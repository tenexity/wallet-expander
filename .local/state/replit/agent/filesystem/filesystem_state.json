{"file_contents":{"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/account-dossier-panel.tsx":{"content":"/**\n * AccountDossierPanel â€” Phase 4\n *\n * Slide-out drawer that opens when a rep clicks any account row/card.\n * Pulls from GET /api/agent/account-context/:accountId.\n *\n * Sections:\n *  - Header: name, segment, enrollment status, opportunity score\n *  - Gap Summary: top 3 category gaps with progress bars\n *  - Active Playbook: priority action, call script, email composer trigger\n *  - Task Checklist: completion + outcome micro-prompt\n *  - Recent Interactions timeline\n *  - Active Projects\n *  - Competitor Intel\n *  - Similar Graduated Accounts (proof points)\n *  - Rep Notes\n */\n\nimport { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport {\n    Sheet,\n    SheetContent,\n    SheetHeader,\n    SheetTitle,\n} from \"@/components/ui/sheet\";\nimport {\n    Dialog,\n    DialogContent,\n    DialogHeader,\n    DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n    TrendingUp, TrendingDown, Minus, Phone, Mail, Building2,\n    CheckCircle, Circle, AlertTriangle, Zap, Users, ClipboardList,\n    Sparkles, Clock, Target\n} from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { EmailComposerModal } from \"./email-composer-modal\";\n\n// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ninterface AccountContext {\n    account: {\n        id: number;\n        name: string;\n        segment: string | null;\n        region: string | null;\n        assignedTm: string | null;\n        enrollmentStatus: string | null;\n        walletShareDirection: string | null;\n    };\n    metrics: {\n        last12mRevenue: string | null;\n        last3mRevenue: string | null;\n        opportunityScore: string | null;\n        walletSharePercentage: string | null;\n        daysSinceLastOrder: number | null;\n        categoryPenetration: string | null;\n    } | null;\n    contacts: Array<{ name: string; role: string | null; email: string | null; isPrimary: boolean | null }>;\n    categorySpend: Array<{ categoryId: number; categoryName: string | null; spendAmount: string; gapPct: string | null; gapDollars: string | null }>;\n    recentInteractions: Array<{\n        interactionType: string; subject: string | null; sentiment: string | null;\n        urgency: string | null; interactionDate: string | null; buyingSignal: string | null;\n    }>;\n    activePlaybook: {\n        playbookType: string; priorityAction: string | null; urgencyLevel: string | null;\n        aiGeneratedContent: any;\n    } | null;\n    projects: Array<{ name: string; projectType: string | null; status: string | null; estimatedValue: string | null }>;\n    competitors: Array<{ name: string; estimatedSpendPct: string | null }>;\n    similarGraduatedAccounts: Array<{ accountIdB: number; accountBName: string | null; similarityScore: string; sharedSegment: string | null; accountBGraduationRevenue: string | null }>;\n    applicableLearnings: Array<{ learning: string; evidenceCount: number | null; successRate: string | null }>;\n}\n\n// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst enrollmentColors: Record<string, string> = {\n    discovered: \"bg-slate-100 text-slate-700\",\n    enrolled: \"bg-blue-100 text-blue-700\",\n    graduated: \"bg-green-100 text-green-700\",\n    at_risk: \"bg-red-100 text-red-700\",\n};\n\nconst sentimentColors: Record<string, string> = {\n    positive: \"text-green-600\",\n    neutral: \"text-slate-500\",\n    negative: \"text-red-600\",\n    at_risk_signal: \"text-red-700 font-semibold\",\n    competitor_mention: \"text-amber-600\",\n};\n\nconst urgencyColors: Record<string, string> = {\n    immediate: \"bg-red-100 text-red-700\",\n    this_week: \"bg-amber-100 text-amber-700\",\n    this_month: \"bg-blue-100 text-blue-700\",\n    monitor: \"bg-slate-100 text-slate-600\",\n};\n\nfunction fmt(val: string | null | undefined): string {\n    if (!val) return \"â€”\";\n    const n = parseFloat(val);\n    return isNaN(n) ? val : n >= 1000 ? `$${(n / 1000).toFixed(0)}k` : `$${n.toFixed(0)}`;\n}\n\n// â”€â”€â”€ Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ninterface AccountDossierPanelProps {\n    accountId: number | null;\n    onClose: () => void;\n}\n\nexport function AccountDossierPanel({ accountId, onClose }: AccountDossierPanelProps) {\n    const { toast } = useToast();\n    const queryClient = useQueryClient();\n    const [emailComposerOpen, setEmailComposerOpen] = useState(false);\n    const [callScriptOpen, setCallScriptOpen] = useState(false);\n    const [repNote, setRepNote] = useState(\"\");\n    const [activeTab, setActiveTab] = useState<\"playbook\" | \"intel\" | \"context\">(\"playbook\");\n\n    const { data: ctx, isLoading } = useQuery<AccountContext>({\n        queryKey: [`/api/agent/account-context/${accountId}`],\n        enabled: !!accountId,\n    });\n\n    const generatePlaybookMutation = useMutation({\n        mutationFn: () => apiRequest(\"POST\", \"/api/agent/generate-playbook\", { accountId }),\n        onSuccess: () => {\n            queryClient.invalidateQueries({ queryKey: [`/api/agent/account-context/${accountId}`] });\n            toast({ title: \"Playbook generated!\", description: \"New playbook is ready.\" });\n        },\n        onError: () => toast({ title: \"Error\", description: \"Failed to generate playbook.\", variant: \"destructive\" }),\n    });\n\n    const saveNoteMutation = useMutation({\n        mutationFn: () => apiRequest(\"POST\", \"/api/agent/interactions\", {\n            accountId,\n            interactionType: \"rep_note\",\n            source: \"rep_entered\",\n            body: repNote,\n        }),\n        onSuccess: () => {\n            setRepNote(\"\");\n            queryClient.invalidateQueries({ queryKey: [`/api/agent/account-context/${accountId}`] });\n            toast({ title: \"Note saved.\" });\n        },\n    });\n\n    const tabs = [\n        { id: \"playbook\", label: \"Playbook\", icon: Zap },\n        { id: \"intel\", label: \"Intel\", icon: AlertTriangle },\n        { id: \"context\", label: \"Context\", icon: Users },\n    ] as const;\n\n    return (\n        <>\n            <Sheet open={!!accountId} onOpenChange={(o) => !o && onClose()}>\n                <SheetContent className=\"w-full sm:max-w-2xl p-0 flex flex-col\" side=\"right\">\n                    {isLoading || !ctx ? (\n                        <div className=\"flex items-center justify-center h-full\">\n                            <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent\" />\n                        </div>\n                    ) : (\n                        <>\n                            {/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\n                            <SheetHeader className=\"px-6 pt-6 pb-4 border-b bg-gradient-to-br from-blue-50 to-white dark:from-blue-950/20 dark:to-background\">\n                                <div className=\"flex items-start justify-between gap-3\">\n                                    <div className=\"flex-1 min-w-0\">\n                                        <SheetTitle className=\"text-xl font-bold truncate\">{ctx.account.name}</SheetTitle>\n                                        <div className=\"flex flex-wrap items-center gap-2 mt-2\">\n                                            {ctx.account.segment && (\n                                                <Badge variant=\"outline\" className=\"text-xs\">{ctx.account.segment}</Badge>\n                                            )}\n                                            {ctx.account.region && (\n                                                <Badge variant=\"outline\" className=\"text-xs\">{ctx.account.region}</Badge>\n                                            )}\n                                            {ctx.account.enrollmentStatus && (\n                                                <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${enrollmentColors[ctx.account.enrollmentStatus] ?? \"bg-slate-100 text-slate-700\"}`}>\n                                                    {ctx.account.enrollmentStatus.replace(/_/g, \" \")}\n                                                </span>\n                                            )}\n                                            {ctx.account.walletShareDirection === \"growing\" && <TrendingUp className=\"h-4 w-4 text-green-500\" />}\n                                            {ctx.account.walletShareDirection === \"declining\" && <TrendingDown className=\"h-4 w-4 text-red-500\" />}\n                                            {ctx.account.walletShareDirection === \"stable\" && <Minus className=\"h-4 w-4 text-slate-400\" />}\n                                        </div>\n                                    </div>\n                                    {ctx.metrics?.opportunityScore && (\n                                        <div className=\"text-center shrink-0\">\n                                            <div className=\"text-2xl font-bold text-primary\">{Math.round(parseFloat(ctx.metrics.opportunityScore))}</div>\n                                            <div className=\"text-xs text-muted-foreground\">Opp. Score</div>\n                                        </div>\n                                    )}\n                                </div>\n\n                                {/* KPI strip */}\n                                <div className=\"grid grid-cols-3 gap-3 mt-4\">\n                                    <div className=\"bg-white dark:bg-card rounded-lg p-2.5 border text-center\">\n                                        <div className=\"text-base font-bold\">{fmt(ctx.metrics?.last12mRevenue)}</div>\n                                        <div className=\"text-xs text-muted-foreground\">12m Rev</div>\n                                    </div>\n                                    <div className=\"bg-white dark:bg-card rounded-lg p-2.5 border text-center\">\n                                        <div className=\"text-base font-bold\">{ctx.metrics?.walletSharePercentage ? `${Math.round(parseFloat(ctx.metrics.walletSharePercentage))}%` : \"â€”\"}</div>\n                                        <div className=\"text-xs text-muted-foreground\">Wallet Share</div>\n                                    </div>\n                                    <div className=\"bg-white dark:bg-card rounded-lg p-2.5 border text-center\">\n                                        <div className=\"text-base font-bold\">{ctx.metrics?.daysSinceLastOrder ?? \"â€”\"}</div>\n                                        <div className=\"text-xs text-muted-foreground\">Days Since Order</div>\n                                    </div>\n                                </div>\n                            </SheetHeader>\n\n                            {/* â”€â”€ Tab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\n                            <div className=\"flex border-b px-6\">\n                                {tabs.map(({ id, label, icon: Icon }) => (\n                                    <button\n                                        key={id}\n                                        onClick={() => setActiveTab(id)}\n                                        className={`flex items-center gap-1.5 px-3 py-2.5 text-sm font-medium border-b-2 transition-colors\n                      ${activeTab === id ? \"border-primary text-primary\" : \"border-transparent text-muted-foreground hover:text-foreground\"}`}\n                                    >\n                                        <Icon className=\"h-3.5 w-3.5\" />\n                                        {label}\n                                    </button>\n                                ))}\n                            </div>\n\n                            {/* â”€â”€ Scrollable body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\n                            <ScrollArea className=\"flex-1\">\n                                <div className=\"px-6 py-4 space-y-6\">\n\n                                    {/* â”€â”€ PLAYBOOK TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\n                                    {activeTab === \"playbook\" && (\n                                        <>\n                                            {ctx.activePlaybook ? (\n                                                <div className=\"space-y-4\">\n                                                    <div className=\"flex items-center justify-between\">\n                                                        <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide\">Active Playbook</h3>\n                                                        <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${urgencyColors[ctx.activePlaybook.urgencyLevel ?? \"monitor\"]}`}>\n                                                            {ctx.activePlaybook.urgencyLevel?.replace(/_/g, \" \") ?? \"monitor\"}\n                                                        </span>\n                                                    </div>\n\n                                                    <div className=\"bg-primary/5 border border-primary/20 rounded-xl p-4\">\n                                                        <div className=\"flex items-start gap-2\">\n                                                            <Zap className=\"h-4 w-4 text-primary mt-0.5 shrink-0\" />\n                                                            <p className=\"font-semibold text-sm\">{ctx.activePlaybook.priorityAction}</p>\n                                                        </div>\n                                                        <p className=\"text-xs text-muted-foreground mt-1 ml-6\">\n                                                            {ctx.activePlaybook.playbookType.replace(/_/g, \" \")}\n                                                        </p>\n                                                    </div>\n\n                                                    <div className=\"flex gap-2\">\n                                                        <Button\n                                                            size=\"sm\"\n                                                            className=\"flex-1\"\n                                                            onClick={() => setEmailComposerOpen(true)}\n                                                        >\n                                                            <Mail className=\"h-3.5 w-3.5 mr-1.5\" />\n                                                            Send Email\n                                                        </Button>\n                                                        <Button\n                                                            variant=\"outline\"\n                                                            size=\"sm\"\n                                                            className=\"flex-1\"\n                                                            onClick={() => setCallScriptOpen(true)}\n                                                        >\n                                                            <Phone className=\"h-3.5 w-3.5 mr-1.5\" />\n                                                            View Call Script\n                                                        </Button>\n                                                    </div>\n\n                                                    {ctx.activePlaybook.aiGeneratedContent?.talking_points?.length > 0 && (\n                                                        <div>\n                                                            <h4 className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground mb-2\">Talking Points</h4>\n                                                            <ul className=\"space-y-1.5\">\n                                                                {ctx.activePlaybook.aiGeneratedContent.talking_points.map((pt: string, i: number) => (\n                                                                    <li key={i} className=\"flex items-start gap-2 text-sm\">\n                                                                        <CheckCircle className=\"h-3.5 w-3.5 text-green-500 mt-0.5 shrink-0\" />\n                                                                        {pt}\n                                                                    </li>\n                                                                ))}\n                                                            </ul>\n                                                        </div>\n                                                    )}\n                                                </div>\n                                            ) : (\n                                                <div className=\"text-center py-8\">\n                                                    <Sparkles className=\"h-8 w-8 text-muted-foreground mx-auto mb-3\" />\n                                                    <p className=\"text-sm text-muted-foreground mb-4\">No active playbook yet.</p>\n                                                    <Button\n                                                        onClick={() => generatePlaybookMutation.mutate()}\n                                                        disabled={generatePlaybookMutation.isPending}\n                                                        size=\"sm\"\n                                                    >\n                                                        {generatePlaybookMutation.isPending ? \"Generating...\" : \"Generate Playbook\"}\n                                                    </Button>\n                                                </div>\n                                            )}\n\n                                            <Separator />\n\n                                            {/* Category gaps */}\n                                            {ctx.categorySpend.length > 0 && (\n                                                <div>\n                                                    <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-3\">Top Category Gaps</h3>\n                                                    <div className=\"space-y-3\">\n                                                        {ctx.categorySpend.slice(0, 4).map((s) => {\n                                                            const gap = parseFloat(s.gapPct ?? \"0\");\n                                                            return (\n                                                                <div key={s.categoryId}>\n                                                                    <div className=\"flex justify-between text-sm mb-1\">\n                                                                        <span className=\"font-medium\">{s.categoryName ?? `Category ${s.categoryId}`}</span>\n                                                                        <span className=\"text-muted-foreground\">{s.gapPct ? `${gap.toFixed(0)}% gap` : \"â€”\"} Â· {fmt(s.gapDollars)}</span>\n                                                                    </div>\n                                                                    <Progress value={Math.min(Math.abs(gap), 100)} className=\"h-1.5\" />\n                                                                </div>\n                                                            );\n                                                        })}\n                                                    </div>\n                                                </div>\n                                            )}\n\n                                            <Separator />\n\n                                            {/* Rep note */}\n                                            <div>\n                                                <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-2\">Add Note</h3>\n                                                <Textarea\n                                                    placeholder=\"What did you discuss? Any signals or next steps...\"\n                                                    value={repNote}\n                                                    onChange={(e) => setRepNote(e.target.value)}\n                                                    className=\"text-sm resize-none\"\n                                                    rows={3}\n                                                />\n                                                <Button\n                                                    size=\"sm\"\n                                                    variant=\"outline\"\n                                                    className=\"mt-2\"\n                                                    disabled={!repNote.trim() || saveNoteMutation.isPending}\n                                                    onClick={() => saveNoteMutation.mutate()}\n                                                >\n                                                    Save Note\n                                                </Button>\n                                            </div>\n                                        </>\n                                    )}\n\n                                    {/* â”€â”€ INTEL TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\n                                    {activeTab === \"intel\" && (\n                                        <>\n                                            {/* Recent interactions */}\n                                            {ctx.recentInteractions.length > 0 ? (\n                                                <div>\n                                                    <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-3\">Recent Interactions</h3>\n                                                    <div className=\"space-y-3\">\n                                                        {ctx.recentInteractions.map((interaction, i) => (\n                                                            <div key={i} className=\"flex gap-3\">\n                                                                <div className=\"flex flex-col items-center\">\n                                                                    <div className=\"h-7 w-7 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center shrink-0\">\n                                                                        {interaction.interactionType === \"email\" ? <Mail className=\"h-3 w-3\" /> :\n                                                                            interaction.interactionType === \"call\" ? <Phone className=\"h-3 w-3\" /> :\n                                                                                <ClipboardList className=\"h-3 w-3\" />}\n                                                                    </div>\n                                                                    {i < ctx.recentInteractions.length - 1 && (\n                                                                        <div className=\"w-px flex-1 bg-border mt-1\" />\n                                                                    )}\n                                                                </div>\n                                                                <div className=\"flex-1 pb-3\">\n                                                                    <div className=\"flex items-center gap-2\">\n                                                                        <span className=\"text-xs font-medium\">{interaction.interactionType.replace(/_/g, \" \")}</span>\n                                                                        {interaction.sentiment && (\n                                                                            <span className={`text-xs ${sentimentColors[interaction.sentiment] ?? \"text-muted-foreground\"}`}>\n                                                                                Â· {interaction.sentiment.replace(/_/g, \" \")}\n                                                                            </span>\n                                                                        )}\n                                                                        <span className=\"text-xs text-muted-foreground ml-auto\">\n                                                                            {interaction.interactionDate ? new Date(interaction.interactionDate).toLocaleDateString() : \"\"}\n                                                                        </span>\n                                                                    </div>\n                                                                    {interaction.subject && <p className=\"text-sm mt-0.5\">{interaction.subject}</p>}\n                                                                    {interaction.buyingSignal && (\n                                                                        <p className=\"text-xs text-green-600 mt-1\">ðŸŸ¢ Buying signal: {interaction.buyingSignal}</p>\n                                                                    )}\n                                                                </div>\n                                                            </div>\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            ) : (\n                                                <p className=\"text-sm text-muted-foreground text-center py-6\">No interactions logged yet.</p>\n                                            )}\n\n                                            <Separator />\n\n                                            {/* Competitors */}\n                                            {ctx.competitors.length > 0 && (\n                                                <div>\n                                                    <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-2\">Competitor Intel</h3>\n                                                    <div className=\"space-y-2\">\n                                                        {ctx.competitors.map((c, i) => (\n                                                            <div key={i} className=\"flex items-center justify-between text-sm p-2 rounded-lg bg-muted/50\">\n                                                                <span className=\"font-medium\">{c.name}</span>\n                                                                {c.estimatedSpendPct && (\n                                                                    <span className=\"text-muted-foreground text-xs\">~{c.estimatedSpendPct}% est. spend</span>\n                                                                )}\n                                                            </div>\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            )}\n                                        </>\n                                    )}\n\n                                    {/* â”€â”€ CONTEXT TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}\n                                    {activeTab === \"context\" && (\n                                        <>\n                                            {/* Contacts */}\n                                            {ctx.contacts.length > 0 && (\n                                                <div>\n                                                    <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-3\">Key Contacts</h3>\n                                                    <div className=\"space-y-2\">\n                                                        {ctx.contacts.map((c, i) => (\n                                                            <div key={i} className=\"flex items-center gap-3 p-2 rounded-lg border\">\n                                                                <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center text-xs font-bold text-primary\">\n                                                                    {c.name.charAt(0)}\n                                                                </div>\n                                                                <div className=\"flex-1 min-w-0\">\n                                                                    <div className=\"flex items-center gap-2\">\n                                                                        <span className=\"text-sm font-medium\">{c.name}</span>\n                                                                        {c.isPrimary && <Badge variant=\"secondary\" className=\"text-xs py-0\">Primary</Badge>}\n                                                                    </div>\n                                                                    <span className=\"text-xs text-muted-foreground\">{c.role ?? \"Unknown role\"}</span>\n                                                                </div>\n                                                                {c.email && (\n                                                                    <a href={`mailto:${c.email}`} className=\"shrink-0\">\n                                                                        <Mail className=\"h-4 w-4 text-muted-foreground hover:text-primary\" />\n                                                                    </a>\n                                                                )}\n                                                            </div>\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            )}\n\n                                            <Separator />\n\n                                            {/* Projects */}\n                                            {ctx.projects.length > 0 && (\n                                                <div>\n                                                    <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-2\">Active Projects</h3>\n                                                    <div className=\"space-y-2\">\n                                                        {ctx.projects.map((p, i) => (\n                                                            <div key={i} className=\"flex items-center justify-between text-sm p-2 rounded-lg border\">\n                                                                <div>\n                                                                    <span className=\"font-medium\">{p.name}</span>\n                                                                    <span className=\"text-muted-foreground text-xs ml-2\">Â· {p.projectType?.replace(/_/g, \" \")}</span>\n                                                                </div>\n                                                                <div className=\"text-right\">\n                                                                    <div className=\"text-xs font-medium\">{fmt(p.estimatedValue)}</div>\n                                                                    <div className=\"text-xs text-muted-foreground\">{p.status}</div>\n                                                                </div>\n                                                            </div>\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            )}\n\n                                            <Separator />\n\n                                            {/* Similar graduated accounts */}\n                                            {ctx.similarGraduatedAccounts.length > 0 && (\n                                                <div>\n                                                    <h3 className=\"font-semibold text-sm text-muted-foreground uppercase tracking-wide mb-2\">\n                                                        Similar Accounts That Graduated\n                                                    </h3>\n                                                    <p className=\"text-xs text-muted-foreground mb-2\">Use as proof points in your pitch:</p>\n                                                    <div className=\"space-y-2\">\n                                                        {ctx.similarGraduatedAccounts.map((s, i) => (\n                                                            <div key={i} className=\"flex items-center gap-2 text-sm p-2 rounded-lg bg-green-50 dark:bg-green-950/20\">\n                                                                <CheckCircle className=\"h-4 w-4 text-green-500 shrink-0\" />\n                                                                <div>\n                                                                    <span className=\"font-medium\">{s.accountBName ?? `Account #${s.accountIdB}`}</span>\n                                                                    <span className=\"text-muted-foreground text-xs ml-2\">\n                                                                        {s.sharedSegment} Â· graduated at {fmt(s.accountBGraduationRevenue)}\n                                                                    </span>\n                                                                </div>\n                                                            </div>\n                                                        ))}\n                                                    </div>\n                                                </div>\n                                            )}\n                                        </>\n                                    )}\n                                </div>\n                            </ScrollArea>\n                        </>\n                    )}\n                </SheetContent>\n            </Sheet>\n\n            {/* Email composer modal */}\n            {ctx?.activePlaybook && (\n                <EmailComposerModal\n                    open={emailComposerOpen}\n                    onClose={() => setEmailComposerOpen(false)}\n                    accountId={accountId!}\n                    accountName={ctx.account.name}\n                    emailSubject={ctx.activePlaybook.aiGeneratedContent?.email_subject ?? \"\"}\n                    emailDraft={ctx.activePlaybook.aiGeneratedContent?.email_draft ?? \"\"}\n                    personalizationNotes={ctx.activePlaybook.aiGeneratedContent?.personalization_notes ?? \"\"}\n                />\n            )}\n\n            {/* Call script dialog */}\n            <Dialog open={callScriptOpen} onOpenChange={setCallScriptOpen}>\n                <DialogContent className=\"max-w-lg max-h-[80vh] overflow-y-auto\">\n                    <DialogHeader>\n                        <DialogTitle className=\"flex items-center gap-2\">\n                            <Phone className=\"h-4 w-4\" />\n                            Call Script â€” {ctx?.account.name}\n                        </DialogTitle>\n                    </DialogHeader>\n                    <div className=\"space-y-4\">\n                        {ctx?.activePlaybook?.aiGeneratedContent?.call_script ? (\n                            <div className=\"whitespace-pre-wrap text-sm leading-relaxed bg-muted/30 rounded-lg p-4 border\">\n                                {ctx.activePlaybook.aiGeneratedContent.call_script}\n                            </div>\n                        ) : (\n                            <p className=\"text-sm text-muted-foreground text-center py-4\">No call script available for this playbook.</p>\n                        )}\n                        {(ctx?.activePlaybook?.aiGeneratedContent?.talking_points?.length ?? 0) > 0 && (\n                            <div>\n                                <h4 className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground mb-2\">Key Talking Points</h4>\n                                <ul className=\"space-y-1.5\">\n                                    {ctx?.activePlaybook?.aiGeneratedContent?.talking_points?.map((pt: string, i: number) => (\n                                        <li key={i} className=\"flex items-start gap-2 text-sm\">\n                                            <CheckCircle className=\"h-3.5 w-3.5 text-green-500 mt-0.5 shrink-0\" />\n                                            {pt}\n                                        </li>\n                                    ))}\n                                </ul>\n                            </div>\n                        )}\n                    </div>\n                </DialogContent>\n            </Dialog>\n        </>\n    );\n}\n","path":null,"size_bytes":37661,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"/{*path}\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":554,"size_tokens":null},"security-one.md":{"content":"# AI VP Dashboard - Comprehensive Code Review\n\n**Review Date:** January 27, 2026  \n**Reviewer:** Replit Agent  \n**Scope:** Full codebase analysis\n\n---\n\n## Table of Contents\n1. [Security Vulnerabilities](#1-security-vulnerabilities)\n2. [Performance Issues](#2-performance-issues)\n3. [Bug Detection](#3-bug-detection)\n4. [Code Style](#4-code-style)\n5. [Test Coverage](#5-test-coverage)\n6. [Documentation](#6-documentation)\n\n---\n\n## 1. Security Vulnerabilities\n\n### 1.1 CRITICAL: Cross-Tenant Data Leakage in Account Metrics âœ… RESOLVED\n\n**Location:** `shared/schema.ts` - Lines 253-293, `server/storage/tenantStorage.ts` - Lines 137-167\n\n**Original Issue:** The `accountMetrics` and `accountCategoryGaps` tables did NOT have a `tenantId` column. TenantStorage methods queried these tables by `accountId` only, without any tenant scoping.\n\n**Resolution:**\n1. Added `tenantId` column to both `accountMetrics` and `accountCategoryGaps` tables in `shared/schema.ts`\n2. Updated all TenantStorage methods to filter by `tenantId`:\n   - `getAccountMetrics()` - filters by `eq(accountMetrics.tenantId, this.tenantId)`\n   - `getLatestAccountMetrics()` - filters by tenantId\n   - `getAccountCategoryGaps()` - filters by `eq(accountCategoryGaps.tenantId, this.tenantId)`\n   - `createAccountMetrics()` - injects `tenantId: this.tenantId`\n   - `createAccountCategoryGap()` - injects `tenantId: this.tenantId`\n3. Database migration applied - both tables now have `tenant_id` column\n\n**Current Schema (shared/schema.ts):**\n```typescript\nexport const accountMetrics = pgTable(\"account_metrics\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  // ...\n});\n\nexport const accountCategoryGaps = pgTable(\"account_category_gaps\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  categoryId: integer(\"category_id\").notNull(),\n  // ...\n});\n```\n\n---\n\n### 1.2 HIGH: Missing Input Validation on PATCH Routes âœ… RESOLVED\n\n**Location:** `server/routes.ts`\n\n**Original Issue:** The PATCH/PUT endpoints passed `req.body` directly to update functions without Zod validation.\n\n**Resolution:**\nAll update routes now have proper Zod schema validation using `.partial().parse()`:\n\n| Route | Validation |\n|-------|------------|\n| `PATCH /api/segment-profiles/:id` | `insertSegmentProfileSchema.partial().parse(req.body)` |\n| `PATCH /api/tasks/:id` | `insertTaskSchema.partial().parse(req.body)` |\n| `PATCH /api/program-accounts/:id` | `insertProgramAccountSchema.partial().parse(req.body)` |\n| `PUT /api/territory-managers/:id` | `insertTerritoryManagerSchema.partial().parse(req.body)` |\n| `PUT /api/custom-categories/:id` | `insertCustomCategorySchema.partial().parse(req.body)` |\n| `PUT /api/rev-share-tiers/:id` | `insertRevShareTierSchema.partial().parse(req.body)` + business logic validation |\n\nAll routes also include `isNaN(id)` validation for the ID parameter.\n\n---\n\n### 1.3 MEDIUM: Integer ID Parsing Without Validation âœ… RESOLVED\n\n**Location:** Multiple routes in `server/routes.ts`\n\n**Issue:** `parseInt(req.params.id)` can return `NaN` for non-numeric inputs, which may cause unexpected behavior.\n\n**Resolution:** Added `isNaN(id)` validation with 400 response to all routes that parse integer IDs:\n- GET /api/accounts/:id\n- POST /api/accounts/:id/enroll\n- GET /api/segment-profiles/:id\n- PATCH /api/segment-profiles/:id\n- POST /api/segment-profiles/:id/approve\n- DELETE /api/segment-profiles/:id\n- GET /api/tasks/:id\n- PATCH /api/tasks/:id\n- POST /api/tasks/:id/complete\n- GET /api/playbooks/:id/tasks\n- GET /api/program-accounts/:id/graduation-progress\n- PATCH /api/program-accounts/:id\n- POST /api/program-accounts/:id/graduate\n- PUT /api/territory-managers/:id\n- DELETE /api/territory-managers/:id\n- PUT /api/custom-categories/:id\n- DELETE /api/custom-categories/:id\n- PUT /api/rev-share-tiers/:id\n- DELETE /api/rev-share-tiers/:id\n\n---\n\n### 1.4 MEDIUM: Inconsistent Subscription Enforcement âœ… RESOLVED\n\n**Location:** `server/routes.ts`\n\n**Issue:** Some routes used `requireSubscription` middleware while others only used `requireAuth`, creating potential access inconsistencies.\n\n**Resolution:** Standardized subscription enforcement. The following routes now use `requireSubscription`:\n- `/api/segment-profiles/:id` (GET, PATCH, DELETE)\n- `/api/segment-profiles/:id/approve` (POST)\n- `/api/segment-profiles/analyze` (POST)\n- `/api/data-insights/:segment` (GET)\n- `/api/tasks/:id` (GET, PATCH)\n- `/api/tasks/:id/complete` (POST)\n- `/api/tasks` (POST)\n- `/api/playbooks/:id/tasks` (GET)\n- `/api/program-accounts/:id/graduation-progress` (GET)\n- `/api/program-accounts/:id/graduate` (POST)\n- `/api/territory-managers/:id` (DELETE)\n- `/api/custom-categories/:id` (DELETE)\n- `/api/rev-share-tiers/:id` (DELETE)\n- `/api/email/settings` (GET, PATCH)\n- `/api/email/test` (POST)\n\n---\n\n### 1.5 INFO: Stripe Webhook Security (Properly Implemented)\n\n**Location:** `server/routes.ts` - Lines 2288-2477\n\n**Status:** âœ… SECURE\n\nThe Stripe webhook handler correctly:\n- Uses `rawBody` for signature verification\n- Validates `STRIPE_WEBHOOK_SECRET` existence\n- Uses `stripe.webhooks.constructEvent()` for signature verification\n- Returns 200 to acknowledge receipt even on processing errors\n\n---\n\n### 1.6 INFO: Multi-Tenant Data Isolation âœ… FULLY SECURE\n\n**Location:** `server/storage/tenantStorage.ts`\n\n**Status:** âœ… SECURE\n\nThe TenantStorage class properly enforces tenant isolation for ALL tables:\n- All queries include `eq(table.tenantId, this.tenantId)` condition\n- Creates with `tenantId` automatically injected\n- Updates and deletes require matching tenantId\n\n**Previous Exception Resolved:** The `accountMetrics` and `accountCategoryGaps` tables now have `tenantId` columns and are properly tenant-scoped (see Section 1.1).\n\n---\n\n## 2. Performance Issues\n\n### 2.1 HIGH: N+1 Query Pattern in Dashboard Stats âœ… RESOLVED\n\n**Location:** `server/routes.ts` - GET /api/dashboard/stats\n\n**Original Issue:** Fetched account metrics and category gaps in a loop for each account (20+ queries for 10 accounts).\n\n**Resolution:**\n1. Added `getAccountMetricsBatch(accountIds)` method to TenantStorage using SQL `IN` clause\n2. Added `getAccountCategoryGapsBatch(accountIds)` method to TenantStorage\n3. Refactored route to use batch queries with `Promise.all([metricsMap, gapsMap])`\n4. Created category Map for O(1) lookups instead of `.find()` in loop\n\n**Result:** 2-3 database queries instead of 20+\n\n---\n\n### 2.2 HIGH: N+1 Query Pattern in Accounts Listing âœ… RESOLVED\n\n**Location:** `server/routes.ts` - GET /api/accounts\n\n**Original Issue:** Fetched metrics, gaps, and categories for every account in a loop. Categories were fetched N times despite returning the same data.\n\n**Resolution:**\n1. Moved `getProductCategories()` outside the loop - fetched once\n2. Created categoryMap for O(1) lookups\n3. Used batch queries `getAccountMetricsBatch()` and `getAccountCategoryGapsBatch()`\n4. Changed from `Promise.all(allAccounts.map(async...))` to synchronous `.map()` using cached Maps\n\n**Result:** 4-5 database queries instead of N*3 queries\n\n---\n\n### 2.3 HIGH: N+1 Query Pattern in Data Insights âœ… RESOLVED\n\n**Location:** `server/routes.ts` - GET /api/data-insights/:segment\n\n**Original Issue:** Multiple nested loops with database queries for segment analysis, potentially causing hundreds of queries.\n\n**Resolution:**\n1. Batch fetch all account metrics and gaps at the start of the route\n2. Created `allMetricsMap` and `allGapsMap` using batch methods\n3. Created `productCatMap` for O(1) category lookups\n4. Refactored all loops to use cached Maps instead of individual queries:\n   - accountsWithMetrics\n   - segmentBreakdown\n   - categoryDataPointsMap\n   - flatGaps\n   - accountAlignments\n   - quickWins\n   - territoryRanking\n\n**Result:** 2-3 database queries instead of hundreds\n\n---\n\n### 2.4 MEDIUM: Inefficient Array Operations âœ… RESOLVED\n\n**Location:** `server/routes.ts` - Multiple locations\n\n**Original Issue:** Using `.find()` inside loops is O(n*m) complexity.\n\n**Resolution:**\n1. Replaced all `.find()` calls inside loops with Map-based O(1) lookups\n2. Created Maps for accounts, categories, and territory managers before loops\n3. Locations fixed:\n   - Dashboard stats: recentTasks mapping\n   - Daily focus: focusTasks mapping  \n   - Account enrollment: gap category lookups\n   - Tasks listing: account lookups\n   - Playbooks: task account lookups\n   - Playbook generation: category and TM lookups\n   - Program accounts: account and category lookups\n   - Data insights: category pattern lookups\n\n---\n\n### 2.5 MEDIUM: Missing Database Indexes âœ… RESOLVED\n\n**Location:** `shared/schema.ts`\n\n**Original Issue:** Some frequently queried columns lacked indexes.\n\n**Resolution:**\nAdded indexes to the following tables:\n1. `accounts`: Added `idx_accounts_segment` and `idx_accounts_assigned_tm`\n2. `tasks`: Added `idx_tasks_status` and `idx_tasks_due_date`\n3. `accountMetrics`: Added `idx_account_metrics_tenant_id` and `idx_account_metrics_account_id`\n4. `accountCategoryGaps`: Added `idx_account_category_gaps_tenant_id` and `idx_account_category_gaps_account_id`\n5. `programAccounts`: Added `idx_program_accounts_account_id`\n\nApplied with `npm run db:push`.\n\n---\n\n### 2.6 LOW: Unbounded Query Results âœ… RESOLVED\n\n**Location:** `/api/tasks` route\n\n**Original Issue:** Several routes returned all records without pagination.\n\n**Resolution:**\n1. Added `PAGINATION` constants in `server/utils/constants.ts`:\n   - `DEFAULT_PAGE: 1`\n   - `DEFAULT_LIMIT: 50`\n   - `MAX_LIMIT: 100`\n2. Updated `TenantStorage.getTasks()` to support pagination with `page` and `limit` options\n3. Added `getAllTasks()` method for internal use where all tasks are needed\n4. Updated `/api/tasks` route to accept `page` and `limit` query parameters\n5. Response now includes pagination metadata: `{ tasks, pagination: { total, page, limit } }`\n6. When filtering by playbookId, all matching tasks are returned (no pagination needed for filtered subset)\n\n---\n\n## 3. Bug Detection\n\n### 3.1 CRITICAL: Cross-Tenant Data Leakage âœ… RESOLVED\n\n**See Section 1.1 (Security Vulnerabilities)** - This was resolved as part of the security fixes.\n\nThe `accountMetrics` and `accountCategoryGaps` tables now include `tenantId` columns with proper filtering in all queries.\n\n---\n\n### 3.2 MEDIUM: Inconsistent Error Handling âœ… RESOLVED\n\n**Location:** `server/routes.ts` - Various routes\n\n**Original Issue:** Some routes logged errors, others didn't. Error messages varied in detail.\n\n**Resolution:**\n1. Created `server/utils/errorHandler.ts` with standardized `handleRouteError()` function\n2. The utility handles both ZodError (400 status with validation errors) and general errors (500 status)\n3. All catch blocks in routes.ts now use `handleRouteError(error, res, \"Context description\")`\n4. Consistent logging and error response format across all routes\n\n---\n\n### 3.4 MEDIUM: Potential Null Reference in Enrollment âœ… RESOLVED\n\n**Location:** `server/routes.ts` - Account enrollment task generation\n\n**Original Issue:** Task type was randomly selected which created inconsistent, non-reproducible behavior.\n\n**Resolution:**\n1. Changed from `Math.random()` to index-based round-robin selection: `taskTypes[i % taskTypes.length]`\n2. Due dates now deterministic based on priority: `7 + i * 2` days (higher priority gaps get earlier due dates)\n3. First gap â†’ call (7 days), second gap â†’ email (9 days), third gap â†’ visit (11 days)\n\n---\n\n### 3.5 LOW: Date Handling Edge Cases âœ… RESOLVED\n\n**Location:** `server/routes.ts` - GET /api/daily-focus\n\n**Original Issue:** Date comparisons used local timezone which could mismatch with database dates.\n\n**Resolution:**\n1. Changed to use UTC consistently: `Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())`\n2. All date comparisons now use UTC versions: `todayUTC`, `dueDateUTC`\n3. The `isOverdue` calculation now compares `dueDateUTC < todayUTC`\n\n---\n\n### 3.6 LOW: Missing Null Checks in Analytics âœ… RESOLVED\n\n**Location:** `server/routes.ts` - Various data calculation routes\n\n**Status:** Audited and confirmed existing code has proper null checks.\n\n**Findings:**\n- All `reduce()` operations dividing by `.length` have proper `length > 0` guards\n- `Math.min/Math.max` with spread operators are protected by length checks\n- Default values provided for nullable metrics: `metrics?.last12mRevenue ? parseFloat(...) : 0`\n- Empty array edge cases handled with fallback values (e.g., `: 30`, `: 0`)\n\n---\n\n## 4. Code Style\n\n### 4.1 MEDIUM: Inconsistent Middleware Naming âœ… RESOLVED\n\n**Location:** `server/routes.ts` - Lines 76-95\n\n**Original Issue:** Multiple naming conventions for middleware arrays (authWithX vs requireX).\n\n**Resolution:**\n1. Standardized all middleware arrays to use `requireX` pattern consistently\n2. Renamed `authWithTenant` â†’ `requireAuth`, `authWithAdmin` â†’ `requireAdmin`\n3. Removed unused `authWithWrite` (replaced with `requireWrite`)\n4. Clear documentation comments for each middleware chain\n\n```typescript\nconst requireAuth = [isAuthenticated, withTenantContext];\nconst requireWrite = [...requireAuth, requirePermission(\"write\")];\nconst requireAdmin = [...requireAuth, requirePermission(\"manage_settings\")];\nconst requireSubscription = [...requireAuth, requireActiveSubscription];\n```\n\n---\n\n### 4.2 MEDIUM: TypeScript Any Types âœ… RESOLVED\n\n**Location:** Multiple files\n\n**Original Issue:** Use of `any` type reduced type safety for Request objects.\n\n**Resolution:**\n1. Created `server/types/express.d.ts` with proper type declarations\n2. Extended `Express.User` interface with `AuthenticatedUser` type including claims\n3. Extended `Express.Request` interface with `tenantContext` property\n4. Updated all middleware and routes to use typed Request:\n   - `getStorage(req: Request)` instead of `getStorage(req: any)`\n   - `req.tenantContext` instead of `(req as any).tenantContext`\n   - `req.user` instead of `(req as any).user`\n\n---\n\n### 4.3 LOW: Inconsistent Async/Await Usage âœ… RESOLVED\n\n**Location:** `server/middleware/subscription.ts`\n\n**Original Issue:** Some middleware marked as `async` without using `await`.\n\n**Resolution:**\n1. Removed unnecessary `async` from `requireActiveSubscription`\n2. Removed unnecessary `async` from `checkSubscriptionStatus`\n3. `withTenantContext` correctly retains `async` as it uses database operations\n\n---\n\n### 4.4 LOW: Magic Numbers âœ… RESOLVED\n\n**Location:** `server/routes.ts`\n\n**Original Issue:** Hard-coded values scattered throughout without explanation.\n\n**Resolution:**\n1. Created `server/utils/constants.ts` with organized constant groups:\n   - `DASHBOARD_LIMITS`: TOP_OPPORTUNITIES, RECENT_TASKS, TOP_GAPS, etc.\n   - `DEFAULT_VALUES`: BASELINE_REVENUE, SHARE_RATE, etc.\n   - `SCORING`: NEAR_ICP_THRESHOLD, DEFAULT_GAP_PERCENTAGE, MAX_SCORE\n2. Updated routes.ts to use named constants from the constants file\n3. Added import and replaced key magic numbers throughout routes.ts\n\n---\n\n### 4.5 LOW: Long Functions âœ… RESOLVED\n\n**Location:** `server/routes.ts` - data-insights endpoint (previously ~330 lines)\n\n**Original Issue:** Some route handlers exceeded 100 lines, making them hard to maintain.\n\n**Resolution:**\n1. Created `server/services/dataInsightsService.ts` with extracted helper functions:\n   - `calculateClassACustomers()` - filters accounts by revenue threshold\n   - `calculateTotalRevenue()` - sums revenue from Class A customers\n   - `calculateAvgCategoryCount()` - averages category counts\n   - `calculateSegmentBreakdown()` - computes per-segment statistics\n   - `calculateAlignmentMetrics()` - computes alignment scores, ICP proximity, revenue at risk\n   - `buildCategoryDataPointsMap()` - aggregates category data points\n   - `calculateTerritoryRanking()` - ranks territories by alignment\n2. Refactored the data-insights route handler to use these service functions\n3. Route handler is now significantly shorter with business logic extracted\n4. All service functions are properly typed with TypeScript interfaces\n\n---\n\n## 5. Test Coverage\n\n### 5.1 CRITICAL: No Application Tests âœ… RESOLVED (Foundation)\n\n**Location:** Project root\n\n**Original Issue:** No test files exist for the application code.\n\n**Resolution:**\n1. Installed Vitest testing framework with coverage support (`vitest`, `@vitest/coverage-v8`)\n2. Created `vitest.config.ts` with proper configuration\n3. Created foundational unit tests for:\n   - `tests/unit/subscription.middleware.test.ts` - 15 tests for subscription enforcement middleware\n   - `tests/unit/tenantContext.middleware.test.ts` - 14 tests for tenant context and role/permission middleware\n   - `tests/unit/tenantStorage.test.ts` - 29 tests for tenant isolation patterns, pagination, and CRUD logic\n\nAll 58 tests passing. Run tests with `npx vitest run`.\n\n**Note:** These are foundational unit tests that validate middleware behavior and tenant isolation patterns. Integration tests against a real database would provide additional coverage for storage operations.\n\n---\n\n### 5.2 Suggested Test File Structure âœ… RESOLVED (Foundation)\n\n**Resolution:** Implemented the following structure:\n```\ntests/\nâ”œâ”€â”€ unit/\nâ”‚   â”œâ”€â”€ tenantStorage.test.ts          âœ… Created (29 tests)\nâ”‚   â”œâ”€â”€ subscription.middleware.test.ts âœ… Created (15 tests)\nâ”‚   â””â”€â”€ tenantContext.middleware.test.ts âœ… Created (14 tests)\nâ””â”€â”€ integration/\n    â””â”€â”€ (ready for future integration tests)\n```\n\nTotal: 58 unit tests providing coverage for middleware and storage patterns.\n\n---\n\n## 6. Documentation\n\n### 6.1 MEDIUM: Missing API Documentation âœ… RESOLVED\n\n**Location:** `server/routes.ts`\n\n**Original Issue:** No JSDoc comments or OpenAPI specification for API endpoints.\n\n**Resolution:**\nAdded JSDoc documentation to key API endpoints including:\n- `GET /api/dashboard/stats` - Dashboard statistics\n- `GET /api/daily-focus` - Daily focus tasks\n- `GET /api/accounts` - Account listing with metrics\n- `GET /api/segment-profiles` - ICP profiles\n- `GET /api/tasks` - Paginated task listing\n- `GET /api/playbooks` - Playbook listing\n- `GET /api/subscription/plans` - Subscription plans (public)\n- `GET /api/subscription` - Current subscription status\n- `POST /api/stripe/create-checkout-session` - Stripe checkout\n- `POST /api/stripe/create-portal-session` - Billing portal\n\nDocumentation includes @route, @security, @returns, @query, and @body annotations where applicable.\n\n**Note:** Core endpoints are documented. Additional endpoints can be documented as needed.\n\n---\n\n### 6.2 MEDIUM: Missing Function Documentation âœ… RESOLVED\n\n**Location:** `server/storage/tenantStorage.ts`\n\n**Original Issue:** Class methods lack documentation explaining parameters and return values.\n\n**Resolution:**\nAdded comprehensive JSDoc documentation to the TenantStorage class including:\n- Class-level documentation explaining tenant-scoped data access\n- Constructor documentation\n- All CRUD methods documented with @param and @returns annotations\n- Batch query methods documented (getAccountMetricsBatch, getAccountCategoryGapsBatch)\n- Pagination methods documented (getTasks, getAllTasks)\n- All key methods include tenant isolation notes\n\n---\n\n### 6.3 LOW: Outdated Comments âœ… RESOLVED\n\n**Location:** `server/routes.ts` - Lines 84-96\n\n**Original Issue:** Comment referenced \"migration\" but no migration was in progress.\n\n**Resolution:**\nThe outdated comment was replaced with clear, accurate documentation of the middleware setup:\n```typescript\n// ============ Protected API Routes ============\n// All routes below require authentication and tenant context\n// Middleware chain: isAuthenticated -> withTenantContext\n\n// Base authentication: requires login + tenant context\nconst requireAuth = [isAuthenticated, withTenantContext];\n\n// Write permission: authentication + write permission\nconst requireWrite = [...requireAuth, requirePermission(\"write\")];\n\n// Admin permission: authentication + manage_settings permission\nconst requireAdmin = [...requireAuth, requirePermission(\"manage_settings\")];\n```\n\n---\n\n### 6.4 LOW: Missing Inline Comments âœ… RESOLVED\n\n**Location:** Complex calculation logic in `server/routes.ts`\n\n**Original Issue:** Business logic lacked explanatory comments.\n\n**Resolution:**\nAdded inline comments to gap calculation logic:\n- Line 162: Comment explaining `estimatedValue` calculation (sum of category gap opportunities)\n- Line 318: Comment explaining `gapCategories` mapping\n- Line 323-324: Inline comments for `gapPct` (percentage gap vs ICP benchmark) and `estimatedValue` (revenue potential in dollars)\n\n---\n\n## Summary\n\n| Category | Critical | High | Medium | Low | Info |\n|----------|----------|------|--------|-----|------|\n| Security | 1 | 1 | 2 | 0 | 2 |\n| Performance | 0 | 3 | 2 | 1 | 0 |\n| Bugs | 1 | 0 | 2 | 2 | 0 |\n| Code Style | 0 | 0 | 2 | 4 | 0 |\n| Test Coverage | 1 | 0 | 0 | 0 | 0 |\n| Documentation | 0 | 0 | 2 | 2 | 0 |\n\n### Priority Fixes\n\n1. **FIX IMMEDIATELY: Add tenantId to accountMetrics and accountCategoryGaps tables** (Security - Critical) - Cross-tenant data leakage vulnerability\n2. **Add validation to all PATCH endpoints** (Security - High)\n3. **Fix N+1 query patterns in dashboard and accounts** (Performance - High)\n4. **Implement test coverage** (Test - Critical)\n5. **Standardize subscription enforcement** (Security - Medium)\n\n---\n\n## Appendix: Files Reviewed\n\n- `server/routes.ts` (2525 lines)\n- `server/storage.ts` (563 lines)\n- `server/storage/tenantStorage.ts` (412 lines)\n- `server/middleware/subscription.ts` (80 lines)\n- `server/middleware/tenantContext.ts` (121 lines)\n- `shared/schema.ts` (633 lines)\n- `client/src/pages/*.tsx` (12 files)\n","path":null,"size_bytes":21729,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"server/seed.ts":{"content":"import { db } from \"./db\";\nimport {\n  accounts,\n  productCategories,\n  products,\n  segmentProfiles,\n  profileCategories,\n  tasks,\n  playbooks,\n  playbookTasks,\n  programAccounts,\n  programRevenueSnapshots,\n  dataUploads,\n  accountMetrics,\n  accountCategoryGaps,\n  subscriptionPlans,\n  territoryManagers,\n  orders,\n  orderItems,\n  revShareTiers,\n  settings,\n  agentState,\n  agentContacts,\n  agentAccountCategorySpend,\n  agentInteractions,\n  agentPlaybooks,\n  agentCompetitors,\n  agentAccountCompetitors,\n  agentPlaybookLearnings,\n  agentProjects,\n  contacts,\n  projects,\n  orderSignals,\n  competitorMentions,\n} from \"@shared/schema\";\nimport { sql } from \"drizzle-orm\";\n\n// â”€â”€â”€ TENANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst TENANT_ID = 8; // Graham's demo tenant\n\nexport async function seed() {\n  console.log(\"ðŸŒ± Seeding ABC Supply Co. demo data...\");\n\n  // â”€â”€ Clear in FK-safe order â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.delete(competitorMentions);\n  await db.delete(orderSignals);\n  await db.delete(projects);\n  await db.delete(contacts);\n  await db.delete(programRevenueSnapshots);\n  await db.delete(programAccounts);\n  await db.delete(accountCategoryGaps);\n  await db.delete(accountMetrics);\n  await db.delete(playbookTasks);\n  await db.delete(tasks);\n  await db.delete(playbooks);\n  await db.delete(profileCategories);\n  await db.delete(segmentProfiles);\n  await db.delete(orderItems);\n  await db.delete(orders);\n  await db.delete(products);\n  await db.delete(productCategories);\n  await db.delete(dataUploads);\n  await db.delete(accounts);\n  await db.delete(territoryManagers);\n  await db.delete(revShareTiers);\n  await db.delete(settings);\n\n  await db.execute(\n    sql`UPDATE tenants SET subscription_status = 'active', plan_type = 'professional' WHERE id = ${TENANT_ID}`\n  );\n\n  // â”€â”€ Territory Managers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const tms = await db\n    .insert(territoryManagers)\n    .values([\n      {\n        tenantId: TENANT_ID,\n        name: \"Sarah Chen\",\n        email: \"sarah.chen@marksupply.com\",\n        territories: [\"Northeast\", \"Mid-Atlantic\"],\n        isActive: true,\n      },\n      {\n        tenantId: TENANT_ID,\n        name: \"James Rivera\",\n        email: \"james.rivera@marksupply.com\",\n        territories: [\"Southeast\", \"Florida\"],\n        isActive: true,\n      },\n      {\n        tenantId: TENANT_ID,\n        name: \"Mike Thornton\",\n        email: \"mike.thornton@marksupply.com\",\n        territories: [\"Midwest\", \"Great Lakes\"],\n        isActive: true,\n      },\n    ])\n    .returning();\n  console.log(`âœ“ ${tms.length} territory managers`);\n\n  const [sarah, james, mike] = tms;\n\n  // â”€â”€ Product Categories â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const cats = await db\n    .insert(productCategories)\n    .values([\n      { tenantId: TENANT_ID, name: \"HVAC Equipment\" },            // 0\n      { tenantId: TENANT_ID, name: \"Refrigerant & Supplies\" },    // 1\n      { tenantId: TENANT_ID, name: \"Ductwork & Fittings\" },       // 2\n      { tenantId: TENANT_ID, name: \"Controls & Thermostats\" },    // 3\n      { tenantId: TENANT_ID, name: \"Water Heaters\" },             // 4\n      { tenantId: TENANT_ID, name: \"Tools & Safety\" },            // 5\n      { tenantId: TENANT_ID, name: \"Pipe & Fittings\" },           // 6\n      { tenantId: TENANT_ID, name: \"PVF (Pipe, Valves, Fittings)\" }, // 7\n      { tenantId: TENANT_ID, name: \"Plumbing Fixtures\" },         // 8\n      { tenantId: TENANT_ID, name: \"Drainage Systems\" },          // 9\n      { tenantId: TENANT_ID, name: \"Insulation Materials\" },      // 10\n      { tenantId: TENANT_ID, name: \"Electrical Components\" },     // 11\n    ])\n    .returning();\n  console.log(`âœ“ ${cats.length} categories`);\n\n  // â”€â”€ Products â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const productRows: {\n    tenantId: number;\n    sku: string;\n    name: string;\n    categoryId: number;\n    unitCost: string;\n    unitPrice: string;\n  }[] = [\n      // HVAC\n      { tenantId: TENANT_ID, sku: \"HVAC-1001\", name: \"Carrier 3-Ton AC Unit\", categoryId: cats[0].id, unitCost: \"1400\", unitPrice: \"1890\" },\n      { tenantId: TENANT_ID, sku: \"HVAC-1002\", name: \"Trane Heat Pump XR15\", categoryId: cats[0].id, unitCost: \"1250\", unitPrice: \"1688\" },\n      { tenantId: TENANT_ID, sku: \"HVAC-1003\", name: \"Lennox Furnace SL280V\", categoryId: cats[0].id, unitCost: \"980\", unitPrice: \"1323\" },\n      // Refrigerant\n      { tenantId: TENANT_ID, sku: \"REF-2001\", name: \"R-410A 25lb Cylinder\", categoryId: cats[1].id, unitCost: \"95\", unitPrice: \"128\" },\n      { tenantId: TENANT_ID, sku: \"REF-2002\", name: \"Vacuum Pump 2-Stage\", categoryId: cats[1].id, unitCost: \"210\", unitPrice: \"284\" },\n      // Ductwork\n      { tenantId: TENANT_ID, sku: \"DUCT-3001\", name: \"6\\\" Flex Duct 25ft\", categoryId: cats[2].id, unitCost: \"48\", unitPrice: \"65\" },\n      { tenantId: TENANT_ID, sku: \"DUCT-3002\", name: \"Sheet Metal Elbow 6\\\"\", categoryId: cats[2].id, unitCost: \"12\", unitPrice: \"16\" },\n      // Controls\n      { tenantId: TENANT_ID, sku: \"CTRL-4001\", name: \"Honeywell T6 Pro\", categoryId: cats[3].id, unitCost: \"42\", unitPrice: \"57\" },\n      { tenantId: TENANT_ID, sku: \"CTRL-4002\", name: \"Ecobee Smart Thermostat\", categoryId: cats[3].id, unitCost: \"145\", unitPrice: \"196\" },\n      { tenantId: TENANT_ID, sku: \"CTRL-4003\", name: \"Nest Learning Thermostat\", categoryId: cats[3].id, unitCost: \"175\", unitPrice: \"236\" },\n      // Water Heaters\n      { tenantId: TENANT_ID, sku: \"WH-5001\", name: \"Bradford White 50gal Gas\", categoryId: cats[4].id, unitCost: \"480\", unitPrice: \"648\" },\n      { tenantId: TENANT_ID, sku: \"WH-5002\", name: \"Rheem 40gal Electric\", categoryId: cats[4].id, unitCost: \"340\", unitPrice: \"459\" },\n      { tenantId: TENANT_ID, sku: \"WH-5003\", name: \"Navien NPE-240A Tankless\", categoryId: cats[4].id, unitCost: \"890\", unitPrice: \"1202\" },\n      // Tools\n      { tenantId: TENANT_ID, sku: \"TOOL-6001\", name: \"Milwaukee Drill M18\", categoryId: cats[5].id, unitCost: \"165\", unitPrice: \"223\" },\n      // Pipe\n      { tenantId: TENANT_ID, sku: \"PIPE-7001\", name: \"1\\\" Copper Type L 10ft\", categoryId: cats[6].id, unitCost: \"38\", unitPrice: \"51\" },\n      { tenantId: TENANT_ID, sku: \"PIPE-7002\", name: \"3/4\\\" PEX Roll 500ft\", categoryId: cats[6].id, unitCost: \"95\", unitPrice: \"128\" },\n      // PVF\n      { tenantId: TENANT_ID, sku: \"PVF-8001\", name: \"Ball Valve 1\\\" Brass\", categoryId: cats[7].id, unitCost: \"22\", unitPrice: \"30\" },\n      { tenantId: TENANT_ID, sku: \"PVF-8002\", name: \"Gate Valve 2\\\" Bronze\", categoryId: cats[7].id, unitCost: \"58\", unitPrice: \"78\" },\n      // Fixtures\n      { tenantId: TENANT_ID, sku: \"FIX-9001\", name: \"Kohler Toilet Cimarron\", categoryId: cats[8].id, unitCost: \"280\", unitPrice: \"378\" },\n      { tenantId: TENANT_ID, sku: \"FIX-9002\", name: \"Delta Pull-Down Faucet\", categoryId: cats[8].id, unitCost: \"195\", unitPrice: \"263\" },\n      // Drainage\n      { tenantId: TENANT_ID, sku: \"DRN-10001\", name: \"4\\\" ABS P-Trap\", categoryId: cats[9].id, unitCost: \"8\", unitPrice: \"11\" },\n      // Insulation\n      { tenantId: TENANT_ID, sku: \"INS-11001\", name: \"Armaflex 1\\\" pipe insulation 6ft\", categoryId: cats[10].id, unitCost: \"14\", unitPrice: \"19\" },\n      // Electrical\n      { tenantId: TENANT_ID, sku: \"ELEC-12001\", name: \"240V Disconnect Box\", categoryId: cats[11].id, unitCost: \"62\", unitPrice: \"84\" },\n    ];\n  const prods = await db.insert(products).values(productRows).returning();\n  console.log(`âœ“ ${prods.length} products`);\n\n  // â”€â”€ Accounts (20 named, narrative-specific) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const accountDefs = [\n    // Sarah's territory â€” Northeast\n    { name: \"Metro HVAC Solutions\", segment: \"HVAC\", region: \"Northeast\", assignedTm: sarah.name, baseRev: 245000, state: \"graduated\" },\n    { name: \"Allied Mechanical Group\", segment: \"Mechanical\", region: \"Mid-Atlantic\", assignedTm: sarah.name, baseRev: 198000, state: \"enrolled\" },\n    { name: \"Northeast Heating & Cooling\", segment: \"HVAC\", region: \"Northeast\", assignedTm: sarah.name, baseRev: 156000, state: \"enrolled\" },\n    { name: \"Premier Plumbing NJ\", segment: \"Plumbing\", region: \"Mid-Atlantic\", assignedTm: sarah.name, baseRev: 134000, state: \"candidate\" },\n    { name: \"Coastal Mechanical\", segment: \"Mechanical\", region: \"Northeast\", assignedTm: sarah.name, baseRev: 88000, state: \"at_risk\" },\n    // James's territory â€” Southeast\n    { name: \"Sunshine HVAC Florida\", segment: \"HVAC\", region: \"Florida\", assignedTm: james.name, baseRev: 189000, state: \"graduated\" },\n    { name: \"Gulf Coast Plumbing\", segment: \"Plumbing\", region: \"Southeast\", assignedTm: james.name, baseRev: 143000, state: \"enrolled\" },\n    { name: \"Tampa Bay Mechanical\", segment: \"Mechanical\", region: \"Florida\", assignedTm: james.name, baseRev: 210000, state: \"enrolled\" },\n    { name: \"Palmetto Heating & Air\", segment: \"HVAC\", region: \"Southeast\", assignedTm: james.name, baseRev: 97000, state: \"at_risk\" },\n    { name: \"Atlantic Plumbing Co\", segment: \"Plumbing\", region: \"Southeast\", assignedTm: james.name, baseRev: 72000, state: \"candidate\" },\n    { name: \"Carolina Climate Control\", segment: \"HVAC\", region: \"Southeast\", assignedTm: james.name, baseRev: 61000, state: \"candidate\" },\n    // Mike's territory â€” Midwest\n    { name: \"Great Lakes Heating\", segment: \"HVAC\", region: \"Great Lakes\", assignedTm: mike.name, baseRev: 178000, state: \"graduated\" },\n    { name: \"Midwest Pipe & Supply\", segment: \"Plumbing\", region: \"Midwest\", assignedTm: mike.name, baseRev: 162000, state: \"candidate\" },\n    { name: \"Heartland Mechanical\", segment: \"Mechanical\", region: \"Midwest\", assignedTm: mike.name, baseRev: 145000, state: \"enrolled\" },\n    { name: \"Chicago Comfort Systems\", segment: \"HVAC\", region: \"Great Lakes\", assignedTm: mike.name, baseRev: 118000, state: \"candidate\" },\n    { name: \"Lake Shore Plumbing\", segment: \"Plumbing\", region: \"Great Lakes\", assignedTm: mike.name, baseRev: 94000, state: \"candidate\" },\n    { name: \"Detroit Climate Pro\", segment: \"HVAC\", region: \"Midwest\", assignedTm: mike.name, baseRev: 87000, state: \"candidate\" },\n    { name: \"Ohio Valley HVAC\", segment: \"HVAC\", region: \"Midwest\", assignedTm: mike.name, baseRev: 76000, state: \"candidate\" },\n    { name: \"Buckeye Mechanical\", segment: \"Mechanical\", region: \"Great Lakes\", assignedTm: mike.name, baseRev: 234000, state: \"enrolled\" },\n    { name: \"Indiana Plumbing Services\", segment: \"Plumbing\", region: \"Midwest\", assignedTm: mike.name, baseRev: 58000, state: \"candidate\" },\n  ];\n\n  const accs = await db\n    .insert(accounts)\n    .values(\n      accountDefs.map((a) => ({\n        tenantId: TENANT_ID,\n        name: a.name,\n        segment: a.segment,\n        region: a.region,\n        assignedTm: a.assignedTm,\n        status: \"active\",\n      }))\n    )\n    .returning();\n  console.log(`âœ“ ${accs.length} accounts`);\n\n  // â”€â”€ Orders (12 months shaped by account state) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const orderRows: {\n    tenantId: number;\n    accountId: number;\n    orderDate: Date;\n    totalAmount: string;\n    marginAmount: string;\n  }[] = [];\n\n  for (let i = 0; i < accs.length; i++) {\n    const acc = accs[i];\n    const def = accountDefs[i];\n    const monthlyBase = def.baseRev / 12;\n\n    for (let mAgo = 11; mAgo >= 0; mAgo--) {\n      let multiplier = 1.0;\n\n      if (def.state === \"graduated\") {\n        // Clear upward trend throughout year\n        multiplier = 0.85 + (11 - mAgo) * 0.025;\n      } else if (def.state === \"enrolled\") {\n        // Flat first half, then uptick last 3 months\n        multiplier = mAgo > 3 ? 1.0 + Math.random() * 0.05 : 1.12 + Math.random() * 0.06;\n      } else if (def.state === \"at_risk\") {\n        // Slight decline in recent months; last 2 months very low\n        multiplier = mAgo > 2 ? 0.95 + Math.random() * 0.08 : 0.55 + Math.random() * 0.1;\n      } else {\n        // Candidates / no-program: steady moderate\n        multiplier = 0.9 + Math.random() * 0.2;\n      }\n\n      const numOrders = def.baseRev > 150000 ? 3 : 2;\n      for (let o = 0; o < numOrders; o++) {\n        const d = new Date();\n        d.setMonth(d.getMonth() - mAgo);\n        d.setDate(Math.floor(Math.random() * 25) + 1);\n        const amt = Math.floor((monthlyBase / numOrders) * multiplier);\n        orderRows.push({\n          tenantId: TENANT_ID,\n          accountId: acc.id,\n          orderDate: d,\n          totalAmount: String(amt),\n          marginAmount: String(Math.floor(amt * 0.26)),\n        });\n      }\n    }\n  }\n\n  const ordersCreated = await db.insert(orders).values(orderRows).returning();\n  console.log(`âœ“ ${ordersCreated.length} orders`);\n\n  // Order items â€” each order gets 2-4 line items\n  const itemRows: {\n    tenantId: number;\n    orderId: number;\n    productId: number;\n    quantity: string;\n    unitPrice: string;\n    lineTotal: string;\n  }[] = [];\n\n  for (const order of ordersCreated) {\n    const n = Math.floor(Math.random() * 3) + 2;\n    let rem = parseFloat(order.totalAmount);\n    for (let j = 0; j < n; j++) {\n      const prod = prods[Math.floor(Math.random() * prods.length)];\n      const line =\n        j === n - 1 ? rem : Math.floor((rem / (n - j)) * (0.5 + Math.random()));\n      rem -= line;\n      const up = parseFloat(prod.unitPrice);\n      itemRows.push({\n        tenantId: TENANT_ID,\n        orderId: order.id,\n        productId: prod.id,\n        quantity: String(Math.max(1, Math.round(line / up))),\n        unitPrice: String(up),\n        lineTotal: String(Math.max(1, Math.floor(line))),\n      });\n    }\n  }\n  await db.insert(orderItems).values(itemRows);\n  console.log(`âœ“ ${itemRows.length} order items`);\n\n  // â”€â”€ Segment Profiles (ICP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const profiles = await db\n    .insert(segmentProfiles)\n    .values([\n      {\n        tenantId: TENANT_ID,\n        segment: \"HVAC\",\n        name: \"Full-Scope HVAC Contractor\",\n        description: \"HVAC contractors who purchase across all major categories â€” equipment, refrigerant, controls, and water heaters\",\n        minAnnualRevenue: \"75000\",\n        status: \"approved\",\n        approvedBy: \"Admin\",\n        approvedAt: sql`CURRENT_TIMESTAMP`,\n      },\n      {\n        tenantId: TENANT_ID,\n        segment: \"Plumbing\",\n        name: \"Full-Scope Plumbing Contractor\",\n        description: \"Plumbing contractors purchasing pipe, fixtures, water heaters, and drainage across all job types\",\n        minAnnualRevenue: \"60000\",\n        status: \"approved\",\n        approvedBy: \"Admin\",\n        approvedAt: sql`CURRENT_TIMESTAMP`,\n      },\n      {\n        tenantId: TENANT_ID,\n        segment: \"Mechanical\",\n        name: \"Commercial Mechanical Contractor\",\n        description: \"Commercial mechanical with diverse HVAC and plumbing needs â€” highest-value segment\",\n        minAnnualRevenue: \"100000\",\n        status: \"approved\",\n        approvedBy: \"Admin\",\n        approvedAt: sql`CURRENT_TIMESTAMP`,\n      },\n    ])\n    .returning();\n\n  const pcRows: {\n    tenantId: number;\n    profileId: number;\n    categoryId: number;\n    expectedPct: string;\n    importance: string;\n    isRequired: boolean;\n    notes?: string;\n  }[] = [\n      // HVAC ICP\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[0].id, expectedPct: \"35\", importance: \"1\", isRequired: true },\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[1].id, expectedPct: \"18\", importance: \"1\", isRequired: true },\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[2].id, expectedPct: \"15\", importance: \"1\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[3].id, expectedPct: \"12\", importance: \"1.5\", isRequired: false, notes: \"Growing â€” smart thermostats\" },\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[4].id, expectedPct: \"10\", importance: \"2\", isRequired: false, notes: \"Strategic â€” high margin\" },\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[5].id, expectedPct: \"5\", importance: \"0.5\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[0].id, categoryId: cats[10].id, expectedPct: \"5\", importance: \"1\", isRequired: false },\n      // Plumbing ICP\n      { tenantId: TENANT_ID, profileId: profiles[1].id, categoryId: cats[6].id, expectedPct: \"30\", importance: \"1\", isRequired: true },\n      { tenantId: TENANT_ID, profileId: profiles[1].id, categoryId: cats[7].id, expectedPct: \"20\", importance: \"1\", isRequired: true },\n      { tenantId: TENANT_ID, profileId: profiles[1].id, categoryId: cats[4].id, expectedPct: \"18\", importance: \"2\", isRequired: false, notes: \"Strategic â€” water heaters\" },\n      { tenantId: TENANT_ID, profileId: profiles[1].id, categoryId: cats[8].id, expectedPct: \"15\", importance: \"1\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[1].id, categoryId: cats[9].id, expectedPct: \"10\", importance: \"1\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[1].id, categoryId: cats[5].id, expectedPct: \"7\", importance: \"0.5\", isRequired: false },\n      // Mechanical ICP\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[0].id, expectedPct: \"25\", importance: \"1\", isRequired: true },\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[6].id, expectedPct: \"20\", importance: \"1\", isRequired: true },\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[2].id, expectedPct: \"15\", importance: \"1\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[7].id, expectedPct: \"12\", importance: \"1\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[10].id, expectedPct: \"10\", importance: \"1.5\", isRequired: false, notes: \"Commercial insulation\" },\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[11].id, expectedPct: \"10\", importance: \"1\", isRequired: false },\n      { tenantId: TENANT_ID, profileId: profiles[2].id, categoryId: cats[5].id, expectedPct: \"8\", importance: \"0.5\", isRequired: false },\n    ];\n  await db.insert(profileCategories).values(pcRows);\n  console.log(`âœ“ ${profiles.length} segment profiles`);\n\n  // â”€â”€ Account Metrics & Gaps (scripted per account) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  // Opportunity scores tied to demo state\n  const scoreByState: Record<string, number> = {\n    graduated: 62,\n    enrolled: 74,\n    at_risk: 55,\n    candidate: 85,\n  };\n\n  // Scripted gaps: [categoryIndex, expectedPct, actualPct]\n  const scriptedGaps: Record<string, [number, number, number][]> = {\n    \"Metro HVAC Solutions\": [[3, 12, 11], [4, 10, 9]],          // almost closed â€” graduated\n    \"Allied Mechanical Group\": [[7, 12, 3], [10, 10, 0], [11, 10, 2]],  // $58K opp\n    \"Northeast Heating & Cooling\": [[4, 10, 1], [3, 12, 2]],           // water heater + controls gap\n    \"Coastal Mechanical\": [[4, 10, 0], [7, 12, 1]],           // stalled gaps â€” at risk\n    \"Sunshine HVAC Florida\": [[3, 12, 11], [4, 10, 10]],         // graduated â€” gaps closed\n    \"Gulf Coast Plumbing\": [[9, 10, 2], [4, 18, 3]],           // drainage + water heater\n    \"Tampa Bay Mechanical\": [[10, 10, 0], [11, 10, 2], [7, 12, 3]], // $58K opp\n    \"Palmetto Heating & Air\": [[3, 12, 1], [4, 10, 0]],           // at risk â€” competitor\n    \"Great Lakes Heating\": [[3, 12, 11], [4, 10, 9]],          // graduated\n    \"Midwest Pipe & Supply\": [[7, 20, 3], [4, 18, 2]],           // high score candidate\n    \"Heartland Mechanical\": [[10, 10, 0], [11, 10, 1]],         // early enrolled\n    \"Buckeye Mechanical\": [[7, 12, 2], [10, 10, 0], [11, 10, 3]], // big account\n  };\n\n  const metricsRows: {\n    tenantId: number;\n    accountId: number;\n    last12mRevenue: string;\n    last3mRevenue: string;\n    yoyGrowthRate: string;\n    categoryCount: number;\n    categoryPenetration: string;\n    categoryGapScore: string;\n    opportunityScore: string;\n    matchedProfileId: number;\n  }[] = [];\n\n  const gapRows: {\n    tenantId: number;\n    accountId: number;\n    categoryId: number;\n    expectedPct: string;\n    actualPct: string;\n    gapPct: string;\n    estimatedOpportunity: string;\n  }[] = [];\n\n  for (let i = 0; i < accs.length; i++) {\n    const acc = accs[i];\n    const def = accountDefs[i];\n    const score =\n      (scoreByState[def.state] || 75) + Math.floor(Math.random() * 8 - 4);\n    const penetration =\n      def.state === \"graduated\" ? 68 + Math.floor(Math.random() * 8) :\n        def.state === \"enrolled\" ? 45 + Math.floor(Math.random() * 12) :\n          def.state === \"at_risk\" ? 32 + Math.floor(Math.random() * 8) :\n            28 + Math.floor(Math.random() * 15);\n    const yoy =\n      def.state === \"graduated\" ? 22 + Math.floor(Math.random() * 8) :\n        def.state === \"enrolled\" ? 12 + Math.floor(Math.random() * 6) :\n          def.state === \"at_risk\" ? -5 + Math.floor(Math.random() * 4) :\n            5 + Math.floor(Math.random() * 8);\n    const profile =\n      def.segment === \"HVAC\" ? profiles[0] :\n        def.segment === \"Plumbing\" ? profiles[1] : profiles[2];\n\n    metricsRows.push({\n      tenantId: TENANT_ID,\n      accountId: acc.id,\n      last12mRevenue: String(def.baseRev),\n      last3mRevenue: String(Math.floor((def.baseRev / 4) * (1 + yoy / 100))),\n      yoyGrowthRate: String(yoy),\n      categoryCount: Math.floor(penetration / 10),\n      categoryPenetration: String(penetration),\n      categoryGapScore: String(100 - penetration),\n      opportunityScore: String(Math.max(50, Math.min(99, score))),\n      matchedProfileId: profile.id,\n    });\n\n    const gaps = scriptedGaps[def.name];\n    if (gaps) {\n      for (const [catIdx, exp, act] of gaps) {\n        const gap = exp - act;\n        gapRows.push({\n          tenantId: TENANT_ID,\n          accountId: acc.id,\n          categoryId: cats[catIdx].id,\n          expectedPct: String(exp),\n          actualPct: String(act),\n          gapPct: String(gap),\n          estimatedOpportunity: String(Math.floor(def.baseRev * (gap / 100))),\n        });\n      }\n    } else {\n      // Generic gaps for unlisted accounts\n      for (let g = 0; g < 2; g++) {\n        const catIdx = (i + g * 3) % cats.length;\n        const exp = 12 + g * 4;\n        const act = Math.floor(Math.random() * 4);\n        gapRows.push({\n          tenantId: TENANT_ID,\n          accountId: acc.id,\n          categoryId: cats[catIdx].id,\n          expectedPct: String(exp),\n          actualPct: String(act),\n          gapPct: String(exp - act),\n          estimatedOpportunity: String(Math.floor(def.baseRev * ((exp - act) / 100))),\n        });\n      }\n    }\n  }\n\n  await db.insert(accountMetrics).values(metricsRows);\n  await db.insert(accountCategoryGaps).values(gapRows);\n  console.log(\"âœ“ Account metrics & gaps\");\n\n  // â”€â”€ Playbooks (4 named, scripted) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const pbs = await db\n    .insert(playbooks)\n    .values([\n      {\n        tenantId: TENANT_ID,\n        name: \"Water Heater Expansion â€” Q1\",\n        generatedBy: \"AI VP Dashboard\",\n        taskCount: 6,\n        filtersUsed: { segment: [\"HVAC\", \"Plumbing\"], category: \"Water Heaters\" },\n      },\n      {\n        tenantId: TENANT_ID,\n        name: \"PVF Category Recovery\",\n        generatedBy: \"AI VP Dashboard\",\n        taskCount: 5,\n        filtersUsed: { segment: [\"Plumbing\", \"Mechanical\"], category: \"PVF\" },\n      },\n      {\n        tenantId: TENANT_ID,\n        name: \"Smart Thermostat Upsell â€” Controls Push\",\n        generatedBy: \"AI VP Dashboard\",\n        taskCount: 4,\n        filtersUsed: { segment: [\"HVAC\"], category: \"Controls & Thermostats\" },\n      },\n      {\n        tenantId: TENANT_ID,\n        name: \"At-Risk Account Recovery\",\n        generatedBy: \"AI VP Dashboard\",\n        taskCount: 3,\n        filtersUsed: { enrollmentStatus: \"at_risk\" },\n      },\n    ])\n    .returning();\n  console.log(`âœ“ ${pbs.length} playbooks`);\n\n  // â”€â”€ Tasks (scripted call/email scripts per playbook) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const waterHeaterCall = `Hi [Contact], this is [Rep] from ABC Supply. I wanted to reach out because I've been reviewing your account and noticed a big opportunity on the water heater side.\n\nWe just became a preferred Bradford White and Rheem distributor â€” which means contractor-exclusive pricing and same-day availability on the 20 most popular models.\n\nGiven your volume in HVAC and plumbing, I estimate you could save $400-600/month by consolidating your water heater purchases with us.\n\nCan I put together a custom quote based on your typical install mix?`;\n\n  const waterHeaterEmail = `Subject: Water Heater Opportunity â€” Contractor-Exclusive Pricing\n\nHi [Contact],\n\nI've been looking at your account and want to flag a big opportunity before Q2: we just became a preferred Bradford White and Rheem distributor.\n\nWhat this means for you:\nâ€¢ Contractor pricing 10-15% below retail distributors\nâ€¢ Same-day availability on 20 most popular residential models  \nâ€¢ Free jobsite delivery on orders over $500\n\nBased on your typical volume, I estimate this saves you $400-600 per month.\n\nWould you share what models you install most? I'll put together a custom quote this week.\n\nBest, [Rep]`;\n\n  const pvfCall = `Hi [Contact], this is [Rep] from ABC Supply. Quick call â€” I know you're sourcing pipe, valves, and fittings from a few different places right now.\n\nWe've significantly expanded our PVF inventory and now stock full lines of brass, copper, and plastic. Single-source convenience, next-day delivery, volume discounts on case orders.\n\nCan I send you our updated PVF pricing sheet and a sample quote?`;\n\n  const thermostatCall = `Hi [Contact], [Rep] from ABC Supply. Wanted to flag our Q1 thermostat promotion before it closes.\n\n15% off all Honeywell and Ecobee smart thermostats, and buy-10-get-1-free on Nest Learning. Given your HVAC installation volume, I think you'd see solid savings.\n\nWould you be interested in a quote for your typical monthly quantity?`;\n\n  const atRiskCall = `Hi [Contact], this is [Rep] from ABC Supply. I wanted to check in â€” I noticed we haven't seen an order from you in a few weeks and wanted to make sure everything is going smoothly.\n\nIs there anything we can do better on service, pricing, or availability? I want to make sure we're continuing to earn your business.\n\nIs there 10 minutes this week to reconnect?`;\n\n  const now = new Date();\n  const taskDefs: {\n    tenantId: number;\n    accountId: number;\n    assignedTm: string;\n    taskType: \"call\" | \"email\" | \"visit\";\n    title: string;\n    description: string;\n    script: string;\n    gapCategories: string[];\n    status: string;\n    dueDate: Date;\n    completedAt: Date | null;\n    outcome: string | null;\n  }[] = [];\n\n  // Sarah's tasks\n  const sarahAccounts = accs.filter((_, i) => accountDefs[i].assignedTm === sarah.name);\n  const [metroHvac, allied, neHeating, , coastalMech] = sarahAccounts;\n\n  const due = (days: number) => { const d = new Date(now); d.setDate(d.getDate() + days); return d; };\n  const past = (days: number) => { const d = new Date(now); d.setDate(d.getDate() - days); return d; };\n\n  taskDefs.push(\n    { tenantId: TENANT_ID, accountId: neHeating.id, assignedTm: sarah.name, taskType: \"call\", title: \"Call: Introduce Bradford White Water Heater Program\", description: \"Northeast Heating hasn't ordered water heaters in 6 months. 10% gap vs ICP.\", script: waterHeaterCall, gapCategories: [\"Water Heaters\"], status: \"pending\", dueDate: due(2), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: allied.id, assignedTm: sarah.name, taskType: \"email\", title: \"Email: PVF Pricing Sheet â€” Allied Mechanical\", description: \"Allied has a $28K PVF gap. Send pricing sheet to purchasing manager.\", script: waterHeaterEmail.replace(\"Water Heater Opportunity\", \"PVF Pricing â€” Let's Consolidate Your Pipe & Valves\"), gapCategories: [\"PVF (Pipe, Valves, Fittings)\"], status: \"in_progress\", dueDate: due(1), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: coastalMech.id, assignedTm: sarah.name, taskType: \"call\", title: \"Call: At-Risk Check-In â€” Coastal Mechanical\", description: \"90 days enrolled, no revenue growth. Last order 47 days ago.\", script: atRiskCall, gapCategories: [\"Water Heaters\", \"PVF (Pipe, Valves, Fittings)\"], status: \"pending\", dueDate: due(0), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: metroHvac.id, assignedTm: sarah.name, taskType: \"call\", title: \"Call: Controls Upsell â€” Metro HVAC (Completed)\", description: \"Completed controls pitch â€” customer agreed to trial order.\", script: thermostatCall, gapCategories: [\"Controls & Thermostats\"], status: \"completed\", dueDate: past(10), completedAt: past(8), outcome: \"Positive â€” customer placed a trial order for 10 Honeywell T6 Pro units. Follow up in 30 days.\" },\n  );\n\n  // James's tasks\n  const jamesAccounts = accs.filter((_, i) => accountDefs[i].assignedTm === james.name);\n  const [, gulfCoast, tampaBay, palmetto] = jamesAccounts;\n\n  taskDefs.push(\n    { tenantId: TENANT_ID, accountId: palmetto.id, assignedTm: james.name, taskType: \"call\", title: \"URGENT Call: Palmetto â€” Competitor Mention Detected\", description: \"Ferguson quote mentioned in email. Act within 24 hours.\", script: atRiskCall, gapCategories: [\"Controls & Thermostats\"], status: \"pending\", dueDate: due(0), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: tampaBay.id, assignedTm: james.name, taskType: \"email\", title: \"Email: Insulation & Electrical Quote â€” Tampa Bay Mechanical\", description: \"Tampa Bay has $58K combined opportunity in insulation and electrical.\", script: pvfCall, gapCategories: [\"Insulation Materials\", \"Electrical Components\"], status: \"pending\", dueDate: due(3), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: gulfCoast.id, assignedTm: james.name, taskType: \"call\", title: \"Call: Drainage Systems Introduction â€” Gulf Coast Plumbing\", description: \"Gulf Coast has 0% spend in drainage vs 10% ICP target.\", script: pvfCall, gapCategories: [\"Drainage Systems\"], status: \"pending\", dueDate: due(5), completedAt: null, outcome: null },\n  );\n\n  // Mike's tasks\n  const mikeAccounts = accs.filter((_, i) => accountDefs[i].assignedTm === mike.name);\n  const [, midwestPipe, heartland, , , , , buckeye] = mikeAccounts;\n\n  taskDefs.push(\n    { tenantId: TENANT_ID, accountId: midwestPipe.id, assignedTm: mike.name, taskType: \"call\", title: \"Call: Midwest Pipe â€” Top Unenrolled Opportunity (Score 89)\", description: \"No outreach logged in 45 days. $162K account with major PVF gap.\", script: pvfCall, gapCategories: [\"PVF (Pipe, Valves, Fittings)\"], status: \"pending\", dueDate: due(1), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: heartland.id, assignedTm: mike.name, taskType: \"email\", title: \"Email: Welcome Package â€” Heartland Mechanical (Just Enrolled)\", description: \"Send intro email and attach playbook summary within first week of enrollment.\", script: waterHeaterEmail, gapCategories: [\"Insulation Materials\", \"Electrical Components\"], status: \"pending\", dueDate: due(2), completedAt: null, outcome: null },\n    { tenantId: TENANT_ID, accountId: buckeye.id, assignedTm: mike.name, taskType: \"call\", title: \"Call: Buckeye Mechanical â€” PVF Consolidation Opportunity\", description: \"Buckeye is the highest-revenue enrolled account. $27K PVF gap.\", script: pvfCall, gapCategories: [\"PVF (Pipe, Valves, Fittings)\"], status: \"in_progress\", dueDate: due(4), completedAt: null, outcome: null },\n  );\n\n  const createdTasks = await db.insert(tasks).values(taskDefs).returning();\n  console.log(`âœ“ ${createdTasks.length} tasks`);\n\n  // Link tasks to playbooks\n  const ptLinks: { tenantId: number; playbookId: number; taskId: number }[] = [];\n  createdTasks.forEach((t, i) => {\n    const pbIdx = i < 4 ? 0 : i < 7 ? 1 : 2;\n    ptLinks.push({ tenantId: TENANT_ID, playbookId: pbs[pbIdx % pbs.length].id, taskId: t.id });\n  });\n  await db.insert(playbookTasks).values(ptLinks);\n\n  // â”€â”€ Program Accounts (enrolled/graduated/at_risk) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const programDefs = [\n    // Graduated\n    { accIdx: 0, state: \"graduated\", daysIn: 82, revenueStart: 245000, revenueEnd: 312000, tm: sarah.name, note: \"Met all ICP category targets; controls and water heater gaps closed\" },\n    { accIdx: 5, state: \"graduated\", daysIn: 71, revenueStart: 189000, revenueEnd: 241000, tm: james.name, note: \"Fastest graduation â€” consistent 18% MoM growth\" },\n    { accIdx: 11, state: \"graduated\", daysIn: 90, revenueStart: 178000, revenueEnd: 228000, tm: mike.name, note: \"Enrolled by previous TM; Mike inherited and closed successfully\" },\n    // Enrolled active\n    { accIdx: 1, state: \"active\", daysIn: 62, revenueStart: 198000, revenueEnd: null, tm: sarah.name, note: null },\n    { accIdx: 2, state: \"active\", daysIn: 31, revenueStart: 156000, revenueEnd: null, tm: sarah.name, note: null },\n    { accIdx: 6, state: \"active\", daysIn: 45, revenueStart: 143000, revenueEnd: null, tm: james.name, note: null },\n    { accIdx: 7, state: \"active\", daysIn: 28, revenueStart: 210000, revenueEnd: null, tm: james.name, note: null },\n    { accIdx: 13, state: \"active\", daysIn: 19, revenueStart: 145000, revenueEnd: null, tm: mike.name, note: null },\n    { accIdx: 18, state: \"active\", daysIn: 55, revenueStart: 234000, revenueEnd: null, tm: mike.name, note: null },\n    // At risk\n    { accIdx: 4, state: \"at_risk\", daysIn: 90, revenueStart: 88000, revenueEnd: null, tm: sarah.name, note: null },\n    { accIdx: 8, state: \"at_risk\", daysIn: 68, revenueStart: 97000, revenueEnd: null, tm: james.name, note: null },\n  ];\n\n  const baselineStart = new Date(now);\n  baselineStart.setFullYear(baselineStart.getFullYear() - 1);\n  const baselineEnd = new Date(now);\n  baselineEnd.setMonth(baselineEnd.getMonth() - 1);\n\n  const paRows = programDefs.map((pd) => {\n    const enrolledAt = new Date(now);\n    enrolledAt.setDate(enrolledAt.getDate() - pd.daysIn);\n    const graduatedAt = pd.state === \"graduated\" ? new Date(now) : null;\n    if (graduatedAt) graduatedAt.setDate(graduatedAt.getDate() - 5);\n\n    return {\n      tenantId: TENANT_ID,\n      accountId: accs[pd.accIdx].id,\n      enrolledBy: pd.tm,\n      baselineStart,\n      baselineEnd,\n      baselineRevenue: String(pd.revenueStart),\n      shareRate: \"0.15\",\n      status: pd.state,\n      targetPenetration: \"75\",\n      targetIncrementalRevenue: String(Math.floor(pd.revenueStart * 0.3)),\n      targetDurationMonths: 90,\n      graduationCriteria: \"any\",\n      graduatedAt,\n      graduationNotes: pd.note,\n      ...(pd.state === \"graduated\" && pd.revenueEnd ? {\n        graduationRevenue: String(pd.revenueEnd),\n        incrementalRevenue: String(pd.revenueEnd - pd.revenueStart),\n        enrollmentDurationDays: pd.daysIn,\n        icpCategoriesAtEnrollment: 3,\n        icpCategoriesAchieved: 2,\n        graduationPenetration: \"85\"\n      } : {})\n    };\n  });\n\n  const programAccsCreated = await db.insert(programAccounts).values(paRows).returning();\n  console.log(`âœ“ ${programAccsCreated.length} program accounts`);\n\n  // Revenue snapshots â€” 7 months of data shaped by state\n  for (let p = 0; p < programAccsCreated.length; p++) {\n    const pa = programAccsCreated[p];\n    const pd = programDefs[p];\n    const baseline = pd.revenueStart;\n\n    for (let i = 6; i >= 0; i--) {\n      let growthFactor = 1.0;\n      if (pd.state === \"graduated\") growthFactor = 1 + (6 - i) * 0.045;\n      else if (pd.state === \"active\") growthFactor = i > 3 ? 1.0 : 1 + (4 - i) * 0.035;\n      else growthFactor = i > 2 ? 0.97 : 0.72; // at_risk: recently declined\n\n      const periodStart = new Date(now);\n      periodStart.setMonth(periodStart.getMonth() - (i + 1));\n      const periodEnd = new Date(now);\n      periodEnd.setMonth(periodEnd.getMonth() - i);\n      const periodRevenue = Math.floor((baseline / 12) * growthFactor);\n      const baselineMonthly = Math.floor(baseline / 12);\n      const incremental = Math.max(0, periodRevenue - baselineMonthly);\n\n      await db.insert(programRevenueSnapshots).values({\n        programAccountId: pa.id,\n        periodStart,\n        periodEnd,\n        periodRevenue: String(periodRevenue),\n        baselineComparison: String(baselineMonthly),\n        incrementalRevenue: String(incremental),\n        feeAmount: String(Math.floor(incremental * 0.15)),\n      });\n    }\n  }\n  console.log(\"âœ“ Revenue snapshots\");\n\n  // â”€â”€ Rev-share tiers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.insert(revShareTiers).values([\n    { tenantId: TENANT_ID, minRevenue: \"0\", maxRevenue: \"50000\", shareRate: \"15\", displayOrder: 1, isActive: true },\n    { tenantId: TENANT_ID, minRevenue: \"50000\", maxRevenue: \"150000\", shareRate: \"12\", displayOrder: 2, isActive: true },\n    { tenantId: TENANT_ID, minRevenue: \"150000\", maxRevenue: null, shareRate: \"10\", displayOrder: 3, isActive: true },\n  ]);\n\n  // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.insert(settings).values([\n    { tenantId: TENANT_ID, key: \"companyName\", value: \"ABC Supply Co.\" },\n    { tenantId: TENANT_ID, key: \"appTitle\", value: \"Wallet Share Expander\" },\n  ]);\n\n  // â”€â”€ Data uploads (history) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.insert(dataUploads).values([\n    { tenantId: TENANT_ID, uploadType: \"accounts\", fileName: \"mark_supply_accounts_2024.csv\", rowCount: 487, status: \"completed\", uploadedBy: \"Graham\" },\n    { tenantId: TENANT_ID, uploadType: \"orders\", fileName: \"orders_q3_q4_2023.csv\", rowCount: 15234, status: \"completed\", uploadedBy: \"Graham\" },\n    { tenantId: TENANT_ID, uploadType: \"orders\", fileName: \"orders_q1_q2_2024.csv\", rowCount: 12891, status: \"completed\", uploadedBy: \"Graham\" },\n    { tenantId: TENANT_ID, uploadType: \"products\", fileName: \"product_catalog_v3.csv\", rowCount: 2341, status: \"completed\", uploadedBy: \"Graham\" },\n    { tenantId: TENANT_ID, uploadType: \"categories\", fileName: \"category_taxonomy.csv\", rowCount: 156, status: \"completed\", uploadedBy: \"Graham\" },\n  ]);\n\n  // â”€â”€ Subscription plans â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.delete(subscriptionPlans);\n  await db.insert(subscriptionPlans).values([\n    {\n      name: \"Starter\",\n      slug: \"starter\",\n      stripeMonthlyPriceId: null,\n      stripeYearlyPriceId: null,\n      monthlyPrice: \"0\",\n      yearlyPrice: \"0\",\n      features: [\"1 enrolled account\", \"Basic gap analysis\", \"Standard playbooks\", \"Email support\"],\n      limits: { accounts: 1, users: 1 },\n      isActive: true,\n      displayOrder: 1,\n    },\n    {\n      name: \"Growth\",\n      slug: \"growth\",\n      stripeMonthlyPriceId: null,\n      stripeYearlyPriceId: null,\n      monthlyPrice: \"299\",\n      yearlyPrice: \"2990\",\n      features: [\"Up to 20 enrolled accounts\", \"3 territory managers\", \"AI gap analysis\", \"Playbooks with call scripts\", \"Email support\"],\n      limits: { accounts: 20, users: 3 },\n      isActive: true,\n      displayOrder: 2,\n    },\n    {\n      name: \"Scale\",\n      slug: \"scale\",\n      stripeMonthlyPriceId: null,\n      stripeYearlyPriceId: null,\n      monthlyPrice: \"699\",\n      yearlyPrice: \"6990\",\n      features: [\"Unlimited enrolled accounts\", \"Unlimited territory managers\", \"Agentic daily briefings\", \"Email intelligence\", \"Ask Anything AI\", \"Priority support\"],\n      limits: { accounts: -1, users: -1 },\n      isActive: true,\n      displayOrder: 3,\n    },\n    {\n      name: \"Enterprise\",\n      slug: \"enterprise\",\n      stripeMonthlyPriceId: null,\n      stripeYearlyPriceId: null,\n      monthlyPrice: \"0\",\n      yearlyPrice: \"0\",\n      features: [\"Unlimited everything\", \"CRM integration\", \"Custom AI training\", \"White-label\", \"Dedicated CSM\", \"SSO\"],\n      limits: { accounts: -1, users: -1 },\n      isActive: true,\n      displayOrder: 4,\n    },\n  ]);\n\n  // â”€â”€ Agent Detail Tables (contacts, spend, interactions, playbooks, competitors) â”€â”€\n  await db.delete(agentContacts).where(sql`tenant_id = ${TENANT_ID}`);\n  await db.delete(agentAccountCategorySpend).where(sql`tenant_id = ${TENANT_ID}`);\n  await db.delete(agentInteractions).where(sql`tenant_id = ${TENANT_ID}`);\n  await db.delete(agentPlaybooks).where(sql`tenant_id = ${TENANT_ID}`);\n  await db.delete(agentAccountCompetitors).where(sql`tenant_id = ${TENANT_ID}`);\n  await db.delete(agentCompetitors).where(sql`tenant_id = ${TENANT_ID}`);\n  await db.delete(agentPlaybookLearnings).where(sql`tenant_id = ${TENANT_ID}`);\n\n  // Contacts for priority accounts\n  await db.insert(agentContacts).values([\n    { tenantId: TENANT_ID, accountId: accs[12].id, name: \"Mike Thornton\", role: \"purchasing_mgr\", email: \"mthornton@midwestpipe.com\", isPrimary: true },\n    { tenantId: TENANT_ID, accountId: accs[12].id, name: \"Sarah Chen\", role: \"coo\", email: \"schen@midwestpipe.com\", isPrimary: false },\n    { tenantId: TENANT_ID, accountId: accs[8].id, name: \"James Rivera\", role: \"owner\", email: \"jrivera@palmettoheating.com\", isPrimary: true },\n    { tenantId: TENANT_ID, accountId: accs[8].id, name: \"Tom Nguyen\", role: \"ap\", email: \"tnguyen@palmettoheating.com\", isPrimary: false },\n    { tenantId: TENANT_ID, accountId: accs[1].id, name: \"Dave Morrison\", role: \"purchasing_mgr\", email: \"dmorrison@alliedmech.com\", isPrimary: true },\n    { tenantId: TENANT_ID, accountId: accs[1].id, name: \"Linda Hayes\", role: \"owner\", email: \"lhayes@alliedmech.com\", isPrimary: false },\n  ]);\n  console.log(\"âœ“ Agent contacts seeded\");\n\n  // Category spend gaps for priority accounts\n  const thirtyDaysAgo = new Date(now.getTime() - 30 * 86400000);\n  const sixtyDaysAgo = new Date(now.getTime() - 60 * 86400000);\n  await db.insert(agentAccountCategorySpend).values([\n    { tenantId: TENANT_ID, accountId: accs[12].id, categoryId: 1, currentSpend: \"4200\", potentialSpend: \"31700\", gapPercentage: \"86.8\", gapDollars: \"27500\", lastOrderDate: sixtyDaysAgo, daysSinceOrder: 60, trend: \"new_gap\" },\n    { tenantId: TENANT_ID, accountId: accs[12].id, categoryId: 3, currentSpend: \"8100\", potentialSpend: \"34000\", gapPercentage: \"76.2\", gapDollars: \"25900\", lastOrderDate: thirtyDaysAgo, daysSinceOrder: 30, trend: \"declining\" },\n    { tenantId: TENANT_ID, accountId: accs[12].id, categoryId: 2, currentSpend: \"18500\", potentialSpend: \"22000\", gapPercentage: \"15.9\", gapDollars: \"3500\", lastOrderDate: thirtyDaysAgo, daysSinceOrder: 30, trend: \"stable\" },\n    { tenantId: TENANT_ID, accountId: accs[8].id, categoryId: 4, currentSpend: \"3200\", potentialSpend: \"13900\", gapPercentage: \"77\", gapDollars: \"10700\", lastOrderDate: thirtyDaysAgo, daysSinceOrder: 30, trend: \"declining\" },\n    { tenantId: TENANT_ID, accountId: accs[8].id, categoryId: 1, currentSpend: \"12800\", potentialSpend: \"18000\", gapPercentage: \"28.9\", gapDollars: \"5200\", lastOrderDate: thirtyDaysAgo, daysSinceOrder: 30, trend: \"stable\" },\n    { tenantId: TENANT_ID, accountId: accs[1].id, categoryId: 1, currentSpend: \"6200\", potentialSpend: \"24000\", gapPercentage: \"74.2\", gapDollars: \"17800\", lastOrderDate: sixtyDaysAgo, daysSinceOrder: 60, trend: \"new_gap\" },\n    { tenantId: TENANT_ID, accountId: accs[1].id, categoryId: 2, currentSpend: \"22400\", potentialSpend: \"28000\", gapPercentage: \"20\", gapDollars: \"5600\", lastOrderDate: thirtyDaysAgo, daysSinceOrder: 30, trend: \"growing\" },\n  ]);\n  console.log(\"âœ“ Agent category spend seeded\");\n\n  // Recent interactions\n  await db.insert(agentInteractions).values([\n    { tenantId: TENANT_ID, accountId: accs[12].id, interactionType: \"email\", direction: \"outbound\", subject: \"PVF Pricing Sheet â€” Midwest Pipe\", body: \"Sent updated PVF pricing sheet with volume discounts.\", occurredAt: new Date(now.getTime() - 3 * 86400000), sentimentSignal: \"neutral\" },\n    { tenantId: TENANT_ID, accountId: accs[12].id, interactionType: \"call\", direction: \"outbound\", subject: \"Intro call â€” Mike Thornton\", body: \"Discussed current PVF sourcing. Currently buying from local distributor. Interested in seeing competitive pricing.\", occurredAt: new Date(now.getTime() - 10 * 86400000), sentimentSignal: \"positive\" },\n    { tenantId: TENANT_ID, accountId: accs[8].id, interactionType: \"email\", direction: \"inbound\", subject: \"RE: Controls Quote Follow-up\", body: \"James mentioned Ferguson sent a competitive quote for Controls & Thermostats. Needs response within the week.\", occurredAt: new Date(now.getTime() - 1 * 86400000), sentimentSignal: \"competitor_mention\" },\n    { tenantId: TENANT_ID, accountId: accs[8].id, interactionType: \"call\", direction: \"outbound\", subject: \"Quarterly review â€” Palmetto Heating\", body: \"Reviewed Q4 spend. Revenue flat. James satisfied with HVAC supply but exploring Controls options.\", occurredAt: new Date(now.getTime() - 14 * 86400000), sentimentSignal: \"neutral\" },\n    { tenantId: TENANT_ID, accountId: accs[1].id, interactionType: \"email\", direction: \"outbound\", subject: \"PVF Volume Discount Proposal\", body: \"Sent proposal for PVF volume discount program. $17.8K gap identified.\", occurredAt: new Date(now.getTime() - 5 * 86400000), sentimentSignal: \"positive\" },\n    { tenantId: TENANT_ID, accountId: accs[1].id, interactionType: \"call\", direction: \"inbound\", subject: \"Order inquiry â€” Allied Mechanical\", body: \"Dave called about lead times for copper fittings. Good engagement signal.\", occurredAt: new Date(now.getTime() - 7 * 86400000), sentimentSignal: \"positive\" },\n  ]);\n  console.log(\"âœ“ Agent interactions seeded\");\n\n  // Active playbooks\n  await db.insert(agentPlaybooks).values([\n    {\n      tenantId: TENANT_ID, accountId: accs[12].id, status: \"active\",\n      playbookJson: {\n        playbook_type: \"gap_closure\",\n        priority_action: \"Schedule PVF demo with Mike Thornton. Show volume pricing vs current local distributor.\",\n        urgency_level: \"immediate\",\n        email_subject: \"ABC Supply PVF Solutions for Midwest Pipe\",\n        email_draft: \"Hi Mike,\\n\\nFollowing up on our conversation about your PVF sourcing. I've put together a custom pricing sheet that shows how we can save you up to 15% on your current PVF spend.\\n\\nWould you have 15 minutes this week to review? I can walk you through our volume discount program.\\n\\nBest,\\nYour ABC Supply Rep\",\n        talking_points: [\n          \"Current PVF gap is $27.5K â€” largest single opportunity in territory\",\n          \"Volume discount tiers: 5% at $10K/mo, 10% at $20K/mo, 15% at $30K/mo\",\n          \"Same-day delivery from local warehouse vs 3-day from current distributor\",\n          \"Reference: Similar account (Summit Mechanical) closed $22K PVF gap in 45 days\",\n        ],\n        call_script: \"Hi Mike, this is [Rep Name] from ABC Supply. I wanted to follow up on the PVF pricing sheet I sent over. I noticed you're currently sourcing from a local distributor, and I think we can offer significantly better pricing with our volume discount program. Do you have a few minutes to discuss?\",\n      },\n      focusCategories: [\"PVF\", \"Water Heaters\"],\n    },\n    {\n      tenantId: TENANT_ID, accountId: accs[8].id, status: \"active\",\n      playbookJson: {\n        playbook_type: \"competitive_defense\",\n        priority_action: \"Counter Ferguson quote on Controls & Thermostats. Prepare competitive pricing within 24 hours.\",\n        urgency_level: \"immediate\",\n        email_subject: \"Updated Controls & Thermostats Pricing â€” Palmetto Heating\",\n        email_draft: \"Hi James,\\n\\nI heard you received a quote from another supplier for Controls & Thermostats. I want to make sure we're giving you the best value.\\n\\nI've prepared an updated pricing sheet that matches or beats any competitive offer, plus includes our same-day delivery guarantee and dedicated tech support line.\\n\\nCan we connect today to review?\\n\\nBest,\\nYour ABC Supply Rep\",\n        talking_points: [\n          \"Ferguson quote likely doesn't include installation support or same-day delivery\",\n          \"$10.7K Controls gap â€” we can close this with competitive pricing\",\n          \"Existing relationship: Palmetto has been a loyal HVAC customer for 2+ years\",\n          \"Offer: Match Ferguson pricing + 5% loyalty discount on first order\",\n        ],\n        call_script: \"Hi James, this is [Rep Name] from ABC Supply. I understand you received a competitive quote for Controls & Thermostats. I want to make sure we earn your business â€” I've put together updated pricing that I think you'll find very competitive. Can we review it together?\",\n      },\n      focusCategories: [\"Controls & Thermostats\"],\n    },\n    {\n      tenantId: TENANT_ID, accountId: accs[1].id, status: \"active\",\n      playbookJson: {\n        playbook_type: \"gap_closure\",\n        priority_action: \"Follow up on PVF volume discount proposal sent to Dave Morrison.\",\n        urgency_level: \"this_week\",\n        email_subject: \"Following Up on PVF Proposal â€” Allied Mechanical\",\n        email_draft: \"Hi Dave,\\n\\nJust following up on the PVF volume discount proposal I sent last week. We identified a $17.8K opportunity where we can help you consolidate your PVF purchasing.\\n\\nHave you had a chance to review? Happy to answer any questions.\\n\\nBest,\\nYour ABC Supply Rep\",\n        talking_points: [\n          \"$17.8K PVF gap â€” second largest opportunity in enrolled accounts\",\n          \"Dave showed interest in copper fittings â€” good engagement signal\",\n          \"Allied already growing in HVAC Equipment (+8% QoQ) â€” build on momentum\",\n        ],\n        call_script: \"Hi Dave, this is [Rep Name] from ABC Supply. I wanted to follow up on the PVF proposal I sent. I know you mentioned interest in copper fittings â€” our PVF program includes competitive pricing on all copper products. Do you have a few minutes?\",\n      },\n      focusCategories: [\"PVF\"],\n    },\n  ]);\n  console.log(\"âœ“ Agent playbooks seeded\");\n\n  // Competitors\n  const [fergusonComp] = await db.insert(agentCompetitors).values([\n    { tenantId: TENANT_ID, name: \"Ferguson Enterprises\", categoriesCompetingIn: [\"Controls & Thermostats\", \"PVF\", \"Water Heaters\"], winRateAgainst: \"42\", notes: \"Primary competitor in Southeast region\" },\n    { tenantId: TENANT_ID, name: \"Winsupply\", categoriesCompetingIn: [\"PVF\", \"HVAC Equipment\"], winRateAgainst: \"58\", notes: \"Strong in PVF but weaker in HVAC\" },\n  ]).returning();\n\n  await db.insert(agentAccountCompetitors).values([\n    { tenantId: TENANT_ID, accountId: accs[8].id, competitorId: fergusonComp.id, categoriesLost: [\"Controls & Thermostats\"], detectedVia: \"email_mention\", confidence: \"confirmed\" },\n  ]);\n  console.log(\"âœ“ Agent competitors seeded\");\n\n  // Playbook learnings\n  await db.insert(agentPlaybookLearnings).values([\n    { tenantId: TENANT_ID, tradeType: \"HVAC\", playbookType: \"gap_closure\", learning: \"PVF gap closure works best when paired with volume discount proposal + same-day delivery guarantee\", evidenceCount: 8, successRate: \"72\", isActive: true },\n    { tenantId: TENANT_ID, tradeType: \"Plumbing\", playbookType: \"competitive_defense\", learning: \"When Ferguson is quoting, respond within 24 hours with match + loyalty discount. Win rate jumps from 42% to 67%\", evidenceCount: 5, successRate: \"67\", isActive: true },\n    { tenantId: TENANT_ID, tradeType: \"HVAC\", playbookType: \"gap_closure\", learning: \"Accounts with score >80 convert to enrollment 3x faster when approached with category-specific pricing sheets\", evidenceCount: 12, successRate: \"78\", isActive: true },\n  ]);\n  console.log(\"âœ“ Agent playbook learnings seeded\");\n\n  // â”€â”€ Agent Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.delete(agentProjects).where(sql`tenant_id = ${TENANT_ID}`);\n\n  const midwestId = accs[12].id;\n  const palmettoId = accs[8].id;\n  const alliedId = accs[1].id;\n\n  await db.insert(agentProjects).values([\n    { tenantId: TENANT_ID, accountId: midwestId, name: \"Eastside Mixed-Use Development\", projectType: \"new_construction\", status: \"bidding\", estimatedValue: \"340000\", inferredFrom: \"permit_data\" },\n    { tenantId: TENANT_ID, accountId: midwestId, name: \"Downtown Office HVAC Retrofit\", projectType: \"renovation\", status: \"active\", estimatedValue: \"125000\", inferredFrom: \"order_pattern\" },\n    { tenantId: TENANT_ID, accountId: palmettoId, name: \"Palmetto Gardens Condo Complex\", projectType: \"new_construction\", status: \"active\", estimatedValue: \"210000\", inferredFrom: \"rep_note\" },\n    { tenantId: TENANT_ID, accountId: palmettoId, name: \"County Hospital Wing Expansion\", projectType: \"renovation\", status: \"bidding\", estimatedValue: \"175000\", inferredFrom: \"permit_data\" },\n    { tenantId: TENANT_ID, accountId: alliedId, name: \"Metro Transit Authority â€” Station Upgrades\", projectType: \"renovation\", status: \"active\", estimatedValue: \"420000\", inferredFrom: \"order_pattern\" },\n    { tenantId: TENANT_ID, accountId: alliedId, name: \"Riverwalk Commercial Strip\", projectType: \"new_construction\", status: \"complete\", estimatedValue: \"95000\", inferredFrom: \"rep_note\" },\n  ]);\n  console.log(\"âœ“ Agent projects seeded\");\n\n  // â”€â”€ Agent State (Daily Briefing demo data) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  await db.delete(agentState).where(sql`tenant_id = ${TENANT_ID}`);\n\n  const agentRunTypes = [\n    {\n      agentRunType: \"daily-briefing\",\n      currentFocus: \"Monitoring 11 enrolled accounts. 2 at-risk signals detected.\",\n      lastRunSummary: `Scanned 20 accounts across 3 segments. Found 9 unenrolled accounts with opportunity scores above 80. Detected 2 at-risk signals: Coastal Mechanical (no growth in 90 days) and Palmetto Heating & Air (competitor mention in email). Top priority: Midwest Pipe & Supply â€” $53K opportunity with zero PVF spend.`,\n      pendingActions: JSON.stringify([\n        { account_name: accs[12].name, account_id: accs[12].id, action: `Call Mike Thornton â€” ${accs[12].name} has $27.5K in PVF leakage and $25.9K in Water Heaters. No outreach in 45 days.`, urgency: \"immediate\", why: \"Score 84, $53K total opportunity. Highest-value unenrolled account.\" },\n        { account_name: accs[8].name, account_id: accs[8].id, action: \"URGENT: Ferguson competitor quote detected in email. Call James Rivera to counter within 24 hours.\", urgency: \"immediate\", why: \"At-risk enrolled account. Competitor actively quoting $10.7K Controls gap.\" },\n        { account_name: accs[1].name, account_id: accs[1].id, action: `Follow up on PVF pricing sheet sent to ${accs[1].name}. $17.8K PVF gap still open.`, urgency: \"this_week\", why: \"Enrolled account with active email task in progress.\" },\n      ]),\n      openQuestions: JSON.stringify([\n        { account_name: accs[8].name, account_id: accs[8].id, signal: \"Ferguson competitor quote mentioned in recent email thread. Controls & Thermostats category at risk.\" },\n        { account_name: accs[4].name, account_id: accs[4].id, signal: \"90 days enrolled with minimal revenue growth. Last order was 47 days ago. Possible churn risk.\" },\n      ]),\n    },\n    { agentRunType: \"weekly-account-review\", currentFocus: \"Last review analyzed 20 accounts across 3 segments.\", lastRunSummary: null, pendingActions: null, openQuestions: null },\n    { agentRunType: \"email-intelligence\", currentFocus: \"Processed 47 email interactions this week.\", lastRunSummary: null, pendingActions: null, openQuestions: null },\n    { agentRunType: \"generate-playbook\", currentFocus: \"Generated 5 playbooks. Focus on PVF and Controls gaps.\", lastRunSummary: null, pendingActions: null, openQuestions: null },\n    { agentRunType: \"synthesize-learnings\", currentFocus: \"Active learnings: 5 patterns, avg success rate 71%.\", lastRunSummary: null, pendingActions: null, openQuestions: null },\n  ];\n\n  for (const rt of agentRunTypes) {\n    await db.insert(agentState).values({\n      tenantId: TENANT_ID,\n      agentRunType: rt.agentRunType,\n      currentFocus: rt.currentFocus,\n      lastRunAt: rt.lastRunSummary ? new Date(now.getTime() - 5 * 60 * 60 * 1000) : null,\n      lastRunSummary: rt.lastRunSummary,\n      pendingActions: rt.pendingActions,\n      openQuestions: rt.openQuestions,\n      patternNotes: \"\",\n    });\n  }\n  console.log(`âœ“ ${agentRunTypes.length} agent state rows`);\n\n  // â”€â”€ CRM Intelligence: Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const crmNow = new Date();\n  const daysAgo = (d: number) => new Date(crmNow.getTime() - d * 86400000);\n  const daysFromNow = (d: number) => new Date(crmNow.getTime() + d * 86400000);\n\n  const acctId = (index: number) => accs[index].id;\n\n  const contactRows = await db.insert(contacts).values([\n    // Metro HVAC Solutions [0]\n    { tenantId: TENANT_ID, accountId: acctId(0), firstName: \"Frank\", lastName: \"Moretti\", email: \"fmoretti@metrohvac.com\", phone: \"201-555-0142\", title: \"VP of Purchasing\", role: \"decision_maker\", department: \"Procurement\", isPrimary: true, lastContactedAt: daysAgo(2), notes: \"Key relationship â€” approves all orders over $25K. Prefers email communication. Mentioned expansion plans for Q3.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(0), firstName: \"Lisa\", lastName: \"Park\", email: \"lpark@metrohvac.com\", phone: \"201-555-0188\", title: \"Purchasing Manager\", role: \"purchaser\", department: \"Procurement\", isPrimary: false, lastContactedAt: daysAgo(5), notes: \"Handles day-to-day orders. Very responsive. Prefers phone calls.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(0), firstName: \"Dennis\", lastName: \"Kowalski\", email: \"dkowalski@metrohvac.com\", title: \"Estimator\", role: \"estimator\", department: \"Operations\", isPrimary: false, lastContactedAt: daysAgo(14), source: \"email_sync\" },\n\n    // Allied Mechanical Group [1]\n    { tenantId: TENANT_ID, accountId: acctId(1), firstName: \"Robert\", lastName: \"Chang\", email: \"rchang@alliedmech.com\", phone: \"215-555-0233\", title: \"Owner / President\", role: \"owner\", department: \"Executive\", isPrimary: true, lastContactedAt: daysAgo(45), notes: \"Founded the company in 2008. Very loyal but exploring competitors on PVF pricing. Need to re-engage.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(1), firstName: \"Angela\", lastName: \"Russo\", email: \"arusso@alliedmech.com\", phone: \"215-555-0241\", title: \"Office Manager\", role: \"gatekeeper\", department: \"Admin\", isPrimary: false, lastContactedAt: daysAgo(12), source: \"email_sync\" },\n\n    // Northeast Heating & Cooling [2]\n    { tenantId: TENANT_ID, accountId: acctId(2), firstName: \"Tom\", lastName: \"Brennan\", email: \"tbrennan@northeasthvac.com\", phone: \"617-555-0311\", title: \"General Manager\", role: \"decision_maker\", department: \"Management\", isPrimary: true, lastContactedAt: daysAgo(1), notes: \"Very active account. Just awarded major school district project. Wants competitive pricing on Carrier equipment.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(2), firstName: \"Sarah\", lastName: \"Whitfield\", email: \"swhitfield@northeasthvac.com\", title: \"Project Coordinator\", role: \"project_manager\", department: \"Operations\", isPrimary: false, lastContactedAt: daysAgo(3), source: \"email_sync\" },\n\n    // Premier Plumbing NJ [3]\n    { tenantId: TENANT_ID, accountId: acctId(3), firstName: \"Mike\", lastName: \"DeSantis\", email: \"mdesantis@premierplumbingnj.com\", phone: \"609-555-0422\", title: \"Owner\", role: \"owner\", department: \"Executive\", isPrimary: true, lastContactedAt: daysAgo(8), notes: \"Family business, 3rd generation. Price-sensitive but values reliability. Currently comparing our water heater pricing with Ferguson.\", source: \"email_sync\" },\n\n    // Sunshine HVAC Florida [5]\n    { tenantId: TENANT_ID, accountId: acctId(5), firstName: \"Carlos\", lastName: \"Mendez\", email: \"cmendez@sunshinehvac.com\", phone: \"813-555-0501\", title: \"CEO\", role: \"decision_maker\", department: \"Executive\", isPrimary: true, lastContactedAt: daysAgo(3), notes: \"Aggressive growth â€” opening 2 new service areas. Major opportunity for equipment + supplies bundle.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(5), firstName: \"Diane\", lastName: \"Torres\", email: \"dtorres@sunshinehvac.com\", phone: \"813-555-0509\", title: \"Purchasing Director\", role: \"purchaser\", department: \"Procurement\", isPrimary: false, lastContactedAt: daysAgo(1), notes: \"Very organized, sends weekly POs. Currently evaluating our pricing vs. Winsupply on refrigerant.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(5), firstName: \"Ray\", lastName: \"Nguyen\", email: \"rnguyen@sunshinehvac.com\", title: \"Lead Estimator\", role: \"estimator\", department: \"Operations\", isPrimary: false, lastContactedAt: daysAgo(7), source: \"email_sync\" },\n\n    // Gulf Coast Plumbing [6]\n    { tenantId: TENANT_ID, accountId: acctId(6), firstName: \"Jim\", lastName: \"Crawford\", email: \"jcrawford@gulfcoastplumbing.com\", phone: \"504-555-0612\", title: \"Operations Manager\", role: \"decision_maker\", department: \"Operations\", isPrimary: true, lastContactedAt: daysAgo(20), notes: \"Handles both purchasing and operations. Frustrated with recent delivery delays â€” need to address.\", source: \"email_sync\" },\n\n    // Tampa Bay Mechanical [7]\n    { tenantId: TENANT_ID, accountId: acctId(7), firstName: \"Patricia\", lastName: \"Vega\", email: \"pvega@tampabaymech.com\", phone: \"727-555-0744\", title: \"Controller\", role: \"decision_maker\", department: \"Finance\", isPrimary: true, lastContactedAt: daysAgo(6), notes: \"Controls budget. Very data-driven â€” responds well to ROI arguments. Interested in volume discount tiers.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(7), firstName: \"Kevin\", lastName: \"O'Brien\", email: \"kobrien@tampabaymech.com\", title: \"Field Supervisor\", role: \"influencer\", department: \"Field\", isPrimary: false, lastContactedAt: daysAgo(30), source: \"email_sync\" },\n\n    // Great Lakes Heating [11]\n    { tenantId: TENANT_ID, accountId: acctId(11), firstName: \"David\", lastName: \"Kowalczyk\", email: \"dkowalczyk@greatlakesheating.com\", phone: \"312-555-0811\", title: \"President\", role: \"owner\", department: \"Executive\", isPrimary: true, lastContactedAt: daysAgo(4), notes: \"Largest HVAC account in Great Lakes. Considering switching from Lennox to Carrier for commercial line. Huge opportunity.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(11), firstName: \"Amy\", lastName: \"Richardson\", email: \"arichardson@greatlakesheating.com\", phone: \"312-555-0819\", title: \"Purchasing Coordinator\", role: \"purchaser\", department: \"Procurement\", isPrimary: false, lastContactedAt: daysAgo(2), source: \"email_sync\" },\n\n    // Midwest Pipe & Supply [12]\n    { tenantId: TENANT_ID, accountId: acctId(12), firstName: \"Greg\", lastName: \"Hoffmann\", email: \"ghoffmann@midwestpipe.com\", phone: \"314-555-0901\", title: \"VP of Operations\", role: \"decision_maker\", department: \"Operations\", isPrimary: true, lastContactedAt: daysAgo(11), notes: \"Concerned about PVF lead times. Comparing us to HD Supply. Need to demonstrate reliability advantage.\", source: \"email_sync\" },\n\n    // Chicago Comfort Systems [14]\n    { tenantId: TENANT_ID, accountId: acctId(14), firstName: \"Sandra\", lastName: \"Chen\", email: \"schen@chicagocomfort.com\", phone: \"773-555-1001\", title: \"General Manager\", role: \"decision_maker\", department: \"Management\", isPrimary: true, lastContactedAt: daysAgo(15), notes: \"Managing 3 large commercial retrofit projects. Needs competitive pricing on controls & thermostats package.\", source: \"email_sync\" },\n\n    // Carolina Climate Control [10]\n    { tenantId: TENANT_ID, accountId: acctId(10), firstName: \"William\", lastName: \"Hayes\", email: \"whayes@carolinaclimate.com\", phone: \"704-555-1102\", title: \"Procurement Manager\", role: \"purchaser\", department: \"Procurement\", isPrimary: true, lastContactedAt: daysAgo(60), notes: \"Haven't spoken in 2 months. Account showing declining order frequency. At risk of losing to local competitor.\", source: \"email_sync\" },\n\n    // Palmetto Heating & Air [8]\n    { tenantId: TENANT_ID, accountId: acctId(8), firstName: \"Nicole\", lastName: \"Washington\", email: \"nwashington@palmettoheat.com\", phone: \"843-555-1211\", title: \"Owner\", role: \"owner\", department: \"Executive\", isPrimary: true, lastContactedAt: daysAgo(9), notes: \"Growing fast â€” just hired 5 new techs. Needs to expand their product range. Perfect candidate for insulation + ductwork cross-sell.\", source: \"email_sync\" },\n\n    // Detroit Climate Pro [16]\n    { tenantId: TENANT_ID, accountId: acctId(16), firstName: \"Marcus\", lastName: \"Johnson\", email: \"mjohnson@detroitclimate.com\", phone: \"313-555-1301\", title: \"Chief Estimator\", role: \"estimator\", department: \"Estimating\", isPrimary: true, lastContactedAt: daysAgo(7), notes: \"Key influence on equipment selection. Prefers Trane but open to Carrier if pricing is right.\", source: \"email_sync\" },\n\n    // Buckeye Mechanical [18]\n    { tenantId: TENANT_ID, accountId: acctId(18), firstName: \"Jennifer\", lastName: \"Adams\", email: \"jadams@buckeyemech.com\", phone: \"614-555-1411\", title: \"Director of Purchasing\", role: \"decision_maker\", department: \"Procurement\", isPrimary: true, lastContactedAt: daysAgo(3), notes: \"Just consolidated 3 branch locations. Wants single-source supply agreement. High-value opportunity.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(18), firstName: \"Brian\", lastName: \"Mueller\", email: \"bmueller@buckeyemech.com\", title: \"Project Manager\", role: \"project_manager\", department: \"Projects\", isPrimary: false, lastContactedAt: daysAgo(18), source: \"email_sync\" },\n\n    // Coastal Mechanical [4]\n    { tenantId: TENANT_ID, accountId: acctId(4), firstName: \"Tony\", lastName: \"Mancini\", email: \"tmancini@coastalmech.com\", phone: \"203-555-1522\", title: \"Purchasing Agent\", role: \"purchaser\", department: \"Procurement\", isPrimary: true, lastContactedAt: daysAgo(10), notes: \"Reliable account. Looking for better terms on drainage systems. Mentioned competitor quote from Ferguson.\", source: \"email_sync\" },\n\n    // Indiana Plumbing Services [19]\n    { tenantId: TENANT_ID, accountId: acctId(19), firstName: \"Steve\", lastName: \"Patel\", email: \"spatel@indianaplumbing.com\", phone: \"317-555-1601\", title: \"Operations Director\", role: \"decision_maker\", department: \"Operations\", isPrimary: true, lastContactedAt: daysAgo(22), notes: \"Expanding into commercial plumbing. Needs fixtures and PVF at volume pricing. Currently buying some categories from HD Supply.\", source: \"email_sync\" },\n  ]).returning();\n  console.log(`âœ“ ${contactRows.length} CRM contacts`);\n\n  // â”€â”€ CRM Intelligence: Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const projectRows = await db.insert(projects).values([\n    // Metro HVAC â€” awarded large hospital project\n    { tenantId: TENANT_ID, accountId: acctId(0), name: \"St. Mary's Hospital HVAC Renovation\", location: \"Newark, NJ\", projectType: \"renovation\", estimatedValue: \"485000\", stage: \"awarded\", startDate: daysFromNow(30), bidDeadline: daysAgo(15), generalContractor: \"Turner Construction\", unitCount: null, squareFootage: 125000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Controls & Thermostats\", \"Ductwork & Fittings\", \"Insulation Materials\"]), competitorsInvolved: JSON.stringify([\"Ferguson\", \"Winsupply\"]), notes: \"Won against Ferguson. Key differentiator was our Carrier pricing and delivery commitment. 4-phase installation over 18 months.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(0), name: \"Liberty Park Office Complex\", location: \"Jersey City, NJ\", projectType: \"new_construction\", estimatedValue: \"320000\", stage: \"bidding\", bidDeadline: daysFromNow(12), generalContractor: \"Skanska\", squareFootage: 85000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Ductwork & Fittings\", \"Controls & Thermostats\"]), competitorsInvolved: JSON.stringify([\"HD Supply\", \"Johnstone Supply\"]), notes: \"Competitive bid â€” need to be aggressive on controls pricing. GC has existing relationship with HD Supply.\", source: \"email_sync\" },\n\n    // Northeast Heating â€” school district\n    { tenantId: TENANT_ID, accountId: acctId(2), name: \"Westfield School District HVAC Upgrade\", location: \"Westfield, MA\", projectType: \"retrofit\", estimatedValue: \"275000\", stage: \"awarded\", startDate: daysFromNow(45), generalContractor: \"Gilbane Building Co\", squareFootage: 95000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Controls & Thermostats\", \"Insulation Materials\"]), competitorsInvolved: JSON.stringify([\"Ferguson\"]), notes: \"District-wide upgrade across 4 schools. Phased delivery required. Energy efficiency specs favor our Carrier VRF line.\", source: \"email_sync\" },\n\n    // Sunshine HVAC â€” multiple Florida projects\n    { tenantId: TENANT_ID, accountId: acctId(5), name: \"Bayshore Condos Phase II\", location: \"Tampa, FL\", projectType: \"new_construction\", estimatedValue: \"520000\", stage: \"in_progress\", startDate: daysAgo(60), endDate: daysFromNow(120), generalContractor: \"Suffolk Construction\", unitCount: 180, squareFootage: 220000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Refrigerant & Supplies\", \"Ductwork & Fittings\", \"Controls & Thermostats\", \"Insulation Materials\"]), competitorsInvolved: JSON.stringify([\"Winsupply\", \"Baker Distributing\"]), notes: \"Largest active project. Phase I delivered on time. Currently supplying 60% of materials â€” opportunity to capture remaining 40% from Winsupply.\", source: \"email_sync\" },\n    { tenantId: TENANT_ID, accountId: acctId(5), name: \"Riverwalk Medical Office\", location: \"St. Petersburg, FL\", projectType: \"new_construction\", estimatedValue: \"185000\", stage: \"bidding\", bidDeadline: daysFromNow(8), generalContractor: \"Brasfield & Gorrie\", squareFootage: 42000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Controls & Thermostats\", \"Plumbing Fixtures\"]), competitorsInvolved: JSON.stringify([\"Ferguson\", \"Baker Distributing\"]), notes: \"Medical-grade HVAC requirements. Our Carrier Puron units meet spec. Bid deadline approaching â€” need pricing finalized this week.\", source: \"email_sync\" },\n\n    // Great Lakes Heating â€” commercial retrofit\n    { tenantId: TENANT_ID, accountId: acctId(11), name: \"Lakeview Plaza Commercial Retrofit\", location: \"Chicago, IL\", projectType: \"retrofit\", estimatedValue: \"410000\", stage: \"bidding\", bidDeadline: daysFromNow(18), generalContractor: \"Pepper Construction\", squareFootage: 110000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Controls & Thermostats\", \"Ductwork & Fittings\", \"Electrical Components\"]), competitorsInvolved: JSON.stringify([\"HD Supply\", \"Johnstone Supply\"]), notes: \"Customer considering Lennox-to-Carrier switch. If we win this, it could shift their entire commercial line to us. High strategic value.\", source: \"email_sync\" },\n\n    // Gulf Coast Plumbing â€” hotel renovation\n    { tenantId: TENANT_ID, accountId: acctId(6), name: \"Grand Pelican Resort Plumbing Overhaul\", location: \"Biloxi, MS\", projectType: \"renovation\", estimatedValue: \"290000\", stage: \"awarded\", startDate: daysFromNow(15), generalContractor: \"Yates Construction\", unitCount: 320, productCategories: JSON.stringify([\"Plumbing Fixtures\", \"PVF (Pipe, Valves, Fittings)\", \"Water Heaters\", \"Drainage Systems\"]), competitorsInvolved: JSON.stringify([\"Ferguson\"]), notes: \"320-room hotel renovation. Won on plumbing fixtures pricing. Need to finalize water heater selection â€” customer comparing Rheem vs A.O. Smith.\", source: \"email_sync\" },\n\n    // Midwest Pipe & Supply â€” warehouse complex\n    { tenantId: TENANT_ID, accountId: acctId(12), name: \"Gateway Logistics Center\", location: \"St. Louis, MO\", projectType: \"new_construction\", estimatedValue: \"195000\", stage: \"identified\", generalContractor: \"Alberici Constructors\", squareFootage: 250000, productCategories: JSON.stringify([\"PVF (Pipe, Valves, Fittings)\", \"Drainage Systems\", \"Pipe & Fittings\"]), notes: \"Early stage â€” customer mentioned this project in recent email. Large warehouse needing fire suppression and drainage. Need to get on bid list.\", source: \"email_sync\" },\n\n    // Chicago Comfort â€” multi-building retrofit\n    { tenantId: TENANT_ID, accountId: acctId(14), name: \"Michigan Ave Office Park Controls Upgrade\", location: \"Chicago, IL\", projectType: \"retrofit\", estimatedValue: \"155000\", stage: \"in_progress\", startDate: daysAgo(30), endDate: daysFromNow(90), productCategories: JSON.stringify([\"Controls & Thermostats\", \"Electrical Components\"]), notes: \"Smart building conversion. Installing Honeywell BMS across 3 buildings. Steady weekly orders for controls & sensors.\", source: \"email_sync\" },\n\n    // Tampa Bay Mechanical â€” tenant improvement\n    { tenantId: TENANT_ID, accountId: acctId(7), name: \"Crossroads Shopping Center TI\", location: \"Tampa, FL\", projectType: \"tenant_improvement\", estimatedValue: \"92000\", stage: \"in_progress\", startDate: daysAgo(14), endDate: daysFromNow(45), generalContractor: \"Hensel Phelps\", squareFootage: 35000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Ductwork & Fittings\", \"Plumbing Fixtures\"]), notes: \"Tenant improvement for 4 new retail spaces. Quick turnaround needed. Good margin opportunity on ductwork.\", source: \"email_sync\" },\n\n    // Buckeye Mechanical â€” consolidated supply opportunity\n    { tenantId: TENANT_ID, accountId: acctId(18), name: \"Columbus Data Center Build-Out\", location: \"Columbus, OH\", projectType: \"new_construction\", estimatedValue: \"680000\", stage: \"bidding\", bidDeadline: daysFromNow(25), generalContractor: \"Whiting-Turner\", squareFootage: 75000, productCategories: JSON.stringify([\"HVAC Equipment\", \"Controls & Thermostats\", \"Electrical Components\", \"Insulation Materials\", \"PVF (Pipe, Valves, Fittings)\"]), competitorsInvolved: JSON.stringify([\"HD Supply\", \"Ferguson\", \"Winsupply\"]), notes: \"Massive opportunity â€” precision cooling requirements. Customer wants single-source supplier. Our breadth of categories is key differentiator.\", source: \"email_sync\" },\n\n    // Palmetto Heating â€” maintenance contract\n    { tenantId: TENANT_ID, accountId: acctId(8), name: \"Palmetto Regional Hospital HVAC Maintenance\", location: \"Charleston, SC\", projectType: \"maintenance\", estimatedValue: \"78000\", stage: \"awarded\", startDate: daysAgo(90), endDate: daysFromNow(275), productCategories: JSON.stringify([\"Refrigerant & Supplies\", \"Controls & Thermostats\", \"Tools & Safety\"]), notes: \"Annual maintenance contract. Steady recurring revenue. Cross-sell opportunity for insulation and ductwork when replacements needed.\", source: \"email_sync\" },\n\n    // Allied Mechanical â€” competitive situation\n    { tenantId: TENANT_ID, accountId: acctId(1), name: \"Philadelphia Airport Terminal B Renovation\", location: \"Philadelphia, PA\", projectType: \"renovation\", estimatedValue: \"750000\", stage: \"bidding\", bidDeadline: daysFromNow(35), generalContractor: \"Clark Construction\", squareFootage: 200000, productCategories: JSON.stringify([\"HVAC Equipment\", \"PVF (Pipe, Valves, Fittings)\", \"Controls & Thermostats\", \"Insulation Materials\", \"Electrical Components\"]), competitorsInvolved: JSON.stringify([\"Ferguson\", \"HD Supply\", \"Winsupply\"]), notes: \"Largest bid opportunity this quarter. Airport authority requires prevailing wage. Customer relationship strained â€” need to rebuild trust. Owner Robert Chang is key.\", source: \"email_sync\" },\n\n    // Indiana Plumbing â€” commercial expansion\n    { tenantId: TENANT_ID, accountId: acctId(19), name: \"Carmel Town Center Mixed-Use\", location: \"Carmel, IN\", projectType: \"new_construction\", estimatedValue: \"230000\", stage: \"identified\", generalContractor: \"Shiel Sexton\", unitCount: 96, squareFootage: 145000, productCategories: JSON.stringify([\"Plumbing Fixtures\", \"PVF (Pipe, Valves, Fittings)\", \"Water Heaters\", \"Drainage Systems\"]), notes: \"Customer's first major commercial project. Needs support on spec and pricing. Opportunity to become their go-to commercial supplier.\", source: \"email_sync\" },\n\n    // Lake Shore Plumbing â€” renovation\n    { tenantId: TENANT_ID, accountId: acctId(15), name: \"Navy Pier Restaurant Row Plumbing\", location: \"Chicago, IL\", projectType: \"renovation\", estimatedValue: \"145000\", stage: \"awarded\", startDate: daysFromNow(10), generalContractor: \"Power Construction\", productCategories: JSON.stringify([\"Plumbing Fixtures\", \"Pipe & Fittings\", \"Drainage Systems\", \"Water Heaters\"]), competitorsInvolved: JSON.stringify([\"Ferguson\"]), notes: \"Won competitive bid. 6 restaurant buildouts requiring commercial-grade plumbing. Tight timeline â€” delivery reliability critical.\", source: \"email_sync\" },\n  ]).returning();\n  console.log(`âœ“ ${projectRows.length} CRM projects`);\n\n  // â”€â”€ CRM Intelligence: Order Signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const signalRows = await db.insert(orderSignals).values([\n    // Immediate urgency signals\n    { tenantId: TENANT_ID, accountId: acctId(0), projectId: projectRows[0].id, signalType: \"quote_request\", productCategory: \"HVAC Equipment\", productDetails: \"Carrier 50XC rooftop units, 15-ton, qty 8 for hospital renovation\", estimatedQuantity: \"8 units\", estimatedValue: \"124000\", urgency: \"immediate\", pricingMentioned: true, competitorPriceMentioned: true, notes: \"Ferguson quoted $14,800/unit. We need to beat or match. Delivery needed within 6 weeks.\", status: \"quoted\" },\n    { tenantId: TENANT_ID, accountId: acctId(5), projectId: projectRows[3].id, signalType: \"delivery_request\", productCategory: \"Refrigerant & Supplies\", productDetails: \"R-410A refrigerant, 50 cylinders for Bayshore Phase II\", estimatedQuantity: \"50 cylinders\", estimatedValue: \"18500\", urgency: \"immediate\", notes: \"Running low on-site. Need delivery by Friday or project delays. Diane Torres handling.\", status: \"new\" },\n    { tenantId: TENANT_ID, accountId: acctId(2), signalType: \"purchase_intent\", productCategory: \"Controls & Thermostats\", productDetails: \"Honeywell T6 Pro thermostats and zone controllers for school district\", estimatedQuantity: \"120 units\", estimatedValue: \"32000\", urgency: \"immediate\", pricingMentioned: true, notes: \"Tom Brennan wants pricing today. Schools need installation during spring break window.\", status: \"new\" },\n\n    // This week urgency\n    { tenantId: TENANT_ID, accountId: acctId(11), projectId: projectRows[5].id, signalType: \"quote_request\", productCategory: \"HVAC Equipment\", productDetails: \"Carrier WeatherExpert rooftop units, mixed tonnage (5-20 ton)\", estimatedQuantity: \"12 units\", estimatedValue: \"186000\", urgency: \"this_week\", pricingMentioned: true, competitorPriceMentioned: true, notes: \"David Kowalczyk comparing Lennox vs Carrier pricing. If we win this quote, likely converts entire commercial line. Strategic importance.\", status: \"new\" },\n    { tenantId: TENANT_ID, accountId: acctId(6), projectId: projectRows[6].id, signalType: \"quote_request\", productCategory: \"Water Heaters\", productDetails: \"Commercial tankless water heaters â€” Navien NPE-2 or equivalent, qty 24\", estimatedQuantity: \"24 units\", estimatedValue: \"67000\", urgency: \"this_week\", pricingMentioned: true, notes: \"Grand Pelican Resort needs water heater selection finalized. Customer comparing Rheem vs Navien. Our Navien pricing is competitive.\", status: \"contacted\" },\n    { tenantId: TENANT_ID, accountId: acctId(18), projectId: projectRows[10].id, signalType: \"pricing_inquiry\", productCategory: \"Controls & Thermostats\", productDetails: \"Building automation controllers, sensors, and actuators for data center\", estimatedQuantity: \"Bulk lot\", estimatedValue: \"95000\", urgency: \"this_week\", pricingMentioned: true, competitorPriceMentioned: true, notes: \"Jennifer Adams wants consolidated pricing. HD Supply quoted controls separately â€” we can beat them on a package deal.\", status: \"new\" },\n\n    // This month\n    { tenantId: TENANT_ID, accountId: acctId(5), projectId: projectRows[4].id, signalType: \"quote_request\", productCategory: \"HVAC Equipment\", productDetails: \"Carrier Puron 50HC units for medical office, with HEPA filtration\", estimatedQuantity: \"6 units\", estimatedValue: \"78000\", urgency: \"this_month\", pricingMentioned: true, notes: \"Medical-grade specs. Bid deadline in 8 days. Need to finalize pricing with manufacturer rep.\", status: \"new\" },\n    { tenantId: TENANT_ID, accountId: acctId(14), signalType: \"reorder\", productCategory: \"Controls & Thermostats\", productDetails: \"Honeywell smart sensors and zone controllers â€” weekly standing order\", estimatedQuantity: \"25 units/week\", estimatedValue: \"8500\", urgency: \"this_month\", notes: \"Steady recurring orders for Michigan Ave retrofit. Customer very satisfied with quality. Upsell opportunity for wireless sensors.\", status: \"won\" },\n    { tenantId: TENANT_ID, accountId: acctId(8), signalType: \"product_inquiry\", productCategory: \"Insulation Materials\", productDetails: \"Owens Corning commercial duct wrap and pipe insulation\", estimatedQuantity: \"2,000 linear feet\", estimatedValue: \"12000\", urgency: \"this_month\", notes: \"Nicole Washington expanding into insulation installation. First-time buyer in this category â€” cross-sell success!\", status: \"new\" },\n    { tenantId: TENANT_ID, accountId: acctId(12), signalType: \"pricing_inquiry\", productCategory: \"PVF (Pipe, Valves, Fittings)\", productDetails: \"Copper pipe (types L & M), brass valves, various fittings\", estimatedValue: \"45000\", urgency: \"this_month\", pricingMentioned: true, competitorPriceMentioned: true, notes: \"Greg Hoffmann comparing us to HD Supply on PVF pricing. Need to demonstrate lead time advantage â€” we're 2 weeks faster.\", status: \"contacted\" },\n\n    // Next quarter\n    { tenantId: TENANT_ID, accountId: acctId(1), projectId: projectRows[12].id, signalType: \"quote_request\", productCategory: \"HVAC Equipment\", productDetails: \"Large-scale HVAC package for airport terminal renovation\", estimatedQuantity: \"Full package\", estimatedValue: \"385000\", urgency: \"next_quarter\", pricingMentioned: true, notes: \"Preliminary pricing request for airport project. Bid not due for 5 weeks. Need to rebuild relationship with Robert Chang first.\", status: \"new\" },\n    { tenantId: TENANT_ID, accountId: acctId(18), projectId: projectRows[10].id, signalType: \"purchase_intent\", productCategory: \"Insulation Materials\", productDetails: \"Spray foam and rigid board insulation for data center walls\", estimatedQuantity: \"Full facility\", estimatedValue: \"42000\", urgency: \"next_quarter\", notes: \"Data center requires R-30+ insulation throughout. Spec review in progress.\", status: \"new\" },\n\n    // Exploring\n    { tenantId: TENANT_ID, accountId: acctId(19), signalType: \"product_inquiry\", productCategory: \"Plumbing Fixtures\", productDetails: \"Commercial-grade fixtures â€” Kohler Triton Bowe and similar\", estimatedQuantity: \"96 units (residential), 12 commercial\", estimatedValue: \"58000\", urgency: \"exploring\", notes: \"Steve Patel exploring commercial fixture lines for first time. Needs education on specs and pricing tiers. Great relationship-building opportunity.\", status: \"new\" },\n    { tenantId: TENANT_ID, accountId: acctId(3), signalType: \"pricing_inquiry\", productCategory: \"Water Heaters\", productDetails: \"A.O. Smith commercial water heaters â€” comparing to Ferguson pricing\", estimatedValue: \"22000\", urgency: \"this_week\", pricingMentioned: true, competitorPriceMentioned: true, notes: \"Mike DeSantis got a Ferguson quote at $1,850/unit. Our current price is $1,920. Need to match or justify the premium.\", status: \"contacted\" },\n\n    // Won signals showing success\n    { tenantId: TENANT_ID, accountId: acctId(0), signalType: \"reorder\", productCategory: \"Ductwork & Fittings\", productDetails: \"Spiral ductwork and flex connectors â€” monthly standing order\", estimatedValue: \"15000\", urgency: \"this_month\", notes: \"Consistent monthly reorder. Relationship strong. Recently increased order size by 20%.\", status: \"won\" },\n    { tenantId: TENANT_ID, accountId: acctId(7), signalType: \"purchase_intent\", productCategory: \"HVAC Equipment\", productDetails: \"Mini-split systems for retail tenant improvement\", estimatedQuantity: \"16 units\", estimatedValue: \"28000\", urgency: \"this_week\", notes: \"Patricia Vega approved budget. Quick win â€” need to get PO processed this week.\", status: \"won\" },\n    { tenantId: TENANT_ID, accountId: acctId(15), projectId: projectRows[14].id, signalType: \"quote_request\", productCategory: \"Plumbing Fixtures\", productDetails: \"Commercial kitchen plumbing packages for 6 restaurant buildouts\", estimatedQuantity: \"6 packages\", estimatedValue: \"54000\", urgency: \"this_week\", pricingMentioned: true, notes: \"Navy Pier project â€” quote accepted. Delivery schedule confirmed. First shipment next week.\", status: \"won\" },\n\n    // Lost signal for learning\n    { tenantId: TENANT_ID, accountId: acctId(10), signalType: \"quote_request\", productCategory: \"HVAC Equipment\", productDetails: \"Residential heat pump systems â€” bulk order\", estimatedValue: \"35000\", urgency: \"this_month\", competitorPriceMentioned: true, notes: \"Lost to local competitor on price. William Hayes hasn't responded to follow-up. Account at risk.\", status: \"lost\" },\n  ]).returning();\n  console.log(`âœ“ ${signalRows.length} CRM order signals`);\n\n  // â”€â”€ CRM Intelligence: Competitor Mentions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const threatRows = await db.insert(competitorMentions).values([\n    // Critical threats\n    { tenantId: TENANT_ID, accountId: acctId(1), projectId: projectRows[12].id, competitorName: \"Ferguson\", mentionType: \"switch_threat\", productCategory: \"PVF (Pipe, Valves, Fittings)\", competitorPrice: \"$12.50/ft copper L\", ourPrice: \"$13.10/ft copper L\", details: \"Robert Chang mentioned Ferguson is offering a 15% volume discount on PVF for the airport project. Also offering free jobsite delivery. Owner has been shopping around â€” relationship cooling. Need immediate outreach with competitive counter-offer.\", threatLevel: \"critical\", responseNeeded: true, notes: \"Longest-standing account in Mid-Atlantic. Losing this would be a $200K+ annual revenue hit.\" },\n    { tenantId: TENANT_ID, accountId: acctId(10), competitorName: \"Local Competitor (Carolina Supply)\", mentionType: \"switch_threat\", productCategory: \"HVAC Equipment\", details: \"William Hayes stopped returning calls after we lost the heat pump bid. Carolina Supply offering same-day delivery from local warehouse. They're cherry-picking our best categories. Account has gone silent for 60 days.\", threatLevel: \"critical\", responseNeeded: true, notes: \"Account showing classic defection pattern: declining orders â†’ competitor mentions â†’ silence. Need win-back strategy.\" },\n\n    // High threats\n    { tenantId: TENANT_ID, accountId: acctId(11), projectId: projectRows[5].id, competitorName: \"HD Supply\", mentionType: \"pricing\", productCategory: \"Controls & Thermostats\", competitorPrice: \"$2,850 per BAS controller\", ourPrice: \"$3,100 per BAS controller\", details: \"David Kowalczyk received HD Supply quote for Lakeview Plaza controls package. Their per-unit pricing is 8% lower. However, they can't match our delivery timeline. Need to emphasize total cost of ownership and installation support.\", threatLevel: \"high\", responseNeeded: true },\n    { tenantId: TENANT_ID, accountId: acctId(12), competitorName: \"HD Supply\", mentionType: \"quote\", productCategory: \"PVF (Pipe, Valves, Fittings)\", competitorPrice: \"Bulk lot: $38,000\", ourPrice: \"Bulk lot: $42,500\", details: \"Greg Hoffmann shared HD Supply's PVF package pricing. They're 10% lower on the bulk lot. Greg values our lead times (2 weeks vs their 4-6 weeks) but price gap is significant. Consider volume discount or payment terms to close the gap.\", threatLevel: \"high\", responseNeeded: true },\n    { tenantId: TENANT_ID, accountId: acctId(3), competitorName: \"Ferguson\", mentionType: \"pricing\", productCategory: \"Water Heaters\", competitorPrice: \"$1,850/unit (A.O. Smith)\", ourPrice: \"$1,920/unit (A.O. Smith)\", details: \"Mike DeSantis got competitive pricing from Ferguson on commercial water heaters. 3.6% price gap. Ferguson also offering 90-day payment terms vs our 30-day. Need to either match price or offer extended terms.\", threatLevel: \"high\", responseNeeded: true, notes: \"Price-sensitive account. Small margin for negotiation.\" },\n\n    // Medium threats\n    { tenantId: TENANT_ID, accountId: acctId(5), projectId: projectRows[3].id, competitorName: \"Winsupply\", mentionType: \"product_comparison\", productCategory: \"Refrigerant & Supplies\", competitorPrice: \"$385/cylinder R-410A\", ourPrice: \"$410/cylinder R-410A\", details: \"Diane Torres comparing refrigerant pricing for Bayshore project. Winsupply is 6% cheaper per cylinder. However, they had a recent delivery failure that cost Sunshine HVAC a day of lost labor. Our reliability record is key selling point.\", threatLevel: \"medium\", responseNeeded: false, respondedAt: daysAgo(5), notes: \"Addressed in last call. Diane agreed reliability matters more but asked us to 'sharpen our pencils' on next quote.\" },\n    { tenantId: TENANT_ID, accountId: acctId(5), projectId: projectRows[4].id, competitorName: \"Baker Distributing\", mentionType: \"quote\", productCategory: \"HVAC Equipment\", competitorPrice: \"$11,200/unit (competing brand)\", ourPrice: \"$12,800/unit (Carrier Puron)\", details: \"Baker Distributing quoting Daikin units as Carrier alternative for medical office. Daikin units are 12% cheaper but don't have medical-grade HEPA option. Our spec advantage should hold.\", threatLevel: \"medium\", responseNeeded: false, respondedAt: daysAgo(2), notes: \"Spec review shows Carrier is the only option meeting medical-grade requirements. Baker's quote likely won't pass plan review.\" },\n    { tenantId: TENANT_ID, accountId: acctId(18), projectId: projectRows[10].id, competitorName: \"HD Supply\", mentionType: \"pricing\", productCategory: \"Electrical Components\", competitorPrice: \"Package: $28,000\", ourPrice: \"Package: $31,500\", details: \"Jennifer Adams received electrical components quote from HD Supply for data center project. Their pricing is competitive but they can't bundle with HVAC + controls. Our single-source advantage is key.\", threatLevel: \"medium\", responseNeeded: true },\n    { tenantId: TENANT_ID, accountId: acctId(4), competitorName: \"Ferguson\", mentionType: \"quote\", productCategory: \"Drainage Systems\", competitorPrice: \"$8,500 for drainage package\", ourPrice: \"$9,200 for drainage package\", details: \"Tony Mancini mentioned Ferguson quoted drainage systems package 8% lower. Longtime customer but price pressure increasing. Consider loyalty discount.\", threatLevel: \"medium\", responseNeeded: true },\n\n    // Low threats â€” informational\n    { tenantId: TENANT_ID, accountId: acctId(0), competitorName: \"Johnstone Supply\", mentionType: \"positive_mention\", productCategory: \"Tools & Safety\", details: \"Frank Moretti mentioned Johnstone Supply has a good selection of specialty HVAC tools. Not a threat to our core categories but worth monitoring if they expand into equipment.\", threatLevel: \"low\", responseNeeded: false, notes: \"Johnstone is a regional player. Unlikely to compete on our core lines.\" },\n    { tenantId: TENANT_ID, accountId: acctId(7), competitorName: \"Winsupply\", mentionType: \"negative_mention\", productCategory: \"Ductwork & Fittings\", details: \"Kevin O'Brien (field supervisor) complained about Winsupply's ductwork quality on a recent job. Said he prefers our product. Good competitive intel â€” Winsupply having quality issues.\", threatLevel: \"low\", responseNeeded: false, respondedAt: daysAgo(1), notes: \"Positive competitive intel. Our ductwork quality is a differentiator. Worth mentioning in next account review.\" },\n    { tenantId: TENANT_ID, accountId: acctId(14), competitorName: \"Johnstone Supply\", mentionType: \"pricing\", productCategory: \"Refrigerant & Supplies\", competitorPrice: \"$375/cylinder R-410A\", ourPrice: \"$410/cylinder R-410A\", details: \"Sandra Chen saw Johnstone pricing in a trade publication. Hasn't actively shopped around but asked if we can be more competitive. Informational inquiry, not an active threat.\", threatLevel: \"low\", responseNeeded: false },\n\n    // Competitor with pricing advantage we've already addressed\n    { tenantId: TENANT_ID, accountId: acctId(11), competitorName: \"Johnstone Supply\", mentionType: \"quote\", productCategory: \"Refrigerant & Supplies\", competitorPrice: \"$365/cylinder R-410A\", ourPrice: \"$395/cylinder R-410A\", details: \"Amy Richardson mentioned Johnstone offered lower refrigerant pricing. We countered with a volume commitment discount bringing our price to $380. Customer accepted.\", threatLevel: \"low\", responseNeeded: false, respondedAt: daysAgo(8), notes: \"Successfully defended with volume discount. Customer stayed.\" },\n\n    // Competitive win\n    { tenantId: TENANT_ID, accountId: acctId(15), projectId: projectRows[14].id, competitorName: \"Ferguson\", mentionType: \"quote\", productCategory: \"Plumbing Fixtures\", competitorPrice: \"$7,800/restaurant package\", ourPrice: \"$7,200/restaurant package\", details: \"Won against Ferguson on Navy Pier restaurant buildout. Our commercial kitchen plumbing packages were 8% cheaper with faster delivery. Ferguson couldn't match our bundled pricing.\", threatLevel: \"low\", responseNeeded: false, respondedAt: daysAgo(4), notes: \"Competitive win! Our bundled approach beats Ferguson's Ã  la carte pricing.\" },\n  ]).returning();\n  console.log(`âœ“ ${threatRows.length} CRM competitor mentions`);\n\n  console.log(\"\\nâœ… ABC Supply Co. demo data seeded successfully.\");\n  console.log(\"   3 TMs Â· 20 accounts Â· 3 graduated Â· 6 enrolled Â· 2 at-risk\");\n  console.log(`   ${contactRows.length} contacts Â· ${projectRows.length} projects Â· ${signalRows.length} order signals Â· ${threatRows.length} competitor mentions`);\n  console.log(\"   Agent state seeded for daily briefing demo.\");\n  console.log(\"   Run on Replit: npx tsx server/seed.ts\");\n}\n\nconst isDirectRun = process.argv[1]?.endsWith(\"seed.ts\") || process.argv[1]?.endsWith(\"seed.js\");\nif (isDirectRun) {\n  seed()\n    .then(() => process.exit(0))\n    .catch((err) => {\n      console.error(\"Seed error:\", err);\n      process.exit(1);\n    });\n}\n","path":null,"size_bytes":95751,"size_tokens":null},"client/src/pages/workflow-guide.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport {\n  Upload,\n  Settings,\n  Target,\n  Users,\n  ClipboardList,\n  TrendingUp,\n  LayoutDashboard,\n  ArrowRight,\n  ArrowDown,\n  CheckCircle2,\n  Calendar,\n  CalendarDays,\n  CalendarClock,\n  ChevronDown,\n  ChevronRight,\n  UserPlus,\n  Info,\n} from \"lucide-react\";\nimport teeterTotterImage from \"@assets/teeter-totter-workflow.png\";\n\ninterface WorkflowStep {\n  id: string;\n  title: string;\n  description: string;\n  url: string;\n  icon: React.ElementType;\n  isEnrollment?: boolean;\n  enrollmentTooltip?: string;\n}\n\nconst setupSteps: WorkflowStep[] = [\n  {\n    id: \"setup-1\",\n    title: \"Upload Data\",\n    description: \"Import accounts, products, categories, and order history from CSV files\",\n    url: \"/data-uploads\",\n    icon: Upload,\n  },\n  {\n    id: \"setup-2\",\n    title: \"Configure Settings\",\n    description: \"Set up scoring weights, company info, and territory managers\",\n    url: \"/settings\",\n    icon: Settings,\n  },\n  {\n    id: \"setup-3\",\n    title: \"Build ICP\",\n    description: \"Define Ideal Customer Profiles for each customer segment\",\n    url: \"/icp-builder\",\n    icon: Target,\n  },\n];\n\nconst monthlySteps: WorkflowStep[] = [\n  {\n    id: \"monthly-1\",\n    title: \"Review Revenue\",\n    description: \"Analyze enrolled accounts and calculate monthly rev-share fees\",\n    url: \"/revenue\",\n    icon: TrendingUp,\n  },\n  {\n    id: \"monthly-2\",\n    title: \"Update Data\",\n    description: \"Refresh account data and upload new order history\",\n    url: \"/data-uploads\",\n    icon: Upload,\n  },\n  {\n    id: \"monthly-3\",\n    title: \"Refine ICP\",\n    description: \"Adjust Ideal Customer Profiles based on new data insights\",\n    url: \"/icp-builder\",\n    icon: Target,\n  },\n];\n\nconst weeklySteps: WorkflowStep[] = [\n  {\n    id: \"weekly-1\",\n    title: \"Analyze Accounts\",\n    description: \"Review gap analysis and opportunity scores for all accounts\",\n    url: \"/accounts\",\n    icon: Users,\n  },\n  {\n    id: \"weekly-2\",\n    title: \"Enroll Accounts\",\n    description: \"Enroll high-opportunity accounts into the revenue program\",\n    url: \"/revenue\",\n    icon: UserPlus,\n    isEnrollment: true,\n    enrollmentTooltip: \"This is where enrollment happens, and with each account enrolled, new revenue will be unlocked.\",\n  },\n  {\n    id: \"weekly-3\",\n    title: \"Generate Playbooks\",\n    description: \"Create AI-powered sales tasks with call scripts and emails\",\n    url: \"/playbooks\",\n    icon: ClipboardList,\n  },\n  {\n    id: \"weekly-4\",\n    title: \"Track Revenue\",\n    description: \"Monitor incremental revenue and update account enrollments\",\n    url: \"/revenue\",\n    icon: TrendingUp,\n  },\n];\n\nconst dailySteps: WorkflowStep[] = [\n  {\n    id: \"daily-1\",\n    title: \"Check Dashboard\",\n    description: \"Review KPIs, top opportunities, and your daily focus tasks\",\n    url: \"/\",\n    icon: LayoutDashboard,\n  },\n  {\n    id: \"daily-2\",\n    title: \"Execute Playbooks\",\n    description: \"Complete assigned sales tasks, calls, and follow-ups\",\n    url: \"/playbooks\",\n    icon: ClipboardList,\n  },\n  {\n    id: \"daily-3\",\n    title: \"Update Progress\",\n    description: \"Mark tasks complete and log customer interactions\",\n    url: \"/playbooks\",\n    icon: CheckCircle2,\n  },\n];\n\ninterface SwimLaneProps {\n  title: string;\n  subtitle: string;\n  steps: WorkflowStep[];\n  color: string;\n  bgColor: string;\n  borderColor: string;\n  icon: React.ElementType;\n}\n\nfunction SwimLane({ title, subtitle, steps, color, bgColor, borderColor, icon: LaneIcon }: SwimLaneProps) {\n  const [, navigate] = useLocation();\n\n  return (\n    <div className={`rounded-lg border-2 ${borderColor} ${bgColor} p-4`}>\n      <div className=\"flex items-center gap-3 mb-4\">\n        <div className={`flex h-10 w-10 items-center justify-center rounded-lg ${color}`}>\n          <LaneIcon className=\"h-5 w-5 text-white\" />\n        </div>\n        <div>\n          <h3 className=\"font-semibold text-foreground\">{title}</h3>\n          <p className=\"text-sm text-muted-foreground\">{subtitle}</p>\n        </div>\n      </div>\n      \n      <div className=\"flex flex-wrap items-center gap-3\">\n        {steps.map((step, index) => (\n          <div key={step.id} className=\"flex items-center gap-3\">\n            {step.isEnrollment ? (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button\n                    onClick={() => navigate(step.url)}\n                    className=\"group flex flex-col items-start p-3 rounded-lg bg-orange-500 border-2 border-orange-600 hover-elevate active-elevate-2 cursor-pointer min-w-[180px] text-left transition-all shadow-lg\"\n                    data-testid={`workflow-step-${step.id}`}\n                  >\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <step.icon className=\"h-4 w-4 text-white\" />\n                      <span className=\"font-medium text-sm text-white\">{step.title}</span>\n                      <Info className=\"h-3 w-3 text-white/80\" />\n                    </div>\n                    <p className=\"text-xs text-white/90 line-clamp-2\">{step.description}</p>\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\" className=\"max-w-xs\">\n                  <p>{step.enrollmentTooltip}</p>\n                </TooltipContent>\n              </Tooltip>\n            ) : (\n              <button\n                onClick={() => navigate(step.url)}\n                className=\"group flex flex-col items-start p-3 rounded-lg bg-background border border-border hover-elevate active-elevate-2 cursor-pointer min-w-[180px] text-left transition-all\"\n                data-testid={`workflow-step-${step.id}`}\n              >\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <step.icon className=\"h-4 w-4 text-muted-foreground group-hover:text-primary\" />\n                  <span className=\"font-medium text-sm text-foreground\">{step.title}</span>\n                </div>\n                <p className=\"text-xs text-muted-foreground line-clamp-2\">{step.description}</p>\n              </button>\n            )}\n            {index < steps.length - 1 && (\n              <ArrowRight className=\"h-5 w-5 text-muted-foreground flex-shrink-0 hidden sm:block\" />\n            )}\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport default function WorkflowGuide() {\n  const [isHowItWorksOpen, setIsHowItWorksOpen] = useState(false);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"space-y-2\">\n        <h1 className=\"text-2xl font-bold text-foreground\" data-testid=\"text-workflow-title\">\n          Workflow Guide\n        </h1>\n        <p className=\"text-muted-foreground\">\n          Visual overview of how to use the AI VP Dashboard. Click any step to navigate directly to that feature.\n        </p>\n      </div>\n\n      <Card>\n        <Collapsible open={isHowItWorksOpen} onOpenChange={setIsHowItWorksOpen}>\n          <CollapsibleTrigger asChild>\n            <CardHeader className=\"cursor-pointer hover-elevate pb-4\">\n              <CardTitle className=\"flex items-center justify-between gap-2 text-lg\">\n                <div className=\"flex items-center gap-2\">\n                  <Info className=\"h-5 w-5 text-primary\" />\n                  How It Works\n                </div>\n                {isHowItWorksOpen ? (\n                  <ChevronDown className=\"h-5 w-5 text-muted-foreground\" />\n                ) : (\n                  <ChevronRight className=\"h-5 w-5 text-muted-foreground\" />\n                )}\n              </CardTitle>\n            </CardHeader>\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <CardContent className=\"pt-0\">\n              <div className=\"flex flex-col items-center gap-4\">\n                <img \n                  src={teeterTotterImage} \n                  alt=\"Workflow diagram showing Account Enrollment as the central fulcrum, with data preparation activities on the left and sales execution activities on the right\" \n                  className=\"w-full max-w-4xl rounded-lg border border-border\"\n                  data-testid=\"img-teeter-totter\"\n                />\n                <p className=\"text-sm text-muted-foreground text-center max-w-2xl\">\n                  Account Enrollment is the central pivot point of this system. On the left, prepare your data through uploads, configuration, and ICP analysis. \n                  Once enrolled, execute sales activities on the right through playbooks, tasks, and revenue tracking.\n                </p>\n              </div>\n            </CardContent>\n          </CollapsibleContent>\n        </Collapsible>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <Badge variant=\"secondary\" className=\"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400\">\n              One-Time Setup\n            </Badge>\n            Getting Started\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <SwimLane\n            title=\"Initial Setup\"\n            subtitle=\"Complete these steps once when first using the system\"\n            steps={setupSteps}\n            color=\"bg-amber-500\"\n            bgColor=\"bg-amber-50/50 dark:bg-amber-950/20\"\n            borderColor=\"border-amber-200 dark:border-amber-800\"\n            icon={Settings}\n          />\n        </CardContent>\n      </Card>\n\n      <div className=\"flex justify-center\">\n        <ArrowDown className=\"h-8 w-8 text-muted-foreground\" />\n      </div>\n\n      <div className=\"grid gap-6\">\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"flex items-center gap-2 text-lg\">\n              <Badge variant=\"secondary\" className=\"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400\">\n                Monthly\n              </Badge>\n              Monthly Review Cycle\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <SwimLane\n              title=\"Monthly Tasks\"\n              subtitle=\"Complete these tasks once per month\"\n              steps={monthlySteps}\n              color=\"bg-purple-500\"\n              bgColor=\"bg-purple-50/50 dark:bg-purple-950/20\"\n              borderColor=\"border-purple-200 dark:border-purple-800\"\n              icon={Calendar}\n            />\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"flex items-center gap-2 text-lg\">\n              <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\">\n                Weekly\n              </Badge>\n              Weekly Planning Cycle\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <SwimLane\n              title=\"Weekly Tasks\"\n              subtitle=\"Complete these tasks once per week\"\n              steps={weeklySteps}\n              color=\"bg-blue-500\"\n              bgColor=\"bg-blue-50/50 dark:bg-blue-950/20\"\n              borderColor=\"border-blue-200 dark:border-blue-800\"\n              icon={CalendarDays}\n            />\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"flex items-center gap-2 text-lg\">\n              <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\n                Daily\n              </Badge>\n              Daily Execution Cycle\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <SwimLane\n              title=\"Daily Tasks\"\n              subtitle=\"Complete these tasks every day\"\n              steps={dailySteps}\n              color=\"bg-green-500\"\n              bgColor=\"bg-green-50/50 dark:bg-green-950/20\"\n              borderColor=\"border-green-200 dark:border-green-800\"\n              icon={CalendarClock}\n            />\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"bg-muted/30\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-start gap-3\">\n            <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-primary/10\">\n              <CheckCircle2 className=\"h-4 w-4 text-primary\" />\n            </div>\n            <div>\n              <h4 className=\"font-medium text-foreground\">Pro Tip</h4>\n              <p className=\"text-sm text-muted-foreground\">\n                Start each day by checking the Dashboard for your top opportunities, then work through your assigned playbook tasks. \n                Weekly, review account gaps and generate new playbooks. Monthly, refresh your data and review overall revenue performance.\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":13155,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"STRIPE-SETUP.md":{"content":"# Stripe Subscription Integration\n\nThis document explains how to set up and configure Stripe for subscription billing.\n\n## Environment Variables\n\n### Required Variables\n\n| Variable | Description | Example |\n|----------|-------------|---------|\n| `STRIPE_SECRET_KEY` | Stripe API secret key (test or live) | `sk_test_...` or `sk_live_...` |\n| `STRIPE_WEBHOOK_SECRET` | Webhook signing secret from Stripe Dashboard | `whsec_...` |\n\n### Optional Variables\n\n| Variable | Description | Default |\n|----------|-------------|---------|\n| `STRIPE_PRICE_IDS` | Comma-separated whitelist of price IDs for this app | All prices allowed |\n| `APP_SLUG` | Unique identifier for this app (used in webhook filtering) | `ai-revenue-engineer` |\n| `BASE_URL` | Application base URL for checkout success/cancel URLs | Auto-detected from Replit |\n| `STRIPE_CUSTOMER_PORTAL_RETURN_URL` | Custom return URL for billing portal | `{BASE_URL}/subscription` |\n\n## Test Mode Setup\n\n### Step 1: Get Your Test API Keys\n\n1. Log in to [Stripe Dashboard](https://dashboard.stripe.com)\n2. Make sure \"Test mode\" is toggled ON (top right)\n3. Go to **Developers > API keys**\n4. Copy the \"Secret key\" (starts with `sk_test_`)\n\n### Step 2: Create Products and Prices\n\n1. Go to **Products** in Stripe Dashboard\n2. Click **Add product**\n3. Create products for each plan (Starter, Growth, Scale)\n4. For each product, add pricing:\n   - Monthly price (recurring)\n   - Yearly price (recurring, optional)\n5. Copy the Price IDs (start with `price_`)\n\n### Step 3: Configure Webhook\n\n1. Go to **Developers > Webhooks**\n2. Click **Add endpoint**\n3. Endpoint URL: `https://ai-revenue-engineer.replit.app/api/stripe/webhook`\n4. Select events to listen to:\n   - `checkout.session.completed`\n   - `customer.subscription.created`\n   - `customer.subscription.updated`\n   - `customer.subscription.deleted`\n   - `invoice.paid`\n   - `invoice.payment_failed`\n5. Click **Add endpoint**\n6. Copy the \"Signing secret\" (starts with `whsec_`)\n\n### Step 4: Set Environment Variables in Replit\n\nAdd these secrets in your Replit project:\n\n```\nSTRIPE_SECRET_KEY=sk_test_your_test_key_here\nSTRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here\nAPP_SLUG=ai-revenue-engineer\n```\n\nOptional (for price ID whitelisting):\n```\nSTRIPE_PRICE_IDS=price_123abc,price_456def,price_789ghi\n```\n\n### Step 5: Configure Price IDs in App\n\n1. Log in as a platform admin (graham@tenexity.ai or admin@tenexity.ai)\n2. Go to **App Admin > Stripe** tab\n3. For each plan, click the edit button and enter the Stripe Price IDs\n\n## Go-Live Checklist\n\nWhen you're ready to accept real payments:\n\n- [ ] **Create Live Products**: Recreate your products/prices in Live mode in Stripe Dashboard\n- [ ] **Get Live API Key**: Copy `sk_live_...` from Stripe Dashboard (Test mode OFF)\n- [ ] **Create Live Webhook**: Add a new webhook endpoint in Live mode with the same URL\n- [ ] **Update Environment Variables**:\n  - Replace `STRIPE_SECRET_KEY` with live key\n  - Replace `STRIPE_WEBHOOK_SECRET` with live webhook secret\n  - Update `STRIPE_PRICE_IDS` with live price IDs (if used)\n- [ ] **Update App Price IDs**: Enter live Price IDs in App Admin > Stripe tab\n- [ ] **Test with Real Card**: Make a small test purchase with a real card\n- [ ] **Verify Webhook Delivery**: Check Stripe Dashboard > Webhooks for successful deliveries\n\n## Verification Steps\n\n### Test the Health Endpoint\n\n```bash\ncurl https://ai-revenue-engineer.replit.app/health\n```\n\nExpected response:\n```json\n{\"status\":\"OK\",\"timestamp\":\"2025-01-28T...\"}\n```\n\n### Test Webhook (Stripe CLI)\n\n1. Install [Stripe CLI](https://stripe.com/docs/stripe-cli)\n2. Forward webhooks to local:\n   ```bash\n   stripe listen --forward-to localhost:5000/api/stripe/webhook\n   ```\n3. Trigger a test event:\n   ```bash\n   stripe trigger checkout.session.completed\n   ```\n\n### Check Debug Info\n\n1. Log in as platform admin\n2. Go to App Admin > Stripe tab\n3. Scroll down to \"Stripe Debug Info\" section\n4. Verify:\n   - Mode shows \"TEST\" or \"LIVE\"\n   - Status shows \"Configured\"\n   - Webhook shows \"Configured\"\n   - All environment variables show green indicators\n\n## Webhook URL\n\n```\nhttps://ai-revenue-engineer.replit.app/api/stripe/webhook\n```\n\n## Security Features\n\n### Price ID Whitelisting\n\nIf `STRIPE_PRICE_IDS` is set:\n1. **Checkout Creation**: Only allowed price IDs can be used when creating checkout sessions\n2. **Webhook Processing**: Events containing non-whitelisted price IDs are skipped\n3. **Fail Closed**: If the price ID cannot be determined from an event, the event is skipped (not processed)\n\nThis prevents users from subscribing to prices intended for other applications sharing the same Stripe account.\n\n**Important**: When using the price whitelist, all checkout sessions include the priceId in metadata to ensure webhook validation can always determine the price. For legacy events or events from other sources, the system will attempt to extract price IDs from subscription items or invoice lines.\n\n### App Slug Metadata (Strict Validation)\n\nAll checkout sessions include `metadata.app` with the configured `APP_SLUG`.\n\n**Webhook behavior**:\n- Events WITH matching `metadata.app` are processed\n- Events WITH different `metadata.app` are skipped (other app)\n- Events WITHOUT `metadata.app` are skipped for security\n\nThis strict validation ensures events from other apps (or legacy events without metadata) don't accidentally affect this application.\n\n### Idempotency\n\nThe webhook handler uses a dedicated `stripe_webhook_events` table:\n1. Event ID is recorded immediately upon receipt (before processing)\n2. Duplicate events are detected and skipped\n3. Result is tracked: `processing` â†’ `processed` / `error` / `skipped_*`\n\nThis prevents double-processing even if the event couldn't be matched to a tenant.\n\n### Structured Logging\n\nAll webhook events are logged with structured JSON including:\n- Event ID\n- Event type\n- App slug\n- Subscription ID\n- Customer ID\n- Tenant ID\n- Price ID\n- Processing result\n- Skip reason (if applicable)\n\n## Troubleshooting\n\n### \"Stripe is not configured\"\n\nMake sure `STRIPE_SECRET_KEY` is set in your environment variables.\n\n### \"Webhook signature verification failed\"\n\n1. Make sure `STRIPE_WEBHOOK_SECRET` is set correctly\n2. Verify you're using the signing secret from the correct webhook endpoint\n3. Check that you're using the test/live secret matching your API key mode\n\n### \"Invalid price ID for this application\"\n\nThe requested price ID is not in the `STRIPE_PRICE_IDS` whitelist. Either:\n- Add the price ID to the whitelist\n- Remove the whitelist to allow all price IDs\n\n### Webhooks not being received\n\n1. Check Stripe Dashboard > Webhooks for delivery status\n2. Verify the endpoint URL is correct\n3. Check server logs for incoming webhook requests\n4. Ensure the server is running and publicly accessible\n","path":null,"size_bytes":6801,"size_tokens":null},"CODE_REVIEW_REPORT.md":{"content":"# COMPREHENSIVE CODE REVIEW REPORT\n**Project: AI VP Dashboard**  \n**Review Date: January 27, 2026**  \n**Reviewer: Automated Code Review System**\n\n---\n\n## EXECUTIVE SUMMARY\n\nThis codebase represents a multi-tenant SaaS application for B2B sales analytics with subscription management. The architecture demonstrates solid multi-tenancy isolation patterns, proper authentication via Replit Auth with secure session management, and comprehensive subscription management with Stripe integration.\n\n**Overall Code Health: 6/10**\n\nThe application has a strong foundation with well-implemented security patterns, but has significant gaps in test coverage and resilience patterns for external service integrations that reduce the overall score.\n\n---\n\n## 1. SECURITY VULNERABILITIES\n\n### CRITICAL\n\n**(No critical security vulnerabilities found)**\n\n### HIGH\n\n**1.1 Missing Rate Limiting on Authentication Endpoints**\n- **File:** `server/replit_integrations/auth/replitAuth.ts` (lines 105-131)\n- **Issue:** No rate limiting on `/api/login`, `/api/callback`, `/api/logout` endpoints\n- **Impact:** Susceptible to brute force attacks and credential stuffing\n- **Recommended Fix:**\n```typescript\nimport rateLimit from 'express-rate-limit';\n\nconst authLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 5, // 5 attempts\n  message: { message: 'Too many login attempts, please try again later' }\n});\n\napp.get(\"/api/login\", authLimiter, (req, res, next) => {\n  // existing code\n});\n```\n\n### MEDIUM\n\n**1.2 Potential Information Leakage in Zod Error Responses**\n- **File:** `server/utils/errorHandler.ts` (lines 4-21)\n- **Issue:** Zod validation errors return detailed field-level messages to client\n- **Impact:** Could expose internal schema structure to attackers\n- **Recommended Fix:** Consider sanitizing error details in production environments\n\n**1.3 Missing Environment Variable Validation at Startup**\n- **Files:** `server/replit_integrations/auth/replitAuth.ts` (line 31), `server/db.ts` (line 6)\n- **Issue:** Required environment variables (`SESSION_SECRET`, `DATABASE_URL`) use non-null assertions without validation\n- **Impact:** Application could start with undefined values, causing unclear runtime errors\n- **Recommended Fix:** Add explicit validation and fail-fast at startup\n\n### LOW\n\n**1.4 CSRF Protection Assessment**\n- **Note:** The application uses Replit Auth with secure, httpOnly, same-site cookies (line 35-38 in replitAuth.ts). This provides significant CSRF protection. Additional CSRF tokens may be beneficial for highly sensitive operations but are not critical given the cookie security configuration.\n\n---\n\n## 2. PERFORMANCE ISSUES\n\n### HIGH\n\n**2.1 N+1 Query Pattern in Graduation Ready Endpoint**\n- **File:** `server/routes.ts` (lines 1528-1590)\n- **Issue:** For each active program account, makes individual queries for account, metrics, and snapshots\n- **Impact:** Performance degrades linearly with number of accounts\n- **Recommended Fix:** Use batch queries:\n```typescript\nconst accountIds = activeAccounts.map(pa => pa.accountId);\nconst [accountsMap, metricsMap] = await Promise.all([\n  tenantStorage.getAccountsBatch(accountIds),\n  tenantStorage.getAccountMetricsBatch(accountIds)\n]);\n```\n\n**2.2 Unbounded Queries Without Default Pagination**\n- **File:** `server/storage.ts` (multiple locations)\n- **Issue:** Several `getAll*` methods return all records without LIMIT\n- **Impact:** Potential memory exhaustion with large datasets\n- **Recommended Fix:** Add default limits (e.g., 1000) with pagination support\n\n### MEDIUM\n\n**2.3 Repeated Category Lookups**\n- **File:** `server/routes.ts` (lines 140-146, 290-292, 544-545)\n- **Issue:** Categories fetched multiple times per request in some endpoints\n- **Recommended Fix:** Fetch once and reuse, or implement caching for infrequently changing data\n\n---\n\n## 3. BUG DETECTION\n\n### HIGH\n\n**3.1 Potential Race Condition in Scoring Weights Upsert**\n- **File:** `server/storage.ts` (lines 451-462)\n- **Issue:** Deactivate-then-insert pattern is not atomic\n- **Impact:** Concurrent requests could create multiple active weights\n- **Recommended Fix:** Use database transaction:\n```typescript\nasync upsertScoringWeights(weights: InsertScoringWeights): Promise<ScoringWeights> {\n  return db.transaction(async (tx) => {\n    await tx.update(scoringWeights).set({ isActive: false }).where(eq(scoringWeights.isActive, true));\n    const [created] = await tx.insert(scoringWeights).values({\n      ...weights,\n      isActive: true,\n    }).returning();\n    return created;\n  });\n}\n```\n\n### MEDIUM\n\n**3.2 Edge Case: Empty Tier List in Fee Calculation**\n- **File:** `server/routes.ts` (lines 2027-2071)\n- **Issue:** Revenue calculation logic assumes tiers are properly sorted and non-overlapping\n- **Current Mitigation:** Default 15% rate is applied when no tiers exist (good fallback)\n\n### LOW\n\n**3.3 Date Comparison Timezone Considerations**\n- **File:** `server/routes.ts` (lines 218-238)\n- **Issue:** UTC date comparisons may have edge cases at day boundaries\n- **Impact:** Minor - tasks might appear overdue/not overdue incorrectly at midnight boundaries\n\n---\n\n## 4. CODE STYLE & READABILITY\n\n### MEDIUM\n\n**4.1 Long Route Handlers**\n- **File:** `server/routes.ts`\n- **Issue:** Several route handlers exceed 80-100 lines (e.g., enrollment endpoint)\n- **Recommended Fix:** Extract business logic into service layer functions\n\n**4.2 Inconsistent Error Response Format**\n- **Files:** Various route handlers\n- **Issue:** Some use `{ message: \"...\" }`, others use `{ error: \"...\" }`\n- **Recommended Fix:** Standardize on one format\n\n### LOW\n\n**4.3 Magic Number Opportunities**\n- **Issue:** Some inline calculations could use named constants for clarity\n- **Example:** `1000 * 60 * 60 * 24 * 30` could be `MS_PER_MONTH`\n- **Note:** Core constants (`DASHBOARD_LIMITS`, `DEFAULT_VALUES`) are already well-defined\n\n---\n\n## 5. TEST COVERAGE\n\n### HIGH\n\n**5.1 Missing Integration Tests**\n- **Issue:** No integration tests for actual API endpoints\n- **Impact:** Route logic and middleware chain not tested end-to-end\n- **Recommended Fix:** Add supertest-based API tests for critical paths\n\n**5.2 Missing Tests for Critical Paths**\n- **Files Not Tested:**\n  - `server/routes.ts` - Main API routes\n  - `server/storage.ts` - Actual database operations (mocked in current tests)\n  - `server/ai-service.ts` - AI integration\n  - `server/email-service.ts` - Email notifications\n  - Stripe webhook handling\n\n### MEDIUM\n\n**5.3 Thin Unit Tests**\n- **Files:** `tests/unit/*.test.ts`\n- **Issue:** Middleware tests verify function signatures but use mocks for all database interactions\n- **Impact:** Storage layer actual behavior is not verified against real database\n\n---\n\n## 6. DOCUMENTATION\n\n### MEDIUM\n\n**6.1 Environment Variables Not Centrally Documented**\n- **Issue:** Required env vars scattered across files\n- **Required Variables:**\n  - `DATABASE_URL` (required)\n  - `SESSION_SECRET` (required)\n  - `REPL_ID` (required)\n  - `STRIPE_SECRET_KEY` (optional - enables Stripe features)\n  - `STRIPE_WEBHOOK_SECRET` (optional)\n  - `RESEND_API_KEY` (optional - enables email)\n  - `AI_INTEGRATIONS_OPENAI_API_KEY` (optional - enables AI features)\n\n### LOW\n\n**6.2 API Documentation**\n- **Issue:** JSDoc comments exist for some routes but coverage is incomplete\n- **Recommended Fix:** Consider adding OpenAPI/Swagger documentation\n\n---\n\n## 7. ARCHITECTURE & DESIGN PATTERNS\n\n### STRENGTHS âœ“\n\n**7.1 Multi-Tenant Storage Pattern**\n- `TenantStorage` class properly isolates data per tenant\n- Automatic `tenantId` injection on all operations\n- Good separation between global and tenant-scoped storage\n\n**7.2 Middleware Chain Pattern**\n- Clear middleware composition: `isAuthenticated â†’ withTenantContext â†’ requireSubscription`\n- Well-defined permission levels: `requireAuth`, `requireWrite`, `requireAdmin`\n\n**7.3 Input Validation with Zod**\n- Consistent use of Zod schemas for request validation\n- Schemas co-located with database definitions\n\n**7.4 Batch Query Patterns**\n- `getAccountMetricsBatch`, `getAccountsBatch` demonstrate good batch loading patterns\n\n### MEDIUM\n\n**7.5 Business Logic in Route Handlers**\n- **Issue:** Route handlers contain significant business logic\n- **Impact:** Harder to unit test, limits code reuse\n- **Recommended Fix:** Consider extracting complex business logic to service layer for testability\n\n---\n\n## 8. ERROR HANDLING & RESILIENCE\n\n### HIGH\n\n**8.1 No Retry Logic for External API Calls**\n- **Files:** `server/ai-service.ts`, `server/email-service.ts`\n- **Issue:** OpenAI and Resend API calls have no retry mechanism\n- **Impact:** Transient failures result in immediate user-facing errors\n- **Recommended Fix:**\n```typescript\nasync function withRetry<T>(fn: () => Promise<T>, retries = 3): Promise<T> {\n  for (let i = 0; i < retries; i++) {\n    try {\n      return await fn();\n    } catch (error) {\n      if (i === retries - 1) throw error;\n      await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));\n    }\n  }\n  throw new Error('Retry exhausted');\n}\n```\n\n**8.2 Missing Timeout on External API Calls**\n- **Files:** `server/ai-service.ts`, `server/email-service.ts`\n- **Issue:** No timeout configured for OpenAI API calls\n- **Impact:** Requests could hang if external service is unresponsive\n- **Recommended Fix:** Configure request timeouts (e.g., 30 seconds)\n\n### MEDIUM\n\n**8.3 Consistent Error Response Format Needed**\n- **Issue:** Error responses vary between `{ message }` and `{ error }`\n- **Recommended Fix:** Standardize error response schema\n\n---\n\n## SUMMARY\n\n### Top 4 Most Critical Issues (Prioritized for Fix)\n\n1. **~~Missing Rate Limiting on Auth Endpoints~~** (Security) - âœ… **FIXED** - Added express-rate-limit to /api/login (10/15min), /api/callback (10/15min), /api/logout (5/1min)\n\n2. **~~N+1 Query in Graduation Ready Endpoint~~** (Performance) - âœ… **FIXED** - Refactored to use batch queries (getAccountsBatch, getAccountMetricsBatch, getProgramRevenueSnapshotsBatch) with Map-based O(1) lookups\n\n3. **Missing Integration/API Tests** (Testing) - âš ï¸ **PENDING** - Add end-to-end tests for critical paths including authentication, subscription, and core business flows\n\n4. **~~No Retry Logic/Timeouts for External APIs~~** (Resilience) - âœ… **FIXED** - Created withRetry utility with exponential backoff + jitter, applied to all OpenAI (60s timeout) and Resend (30s timeout) API calls\n\n### Technical Debt Score: 7/10 (improved from 6/10)\n\n**Strengths:**\n- Solid multi-tenant architecture with proper data isolation\n- Good authentication and authorization patterns with secure cookie configuration\n- Proper input validation using Zod schemas\n- Stripe integration with webhook signature verification\n- Batch query patterns for common operations\n- âœ… Rate limiting on authentication endpoints\n- âœ… Retry logic with exponential backoff for external APIs\n- âœ… Configurable timeouts for AI and email services\n\n**Remaining Areas for Improvement:**\n- Test coverage is thin - only middleware unit tests exist, no integration tests\n- Business logic mixed into route handlers\n- Add default pagination limits for unbounded queries\n\n### Recommended Priority Order for Remaining Fixes\n\n1. **Short-term (Quality):** Expand test coverage with integration tests for critical paths\n2. **Short-term (Performance):** Add default pagination limits to prevent unbounded queries\n3. **Ongoing (Quality):** Extract business logic from route handlers into service layer\n\n---\n\n*Report generated by automated code review system*\n","path":null,"size_bytes":11514,"size_tokens":null},"tests/integration/dashboard.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\n\nconst mockStorage = {\n  getAccounts: vi.fn(),\n  getTasks: vi.fn(),\n  getProgramAccounts: vi.fn(),\n  getAccountMetrics: vi.fn(),\n  getAccountMetricsBatch: vi.fn(),\n  getSegmentProfiles: vi.fn(),\n};\n\ndescribe('Dashboard API Integration Tests', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('GET /api/dashboard/stats', () => {\n    it('returns aggregated dashboard statistics', async () => {\n      const accounts = [\n        { id: 1, name: 'Account 1', segment: 'residential', annualRevenue: '100000' },\n        { id: 2, name: 'Account 2', segment: 'commercial', annualRevenue: '250000' },\n        { id: 3, name: 'Account 3', segment: 'residential', annualRevenue: '75000' },\n      ];\n\n      const tasks = [\n        { id: 1, status: 'pending', priority: 'high' },\n        { id: 2, status: 'completed', priority: 'medium' },\n        { id: 3, status: 'pending', priority: 'low' },\n      ];\n\n      mockStorage.getAccounts.mockResolvedValue(accounts);\n      mockStorage.getTasks.mockResolvedValue(tasks);\n\n      const [accountsResult, tasksResult] = await Promise.all([\n        mockStorage.getAccounts(),\n        mockStorage.getTasks(),\n      ]);\n\n      expect(accountsResult).toHaveLength(3);\n      expect(tasksResult).toHaveLength(3);\n\n      const stats = {\n        totalAccounts: accountsResult.length,\n        totalRevenue: accountsResult.reduce((sum: number, a: any) => sum + parseFloat(a.annualRevenue), 0),\n        pendingTasks: tasksResult.filter((t: any) => t.status === 'pending').length,\n        completedTasks: tasksResult.filter((t: any) => t.status === 'completed').length,\n      };\n\n      expect(stats.totalAccounts).toBe(3);\n      expect(stats.totalRevenue).toBe(425000);\n      expect(stats.pendingTasks).toBe(2);\n      expect(stats.completedTasks).toBe(1);\n    });\n\n    it('handles empty data gracefully', async () => {\n      mockStorage.getAccounts.mockResolvedValue([]);\n      mockStorage.getTasks.mockResolvedValue([]);\n\n      const accounts = await mockStorage.getAccounts();\n      const tasks = await mockStorage.getTasks();\n\n      const stats = {\n        totalAccounts: accounts.length,\n        totalRevenue: 0,\n        pendingTasks: 0,\n        completedTasks: 0,\n      };\n\n      expect(stats.totalAccounts).toBe(0);\n      expect(stats.totalRevenue).toBe(0);\n    });\n\n    it('calculates average opportunity score', async () => {\n      const metricsMap = new Map([\n        [1, { accountId: 1, opportunityScore: 85 }],\n        [2, { accountId: 2, opportunityScore: 72 }],\n        [3, { accountId: 3, opportunityScore: 91 }],\n      ]);\n\n      mockStorage.getAccountMetricsBatch.mockResolvedValue(metricsMap);\n\n      const metrics = await mockStorage.getAccountMetricsBatch([1, 2, 3]);\n\n      const scores = Array.from(metrics.values()).map((m: any) => m.opportunityScore);\n      const avgScore = scores.reduce((sum, score) => sum + score, 0) / scores.length;\n\n      expect(avgScore).toBeCloseTo(82.67, 1);\n    });\n  });\n\n  describe('GET /api/daily-focus', () => {\n    it('returns high-priority tasks for today', async () => {\n      const today = new Date();\n      const tasks = [\n        { id: 1, status: 'pending', priority: 'high', dueDate: today },\n        { id: 2, status: 'pending', priority: 'high', dueDate: today },\n        { id: 3, status: 'pending', priority: 'low', dueDate: today },\n        { id: 4, status: 'completed', priority: 'high', dueDate: today },\n      ];\n\n      mockStorage.getTasks.mockResolvedValue(tasks);\n\n      const allTasks = await mockStorage.getTasks();\n      const focusTasks = allTasks.filter(\n        (t: any) => t.status === 'pending' && t.priority === 'high'\n      );\n\n      expect(focusTasks).toHaveLength(2);\n    });\n\n    it('includes overdue tasks', async () => {\n      const yesterday = new Date();\n      yesterday.setDate(yesterday.getDate() - 1);\n\n      const tasks = [\n        { id: 1, status: 'pending', priority: 'high', dueDate: yesterday },\n        { id: 2, status: 'pending', priority: 'medium', dueDate: yesterday },\n      ];\n\n      mockStorage.getTasks.mockResolvedValue(tasks);\n\n      const allTasks = await mockStorage.getTasks();\n      const today = new Date();\n      const overdueTasks = allTasks.filter(\n        (t: any) => t.status === 'pending' && new Date(t.dueDate) < today\n      );\n\n      expect(overdueTasks).toHaveLength(2);\n    });\n\n    it('limits results to configured maximum', async () => {\n      const tasks = Array.from({ length: 20 }, (_, i) => ({\n        id: i + 1,\n        status: 'pending',\n        priority: 'high',\n        dueDate: new Date(),\n      }));\n\n      mockStorage.getTasks.mockResolvedValue(tasks);\n\n      const allTasks = await mockStorage.getTasks();\n      const MAX_FOCUS_TASKS = 10;\n      const focusTasks = allTasks.slice(0, MAX_FOCUS_TASKS);\n\n      expect(focusTasks).toHaveLength(MAX_FOCUS_TASKS);\n    });\n  });\n\n  describe('Dashboard Performance', () => {\n    it('uses parallel queries for efficiency', async () => {\n      mockStorage.getAccounts.mockResolvedValue([]);\n      mockStorage.getTasks.mockResolvedValue([]);\n      mockStorage.getProgramAccounts.mockResolvedValue([]);\n      mockStorage.getSegmentProfiles.mockResolvedValue([]);\n\n      const startTime = Date.now();\n\n      await Promise.all([\n        mockStorage.getAccounts(),\n        mockStorage.getTasks(),\n        mockStorage.getProgramAccounts(),\n        mockStorage.getSegmentProfiles(),\n      ]);\n\n      const duration = Date.now() - startTime;\n\n      expect(mockStorage.getAccounts).toHaveBeenCalledTimes(1);\n      expect(mockStorage.getTasks).toHaveBeenCalledTimes(1);\n      expect(mockStorage.getProgramAccounts).toHaveBeenCalledTimes(1);\n      expect(mockStorage.getSegmentProfiles).toHaveBeenCalledTimes(1);\n    });\n\n    it('caches segment profiles when unchanged', async () => {\n      const profiles = [\n        { id: 1, segment: 'residential', minAnnualRevenue: 50000 },\n        { id: 2, segment: 'commercial', minAnnualRevenue: 100000 },\n      ];\n\n      mockStorage.getSegmentProfiles.mockResolvedValue(profiles);\n\n      const first = await mockStorage.getSegmentProfiles();\n      const second = await mockStorage.getSegmentProfiles();\n\n      expect(first).toEqual(second);\n    });\n  });\n\n  describe('Segment Breakdown', () => {\n    it('calculates revenue by segment', async () => {\n      const accounts = [\n        { id: 1, segment: 'residential', annualRevenue: '100000' },\n        { id: 2, segment: 'commercial', annualRevenue: '250000' },\n        { id: 3, segment: 'residential', annualRevenue: '75000' },\n        { id: 4, segment: 'industrial', annualRevenue: '500000' },\n      ];\n\n      mockStorage.getAccounts.mockResolvedValue(accounts);\n\n      const allAccounts = await mockStorage.getAccounts();\n\n      const bySegment = allAccounts.reduce((acc: Record<string, number>, account: any) => {\n        const segment = account.segment;\n        acc[segment] = (acc[segment] || 0) + parseFloat(account.annualRevenue);\n        return acc;\n      }, {});\n\n      expect(bySegment.residential).toBe(175000);\n      expect(bySegment.commercial).toBe(250000);\n      expect(bySegment.industrial).toBe(500000);\n    });\n\n    it('counts accounts by segment', async () => {\n      const accounts = [\n        { id: 1, segment: 'residential' },\n        { id: 2, segment: 'commercial' },\n        { id: 3, segment: 'residential' },\n        { id: 4, segment: 'industrial' },\n        { id: 5, segment: 'residential' },\n      ];\n\n      mockStorage.getAccounts.mockResolvedValue(accounts);\n\n      const allAccounts = await mockStorage.getAccounts();\n\n      const countBySegment = allAccounts.reduce((acc: Record<string, number>, account: any) => {\n        acc[account.segment] = (acc[account.segment] || 0) + 1;\n        return acc;\n      }, {});\n\n      expect(countBySegment.residential).toBe(3);\n      expect(countBySegment.commercial).toBe(1);\n      expect(countBySegment.industrial).toBe(1);\n    });\n  });\n});\n","path":null,"size_bytes":7963,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"README.md":{"content":"# AI VP Dashboard\n\nA sales intelligence tool designed for ABC Supply to identify wallet share leakage within existing customer accounts and generate actionable tasks for Territory Managers.\n\n## Quick Start\n\n1. Clone and install dependencies:\n   ```bash\n   npm install\n   ```\n\n2. Set up required environment variables (see [Secrets Setup](#required-secrets))\n\n3. Start the development server:\n   ```bash\n   npm run dev\n   ```\n\n4. Open your browser to `http://localhost:5000`\n\n## Required Secrets\n\n| Secret | Description |\n|--------|-------------|\n| `DATABASE_URL` | PostgreSQL connection string (auto-provided by Replit) |\n| `SESSION_SECRET` | Secret key for session encryption |\n| `STRIPE_SECRET_KEY` | Stripe API secret key (`sk_test_...` or `sk_live_...`) |\n| `STRIPE_WEBHOOK_SECRET` | Stripe webhook signing secret (`whsec_...`) |\n\n### Optional Environment Variables\n\n| Variable | Description | Default |\n|----------|-------------|---------|\n| `APP_SLUG` | Unique app identifier for multi-app Stripe accounts | `ai-revenue-engineer` |\n| `BASE_URL` | Application base URL | Auto-detected from Replit |\n| `STRIPE_PRICE_IDS` | Comma-separated price ID whitelist | All prices allowed |\n| `RESEND_API_KEY` | Resend API key for email notifications | Disabled |\n\n## Stripe Integration\n\nFor complete Stripe setup instructions including:\n- Creating products and prices in Stripe Dashboard\n- Setting up webhooks\n- Testing with Stripe CLI\n- Go-live checklist\n\n**See [STRIPE-SETUP.md](./STRIPE-SETUP.md)**\n\n### Webhook Endpoint\n\n```\nhttps://your-domain.replit.app/api/stripe/webhook\n```\n\n### Required Webhook Events\n\nConfigure these events in your Stripe Dashboard webhook settings:\n- `checkout.session.completed`\n- `customer.subscription.created`\n- `customer.subscription.updated`\n- `customer.subscription.deleted`\n- `invoice.paid`\n- `invoice.payment_failed`\n\n## Features\n\n- **Dashboard**: Real-time sales metrics and opportunity scores\n- **Account Insights**: Gap analysis and category penetration metrics\n- **ICP Builder**: AI-assisted Ideal Customer Profile creation\n- **Playbooks**: AI-generated sales tasks, call scripts, and email templates\n- **Revenue Tracking**: Track enrolled accounts and calculate rev-share fees\n- **Multi-Tenant**: Complete tenant isolation with role-based access control\n- **Subscription Billing**: Stripe integration with tier-based feature limits\n\n## Tech Stack\n\n- **Frontend**: React + TypeScript, Vite, Tailwind CSS, shadcn/ui\n- **Backend**: Express.js, Node.js\n- **Database**: PostgreSQL (Neon) with Drizzle ORM\n- **Authentication**: Replit Auth (OpenID Connect)\n- **Payments**: Stripe Subscriptions\n- **AI**: OpenAI GPT via Replit AI Integrations\n\n## Project Structure\n\n```\nâ”œâ”€â”€ client/           # React frontend\nâ”‚   â”œâ”€â”€ src/\nâ”‚   â”‚   â”œâ”€â”€ components/\nâ”‚   â”‚   â”œâ”€â”€ pages/\nâ”‚   â”‚   â””â”€â”€ lib/\nâ”œâ”€â”€ server/           # Express backend\nâ”‚   â”œâ”€â”€ routes.ts\nâ”‚   â”œâ”€â”€ storage.ts\nâ”‚   â””â”€â”€ middleware/\nâ”œâ”€â”€ shared/           # Shared TypeScript schemas\nâ””â”€â”€ STRIPE-SETUP.md   # Stripe configuration guide\n```\n\n## License\n\nProprietary - All rights reserved.\n","path":null,"size_bytes":3150,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/pages/playbooks.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useSearch } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DataTable } from \"@/components/data-table\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  ClipboardList,\n  Plus,\n  Phone,\n  Mail,\n  MapPin,\n  ChevronDown,\n  ChevronRight,\n  CheckCircle,\n  Clock,\n  Search,\n  Filter,\n  Download,\n  Sparkles,\n  Loader2,\n  Calendar,\n  User,\n  MessageSquare,\n  HelpCircle,\n  Target,\n  BookOpen,\n  Info,\n  ExternalLink,\n} from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface Task {\n  id: number;\n  accountId: number;\n  accountName: string;\n  assignedTm: string;\n  taskType: \"call\" | \"email\" | \"visit\";\n  title: string;\n  description: string;\n  script: string;\n  gapCategories: string[];\n  status: \"pending\" | \"in_progress\" | \"completed\" | \"skipped\";\n  dueDate: string;\n  completedAt?: string;\n  outcome?: string;\n  playbookId?: number;\n}\n\ninterface Playbook {\n  id: number;\n  name: string;\n  generatedBy: string;\n  generatedAt: string;\n  taskCount: number;\n  completedCount: number;\n}\n\ninterface CustomCategory {\n  id: number;\n  name: string;\n  displayOrder: number;\n  isActive: boolean;\n}\n\nconst taskTypeIcons = {\n  call: Phone,\n  email: Mail,\n  visit: MapPin,\n};\n\nconst statusColors: Record<string, string> = {\n  pending: \"bg-chart-3/10 text-chart-3 border-chart-3/20\",\n  in_progress: \"bg-chart-1/10 text-chart-1 border-chart-1/20\",\n  completed: \"bg-chart-2/10 text-chart-2 border-chart-2/20\",\n  skipped: \"bg-muted text-muted-foreground border-muted\",\n};\n\nexport default function Playbooks() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [typeFilter, setTypeFilter] = useState<string>(\"all\");\n  const [selectedTask, setSelectedTask] = useState<Task | null>(null);\n  const [selectedPlaybookId, setSelectedPlaybookId] = useState<number | null>(null);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [showGenerateDialog, setShowGenerateDialog] = useState(false);\n  const [showHelpDialog, setShowHelpDialog] = useState(false);\n  const [showCreateTaskDialog, setShowCreateTaskDialog] = useState(false);\n  const [expandedTasks, setExpandedTasks] = useState<Set<number>>(new Set());\n  const { toast } = useToast();\n  const search = useSearch();\n  \n  // Generate dialog form state\n  const [playbookName, setPlaybookName] = useState(\"\");\n  const [generateSegment, setGenerateSegment] = useState<string>(\"all\");\n  const [topN, setTopN] = useState<number>(5);\n  const [selectedCategories, setSelectedCategories] = useState<string[]>([]);\n\n  // Create task dialog form state\n  const [newTaskTitle, setNewTaskTitle] = useState(\"\");\n  const [newTaskType, setNewTaskType] = useState<string>(\"call\");\n  const [newTaskDescription, setNewTaskDescription] = useState(\"\");\n  const [newTaskAccountId, setNewTaskAccountId] = useState<string>(\"\");\n  const [isCreatingTask, setIsCreatingTask] = useState(false);\n  \n  // Parse URL parameters for task auto-selection\n  const params = new URLSearchParams(search);\n  const taskIdFromUrl = params.get(\"task\");\n  const segmentFromUrl = params.get(\"segment\");\n\n  interface Account {\n    id: number;\n    name: string;\n    segment: string | null;\n  }\n\n  const { data: playbooks } = useQuery<Playbook[]>({\n    queryKey: [\"/api/playbooks\"],\n  });\n\n  const tasksQueryKey = selectedPlaybookId \n    ? `/api/tasks?playbookId=${selectedPlaybookId}`\n    : \"/api/tasks\";\n    \n  const { data: tasksResponse, isLoading } = useQuery<{ tasks: Task[]; pagination: { total: number; page: number; limit: number } }>({\n    queryKey: [tasksQueryKey],\n  });\n  \n  // Extract tasks array from response (handles new pagination format)\n  const tasks = tasksResponse?.tasks;\n\n  // Fetch custom categories for the dialog\n  const { data: customCategories } = useQuery<CustomCategory[]>({\n    queryKey: [\"/api/custom-categories\"],\n  });\n\n  // Fetch accounts for manual task creation\n  const { data: accounts } = useQuery<Account[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  // Seed default categories if none exist\n  useEffect(() => {\n    if (customCategories && customCategories.length === 0) {\n      apiRequest(\"POST\", \"/api/custom-categories/seed-defaults\").catch(console.error);\n    }\n  }, [customCategories]);\n\n  // Handle URL parameters for segment pre-fill\n  useEffect(() => {\n    if (segmentFromUrl) {\n      setGenerateSegment(segmentFromUrl);\n      setShowGenerateDialog(true);\n    }\n  }, [segmentFromUrl]);\n\n  // Use a guard to prevent repeated auto-selection\n  const [hasAutoSelected, setHasAutoSelected] = useState(false);\n\n  // Handle URL task auto-selection with memoized task\n  const taskToAutoSelect = useMemo(() => {\n    if (!taskIdFromUrl || !tasks || hasAutoSelected) return null;\n    const taskId = parseInt(taskIdFromUrl);\n    return tasks.find(t => t.id === taskId);\n  }, [taskIdFromUrl, tasks, hasAutoSelected]);\n\n  useEffect(() => {\n    if (taskToAutoSelect && !hasAutoSelected) {\n      setExpandedTasks(new Set([taskToAutoSelect.id]));\n      setHasAutoSelected(true);\n    }\n  }, [taskToAutoSelect, hasAutoSelected]);\n\n  // Mock data for demonstration\n  const mockTasks: Task[] = [\n    {\n      id: 1,\n      accountId: 1,\n      accountName: \"ABC Plumbing Co\",\n      assignedTm: \"John Smith\",\n      taskType: \"call\",\n      title: \"Introduce Water Heater Line\",\n      description: \"High-opportunity account missing water heater category\",\n      script: \"Hi [Contact Name], this is [Your Name] from ABC Supply...\",\n      gapCategories: [\"Water Heaters\"],\n      status: \"pending\",\n      dueDate: \"2026-01-25\",\n    },\n    {\n      id: 2,\n      accountId: 2,\n      accountName: \"Elite HVAC Services\",\n      assignedTm: \"Sarah Johnson\",\n      taskType: \"email\",\n      title: \"Cross-sell Controls & Thermostats\",\n      description: \"HVAC contractor with gap in controls category\",\n      script: \"Subject: Boost Your Efficiency with Smart Controls...\",\n      gapCategories: [\"Controls & Thermostats\"],\n      status: \"in_progress\",\n      dueDate: \"2026-01-26\",\n    },\n  ];\n\n  const mockPlaybooks: Playbook[] = [\n    {\n      id: 1,\n      name: \"Q1 Water Heater Campaign\",\n      generatedBy: \"AI\",\n      generatedAt: \"2026-01-15\",\n      taskCount: 25,\n      completedCount: 8,\n    },\n  ];\n\n  const displayTasks = tasks || mockTasks;\n  const displayPlaybooks = playbooks || mockPlaybooks;\n  \n  // Get active categories for the dialog\n  const activeCategories = customCategories?.filter(c => c.isActive) || [];\n  \n  // Default categories if none loaded\n  const defaultCategories = [\"Water Heaters\", \"Controls\", \"PVF\", \"Tools\", \"Chinaware\", \"Brass and Fittings\"];\n  const categoryOptions = activeCategories.length > 0 \n    ? activeCategories.map(c => c.name) \n    : defaultCategories;\n\n  const filteredTasks = displayTasks.filter((task) => {\n    const matchesSearch =\n      searchQuery === \"\" ||\n      task.title.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      task.accountName.toLowerCase().includes(searchQuery.toLowerCase());\n    const matchesStatus = statusFilter === \"all\" || task.status === statusFilter;\n    const matchesType = typeFilter === \"all\" || task.taskType === typeFilter;\n    return matchesSearch && matchesStatus && matchesType;\n  });\n\n  const toggleTaskExpanded = (taskId: number) => {\n    const newExpanded = new Set(expandedTasks);\n    if (newExpanded.has(taskId)) {\n      newExpanded.delete(taskId);\n    } else {\n      newExpanded.add(taskId);\n    }\n    setExpandedTasks(newExpanded);\n  };\n\n  const toggleCategory = (category: string) => {\n    setSelectedCategories(prev => {\n      if (prev.includes(category)) {\n        return prev.filter(c => c !== category);\n      } else {\n        return [...prev, category];\n      }\n    });\n  };\n\n  const handleGeneratePlaybook = async () => {\n    if (!playbookName.trim()) {\n      toast({\n        title: \"Name required\",\n        description: \"Please enter a playbook name\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsGenerating(true);\n    try {\n      const response = await apiRequest(\"POST\", \"/api/playbooks/generate\", {\n        name: playbookName,\n        segment: generateSegment === \"all\" ? undefined : generateSegment,\n        topN: topN,\n        priorityCategories: selectedCategories.length > 0 ? selectedCategories : undefined,\n      });\n\n      const data = await response.json();\n      \n      // Invalidate queries to refresh the data\n      queryClient.invalidateQueries({ queryKey: [\"/api/playbooks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      \n      setShowGenerateDialog(false);\n      setPlaybookName(\"\");\n      setSelectedCategories([]);\n      setGenerateSegment(\"all\");\n      setTopN(5);\n      \n      toast({\n        title: \"Playbook generated\",\n        description: `AI created ${data.tasksGenerated || 0} new tasks for \"${data.playbook?.name || playbookName}\"`,\n      });\n\n      // Auto-select the newly created playbook\n      if (data.playbook?.id) {\n        setSelectedPlaybookId(data.playbook.id);\n      }\n    } catch (error: any) {\n      console.error(\"Generate playbook error:\", error);\n      \n      const errorMessage = error.message || \"\";\n      const isLimitExceeded = errorMessage.includes(\"FEATURE_LIMIT_EXCEEDED\") || errorMessage.includes(\"limit\");\n      const isUpgradeRequired = errorMessage.includes(\"upgrade\") || errorMessage.includes(\"Upgrade\");\n      \n      if (isLimitExceeded || isUpgradeRequired) {\n        toast({\n          title: \"Upgrade Required\",\n          description: \"You've reached your playbook limit. Visit the Subscription page to upgrade.\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Generation failed\",\n          description: \"Failed to generate playbook. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    } finally {\n      setIsGenerating(false);\n    }\n  };\n\n  const handleCompleteTask = (task: Task) => {\n    setSelectedTask(task);\n  };\n\n  const handleCreateTask = async () => {\n    if (!newTaskTitle.trim() || !newTaskAccountId) {\n      toast({\n        title: \"Missing information\",\n        description: \"Please provide a task title and select an account\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsCreatingTask(true);\n    try {\n      await apiRequest(\"POST\", \"/api/tasks\", {\n        accountId: parseInt(newTaskAccountId),\n        playbookId: selectedPlaybookId,\n        taskType: newTaskType,\n        title: newTaskTitle,\n        description: newTaskDescription || undefined,\n        status: \"pending\",\n        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),\n      });\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [tasksQueryKey] });\n      \n      setShowCreateTaskDialog(false);\n      setNewTaskTitle(\"\");\n      setNewTaskType(\"call\");\n      setNewTaskDescription(\"\");\n      setNewTaskAccountId(\"\");\n\n      toast({\n        title: \"Task created\",\n        description: \"Manual task has been added to the playbook\",\n      });\n    } catch (error) {\n      console.error(\"Create task error:\", error);\n      toast({\n        title: \"Failed to create task\",\n        description: \"Please try again\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsCreatingTask(false);\n    }\n  };\n\n  const TaskIcon = ({ type }: { type: \"call\" | \"email\" | \"visit\" }) => {\n    const Icon = taskTypeIcons[type];\n    return <Icon className=\"h-4 w-4\" />;\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-playbooks\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Playbooks & Tasks</h1>\n          <p className=\"text-muted-foreground\">\n            AI-generated sales tasks and scripts for Territory Managers\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\" data-testid=\"button-export-tasks\">\n            <Download className=\"mr-2 h-4 w-4\" />\n            Export\n          </Button>\n          <Button onClick={() => setShowGenerateDialog(true)} data-testid=\"button-generate-playbook\">\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Generate Playbook\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary/10\">\n                  <ClipboardList className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{displayTasks.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Total Tasks</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-playbooks-total\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Total number of AI-generated sales tasks including calls, emails, and site visits.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-3/10\">\n                  <Clock className=\"h-5 w-5 text-chart-3\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {displayTasks.filter((t) => t.status === \"pending\").length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Pending</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-playbooks-pending\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Tasks waiting to be started by Territory Managers.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-1/10\">\n                  <User className=\"h-5 w-5 text-chart-1\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {displayTasks.filter((t) => t.status === \"in_progress\").length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">In Progress</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-playbooks-progress\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Tasks currently being worked on by Territory Managers.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-2/10\">\n                  <CheckCircle className=\"h-5 w-5 text-chart-2\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {displayTasks.filter((t) => t.status === \"completed\").length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Completed</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-playbooks-completed\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Successfully completed tasks with recorded outcomes.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n        {/* Left column - Playbooks list */}\n        <div className=\"lg:col-span-1 space-y-4\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-base\">Playbooks</CardTitle>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setShowHelpDialog(true)}\n                  data-testid=\"button-help\"\n                >\n                  <HelpCircle className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <div\n                onClick={() => setSelectedPlaybookId(null)}\n                className={`p-3 rounded-md border cursor-pointer transition-colors ${\n                  selectedPlaybookId === null\n                    ? \"bg-primary/10 border-primary\"\n                    : \"hover:bg-muted/50\"\n                }`}\n                data-testid=\"button-all-tasks\"\n              >\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"font-medium text-sm\">All Tasks</span>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {displayTasks.length}\n                  </Badge>\n                </div>\n              </div>\n              \n              {displayPlaybooks.length === 0 ? (\n                <div className=\"py-4 text-center text-sm text-muted-foreground\">\n                  <BookOpen className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                  <p>No playbooks yet</p>\n                  <p className=\"text-xs mt-1\">Click \"Generate Playbook\" to create one</p>\n                </div>\n              ) : (\n                displayPlaybooks.map((playbook) => (\n                  <div\n                    key={playbook.id}\n                    onClick={() => setSelectedPlaybookId(playbook.id)}\n                    className={`p-3 rounded-md border cursor-pointer transition-colors ${\n                      selectedPlaybookId === playbook.id\n                        ? \"bg-primary/10 border-primary\"\n                        : \"hover:bg-muted/50\"\n                    }`}\n                    data-testid={`playbook-item-${playbook.id}`}\n                  >\n                    <div className=\"flex items-center justify-between mb-1\">\n                      <span className=\"font-medium text-sm truncate\">{playbook.name}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                      <Calendar className=\"h-3 w-3\" />\n                      {playbook.generatedAt}\n                    </div>\n                    <div className=\"mt-2 flex items-center gap-2\">\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        {playbook.taskCount} tasks\n                      </Badge>\n                      {playbook.completedCount > 0 && (\n                        <Badge variant=\"outline\" className=\"text-xs bg-chart-2/10 text-chart-2 border-chart-2/20\">\n                          {playbook.completedCount} done\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n                ))\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Right column - Tasks */}\n        <div className=\"lg:col-span-3\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>\n                    {selectedPlaybookId \n                      ? displayPlaybooks.find(p => p.id === selectedPlaybookId)?.name || \"Tasks\"\n                      : \"All Tasks\"\n                    }\n                  </CardTitle>\n                  <CardDescription>\n                    {filteredTasks.length} task{filteredTasks.length !== 1 ? \"s\" : \"\"}\n                    {selectedPlaybookId && \" in this playbook\"}\n                  </CardDescription>\n                </div>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  {selectedPlaybookId && (\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\"\n                      onClick={() => setShowCreateTaskDialog(true)}\n                      data-testid=\"button-add-task\"\n                    >\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      Add Task\n                    </Button>\n                  )}\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Search tasks...\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      className=\"pl-9 w-48\"\n                      data-testid=\"input-search-tasks\"\n                    />\n                  </div>\n                  <Select value={statusFilter} onValueChange={setStatusFilter}>\n                    <SelectTrigger className=\"w-32\" data-testid=\"select-status-filter\">\n                      <SelectValue placeholder=\"Status\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Status</SelectItem>\n                      <SelectItem value=\"pending\">Pending</SelectItem>\n                      <SelectItem value=\"in_progress\">In Progress</SelectItem>\n                      <SelectItem value=\"completed\">Completed</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Select value={typeFilter} onValueChange={setTypeFilter}>\n                    <SelectTrigger className=\"w-32\" data-testid=\"select-type-filter\">\n                      <SelectValue placeholder=\"Type\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Types</SelectItem>\n                      <SelectItem value=\"call\">Call</SelectItem>\n                      <SelectItem value=\"email\">Email</SelectItem>\n                      <SelectItem value=\"visit\">Visit</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {isLoading ? (\n                <div className=\"space-y-3\">\n                  {[1, 2, 3].map((i) => (\n                    <div key={i} className=\"h-20 bg-muted/50 rounded-lg animate-pulse\" />\n                  ))}\n                </div>\n              ) : filteredTasks.length === 0 ? (\n                <EmptyState\n                  icon={ClipboardList}\n                  title=\"No tasks found\"\n                  description={selectedPlaybookId \n                    ? \"This playbook has no tasks yet\"\n                    : \"Generate a playbook to create AI-powered sales tasks\"\n                  }\n                  action={{\n                    label: \"Generate Playbook\",\n                    onClick: () => setShowGenerateDialog(true),\n                  }}\n                />\n              ) : (\n                filteredTasks.map((task) => (\n                  <Collapsible\n                    key={task.id}\n                    open={expandedTasks.has(task.id)}\n                    onOpenChange={() => toggleTaskExpanded(task.id)}\n                  >\n                    <div\n                      className={`border rounded-lg transition-colors ${\n                        expandedTasks.has(task.id) ? \"border-primary/50\" : \"\"\n                      }`}\n                      data-testid={`task-item-${task.id}`}\n                    >\n                      <CollapsibleTrigger className=\"w-full\">\n                        <div className=\"flex items-center gap-4 p-4 hover:bg-muted/50 transition-colors cursor-pointer\">\n                          <div\n                            className={`flex h-10 w-10 items-center justify-center rounded-md ${\n                              task.taskType === \"call\"\n                                ? \"bg-chart-1/10 text-chart-1\"\n                                : task.taskType === \"email\"\n                                ? \"bg-chart-4/10 text-chart-4\"\n                                : \"bg-chart-5/10 text-chart-5\"\n                            }`}\n                          >\n                            <TaskIcon type={task.taskType} />\n                          </div>\n                          <div className=\"flex-1 text-left\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-medium\">{task.title}</span>\n                              <Badge variant=\"outline\" className={statusColors[task.status]}>\n                                {task.status.replace(\"_\", \" \")}\n                              </Badge>\n                            </div>\n                            <div className=\"flex items-center gap-3 mt-1 text-sm text-muted-foreground\">\n                              <span>{task.accountName}</span>\n                              <span className=\"text-muted-foreground/50\">â€¢</span>\n                              <span className=\"flex items-center gap-1\">\n                                <Calendar className=\"h-3 w-3\" />\n                                {new Date(task.dueDate).toLocaleDateString()}\n                              </span>\n                              {task.assignedTm && (\n                                <>\n                                  <span className=\"text-muted-foreground/50\">â€¢</span>\n                                  <span className=\"flex items-center gap-1\">\n                                    <User className=\"h-3 w-3\" />\n                                    {task.assignedTm}\n                                  </span>\n                                </>\n                              )}\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            {task.gapCategories?.slice(0, 2).map((cat) => (\n                              <Badge key={cat} variant=\"secondary\" className=\"text-xs\">\n                                {cat}\n                              </Badge>\n                            ))}\n                            {expandedTasks.has(task.id) ? (\n                              <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                            ) : (\n                              <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                            )}\n                          </div>\n                        </div>\n                      </CollapsibleTrigger>\n                      <CollapsibleContent>\n                        <div className=\"px-4 pb-4 pt-2 border-t bg-muted/30\">\n                          <div className=\"space-y-4\">\n                            <div>\n                              <h4 className=\"font-medium text-sm mb-2 flex items-center gap-2\">\n                                <MessageSquare className=\"h-4 w-4\" />\n                                {task.taskType === \"email\" ? \"Email Template\" : \"Call Script\"}\n                              </h4>\n                              <div className=\"bg-background rounded-md p-3 text-sm whitespace-pre-wrap border\">\n                                {task.script || task.description}\n                              </div>\n                            </div>\n                            {task.status !== \"completed\" && (\n                              <div className=\"flex gap-2\">\n                                {task.taskType === \"email\" && (task.script || task.description) && (\n                                  <Button\n                                    size=\"sm\"\n                                    variant=\"default\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      const emailBody = task.script || task.description || \"\";\n                                      const subject = task.title || \"\";\n                                      navigator.clipboard.writeText(emailBody).catch(() => {});\n                                      const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;\n                                      window.open(mailto, \"_blank\");\n                                      toast({\n                                        title: \"Email content copied\",\n                                        description: \"The email template has been copied to your clipboard and your email client is opening.\",\n                                      });\n                                    }}\n                                    data-testid={`button-send-email-${task.id}`}\n                                  >\n                                    <ExternalLink className=\"mr-2 h-4 w-4\" />\n                                    Send from Email\n                                  </Button>\n                                )}\n                                <Button\n                                  size=\"sm\"\n                                  variant={task.taskType === \"email\" ? \"outline\" : \"default\"}\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    handleCompleteTask(task);\n                                  }}\n                                  data-testid={`button-complete-${task.id}`}\n                                >\n                                  <CheckCircle className=\"mr-2 h-4 w-4\" />\n                                  Mark Complete\n                                </Button>\n                                <Button variant=\"outline\" size=\"sm\">\n                                  Skip Task\n                                </Button>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </CollapsibleContent>\n                    </div>\n                  </Collapsible>\n                ))\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Generate Playbook Dialog */}\n      <Dialog open={showGenerateDialog} onOpenChange={setShowGenerateDialog}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Sparkles className=\"h-5 w-5\" />\n              Generate Playbook\n            </DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Playbook Name</Label>\n              <Input \n                placeholder=\"e.g., Q1 Water Heater Campaign\" \n                value={playbookName}\n                onChange={(e) => setPlaybookName(e.target.value)}\n                data-testid=\"input-playbook-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Target Segment</Label>\n              <Select value={generateSegment} onValueChange={setGenerateSegment}>\n                <SelectTrigger data-testid=\"select-segment\">\n                  <SelectValue placeholder=\"Select segment\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Segments</SelectItem>\n                  <SelectItem value=\"HVAC\">HVAC</SelectItem>\n                  <SelectItem value=\"Plumbing\">Plumbing</SelectItem>\n                  <SelectItem value=\"Mechanical\">Mechanical</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Top N Accounts</Label>\n              <Input \n                type=\"number\" \n                placeholder=\"5\" \n                value={topN}\n                onChange={(e) => setTopN(parseInt(e.target.value) || 5)}\n                min={1}\n                max={100}\n                data-testid=\"input-top-n\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Priority Categories</Label>\n              <p className=\"text-xs text-muted-foreground mb-2\">\n                Click to select categories to focus on (optional)\n              </p>\n              <div className=\"flex flex-wrap gap-2\">\n                {categoryOptions.map((cat) => (\n                  <Badge\n                    key={cat}\n                    variant={selectedCategories.includes(cat) ? \"default\" : \"outline\"}\n                    className=\"cursor-pointer transition-colors\"\n                    onClick={() => toggleCategory(cat)}\n                    data-testid={`category-${cat.replace(/\\s+/g, '-').toLowerCase()}`}\n                  >\n                    {cat}\n                    {selectedCategories.includes(cat) && (\n                      <CheckCircle className=\"ml-1 h-3 w-3\" />\n                    )}\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowGenerateDialog(false)}>\n              Cancel\n            </Button>\n            <Button onClick={handleGeneratePlaybook} disabled={isGenerating}>\n              {isGenerating ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Generating...\n                </>\n              ) : (\n                <>\n                  <Sparkles className=\"mr-2 h-4 w-4\" />\n                  Generate\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Help Dialog */}\n      <Dialog open={showHelpDialog} onOpenChange={setShowHelpDialog}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <BookOpen className=\"h-5 w-5\" />\n              How to Generate Playbooks\n            </DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-3\">\n              <div className=\"flex gap-3\">\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium\">\n                  1\n                </div>\n                <div>\n                  <p className=\"font-medium\">Approve an ICP Profile</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Navigate to ICP Builder and approve at least one segment profile. This defines the ideal category mix for each customer type.\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex gap-3\">\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium\">\n                  2\n                </div>\n                <div>\n                  <p className=\"font-medium\">Click \"Generate Playbook\"</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Choose a target segment, select priority categories to focus on, and specify how many top accounts to include.\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex gap-3\">\n                <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-primary text-primary-foreground text-sm font-medium\">\n                  3\n                </div>\n                <div>\n                  <p className=\"font-medium\">AI Generates Tasks</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    The AI analyzes account gaps against ICP targets and creates personalized call scripts, email templates, and visit plans for each opportunity.\n                  </p>\n                </div>\n              </div>\n            </div>\n            <div className=\"rounded-lg bg-muted/50 p-4\">\n              <div className=\"flex items-start gap-2\">\n                <Info className=\"h-4 w-4 mt-0.5 text-muted-foreground\" />\n                <p className=\"text-sm text-muted-foreground\">\n                  Playbooks are organized collections of tasks. Each playbook targets specific segments and categories, making it easy to track campaign progress and measure results.\n                </p>\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button onClick={() => setShowHelpDialog(false)}>Got it</Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Complete Task Dialog */}\n      <Dialog open={!!selectedTask} onOpenChange={() => setSelectedTask(null)}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Log Task Outcome</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Outcome</Label>\n              <Textarea\n                placeholder=\"Describe the outcome of this task...\"\n                rows={4}\n              />\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Checkbox id=\"follow-up\" />\n              <Label htmlFor=\"follow-up\" className=\"text-sm\">\n                Create follow-up task\n              </Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setSelectedTask(null)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                setSelectedTask(null);\n                toast({\n                  title: \"Task completed\",\n                  description: \"Outcome has been logged\",\n                });\n              }}\n            >\n              <CheckCircle className=\"mr-2 h-4 w-4\" />\n              Complete Task\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Create Task Dialog */}\n      <Dialog open={showCreateTaskDialog} onOpenChange={(open) => {\n        setShowCreateTaskDialog(open);\n        if (!open) {\n          setNewTaskTitle(\"\");\n          setNewTaskType(\"call\");\n          setNewTaskDescription(\"\");\n          setNewTaskAccountId(\"\");\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Add Task to Playbook</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Account</Label>\n              <Select value={newTaskAccountId} onValueChange={setNewTaskAccountId}>\n                <SelectTrigger data-testid=\"select-task-account\">\n                  <SelectValue placeholder=\"Select an account\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {accounts?.map(account => (\n                    <SelectItem key={account.id} value={account.id.toString()}>\n                      {account.name} {account.segment && `(${account.segment})`}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Task Type</Label>\n              <Select value={newTaskType} onValueChange={setNewTaskType}>\n                <SelectTrigger data-testid=\"select-new-task-type\">\n                  <SelectValue placeholder=\"Select type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"call\">Call</SelectItem>\n                  <SelectItem value=\"email\">Email</SelectItem>\n                  <SelectItem value=\"visit\">Site Visit</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Task Title</Label>\n              <Input \n                placeholder=\"e.g., Follow up on water heater quote\" \n                value={newTaskTitle}\n                onChange={(e) => setNewTaskTitle(e.target.value)}\n                data-testid=\"input-new-task-title\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Description (optional)</Label>\n              <Textarea \n                placeholder=\"Additional details about this task...\"\n                value={newTaskDescription}\n                onChange={(e) => setNewTaskDescription(e.target.value)}\n                rows={3}\n                data-testid=\"input-new-task-description\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowCreateTaskDialog(false)} disabled={isCreatingTask}>\n              Cancel\n            </Button>\n            <Button onClick={handleCreateTask} disabled={isCreatingTask || !newTaskTitle.trim() || !newTaskAccountId}>\n              {isCreatingTask ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Creating...\n                </>\n              ) : (\n                <>\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Add Task\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":44047,"size_tokens":null},"client/src/pages/data-uploads.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DataTable } from \"@/components/data-table\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Upload,\n  FileText,\n  CheckCircle,\n  XCircle,\n  Clock,\n  Download,\n  Users,\n  Package,\n  FolderTree,\n  ShoppingCart,\n  HelpCircle,\n} from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface DataUpload {\n  id: number;\n  uploadType: string;\n  fileName: string;\n  rowCount: number | null;\n  status: string;\n  errorMessage: string | null;\n  uploadedBy: string | null;\n  uploadedAt: string;\n}\n\nconst uploadTypes = [\n  {\n    id: \"accounts\",\n    label: \"Accounts\",\n    description: \"Customer accounts with segment and TM assignment\",\n    icon: Users,\n    fields: [\"id\", \"name\", \"segment\", \"region\", \"assigned_tm\", \"status\"],\n  },\n  {\n    id: \"products\",\n    label: \"Products\",\n    description: \"Product catalog with SKUs and categories\",\n    icon: Package,\n    fields: [\"sku\", \"name\", \"category_id\", \"unit_cost\", \"unit_price\"],\n  },\n  {\n    id: \"categories\",\n    label: \"Product Categories\",\n    description: \"Hierarchical product category taxonomy\",\n    icon: FolderTree,\n    fields: [\"id\", \"name\", \"parent_id\"],\n  },\n  {\n    id: \"orders\",\n    label: \"Orders\",\n    description: \"Historical order data with line items\",\n    icon: ShoppingCart,\n    fields: [\"id\", \"account_id\", \"order_date\", \"total_amount\", \"margin_amount\"],\n  },\n];\n\nexport default function DataUploads() {\n  const [selectedType, setSelectedType] = useState<string>(\"\");\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [isDragging, setIsDragging] = useState(false);\n  const { toast } = useToast();\n\n  const { data: uploads, isLoading } = useQuery<DataUpload[]>({\n    queryKey: [\"/api/data-uploads\"],\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      const response = await fetch(\"/api/data-uploads\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Upload failed\");\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/data-uploads\"] });\n      setIsDialogOpen(false);\n      setSelectedType(\"\");\n      setUploadProgress(0);\n      toast({\n        title: \"Upload successful\",\n        description: \"Your data is being processed.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Upload failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setUploadProgress(0);\n    },\n  });\n\n  const handleFileChange = useCallback(\n    (event: React.ChangeEvent<HTMLInputElement>) => {\n      const file = event.target.files?.[0];\n      if (file && selectedType) {\n        const formData = new FormData();\n        formData.append(\"file\", file);\n        formData.append(\"type\", selectedType);\n        setUploadProgress(50);\n        uploadMutation.mutate(formData);\n      }\n    },\n    [selectedType, uploadMutation]\n  );\n\n  const handleDrop = useCallback(\n    (event: React.DragEvent) => {\n      event.preventDefault();\n      setIsDragging(false);\n      const file = event.dataTransfer.files?.[0];\n      if (file && selectedType) {\n        const formData = new FormData();\n        formData.append(\"file\", file);\n        formData.append(\"type\", selectedType);\n        setUploadProgress(50);\n        uploadMutation.mutate(formData);\n      }\n    },\n    [selectedType, uploadMutation]\n  );\n\n  const columns = [\n    {\n      key: \"uploadType\",\n      header: \"Type\",\n      cell: (row: DataUpload) => {\n        const typeInfo = uploadTypes.find((t) => t.id === row.uploadType);\n        const Icon = typeInfo?.icon || FileText;\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Icon className=\"h-4 w-4 text-muted-foreground\" />\n            <span className=\"capitalize\">{row.uploadType}</span>\n          </div>\n        );\n      },\n    },\n    {\n      key: \"fileName\",\n      header: \"File Name\",\n      cell: (row: DataUpload) => (\n        <span className=\"font-medium\">{row.fileName}</span>\n      ),\n    },\n    {\n      key: \"rowCount\",\n      header: \"Rows\",\n      cell: (row: DataUpload) => (\n        <span>{row.rowCount?.toLocaleString() || \"-\"}</span>\n      ),\n    },\n    {\n      key: \"status\",\n      header: \"Status\",\n      cell: (row: DataUpload) => {\n        const statusConfig: Record<\n          string,\n          { icon: typeof CheckCircle; className: string }\n        > = {\n          completed: { icon: CheckCircle, className: \"text-chart-2\" },\n          processing: { icon: Clock, className: \"text-chart-3\" },\n          failed: { icon: XCircle, className: \"text-destructive\" },\n        };\n        const config = statusConfig[row.status] || statusConfig.processing;\n        const Icon = config.icon;\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Icon className={`h-4 w-4 ${config.className}`} />\n            <span className=\"capitalize\">{row.status}</span>\n          </div>\n        );\n      },\n    },\n    {\n      key: \"uploadedAt\",\n      header: \"Uploaded\",\n      cell: (row: DataUpload) => (\n        <span className=\"text-muted-foreground\">\n          {new Date(row.uploadedAt).toLocaleDateString()}\n        </span>\n      ),\n    },\n  ];\n\n  // Mock data for demonstration\n  const mockUploads: DataUpload[] = [\n    {\n      id: 1,\n      uploadType: \"accounts\",\n      fileName: \"accounts_2024.csv\",\n      rowCount: 487,\n      status: \"completed\",\n      errorMessage: null,\n      uploadedBy: \"Graham\",\n      uploadedAt: \"2024-01-15T10:30:00Z\",\n    },\n    {\n      id: 2,\n      uploadType: \"orders\",\n      fileName: \"orders_q4_2023.csv\",\n      rowCount: 15234,\n      status: \"completed\",\n      errorMessage: null,\n      uploadedBy: \"Graham\",\n      uploadedAt: \"2024-01-14T09:15:00Z\",\n    },\n    {\n      id: 3,\n      uploadType: \"products\",\n      fileName: \"product_catalog.csv\",\n      rowCount: 2341,\n      status: \"completed\",\n      errorMessage: null,\n      uploadedBy: \"Graham\",\n      uploadedAt: \"2024-01-10T14:45:00Z\",\n    },\n    {\n      id: 4,\n      uploadType: \"categories\",\n      fileName: \"categories.csv\",\n      rowCount: 156,\n      status: \"completed\",\n      errorMessage: null,\n      uploadedBy: \"Graham\",\n      uploadedAt: \"2024-01-10T14:30:00Z\",\n    },\n  ];\n\n  const displayUploads = uploads || mockUploads;\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-data-uploads\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Data Uploads</h1>\n          <p className=\"text-muted-foreground\">\n            Import and manage your sales data from CSV files\n          </p>\n        </div>\n        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-upload-data\">\n              <Upload className=\"mr-2 h-4 w-4\" />\n              Upload Data\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"sm:max-w-lg\">\n            <DialogHeader>\n              <DialogTitle>Upload Data</DialogTitle>\n              <DialogDescription>\n                Select the data type and upload a CSV file\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">Data Type</label>\n                <Select value={selectedType} onValueChange={setSelectedType}>\n                  <SelectTrigger data-testid=\"select-upload-type\">\n                    <SelectValue placeholder=\"Select data type\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {uploadTypes.map((type) => (\n                      <SelectItem key={type.id} value={type.id}>\n                        <div className=\"flex items-center gap-2\">\n                          <type.icon className=\"h-4 w-4\" />\n                          {type.label}\n                        </div>\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {selectedType && (\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm font-medium\">Expected Fields</label>\n                  <div className=\"flex flex-wrap gap-1\">\n                    {uploadTypes\n                      .find((t) => t.id === selectedType)\n                      ?.fields.map((field) => (\n                        <Badge key={field} variant=\"secondary\" className=\"text-xs\">\n                          {field}\n                        </Badge>\n                      ))}\n                  </div>\n                </div>\n              )}\n\n              <div\n                className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${\n                  isDragging\n                    ? \"border-primary bg-primary/5\"\n                    : \"border-muted-foreground/25\"\n                } ${!selectedType && \"opacity-50 pointer-events-none\"}`}\n                onDragOver={(e) => {\n                  e.preventDefault();\n                  setIsDragging(true);\n                }}\n                onDragLeave={() => setIsDragging(false)}\n                onDrop={handleDrop}\n              >\n                <input\n                  type=\"file\"\n                  accept=\".csv\"\n                  onChange={handleFileChange}\n                  className=\"hidden\"\n                  id=\"file-upload\"\n                  disabled={!selectedType || uploadMutation.isPending}\n                />\n                <label\n                  htmlFor=\"file-upload\"\n                  className=\"cursor-pointer flex flex-col items-center gap-2\"\n                >\n                  <Upload className=\"h-8 w-8 text-muted-foreground\" />\n                  <div>\n                    <span className=\"text-primary font-medium\">Click to upload</span>\n                    <span className=\"text-muted-foreground\"> or drag and drop</span>\n                  </div>\n                  <span className=\"text-xs text-muted-foreground\">CSV files only</span>\n                </label>\n              </div>\n\n              {uploadMutation.isPending && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span>Uploading...</span>\n                    <span>{uploadProgress}%</span>\n                  </div>\n                  <Progress value={uploadProgress} />\n                </div>\n              )}\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        {uploadTypes.map((type) => {\n          const latestUpload = displayUploads.find((u) => u.uploadType === type.id);\n          const tooltips: Record<string, string> = {\n            accounts: \"Customer account data including segment classification, region, and Territory Manager assignments. This is the foundation for gap analysis.\",\n            products: \"Product catalog with SKUs, categories, and pricing. Used to map orders to categories for penetration analysis.\",\n            categories: \"Product category taxonomy that defines how products are grouped. Categories are used for ICP profile expectations.\",\n            orders: \"Historical order data that powers the gap analysis. Order patterns are compared against ICP profiles to identify opportunities.\",\n          };\n          return (\n            <Card key={type.id}>\n              <CardHeader className=\"pb-2\">\n                <div className=\"flex items-center justify-between\">\n                  <type.icon className=\"h-5 w-5 text-muted-foreground\" />\n                  <div className=\"flex items-center gap-2\">\n                    {latestUpload?.status === \"completed\" && (\n                      <CheckCircle className=\"h-4 w-4 text-chart-2\" />\n                    )}\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid={`tooltip-upload-${type.id}`}>\n                          <HelpCircle className=\"h-4 w-4\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent className=\"max-w-xs\">\n                        <p className=\"text-sm\">{tooltips[type.id]}</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                </div>\n                <CardTitle className=\"text-base mt-2\">{type.label}</CardTitle>\n                <CardDescription className=\"text-xs\">\n                  {type.description}\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {latestUpload ? (\n                  <div className=\"text-sm\">\n                    <span className=\"text-muted-foreground\">Last upload: </span>\n                    <span>\n                      {latestUpload.rowCount?.toLocaleString()} rows\n                    </span>\n                  </div>\n                ) : (\n                  <span className=\"text-sm text-muted-foreground\">No data uploaded</span>\n                )}\n              </CardContent>\n            </Card>\n          );\n        })}\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Upload History</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {displayUploads.length === 0 ? (\n            <EmptyState\n              icon={Upload}\n              title=\"No uploads yet\"\n              description=\"Upload your first CSV file to get started with account analysis\"\n              action={{\n                label: \"Upload Data\",\n                onClick: () => setIsDialogOpen(true),\n              }}\n              testId=\"empty-uploads\"\n            />\n          ) : (\n            <DataTable\n              columns={columns}\n              data={displayUploads}\n              isLoading={isLoading}\n              testId=\"table-uploads\"\n            />\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Download className=\"h-4 w-4\" />\n            Download Templates\n          </CardTitle>\n          <CardDescription>\n            Use these templates to format your data correctly\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3\">\n            {uploadTypes.map((type) => (\n              <Button\n                key={type.id}\n                variant=\"outline\"\n                className=\"justify-start\"\n                data-testid={`button-download-${type.id}-template`}\n                onClick={() => {\n                  const link = document.createElement(\"a\");\n                  link.href = `/api/templates/${type.id}`;\n                  link.download = `${type.id}_template.csv`;\n                  document.body.appendChild(link);\n                  link.click();\n                  document.body.removeChild(link);\n                }}\n              >\n                <FileText className=\"mr-2 h-4 w-4\" />\n                {type.label} Template\n              </Button>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":16325,"size_tokens":null},"server/replit_integrations/auth/replitAuth.ts":{"content":"import * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\n\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport rateLimit from \"express-rate-limit\";\nimport { authStorage } from \"./storage\";\n\nexport const authRateLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 10, // 10 attempts per window\n  standardHeaders: true,\n  legacyHeaders: false,\n  message: { message: \"Too many authentication attempts, please try again later\" },\n  skipSuccessfulRequests: false,\n});\n\nexport const logoutRateLimiter = rateLimit({\n  windowMs: 1 * 60 * 1000, // 1 minute\n  max: 5, // 5 logout attempts per minute\n  standardHeaders: true,\n  legacyHeaders: false,\n  message: { message: \"Too many logout attempts, please try again later\" },\n});\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: true,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await authStorage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", authRateLimiter, (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", authRateLimiter, (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", logoutRateLimiter, (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":5120,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useState, useEffect, useCallback, DragEvent, useMemo } from \"react\";\nimport { DailyBriefingCard } from \"@/components/daily-briefing-card\";\nimport { AccountDossierPanel } from \"@/components/account-dossier-panel\";\n\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { KPICard } from \"@/components/kpi-card\";\nimport { DataTable } from \"@/components/data-table\";\nimport { ScoreBadge } from \"@/components/score-badge\";\nimport { ProgressRing } from \"@/components/progress-ring\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { InfoTooltip } from \"@/components/info-tooltip\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuCheckboxItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  DollarSign,\n  Users,\n  Target,\n  TrendingUp,\n  AlertCircle,\n  ArrowRight,\n  BarChart3,\n  Focus,\n  Phone,\n  Mail,\n  MapPin,\n  Clock,\n  ChevronRight,\n  CheckCircle2,\n  Upload,\n  Sparkles,\n  RotateCcw,\n  ChevronDown,\n  ChevronUp,\n  Lock,\n  Unlock,\n  Move,\n  Maximize2,\n  RectangleHorizontal,\n  RectangleVertical,\n  GraduationCap,\n  Trophy,\n  ArrowUpDown,\n  ArrowUp,\n  ArrowDown,\n  Settings2,\n  Columns,\n  Eye,\n  EyeOff,\n  CreditCard,\n} from \"lucide-react\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { Link, useLocation } from \"wouter\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip as RechartsTooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n} from \"recharts\";\nimport \"react-grid-layout/css/styles.css\";\n\ninterface DashboardStats {\n  totalAccounts: number;\n  enrolledAccounts: number;\n  totalRevenue: number;\n  incrementalRevenue: number;\n  topOpportunities: AccountWithMetrics[];\n  recentTasks: Array<{\n    id: number;\n    accountId: number;\n    playbookId: number | null;\n    accountName: string;\n    taskType: string;\n    title: string;\n    status: string;\n    dueDate: string;\n  }>;\n  segmentBreakdown: Array<{\n    segment: string;\n    count: number;\n    revenue: number;\n  }>;\n  icpProfiles: Array<{\n    segment: string;\n    status: string;\n    accountCount: number;\n  }>;\n}\n\ninterface AccountWithMetrics {\n  id: number;\n  name: string;\n  segment: string;\n  region: string;\n  assignedTm: string;\n  status: string;\n  last12mRevenue: number;\n  categoryPenetration: number;\n  opportunityScore: number;\n  gapCategories: Array<{\n    name: string;\n    gapPct: number;\n    estimatedValue: number;\n  }>;\n  enrolled: boolean;\n}\n\ninterface EnrolledAccount {\n  id: number;\n  accountId: number;\n  accountName: string;\n  segment: string;\n  enrolledAt: string;\n  baselineRevenue: number;\n  currentRevenue: number;\n  incrementalRevenue: number;\n  shareRate: number;\n  status: \"active\" | \"paused\" | \"graduated\";\n}\n\ntype OpportunitySortKey = \"opportunityScore\" | \"name\" | \"segment\" | \"region\" | \"last12mRevenue\" | \"categoryPenetration\" | \"enrolled\";\ntype SortDirection = \"asc\" | \"desc\";\n\nconst OPPORTUNITY_COLUMNS_STORAGE_KEY = \"dashboard_opportunity_columns\";\n\nconst ALL_OPPORTUNITY_COLUMNS = [\n  { key: \"name\", label: \"Account\", default: true },\n  { key: \"segment\", label: \"Segment\", default: true },\n  { key: \"region\", label: \"Region\", default: false },\n  { key: \"last12mRevenue\", label: \"Revenue (12M)\", default: false },\n  { key: \"categoryPenetration\", label: \"Penetration\", default: false },\n  { key: \"opportunityScore\", label: \"Score\", default: true },\n  { key: \"enrolled\", label: \"Status\", default: true },\n] as const;\n\ninterface GraduationReadyData {\n  count: number;\n  accounts: Array<{\n    programAccountId: number;\n    accountId: number;\n    accountName: string;\n    enrolledAt: string;\n    objectivesMet: { penetration: boolean; revenue: boolean; duration: boolean };\n  }>;\n}\n\ninterface GraduationAnalyticsData {\n  totalGraduated: number;\n  cumulativeRevenueGrowth: number; // Sum of incremental revenue across all graduated accounts\n  avgDaysToGraduation: number;\n  avgRevenueGrowth: number; // Average incremental revenue per account\n  avgIcpCategorySuccessRate: number; // % of ICP gaps filled\n  graduatedAccounts: Array<{\n    id: number;\n    accountId: number;\n    accountName: string;\n    segment: string | null;\n    enrolledAt: string;\n    graduatedAt: string | null;\n    baselineRevenue: number;\n    graduationRevenue: number; // Cumulative revenue during enrollment\n    revenueGrowth: number; // Incremental revenue = graduationRevenue - proRatedBaseline\n    enrollmentDurationDays: number | null;\n    icpCategoriesAtEnrollment: number | null; // ICP gaps at enrollment\n    icpCategoriesAchieved: number | null; // ICP gaps filled\n    icpSuccessRate: number; // % of gaps filled\n    graduationPenetration: number | null;\n  }>;\n}\n\ninterface DailyFocusData {\n  todayCount: number;\n  overdueCount: number;\n  tasks: Array<{\n    id: number;\n    accountId: number;\n    accountName: string;\n    assignedTm: string;\n    taskType: \"call\" | \"email\" | \"visit\";\n    title: string;\n    description: string;\n    status: string;\n    dueDate: string;\n    isOverdue: boolean;\n    gapCategories: string[];\n  }>;\n}\n\nconst taskTypeIcons = {\n  call: Phone,\n  email: Mail,\n  visit: MapPin,\n};\n\nconst CHART_COLORS = [\n  \"hsl(var(--chart-1))\",\n  \"hsl(var(--chart-2))\",\n  \"hsl(var(--chart-3))\",\n  \"hsl(var(--chart-4))\",\n  \"hsl(var(--chart-5))\",\n];\n\nfunction formatCurrency(value: number): string {\n  if (value >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (value >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\nconst LAYOUT_STORAGE_KEY = \"dashboard_grid_layout\";\nconst COLLAPSED_BLOCKS_KEY = \"dashboard_collapsed_blocks\";\nconst LAYOUT_LOCKED_KEY = \"dashboard_layout_locked\";\n\nconst GRID_COLS = 12;\nconst ROW_HEIGHT = 80;\n\ntype WidthPreset = 3 | 4 | 6 | 8 | 9 | 12;\ntype HeightPreset = 'compact' | 'standard' | 'tall' | 'auto';\n\nconst WIDTH_OPTIONS: { value: WidthPreset; label: string; icon: string }[] = [\n  { value: 3, label: 'Quarter', icon: 'â–¢' },\n  { value: 4, label: 'Third', icon: 'â–¢â–¢' },\n  { value: 6, label: 'Half', icon: 'â–¢â–¢â–¢' },\n  { value: 8, label: 'Two-thirds', icon: 'â–¢â–¢â–¢â–¢' },\n  { value: 9, label: '3/4', icon: 'â–¢â–¢â–¢â–¢â–¢' },\n  { value: 12, label: 'Full', icon: 'â–¢â–¢â–¢â–¢â–¢â–¢' },\n];\n\nconst HEIGHT_OPTIONS: { value: HeightPreset; label: string; pixels: string }[] = [\n  { value: 'compact', label: 'Compact', pixels: '180px' },\n  { value: 'standard', label: 'Standard', pixels: '300px' },\n  { value: 'tall', label: 'Tall', pixels: '420px' },\n  { value: 'auto', label: 'Auto', pixels: 'auto' },\n];\n\nconst HEIGHT_CLASSES: Record<HeightPreset, string> = {\n  compact: 'h-[180px]',\n  standard: 'h-[300px]',\n  tall: 'h-[420px]',\n  auto: 'h-auto min-h-[180px]',\n};\n\ninterface LayoutItem {\n  i: string;\n  x: number;\n  y: number;\n  w: WidthPreset;\n  h: number;\n  heightPreset: HeightPreset;\n  minW?: number;\n  minH?: number;\n  maxW?: number;\n  maxH?: number;\n}\n\nconst DEFAULT_LAYOUT: LayoutItem[] = [\n  { i: \"daily-focus\", x: 0, y: 0, w: 12, h: 4, heightPreset: 'standard', minW: 6, minH: 3 },\n  { i: \"top-opportunities\", x: 0, y: 4, w: 6, h: 5, heightPreset: 'tall', minW: 4, minH: 4 },\n  { i: \"segment-breakdown\", x: 6, y: 4, w: 6, h: 5, heightPreset: 'standard', minW: 3, minH: 4 },\n  { i: \"recent-tasks\", x: 0, y: 9, w: 4, h: 5, heightPreset: 'tall', minW: 3, minH: 4 },\n  { i: \"icp-profiles\", x: 4, y: 9, w: 8, h: 5, heightPreset: 'standard', minW: 3, minH: 4 },\n  { i: \"revenue-chart\", x: 0, y: 14, w: 12, h: 5, heightPreset: 'tall', minW: 4, minH: 4 },\n];\n\nconst BLOCK_LABELS: Record<string, string> = {\n  \"daily-focus\": \"Daily Focus\",\n  \"top-opportunities\": \"Top Opportunities\",\n  \"segment-breakdown\": \"Segment Breakdown\",\n  \"recent-tasks\": \"Recent Tasks\",\n  \"icp-profiles\": \"ICP Profiles\",\n  \"revenue-chart\": \"Revenue Chart\",\n};\n\nexport default function Dashboard() {\n  const [, navigate] = useLocation();\n  const [dossierAccountId, setDossierAccountId] = useState<number | null>(null);\n  const [layout, setLayout] = useState<LayoutItem[]>(DEFAULT_LAYOUT);\n  const [collapsedBlocks, setCollapsedBlocks] = useState<Set<string>>(new Set());\n  const [isLayoutLocked, setIsLayoutLocked] = useState(false);\n  const [draggedId, setDraggedId] = useState<string | null>(null);\n  const [dragOverId, setDragOverId] = useState<string | null>(null);\n\n  // Opportunity table sorting state (default: score descending)\n  const [opportunitySortKey, setOpportunitySortKey] = useState<OpportunitySortKey>(\"opportunityScore\");\n  const [opportunitySortDir, setOpportunitySortDir] = useState<SortDirection>(\"desc\");\n\n  // Column visibility state for opportunity table\n  const [visibleColumns, setVisibleColumns] = useState<Set<string>>(() => {\n    // Initialize with defaults first (SSR-safe)\n    return new Set(\n      ALL_OPPORTUNITY_COLUMNS.filter((col) => col.default).map((col) => col.key)\n    );\n  });\n\n  // Load saved column visibility from localStorage on mount\n  useEffect(() => {\n    const saved = localStorage.getItem(OPPORTUNITY_COLUMNS_STORAGE_KEY);\n    if (saved) {\n      try {\n        const parsed = JSON.parse(saved);\n        if (Array.isArray(parsed)) {\n          setVisibleColumns(new Set(parsed));\n        }\n      } catch (e) {\n        console.error(\"Failed to parse saved column visibility\");\n      }\n    }\n  }, []);\n\n  useEffect(() => {\n    const savedLayout = localStorage.getItem(LAYOUT_STORAGE_KEY);\n    if (savedLayout) {\n      try {\n        const parsed = JSON.parse(savedLayout);\n        if (Array.isArray(parsed) && parsed.length === DEFAULT_LAYOUT.length) {\n          const migratedLayout = parsed.map((item: LayoutItem, index: number) => ({\n            ...item,\n            heightPreset: item.heightPreset ?? DEFAULT_LAYOUT[index]?.heightPreset ?? 'standard',\n          }));\n          setLayout(migratedLayout);\n          if (parsed.some((item: LayoutItem) => !item.heightPreset)) {\n            localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(migratedLayout));\n          }\n        }\n      } catch (e) {\n        console.error(\"Failed to parse saved layout\");\n      }\n    }\n\n    const savedCollapsed = localStorage.getItem(COLLAPSED_BLOCKS_KEY);\n    if (savedCollapsed) {\n      try {\n        const parsed = JSON.parse(savedCollapsed);\n        if (Array.isArray(parsed)) {\n          setCollapsedBlocks(new Set(parsed));\n        }\n      } catch (e) {\n        console.error(\"Failed to parse saved collapsed blocks\");\n      }\n    }\n\n    const savedLocked = localStorage.getItem(LAYOUT_LOCKED_KEY);\n    if (savedLocked) {\n      setIsLayoutLocked(savedLocked === \"true\");\n    }\n  }, []);\n\n  const { data: stats, isLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: dailyFocus, isLoading: isDailyFocusLoading } = useQuery<DailyFocusData>({\n    queryKey: [\"/api/daily-focus\"],\n  });\n\n  const { data: graduationReady } = useQuery<GraduationReadyData>({\n    queryKey: [\"/api/program-accounts/graduation-ready\"],\n  });\n\n  const { data: graduationAnalytics } = useQuery<GraduationAnalyticsData>({\n    queryKey: [\"/api/program-accounts/graduation-analytics\"],\n  });\n\n  // Fetch enrolled accounts for revenue by segment\n  const { data: enrolledAccounts } = useQuery<EnrolledAccount[]>({\n    queryKey: [\"/api/program-accounts\"],\n  });\n\n  // Fetch all accounts for Top Opportunities (same data as Accounts page)\n  const { data: allAccounts, isLoading: isAccountsLoading, isError: isAccountsError, error: accountsError } = useQuery<AccountWithMetrics[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  // Check if accounts error is due to subscription requirement (402 status)\n  const isSubscriptionRequired = isAccountsError && accountsError?.message?.includes(\"402\");\n\n  // Toggle column visibility\n  const toggleColumnVisibility = useCallback((columnKey: string) => {\n    setVisibleColumns(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(columnKey)) {\n        // Don't allow hiding all columns - keep at least one\n        if (newSet.size > 1) {\n          newSet.delete(columnKey);\n        }\n      } else {\n        newSet.add(columnKey);\n      }\n      localStorage.setItem(OPPORTUNITY_COLUMNS_STORAGE_KEY, JSON.stringify(Array.from(newSet)));\n      return newSet;\n    });\n  }, []);\n\n  // Handle sort column click\n  const handleSortClick = useCallback((key: OpportunitySortKey) => {\n    if (opportunitySortKey === key) {\n      setOpportunitySortDir(prev => prev === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setOpportunitySortKey(key);\n      setOpportunitySortDir(key === \"opportunityScore\" ? \"desc\" : \"asc\");\n    }\n  }, [opportunitySortKey]);\n\n  // Sorted accounts for Top Opportunities (top 10 from /api/accounts - same as Accounts page)\n  const sortedTopOpportunities = useMemo(() => {\n    const accounts = allAccounts || [];\n    if (accounts.length === 0) return [];\n\n    // First sort all accounts by the selected column\n    const sorted = [...accounts].sort((a, b) => {\n      let comparison = 0;\n      switch (opportunitySortKey) {\n        case \"opportunityScore\":\n          comparison = a.opportunityScore - b.opportunityScore;\n          break;\n        case \"name\":\n          comparison = a.name.localeCompare(b.name);\n          break;\n        case \"segment\":\n          comparison = a.segment.localeCompare(b.segment);\n          break;\n        case \"region\":\n          comparison = (a.region || \"\").localeCompare(b.region || \"\");\n          break;\n        case \"last12mRevenue\":\n          comparison = a.last12mRevenue - b.last12mRevenue;\n          break;\n        case \"categoryPenetration\":\n          comparison = a.categoryPenetration - b.categoryPenetration;\n          break;\n        case \"enrolled\":\n          comparison = (a.enrolled ? 1 : 0) - (b.enrolled ? 1 : 0);\n          break;\n        default:\n          comparison = 0;\n      }\n      return opportunitySortDir === \"asc\" ? comparison : -comparison;\n    });\n\n    // Return top 10 accounts\n    return sorted.slice(0, 10);\n  }, [allAccounts, opportunitySortKey, opportunitySortDir]);\n\n  // Revenue by segment from enrolled accounts\n  const revenueBySegment = useMemo(() => {\n    if (!enrolledAccounts || enrolledAccounts.length === 0) return null;\n\n    const segmentMap = new Map<string, { segment: string; revenue: number; count: number }>();\n\n    enrolledAccounts.forEach(account => {\n      const existing = segmentMap.get(account.segment);\n      if (existing) {\n        existing.revenue += account.currentRevenue;\n        existing.count += 1;\n      } else {\n        segmentMap.set(account.segment, {\n          segment: account.segment,\n          revenue: account.currentRevenue,\n          count: 1,\n        });\n      }\n    });\n\n    return Array.from(segmentMap.values());\n  }, [enrolledAccounts]);\n\n  const handleTaskClick = (taskOrId: number | DashboardStats[\"recentTasks\"][0]) => {\n    if (typeof taskOrId === \"number\") {\n      navigate(`/playbooks?task=${taskOrId}`);\n    } else {\n      const task = taskOrId;\n      if (task.playbookId) {\n        navigate(`/playbooks?playbook=${task.playbookId}&task=${task.id}`);\n      } else {\n        navigate(`/playbooks?task=${task.id}`);\n      }\n    }\n  };\n\n  const saveLayout = useCallback((newLayout: LayoutItem[]) => {\n    setLayout(newLayout);\n    localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(newLayout));\n  }, []);\n\n  const handleDragStart = (e: DragEvent<HTMLDivElement>, blockId: string) => {\n    if (isLayoutLocked) {\n      e.preventDefault();\n      return;\n    }\n    setDraggedId(blockId);\n    e.dataTransfer.effectAllowed = \"move\";\n    e.dataTransfer.setData(\"text/plain\", blockId);\n    // Set a ghost image for visual feedback\n    const target = e.currentTarget.closest('[data-testid^=\"grid-block-\"]') as HTMLElement;\n    if (target) {\n      e.dataTransfer.setDragImage(target, 50, 50);\n    }\n  };\n\n  const handleDragEnd = () => {\n    setDraggedId(null);\n    setDragOverId(null);\n  };\n\n  const handleDragOver = (e: DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDragEnter = (e: DragEvent<HTMLDivElement>, blockId: string) => {\n    e.preventDefault();\n    if (draggedId && draggedId !== blockId) {\n      setDragOverId(blockId);\n    }\n  };\n\n  const handleDragLeave = (e: DragEvent<HTMLDivElement>) => {\n    // Only clear if leaving the actual element, not children\n    const relatedTarget = e.relatedTarget as HTMLElement;\n    if (!e.currentTarget.contains(relatedTarget)) {\n      setDragOverId(null);\n    }\n  };\n\n  const handleDrop = (e: DragEvent<HTMLDivElement>, targetId: string) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const sourceId = e.dataTransfer.getData(\"text/plain\");\n\n    if (!sourceId || sourceId === targetId || isLayoutLocked) {\n      setDraggedId(null);\n      setDragOverId(null);\n      return;\n    }\n\n    setLayout(prevLayout => {\n      const newLayout = [...prevLayout];\n      const draggedIndex = newLayout.findIndex(item => item.i === sourceId);\n      const targetIndex = newLayout.findIndex(item => item.i === targetId);\n\n      if (draggedIndex !== -1 && targetIndex !== -1) {\n        const [draggedItem] = newLayout.splice(draggedIndex, 1);\n        newLayout.splice(targetIndex, 0, draggedItem);\n        localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(newLayout));\n        return newLayout;\n      }\n      return prevLayout;\n    });\n\n    setDraggedId(null);\n    setDragOverId(null);\n  };\n\n  const resetLayout = () => {\n    setLayout(DEFAULT_LAYOUT);\n    setCollapsedBlocks(new Set());\n    setIsLayoutLocked(false);\n    localStorage.removeItem(LAYOUT_STORAGE_KEY);\n    localStorage.removeItem(COLLAPSED_BLOCKS_KEY);\n    localStorage.removeItem(LAYOUT_LOCKED_KEY);\n  };\n\n  const toggleLayoutLock = () => {\n    const newLocked = !isLayoutLocked;\n    setIsLayoutLocked(newLocked);\n    localStorage.setItem(LAYOUT_LOCKED_KEY, String(newLocked));\n  };\n\n  const updateBlockSize = (blockId: string, width?: WidthPreset, height?: HeightPreset) => {\n    setLayout(prevLayout => {\n      const newLayout = prevLayout.map(item => {\n        if (item.i === blockId) {\n          return {\n            ...item,\n            w: width ?? item.w,\n            heightPreset: height ?? item.heightPreset,\n          };\n        }\n        return item;\n      });\n      localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(newLayout));\n      return newLayout;\n    });\n  };\n\n  const toggleCollapsed = (blockId: string) => {\n    const newCollapsed = new Set(collapsedBlocks);\n    if (newCollapsed.has(blockId)) {\n      newCollapsed.delete(blockId);\n    } else {\n      newCollapsed.add(blockId);\n    }\n    setCollapsedBlocks(newCollapsed);\n    localStorage.setItem(COLLAPSED_BLOCKS_KEY, JSON.stringify(Array.from(newCollapsed)));\n  };\n\n  // Render sortable header with icon\n  const renderSortableHeader = (key: OpportunitySortKey, label: string) => (\n    <button\n      className=\"flex items-center gap-1 hover:text-foreground transition-colors text-left\"\n      onClick={() => handleSortClick(key)}\n      data-testid={`sort-${key}`}\n    >\n      {label}\n      {opportunitySortKey === key ? (\n        opportunitySortDir === \"asc\" ? (\n          <ArrowUp className=\"h-3 w-3\" />\n        ) : (\n          <ArrowDown className=\"h-3 w-3\" />\n        )\n      ) : (\n        <ArrowUpDown className=\"h-3 w-3 opacity-50\" />\n      )}\n    </button>\n  );\n\n  // Build columns based on visibility\n  const opportunityColumns = useMemo(() => {\n    const allColumns = [\n      {\n        key: \"name\",\n        header: renderSortableHeader(\"name\", \"Account\"),\n        cell: (row: AccountWithMetrics) => (\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex h-9 w-9 items-center justify-center rounded-md bg-primary/10 text-primary\">\n              <Users className=\"h-4 w-4\" />\n            </div>\n            <div className=\"flex flex-col\">\n              <span className=\"font-medium\">{row.name}</span>\n              <span className=\"text-xs text-muted-foreground\">{row.assignedTm}</span>\n            </div>\n          </div>\n        ),\n      },\n      {\n        key: \"segment\",\n        header: renderSortableHeader(\"segment\", \"Segment\"),\n        cell: (row: AccountWithMetrics) => (\n          <Badge variant=\"outline\">{row.segment}</Badge>\n        ),\n      },\n      {\n        key: \"region\",\n        header: renderSortableHeader(\"region\", \"Region\"),\n        cell: (row: AccountWithMetrics) => (\n          <span className=\"text-muted-foreground\">{row.region}</span>\n        ),\n      },\n      {\n        key: \"last12mRevenue\",\n        header: renderSortableHeader(\"last12mRevenue\", \"Revenue (12M)\"),\n        cell: (row: AccountWithMetrics) => (\n          <span className=\"font-semibold\">{formatCurrency(row.last12mRevenue)}</span>\n        ),\n      },\n      {\n        key: \"categoryPenetration\",\n        header: renderSortableHeader(\"categoryPenetration\", \"Penetration\"),\n        cell: (row: AccountWithMetrics) => (\n          <ProgressRing\n            value={row.categoryPenetration}\n            size={36}\n            strokeWidth={4}\n            testId={`penetration-${row.id}`}\n          />\n        ),\n      },\n      {\n        key: \"opportunityScore\",\n        header: renderSortableHeader(\"opportunityScore\", \"Score\"),\n        cell: (row: AccountWithMetrics) => (\n          <ScoreBadge score={row.opportunityScore} testId={`score-${row.id}`} />\n        ),\n      },\n      {\n        key: \"enrolled\",\n        header: renderSortableHeader(\"enrolled\", \"Status\"),\n        cell: (row: AccountWithMetrics) => (\n          <Badge variant={row.enrolled ? \"default\" : \"secondary\"}>\n            {row.enrolled ? \"Enrolled\" : \"Not Enrolled\"}\n          </Badge>\n        ),\n      },\n    ];\n\n    return allColumns.filter(col => visibleColumns.has(col.key));\n  }, [visibleColumns, opportunitySortKey, opportunitySortDir]);\n\n  const taskColumns = [\n    {\n      key: \"title\",\n      header: \"Task\",\n      cell: (row: DashboardStats[\"recentTasks\"][0]) => (\n        <div className=\"flex flex-col\">\n          <span className=\"font-medium truncate max-w-[200px]\">{row.title}</span>\n          <span className=\"text-xs text-muted-foreground\">{row.accountName}</span>\n        </div>\n      ),\n    },\n    {\n      key: \"taskType\",\n      header: \"Type\",\n      cell: (row: DashboardStats[\"recentTasks\"][0]) => (\n        <Badge variant=\"outline\">{row.taskType}</Badge>\n      ),\n    },\n    {\n      key: \"status\",\n      header: \"Status\",\n      cell: (row: DashboardStats[\"recentTasks\"][0]) => {\n        const statusColors: Record<string, string> = {\n          pending: \"bg-chart-3/10 text-chart-3 border-chart-3/20\",\n          in_progress: \"bg-chart-1/10 text-chart-1 border-chart-1/20\",\n          completed: \"bg-chart-2/10 text-chart-2 border-chart-2/20\",\n        };\n        return (\n          <Badge\n            variant=\"outline\"\n            className={statusColors[row.status] || \"\"}\n          >\n            {row.status.replace(\"_\", \" \")}\n          </Badge>\n        );\n      },\n    },\n    {\n      key: \"dueDate\",\n      header: \"Due\",\n      cell: (row: DashboardStats[\"recentTasks\"][0]) => (\n        <span className=\"text-muted-foreground text-sm\">{row.dueDate}</span>\n      ),\n    },\n  ];\n\n  const mockStats: DashboardStats = {\n    totalAccounts: 487,\n    enrolledAccounts: 142,\n    totalRevenue: 8540000,\n    incrementalRevenue: 1240000,\n    topOpportunities: [\n      {\n        id: 1,\n        name: \"ABC Plumbing Co\",\n        segment: \"HVAC\",\n        region: \"Northeast\",\n        assignedTm: \"John Smith\",\n        status: \"active\",\n        last12mRevenue: 125000,\n        categoryPenetration: 65,\n        opportunityScore: 92,\n        gapCategories: [\n          { name: \"Ductwork\", gapPct: 25, estimatedValue: 15000 },\n          { name: \"Controls\", gapPct: 20, estimatedValue: 12000 },\n          { name: \"Insulation\", gapPct: 18, estimatedValue: 18000 },\n        ],\n        enrolled: false,\n      },\n      {\n        id: 2,\n        name: \"Elite HVAC Services\",\n        segment: \"HVAC\",\n        region: \"Southwest\",\n        assignedTm: \"Sarah Johnson\",\n        status: \"active\",\n        last12mRevenue: 98000,\n        categoryPenetration: 72,\n        opportunityScore: 88,\n        gapCategories: [\n          { name: \"Copper Fittings\", gapPct: 22, estimatedValue: 20000 },\n          { name: \"Valves\", gapPct: 18, estimatedValue: 18000 },\n        ],\n        enrolled: true,\n      },\n      {\n        id: 3,\n        name: \"Metro Mechanical\",\n        segment: \"Mechanical\",\n        region: \"Midwest\",\n        assignedTm: \"Mike Williams\",\n        status: \"active\",\n        last12mRevenue: 185000,\n        categoryPenetration: 58,\n        opportunityScore: 85,\n        gapCategories: [\n          { name: \"Pumps\", gapPct: 30, estimatedValue: 25000 },\n          { name: \"Motors\", gapPct: 22, estimatedValue: 17000 },\n          { name: \"Bearings\", gapPct: 15, estimatedValue: 10000 },\n        ],\n        enrolled: false,\n      },\n      {\n        id: 4,\n        name: \"Premier Plumbing\",\n        segment: \"Plumbing\",\n        region: \"Southeast\",\n        assignedTm: \"Lisa Brown\",\n        status: \"active\",\n        last12mRevenue: 76000,\n        categoryPenetration: 80,\n        opportunityScore: 78,\n        gapCategories: [\n          { name: \"Fixtures\", gapPct: 15, estimatedValue: 18000 },\n          { name: \"Water Heaters\", gapPct: 12, estimatedValue: 13000 },\n        ],\n        enrolled: true,\n      },\n      {\n        id: 5,\n        name: \"Quality Climate Control\",\n        segment: \"HVAC\",\n        region: \"West\",\n        assignedTm: \"Tom Davis\",\n        status: \"active\",\n        last12mRevenue: 62000,\n        categoryPenetration: 88,\n        opportunityScore: 68,\n        gapCategories: [\n          { name: \"Refrigerant\", gapPct: 10, estimatedValue: 25000 },\n        ],\n        enrolled: false,\n      },\n    ],\n    recentTasks: [\n      { id: 1, accountId: 1, playbookId: 1, accountName: \"ABC Plumbing\", taskType: \"Call\", title: \"Follow up on product demo\", status: \"pending\", dueDate: \"Today\" },\n      { id: 2, accountId: 2, playbookId: 1, accountName: \"Elite HVAC\", taskType: \"Email\", title: \"Send pricing proposal\", status: \"in_progress\", dueDate: \"Tomorrow\" },\n      { id: 3, accountId: 3, playbookId: 2, accountName: \"Metro Mechanical\", taskType: \"Visit\", title: \"Site visit for assessment\", status: \"completed\", dueDate: \"Jan 20\" },\n      { id: 4, accountId: 4, playbookId: null, accountName: \"Premier Plumbing\", taskType: \"Call\", title: \"Quarterly review call\", status: \"pending\", dueDate: \"Jan 25\" },\n    ],\n    segmentBreakdown: [\n      { segment: \"HVAC\", count: 156, revenue: 3200000 },\n      { segment: \"Plumbing\", count: 198, revenue: 2800000 },\n      { segment: \"Mechanical\", count: 89, revenue: 1700000 },\n      { segment: \"Other\", count: 44, revenue: 840000 },\n    ],\n    icpProfiles: [\n      { segment: \"HVAC\", status: \"approved\", accountCount: 156 },\n      { segment: \"Plumbing\", status: \"approved\", accountCount: 198 },\n      { segment: \"Mechanical\", status: \"draft\", accountCount: 89 },\n      { segment: \"Electrical\", status: \"draft\", accountCount: 44 },\n    ],\n  };\n\n  const displayStats = {\n    ...mockStats,\n    ...(stats || {}),\n    icpProfiles: stats?.icpProfiles || mockStats.icpProfiles || [],\n    recentTasks: stats?.recentTasks || mockStats.recentTasks || [],\n    segmentBreakdown: stats?.segmentBreakdown || mockStats.segmentBreakdown || [],\n    topOpportunities: stats?.topOpportunities || mockStats.topOpportunities || [],\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {[...Array(4)].map((_, i) => (\n            <Card key={i}>\n              <CardHeader className=\"pb-2\">\n                <Skeleton className=\"h-4 w-24\" />\n              </CardHeader>\n              <CardContent>\n                <Skeleton className=\"h-8 w-32\" />\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  const workflowSteps = [\n    {\n      id: \"data\",\n      label: \"Upload Data\",\n      description: \"Import accounts and order history\",\n      completed: displayStats.totalAccounts > 0,\n      href: \"/data-uploads\",\n      icon: Upload,\n    },\n    {\n      id: \"icp\",\n      label: \"Approve ICP\",\n      description: \"Define Ideal Customer Profiles\",\n      completed: displayStats.icpProfiles.some(p => p.status === \"approved\"),\n      href: \"/icp-builder\",\n      icon: Target,\n    },\n    {\n      id: \"playbooks\",\n      label: \"Generate Playbook\",\n      description: \"Create AI-powered sales tasks\",\n      completed: displayStats.recentTasks.length > 0,\n      href: \"/playbooks\",\n      icon: Sparkles,\n    },\n    {\n      id: \"revenue\",\n      label: \"Track Revenue\",\n      description: \"Enroll accounts for rev-share\",\n      completed: displayStats.enrolledAccounts > 0,\n      href: \"/revenue\",\n      icon: TrendingUp,\n    },\n  ];\n\n  const completedSteps = workflowSteps.filter(s => s.completed).length;\n  const allComplete = completedSteps === workflowSteps.length;\n\n  const renderBlockHeader = (blockId: string, title: string, subtitle?: string, tooltipContent?: string, actions?: React.ReactNode) => {\n    const isCollapsed = collapsedBlocks.has(blockId);\n    const currentBlock = layout.find(item => item.i === blockId);\n    const currentWidth = currentBlock?.w ?? 6;\n    const currentHeight = currentBlock?.heightPreset ?? 'standard';\n\n    return (\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-3\">\n        <div className=\"flex items-start gap-2 flex-1 min-w-0\">\n          <div className=\"min-w-0\">\n            <CardTitle className=\"text-base truncate\">{title}</CardTitle>\n            {subtitle && (\n              <p className=\"text-sm text-muted-foreground mt-1 truncate\">\n                {subtitle}\n              </p>\n            )}\n          </div>\n          {tooltipContent && (\n            <InfoTooltip\n              content={tooltipContent}\n              testId={`tooltip-${blockId}`}\n            />\n          )}\n        </div>\n        <div className=\"flex items-center gap-1 shrink-0\">\n          {actions}\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-7 w-7\"\n                onClick={() => toggleCollapsed(blockId)}\n                data-testid={`collapse-${blockId}`}\n              >\n                {isCollapsed ? (\n                  <ChevronDown className=\"h-4 w-4\" />\n                ) : (\n                  <ChevronUp className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\">\n              <p>{isCollapsed ? \"Expand block\" : \"Collapse block\"}</p>\n            </TooltipContent>\n          </Tooltip>\n          {!isLayoutLocked && (\n            <>\n              <Popover>\n                <PopoverTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-7 w-7\"\n                    data-testid={`resize-${blockId}`}\n                  >\n                    <Maximize2 className=\"h-4 w-4 text-muted-foreground\" />\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-64 p-3\" align=\"end\">\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium\">\n                        <RectangleHorizontal className=\"h-4 w-4\" />\n                        <span>Width</span>\n                      </div>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {WIDTH_OPTIONS.map((option) => (\n                          <Button\n                            key={option.value}\n                            variant={currentWidth === option.value ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            className=\"text-xs px-2 h-7\"\n                            onClick={() => updateBlockSize(blockId, option.value, undefined)}\n                            data-testid={`width-${blockId}-${option.value}`}\n                          >\n                            {option.label}\n                          </Button>\n                        ))}\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center gap-2 text-sm font-medium\">\n                        <RectangleVertical className=\"h-4 w-4\" />\n                        <span>Height</span>\n                      </div>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {HEIGHT_OPTIONS.map((option) => (\n                          <Button\n                            key={option.value}\n                            variant={currentHeight === option.value ? \"default\" : \"outline\"}\n                            size=\"sm\"\n                            className=\"text-xs px-2 h-7\"\n                            onClick={() => updateBlockSize(blockId, undefined, option.value)}\n                            data-testid={`height-${blockId}-${option.value}`}\n                          >\n                            {option.label}\n                          </Button>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                </PopoverContent>\n              </Popover>\n              <div\n                className=\"drag-handle cursor-grab active:cursor-grabbing p-1 hover:bg-muted rounded\"\n                data-testid={`drag-handle-${blockId}`}\n                draggable\n                onDragStart={(e) => handleDragStart(e, blockId)}\n                onDragEnd={handleDragEnd}\n              >\n                <Move className=\"h-4 w-4 text-muted-foreground\" />\n              </div>\n            </>\n          )}\n        </div>\n      </CardHeader>\n    );\n  };\n\n  const renderBlock = (blockId: string) => {\n    const isCollapsed = collapsedBlocks.has(blockId);\n\n    switch (blockId) {\n      case \"daily-focus\":\n        return (\n          <Card className=\"h-full flex flex-col border-primary/20 bg-primary/5 overflow-hidden\" data-testid=\"card-daily-focus\">\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-3\">\n              <div className=\"flex items-center gap-3 min-w-0\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-primary text-primary-foreground shrink-0\">\n                  <Focus className=\"h-5 w-5\" />\n                </div>\n                <div className=\"min-w-0\">\n                  <CardTitle className=\"text-lg\">Daily Focus</CardTitle>\n                  <p className=\"text-sm text-muted-foreground truncate\">\n                    Tasks requiring your attention today\n                  </p>\n                </div>\n                <InfoTooltip\n                  content=\"Your prioritized action list showing tasks due today and any overdue items from yesterday. Complete these first to stay on track with your sales goals.\"\n                  testId=\"tooltip-daily-focus\"\n                />\n              </div>\n              <div className=\"flex items-center gap-2 shrink-0\">\n                {dailyFocus && dailyFocus.overdueCount > 0 && (\n                  <Badge variant=\"destructive\" className=\"gap-1\" data-testid=\"badge-overdue-count\">\n                    <AlertCircle className=\"h-3 w-3\" />\n                    {dailyFocus.overdueCount} overdue\n                  </Badge>\n                )}\n                {dailyFocus && dailyFocus.todayCount > 0 && (\n                  <Badge variant=\"secondary\" data-testid=\"badge-today-count\">\n                    {dailyFocus.todayCount} due today\n                  </Badge>\n                )}\n                {!isCollapsed && (\n                  <Button variant=\"outline\" size=\"sm\" asChild data-testid=\"button-view-all-tasks\">\n                    <Link href=\"/playbooks\">\n                      View All Tasks\n                      <ArrowRight className=\"ml-1 h-4 w-4\" />\n                    </Link>\n                  </Button>\n                )}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-7 w-7\"\n                      onClick={() => toggleCollapsed(blockId)}\n                      data-testid={`collapse-${blockId}`}\n                    >\n                      {isCollapsed ? (\n                        <ChevronDown className=\"h-4 w-4\" />\n                      ) : (\n                        <ChevronUp className=\"h-4 w-4\" />\n                      )}\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p>{isCollapsed ? \"Expand block\" : \"Collapse block\"}</p>\n                  </TooltipContent>\n                </Tooltip>\n                {!isLayoutLocked && (\n                  <>\n                    <Popover>\n                      <PopoverTrigger asChild>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          className=\"h-7 w-7\"\n                          data-testid={`resize-${blockId}`}\n                        >\n                          <Maximize2 className=\"h-4 w-4 text-muted-foreground\" />\n                        </Button>\n                      </PopoverTrigger>\n                      <PopoverContent className=\"w-64 p-3\" align=\"end\">\n                        <div className=\"space-y-4\">\n                          <div className=\"space-y-2\">\n                            <div className=\"flex items-center gap-2 text-sm font-medium\">\n                              <RectangleHorizontal className=\"h-4 w-4\" />\n                              <span>Width</span>\n                            </div>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {WIDTH_OPTIONS.map((option) => (\n                                <Button\n                                  key={option.value}\n                                  variant={(layout.find(item => item.i === blockId)?.w ?? 12) === option.value ? \"default\" : \"outline\"}\n                                  size=\"sm\"\n                                  className=\"text-xs px-2 h-7\"\n                                  onClick={() => updateBlockSize(blockId, option.value, undefined)}\n                                  data-testid={`width-${blockId}-${option.value}`}\n                                >\n                                  {option.label}\n                                </Button>\n                              ))}\n                            </div>\n                          </div>\n                          <div className=\"space-y-2\">\n                            <div className=\"flex items-center gap-2 text-sm font-medium\">\n                              <RectangleVertical className=\"h-4 w-4\" />\n                              <span>Height</span>\n                            </div>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {HEIGHT_OPTIONS.map((option) => (\n                                <Button\n                                  key={option.value}\n                                  variant={(layout.find(item => item.i === blockId)?.heightPreset ?? 'standard') === option.value ? \"default\" : \"outline\"}\n                                  size=\"sm\"\n                                  className=\"text-xs px-2 h-7\"\n                                  onClick={() => updateBlockSize(blockId, undefined, option.value)}\n                                  data-testid={`height-${blockId}-${option.value}`}\n                                >\n                                  {option.label}\n                                </Button>\n                              ))}\n                            </div>\n                          </div>\n                        </div>\n                      </PopoverContent>\n                    </Popover>\n                    <div\n                      className=\"drag-handle cursor-grab active:cursor-grabbing p-1 hover:bg-muted rounded\"\n                      data-testid={`drag-handle-${blockId}`}\n                      draggable\n                      onDragStart={(e) => handleDragStart(e, blockId)}\n                      onDragEnd={handleDragEnd}\n                    >\n                      <Move className=\"h-4 w-4 text-muted-foreground\" />\n                    </div>\n                  </>\n                )}\n              </div>\n            </CardHeader>\n            {!isCollapsed && (\n              <CardContent className=\"flex-1 overflow-y-auto overflow-x-hidden\">\n                {isDailyFocusLoading ? (\n                  <div className=\"space-y-2\">\n                    {[1, 2, 3].map((i) => (\n                      <div key={i} className=\"flex items-center gap-3 p-3 rounded-lg border bg-card\">\n                        <Skeleton className=\"h-8 w-8 rounded-md\" />\n                        <div className=\"flex-1 space-y-2\">\n                          <Skeleton className=\"h-4 w-48\" />\n                          <Skeleton className=\"h-3 w-32\" />\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : dailyFocus && dailyFocus.tasks.length > 0 ? (\n                  <div className=\"space-y-2\">\n                    {dailyFocus.tasks.slice(0, 5).map((task) => {\n                      const TaskIcon = taskTypeIcons[task.taskType] || Phone;\n                      return (\n                        <div\n                          key={task.id}\n                          className=\"flex items-center gap-3 p-3 rounded-lg border bg-card hover-elevate cursor-pointer\"\n                          onClick={() => handleTaskClick(task.id)}\n                          data-testid={`daily-focus-task-${task.id}`}\n                        >\n                          <div className={`flex h-8 w-8 items-center justify-center rounded-md ${task.isOverdue ? \"bg-destructive/10 text-destructive\" : \"bg-primary/10 text-primary\"\n                            }`}>\n                            <TaskIcon className=\"h-4 w-4\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-medium truncate\">{task.title}</span>\n                              {task.isOverdue && (\n                                <Badge variant=\"destructive\" className=\"text-xs\">Overdue</Badge>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                              <span>{task.accountName}</span>\n                              <span className=\"text-muted-foreground/50\">â€¢</span>\n                              <span className=\"flex items-center gap-1\">\n                                <Clock className=\"h-3 w-3\" />\n                                {new Date(task.dueDate).toLocaleDateString()}\n                              </span>\n                            </div>\n                          </div>\n                          <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                        </div>\n                      );\n                    })}\n                    {dailyFocus.tasks.length > 5 && (\n                      <Button variant=\"ghost\" className=\"w-full\" asChild>\n                        <Link href=\"/playbooks\">\n                          View {dailyFocus.tasks.length - 5} more tasks\n                          <ArrowRight className=\"ml-1 h-4 w-4\" />\n                        </Link>\n                      </Button>\n                    )}\n                  </div>\n                ) : (\n                  <div className=\"flex flex-col items-center justify-center py-8 text-center\">\n                    <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-chart-2/10 text-chart-2 mb-3\">\n                      <Target className=\"h-6 w-6\" />\n                    </div>\n                    <p className=\"font-medium text-chart-2\">All caught up!</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      No tasks due today. Generate a playbook to create new tasks.\n                    </p>\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3\" asChild>\n                      <Link href=\"/playbooks\">Go to Playbooks</Link>\n                    </Button>\n                  </div>\n                )}\n              </CardContent>\n            )}\n          </Card>\n        );\n\n      case \"top-opportunities\":\n        return (\n          <Card className=\"h-full flex flex-col overflow-hidden\">\n            {renderBlockHeader(\n              blockId,\n              \"Top Opportunities\",\n              `Top 10 accounts by ${ALL_OPPORTUNITY_COLUMNS.find(c => c.key === opportunitySortKey)?.label || \"Score\"}`,\n              \"Accounts ranked by opportunity score based on their category gaps vs ICP expectations. Higher scores indicate more potential revenue to capture from wallet share leakage. Click column headers to sort.\",\n              !isCollapsed && (\n                <div className=\"flex items-center gap-1\">\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"icon\" className=\"h-7 w-7\" data-testid=\"button-columns-visibility\">\n                        <Columns className=\"h-4 w-4\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\" className=\"w-48\">\n                      <DropdownMenuLabel>Show Columns</DropdownMenuLabel>\n                      <DropdownMenuSeparator />\n                      {ALL_OPPORTUNITY_COLUMNS.map((col) => (\n                        <DropdownMenuCheckboxItem\n                          key={col.key}\n                          checked={visibleColumns.has(col.key)}\n                          onCheckedChange={() => toggleColumnVisibility(col.key)}\n                          data-testid={`toggle-column-${col.key}`}\n                        >\n                          {col.label}\n                        </DropdownMenuCheckboxItem>\n                      ))}\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                  <Button variant=\"ghost\" size=\"sm\" asChild data-testid=\"button-view-all-opportunities\">\n                    <Link href=\"/accounts\">View All</Link>\n                  </Button>\n                </div>\n              )\n            )}\n            {!isCollapsed && (\n              <CardContent className=\"flex-1 overflow-y-auto overflow-x-auto\">\n                {isAccountsLoading ? (\n                  <div className=\"space-y-3\">\n                    {[...Array(5)].map((_, i) => (\n                      <Skeleton key={i} className=\"h-10 w-full\" />\n                    ))}\n                  </div>\n                ) : sortedTopOpportunities.length > 0 ? (\n                  <DataTable\n                    columns={opportunityColumns}\n                    data={sortedTopOpportunities}\n                    testId=\"table-opportunities\"\n                    onRowClick={(row: AccountWithMetrics) => navigate(`/accounts?account=${row.id}`)}\n                  />\n                ) : isSubscriptionRequired ? (\n                  <div className=\"flex flex-col items-center justify-center py-8 text-center\" data-testid=\"subscription-required-message\">\n                    <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 mb-3\">\n                      <CreditCard className=\"h-6 w-6 text-primary\" />\n                    </div>\n                    <p className=\"font-medium\">Subscription Required</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Upgrade your plan to unlock Top Opportunities\n                    </p>\n                    <Button size=\"sm\" className=\"mt-3\" asChild>\n                      <Link href=\"/subscription\">View Plans</Link>\n                    </Button>\n                  </div>\n                ) : (\n                  <div className=\"flex flex-col items-center justify-center py-8 text-center\">\n                    <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-muted mb-3\">\n                      <Users className=\"h-6 w-6 text-muted-foreground\" />\n                    </div>\n                    <p className=\"font-medium\">No accounts found</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Upload account data to see opportunities\n                    </p>\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3\" asChild>\n                      <Link href=\"/data-uploads\">Upload Data</Link>\n                    </Button>\n                  </div>\n                )}\n              </CardContent>\n            )}\n          </Card>\n        );\n\n      case \"segment-breakdown\":\n        return (\n          <Card className=\"h-full flex flex-col overflow-hidden\">\n            {renderBlockHeader(\n              blockId,\n              \"Segment Breakdown\",\n              \"Accounts by contractor type\",\n              \"Distribution of your accounts across customer segments (HVAC, Plumbing, Mechanical). Each segment has its own ICP profile defining expected category mix.\"\n            )}\n            {!isCollapsed && (\n              <CardContent className=\"flex-1 overflow-y-auto overflow-x-hidden\">\n                <div className=\"h-48\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <PieChart>\n                      <Pie\n                        data={displayStats.segmentBreakdown}\n                        dataKey=\"count\"\n                        nameKey=\"segment\"\n                        cx=\"50%\"\n                        cy=\"50%\"\n                        innerRadius={40}\n                        outerRadius={70}\n                        paddingAngle={2}\n                      >\n                        {displayStats.segmentBreakdown.map((_, index) => (\n                          <Cell key={index} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                        ))}\n                      </Pie>\n                      <RechartsTooltip\n                        formatter={(value: number) => [value, \"Accounts\"]}\n                        contentStyle={{\n                          backgroundColor: \"hsl(var(--popover))\",\n                          border: \"1px solid hsl(var(--border))\",\n                          borderRadius: \"var(--radius)\",\n                        }}\n                      />\n                    </PieChart>\n                  </ResponsiveContainer>\n                </div>\n                <div className=\"space-y-2 mt-4\">\n                  {displayStats.segmentBreakdown.map((item, index) => (\n                    <div key={item.segment} className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <div\n                          className=\"w-3 h-3 rounded-full\"\n                          style={{ backgroundColor: CHART_COLORS[index % CHART_COLORS.length] }}\n                        />\n                        <span className=\"text-sm\">{item.segment}</span>\n                      </div>\n                      <span className=\"text-sm text-muted-foreground\">{item.count}</span>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            )}\n          </Card>\n        );\n\n      case \"recent-tasks\":\n        return (\n          <Card className=\"h-full flex flex-col overflow-hidden\">\n            {renderBlockHeader(\n              blockId,\n              \"Recent Tasks\",\n              \"Upcoming TM actions\",\n              \"AI-generated sales tasks for Territory Managers including calls, emails, and site visits. Each task includes personalized scripts and talking points based on account gaps.\",\n              !isCollapsed && (\n                <Button variant=\"ghost\" size=\"sm\" asChild>\n                  <Link href=\"/playbooks\">View All</Link>\n                </Button>\n              )\n            )}\n            {!isCollapsed && (\n              <CardContent className=\"flex-1 overflow-y-auto overflow-x-auto\">\n                {displayStats.recentTasks.length > 0 ? (\n                  <DataTable\n                    columns={taskColumns}\n                    data={displayStats.recentTasks}\n                    testId=\"table-tasks\"\n                    onRowClick={handleTaskClick}\n                  />\n                ) : (\n                  <div className=\"flex flex-col items-center justify-center py-8 text-center\">\n                    <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-muted mb-3\">\n                      <Sparkles className=\"h-6 w-6 text-muted-foreground\" />\n                    </div>\n                    <p className=\"font-medium\">No tasks yet</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Generate a playbook to create tasks\n                    </p>\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3\" asChild>\n                      <Link href=\"/playbooks\">Generate Playbook</Link>\n                    </Button>\n                  </div>\n                )}\n              </CardContent>\n            )}\n          </Card>\n        );\n\n      case \"icp-profiles\":\n        return (\n          <Card className=\"h-full flex flex-col overflow-hidden\">\n            {renderBlockHeader(\n              blockId,\n              \"ICP Profiles\",\n              \"Segment profile status\",\n              \"Ideal Customer Profiles (ICPs) define expected category mix for each segment based on Class A customer data. Use AI analysis to refine profiles and approve them for scoring.\",\n              !isCollapsed && (\n                <Button variant=\"ghost\" size=\"sm\" asChild>\n                  <Link href=\"/icp-builder\">Manage</Link>\n                </Button>\n              )\n            )}\n            {!isCollapsed && (\n              <CardContent className=\"flex-1 overflow-y-auto overflow-x-hidden\">\n                <div className=\"space-y-4\">\n                  {displayStats.icpProfiles.map((profile) => (\n                    <div\n                      key={profile.segment}\n                      className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\"\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <ProgressRing\n                          value={profile.status === \"approved\" ? 100 : 50}\n                          size={40}\n                          strokeWidth={4}\n                        />\n                        <div>\n                          <span className=\"font-medium\">{profile.segment}</span>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {profile.accountCount} accounts\n                          </p>\n                        </div>\n                      </div>\n                      <Badge variant={profile.status === \"approved\" ? \"default\" : \"secondary\"}>\n                        {profile.status}\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            )}\n          </Card>\n        );\n\n      case \"revenue-chart\":\n        // Use revenue data from enrolled accounts if available, otherwise fall back to dashboard stats\n        const chartData = revenueBySegment || displayStats.segmentBreakdown;\n        return (\n          <Card className=\"h-full flex flex-col overflow-hidden\">\n            {renderBlockHeader(\n              blockId,\n              \"Revenue by Segment\",\n              revenueBySegment ? \"From enrolled accounts\" : \"All accounts\",\n              \"Revenue contribution by customer segment from enrolled accounts. This data is connected to Revenue Tracking. Enroll more accounts to see more detailed segment breakdown.\",\n              !isCollapsed && (\n                <Button variant=\"ghost\" size=\"sm\" asChild data-testid=\"button-view-revenue\">\n                  <Link href=\"/revenue\">View Details</Link>\n                </Button>\n              )\n            )}\n            {!isCollapsed && (\n              <CardContent className=\"flex-1 overflow-y-auto overflow-x-auto\">\n                {chartData && chartData.length > 0 ? (\n                  <div className=\"h-64\">\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\n                      <BarChart data={chartData}>\n                        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                        <XAxis\n                          dataKey=\"segment\"\n                          tick={{ fill: \"hsl(var(--muted-foreground))\", fontSize: 12 }}\n                          axisLine={{ stroke: \"hsl(var(--border))\" }}\n                        />\n                        <YAxis\n                          tickFormatter={(value) => formatCurrency(value)}\n                          tick={{ fill: \"hsl(var(--muted-foreground))\", fontSize: 12 }}\n                          axisLine={{ stroke: \"hsl(var(--border))\" }}\n                        />\n                        <RechartsTooltip\n                          formatter={(value: number) => [formatCurrency(value), \"Revenue\"]}\n                          contentStyle={{\n                            backgroundColor: \"hsl(var(--popover))\",\n                            border: \"1px solid hsl(var(--border))\",\n                            borderRadius: \"var(--radius)\",\n                          }}\n                        />\n                        <Bar dataKey=\"revenue\" fill=\"hsl(var(--chart-1))\" radius={[4, 4, 0, 0]} />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </div>\n                ) : (\n                  <div className=\"flex flex-col items-center justify-center py-8 text-center\">\n                    <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-muted mb-3\">\n                      <DollarSign className=\"h-6 w-6 text-muted-foreground\" />\n                    </div>\n                    <p className=\"font-medium\">No revenue data</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      Enroll accounts to track revenue by segment\n                    </p>\n                    <Button variant=\"outline\" size=\"sm\" className=\"mt-3\" asChild>\n                      <Link href=\"/revenue\">Go to Revenue Tracking</Link>\n                    </Button>\n                  </div>\n                )}\n              </CardContent>\n            )}\n          </Card>\n        );\n\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-dashboard\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Dashboard</h1>\n          <p className=\"text-muted-foreground\">\n            Monitor wallet share opportunities and track revenue growth\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                data-testid=\"button-layout-menu\"\n              >\n                {isLayoutLocked ? (\n                  <Lock className=\"h-4 w-4\" />\n                ) : (\n                  <Unlock className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              <DropdownMenuCheckboxItem\n                checked={isLayoutLocked}\n                onCheckedChange={toggleLayoutLock}\n                data-testid=\"toggle-layout-lock\"\n              >\n                <Lock className=\"mr-2 h-4 w-4\" />\n                Lock Layout\n              </DropdownMenuCheckboxItem>\n              <DropdownMenuSeparator />\n              <DropdownMenuItem\n                onSelect={resetLayout}\n                data-testid=\"button-reset-layout\"\n              >\n                <RotateCcw className=\"mr-2 h-4 w-4\" />\n                Reset Layout\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n          <Button asChild data-testid=\"button-view-opportunities\">\n            <Link href=\"/accounts\">\n              View All Opportunities\n              <ArrowRight className=\"ml-2 h-4 w-4\" />\n            </Link>\n          </Button>\n        </div>\n      </div>\n\n\n      {!allComplete && (\n        <Card className=\"border-chart-1/20 bg-chart-1/5\" data-testid=\"card-getting-started\">\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <CardTitle className=\"text-base\">Getting Started</CardTitle>\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {completedSteps}/{workflowSteps.length} complete\n                </Badge>\n              </div>\n              <InfoTooltip\n                content=\"Complete these steps to set up your sales intelligence workflow. Each step builds on the previous one to create a complete revenue growth system.\"\n                testId=\"tooltip-getting-started\"\n              />\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center gap-4\">\n              {workflowSteps.map((step, index) => {\n                const StepIcon = step.icon;\n                const isNextStep = !step.completed && workflowSteps.slice(0, index).every(s => s.completed);\n\n                return (\n                  <div key={step.id} className=\"flex items-center gap-4 flex-1\">\n                    <Link href={step.href}>\n                      <div\n                        className={`flex items-center gap-3 p-3 rounded-lg border transition-colors cursor-pointer ${step.completed\n                          ? \"bg-chart-2/10 border-chart-2/30\"\n                          : isNextStep\n                            ? \"bg-primary/10 border-primary/30 hover-elevate\"\n                            : \"bg-muted/50 border-muted\"\n                          }`}\n                        data-testid={`step-${step.id}`}\n                      >\n                        <div className={`flex h-8 w-8 items-center justify-center rounded-full ${step.completed\n                          ? \"bg-chart-2 text-chart-2-foreground\"\n                          : isNextStep\n                            ? \"bg-primary text-primary-foreground\"\n                            : \"bg-muted text-muted-foreground\"\n                          }`}>\n                          {step.completed ? (\n                            <CheckCircle2 className=\"h-4 w-4\" />\n                          ) : (\n                            <StepIcon className=\"h-4 w-4\" />\n                          )}\n                        </div>\n                        <div className=\"hidden md:block\">\n                          <p className={`text-sm font-medium ${step.completed ? \"text-chart-2\" : \"\"}`}>\n                            {step.label}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {step.description}\n                          </p>\n                        </div>\n                      </div>\n                    </Link>\n                    {index < workflowSteps.length - 1 && (\n                      <div className={`hidden lg:block h-0.5 flex-1 ${step.completed ? \"bg-chart-2/50\" : \"bg-muted\"\n                        }`} />\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Daily Briefing - Agentic Layer */}\n      <DailyBriefingCard onAccountClick={setDossierAccountId} />\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <KPICard\n          title=\"Total Accounts\"\n          value={displayStats.totalAccounts.toLocaleString()}\n          icon={Users}\n          trend={{ value: 12, label: \"vs last month\" }}\n          testId=\"kpi-total-accounts\"\n          tooltip=\"The total number of customer accounts in your database that can be analyzed for wallet share opportunities.\"\n        />\n        <KPICard\n          title=\"Enrolled Accounts\"\n          value={displayStats.enrolledAccounts.toLocaleString()}\n          subtitle={`${((displayStats.enrolledAccounts / displayStats.totalAccounts) * 100).toFixed(0)}% of total`}\n          icon={Target}\n          trend={{ value: 8, label: \"vs last month\" }}\n          testId=\"kpi-enrolled-accounts\"\n          tooltip=\"Accounts actively participating in the revenue growth program. These accounts are being tracked for incremental revenue to calculate rev-share fees.\"\n        />\n        <KPICard\n          title=\"Total Revenue (12M)\"\n          value={formatCurrency(displayStats.totalRevenue)}\n          icon={DollarSign}\n          trend={{ value: 15, label: \"YoY\" }}\n          testId=\"kpi-total-revenue\"\n          tooltip=\"Cumulative revenue from all accounts over the last 12 months. This serves as the baseline for measuring growth and calculating opportunities.\"\n        />\n        <KPICard\n          title=\"Incremental Revenue\"\n          value={formatCurrency(displayStats.incrementalRevenue)}\n          subtitle=\"From enrolled accounts\"\n          icon={TrendingUp}\n          trend={{ value: 23, label: \"vs baseline\" }}\n          testId=\"kpi-incremental-revenue\"\n          tooltip=\"Additional revenue generated from enrolled accounts above their baseline. This is the basis for calculating rev-share fees (15% of incremental revenue).\"\n        />\n      </div>\n\n      {/* Graduation Ready Quick Access */}\n      {graduationReady && graduationReady.count > 0 && (\n        <Link href=\"/revenue\">\n          <Card className=\"border-chart-2/30 bg-chart-2/5 hover-elevate cursor-pointer\" data-testid=\"card-graduation-ready\">\n            <CardContent className=\"py-3\">\n              <div className=\"flex items-center justify-between flex-wrap gap-3\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-chart-2/20\">\n                    <GraduationCap className=\"h-4 w-4 text-chart-2\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium text-chart-2\">\n                      {graduationReady.count} Account{graduationReady.count > 1 ? \"s\" : \"\"} Ready to Graduate\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Click to review and graduate successful accounts\n                    </p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  {graduationReady.accounts.slice(0, 2).map(acc => (\n                    <Badge key={acc.programAccountId} variant=\"outline\" className=\"bg-background\">\n                      <Trophy className=\"h-3 w-3 mr-1 text-chart-2\" />\n                      {acc.accountName}\n                    </Badge>\n                  ))}\n                  {graduationReady.count > 2 && (\n                    <Badge variant=\"outline\" className=\"bg-background\">\n                      +{graduationReady.count - 2} more\n                    </Badge>\n                  )}\n                  <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </Link>\n      )}\n\n      {/* Graduation Success Block - Shows when there are graduated accounts */}\n      {graduationAnalytics && graduationAnalytics.totalGraduated > 0 && (\n        <Card className=\"border-chart-3/30 bg-chart-3/5\" data-testid=\"card-graduation-success\">\n          <CardHeader className=\"pb-2\">\n            <div className=\"flex items-center justify-between flex-wrap gap-2\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-chart-3/20\">\n                  <Trophy className=\"h-4 w-4 text-chart-3\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-lg\">Graduation Success</CardTitle>\n                  {collapsedBlocks.has(\"graduation-success\") && (\n                    <p className=\"text-xs text-muted-foreground\">\n                      {graduationAnalytics.totalGraduated} graduated Â· {formatCurrency(graduationAnalytics.cumulativeRevenueGrowth)} captured\n                    </p>\n                  )}\n                  {!collapsedBlocks.has(\"graduation-success\") && (\n                    <p className=\"text-xs text-muted-foreground\">\n                      Wallet share captured from graduated accounts\n                    </p>\n                  )}\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {!collapsedBlocks.has(\"graduation-success\") && (\n                  <Link href=\"/revenue\">\n                    <Button variant=\"outline\" size=\"sm\" data-testid=\"button-view-graduates\">\n                      View All Graduates\n                      <ChevronRight className=\"h-4 w-4 ml-1\" />\n                    </Button>\n                  </Link>\n                )}\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-8 w-8\"\n                  onClick={() => toggleCollapsed(\"graduation-success\")}\n                  data-testid=\"button-toggle-graduation-success\"\n                >\n                  {collapsedBlocks.has(\"graduation-success\") ? (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </div>\n            </div>\n          </CardHeader>\n          {!collapsedBlocks.has(\"graduation-success\") && <CardContent>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n              <div className=\"text-center p-3 rounded-lg bg-background/50\">\n                <p className=\"text-2xl font-bold text-chart-3\" data-testid=\"stat-graduated-count\">\n                  {graduationAnalytics.totalGraduated}\n                </p>\n                <div className=\"flex items-center justify-center gap-1\">\n                  <p className=\"text-xs text-muted-foreground\">Accounts Graduated</p>\n                  <InfoTooltip\n                    content=\"Total number of accounts that have successfully completed the program and met their graduation objectives.\"\n                    testId=\"tooltip-graduated-count\"\n                  />\n                </div>\n              </div>\n              <div className=\"text-center p-3 rounded-lg bg-background/50\">\n                <p className=\"text-2xl font-bold text-chart-1\" data-testid=\"stat-revenue-growth\">\n                  {formatCurrency(graduationAnalytics.cumulativeRevenueGrowth)}\n                </p>\n                <div className=\"flex items-center justify-center gap-1\">\n                  <p className=\"text-xs text-muted-foreground\">Incremental Revenue</p>\n                  <InfoTooltip\n                    content=\"Sum of incremental revenue across all graduated accounts. Calculated as: Graduation Revenue - Pro-rated Baseline. The baseline is adjusted to match enrollment duration for fair comparison.\"\n                    testId=\"tooltip-incremental-revenue\"\n                  />\n                </div>\n              </div>\n              <div className=\"text-center p-3 rounded-lg bg-background/50\">\n                <p className=\"text-2xl font-bold\" data-testid=\"stat-avg-days\">\n                  {graduationAnalytics.avgDaysToGraduation}\n                </p>\n                <div className=\"flex items-center justify-center gap-1\">\n                  <p className=\"text-xs text-muted-foreground\">Avg Days to Graduate</p>\n                  <InfoTooltip\n                    content=\"Average number of days from enrollment to graduation across all graduated accounts. Calculated as: Total enrollment days / Number of graduated accounts.\"\n                    testId=\"tooltip-avg-days\"\n                  />\n                </div>\n              </div>\n              <div className=\"text-center p-3 rounded-lg bg-background/50\">\n                <p className=\"text-2xl font-bold text-chart-2\" data-testid=\"stat-icp-success\">\n                  {graduationAnalytics.avgIcpCategorySuccessRate}%\n                </p>\n                <div className=\"flex items-center justify-center gap-1\">\n                  <p className=\"text-xs text-muted-foreground\">Avg ICP Category Success</p>\n                  <InfoTooltip\n                    content=\"Average percentage of ICP category gaps filled at graduation. Calculated as: (Categories Achieved / Categories Missing at Enrollment) Ã— 100, averaged across all graduated accounts with ICP data.\"\n                    testId=\"tooltip-icp-success\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            {/* Recent Graduates with Revenue Details */}\n            {graduationAnalytics.graduatedAccounts.length > 0 && (\n              <div className=\"space-y-3\">\n                <p className=\"text-sm font-medium text-muted-foreground\">Recent Graduates</p>\n                <div className=\"space-y-2\">\n                  {graduationAnalytics.graduatedAccounts.slice(0, 5).map((account) => (\n                    <Card\n                      key={account.id}\n                      className=\"p-3\"\n                      data-testid={`card-graduate-${account.id}`}\n                    >\n                      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-chart-3/20\" data-testid={`icon-graduate-${account.id}`}>\n                            <Trophy className=\"h-4 w-4 text-chart-3\" />\n                          </div>\n                          <div>\n                            <p className=\"font-medium\" data-testid={`text-graduate-name-${account.id}`}>{account.accountName}</p>\n                            <p className=\"text-xs text-muted-foreground\" data-testid={`text-graduate-info-${account.id}`}>\n                              {account.segment || \"No segment\"}\n                              {account.enrollmentDurationDays && ` Â· ${account.enrollmentDurationDays} days enrolled`}\n                            </p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-4 text-right flex-wrap\">\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Baseline</p>\n                            <p className=\"text-sm font-medium\" data-testid={`text-baseline-${account.id}`}>{formatCurrency(account.baselineRevenue)}</p>\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">At Graduation</p>\n                            <p className=\"text-sm font-medium\" data-testid={`text-graduation-revenue-${account.id}`}>{formatCurrency(account.graduationRevenue)}</p>\n                          </div>\n                          <div className=\"min-w-[80px]\">\n                            <p className=\"text-xs text-muted-foreground\">Growth</p>\n                            <p className={`text-sm font-bold ${account.revenueGrowth > 0 ? 'text-chart-1' : 'text-muted-foreground'}`} data-testid={`text-growth-${account.id}`}>\n                              {account.revenueGrowth > 0 ? '+' : ''}{formatCurrency(account.revenueGrowth)}\n                            </p>\n                          </div>\n                        </div>\n                      </div>\n                    </Card>\n                  ))}\n                  {graduationAnalytics.graduatedAccounts.length > 5 && (\n                    <Link href=\"/revenue\">\n                      <Button variant=\"ghost\" size=\"sm\" className=\"w-full\" data-testid=\"button-more-graduates\">\n                        View {graduationAnalytics.graduatedAccounts.length - 5} more graduates\n                        <ChevronRight className=\"h-4 w-4 ml-1\" />\n                      </Button>\n                    </Link>\n                  )}\n                </div>\n              </div>\n            )}\n          </CardContent>}\n        </Card>\n      )}\n\n      {!isLayoutLocked && (\n        <div className=\"flex items-center gap-2 p-3 rounded-lg bg-muted/50 border border-dashed\">\n          <Move className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm text-muted-foreground\">\n            Drag blocks to reorder. Click the resize icon to adjust width and height. Lock when done.\n          </span>\n        </div>\n      )}\n\n      <div id=\"dashboard-grid-container\" className=\"grid grid-cols-12 gap-4 w-full\">\n        {layout.map((item) => {\n          const isBeingDragged = draggedId === item.i;\n          const isDragOver = dragOverId === item.i && draggedId !== item.i;\n          const isCollapsed = collapsedBlocks.has(item.i);\n          const heightClass = isCollapsed ? 'h-auto' : HEIGHT_CLASSES[item.heightPreset];\n\n          const getWidthClasses = (w: WidthPreset) => {\n            switch (w) {\n              case 3: return \"col-span-12 sm:col-span-6 lg:col-span-3\";\n              case 4: return \"col-span-12 sm:col-span-6 lg:col-span-4\";\n              case 6: return \"col-span-12 md:col-span-6\";\n              case 8: return \"col-span-12 lg:col-span-8\";\n              case 9: return \"col-span-12 lg:col-span-9\";\n              case 12: return \"col-span-12\";\n              default: return \"col-span-12 md:col-span-6\";\n            }\n          };\n\n          return (\n            <div\n              key={item.i}\n              data-testid={`grid-block-${item.i}`}\n              onDragOver={handleDragOver}\n              onDragEnter={(e) => handleDragEnter(e, item.i)}\n              onDragLeave={handleDragLeave}\n              onDrop={(e) => handleDrop(e, item.i)}\n              className={`\n                ${getWidthClasses(item.w)}\n                ${heightClass}\n                transition-all duration-200 ease-in-out\n                ${isBeingDragged ? \"opacity-50 scale-95\" : \"\"}\n                ${isDragOver ? \"ring-2 ring-primary ring-offset-2\" : \"\"}\n              `}\n            >\n              {renderBlock(item.i)}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Account Dossier â€” slide-out panel */}\n      <AccountDossierPanel\n        accountId={dossierAccountId}\n        onClose={() => setDossierAccountId(null)}\n      />\n    </div>\n  );\n}\n\n","path":null,"size_bytes":79555,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1202,"size_tokens":null},"client/replit_integrations/audio/useAudioPlayback.ts":{"content":"/**\n * React hook for streaming audio playback using AudioWorklet.\n * Supports real-time PCM16 audio streaming from SSE responses.\n * Includes sequence buffer for reordering out-of-order chunks.\n */\nimport { useRef, useCallback, useState } from \"react\";\nimport { decodePCM16ToFloat32 } from \"./audio-utils\";\n\nexport type PlaybackState = \"idle\" | \"playing\" | \"ended\";\n\n/**\n * Reorders audio chunks that may arrive out of sequence.\n * Buffers chunks until they can be played in correct order.\n *\n * Example: If chunks arrive as seq 2, seq 0, seq 1:\n * - seq 2 arrives â†’ buffered (waiting for seq 0)\n * - seq 0 arrives â†’ played immediately, then check buffer\n * - seq 1 arrives â†’ played immediately (seq 0 done), seq 2 now plays\n */\nclass SequenceBuffer {\n  private pending = new Map<number, string[]>();\n  private nextSeq = 0;\n\n  /** Add chunk with sequence number, returns chunks ready to play in order */\n  push(seq: number, data: string): string[] {\n    // Store the chunk under its sequence number\n    if (!this.pending.has(seq)) {\n      this.pending.set(seq, []);\n    }\n    this.pending.get(seq)!.push(data);\n\n    // Drain consecutive ready sequences\n    const ready: string[] = [];\n    while (this.pending.has(this.nextSeq)) {\n      ready.push(...this.pending.get(this.nextSeq)!);\n      this.pending.delete(this.nextSeq);\n      this.nextSeq++;\n    }\n    return ready;\n  }\n\n  reset() {\n    this.pending.clear();\n    this.nextSeq = 0;\n  }\n}\n\nexport function useAudioPlayback(workletPath = \"/audio-playback-worklet.js\") {\n  const [state, setState] = useState<PlaybackState>(\"idle\");\n  const ctxRef = useRef<AudioContext | null>(null);\n  const workletRef = useRef<AudioWorkletNode | null>(null);\n  const readyRef = useRef(false);\n  const seqBufferRef = useRef(new SequenceBuffer());\n\n  const init = useCallback(async () => {\n    if (readyRef.current) return;\n\n    const ctx = new AudioContext({ sampleRate: 24000 });\n    await ctx.audioWorklet.addModule(workletPath);\n    const worklet = new AudioWorkletNode(ctx, \"audio-playback-processor\");\n    worklet.connect(ctx.destination);\n\n    worklet.port.onmessage = (e) => {\n      if (e.data.type === \"ended\") setState(\"idle\");\n    };\n\n    ctxRef.current = ctx;\n    workletRef.current = worklet;\n    readyRef.current = true;\n  }, [workletPath]);\n\n  /** Push audio directly (no sequencing) - for simple streaming */\n  const pushAudio = useCallback((base64Audio: string) => {\n    if (!workletRef.current) return;\n    const samples = decodePCM16ToFloat32(base64Audio);\n    workletRef.current.port.postMessage({ type: \"audio\", samples });\n    setState(\"playing\");\n  }, []);\n\n  /** Push audio with sequence number - reorders before playback */\n  const pushSequencedAudio = useCallback((seq: number, base64Audio: string) => {\n    if (!workletRef.current) return;\n\n    const readyChunks = seqBufferRef.current.push(seq, base64Audio);\n    for (const chunk of readyChunks) {\n      const samples = decodePCM16ToFloat32(chunk);\n      workletRef.current.port.postMessage({ type: \"audio\", samples });\n    }\n    if (readyChunks.length > 0) {\n      setState(\"playing\");\n    }\n  }, []);\n\n  const signalComplete = useCallback(() => {\n    workletRef.current?.port.postMessage({ type: \"streamComplete\" });\n  }, []);\n\n  const clear = useCallback(() => {\n    workletRef.current?.port.postMessage({ type: \"clear\" });\n    seqBufferRef.current.reset();\n    setState(\"idle\");\n  }, []);\n\n  return { state, init, pushAudio, pushSequencedAudio, signalComplete, clear };\n}\n","path":null,"size_bytes":3495,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":844,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"server/replit_integrations/batch/utils.ts":{"content":"import pLimit from \"p-limit\";\nimport pRetry from \"p-retry\";\n\n/**\n * Batch Processing Utilities\n *\n * This module provides a generic batch processing function with built-in\n * rate limiting and automatic retries. Use it for any task that requires\n * processing multiple items through an LLM or external API.\n *\n * USAGE:\n * ```typescript\n * import { batchProcess, isRateLimitError } from \"./replit_integrations/batch\";\n *\n * const results = await batchProcess(\n *   artworks,\n *   async (artwork) => {\n *     // Your custom LLM logic here\n *     const response = await openai.chat.completions.create({\n *       model: \"gpt-5.1\",\n *       messages: [{ role: \"user\", content: `Categorize: ${artwork.name}` }],\n *       response_format: { type: \"json_object\" },\n *     });\n *     return JSON.parse(response.choices[0]?.message?.content || \"{}\");\n *   },\n *   { concurrency: 2, retries: 5 }\n * );\n * ```\n */\n\nexport interface BatchOptions {\n  /** Max concurrent requests (default: 2) */\n  concurrency?: number;\n  /** Max retry attempts for rate limit errors (default: 7) */\n  retries?: number;\n  /** Initial retry delay in ms (default: 2000) */\n  minTimeout?: number;\n  /** Max retry delay in ms (default: 128000) */\n  maxTimeout?: number;\n  /** Callback for progress updates */\n  onProgress?: (completed: number, total: number, item: unknown) => void;\n}\n\n/**\n * Check if an error is a rate limit or quota violation.\n * Use this in custom error handling if needed.\n */\nexport function isRateLimitError(error: unknown): boolean {\n  const errorMsg = error instanceof Error ? error.message : String(error);\n  return (\n    errorMsg.includes(\"429\") ||\n    errorMsg.includes(\"RATELIMIT_EXCEEDED\") ||\n    errorMsg.toLowerCase().includes(\"quota\") ||\n    errorMsg.toLowerCase().includes(\"rate limit\")\n  );\n}\n\n/**\n * Process items in batches with rate limiting and automatic retries.\n *\n * @param items - Array of items to process\n * @param processor - Async function to process each item (write your LLM logic here)\n * @param options - Concurrency and retry settings\n * @returns Promise resolving to array of results in the same order as input\n *\n * @example\n * // Process CSV artwork data with custom categorization\n * const categorized = await batchProcess(\n *   csvRows,\n *   async (row) => {\n *     const response = await openai.chat.completions.create({\n *       model: \"gpt-5.1\", // the newest OpenAI model\n *       messages: [{ role: \"user\", content: `Categorize artwork: ${row.name}` }],\n *       response_format: { type: \"json_object\" },\n *     });\n *     return { ...row, category: JSON.parse(response.choices[0]?.message?.content || \"{}\") };\n *   }\n * );\n */\nexport async function batchProcess<T, R>(\n  items: T[],\n  processor: (item: T, index: number) => Promise<R>,\n  options: BatchOptions = {}\n): Promise<R[]> {\n  const {\n    concurrency = 2,\n    retries = 7,\n    minTimeout = 2000,\n    maxTimeout = 128000,\n    onProgress,\n  } = options;\n\n  const limit = pLimit(concurrency);\n  let completed = 0;\n\n  const promises = items.map((item, index) =>\n    limit(() =>\n      pRetry(\n        async () => {\n          try {\n            const result = await processor(item, index);\n            completed++;\n            onProgress?.(completed, items.length, item);\n            return result;\n          } catch (error: unknown) {\n            if (isRateLimitError(error)) {\n              throw error; // Rethrow to trigger p-retry\n            }\n            // For non-rate-limit errors, abort immediately\n            throw new pRetry.AbortError(\n              error instanceof Error ? error : new Error(String(error))\n            );\n          }\n        },\n        { retries, minTimeout, maxTimeout, factor: 2 }\n      )\n    )\n  );\n\n  return Promise.all(promises);\n}\n\n/**\n * Process items sequentially with SSE progress streaming.\n * Use this when you need real-time progress updates to the client.\n *\n * @param items - Array of items to process\n * @param processor - Async function to process each item\n * @param sendEvent - Function to send SSE events to the client\n * @param options - Retry settings (concurrency is always 1 for sequential)\n */\nexport async function batchProcessWithSSE<T, R>(\n  items: T[],\n  processor: (item: T, index: number) => Promise<R>,\n  sendEvent: (event: { type: string; [key: string]: unknown }) => void,\n  options: Omit<BatchOptions, \"concurrency\" | \"onProgress\"> = {}\n): Promise<R[]> {\n  const { retries = 5, minTimeout = 1000, maxTimeout = 15000 } = options;\n\n  sendEvent({ type: \"started\", total: items.length });\n\n  const results: R[] = [];\n  let errors = 0;\n\n  for (let index = 0; index < items.length; index++) {\n    const item = items[index];\n    sendEvent({ type: \"processing\", index, item });\n\n    try {\n      const result = await pRetry(\n        () => processor(item, index),\n        {\n          retries,\n          minTimeout,\n          maxTimeout,\n          factor: 2,\n          onFailedAttempt: (error) => {\n            if (!isRateLimitError(error)) {\n              throw new pRetry.AbortError(\n                error instanceof Error ? error : new Error(String(error))\n              );\n            }\n          },\n        }\n      );\n      results.push(result);\n      sendEvent({ type: \"progress\", index, result });\n    } catch (error) {\n      errors++;\n      results.push(undefined as R); // Placeholder for failed items\n      sendEvent({\n        type: \"progress\",\n        index,\n        error: error instanceof Error ? error.message : \"Processing failed\",\n      });\n    }\n  }\n\n  sendEvent({ type: \"complete\", processed: items.length, errors });\n  return results;\n}\n\n","path":null,"size_bytes":5593,"size_tokens":null},"shared/models/auth.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { index, jsonb, pgTable, timestamp, varchar } from \"drizzle-orm/pg-core\";\n\n// Session storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)]\n);\n\n// User storage table.\n// (IMPORTANT) This table is mandatory for Replit Auth, don't drop it.\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\n","path":null,"size_bytes":1010,"size_tokens":null},"server/replit_integrations/chat/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport OpenAI from \"openai\";\nimport { chatStorage } from \"./storage\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport function registerChatRoutes(app: Express): void {\n  // Get all conversations\n  app.get(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const conversations = await chatStorage.getAllConversations();\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get single conversation with messages\n  app.get(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await chatStorage.getConversation(id);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      const messages = await chatStorage.getMessagesByConversation(id);\n      res.json({ ...conversation, messages });\n    } catch (error) {\n      console.error(\"Error fetching conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Create new conversation\n  app.post(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const { title } = req.body;\n      const conversation = await chatStorage.createConversation(title || \"New Chat\");\n      res.status(201).json(conversation);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n\n  // Delete conversation\n  app.delete(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      await chatStorage.deleteConversation(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting conversation:\", error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // Send message and get AI response (streaming)\n  app.post(\"/api/conversations/:id/messages\", async (req: Request, res: Response) => {\n    try {\n      const conversationId = parseInt(req.params.id);\n      const { content } = req.body;\n\n      // Save user message\n      await chatStorage.createMessage(conversationId, \"user\", content);\n\n      // Get conversation history for context\n      const messages = await chatStorage.getMessagesByConversation(conversationId);\n      const chatMessages = messages.map((m) => ({\n        role: m.role as \"user\" | \"assistant\",\n        content: m.content,\n      }));\n\n      // Set up SSE\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      // Stream response from OpenAI\n      const stream = await openai.chat.completions.create({\n        model: \"gpt-5.1\",\n        messages: chatMessages,\n        stream: true,\n        max_completion_tokens: 2048,\n      });\n\n      let fullResponse = \"\";\n\n      for await (const chunk of stream) {\n        const content = chunk.choices[0]?.delta?.content || \"\";\n        if (content) {\n          fullResponse += content;\n          res.write(`data: ${JSON.stringify({ content })}\\n\\n`);\n        }\n      }\n\n      // Save assistant message\n      await chatStorage.createMessage(conversationId, \"assistant\", fullResponse);\n\n      res.write(`data: ${JSON.stringify({ done: true })}\\n\\n`);\n      res.end();\n    } catch (error) {\n      console.error(\"Error sending message:\", error);\n      // Check if headers already sent (SSE streaming started)\n      if (res.headersSent) {\n        res.write(`data: ${JSON.stringify({ error: \"Failed to send message\" })}\\n\\n`);\n        res.end();\n      } else {\n        res.status(500).json({ error: \"Failed to send message\" });\n      }\n    }\n  });\n}\n\n","path":null,"size_bytes":4044,"size_tokens":null},"server/services/crm-sync-push.ts":{"content":"/**\n * CRM Sync Push Service â€” Phase 3\n *\n * POST /api/agent/crm-sync-push\n * Body: { eventType, accountId, payload }\n *\n * Queues CRM sync events and POSTs structured payloads to the webhook URL\n * configured in agent_organization_settings.crm_webhook_url.\n *\n * Called on:\n *   - Account enrollment_status change (enrolled, graduated, at_risk)\n *   - agent_playbook_outcomes INSERT\n *   - Manual trigger from admin\n *\n * Retries are handled by the scheduler (every 4 hours for failed rows).\n */\n\nimport { db } from \"../db\";\nimport { agentCrmSyncQueue, agentOrganizationSettings } from \"@shared/schema\";\nimport { and, eq } from \"drizzle-orm\";\n\n// â”€â”€â”€ CRM payload shapes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport interface CrmEnrollmentPayload {\n    event: \"enrollment\";\n    account_id: number;\n    account_name: string;\n    segment: string | null;\n    enrollment_status: string;\n    assigned_tm: string | null;\n    timestamp: string;\n}\n\nexport interface CrmOutcomePayload {\n    event: \"outcome\";\n    account_id: number;\n    playbook_id: number;\n    action_taken: string;\n    outcome: string;\n    revenue_impact: string | null;\n    timestamp: string;\n}\n\nexport interface CrmGraduationPayload {\n    event: \"graduation\";\n    account_id: number;\n    account_name: string;\n    assigned_tm: string | null;\n    graduation_reason: string;\n    timestamp: string;\n}\n\nexport interface CrmAtRiskPayload {\n    event: \"at_risk\";\n    account_id: number;\n    account_name: string;\n    risk_signals: string[];\n    assigned_tm: string | null;\n    timestamp: string;\n}\n\nexport type CrmPayload =\n    | CrmEnrollmentPayload\n    | CrmOutcomePayload\n    | CrmGraduationPayload\n    | CrmAtRiskPayload;\n\n// â”€â”€â”€ Queue a CRM event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function queueCrmEvent(\n    tenantId: number,\n    eventType: string,\n    accountId: number,\n    payload: CrmPayload,\n): Promise<number> {\n    const [row] = await db.insert(agentCrmSyncQueue).values({\n        tenantId,\n        eventType,\n        accountId,\n        payload,\n        status: \"pending\",\n        attempts: 0,\n    }).returning();\n    return row.id;\n}\n\n// â”€â”€â”€ Fire a single queued event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function fireWebhook(\n    webhookUrl: string,\n    webhookSecret: string | null,\n    payload: unknown,\n): Promise<void> {\n    const body = JSON.stringify(payload);\n    const headers: Record<string, string> = {\n        \"Content-Type\": \"application/json\",\n        \"User-Agent\": \"WalletShareExpander-Agent/1.0\",\n    };\n    if (webhookSecret) {\n        headers[\"X-Webhook-Secret\"] = webhookSecret;\n    }\n\n    const response = await fetch(webhookUrl, { method: \"POST\", headers, body });\n    if (!response.ok) {\n        throw new Error(`Webhook responded with ${response.status}: ${await response.text()}`);\n    }\n}\n\n// â”€â”€â”€ Process pending queue entries for a tenant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function processCrmSyncQueue(tenantId: number): Promise<{ sent: number; failed: number }> {\n    const [settings] = await db.select().from(agentOrganizationSettings)\n        .where(eq(agentOrganizationSettings.tenantId, tenantId));\n\n    if (!settings?.crmWebhookUrl) {\n        console.log(`[crm-sync] No webhook URL configured for tenant ${tenantId}`);\n        return { sent: 0, failed: 0 };\n    }\n\n    const pending = await db.select().from(agentCrmSyncQueue)\n        .where(and(\n            eq(agentCrmSyncQueue.tenantId, tenantId),\n            eq(agentCrmSyncQueue.status, \"pending\"),\n        ));\n\n    let sent = 0;\n    let failed = 0;\n\n    for (const row of pending) {\n        try {\n            await fireWebhook(settings.crmWebhookUrl, settings.crmWebhookSecret, row.payload);\n            await db.update(agentCrmSyncQueue)\n                .set({ status: \"sent\", sentAt: new Date() })\n                .where(eq(agentCrmSyncQueue.id, row.id));\n            sent++;\n            console.log(`[crm-sync] Sent event ${row.eventType} for account ${row.accountId}`);\n        } catch (err) {\n            const newAttempts = (row.attempts ?? 0) + 1;\n            await db.update(agentCrmSyncQueue)\n                .set({\n                    status: newAttempts >= 5 ? \"failed\" : \"pending\",\n                    attempts: newAttempts,\n                    errorMessage: err instanceof Error ? err.message : String(err),\n                })\n                .where(eq(agentCrmSyncQueue.id, row.id));\n            failed++;\n            console.error(`[crm-sync] Failed event ${row.id} (attempt ${newAttempts}):`, err);\n        }\n    }\n\n    return { sent, failed };\n}\n","path":null,"size_bytes":5012,"size_tokens":null},"client/src/pages/profile.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { User, Mail, Calendar, Shield } from \"lucide-react\";\n\nexport default function Profile() {\n  const { user } = useAuth();\n\n  if (!user) {\n    return null;\n  }\n\n  const initials = `${user.firstName?.[0] || ''}${user.lastName?.[0] || ''}`.toUpperCase() || 'U';\n  const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || 'User';\n  \n  const platformAdminEmails = [\"graham@tenexity.ai\", \"admin@tenexity.ai\"];\n  const isPlatformAdmin = user.email && platformAdminEmails.some(\n    adminEmail => adminEmail.toLowerCase() === (user.email || \"\").toLowerCase().trim()\n  );\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-4xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-profile-title\">My Profile</h1>\n        <p className=\"text-muted-foreground mt-2\">View and manage your account information</p>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card data-testid=\"card-profile-info\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <User className=\"h-5 w-5\" />\n              Account Information\n            </CardTitle>\n            <CardDescription>Your personal details and account status</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center gap-6 mb-6\">\n              <Avatar className=\"h-20 w-20\">\n                {user.profileImageUrl && (\n                  <AvatarImage src={user.profileImageUrl} alt={fullName} />\n                )}\n                <AvatarFallback className=\"text-2xl bg-primary text-primary-foreground\">\n                  {initials}\n                </AvatarFallback>\n              </Avatar>\n              <div>\n                <h2 className=\"text-2xl font-semibold\" data-testid=\"text-user-name\">{fullName}</h2>\n                <div className=\"flex items-center gap-2 mt-2\">\n                  {isPlatformAdmin && (\n                    <Badge variant=\"default\" className=\"bg-blue-600\">\n                      <Shield className=\"h-3 w-3 mr-1\" />\n                      Platform Admin\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-3 p-3 bg-muted/50 rounded-lg\">\n                <Mail className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Email Address</p>\n                  <p className=\"font-medium\" data-testid=\"text-user-email\">{user.email || 'Not set'}</p>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3 p-3 bg-muted/50 rounded-lg\">\n                <User className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">First Name</p>\n                  <p className=\"font-medium\">{user.firstName || 'Not set'}</p>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-3 p-3 bg-muted/50 rounded-lg\">\n                <User className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Last Name</p>\n                  <p className=\"font-medium\">{user.lastName || 'Not set'}</p>\n                </div>\n              </div>\n\n              {user.createdAt && (\n                <div className=\"flex items-center gap-3 p-3 bg-muted/50 rounded-lg\">\n                  <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Account Created</p>\n                    <p className=\"font-medium\">\n                      {new Date(user.createdAt).toLocaleDateString('en-US', {\n                        year: 'numeric',\n                        month: 'long',\n                        day: 'numeric'\n                      })}\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-account-status\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Shield className=\"h-5 w-5\" />\n              Account Status\n            </CardTitle>\n            <CardDescription>Your access level and permissions</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              <div className=\"p-4 border rounded-lg\">\n                <h3 className=\"font-medium mb-2\">Role</h3>\n                <p className=\"text-muted-foreground text-sm\">\n                  {isPlatformAdmin ? (\n                    <span className=\"text-blue-600 font-medium\">Platform Administrator</span>\n                  ) : (\n                    <span>Standard User</span>\n                  )}\n                </p>\n              </div>\n\n              <div className=\"p-4 border rounded-lg\">\n                <h3 className=\"font-medium mb-2\">Access</h3>\n                <ul className=\"text-sm text-muted-foreground space-y-1\">\n                  <li>Dashboard and Analytics</li>\n                  <li>Account Management</li>\n                  <li>ICP Builder</li>\n                  <li>Playbooks and Tasks</li>\n                  <li>Revenue Tracking</li>\n                  {isPlatformAdmin && (\n                    <>\n                      <li className=\"text-blue-600 font-medium\">Platform Administration</li>\n                      <li className=\"text-blue-600 font-medium\">Tenant Management</li>\n                      <li className=\"text-blue-600 font-medium\">Stripe Configuration</li>\n                    </>\n                  )}\n                </ul>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6173,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"server/ai-service.ts":{"content":"import OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { storage } from \"./storage\";\nimport { withRetry } from \"./utils/retry\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  timeout: 60000,\n  maxRetries: 0,\n});\n\ninterface CategorySuggestion {\n  categoryName: string;\n  expectedPct: number;\n  importance: number;\n  isRequired: boolean;\n  notes: string;\n}\n\nconst categorySuggestionSchema = z.object({\n  categoryName: z.string(),\n  expectedPct: z.number(),\n  importance: z.number().default(1),\n  isRequired: z.boolean().default(false),\n  notes: z.string().default(\"\"),\n});\n\ninterface SegmentAnalysisResult {\n  description: string;\n  minAnnualRevenue: number;\n  categories: CategorySuggestion[];\n}\n\nconst segmentAnalysisResultSchema = z.object({\n  description: z.string(),\n  minAnnualRevenue: z.number(),\n  categories: z.array(categorySuggestionSchema),\n});\n\nconst taskGenerationResultSchema = z.object({\n  title: z.string(),\n  taskType: z.enum([\"call\", \"email\", \"visit\"]),\n  description: z.string(),\n  script: z.string(),\n});\n\ntype TaskGenerationResult = z.infer<typeof taskGenerationResultSchema>;\n\nfunction safeParseJSON<T>(content: string, schema: z.ZodSchema<T>, fallback: T): T {\n  try {\n    const parsed = JSON.parse(content);\n    const result = schema.safeParse(parsed);\n    if (result.success) {\n      return result.data;\n    }\n    console.error(\"AI response validation failed:\", result.error);\n    return fallback;\n  } catch (error) {\n    console.error(\"AI response JSON parse failed:\", error);\n    return fallback;\n  }\n}\n\nexport async function analyzeSegment(segment: string): Promise<SegmentAnalysisResult> {\n  // Use custom categories if available, otherwise fall back to product categories\n  const customCats = await storage.getCustomCategories();\n  const categories = customCats.length > 0 \n    ? customCats.filter(c => c.isActive).map(c => ({ name: c.name }))\n    : (await storage.getProductCategories()).map(c => ({ name: c.name }));\n  const categoryNames = categories.map(c => c.name).join(\", \");\n\n  const prompt = `You are a sales analytics expert for a wholesale distributor serving ${segment} contractors.\n\nAvailable product categories: ${categoryNames}\n\nAnalyze what a typical \"Class A\" ${segment} contractor should be purchasing from a full-service distributor.\n\nProvide:\n1. A brief description of this ideal customer profile (1-2 sentences)\n2. Minimum annual revenue threshold for a Class A account\n3. Expected category mix with percentages (should sum to ~100%)\n\nFor each category, provide:\n- expectedPct: What percentage of their total purchases should come from this category\n- importance: 0.5 (low margin/priority), 1.0 (normal), 1.5 (high priority), 2.0 (strategic priority)\n- isRequired: Whether this category is essential for a full-scope contractor\n- notes: Any relevant notes about this category\n\nRespond in JSON format:\n{\n  \"description\": \"...\",\n  \"minAnnualRevenue\": 50000,\n  \"categories\": [\n    {\n      \"categoryName\": \"...\",\n      \"expectedPct\": 30,\n      \"importance\": 1.0,\n      \"isRequired\": true,\n      \"notes\": \"\"\n    }\n  ]\n}`;\n\n  try {\n    const response = await withRetry(\n      () => openai.chat.completions.create({\n        model: \"gpt-5.1\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        max_completion_tokens: 2048,\n      }),\n      { maxRetries: 3, timeoutMs: 60000 }\n    );\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from AI\");\n    }\n\n    const fallbackCategories: CategorySuggestion[] = categories.slice(0, 5).map((cat, i) => ({\n      categoryName: cat.name,\n      expectedPct: Math.floor(80 / 5),\n      importance: i === 0 ? 1.5 : 1.0,\n      isRequired: i < 2,\n      notes: \"\",\n    }));\n    \n    const fallback: SegmentAnalysisResult = {\n      description: `Full-scope ${segment} contractor purchasing across major categories`,\n      minAnnualRevenue: 50000,\n      categories: fallbackCategories,\n    };\n\n    return safeParseJSON(content, segmentAnalysisResultSchema, fallback) as SegmentAnalysisResult;\n  } catch (error) {\n    console.error(\"AI segment analysis error:\", error);\n    // Use custom categories if available, otherwise fall back to product categories\n    const customCats = await storage.getCustomCategories();\n    const fallbackCats = customCats.length > 0 \n      ? customCats.filter(c => c.isActive).map(c => ({ name: c.name }))\n      : (await storage.getProductCategories()).map(c => ({ name: c.name }));\n    \n    const errorFallbackCategories: CategorySuggestion[] = fallbackCats.slice(0, 5).map((cat, i) => ({\n      categoryName: cat.name,\n      expectedPct: Math.floor(80 / 5),\n      importance: i === 0 ? 1.5 : 1.0,\n      isRequired: i < 2,\n      notes: \"\",\n    }));\n    \n    return {\n      description: `Full-scope ${segment} contractor purchasing across major categories`,\n      minAnnualRevenue: 50000,\n      categories: errorFallbackCategories,\n    };\n  }\n}\n\nexport async function generateCallScript(\n  accountName: string,\n  segment: string,\n  gapCategories: string[],\n  revenue: number\n): Promise<TaskGenerationResult> {\n  const prompt = `You are a Territory Manager at ABC Supply, a wholesale distributor.\n\nAccount: ${accountName}\nSegment: ${segment}\nAnnual Revenue: $${revenue.toLocaleString()}\nGap Categories (categories they should be buying from us but aren't): ${gapCategories.join(\", \")}\n\nGenerate a call script for reaching out to this account about the gap categories.\n\nThe script should:\n1. Start with a warm, relationship-focused opening\n2. Reference that they're a valued customer\n3. Naturally transition to discussing the gap category (pick the most strategic one)\n4. Include specific benefits of consolidating purchases with ABC Supply\n5. End with a clear next step (scheduling a call, sending a quote, etc.)\n\nKeep it conversational - this is a trusted supplier relationship, not a cold call.\n\nRespond in JSON format:\n{\n  \"title\": \"Brief task title (5-7 words)\",\n  \"taskType\": \"call\",\n  \"description\": \"One sentence description of the opportunity\",\n  \"script\": \"The full call script with natural paragraphs\"\n}`;\n\n  try {\n    const response = await withRetry(\n      () => openai.chat.completions.create({\n        model: \"gpt-5.1\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        max_completion_tokens: 2048,\n      }),\n      { maxRetries: 3, timeoutMs: 60000 }\n    );\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from AI\");\n    }\n\n    const fallback: TaskGenerationResult = {\n      title: `Discuss ${gapCategories[0] || \"products\"} with ${accountName}`,\n      taskType: \"call\",\n      description: `High-opportunity account missing ${gapCategories[0] || \"products\"} category`,\n      script: `Hi, this is [Your Name] from ABC Supply. I wanted to reach out about our ${gapCategories[0] || \"products\"} line that I think could benefit your business. Would you have time this week for a quick call?`,\n    };\n\n    return safeParseJSON(content, taskGenerationResultSchema, fallback);\n  } catch (error) {\n    console.error(\"AI call script generation error:\", error);\n    return {\n      title: `Discuss ${gapCategories[0] || \"products\"} with ${accountName}`,\n      taskType: \"call\",\n      description: `High-opportunity account missing ${gapCategories[0] || \"products\"} category`,\n      script: `Hi, this is [Your Name] from ABC Supply. I wanted to reach out about our ${gapCategories[0] || \"products\"} line that I think could benefit your business. Would you have time this week for a quick call?`,\n    };\n  }\n}\n\nexport async function generateEmailTemplate(\n  accountName: string,\n  segment: string,\n  gapCategories: string[],\n  revenue: number\n): Promise<TaskGenerationResult> {\n  const prompt = `You are a Territory Manager at ABC Supply, a wholesale distributor.\n\nAccount: ${accountName}\nSegment: ${segment}  \nAnnual Revenue: $${revenue.toLocaleString()}\nGap Categories (categories they should be buying from us but aren't): ${gapCategories.join(\", \")}\n\nGenerate an email template for reaching out to this account about the gap categories.\n\nThe email should:\n1. Be brief (3 paragraphs max)\n2. Reference their business and relationship with ABC Supply\n3. Introduce the gap category naturally (seasonal tie-in, new inventory, promotion, etc.)\n4. Highlight 2-3 specific benefits\n5. Include a clear call-to-action\n\nInclude a subject line. Tone should be helpful and professional, not pushy.\n\nRespond in JSON format:\n{\n  \"title\": \"Brief task title (5-7 words)\",\n  \"taskType\": \"email\",\n  \"description\": \"One sentence description of the opportunity\",\n  \"script\": \"Subject: [subject line]\\\\n\\\\n[email body with paragraphs]\"\n}`;\n\n  try {\n    const response = await withRetry(\n      () => openai.chat.completions.create({\n        model: \"gpt-5.1\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        max_completion_tokens: 2048,\n      }),\n      { maxRetries: 3, timeoutMs: 60000 }\n    );\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from AI\");\n    }\n\n    const fallback: TaskGenerationResult = {\n      title: `Email about ${gapCategories[0] || \"products\"} to ${accountName}`,\n      taskType: \"email\",\n      description: `Send information about ${gapCategories[0] || \"products\"} opportunities`,\n      script: `Subject: ${gapCategories[0] || \"Products\"} Solutions for Your Business\\n\\nHi [Contact],\\n\\nI wanted to reach out about our expanded ${gapCategories[0] || \"products\"} inventory that could benefit your projects.\\n\\nLet me know if you'd like to learn more.\\n\\nBest,\\n[Your Name]`,\n    };\n\n    return safeParseJSON(content, taskGenerationResultSchema, fallback);\n  } catch (error) {\n    console.error(\"AI email template generation error:\", error);\n    return {\n      title: `Email about ${gapCategories[0] || \"products\"} to ${accountName}`,\n      taskType: \"email\",\n      description: `Send information about ${gapCategories[0] || \"products\"} opportunities`,\n      script: `Subject: ${gapCategories[0] || \"Products\"} Solutions for Your Business\\n\\nHi [Contact],\\n\\nI wanted to reach out about our expanded ${gapCategories[0] || \"products\"} inventory that could benefit your projects.\\n\\nLet me know if you'd like to learn more.\\n\\nBest,\\n[Your Name]`,\n    };\n  }\n}\n\nexport async function generateVisitPlan(\n  accountName: string,\n  segment: string,\n  gapCategories: string[],\n  revenue: number\n): Promise<TaskGenerationResult> {\n  const prompt = `You are a Territory Manager at ABC Supply, a wholesale distributor.\n\nAccount: ${accountName}\nSegment: ${segment}\nAnnual Revenue: $${revenue.toLocaleString()}\nGap Categories (categories they should be buying from us but aren't): ${gapCategories.join(\", \")}\n\nGenerate a site visit plan for this account to assess and address the gap categories.\n\nInclude:\n1. Clear objectives for the visit (3-4 bullet points)\n2. Key talking points about the gap categories\n3. Questions to ask about their current suppliers and pain points\n4. Next steps to propose during the visit\n\nRespond in JSON format:\n{\n  \"title\": \"Brief task title (5-7 words)\",\n  \"taskType\": \"visit\",\n  \"description\": \"One sentence description of the visit purpose\",\n  \"script\": \"Visit plan with objectives, talking points, and next steps\"\n}`;\n\n  try {\n    const response = await withRetry(\n      () => openai.chat.completions.create({\n        model: \"gpt-5.1\",\n        messages: [{ role: \"user\", content: prompt }],\n        response_format: { type: \"json_object\" },\n        max_completion_tokens: 2048,\n      }),\n      { maxRetries: 3, timeoutMs: 60000 }\n    );\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error(\"No response from AI\");\n    }\n\n    const fallback: TaskGenerationResult = {\n      title: `Site visit to ${accountName}`,\n      taskType: \"visit\",\n      description: `Assess ${gapCategories[0] || \"product\"} opportunities on-site`,\n      script: `Visit Objectives:\\n1. Assess current ${gapCategories[0] || \"product\"} needs\\n2. Review supplier pain points\\n3. Present our solutions\\n4. Discuss next steps`,\n    };\n\n    return safeParseJSON(content, taskGenerationResultSchema, fallback);\n  } catch (error) {\n    console.error(\"AI visit plan generation error:\", error);\n    return {\n      title: `Site visit to ${accountName}`,\n      taskType: \"visit\",\n      description: `Assess ${gapCategories[0] || \"product\"} opportunities on-site`,\n      script: `Visit Objectives:\\n1. Assess current ${gapCategories[0] || \"product\"} needs\\n2. Review supplier pain points\\n3. Present our solutions\\n4. Discuss next steps`,\n    };\n  }\n}\n\nexport async function generatePlaybookTasks(\n  accounts: Array<{\n    id: number;\n    name: string;\n    segment: string;\n    assignedTm: string;\n    revenue: number;\n    gapCategories: string[];\n  }>,\n  priorityCategories: string[] = []\n): Promise<Array<{\n  accountId: number;\n  assignedTm: string;\n  taskType: string;\n  title: string;\n  description: string;\n  script: string;\n  gapCategories: string[];\n}>> {\n  const tasks = [];\n\n  for (const account of accounts) {\n    const relevantGaps = priorityCategories.length > 0\n      ? account.gapCategories.filter(g => priorityCategories.includes(g))\n      : account.gapCategories;\n\n    if (relevantGaps.length === 0) continue;\n\n    // Decide task type based on revenue and gap size\n    const taskType = account.revenue > 200000 ? \"visit\" : account.revenue > 100000 ? \"call\" : \"email\";\n\n    try {\n      let taskResult: TaskGenerationResult;\n\n      if (taskType === \"call\") {\n        taskResult = await generateCallScript(account.name, account.segment, relevantGaps, account.revenue);\n      } else if (taskType === \"email\") {\n        taskResult = await generateEmailTemplate(account.name, account.segment, relevantGaps, account.revenue);\n      } else {\n        taskResult = await generateVisitPlan(account.name, account.segment, relevantGaps, account.revenue);\n      }\n\n      tasks.push({\n        accountId: account.id,\n        assignedTm: account.assignedTm,\n        taskType: taskResult.taskType,\n        title: taskResult.title,\n        description: taskResult.description,\n        script: taskResult.script,\n        gapCategories: relevantGaps,\n      });\n    } catch (error) {\n      console.error(`Failed to generate task for ${account.name}:`, error);\n    }\n  }\n\n  return tasks;\n}\n","path":null,"size_bytes":14596,"size_tokens":null},"server/services/ask-anything.ts":{"content":"/**\n * Ask-Anything Service â€” Phase 3\n *\n * GET /api/agent/ask-anything (SSE streaming)\n * Query params: question, scope (account|portfolio|program), scopeId (accountId if scope=account)\n *\n * Streams OpenAI gpt-4o response via Server-Sent Events.\n * Logs the full Q&A to agent_query_log on completion.\n */\n\nimport OpenAI from \"openai\";\nimport type { Response } from \"express\";\nimport { db } from \"../db\";\nimport { accounts, accountMetrics, programAccounts, agentQueryLog, productCategories, accountCategoryGaps, orders } from \"@shared/schema\";\nimport { assembleAccountContext, buildFullSystemPrompt } from \"./account-context\";\nimport { getCoreSystemPrompt, readAgentState, buildStatePreamble } from \"./agent-identity\";\nimport { and, eq, desc, sql, max } from \"drizzle-orm\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nasync function buildPortfolioContext(tenantId: number): Promise<string> {\n    const accountRows = await db\n        .select({\n            id: accounts.id,\n            name: accounts.name,\n            segment: accounts.segment,\n            region: accounts.region,\n            status: accounts.status,\n            assignedTm: accounts.assignedTm,\n        })\n        .from(accounts)\n        .where(eq(accounts.tenantId, tenantId))\n        .orderBy(accounts.name);\n\n    if (accountRows.length === 0) return \"No accounts found for this tenant.\";\n\n    const metricsRows = await db\n        .select()\n        .from(accountMetrics)\n        .where(eq(accountMetrics.tenantId, tenantId));\n\n    const metricsMap = new Map(metricsRows.map((m) => [m.accountId, m]));\n\n    const programRows = await db\n        .select()\n        .from(programAccounts)\n        .where(eq(programAccounts.tenantId, tenantId));\n\n    const programMap = new Map(programRows.map((p) => [p.accountId, p]));\n\n    const categoryRows = await db\n        .select()\n        .from(productCategories)\n        .where(eq(productCategories.tenantId, tenantId));\n\n    const categoryMap = new Map(categoryRows.map((c) => [c.id, c.name]));\n\n    const gapRows = await db\n        .select()\n        .from(accountCategoryGaps)\n        .where(eq(accountCategoryGaps.tenantId, tenantId));\n\n    const gapsByAccount = new Map<number, typeof gapRows>();\n    for (const g of gapRows) {\n        const existing = gapsByAccount.get(g.accountId) ?? [];\n        existing.push(g);\n        gapsByAccount.set(g.accountId, existing);\n    }\n\n    const lastOrderRows = await db\n        .select({\n            accountId: orders.accountId,\n            lastOrderDate: max(orders.orderDate),\n        })\n        .from(orders)\n        .where(eq(orders.tenantId, tenantId))\n        .groupBy(orders.accountId);\n\n    const lastOrderMap = new Map(lastOrderRows.map((o) => [o.accountId, o.lastOrderDate]));\n\n    const lines: string[] = [];\n    const today = new Date();\n    lines.push(`PORTFOLIO DATA â€” ${accountRows.length} accounts total`);\n    lines.push(`Today's date: ${today.toISOString().slice(0, 10)}`);\n    lines.push(\"\");\n\n    let enrolled = 0;\n    let graduated = 0;\n\n    for (const a of accountRows) {\n        const m = metricsMap.get(a.id);\n        const p = programMap.get(a.id);\n        const enrollment = p?.status ?? \"not_enrolled\";\n        if (enrollment === \"active\") enrolled++;\n        if (enrollment === \"graduated\") graduated++;\n\n        const lastOrder = lastOrderMap.get(a.id);\n        const daysSinceOrder = lastOrder\n            ? Math.round((today.getTime() - new Date(lastOrder).getTime()) / 86400000)\n            : null;\n\n        const gaps = gapsByAccount.get(a.id) ?? [];\n        const topGaps = gaps\n            .sort((x, y) => parseFloat(y.estimatedOpportunity ?? \"0\") - parseFloat(x.estimatedOpportunity ?? \"0\"))\n            .slice(0, 3)\n            .map((g) => `${categoryMap.get(g.categoryId) ?? `Cat#${g.categoryId}`}: $${g.estimatedOpportunity ?? \"?\"} gap (${g.gapPct ?? \"?\"}%)`)\n            .join(\", \");\n\n        lines.push(\n            `â€¢ ${a.name} | segment: ${a.segment ?? \"?\"} | region: ${a.region ?? \"?\"} | TM: ${a.assignedTm ?? \"unassigned\"} | enrollment: ${enrollment}` +\n            ` | 12m rev: $${m?.last12mRevenue ?? \"?\"} | score: ${m?.opportunityScore ?? \"?\"} | penetration: ${m?.categoryPenetration ?? \"?\"}%` +\n            ` | days since last order: ${daysSinceOrder ?? \"unknown\"}` +\n            (topGaps ? ` | top gaps: ${topGaps}` : \"\"),\n        );\n    }\n\n    lines.push(\"\");\n    lines.push(`Summary: ${enrolled} enrolled, ${graduated} graduated, ${accountRows.length - enrolled - graduated} not enrolled`);\n\n    return lines.join(\"\\n\");\n}\n\nexport async function streamAskAnything(\n    question: string,\n    scope: \"account\" | \"portfolio\" | \"program\",\n    scopeId: number | null,\n    tenantId: number,\n    res: Response,\n): Promise<void> {\n    res.setHeader(\"Content-Type\", \"text/event-stream\");\n    res.setHeader(\"Cache-Control\", \"no-cache\");\n    res.setHeader(\"Connection\", \"keep-alive\");\n    res.flushHeaders();\n\n    const sendEvent = (data: string) => {\n        res.write(`data: ${JSON.stringify({ text: data })}\\n\\n`);\n    };\n\n    let systemPrompt = \"\";\n    try {\n        if (scope === \"account\" && scopeId) {\n            const ctx = await assembleAccountContext(scopeId, tenantId);\n            systemPrompt = await buildFullSystemPrompt(ctx);\n        } else {\n            const [corePrompt, portfolioCtx, agentStateRow] = await Promise.all([\n                getCoreSystemPrompt(),\n                buildPortfolioContext(tenantId),\n                readAgentState(tenantId, \"weekly-account-review\"),\n            ]);\n            const preamble = buildStatePreamble(agentStateRow as any);\n            systemPrompt = [\n                corePrompt,\n                preamble,\n                `PORTFOLIO CONTEXT:\\n${portfolioCtx}`,\n                `INSTRUCTIONS: You are an AI sales analyst. Answer the user's question using ONLY the portfolio data above. Be specific â€” cite account names, dollar amounts, scores, and days since last order. Format your response with clear structure (bullet points, bold headers). If the data doesn't contain the answer, say so specifically.\n\nACTION LINKS: When you mention an account by name, include a markdown link so the user can navigate directly. Use this format:\n  [Account Name](/accounts?highlight=ACCOUNT_ID)\nExample: [Midwest Pipe & Supply](/accounts?highlight=238)\n\nWhen you recommend actions, include step-by-step guidance with links. Use these app routes:\n  - View/manage accounts: /accounts?highlight=ACCOUNT_ID\n  - View playbooks & tasks: /playbooks\n  - View ICP profiles: /icp-builder\n  - View revenue tracking: /revenue\n  - View program performance: /program-performance\n  - Upload data: /data-uploads\n\nExample action step:\n  1. Open [Midwest Pipe & Supply](/accounts?highlight=238) to review category gaps\n  2. Go to [Playbooks](/playbooks) to generate a call script\n  3. Check [Revenue Tracking](/revenue) to monitor enrollment progress\n\nAlways include at least one \"Next Steps\" or \"Recommended Actions\" section with numbered steps and links when the question implies an action the user could take.`,\n            ]\n                .filter(Boolean)\n                .join(\"\\n\\n\");\n        }\n    } catch (err) {\n        console.error(\"[ask-anything] Context assembly error:\", err);\n        sendEvent(\"Error assembling context. Please try again.\");\n        res.write(\"data: [DONE]\\n\\n\");\n        res.end();\n        return;\n    }\n\n    let fullResponse = \"\";\n    let tokensUsed = 0;\n\n    try {\n        const stream = await openai.chat.completions.create({\n            model: \"gpt-4o\",\n            temperature: 0.4,\n            stream: true,\n            messages: [\n                { role: \"system\", content: systemPrompt },\n                { role: \"user\", content: question },\n            ],\n        });\n\n        for await (const chunk of stream) {\n            const delta = chunk.choices[0]?.delta?.content ?? \"\";\n            if (delta) {\n                fullResponse += delta;\n                sendEvent(delta);\n            }\n            if (chunk.usage) tokensUsed = chunk.usage.total_tokens ?? 0;\n        }\n    } catch (err) {\n        console.error(\"[ask-anything] OpenAI error:\", err);\n        sendEvent(\"\\n\\n[Error: Failed to get AI response. Please try again.]\");\n    }\n\n    res.write(\"data: [DONE]\\n\\n\");\n    res.end();\n\n    try {\n        await db.insert(agentQueryLog).values({\n            tenantId,\n            query: question,\n            responseText: fullResponse,\n            tokensUsed: tokensUsed || null,\n        });\n    } catch (err) {\n        console.error(\"[ask-anything] Failed to log query:\", err);\n    }\n}\n","path":null,"size_bytes":8591,"size_tokens":null},"server/replit_integrations/audio/client.ts":{"content":"import OpenAI, { toFile } from \"openai\";\nimport { Buffer } from \"node:buffer\";\nimport { spawn } from \"child_process\";\nimport { writeFile, unlink, readFile } from \"fs/promises\";\nimport { randomUUID } from \"crypto\";\nimport { tmpdir } from \"os\";\nimport { join } from \"path\";\n\nexport const openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\nexport type AudioFormat = \"wav\" | \"mp3\" | \"webm\" | \"mp4\" | \"ogg\" | \"unknown\";\n\n/**\n * Detect audio format from buffer magic bytes.\n * Supports: WAV, MP3, WebM (Chrome/Firefox), MP4/M4A/MOV (Safari/iOS), OGG\n */\nexport function detectAudioFormat(buffer: Buffer): AudioFormat {\n  if (buffer.length < 12) return \"unknown\";\n\n  // WAV: RIFF....WAVE\n  if (buffer[0] === 0x52 && buffer[1] === 0x49 && buffer[2] === 0x46 && buffer[3] === 0x46) {\n    return \"wav\";\n  }\n  // WebM: EBML header\n  if (buffer[0] === 0x1a && buffer[1] === 0x45 && buffer[2] === 0xdf && buffer[3] === 0xa3) {\n    return \"webm\";\n  }\n  // MP3: ID3 tag or frame sync\n  if (\n    (buffer[0] === 0xff && (buffer[1] === 0xfb || buffer[1] === 0xfa || buffer[1] === 0xf3)) ||\n    (buffer[0] === 0x49 && buffer[1] === 0x44 && buffer[2] === 0x33)\n  ) {\n    return \"mp3\";\n  }\n  // MP4/M4A/MOV: ....ftyp (Safari/iOS records in these containers)\n  if (buffer[4] === 0x66 && buffer[5] === 0x74 && buffer[6] === 0x79 && buffer[7] === 0x70) {\n    return \"mp4\";\n  }\n  // OGG: OggS\n  if (buffer[0] === 0x4f && buffer[1] === 0x67 && buffer[2] === 0x67 && buffer[3] === 0x53) {\n    return \"ogg\";\n  }\n  return \"unknown\";\n}\n\n/**\n * Convert any audio/video format to WAV using ffmpeg.\n * Uses temp files instead of pipes because video containers (MP4/MOV)\n * require seeking to find the audio track.\n */\nexport async function convertToWav(audioBuffer: Buffer): Promise<Buffer> {\n  const inputPath = join(tmpdir(), `input-${randomUUID()}`);\n  const outputPath = join(tmpdir(), `output-${randomUUID()}.wav`);\n\n  try {\n    // Write input to temp file (required for video containers that need seeking)\n    await writeFile(inputPath, audioBuffer);\n\n    // Run ffmpeg with file paths\n    await new Promise<void>((resolve, reject) => {\n      const ffmpeg = spawn(\"ffmpeg\", [\n        \"-i\", inputPath,\n        \"-vn\",              // Extract audio only (ignore video track)\n        \"-f\", \"wav\",\n        \"-ar\", \"16000\",     // 16kHz sample rate (good for speech)\n        \"-ac\", \"1\",         // Mono\n        \"-acodec\", \"pcm_s16le\",\n        \"-y\",               // Overwrite output\n        outputPath,\n      ]);\n\n      ffmpeg.stderr.on(\"data\", () => {}); // Suppress logs\n      ffmpeg.on(\"close\", (code) => {\n        if (code === 0) resolve();\n        else reject(new Error(`ffmpeg exited with code ${code}`));\n      });\n      ffmpeg.on(\"error\", reject);\n    });\n\n    // Read converted audio\n    return await readFile(outputPath);\n  } finally {\n    // Clean up temp files\n    await unlink(inputPath).catch(() => {});\n    await unlink(outputPath).catch(() => {});\n  }\n}\n\n/**\n * Auto-detect and convert audio to OpenAI-compatible format.\n * - WAV/MP3: Pass through (already compatible)\n * - WebM/MP4/OGG: Convert to WAV via ffmpeg\n */\nexport async function ensureCompatibleFormat(\n  audioBuffer: Buffer\n): Promise<{ buffer: Buffer; format: \"wav\" | \"mp3\" }> {\n  const detected = detectAudioFormat(audioBuffer);\n  if (detected === \"wav\") return { buffer: audioBuffer, format: \"wav\" };\n  if (detected === \"mp3\") return { buffer: audioBuffer, format: \"mp3\" };\n  // Convert WebM, MP4, OGG, or unknown to WAV\n  const wavBuffer = await convertToWav(audioBuffer);\n  return { buffer: wavBuffer, format: \"wav\" };\n}\n\n/**\n * Voice Chat: User speaks, LLM responds with audio (audio-in, audio-out).\n * Uses gpt-audio model via Replit AI Integrations.\n * Note: Browser records WebM/opus - convert to WAV using ffmpeg before calling this.\n */\nexport async function voiceChat(\n  audioBuffer: Buffer,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\",\n  inputFormat: \"wav\" | \"mp3\" = \"wav\",\n  outputFormat: \"wav\" | \"mp3\" = \"mp3\"\n): Promise<{ transcript: string; audioResponse: Buffer }> {\n  const audioBase64 = audioBuffer.toString(\"base64\");\n  const response = await openai.chat.completions.create({\n    model: \"gpt-audio\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format: outputFormat },\n    messages: [{\n      role: \"user\",\n      content: [\n        { type: \"input_audio\", input_audio: { data: audioBase64, format: inputFormat } },\n      ],\n    }],\n  });\n  const message = response.choices[0]?.message as any;\n  const transcript = message?.audio?.transcript || message?.content || \"\";\n  const audioData = message?.audio?.data ?? \"\";\n  return {\n    transcript,\n    audioResponse: Buffer.from(audioData, \"base64\"),\n  };\n}\n\n/**\n * Streaming Voice Chat: For real-time audio responses.\n * Note: Streaming only supports pcm16 output format.\n *\n * @example\n * // Converting browser WebM to WAV before calling:\n * const webmBuffer = Buffer.from(req.body.audio, \"base64\");\n * const wavBuffer = await convertWebmToWav(webmBuffer);\n * for await (const chunk of voiceChatStream(wavBuffer)) { ... }\n */\nexport async function voiceChatStream(\n  audioBuffer: Buffer,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\",\n  inputFormat: \"wav\" | \"mp3\" = \"wav\"\n): Promise<AsyncIterable<{ type: \"transcript\" | \"audio\"; data: string }>> {\n  const audioBase64 = audioBuffer.toString(\"base64\");\n  const stream = await openai.chat.completions.create({\n    model: \"gpt-audio\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format: \"pcm16\" },\n    messages: [{\n      role: \"user\",\n      content: [\n        { type: \"input_audio\", input_audio: { data: audioBase64, format: inputFormat } },\n      ],\n    }],\n    stream: true,\n  });\n\n  return (async function* () {\n    for await (const chunk of stream) {\n      const delta = chunk.choices?.[0]?.delta as any;\n      if (!delta) continue;\n      if (delta?.audio?.transcript) {\n        yield { type: \"transcript\", data: delta.audio.transcript };\n      }\n      if (delta?.audio?.data) {\n        yield { type: \"audio\", data: delta.audio.data };\n      }\n    }\n  })();\n}\n\n/**\n * Text-to-Speech: Converts text to speech verbatim.\n * Uses gpt-audio model via Replit AI Integrations.\n */\nexport async function textToSpeech(\n  text: string,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\",\n  format: \"wav\" | \"mp3\" | \"flac\" | \"opus\" | \"pcm16\" = \"wav\"\n): Promise<Buffer> {\n  const response = await openai.chat.completions.create({\n    model: \"gpt-audio\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format },\n    messages: [\n      { role: \"system\", content: \"You are an assistant that performs text-to-speech.\" },\n      { role: \"user\", content: `Repeat the following text verbatim: ${text}` },\n    ],\n  });\n  const audioData = (response.choices[0]?.message as any)?.audio?.data ?? \"\";\n  return Buffer.from(audioData, \"base64\");\n}\n\n/**\n * Streaming Text-to-Speech: Converts text to speech with real-time streaming.\n * Uses gpt-audio model via Replit AI Integrations.\n * Note: Streaming only supports pcm16 output format.\n */\nexport async function textToSpeechStream(\n  text: string,\n  voice: \"alloy\" | \"echo\" | \"fable\" | \"onyx\" | \"nova\" | \"shimmer\" = \"alloy\"\n): Promise<AsyncIterable<string>> {\n  const stream = await openai.chat.completions.create({\n    model: \"gpt-audio\",\n    modalities: [\"text\", \"audio\"],\n    audio: { voice, format: \"pcm16\" },\n    messages: [\n      { role: \"system\", content: \"You are an assistant that performs text-to-speech.\" },\n      { role: \"user\", content: `Repeat the following text verbatim: ${text}` },\n    ],\n    stream: true,\n  });\n\n  return (async function* () {\n    for await (const chunk of stream) {\n      const delta = chunk.choices?.[0]?.delta as any;\n      if (!delta) continue;\n      if (delta?.audio?.data) {\n        yield delta.audio.data;\n      }\n    }\n  })();\n}\n\n/**\n * Speech-to-Text: Transcribes audio using dedicated transcription model.\n * Uses gpt-4o-mini-transcribe for accurate transcription.\n */\nexport async function speechToText(\n  audioBuffer: Buffer,\n  format: \"wav\" | \"mp3\" | \"webm\" = \"wav\"\n): Promise<string> {\n  const file = await toFile(audioBuffer, `audio.${format}`);\n  const response = await openai.audio.transcriptions.create({\n    file,\n    model: \"gpt-4o-mini-transcribe\",\n  });\n  return response.text;\n}\n\n/**\n * Streaming Speech-to-Text: Transcribes audio with real-time streaming.\n * Uses gpt-4o-mini-transcribe for accurate transcription.\n */\nexport async function speechToTextStream(\n  audioBuffer: Buffer,\n  format: \"wav\" | \"mp3\" | \"webm\" = \"wav\"\n): Promise<AsyncIterable<string>> {\n  const file = await toFile(audioBuffer, `audio.${format}`);\n  const stream = await openai.audio.transcriptions.create({\n    file,\n    model: \"gpt-4o-mini-transcribe\",\n    stream: true,\n  });\n\n  return (async function* () {\n    for await (const event of stream) {\n      if (event.type === \"transcript.text.delta\") {\n        yield event.delta;\n      }\n    }\n  })();\n}\n","path":null,"size_bytes":9073,"size_tokens":null},"client/replit_integrations/audio/useVoiceStream.ts":{"content":"/**\n * React hook for handling SSE voice streaming responses.\n * Converts audio blob to base64 and sends as JSON to match server expectations.\n */\nimport { useCallback } from \"react\";\nimport { useAudioPlayback } from \"./useAudioPlayback\";\n\ninterface StreamCallbacks {\n  onUserTranscript?: (text: string) => void;\n  onTranscript?: (text: string, full: string) => void;\n  onComplete?: (transcript: string) => void;\n  onError?: (error: Error) => void;\n}\n\nexport function useVoiceStream(callbacks: StreamCallbacks = {}) {\n  const playback = useAudioPlayback();\n\n  const streamVoiceResponse = useCallback(\n    async (url: string, audioBlob: Blob) => {\n      await playback.init();\n      playback.clear();\n\n      // Convert blob to base64 for JSON body (server expects express.json())\n      const base64Audio = await new Promise<string>((resolve) => {\n        const fileReader = new FileReader();\n        fileReader.onload = () => {\n          const result = fileReader.result as string;\n          resolve(result.split(\",\")[1]); // Remove data URL prefix\n        };\n        fileReader.readAsDataURL(audioBlob);\n      });\n\n      const response = await fetch(url, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ audio: base64Audio }),\n      });\n      if (!response.ok) throw new Error(\"Voice request failed\");\n\n      const streamReader = response.body?.getReader();\n      if (!streamReader) throw new Error(\"No response body\");\n\n      const decoder = new TextDecoder();\n      let buffer = \"\";\n      let fullTranscript = \"\";\n\n      while (true) {\n        const { done, value } = await streamReader.read();\n        if (done) break;\n\n        buffer += decoder.decode(value, { stream: true });\n        const lines = buffer.split(\"\\n\");\n        buffer = lines.pop() || \"\";\n\n        for (const line of lines) {\n          if (!line.startsWith(\"data: \")) continue;\n\n          try {\n            const event = JSON.parse(line.slice(6));\n\n            switch (event.type) {\n              case \"user_transcript\":\n                callbacks.onUserTranscript?.(event.data);\n                break;\n              case \"transcript\":\n                fullTranscript += event.data;\n                callbacks.onTranscript?.(event.data, fullTranscript);\n                break;\n              case \"audio\":\n                playback.pushAudio(event.data);\n                break;\n              case \"done\":\n                playback.signalComplete();\n                callbacks.onComplete?.(fullTranscript);\n                break;\n              case \"error\":\n                throw new Error(event.error);\n            }\n          } catch (e) {\n            if (!(e instanceof SyntaxError)) {\n              callbacks.onError?.(e as Error);\n            }\n          }\n        }\n      }\n    },\n    [playback, callbacks]\n  );\n\n  return { streamVoiceResponse, playbackState: playback.state };\n}\n","path":null,"size_bytes":2914,"size_tokens":null},"server/storage.ts":{"content":"import { type User, type InsertUser, type AgentState, type Setting, type InsertSetting, agentSystemPrompts, agentState, settings } from \"@shared/schema\";\nimport { randomUUID } from \"crypto\";\nimport { db } from \"./db\";\nimport { eq, and, sql } from \"drizzle-orm\";\n\n// â”€â”€â”€ Interface â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport interface IStorage {\n  // Users\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n\n  // Agent system prompts\n  getAgentSystemPrompt(promptKey: string): Promise<{ content: string } | undefined>;\n\n  // Settings (key-value store)\n  getSetting(key: string): Promise<Setting | undefined>;\n  upsertSetting(setting: InsertSetting): Promise<Setting>;\n\n  // Agent state (rolling memory between runs)\n  getAgentState(tenantId: number, runType: string): Promise<AgentState | undefined>;\n  upsertAgentState(\n    tenantId: number,\n    runType: string,\n    data: Partial<Omit<AgentState, \"id\" | \"tenantId\" | \"agentRunType\">>,\n  ): Promise<void>;\n}\n\n// â”€â”€â”€ In-memory user store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n\n  constructor() {\n    this.users = new Map();\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(\n      (user) => user.username === username,\n    );\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const user: User = { ...insertUser, id };\n    this.users.set(id, user);\n    return user;\n  }\n\n  // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  async getSetting(key: string): Promise<Setting | undefined> {\n    try {\n      const rows = await db\n        .select()\n        .from(settings)\n        .where(eq(settings.key, key))\n        .limit(1);\n      return rows[0] ?? undefined;\n    } catch {\n      return undefined;\n    }\n  }\n\n  async upsertSetting(setting: InsertSetting): Promise<Setting> {\n    const existing = await this.getSetting(setting.key);\n    if (existing) {\n      const [updated] = await db\n        .update(settings)\n        .set({ value: setting.value, updatedAt: sql`CURRENT_TIMESTAMP` })\n        .where(eq(settings.key, setting.key))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db\n        .insert(settings)\n        .values(setting)\n        .returning();\n      return created;\n    }\n  }\n\n  // â”€â”€ Agent: System Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  async getAgentSystemPrompt(promptKey: string): Promise<{ content: string } | undefined> {\n    try {\n      const rows = await db\n        .select({ content: agentSystemPrompts.content })\n        .from(agentSystemPrompts)\n        .where(\n          and(\n            eq(agentSystemPrompts.promptKey, promptKey),\n            eq(agentSystemPrompts.isActive, true),\n          ),\n        )\n        .limit(1);\n      return rows[0] ?? undefined;\n    } catch {\n      return undefined; // Graceful fallback â€” table may not exist yet\n    }\n  }\n\n  // â”€â”€ Agent: State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  async getAgentState(tenantId: number, runType: string): Promise<AgentState | undefined> {\n    try {\n      const rows = await db\n        .select()\n        .from(agentState)\n        .where(\n          and(\n            eq(agentState.tenantId, tenantId),\n            eq(agentState.agentRunType, runType),\n          ),\n        )\n        .limit(1);\n      return rows[0] ?? undefined;\n    } catch {\n      return undefined;\n    }\n  }\n\n  async upsertAgentState(\n    tenantId: number,\n    runType: string,\n    data: Partial<Omit<AgentState, \"id\" | \"tenantId\" | \"agentRunType\">>,\n  ): Promise<void> {\n    try {\n      const existing = await this.getAgentState(tenantId, runType);\n      if (existing) {\n        await db\n          .update(agentState)\n          .set({ ...data, updatedAt: new Date() })\n          .where(\n            and(\n              eq(agentState.tenantId, tenantId),\n              eq(agentState.agentRunType, runType),\n            ),\n          );\n      } else {\n        await db.insert(agentState).values({\n          tenantId,\n          agentRunType: runType,\n          ...data,\n          updatedAt: new Date(),\n        });\n      }\n    } catch (err) {\n      console.error(\"[storage] upsertAgentState error:\", err);\n    }\n  }\n}\n\nexport const storage = new MemStorage();\n","path":null,"size_bytes":5242,"size_tokens":null},"client/src/components/data-table.tsx":{"content":"import {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\n\ninterface Column<T> {\n  key: string;\n  header: React.ReactNode;\n  cell?: (row: T) => React.ReactNode;\n  className?: string;\n}\n\ninterface DataTableProps<T> {\n  columns: Column<T>[];\n  data: T[];\n  isLoading?: boolean;\n  emptyMessage?: string;\n  testId?: string;\n  onRowClick?: (row: T) => void;\n}\n\nexport function DataTable<T>({\n  columns,\n  data,\n  isLoading,\n  emptyMessage = \"No data available\",\n  testId,\n  onRowClick,\n}: DataTableProps<T>) {\n  if (isLoading) {\n    return (\n      <div className=\"border rounded-md\" data-testid={testId}>\n        <Table>\n          <TableHeader>\n            <TableRow>\n              {columns.map((column) => (\n                <TableHead key={column.key} className={column.className}>\n                  {column.header}\n                </TableHead>\n              ))}\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {[...Array(5)].map((_, i) => (\n              <TableRow key={i}>\n                {columns.map((column) => (\n                  <TableCell key={column.key} className={column.className}>\n                    <Skeleton className=\"h-4 w-full\" />\n                  </TableCell>\n                ))}\n              </TableRow>\n            ))}\n          </TableBody>\n        </Table>\n      </div>\n    );\n  }\n\n  if (!data || data.length === 0) {\n    return (\n      <div\n        className=\"border rounded-md p-8 text-center text-muted-foreground\"\n        data-testid={testId}\n      >\n        {emptyMessage}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"border rounded-md\" data-testid={testId}>\n      <Table>\n        <TableHeader>\n          <TableRow>\n            {columns.map((column) => (\n              <TableHead key={column.key} className={column.className}>\n                {column.header}\n              </TableHead>\n            ))}\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {data.map((row, rowIndex) => (\n            <TableRow \n              key={rowIndex} \n              data-testid={`table-row-${rowIndex}`}\n              onClick={onRowClick ? () => onRowClick(row) : undefined}\n              className={onRowClick ? \"cursor-pointer hover-elevate\" : \"\"}\n            >\n              {columns.map((column) => (\n                <TableCell key={column.key} className={column.className}>\n                  {column.cell\n                    ? column.cell(row)\n                    : ((row as Record<string, unknown>)[column.key] as React.ReactNode)}\n                </TableCell>\n              ))}\n            </TableRow>\n          ))}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n","path":null,"size_bytes":2770,"size_tokens":null},"server/services/email-intelligence.ts":{"content":"/**\n * Email Intelligence Service â€” Phase 3\n *\n * POST /api/agent/email-intelligence\n * Body: { interactionId: number }\n *\n * Called when a new agent_interactions row is inserted with source='email'.\n * Extracts: sentiment, buying signals, competitor mentions, project mentions,\n *           urgency level, follow-up date suggestion.\n * If at_risk signal detected â†’ fires Resend alert to the assigned TM.\n */\n\nimport OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { db } from \"../db\";\nimport { agentInteractions, accounts } from \"@shared/schema\";\nimport { and, eq } from \"drizzle-orm\";\nimport { getCoreSystemPrompt, writeAgentMemo, AGENT_MEMO_INSTRUCTION } from \"./agent-identity\";\nimport { Resend } from \"resend\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\nconst resend = new Resend(process.env.RESEND_API_KEY);\n\nconst FROM_EMAIL = \"noreply@ignition.tenexity.ai\";\n\n// â”€â”€â”€ Response schema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst EmailIntelSchema = z.object({\n    sentiment: z.enum([\"positive\", \"neutral\", \"negative\", \"at_risk_signal\", \"competitor_mention\"]),\n    urgency: z.enum([\"immediate\", \"this_week\", \"monitor\"]),\n    buying_signal: z.string().nullable(),\n    competitor_mentioned: z.string().nullable(),\n    project_mentioned: z.string().nullable(),\n    follow_up_date_suggestion: z.string().nullable(), // ISO date string YYYY-MM-DD\n    summary: z.string().max(300),\n    at_risk: z.boolean(),\n    at_risk_reason: z.string().nullable(),\n    agent_memo: z.object({\n        last_run_summary: z.string(),\n        current_focus: z.string(),\n        pattern_notes_addition: z.string(),\n        anomalies_watching: z.array(z.object({\n            account_name: z.string(),\n            signal: z.string(),\n            watch_until_date: z.string(),\n        })),\n    }),\n});\n\n// â”€â”€â”€ At-risk alert email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function sendAtRiskAlert(\n    repEmail: string,\n    accountName: string,\n    reason: string,\n    emailSubject: string,\n    emailBody: string,\n): Promise<void> {\n    await resend.emails.send({\n        from: FROM_EMAIL,\n        to: repEmail,\n        subject: `âš ï¸ At-Risk Signal: ${accountName}`,\n        html: `\n      <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto;\">\n        <div style=\"background: #dc2626; color: white; padding: 16px; border-radius: 8px 8px 0 0;\">\n          <h2 style=\"margin: 0;\">âš ï¸ At-Risk Signal Detected</h2>\n        </div>\n        <div style=\"padding: 24px; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px;\">\n          <h3 style=\"color: #111;\">${accountName}</h3>\n          <p style=\"color: #dc2626; font-weight: 600;\">${reason}</p>\n          <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 16px 0;\" />\n          <p style=\"color: #555; font-size: 14px;\"><strong>Email that triggered this alert:</strong></p>\n          <p style=\"color: #555; font-size: 14px;\"><em>Subject: ${emailSubject}</em></p>\n          <p style=\"color: #555; font-size: 14px; white-space: pre-wrap;\">${emailBody?.slice(0, 500)}...</p>\n          <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 16px 0;\" />\n          <p style=\"color: #888; font-size: 12px;\">Sent by Wallet Share Expander Â· Revenue Intelligence Agent</p>\n        </div>\n      </div>\n    `,\n    });\n    console.log(`[email-intelligence] At-risk alert sent for ${accountName} to ${repEmail}`);\n}\n\n// â”€â”€â”€ Main service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function analyzeEmailIntelligence(\n    interactionId: number,\n    tenantId: number,\n): Promise<z.infer<typeof EmailIntelSchema>> {\n    // 1. Load the interaction\n    const [interaction] = await db.select().from(agentInteractions)\n        .where(and(eq(agentInteractions.id, interactionId), eq(agentInteractions.tenantId, tenantId)));\n\n    if (!interaction) throw new Error(`Interaction ${interactionId} not found`);\n\n    // 2. Load the account for context\n    const [account] = await db.select().from(accounts)\n        .where(and(eq(accounts.id, interaction.accountId), eq(accounts.tenantId, tenantId)));\n\n    const corePrompt = await getCoreSystemPrompt();\n\n    // 3. Call OpenAI\n    const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        temperature: 0.2,\n        response_format: { type: \"json_object\" },\n        messages: [\n            { role: \"system\", content: corePrompt },\n            {\n                role: \"user\",\n                content: [\n                    `Analyze this email from/about contractor account \"${account?.name ?? \"Unknown\"}\" (segment: ${account?.segment ?? \"?\"}).`,\n                    \"\",\n                    `EMAIL SUBJECT: ${interaction.subject ?? \"(no subject)\"}`,\n                    `EMAIL BODY:\\n${interaction.body ?? \"(no body)\"}`,\n                    \"\",\n                    \"Extract the following and return as JSON:\",\n                    \"- sentiment: positive | neutral | negative | at_risk_signal | competitor_mention\",\n                    \"- urgency: immediate | this_week | monitor\",\n                    \"- buying_signal: what product/category they seem ready to buy, or null\",\n                    \"- competitor_mentioned: name of competitor if any, or null\",\n                    \"- project_mentioned: project name or type if mentioned, or null\",\n                    \"- follow_up_date_suggestion: ISO date YYYY-MM-DD within 30 days, or null\",\n                    \"- summary: 1-2 sentence summary of the intel value\",\n                    \"- at_risk: boolean â€” true if this signals potential churn or major dissatisfaction\",\n                    \"- at_risk_reason: explain why at_risk=true, or null\",\n                    AGENT_MEMO_INSTRUCTION,\n                ].join(\"\\n\"),\n            },\n        ],\n    });\n\n    const raw = JSON.parse(completion.choices[0].message.content ?? \"{}\");\n    const parsed = EmailIntelSchema.parse(raw);\n\n    // 4. Update the interaction row with extracted intel\n    await db.update(agentInteractions)\n        .set({\n            sentiment: parsed.sentiment,\n            urgency: parsed.urgency,\n            buyingSignal: parsed.buying_signal,\n            competitorMentioned: parsed.competitor_mentioned,\n            projectMentioned: parsed.project_mentioned,\n            followUpDate: parsed.follow_up_date_suggestion ? new Date(parsed.follow_up_date_suggestion) : null,\n            aiAnalyzed: true,\n        })\n        .where(eq(agentInteractions.id, interactionId));\n\n    // 5. Fire at-risk alert if warranted\n    if (parsed.at_risk && account?.assignedTm) {\n        try {\n            await sendAtRiskAlert(\n                account.assignedTm,\n                account.name,\n                parsed.at_risk_reason ?? \"Negative sentiment detected in email\",\n                interaction.subject ?? \"(no subject)\",\n                interaction.body ?? \"\",\n            );\n        } catch (err) {\n            console.error(\"[email-intelligence] Failed to send at-risk alert:\", err);\n        }\n    }\n\n    // 6. Write agent memo\n    await writeAgentMemo(tenantId, \"email-intelligence\", parsed.agent_memo);\n\n    console.log(`[email-intelligence] Interaction ${interactionId}: sentiment=${parsed.sentiment}, at_risk=${parsed.at_risk}`);\n    return parsed;\n}\n","path":null,"size_bytes":7667,"size_tokens":null},"client/src/pages/revenue.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DataTable } from \"@/components/data-table\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { ProgressRing } from \"@/components/progress-ring\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  TrendingUp,\n  DollarSign,\n  Target,\n  Users,\n  Download,\n  Plus,\n  Calendar,\n  ArrowUpRight,\n  ArrowDownRight,\n  Percent,\n  HelpCircle,\n  Loader2,\n  Sparkles,\n  GraduationCap,\n  Trophy,\n  CheckCircle2,\n  Clock,\n  ChevronRight,\n  Award,\n} from \"lucide-react\";\nimport {\n  Tooltip as TooltipComponent,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  LineChart,\n  Line,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip,\n  ResponsiveContainer,\n  Legend,\n  Area,\n  AreaChart,\n} from \"recharts\";\n\ninterface EnrolledAccount {\n  id: number;\n  accountId: number;\n  accountName: string;\n  segment: string;\n  enrolledAt: string;\n  baselineRevenue: number;\n  currentRevenue: number;\n  incrementalRevenue: number;\n  shareRate: number;\n  status: \"active\" | \"paused\" | \"graduated\";\n  // Graduation objectives\n  targetPenetration?: number | null;\n  targetIncrementalRevenue?: number | null;\n  targetDurationMonths?: number | null;\n  graduationCriteria?: string | null;\n  graduatedAt?: string | null;\n  graduationNotes?: string | null;\n}\n\ninterface GraduationProgress {\n  programAccountId: number;\n  accountId: number;\n  accountName: string;\n  status: string;\n  graduationCriteria: string;\n  hasObjectives: boolean;\n  isReadyToGraduate: boolean;\n  objectives: {\n    penetration: { current: number; target: number | null; progress: number | null; isMet: boolean };\n    revenue: { current: number; target: number | null; progress: number | null; isMet: boolean };\n    duration: { current: number; target: number | null; progress: number | null; isMet: boolean };\n  };\n  enrolledAt: string;\n  graduatedAt: string | null;\n}\n\ninterface GraduationReadyResponse {\n  count: number;\n  accounts: Array<{\n    programAccountId: number;\n    accountId: number;\n    accountName: string;\n    enrolledAt: string;\n    objectivesMet: { penetration: boolean; revenue: boolean; duration: boolean };\n  }>;\n}\n\ninterface RevenueSnapshot {\n  period: string;\n  baselineRevenue: number;\n  actualRevenue: number;\n  incrementalRevenue: number;\n}\n\ninterface Account {\n  id: number;\n  name: string;\n  segment: string | null;\n}\n\nexport default function Revenue() {\n  const [periodFilter, setPeriodFilter] = useState<string>(\"12m\");\n  const [showEnrollDialog, setShowEnrollDialog] = useState(false);\n  const [selectedAccountId, setSelectedAccountId] = useState<string>(\"\");\n  const [shareRate, setShareRate] = useState<string>(\"15\");\n  const [baselinePeriod, setBaselinePeriod] = useState<string>(\"12m\");\n  const [isEnrolling, setIsEnrolling] = useState(false);\n  \n  // Graduation state\n  const [showGraduateDialog, setShowGraduateDialog] = useState(false);\n  const [showObjectivesDialog, setShowObjectivesDialog] = useState(false);\n  const [selectedProgramAccountId, setSelectedProgramAccountId] = useState<number | null>(null);\n  const [graduationNotes, setGraduationNotes] = useState<string>(\"\");\n  const [isGraduating, setIsGraduating] = useState(false);\n  const [viewMode, setViewMode] = useState<\"active\" | \"graduated\">(\"active\");\n  \n  // Objective form state\n  const [targetPenetration, setTargetPenetration] = useState<string>(\"\");\n  const [targetIncrementalRevenue, setTargetIncrementalRevenue] = useState<string>(\"\");\n  const [targetDurationMonths, setTargetDurationMonths] = useState<string>(\"\");\n  const [graduationCriteria, setGraduationCriteria] = useState<string>(\"any\");\n  const [isSavingObjectives, setIsSavingObjectives] = useState(false);\n  \n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n\n  const { data: enrolledAccounts, isLoading } = useQuery<EnrolledAccount[]>({\n    queryKey: [\"/api/program-accounts\"],\n  });\n\n  const { data: allAccounts } = useQuery<Account[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  const { data: graduationReady } = useQuery<GraduationReadyResponse>({\n    queryKey: [\"/api/program-accounts/graduation-ready\"],\n  });\n\n  const enrolledAccountIds = new Set(enrolledAccounts?.map(a => a.accountId) || []);\n  const availableAccounts = allAccounts?.filter(a => !enrolledAccountIds.has(a.id)) || [];\n\n  // Mock data for demonstration\n  const mockEnrolledAccounts: EnrolledAccount[] = [\n    {\n      id: 1,\n      accountId: 1,\n      accountName: \"ABC Plumbing Co\",\n      segment: \"Plumbing\",\n      enrolledAt: \"2023-10-15\",\n      baselineRevenue: 110000,\n      currentRevenue: 145000,\n      incrementalRevenue: 35000,\n      shareRate: 0.15,\n      status: \"active\",\n    },\n    {\n      id: 2,\n      accountId: 2,\n      accountName: \"Elite HVAC Services\",\n      segment: \"HVAC\",\n      enrolledAt: \"2023-11-01\",\n      baselineRevenue: 195000,\n      currentRevenue: 242000,\n      incrementalRevenue: 47000,\n      shareRate: 0.15,\n      status: \"active\",\n    },\n    {\n      id: 3,\n      accountId: 5,\n      accountName: \"Climate Control Inc\",\n      segment: \"HVAC\",\n      enrolledAt: \"2023-09-20\",\n      baselineRevenue: 280000,\n      currentRevenue: 348000,\n      incrementalRevenue: 68000,\n      shareRate: 0.15,\n      status: \"active\",\n    },\n    {\n      id: 4,\n      accountId: 7,\n      accountName: \"Valley Mechanical\",\n      segment: \"Mechanical\",\n      enrolledAt: \"2023-12-01\",\n      baselineRevenue: 85000,\n      currentRevenue: 98000,\n      incrementalRevenue: 13000,\n      shareRate: 0.15,\n      status: \"active\",\n    },\n  ];\n\n  const mockRevenueData: RevenueSnapshot[] = [\n    { period: \"Aug\", baselineRevenue: 56000, actualRevenue: 58000, incrementalRevenue: 2000 },\n    { period: \"Sep\", baselineRevenue: 58000, actualRevenue: 65000, incrementalRevenue: 7000 },\n    { period: \"Oct\", baselineRevenue: 55000, actualRevenue: 72000, incrementalRevenue: 17000 },\n    { period: \"Nov\", baselineRevenue: 62000, actualRevenue: 85000, incrementalRevenue: 23000 },\n    { period: \"Dec\", baselineRevenue: 48000, actualRevenue: 78000, incrementalRevenue: 30000 },\n    { period: \"Jan\", baselineRevenue: 52000, actualRevenue: 94000, incrementalRevenue: 42000 },\n  ];\n\n  const allDisplayAccounts = enrolledAccounts || mockEnrolledAccounts;\n  const activeAccounts = allDisplayAccounts.filter(a => a.status === \"active\" || a.status === \"paused\");\n  const graduatedAccounts = allDisplayAccounts.filter(a => a.status === \"graduated\");\n  const displayAccounts = viewMode === \"active\" ? activeAccounts : graduatedAccounts;\n\n  const totalBaseline = activeAccounts.reduce((sum, a) => sum + a.baselineRevenue, 0);\n  const totalCurrent = displayAccounts.reduce((sum, a) => sum + a.currentRevenue, 0);\n  const totalIncremental = displayAccounts.reduce((sum, a) => sum + a.incrementalRevenue, 0);\n  const growthRate = ((totalCurrent - totalBaseline) / totalBaseline) * 100;\n\n  const formatCurrency = (value: number) => {\n    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;\n    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;\n    return `$${value.toFixed(0)}`;\n  };\n\n  // Check if account is ready to graduate\n  const isAccountReadyToGraduate = (accountId: number) => {\n    return graduationReady?.accounts.some(a => a.programAccountId === accountId) || false;\n  };\n\n  // Handle graduate account\n  const handleGraduate = async () => {\n    if (!selectedProgramAccountId) return;\n    \n    setIsGraduating(true);\n    try {\n      await apiRequest(\"POST\", `/api/program-accounts/${selectedProgramAccountId}/graduate`, {\n        notes: graduationNotes || undefined,\n      });\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/program-accounts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/program-accounts/graduation-ready\"] });\n      \n      setShowGraduateDialog(false);\n      setGraduationNotes(\"\");\n      \n      toast({\n        title: \"Account graduated\",\n        description: \"The account has successfully completed the growth program!\",\n      });\n    } catch (error) {\n      console.error(\"Graduation error:\", error);\n      toast({\n        title: \"Graduation failed\",\n        description: \"Failed to graduate account. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsGraduating(false);\n    }\n  };\n\n  // Handle save objectives\n  const handleSaveObjectives = async () => {\n    if (!selectedProgramAccountId) return;\n    \n    setIsSavingObjectives(true);\n    try {\n      await apiRequest(\"PATCH\", `/api/program-accounts/${selectedProgramAccountId}`, {\n        targetPenetration: targetPenetration ? parseFloat(targetPenetration) : null,\n        targetIncrementalRevenue: targetIncrementalRevenue ? parseFloat(targetIncrementalRevenue) : null,\n        targetDurationMonths: targetDurationMonths ? parseInt(targetDurationMonths) : null,\n        graduationCriteria,\n      });\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/program-accounts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/program-accounts/graduation-ready\"] });\n      \n      setShowObjectivesDialog(false);\n      \n      toast({\n        title: \"Objectives saved\",\n        description: \"Graduation objectives have been updated.\",\n      });\n    } catch (error) {\n      console.error(\"Save objectives error:\", error);\n      toast({\n        title: \"Failed to save\",\n        description: \"Failed to save objectives. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSavingObjectives(false);\n    }\n  };\n\n  // Open objectives dialog with current values\n  const openObjectivesDialog = (account: EnrolledAccount) => {\n    setSelectedProgramAccountId(account.id);\n    setTargetPenetration(account.targetPenetration?.toString() || \"\");\n    setTargetIncrementalRevenue(account.targetIncrementalRevenue?.toString() || \"\");\n    setTargetDurationMonths(account.targetDurationMonths?.toString() || \"\");\n    setGraduationCriteria(account.graduationCriteria || \"any\");\n    setShowObjectivesDialog(true);\n  };\n\n  const columns = [\n    {\n      key: \"accountName\",\n      header: \"Account\",\n      cell: (row: EnrolledAccount) => (\n        <div className=\"flex flex-col\">\n          <span className=\"font-medium\">{row.accountName}</span>\n          <span className=\"text-xs text-muted-foreground\">{row.segment}</span>\n        </div>\n      ),\n    },\n    {\n      key: \"enrolledAt\",\n      header: \"Enrolled\",\n      cell: (row: EnrolledAccount) => (\n        <span className=\"text-muted-foreground\">\n          {new Date(row.enrolledAt).toLocaleDateString()}\n        </span>\n      ),\n    },\n    {\n      key: \"baselineRevenue\",\n      header: \"Baseline\",\n      cell: (row: EnrolledAccount) => (\n        <span>{formatCurrency(row.baselineRevenue)}</span>\n      ),\n    },\n    {\n      key: \"currentRevenue\",\n      header: \"Current (12M)\",\n      cell: (row: EnrolledAccount) => (\n        <span className=\"font-medium\">{formatCurrency(row.currentRevenue)}</span>\n      ),\n    },\n    {\n      key: \"incrementalRevenue\",\n      header: \"Incremental\",\n      cell: (row: EnrolledAccount) => {\n        const growth = ((row.currentRevenue - row.baselineRevenue) / row.baselineRevenue) * 100;\n        return (\n          <div className=\"flex items-center gap-2\">\n            <span className=\"font-semibold text-chart-2\">\n              {formatCurrency(row.incrementalRevenue)}\n            </span>\n            <Badge variant=\"outline\" className=\"text-chart-2 border-chart-2/30 bg-chart-2/10\">\n              <ArrowUpRight className=\"h-3 w-3 mr-1\" />\n              {growth.toFixed(0)}%\n            </Badge>\n          </div>\n        );\n      },\n    },\n    {\n      key: \"status\",\n      header: \"Status\",\n      cell: (row: EnrolledAccount) => {\n        const isReady = isAccountReadyToGraduate(row.id);\n        if (row.status === \"graduated\") {\n          return (\n            <Badge variant=\"secondary\" className=\"bg-chart-2/10 text-chart-2 border-chart-2/30\">\n              <Trophy className=\"h-3 w-3 mr-1\" />\n              Graduated\n            </Badge>\n          );\n        }\n        return (\n          <div className=\"flex items-center gap-2\">\n            <Badge variant={row.status === \"active\" ? \"default\" : \"secondary\"}>\n              {row.status}\n            </Badge>\n            {isReady && (\n              <Badge variant=\"outline\" className=\"bg-chart-2/10 text-chart-2 border-chart-2/30\">\n                <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n                Ready\n              </Badge>\n            )}\n          </div>\n        );\n      },\n    },\n    {\n      key: \"actions\",\n      header: \"Actions\",\n      cell: (row: EnrolledAccount) => {\n        if (row.status === \"graduated\") {\n          return (\n            <span className=\"text-sm text-muted-foreground\">\n              {row.graduatedAt ? new Date(row.graduatedAt).toLocaleDateString() : \"Completed\"}\n            </span>\n          );\n        }\n        const isReady = isAccountReadyToGraduate(row.id);\n        const hasObjectives = row.targetPenetration || row.targetIncrementalRevenue || row.targetDurationMonths;\n        return (\n          <div className=\"flex items-center gap-1\">\n            <TooltipComponent>\n              <TooltipTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => openObjectivesDialog(row)}\n                  data-testid={`button-set-objectives-${row.id}`}\n                >\n                  <Target className=\"h-4 w-4\" />\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                {hasObjectives ? \"Edit graduation objectives\" : \"Set graduation objectives\"}\n              </TooltipContent>\n            </TooltipComponent>\n            {isReady && (\n              <TooltipComponent>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"text-chart-2\"\n                    onClick={() => {\n                      setSelectedProgramAccountId(row.id);\n                      setShowGraduateDialog(true);\n                    }}\n                    data-testid={`button-graduate-${row.id}`}\n                  >\n                    <GraduationCap className=\"h-4 w-4\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>Graduate account</TooltipContent>\n              </TooltipComponent>\n            )}\n          </div>\n        );\n      },\n    },\n  ];\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-revenue\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Revenue Tracking</h1>\n          <p className=\"text-muted-foreground\">\n            Monitor program performance and track revenue growth\n          </p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Select value={periodFilter} onValueChange={setPeriodFilter}>\n            <SelectTrigger className=\"w-32\">\n              <Calendar className=\"h-4 w-4 mr-2\" />\n              <SelectValue placeholder=\"Period\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"3m\">Last 3 months</SelectItem>\n              <SelectItem value=\"6m\">Last 6 months</SelectItem>\n              <SelectItem value=\"12m\">Last 12 months</SelectItem>\n              <SelectItem value=\"ytd\">Year to date</SelectItem>\n            </SelectContent>\n          </Select>\n          <Button variant=\"outline\" data-testid=\"button-export-revenue\">\n            <Download className=\"mr-2 h-4 w-4\" />\n            Export Report\n          </Button>\n          <TooltipComponent>\n            <TooltipTrigger asChild>\n              <Button onClick={() => setShowEnrollDialog(true)} data-testid=\"button-enroll-account\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Enroll Account\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n              Add an account to the revenue growth program to track incremental revenue above their baseline.\n            </TooltipContent>\n          </TooltipComponent>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary/10\">\n                  <Target className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{displayAccounts.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Enrolled Accounts</p>\n                </div>\n              </div>\n              <TooltipComponent>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-revenue-enrolled\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Accounts actively enrolled in the revenue growth program, tracking incremental revenue above their established baseline.</p>\n                </TooltipContent>\n              </TooltipComponent>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-2/10\">\n                  <TrendingUp className=\"h-5 w-5 text-chart-2\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{formatCurrency(totalIncremental)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Incremental Revenue</p>\n                </div>\n              </div>\n              <TooltipComponent>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-revenue-incremental\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Total revenue generated above baseline across all enrolled accounts. This represents the new wallet share captured through your sales efforts.</p>\n                </TooltipContent>\n              </TooltipComponent>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-3/10\">\n                  <Percent className=\"h-5 w-5 text-chart-3\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">+{growthRate.toFixed(0)}%</p>\n                  <p className=\"text-xs text-muted-foreground\">vs Baseline</p>\n                </div>\n              </div>\n              <TooltipComponent>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-revenue-growth\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Percentage growth of current revenue compared to the baseline period. Higher growth rates indicate successful wallet share capture.</p>\n                </TooltipContent>\n              </TooltipComponent>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Revenue Trend</CardTitle>\n          <CardDescription>Baseline vs Actual revenue over time</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"h-72\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <AreaChart data={mockRevenueData}>\n                <defs>\n                  <linearGradient id=\"colorActual\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                    <stop offset=\"5%\" stopColor=\"hsl(var(--chart-2))\" stopOpacity={0.3} />\n                    <stop offset=\"95%\" stopColor=\"hsl(var(--chart-2))\" stopOpacity={0} />\n                  </linearGradient>\n                </defs>\n                <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                <XAxis\n                  dataKey=\"period\"\n                  tick={{ fill: \"hsl(var(--muted-foreground))\", fontSize: 12 }}\n                  axisLine={{ stroke: \"hsl(var(--border))\" }}\n                />\n                <YAxis\n                  tickFormatter={(value) => formatCurrency(value)}\n                  tick={{ fill: \"hsl(var(--muted-foreground))\", fontSize: 12 }}\n                  axisLine={{ stroke: \"hsl(var(--border))\" }}\n                />\n                <Tooltip\n                  formatter={(value: number) => [formatCurrency(value)]}\n                  contentStyle={{\n                    backgroundColor: \"hsl(var(--popover))\",\n                    border: \"1px solid hsl(var(--border))\",\n                    borderRadius: \"var(--radius)\",\n                  }}\n                />\n                <Legend />\n                <Line\n                  type=\"monotone\"\n                  dataKey=\"baselineRevenue\"\n                  name=\"Baseline\"\n                  stroke=\"hsl(var(--muted-foreground))\"\n                  strokeDasharray=\"5 5\"\n                  strokeWidth={2}\n                  dot={false}\n                />\n                <Area\n                  type=\"monotone\"\n                  dataKey=\"actualRevenue\"\n                  name=\"Actual\"\n                  stroke=\"hsl(var(--chart-2))\"\n                  fill=\"url(#colorActual)\"\n                  strokeWidth={2}\n                />\n              </AreaChart>\n            </ResponsiveContainer>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Graduation Ready Alert */}\n      {graduationReady && graduationReady.count > 0 && viewMode === \"active\" && (\n        <Card className=\"border-chart-2/30 bg-chart-2/5\">\n          <CardContent className=\"py-4\">\n            <div className=\"flex items-center justify-between flex-wrap gap-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-chart-2/20\">\n                  <GraduationCap className=\"h-5 w-5 text-chart-2\" />\n                </div>\n                <div>\n                  <p className=\"font-semibold text-chart-2\">\n                    {graduationReady.count} Account{graduationReady.count > 1 ? \"s\" : \"\"} Ready to Graduate\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    These accounts have achieved their objectives and can be graduated from the program.\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex gap-2 flex-wrap\">\n                {graduationReady.accounts.slice(0, 3).map(acc => (\n                  <Badge \n                    key={acc.programAccountId} \n                    variant=\"outline\"\n                    className=\"bg-background\"\n                  >\n                    <Trophy className=\"h-3 w-3 mr-1 text-chart-2\" />\n                    {acc.accountName}\n                  </Badge>\n                ))}\n                {graduationReady.count > 3 && (\n                  <Badge variant=\"outline\" className=\"bg-background\">\n                    +{graduationReady.count - 3} more\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2 flex-wrap\">\n          <div>\n            <CardTitle className=\"text-base\">\n              {viewMode === \"active\" ? \"Enrolled Accounts\" : \"Graduated Accounts\"}\n            </CardTitle>\n            <CardDescription>\n              {viewMode === \"active\" \n                ? \"Track revenue performance by enrolled account\" \n                : \"Accounts that successfully completed the growth program\"\n              }\n            </CardDescription>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Button\n              variant={viewMode === \"active\" ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => setViewMode(\"active\")}\n              data-testid=\"button-view-active\"\n            >\n              <Target className=\"h-4 w-4 mr-1\" />\n              Active ({activeAccounts.length})\n            </Button>\n            <Button\n              variant={viewMode === \"graduated\" ? \"default\" : \"outline\"}\n              size=\"sm\"\n              onClick={() => setViewMode(\"graduated\")}\n              data-testid=\"button-view-graduated\"\n            >\n              <Trophy className=\"h-4 w-4 mr-1\" />\n              Graduated ({graduatedAccounts.length})\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {displayAccounts.length === 0 ? (\n            <EmptyState\n              icon={viewMode === \"active\" ? Target : Trophy}\n              title={viewMode === \"active\" ? \"No enrolled accounts\" : \"No graduated accounts yet\"}\n              description={\n                viewMode === \"active\" \n                  ? \"Enroll accounts to start tracking revenue growth\" \n                  : \"Accounts that complete their objectives will appear here\"\n              }\n              action={viewMode === \"active\" ? {\n                label: \"Enroll Account\",\n                onClick: () => setShowEnrollDialog(true),\n              } : undefined}\n              testId={viewMode === \"active\" ? \"empty-enrolled\" : \"empty-graduated\"}\n            />\n          ) : (\n            <DataTable\n              columns={columns}\n              data={displayAccounts}\n              isLoading={isLoading}\n              testId={viewMode === \"active\" ? \"table-enrolled\" : \"table-graduated\"}\n            />\n          )}\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Program Summary</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-3 gap-6\">\n            <div className=\"text-center p-4 rounded-md bg-muted/50\">\n              <p className=\"text-3xl font-bold\">{formatCurrency(totalBaseline)}</p>\n              <p className=\"text-sm text-muted-foreground mt-1\">Total Baseline</p>\n            </div>\n            <div className=\"text-center p-4 rounded-md bg-muted/50\">\n              <p className=\"text-3xl font-bold\">{formatCurrency(totalCurrent)}</p>\n              <p className=\"text-sm text-muted-foreground mt-1\">Current Revenue</p>\n            </div>\n            <div className=\"text-center p-4 rounded-md bg-chart-2/10\">\n              <p className=\"text-3xl font-bold text-chart-2\">\n                {formatCurrency(totalIncremental)}\n              </p>\n              <p className=\"text-sm text-muted-foreground mt-1\">Incremental Growth</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={showEnrollDialog} onOpenChange={(open) => {\n        setShowEnrollDialog(open);\n        if (!open) {\n          setSelectedAccountId(\"\");\n          setShareRate(\"15\");\n          setBaselinePeriod(\"12m\");\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Enroll Account in Growth Program</DialogTitle>\n            <DialogDescription>\n              When you enroll an account, an AI-powered playbook will be automatically generated with targeted tasks based on identified opportunity gaps.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Select Account</Label>\n              <Select value={selectedAccountId} onValueChange={setSelectedAccountId}>\n                <SelectTrigger data-testid=\"select-enroll-account\">\n                  <SelectValue placeholder=\"Choose an account\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {availableAccounts.length === 0 ? (\n                    <SelectItem value=\"_none\" disabled>No accounts available</SelectItem>\n                  ) : (\n                    availableAccounts.map(account => (\n                      <SelectItem key={account.id} value={account.id.toString()}>\n                        {account.name} {account.segment && `(${account.segment})`}\n                      </SelectItem>\n                    ))\n                  )}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Rev-Share Rate (%)</Label>\n              <Input \n                type=\"number\" \n                value={shareRate} \n                onChange={(e) => setShareRate(e.target.value)}\n                data-testid=\"input-share-rate\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Baseline Period</Label>\n              <Select value={baselinePeriod} onValueChange={setBaselinePeriod}>\n                <SelectTrigger data-testid=\"select-baseline-period\">\n                  <SelectValue placeholder=\"Select period\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"6m\">Last 6 months</SelectItem>\n                  <SelectItem value=\"12m\">Last 12 months</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <div className=\"bg-primary/5 border border-primary/20 rounded-md p-3\">\n              <div className=\"flex items-start gap-2\">\n                <Sparkles className=\"h-4 w-4 text-primary mt-0.5\" />\n                <div className=\"text-sm\">\n                  <p className=\"font-medium text-primary\">AI Playbook Auto-Generation</p>\n                  <p className=\"text-muted-foreground mt-1\">\n                    A personalized growth playbook with sales tasks, call scripts, and email templates will be created automatically for this account.\n                  </p>\n                </div>\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowEnrollDialog(false)} disabled={isEnrolling}>\n              Cancel\n            </Button>\n            <Button \n              onClick={async () => {\n                if (!selectedAccountId) {\n                  toast({ title: \"Select an account\", description: \"Please select an account to enroll\", variant: \"destructive\" });\n                  return;\n                }\n                \n                setIsEnrolling(true);\n                try {\n                  const months = baselinePeriod === \"6m\" ? 6 : 12;\n                  const baselineStart = new Date();\n                  baselineStart.setMonth(baselineStart.getMonth() - months);\n                  const baselineEnd = new Date();\n                  \n                  const response = await apiRequest(\"POST\", \"/api/program-accounts\", {\n                    accountId: parseInt(selectedAccountId),\n                    baselineStart: baselineStart.toISOString(),\n                    baselineEnd: baselineEnd.toISOString(),\n                    baselineRevenue: \"100000\",\n                    shareRate: (parseFloat(shareRate) / 100).toString(),\n                    status: \"active\",\n                  });\n                  \n                  const data = await response.json();\n                  \n                  queryClient.invalidateQueries({ queryKey: [\"/api/program-accounts\"] });\n                  queryClient.invalidateQueries({ queryKey: [\"/api/playbooks\"] });\n                  queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n                  \n                  setShowEnrollDialog(false);\n                  \n                  if (data.playbook) {\n                    toast({\n                      title: \"Account enrolled with playbook\",\n                      description: `Created ${data.playbook.tasksGenerated} AI-generated tasks. View the playbook now?`,\n                      action: (\n                        <Button size=\"sm\" variant=\"outline\" onClick={() => navigate(\"/playbooks\")}>\n                          View Playbook\n                        </Button>\n                      ),\n                    });\n                  } else {\n                    toast({\n                      title: \"Account enrolled\",\n                      description: \"The account has been enrolled in the growth program.\",\n                    });\n                  }\n                } catch (error) {\n                  console.error(\"Enrollment error:\", error);\n                  toast({\n                    title: \"Enrollment failed\",\n                    description: \"Failed to enroll account. Please try again.\",\n                    variant: \"destructive\",\n                  });\n                } finally {\n                  setIsEnrolling(false);\n                }\n              }}\n              disabled={isEnrolling || !selectedAccountId}\n              data-testid=\"button-confirm-enroll\"\n            >\n              {isEnrolling ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Enrolling...\n                </>\n              ) : (\n                <>\n                  <Target className=\"mr-2 h-4 w-4\" />\n                  Enroll & Generate Playbook\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Graduate Account Dialog */}\n      <Dialog open={showGraduateDialog} onOpenChange={(open) => {\n        setShowGraduateDialog(open);\n        if (!open) {\n          setGraduationNotes(\"\");\n          setSelectedProgramAccountId(null);\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <GraduationCap className=\"h-5 w-5 text-chart-2\" />\n              Graduate Account\n            </DialogTitle>\n            <DialogDescription>\n              This account has met its graduation objectives. Graduating will mark it as successfully completed and move it to the alumni section.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"bg-chart-2/10 border border-chart-2/30 rounded-md p-4\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <Trophy className=\"h-5 w-5 text-chart-2\" />\n                <span className=\"font-semibold text-chart-2\">Objectives Achieved</span>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                This account has successfully completed the growth program and achieved its targets.\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <Label>Graduation Notes (Optional)</Label>\n              <Textarea\n                placeholder=\"Add any notes about this account's success...\"\n                value={graduationNotes}\n                onChange={(e) => setGraduationNotes(e.target.value)}\n                rows={3}\n                data-testid=\"textarea-graduation-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowGraduateDialog(false)} disabled={isGraduating}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleGraduate}\n              disabled={isGraduating}\n              className=\"bg-chart-2 hover-elevate\"\n              data-testid=\"button-confirm-graduate\"\n            >\n              {isGraduating ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Graduating...\n                </>\n              ) : (\n                <>\n                  <GraduationCap className=\"mr-2 h-4 w-4\" />\n                  Graduate Account\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Set Objectives Dialog */}\n      <Dialog open={showObjectivesDialog} onOpenChange={(open) => {\n        setShowObjectivesDialog(open);\n        if (!open) {\n          setSelectedProgramAccountId(null);\n          setTargetPenetration(\"\");\n          setTargetIncrementalRevenue(\"\");\n          setTargetDurationMonths(\"\");\n          setGraduationCriteria(\"any\");\n        }\n      }}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Target className=\"h-5 w-5\" />\n              Set Graduation Objectives\n            </DialogTitle>\n            <DialogDescription>\n              Define the targets that this account should achieve before graduating from the program.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Target Penetration (%)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"e.g., 80\"\n                  value={targetPenetration}\n                  onChange={(e) => setTargetPenetration(e.target.value)}\n                  min=\"0\"\n                  max=\"100\"\n                  data-testid=\"input-target-penetration\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Category penetration percentage\n                </p>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Target Revenue ($)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"e.g., 50000\"\n                  value={targetIncrementalRevenue}\n                  onChange={(e) => setTargetIncrementalRevenue(e.target.value)}\n                  min=\"0\"\n                  data-testid=\"input-target-revenue\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Incremental revenue target\n                </p>\n              </div>\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label>Target Duration (Months)</Label>\n                <Input\n                  type=\"number\"\n                  placeholder=\"e.g., 12\"\n                  value={targetDurationMonths}\n                  onChange={(e) => setTargetDurationMonths(e.target.value)}\n                  min=\"1\"\n                  data-testid=\"input-target-duration\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Months enrolled before graduation\n                </p>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Graduation Criteria</Label>\n                <Select value={graduationCriteria} onValueChange={setGraduationCriteria}>\n                  <SelectTrigger data-testid=\"select-graduation-criteria\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"any\">Meet ANY objective</SelectItem>\n                    <SelectItem value=\"all\">Meet ALL objectives</SelectItem>\n                  </SelectContent>\n                </Select>\n                <p className=\"text-xs text-muted-foreground\">\n                  How to determine readiness\n                </p>\n              </div>\n            </div>\n            <div className=\"bg-muted/50 rounded-md p-3\">\n              <p className=\"text-sm text-muted-foreground\">\n                <strong>Tip:</strong> Set at least one objective. The account will show as \"Ready to Graduate\" once the criteria is met.\n              </p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowObjectivesDialog(false)} disabled={isSavingObjectives}>\n              Cancel\n            </Button>\n            <Button \n              onClick={handleSaveObjectives}\n              disabled={isSavingObjectives}\n              data-testid=\"button-save-objectives\"\n            >\n              {isSavingObjectives ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Saving...\n                </>\n              ) : (\n                <>\n                  <CheckCircle2 className=\"mr-2 h-4 w-4\" />\n                  Save Objectives\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":42279,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"admin-access.md":{"content":"# Platform Administrator Guide\n\n## Overview\n\nThe Wallet Share Expander platform includes a dedicated App Admin panel for platform administrators (Tenexity team members) to manage all client tenants and their subscriptions.\n\n## Accessing the App Admin Panel\n\n### Requirements\n\nOnly users with platform administrator privileges can access the App Admin panel. Platform administrators are identified by their email address:\n\n- graham@tenexity.ai\n- admin@tenexity.ai\n\n### Navigation\n\n1. Log in to the application with a platform administrator email\n2. Look for \"App Admin\" in the Admin section of the sidebar navigation\n3. Click \"App Admin\" to access the tenant management panel\n\n**Note:** If you don't see \"App Admin\" in the sidebar, your email is not in the platform administrator whitelist.\n\n## App Admin Features\n\n### Tenant Overview\n\nThe main dashboard displays all registered tenants with the following information:\n\n| Column | Description |\n|--------|-------------|\n| Tenant | Company/organization name |\n| Status | Subscription status (active, trial, expired, cancelled) |\n| Plan | Current subscription tier (Free, Starter, Growth, Scale) |\n| Accounts | Number of accounts in the tenant's database |\n| Playbooks | Number of playbooks created |\n| ICPs | Number of Ideal Customer Profiles defined |\n| Enrolled | Number of accounts enrolled in the program |\n| Actions | Edit subscription button |\n\n### Managing Tenant Subscriptions\n\nTo update a tenant's subscription:\n\n1. Click the \"Edit\" button (pencil icon) next to the tenant\n2. In the dialog, you can modify:\n   - **Status**: Change between active, trial, expired, or cancelled\n   - **Plan Type**: Upgrade or downgrade the tenant's tier\n3. Click \"Save Changes\" to apply the updates\n\n### Subscription Plans and Feature Limits\n\nEach plan tier includes specific feature limits:\n\n| Feature | Free | Starter | Growth | Scale |\n|---------|------|---------|--------|-------|\n| Accounts | 10 | 50 | Unlimited | Unlimited |\n| Enrolled Accounts | 1 | 1 | 5 | Unlimited |\n| Playbooks | 1 | 1 | Unlimited | Unlimited |\n| ICPs | 1 | 1 | 3 | Unlimited |\n\nWhen tenants exceed their limits, they receive an upgrade prompt encouraging them to move to a higher tier.\n\n## Subscription Status Definitions\n\n- **Active**: Tenant has a valid, paid subscription\n- **Trial**: Tenant is in a trial period\n- **Expired**: Subscription has lapsed and needs renewal\n- **Cancelled**: Tenant has cancelled their subscription\n\n## Best Practices\n\n1. **Monitor Usage**: Regularly review tenant usage metrics to identify accounts that may benefit from tier upgrades\n2. **Proactive Outreach**: Contact tenants approaching their limits to discuss upgrade options\n3. **Status Management**: Keep subscription statuses current to ensure accurate feature access\n\n## Troubleshooting\n\n### Can't Access App Admin\n\n- Verify your login email is in the platform administrator whitelist\n- Clear browser cache and log in again\n- Contact the development team to add your email to the whitelist\n\n### Changes Not Saving\n\n- Check your network connection\n- Verify the tenant ID is valid\n- Review browser console for error messages\n\n## Security Notes\n\n- App Admin access is restricted at both the UI level (sidebar visibility) and API level (endpoint protection)\n- All API requests to /api/app-admin/* endpoints require platform administrator authentication\n- Non-admin users attempting to access these endpoints will receive a 403 Forbidden error\n","path":null,"size_bytes":3447,"size_tokens":null},"server/services/account-context.ts":{"content":"/**\n * Account Context Assembler â€” Phase 2\n *\n * assembleAccountContext(accountId, tenantId) is the single most important\n * function in the agentic layer. Every AI call (playbook generation, briefing,\n * ask-anything, email intelligence) MUST call this first to assemble a rich,\n * structured context bundle that gets injected into the OpenAI system prompt.\n *\n * Data pulled:\n *   - accounts + account_metrics (core financials, scores, enrollment state)\n *   - agent_contacts (key people)\n *   - agent_account_category_spend (last 12 months, top gaps)\n *   - agent_interactions (last 10 touchpoints)\n *   - agent_playbooks (active playbook if any)\n *   - agent_projects (active/bidding projects)\n *   - agent_similar_account_pairs (graduated peers for proof points)\n *   - agent_account_competitors (known competitors)\n *   - agent_playbook_learnings (applicable learnings for this account's segment/trade)\n *   - agent_state (agent's prior observations)\n */\n\nimport { db } from \"../db\";\nimport {\n    accounts,\n    accountMetrics,\n    productCategories,\n    agentContacts,\n    agentAccountCategorySpend,\n    agentInteractions,\n    agentPlaybooks,\n    agentProjects,\n    agentSimilarAccountPairs,\n    agentAccountCompetitors,\n    agentCompetitors,\n    agentPlaybookLearnings,\n    agentState,\n} from \"@shared/schema\";\nimport { and, eq, desc, gte, isNull, or, inArray } from \"drizzle-orm\";\nimport { getCoreSystemPrompt, buildStatePreamble } from \"./agent-identity\";\n\n// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport interface AccountContext {\n    account: {\n        id: number;\n        name: string;\n        segment: string | null;\n        region: string | null;\n        assignedTm: string | null;\n        status: string | null;\n        enrollmentStatus: string | null;\n        walletShareDirection: string | null;\n    };\n    metrics: {\n        last12mRevenue: string | null;\n        last3mRevenue: string | null;\n        yoyGrowthRate: string | null;\n        categoryPenetration: string | null;\n        opportunityScore: string | null;\n        walletSharePercentage: string | null;\n        daysSinceLastOrder: number | null;\n    } | null;\n    contacts: Array<{\n        name: string;\n        role: string | null;\n        email: string | null;\n        isPrimary: boolean | null;\n    }>;\n    categorySpend: Array<{\n        categoryId: number;\n        categoryName: string | null;\n        periodStart: Date;\n        spendAmount: string;\n        spendPct: string | null;\n        gapDollars: string | null;\n        gapPct: string | null;\n    }>;\n    recentInteractions: Array<{\n        interactionType: string;\n        subject: string | null;\n        sentiment: string | null;\n        urgency: string | null;\n        buyingSignal: string | null;\n        competitorMentioned: string | null;\n        projectMentioned: string | null;\n        interactionDate: Date | null;\n    }>;\n    activePlaybook: {\n        playbookType: string;\n        priorityAction: string | null;\n        urgencyLevel: string | null;\n        aiGeneratedContent: unknown;\n    } | null;\n    projects: Array<{\n        name: string;\n        projectType: string | null;\n        status: string | null;\n        estimatedValue: string | null;\n    }>;\n    similarGraduatedAccounts: Array<{\n        accountIdB: number;\n        accountBName: string | null;\n        similarityScore: string;\n        sharedSegment: string | null;\n        accountBGraduationRevenue: string | null;\n    }>;\n    competitors: Array<{\n        name: string;\n        estimatedSpendPct: string | null;\n    }>;\n    applicableLearnings: Array<{\n        learning: string;\n        evidenceCount: number | null;\n        successRate: string | null;\n    }>;\n    agentStatePreamble: string;\n}\n\n// â”€â”€â”€ Main assembler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function assembleAccountContext(\n    accountId: number,\n    tenantId: number,\n): Promise<AccountContext> {\n    const twelveMonthsAgo = new Date();\n    twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);\n\n    // Fetch everything in parallel for performance\n    const [\n        accountRow,\n        metricsRow,\n        contactRows,\n        spendRows,\n        interactionRows,\n        activePlaybookRow,\n        projectRows,\n        similarRows,\n        competitorJoinRows,\n        stateRow,\n    ] = await Promise.all([\n        db.select().from(accounts).where(and(eq(accounts.id, accountId), eq(accounts.tenantId, tenantId))).limit(1),\n        db.select().from(accountMetrics).where(and(eq(accountMetrics.accountId, accountId), eq(accountMetrics.tenantId, tenantId))).limit(1),\n        db.select().from(agentContacts).where(and(eq(agentContacts.accountId, accountId), eq(agentContacts.tenantId, tenantId))),\n        db.select().from(agentAccountCategorySpend)\n            .where(and(eq(agentAccountCategorySpend.accountId, accountId), eq(agentAccountCategorySpend.tenantId, tenantId)))\n            .limit(24),\n        db.select().from(agentInteractions)\n            .where(and(eq(agentInteractions.accountId, accountId), eq(agentInteractions.tenantId, tenantId)))\n            .orderBy(desc(agentInteractions.occurredAt))\n            .limit(10),\n        db.select().from(agentPlaybooks)\n            .where(and(eq(agentPlaybooks.accountId, accountId), eq(agentPlaybooks.tenantId, tenantId), eq(agentPlaybooks.status, \"active\")))\n            .orderBy(desc(agentPlaybooks.generatedAt))\n            .limit(1),\n        db.select().from(agentProjects)\n            .where(and(eq(agentProjects.accountId, accountId), eq(agentProjects.tenantId, tenantId))),\n        db.select().from(agentSimilarAccountPairs)\n            .where(and(eq(agentSimilarAccountPairs.accountIdA, accountId), eq(agentSimilarAccountPairs.tenantId, tenantId), eq(agentSimilarAccountPairs.accountBGraduated, true)))\n            .orderBy(desc(agentSimilarAccountPairs.similarityScore))\n            .limit(3),\n        db.select({\n            name: agentCompetitors.name,\n        })\n            .from(agentAccountCompetitors)\n            .innerJoin(agentCompetitors, eq(agentCompetitors.id, agentAccountCompetitors.competitorId))\n            .where(and(eq(agentAccountCompetitors.accountId, accountId), eq(agentAccountCompetitors.tenantId, tenantId))),\n        db.select().from(agentState)\n            .where(and(eq(agentState.tenantId, tenantId), eq(agentState.agentRunType, \"weekly-account-review\")))\n            .limit(1),\n    ]);\n\n    const account = accountRow[0];\n    if (!account) throw new Error(`Account ${accountId} not found for tenant ${tenantId}`);\n\n    // Look up category names for spend rows\n    const catIds = spendRows.map((s) => s.categoryId).filter((id): id is number => id !== null);\n    const categoryNameRows = catIds.length > 0\n        ? await db.select({ id: productCategories.id, name: productCategories.name }).from(productCategories).where(inArray(productCategories.id, catIds))\n        : [];\n    const categoryNameMap = new Map(categoryNameRows.map((c) => [c.id, c.name]));\n\n    // Look up account names for similar accounts\n    const similarAccountIds = similarRows.map((s) => s.accountIdB);\n    const similarAccountNameRows = similarAccountIds.length > 0\n        ? await db.select({ id: accounts.id, name: accounts.name }).from(accounts).where(inArray(accounts.id, similarAccountIds))\n        : [];\n    const similarAccountNameMap = new Map(similarAccountNameRows.map((a) => [a.id, a.name]));\n\n    // Fetch applicable learnings based on account segment/trade type\n    const learningRows = await db.select().from(agentPlaybookLearnings)\n        .where(and(\n            eq(agentPlaybookLearnings.isActive, true),\n            or(isNull(agentPlaybookLearnings.tenantId), eq(agentPlaybookLearnings.tenantId, tenantId)),\n        ))\n        .orderBy(desc(agentPlaybookLearnings.evidenceCount))\n        .limit(5);\n\n    return {\n        account: {\n            id: account.id,\n            name: account.name,\n            segment: account.segment,\n            region: account.region,\n            assignedTm: account.assignedTm,\n            status: account.status,\n            enrollmentStatus: (account as any).enrollmentStatus ?? null,\n            walletShareDirection: (account as any).walletShareDirection ?? null,\n        },\n        metrics: metricsRow[0]\n            ? {\n                last12mRevenue: metricsRow[0].last12mRevenue,\n                last3mRevenue: metricsRow[0].last3mRevenue,\n                yoyGrowthRate: metricsRow[0].yoyGrowthRate,\n                categoryPenetration: metricsRow[0].categoryPenetration,\n                opportunityScore: metricsRow[0].opportunityScore,\n                walletSharePercentage: (metricsRow[0] as any).walletSharePercentage ?? null,\n                daysSinceLastOrder: (metricsRow[0] as any).daysSinceLastOrder ?? null,\n            }\n            : null,\n        contacts: contactRows.map((c) => ({\n            name: c.name,\n            role: c.role,\n            email: c.email,\n            isPrimary: c.isPrimary,\n        })),\n        categorySpend: spendRows.map((s) => ({\n            categoryId: s.categoryId ?? 0,\n            categoryName: categoryNameMap.get(s.categoryId ?? 0) ?? null,\n            periodStart: s.lastOrderDate ?? new Date(),\n            spendAmount: s.currentSpend ?? \"0\",\n            spendPct: null,\n            gapDollars: s.gapDollars,\n            gapPct: s.gapPercentage,\n        })),\n        recentInteractions: interactionRows.map((i) => ({\n            interactionType: i.interactionType,\n            subject: i.subject,\n            sentiment: i.sentimentSignal,\n            urgency: null,\n            buyingSignal: null,\n            competitorMentioned: null,\n            projectMentioned: null,\n            interactionDate: i.occurredAt,\n        })),\n        activePlaybook: activePlaybookRow[0]\n            ? {\n                playbookType: ((activePlaybookRow[0].playbookJson as any)?.playbook_type) ?? \"general\",\n                priorityAction: ((activePlaybookRow[0].playbookJson as any)?.priority_action) ?? null,\n                urgencyLevel: ((activePlaybookRow[0].playbookJson as any)?.urgency_level) ?? null,\n                aiGeneratedContent: (activePlaybookRow[0].playbookJson as any) ?? null,\n            }\n            : null,\n        projects: projectRows.map((p) => ({\n            name: p.name,\n            projectType: p.projectType,\n            status: p.status,\n            estimatedValue: p.estimatedValue,\n        })),\n        similarGraduatedAccounts: similarRows.map((s) => ({\n            accountIdB: s.accountIdB,\n            accountBName: similarAccountNameMap.get(s.accountIdB) ?? null,\n            similarityScore: s.similarityScore ?? \"0\",\n            sharedSegment: ((s.similarityBasis as any)?.shared_segment) ?? null,\n            accountBGraduationRevenue: ((s.similarityBasis as any)?.graduation_revenue) ?? null,\n        })),\n        competitors: competitorJoinRows.map((c) => ({\n            name: c.name,\n            estimatedSpendPct: null,\n        })),\n        applicableLearnings: learningRows.map((l) => ({\n            learning: l.learning ?? \"\",\n            evidenceCount: l.evidenceCount,\n            successRate: l.successRate,\n        })),\n        agentStatePreamble: buildStatePreamble(stateRow[0] as any),\n    };\n}\n\n// â”€â”€â”€ Context â†’ Prompt string converter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Converts the structured context bundle into a tight prompt-ready string\n// that gets injected after the core system prompt in every AI call.\n\nexport function contextToPromptString(ctx: AccountContext): string {\n    const lines: string[] = [];\n\n    lines.push(`ACCOUNT: ${ctx.account.name}`);\n    lines.push(`Segment: ${ctx.account.segment ?? \"Unknown\"} | Region: ${ctx.account.region ?? \"Unknown\"} | Rep: ${ctx.account.assignedTm ?? \"Unassigned\"}`);\n    lines.push(`Enrollment: ${ctx.account.enrollmentStatus ?? \"discovered\"} | Wallet Share Trend: ${ctx.account.walletShareDirection ?? \"unknown\"}`);\n\n    if (ctx.metrics) {\n        lines.push(`\\nFINANCIALS:`);\n        lines.push(`  Last 12m Revenue: $${ctx.metrics.last12mRevenue ?? \"N/A\"}`);\n        lines.push(`  Last 3m Revenue: $${ctx.metrics.last3mRevenue ?? \"N/A\"}`);\n        lines.push(`  YoY Growth: ${ctx.metrics.yoyGrowthRate ?? \"N/A\"}%`);\n        lines.push(`  Wallet Share Estimated: ${ctx.metrics.walletSharePercentage ?? \"N/A\"}%`);\n        lines.push(`  Days Since Last Order: ${ctx.metrics.daysSinceLastOrder ?? \"N/A\"}`);\n        lines.push(`  Category Penetration: ${ctx.metrics.categoryPenetration ?? \"N/A\"}% | Opportunity Score: ${ctx.metrics.opportunityScore ?? \"N/A\"}`);\n    }\n\n    if (ctx.contacts.length > 0) {\n        lines.push(`\\nCONTACTS:`);\n        ctx.contacts.forEach((c) => {\n            lines.push(`  - ${c.name} (${c.role ?? \"unknown role\"})${c.isPrimary ? \" [PRIMARY]\" : \"\"}${c.email ? ` <${c.email}>` : \"\"}`);\n        });\n    }\n\n    if (ctx.categorySpend.length > 0) {\n        lines.push(`\\nCAT SPEND (last 12 months, top gaps first):`);\n        ctx.categorySpend.slice(0, 8).forEach((s) => {\n            lines.push(`  - ${s.categoryName ?? `Cat ${s.categoryId}`}: $${s.spendAmount} spend | gap: ${s.gapPct ?? \"?\"}% ($${s.gapDollars ?? \"?\"} est.)`);\n        });\n    }\n\n    if (ctx.recentInteractions.length > 0) {\n        lines.push(`\\nRECENT INTERACTIONS:`);\n        ctx.recentInteractions.slice(0, 5).forEach((i) => {\n            const date = i.interactionDate ? new Date(i.interactionDate).toISOString().slice(0, 10) : \"?\";\n            lines.push(`  [${date}] ${i.interactionType.toUpperCase()}${i.subject ? `: ${i.subject}` : \"\"} â€” sentiment: ${i.sentiment ?? \"?\"} | urgency: ${i.urgency ?? \"?\"}`);\n            if (i.buyingSignal) lines.push(`    â†’ Buying signal: ${i.buyingSignal}`);\n            if (i.competitorMentioned) lines.push(`    â†’ Competitor mentioned: ${i.competitorMentioned}`);\n        });\n    }\n\n    if (ctx.activePlaybook) {\n        lines.push(`\\nACTIVE PLAYBOOK: ${ctx.activePlaybook.playbookType}`);\n        if (ctx.activePlaybook.priorityAction) lines.push(`  Priority: ${ctx.activePlaybook.priorityAction}`);\n        if (ctx.activePlaybook.urgencyLevel) lines.push(`  Urgency: ${ctx.activePlaybook.urgencyLevel}`);\n    }\n\n    if (ctx.projects.length > 0) {\n        lines.push(`\\nACTIVE PROJECTS:`);\n        ctx.projects.forEach((p) => {\n            lines.push(`  - ${p.name} (${p.projectType ?? \"?\"}) â€” ${p.status ?? \"?\"} â€” Est. value: $${p.estimatedValue ?? \"?\"}`);\n        });\n    }\n\n    if (ctx.competitors.length > 0) {\n        lines.push(`\\nKNOWN COMPETITORS:`);\n        ctx.competitors.forEach((c) => {\n            lines.push(`  - ${c.name}${c.estimatedSpendPct ? `: ~${c.estimatedSpendPct}% est. spend` : \"\"}`);\n        });\n    }\n\n    if (ctx.similarGraduatedAccounts.length > 0) {\n        lines.push(`\\nSIMILAR GRADUATED ACCOUNTS (proof points):`);\n        ctx.similarGraduatedAccounts.forEach((s) => {\n            lines.push(`  - ${s.accountBName ?? `Account ${s.accountIdB}`} (${s.sharedSegment ?? \"same segment\"}, similarity: ${s.similarityScore}) â€” Graduated at $${s.accountBGraduationRevenue ?? \"?\"} revenue`);\n        });\n    }\n\n    if (ctx.applicableLearnings.length > 0) {\n        lines.push(`\\nAPPLICABLE LEARNINGS (from prior playbook outcomes):`);\n        ctx.applicableLearnings.forEach((l, i) => {\n            lines.push(`  ${i + 1}. ${l.learning} [evidence: ${l.evidenceCount ?? 1}, success rate: ${l.successRate ?? \"?\"}%]`);\n        });\n    }\n\n    if (ctx.agentStatePreamble) {\n        lines.push(`\\n${ctx.agentStatePreamble}`);\n    }\n\n    return lines.join(\"\\n\");\n}\n\n// â”€â”€â”€ Full system prompt builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Convenience function used by every agent service.\n\nconst ACTION_LINK_INSTRUCTIONS = `\nACTION LINKS: When recommending actions, include markdown links to in-app pages so the user can navigate directly. Use these app routes:\n  - View this account: /accounts?highlight=ACCOUNT_ID\n  - View playbooks & tasks: /playbooks\n  - View ICP profiles: /icp-builder\n  - View revenue tracking: /revenue\n  - View program performance: /program-performance\n\nWhen you suggest steps, format them as a numbered \"Next Steps\" section with links. Example:\n  1. Go to [Playbooks](/playbooks) to generate a call script for this account\n  2. Check [Revenue Tracking](/revenue) to monitor enrollment progress\n`;\n\nexport async function buildFullSystemPrompt(ctx: AccountContext): Promise<string> {\n    const [corePrompt, contextStr] = await Promise.all([\n        getCoreSystemPrompt(),\n        Promise.resolve(contextToPromptString(ctx)),\n    ]);\n    const accountLink = `/accounts?highlight=${ctx.account.id}`;\n    const linkInstructions = ACTION_LINK_INSTRUCTIONS.replace(/ACCOUNT_ID/g, String(ctx.account.id));\n    return `${corePrompt}\\n\\n---\\nACCOUNT CONTEXT:\\n${contextStr}\\n\\n${linkInstructions}`;\n}\n","path":null,"size_bytes":17291,"size_tokens":null},"tests/unit/tenantStorage.test.ts":{"content":"import { describe, it, expect, vi, beforeEach, afterEach, Mock } from 'vitest';\n\nconst mockSelect = vi.fn();\nconst mockFrom = vi.fn();\nconst mockWhere = vi.fn();\nconst mockOrderBy = vi.fn();\nconst mockLimit = vi.fn();\nconst mockOffset = vi.fn();\nconst mockReturning = vi.fn();\nconst mockValues = vi.fn();\nconst mockSet = vi.fn();\nconst mockInsert = vi.fn();\nconst mockUpdate = vi.fn();\nconst mockDelete = vi.fn();\n\nconst mockDb = {\n  select: mockSelect,\n  insert: mockInsert,\n  update: mockUpdate,\n  delete: mockDelete,\n};\n\nvi.mock('../../server/db', () => ({\n  db: mockDb\n}));\n\nfunction setupSelectChain(result: any[] = []) {\n  mockFrom.mockReturnValue({ where: mockWhere, orderBy: mockOrderBy });\n  mockWhere.mockReturnValue(Promise.resolve(result));\n  mockOrderBy.mockReturnValue({ limit: mockLimit, offset: mockOffset });\n  mockLimit.mockReturnValue({ offset: mockOffset });\n  mockOffset.mockReturnValue(Promise.resolve(result));\n  mockSelect.mockReturnValue({ from: mockFrom });\n  return result;\n}\n\nfunction setupInsertChain(result: any = { id: 1 }) {\n  mockReturning.mockReturnValue(Promise.resolve([result]));\n  mockValues.mockReturnValue({ returning: mockReturning });\n  mockInsert.mockReturnValue({ values: mockValues });\n  return result;\n}\n\nfunction setupUpdateChain(result: any = { id: 1 }) {\n  const mockWhereUpdate = vi.fn().mockReturnValue({ returning: mockReturning });\n  mockReturning.mockReturnValue(Promise.resolve([result]));\n  mockSet.mockReturnValue({ where: mockWhereUpdate });\n  mockUpdate.mockReturnValue({ set: mockSet });\n  return result;\n}\n\nfunction setupDeleteChain() {\n  const mockWhereDelete = vi.fn().mockReturnValue(Promise.resolve(undefined));\n  mockDelete.mockReturnValue({ where: mockWhereDelete });\n}\n\ndescribe('TenantStorage', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('tenant isolation', () => {\n    it('enforces tenantId on all queries - tenantId must be part of query conditions', () => {\n      const tenantId = 42;\n      expect(tenantId).toBe(42);\n    });\n\n    it('prevents cross-tenant data access - different tenants get different storage instances', () => {\n      const tenant1 = 1;\n      const tenant2 = 2;\n      expect(tenant1).not.toBe(tenant2);\n    });\n  });\n\n  describe('CRUD operations pattern', () => {\n    it('create operations should include tenantId in inserted values', () => {\n      const accountData = { name: 'Test Account', segment: 'SMB' };\n      const tenantId = 1;\n      const withTenant = { ...accountData, tenantId };\n      expect(withTenant.tenantId).toBe(1);\n      expect(withTenant.name).toBe('Test Account');\n    });\n\n    it('read operations should filter by tenantId in where clause', () => {\n      const tenantId = 1;\n      const query = { tenantId };\n      expect(query.tenantId).toBe(1);\n    });\n\n    it('update operations should include tenantId in where clause', () => {\n      const id = 5;\n      const tenantId = 1;\n      const whereClause = { id, tenantId };\n      expect(whereClause.id).toBe(5);\n      expect(whereClause.tenantId).toBe(1);\n    });\n\n    it('delete operations should include tenantId in where clause', () => {\n      const id = 10;\n      const tenantId = 1;\n      const whereClause = { id, tenantId };\n      expect(whereClause.id).toBe(10);\n      expect(whereClause.tenantId).toBe(1);\n    });\n  });\n\n  describe('pagination pattern', () => {\n    it('calculates correct offset from page and limit', () => {\n      const page = 3;\n      const limit = 50;\n      const offset = (page - 1) * limit;\n      expect(offset).toBe(100);\n    });\n\n    it('defaults to page 1 limit 50', () => {\n      const DEFAULT_PAGE = 1;\n      const DEFAULT_LIMIT = 50;\n      expect(DEFAULT_PAGE).toBe(1);\n      expect(DEFAULT_LIMIT).toBe(50);\n    });\n\n    it('caps limit at MAX_LIMIT', () => {\n      const MAX_LIMIT = 100;\n      const requestedLimit = 500;\n      const actualLimit = Math.min(requestedLimit, MAX_LIMIT);\n      expect(actualLimit).toBe(100);\n    });\n  });\n\n  describe('getTasks pagination', () => {\n    it('returns correct structure with pagination metadata', () => {\n      const mockResult = {\n        tasks: [{ id: 1, title: 'Test Task' }],\n        total: 150,\n        page: 2,\n        limit: 50,\n      };\n\n      expect(mockResult).toHaveProperty('tasks');\n      expect(mockResult).toHaveProperty('total');\n      expect(mockResult).toHaveProperty('page');\n      expect(mockResult).toHaveProperty('limit');\n    });\n\n    it('calculates total pages correctly', () => {\n      const total = 150;\n      const limit = 50;\n      const totalPages = Math.ceil(total / limit);\n      expect(totalPages).toBe(3);\n    });\n  });\n\n  describe('data integrity', () => {\n    it('ensures required fields are present', () => {\n      const account = { name: 'Test', segment: 'SMB', tenantId: 1 };\n      expect(account.name).toBeDefined();\n      expect(account.tenantId).toBeDefined();\n    });\n\n    it('validates segment values', () => {\n      const validSegments = ['SMB', 'Mid-Market', 'Enterprise'];\n      const segment = 'SMB';\n      expect(validSegments).toContain(segment);\n    });\n  });\n});\n\ndescribe('TenantStorage - Account Operations', () => {\n  describe('getAccounts', () => {\n    it('should return only accounts for the tenant', () => {\n      const tenantId = 1;\n      const allAccounts = [\n        { id: 1, name: 'Tenant 1 Account', tenantId: 1 },\n        { id: 2, name: 'Tenant 2 Account', tenantId: 2 },\n        { id: 3, name: 'Another Tenant 1 Account', tenantId: 1 },\n      ];\n      \n      const tenantAccounts = allAccounts.filter(a => a.tenantId === tenantId);\n      expect(tenantAccounts.length).toBe(2);\n      expect(tenantAccounts.every(a => a.tenantId === 1)).toBe(true);\n    });\n  });\n\n  describe('getAccount', () => {\n    it('should return undefined for accounts from other tenants', () => {\n      const tenantId = 1;\n      const account = { id: 5, name: 'Other Account', tenantId: 2 };\n      \n      const result = account.tenantId === tenantId ? account : undefined;\n      expect(result).toBeUndefined();\n    });\n\n    it('should return account when it belongs to tenant', () => {\n      const tenantId = 1;\n      const account = { id: 5, name: 'My Account', tenantId: 1 };\n      \n      const result = account.tenantId === tenantId ? account : undefined;\n      expect(result).toEqual(account);\n    });\n  });\n\n  describe('createAccount', () => {\n    it('should automatically add tenantId to new accounts', () => {\n      const tenantId = 1;\n      const inputAccount = { name: 'New Account', segment: 'SMB' };\n      const createdAccount = { ...inputAccount, tenantId, id: 1 };\n      \n      expect(createdAccount.tenantId).toBe(tenantId);\n    });\n  });\n\n  describe('updateAccount', () => {\n    it('should only update accounts belonging to tenant', () => {\n      const tenantId = 1;\n      const accountId = 5;\n      const whereClause = { id: accountId, tenantId };\n      \n      expect(whereClause.tenantId).toBe(tenantId);\n      expect(whereClause.id).toBe(accountId);\n    });\n  });\n});\n\ndescribe('TenantStorage - Task Operations', () => {\n  describe('getTasks with pagination', () => {\n    it('should support page parameter', () => {\n      const options = { page: 2, limit: 50 };\n      expect(options.page).toBe(2);\n    });\n\n    it('should support limit parameter', () => {\n      const options = { page: 1, limit: 25 };\n      expect(options.limit).toBe(25);\n    });\n\n    it('should default to page 1 when not specified', () => {\n      const options: { page?: number; limit?: number } = {};\n      const page = options.page ?? 1;\n      expect(page).toBe(1);\n    });\n  });\n\n  describe('getAllTasks', () => {\n    it('should return all tasks without pagination', () => {\n      const tasks = [\n        { id: 1, title: 'Task 1', tenantId: 1 },\n        { id: 2, title: 'Task 2', tenantId: 1 },\n        { id: 3, title: 'Task 3', tenantId: 1 },\n      ];\n      \n      expect(tasks.length).toBe(3);\n    });\n  });\n});\n\ndescribe('TenantStorage - Tenant Isolation Verification', () => {\n  it('validates tenant isolation principle - tenantId is required in all queries', () => {\n    const mockQuery = (tenantId: number, table: string) => ({\n      where: `${table}.tenantId = ${tenantId}`,\n      table,\n    });\n\n    const query = mockQuery(1, 'accounts');\n    expect(query.where).toContain('tenantId = 1');\n  });\n\n  it('validates batch operations include tenantId', () => {\n    const tenantId = 1;\n    const accountIds = [1, 2, 3];\n    \n    const mockBatchQuery = {\n      condition1: `accountId IN (${accountIds.join(',')})`,\n      condition2: `tenantId = ${tenantId}`,\n    };\n    \n    expect(mockBatchQuery.condition2).toContain('tenantId');\n  });\n\n  it('validates create operations auto-inject tenantId', () => {\n    const tenantId = 5;\n    const insertData = { name: 'Test', segment: 'SMB' };\n    const finalData = { ...insertData, tenantId };\n    \n    expect(finalData.tenantId).toBe(5);\n    expect(Object.keys(finalData)).toContain('tenantId');\n  });\n});\n\ndescribe('TenantStorage - Edge Cases', () => {\n  it('handles empty result sets', () => {\n    const emptyResults: any[] = [];\n    expect(emptyResults.length).toBe(0);\n  });\n\n  it('handles batch operations with empty array', () => {\n    const emptyAccountIds: number[] = [];\n    const result = emptyAccountIds.length === 0 ? new Map() : null;\n    expect(result).toBeInstanceOf(Map);\n    expect(result?.size).toBe(0);\n  });\n\n  it('handles pagination edge case - page 0 defaults to 1', () => {\n    const page = 0;\n    const safePage = page || 1;\n    expect(safePage).toBe(1);\n  });\n\n  it('handles undefined account id in getAccount', () => {\n    const accounts = [{ id: 1, name: 'Test', tenantId: 1 }];\n    const searchId = 999;\n    const found = accounts.find(a => a.id === searchId);\n    expect(found).toBeUndefined();\n  });\n});\n","path":null,"size_bytes":9777,"size_tokens":null},"tests/setup/test-app.ts":{"content":"import express, { Express, Request, Response, NextFunction } from 'express';\nimport { createServer, Server } from 'http';\n\ntype TenantContextData = {\n  tenantId: number;\n  userId: string;\n  roles: string[];\n  permissions: string[];\n};\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      isAuthenticated(): boolean;\n      user?: {\n        claims: {\n          sub: string;\n          email?: string;\n        };\n      };\n      tenantContext?: TenantContextData;\n    }\n  }\n}\n\ninterface TestAppConfig {\n  authenticated?: boolean;\n  tenantContext?: TenantContextData;\n  subscriptionStatus?: 'active' | 'inactive' | 'trialing';\n}\n\nexport function createTestApp(config: TestAppConfig = {}): { app: Express; server: Server } {\n  const app = express();\n  const server = createServer(app);\n\n  app.use(express.json());\n  app.use(express.urlencoded({ extended: false }));\n\n  app.use((req: Request, _res: Response, next: NextFunction) => {\n    (req as any).isAuthenticated = () => config.authenticated ?? false;\n    \n    if (config.authenticated && config.tenantContext) {\n      req.user = {\n        claims: {\n          sub: `user-${config.tenantContext.userId}`,\n          email: 'test@example.com',\n        },\n      };\n      req.tenantContext = config.tenantContext;\n    }\n    \n    next();\n  });\n\n  return { app, server };\n}\n\nexport function createMockTenantContext(overrides: Partial<TenantContextData> = {}): TenantContextData {\n  return {\n    tenantId: 1,\n    userId: 'test-user-1',\n    roles: ['super_admin'],\n    permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],\n    ...overrides,\n  };\n}\n\nexport function createMockSubscribedTenantContext(): TenantContextData {\n  return createMockTenantContext({\n    permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings', 'subscription_active'],\n  });\n}\n\nexport function createMockFreeTenantContext(): TenantContextData {\n  return createMockTenantContext({\n    roles: ['viewer'],\n    permissions: ['read'],\n  });\n}\n","path":null,"size_bytes":2007,"size_tokens":null},"server/replit_integrations/audio/routes.ts":{"content":"import express, { type Express, type Request, type Response } from \"express\";\nimport { chatStorage } from \"../chat/storage\";\nimport { openai, speechToText, ensureCompatibleFormat } from \"./client\";\n\n// Body parser with 50MB limit for audio payloads\nconst audioBodyParser = express.json({ limit: \"50mb\" });\n\nexport function registerAudioRoutes(app: Express): void {\n  // Get all conversations\n  app.get(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const conversations = await chatStorage.getAllConversations();\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get single conversation with messages\n  app.get(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await chatStorage.getConversation(id);\n      if (!conversation) {\n        return res.status(404).json({ error: \"Conversation not found\" });\n      }\n      const messages = await chatStorage.getMessagesByConversation(id);\n      res.json({ ...conversation, messages });\n    } catch (error) {\n      console.error(\"Error fetching conversation:\", error);\n      res.status(500).json({ error: \"Failed to fetch conversation\" });\n    }\n  });\n\n  // Create new conversation\n  app.post(\"/api/conversations\", async (req: Request, res: Response) => {\n    try {\n      const { title } = req.body;\n      const conversation = await chatStorage.createConversation(title || \"New Chat\");\n      res.status(201).json(conversation);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(500).json({ error: \"Failed to create conversation\" });\n    }\n  });\n\n  // Delete conversation\n  app.delete(\"/api/conversations/:id\", async (req: Request, res: Response) => {\n    try {\n      const id = parseInt(req.params.id);\n      await chatStorage.deleteConversation(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting conversation:\", error);\n      res.status(500).json({ error: \"Failed to delete conversation\" });\n    }\n  });\n\n  // Send voice message and get streaming audio response\n  // Auto-detects audio format and converts WebM/MP4/OGG to WAV\n  // Uses gpt-4o-mini-transcribe for STT, gpt-audio for voice response\n  app.post(\"/api/conversations/:id/messages\", audioBodyParser, async (req: Request, res: Response) => {\n    try {\n      const conversationId = parseInt(req.params.id);\n      const { audio, voice = \"alloy\" } = req.body;\n\n      if (!audio) {\n        return res.status(400).json({ error: \"Audio data (base64) is required\" });\n      }\n\n      // 1. Auto-detect format and convert to OpenAI-compatible format\n      const rawBuffer = Buffer.from(audio, \"base64\");\n      const { buffer: audioBuffer, format: inputFormat } = await ensureCompatibleFormat(rawBuffer);\n\n      // 2. Transcribe user audio\n      const userTranscript = await speechToText(audioBuffer, inputFormat);\n\n      // 3. Save user message\n      await chatStorage.createMessage(conversationId, \"user\", userTranscript);\n\n      // 4. Get conversation history\n      const existingMessages = await chatStorage.getMessagesByConversation(conversationId);\n      const chatHistory = existingMessages.map((m) => ({\n        role: m.role as \"user\" | \"assistant\",\n        content: m.content,\n      }));\n\n      // 5. Set up SSE\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      res.write(`data: ${JSON.stringify({ type: \"user_transcript\", data: userTranscript })}\\n\\n`);\n\n      // 6. Stream audio response from gpt-audio\n      const stream = await openai.chat.completions.create({\n        model: \"gpt-audio\",\n        modalities: [\"text\", \"audio\"],\n        audio: { voice, format: \"pcm16\" },\n        messages: chatHistory,\n        stream: true,\n      });\n\n      let assistantTranscript = \"\";\n\n      for await (const chunk of stream) {\n        const delta = chunk.choices?.[0]?.delta as any;\n        if (!delta) continue;\n\n        if (delta?.audio?.transcript) {\n          assistantTranscript += delta.audio.transcript;\n          res.write(`data: ${JSON.stringify({ type: \"transcript\", data: delta.audio.transcript })}\\n\\n`);\n        }\n\n        if (delta?.audio?.data) {\n          res.write(`data: ${JSON.stringify({ type: \"audio\", data: delta.audio.data })}\\n\\n`);\n        }\n      }\n\n      // 7. Save assistant message\n      await chatStorage.createMessage(conversationId, \"assistant\", assistantTranscript);\n\n      res.write(`data: ${JSON.stringify({ type: \"done\", transcript: assistantTranscript })}\\n\\n`);\n      res.end();\n    } catch (error) {\n      console.error(\"Error processing voice message:\", error);\n      if (res.headersSent) {\n        res.write(`data: ${JSON.stringify({ type: \"error\", error: \"Failed to process voice message\" })}\\n\\n`);\n        res.end();\n      } else {\n        res.status(500).json({ error: \"Failed to process voice message\" });\n      }\n    }\n  });\n}\n","path":null,"size_bytes":5151,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":4050,"size_tokens":null},"server/services/daily-briefing.ts":{"content":"/**\n * Daily Briefing Service â€” Phase 3\n *\n * POST /api/agent/daily-briefing\n * (Also triggered by node-cron weekdays 7am EST in scheduler.ts)\n *\n * For each active territory manager:\n *   1. Loads all enrolled accounts assigned to that TM\n *   2. Assembles context for each and asks gpt-4o for a prioritized daily brief\n *   3. Formats HTML email with headline action + priority list + at-risk accounts\n *   4. Sends via Resend\n *   5. Writes to agent_rep_daily_briefings\n *   6. Updates agent_state for run_type=daily-briefing\n */\n\nimport OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { db } from \"../db\";\nimport { accounts, agentRepDailyBriefings, agentOrganizationSettings } from \"@shared/schema\";\nimport { and, eq } from \"drizzle-orm\";\nimport { assembleAccountContext, contextToPromptString } from \"./account-context\";\nimport { getCoreSystemPrompt, readAgentState, writeAgentMemo, buildStatePreamble, AGENT_MEMO_INSTRUCTION } from \"./agent-identity\";\nimport { Resend } from \"resend\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\nconst resend = new Resend(process.env.RESEND_API_KEY);\nconst FROM_EMAIL = \"noreply@ignition.tenexity.ai\";\n\n// â”€â”€â”€ Response schema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst BriefingResponseSchema = z.object({\n    headline_action: z.string().max(200),\n    priority_items: z.array(z.object({\n        account_name: z.string(),\n        account_id: z.number(),\n        action: z.string(),\n        urgency: z.enum([\"immediate\", \"this_week\", \"this_month\"]),\n        why: z.string(),\n    })).max(5),\n    at_risk_accounts: z.array(z.object({\n        account_name: z.string(),\n        account_id: z.number(),\n        signal: z.string(),\n    })).max(3),\n    portfolio_summary: z.string().max(500),\n    agent_memo: z.object({\n        last_run_summary: z.string(),\n        current_focus: z.string(),\n        pattern_notes_addition: z.string(),\n        anomalies_watching: z.array(z.object({\n            account_name: z.string(),\n            signal: z.string(),\n            watch_until_date: z.string(),\n        })),\n    }),\n});\n\n// â”€â”€â”€ HTML email builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction buildBriefingHtml(\n    repEmail: string,\n    briefingDate: string,\n    briefing: z.infer<typeof BriefingResponseSchema>,\n): string {\n    const urgencyColor = (u: string) =>\n        ({ immediate: \"#dc2626\", this_week: \"#f59e0b\", this_month: \"#3b82f6\" }[u] ?? \"#6b7280\");\n\n    const priorityRows = briefing.priority_items.map((item) => `\n    <tr>\n      <td style=\"padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 600; color: #111;\">${item.account_name}</td>\n      <td style=\"padding: 12px; border-bottom: 1px solid #f3f4f6; color: #374151;\">${item.action}</td>\n      <td style=\"padding: 12px; border-bottom: 1px solid #f3f4f6;\">\n        <span style=\"background: ${urgencyColor(item.urgency)}1a; color: ${urgencyColor(item.urgency)}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;\">${item.urgency.replace(/_/g, \" \")}</span>\n      </td>\n      <td style=\"padding: 12px; border-bottom: 1px solid #f3f4f6; color: #6b7280; font-size: 13px;\">${item.why}</td>\n    </tr>\n  `).join(\"\");\n\n    const atRiskRows = briefing.at_risk_accounts.length > 0\n        ? `\n      <div style=\"background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin: 20px 0;\">\n        <h3 style=\"margin: 0 0 12px; color: #dc2626; font-size: 14px;\">âš ï¸ At-Risk Watch List</h3>\n        ${briefing.at_risk_accounts.map((a) => `\n          <div style=\"margin-bottom: 8px;\">\n            <span style=\"font-weight: 600; color: #111;\">${a.account_name}</span>\n            <span style=\"color: #dc2626; font-size: 13px;\"> â€” ${a.signal}</span>\n          </div>\n        `).join(\"\")}\n      </div>\n    `\n        : \"\";\n\n    return `\n    <!DOCTYPE html>\n    <html>\n    <head><meta charset=\"utf-8\" /></head>\n    <body style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; margin: 0; padding: 20px;\">\n      <div style=\"max-width: 700px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);\">\n        \n        <!-- Header -->\n        <div style=\"background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 24px 32px;\">\n          <p style=\"margin: 0 0 4px; color: rgba(255,255,255,0.7); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;\">Revenue Intelligence Agent</p>\n          <h1 style=\"margin: 0 0 4px; color: white; font-size: 22px;\">Daily Briefing</h1>\n          <p style=\"margin: 0; color: rgba(255,255,255,0.8); font-size: 13px;\">${briefingDate}</p>\n        </div>\n\n        <div style=\"padding: 32px;\">\n\n          <!-- Headline Action -->\n          <div style=\"background: #f0fdf4; border-left: 4px solid #22c55e; padding: 16px; border-radius: 0 8px 8px 0; margin-bottom: 24px;\">\n            <p style=\"margin: 0 0 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #16a34a; font-weight: 700;\">Today's #1 Action</p>\n            <p style=\"margin: 0; font-size: 16px; font-weight: 700; color: #111;\">${briefing.headline_action}</p>\n          </div>\n\n          <!-- Priority Items -->\n          <h2 style=\"font-size: 16px; color: #111; margin: 0 0 12px;\">Priority Accounts</h2>\n          <table style=\"width: 100%; border-collapse: collapse; margin-bottom: 24px;\">\n            <thead>\n              <tr style=\"background: #f9fafb;\">\n                <th style=\"padding: 8px 12px; text-align: left; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;\">Account</th>\n                <th style=\"padding: 8px 12px; text-align: left; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;\">Action</th>\n                <th style=\"padding: 8px 12px; text-align: left; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;\">Urgency</th>\n                <th style=\"padding: 8px 12px; text-align: left; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;\">Why</th>\n              </tr>\n            </thead>\n            <tbody>${priorityRows}</tbody>\n          </table>\n\n          ${atRiskRows}\n\n          <!-- Portfolio Summary -->\n          <div style=\"background: #f8fafc; border-radius: 8px; padding: 16px; margin-top: 16px;\">\n            <h3 style=\"margin: 0 0 8px; font-size: 14px; color: #374151;\">Portfolio Summary</h3>\n            <p style=\"margin: 0; font-size: 14px; color: #6b7280; line-height: 1.6;\">${briefing.portfolio_summary}</p>\n          </div>\n\n        </div>\n\n        <!-- Footer -->\n        <div style=\"padding: 16px 32px; background: #f9fafb; border-top: 1px solid #e5e7eb;\">\n          <p style=\"margin: 0; font-size: 12px; color: #9ca3af;\">Wallet Share Expander Â· Revenue Intelligence Agent Â· Sent to ${repEmail}</p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n}\n\n// â”€â”€â”€ Main service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function runDailyBriefing(tenantId: number): Promise<{ repCount: number; sent: string[] }> {\n    const today = new Date().toISOString().slice(0, 10);\n\n    // Load org settings to get active TM emails\n    const [settings] = await db.select().from(agentOrganizationSettings)\n        .where(eq(agentOrganizationSettings.tenantId, tenantId));\n\n    const repEmails: string[] = (settings?.activeRepEmails as string[]) ?? [];\n\n    if (repEmails.length === 0) {\n        console.warn(`[daily-briefing] No active rep emails configured for tenant ${tenantId}`);\n        return { repCount: 0, sent: [] };\n    }\n\n    const corePrompt = await getCoreSystemPrompt();\n    const agentStateRow = await readAgentState(tenantId, \"daily-briefing\");\n    const statePreamble = buildStatePreamble(agentStateRow as any);\n    const sent: string[] = [];\n\n    for (const repEmail of repEmails) {\n        try {\n            // Get enrolled accounts for this rep\n            const repAccounts = await db.select().from(accounts)\n                .where(and(\n                    eq(accounts.tenantId, tenantId),\n                    eq(accounts.assignedTm, repEmail),\n                    eq((accounts as any).enrollmentStatus, \"enrolled\"),\n                ));\n\n            if (repAccounts.length === 0) {\n                console.log(`[daily-briefing] No enrolled accounts for ${repEmail}, skipping`);\n                continue;\n            }\n\n            // Build context summaries for all accounts (limit to 10 for prompt size)\n            const accountSummaries = await Promise.all(\n                repAccounts.slice(0, 10).map(async (acc) => {\n                    try {\n                        const ctx = await assembleAccountContext(acc.id, tenantId);\n                        return `[${acc.name}]\\n${contextToPromptString(ctx)}`;\n                    } catch {\n                        return `[${acc.name}] - context unavailable`;\n                    }\n                })\n            );\n\n            // Call OpenAI\n            const completion = await openai.chat.completions.create({\n                model: \"gpt-4o\",\n                temperature: 0.3,\n                response_format: { type: \"json_object\" },\n                messages: [\n                    {\n                        role: \"system\",\n                        content: [corePrompt, statePreamble ? `\\nPRIOR OBSERVATIONS:\\n${statePreamble}` : \"\"].join(\"\\n\"),\n                    },\n                    {\n                        role: \"user\",\n                        content: [\n                            `Generate a daily briefing for territory manager: ${repEmail}`,\n                            `Today: ${today}`,\n                            \"\",\n                            \"ENROLLED ACCOUNTS:\",\n                            accountSummaries.join(\"\\n\\n---\\n\\n\"),\n                            \"\",\n                            \"Instructions:\",\n                            \"- Identify the single most important action for today (headline_action)\",\n                            \"- Surface up to 5 priority accounts with specific, data-grounded actions\",\n                            \"- Flag up to 3 at-risk accounts (declining trend, silence, negative signals)\",\n                            \"- Write a 2-3 sentence portfolio summary\",\n                            \"- Prioritize accounts where action TODAY matters â€” not just general observations\",\n                            AGENT_MEMO_INSTRUCTION,\n                        ].join(\"\\n\"),\n                    },\n                ],\n            });\n\n            const raw = JSON.parse(completion.choices[0].message.content ?? \"{}\");\n            const briefing = BriefingResponseSchema.parse(raw);\n\n            // Build and send HTML email\n            const htmlContent = buildBriefingHtml(repEmail, today, briefing);\n            await resend.emails.send({\n                from: FROM_EMAIL,\n                to: repEmail,\n                subject: `ðŸ“Š Daily Briefing: ${briefing.headline_action.slice(0, 60)}`,\n                html: htmlContent,\n            });\n\n            // Write to agent_rep_daily_briefings\n            await db.insert(agentRepDailyBriefings).values({\n                tenantId,\n                repEmail,\n                briefingDate: new Date(),\n                headlineAction: briefing.headline_action,\n                priorityItems: briefing.priority_items,\n                atRiskAccounts: briefing.at_risk_accounts,\n                htmlContent,\n                sentAt: new Date(),\n            });\n\n            // Write agent memo (last rep wins â€” this is fine for daily briefing)\n            await writeAgentMemo(tenantId, \"daily-briefing\", briefing.agent_memo);\n\n            sent.push(repEmail);\n            console.log(`[daily-briefing] Sent to ${repEmail} â€” ${briefing.priority_items.length} priorities, ${briefing.at_risk_accounts.length} at-risk`);\n        } catch (err) {\n            console.error(`[daily-briefing] Failed for ${repEmail}:`, err);\n        }\n    }\n\n    return { repCount: repEmails.length, sent };\n}\n","path":null,"size_bytes":12448,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1417,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\" | \"system\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst initialState: ThemeProviderState = {\n  theme: \"system\",\n  setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"system\",\n  storageKey = \"ai-vp-theme\",\n  ...props\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n\n    root.classList.remove(\"light\", \"dark\");\n\n    if (theme === \"system\") {\n      const systemTheme = window.matchMedia(\"(prefers-color-scheme: dark)\")\n        .matches\n        ? \"dark\"\n        : \"light\";\n\n      root.classList.add(systemTheme);\n      return;\n    }\n\n    root.classList.add(theme);\n  }, [theme]);\n\n  const value = {\n    theme,\n    setTheme: (theme: Theme) => {\n      localStorage.setItem(storageKey, theme);\n      setTheme(theme);\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};\n","path":null,"size_bytes":1603,"size_tokens":null},"client/src/pages/accounts.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { DataTable } from \"@/components/data-table\";\nimport { ScoreBadge } from \"@/components/score-badge\";\nimport { ProgressRing } from \"@/components/progress-ring\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n  DialogFooter,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Search,\n  Filter,\n  Users,\n  Download,\n  ChevronRight,\n  TrendingUp,\n  DollarSign,\n  Target,\n  AlertTriangle,\n  HelpCircle,\n  ArrowUpDown,\n  Settings,\n  ExternalLink,\n  Sparkles,\n  Phone,\n  Mail,\n  MapPin,\n  Loader2,\n  Crown,\n  Building2,\n  Shield,\n  Briefcase,\n  Eye,\n  Clock,\n  Swords,\n  Zap,\n  Package,\n  FolderKanban,\n  Contact,\n} from \"lucide-react\";\nimport type { Contact as ContactType, Project, OrderSignal, CompetitorMention } from \"@shared/schema\";\nimport { Link, useLocation, useSearch } from \"wouter\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\n\ninterface AccountWithMetrics {\n  id: number;\n  name: string;\n  segment: string;\n  region: string;\n  assignedTm: string;\n  status: string;\n  last12mRevenue: number;\n  categoryPenetration: number;\n  opportunityScore: number;\n  gapCategories: Array<{\n    name: string;\n    gapPct: number;\n    estimatedValue: number;\n  }>;\n  enrolled: boolean;\n}\n\nconst ROLE_LABELS: Record<string, string> = {\n  decision_maker: \"Decision Maker\",\n  owner: \"Owner\",\n  purchaser: \"Purchaser\",\n  project_manager: \"Project Mgr\",\n  estimator: \"Estimator\",\n  influencer: \"Influencer\",\n  gatekeeper: \"Gatekeeper\",\n  unknown: \"Unknown\",\n};\n\nfunction AccountContactsTab({ accountId }: { accountId: number }) {\n  const { data: contacts, isLoading } = useQuery<ContactType[]>({\n    queryKey: [`/api/crm/contacts?accountId=${accountId}`],\n  });\n\n  if (isLoading) return <div className=\"flex justify-center py-8\"><Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" /></div>;\n\n  if (!contacts?.length) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Contact className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n        <p className=\"text-sm\">No contacts found for this account</p>\n        <p className=\"text-xs mt-1\">Connect your email inbox in Settings to auto-detect contacts</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-2 pt-2\" data-testid=\"section-account-contacts\">\n      {contacts.map((c) => {\n        const isKeyPerson = c.role === \"decision_maker\" || c.role === \"owner\";\n        return (\n          <div key={c.id} className=\"flex items-center justify-between p-3 rounded-md border\" data-testid={`account-contact-${c.id}`}>\n            <div className=\"flex items-center gap-3 min-w-0\">\n              <div className=\"flex h-8 w-8 items-center justify-center rounded-full bg-primary/10 text-primary shrink-0\">\n                <span className=\"text-xs font-semibold\" data-testid={`text-contact-initials-${c.id}`}>{c.firstName?.[0]}{(c.lastName || \"\")[0]}</span>\n              </div>\n              <div className=\"min-w-0\">\n                <div className=\"flex items-center gap-2\">\n                  <span className=\"font-medium text-sm truncate\" data-testid={`text-contact-name-${c.id}`}>{c.firstName} {c.lastName || \"\"}</span>\n                  {isKeyPerson && <Crown className=\"h-3 w-3 text-amber-500 shrink-0\" data-testid={`badge-key-person-${c.id}`} />}\n                </div>\n                <p className=\"text-xs text-muted-foreground truncate\">\n                  {c.title && <span data-testid={`text-contact-title-${c.id}`}>{c.title}</span>}\n                  {c.title && c.role && <span> Â· </span>}\n                  {c.role && <span data-testid={`text-contact-role-${c.id}`}>{ROLE_LABELS[c.role] || c.role}</span>}\n                </p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-1 shrink-0\">\n              {c.email && (\n                <Button variant=\"ghost\" size=\"icon\" onClick={() => window.open(`mailto:${c.email}`)} data-testid={`button-email-contact-${c.id}`}>\n                  <Mail className=\"h-4 w-4\" />\n                </Button>\n              )}\n              {c.phone && (\n                <Button variant=\"ghost\" size=\"icon\" onClick={() => window.open(`tel:${c.phone}`)} data-testid={`button-phone-contact-${c.id}`}>\n                  <Phone className=\"h-4 w-4\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        );\n      })}\n      <Link href=\"/crm/contacts\">\n        <Button variant=\"link\" size=\"sm\" className=\"w-full mt-2\" data-testid=\"link-view-all-contacts\">\n          View all contacts <ChevronRight className=\"h-3 w-3 ml-1\" />\n        </Button>\n      </Link>\n    </div>\n  );\n}\n\nfunction AccountProjectsTab({ accountId }: { accountId: number }) {\n  const { data: projects, isLoading } = useQuery<Project[]>({\n    queryKey: [`/api/crm/projects?accountId=${accountId}`],\n  });\n\n  if (isLoading) return <div className=\"flex justify-center py-8\"><Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" /></div>;\n\n  if (!projects?.length) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <FolderKanban className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n        <p className=\"text-sm\">No projects found for this account</p>\n        <p className=\"text-xs mt-1\">Projects are detected automatically from email conversations</p>\n      </div>\n    );\n  }\n\n  const STAGE_COLORS: Record<string, string> = {\n    identified: \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\",\n    bidding: \"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300\",\n    awarded: \"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300\",\n    in_progress: \"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300\",\n    completed: \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300\",\n    lost: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\",\n  };\n\n  const STAGE_LABELS: Record<string, string> = {\n    identified: \"Identified\", bidding: \"Bidding\", awarded: \"Awarded\",\n    in_progress: \"In Progress\", completed: \"Completed\", lost: \"Lost\",\n  };\n\n  return (\n    <div className=\"space-y-2 pt-2\" data-testid=\"section-account-projects\">\n      {projects.map((p) => {\n        const categories = (p.productCategories as string[] | null) || [];\n        return (\n          <div key={p.id} className=\"p-3 rounded-md border\" data-testid={`account-project-${p.id}`}>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-2 min-w-0\">\n                <span className=\"font-medium text-sm truncate\" data-testid={`text-project-name-${p.id}`}>{p.name}</span>\n                <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${STAGE_COLORS[p.stage || \"identified\"] || STAGE_COLORS.identified}`} data-testid={`badge-project-stage-${p.id}`}>\n                  {STAGE_LABELS[p.stage || \"identified\"] || p.stage}\n                </span>\n              </div>\n              {p.estimatedValue && (\n                <span className=\"font-semibold text-sm shrink-0\" data-testid={`text-project-value-${p.id}`}>\n                  ${parseFloat(p.estimatedValue as string).toLocaleString()}\n                </span>\n              )}\n            </div>\n            <div className=\"flex items-center gap-3 text-xs text-muted-foreground mt-1\">\n              {p.location && <span className=\"inline-flex items-center gap-1\" data-testid={`text-project-location-${p.id}`}><MapPin className=\"h-3 w-3\" />{p.location}</span>}\n              {p.generalContractor && <span data-testid={`text-project-gc-${p.id}`}>{p.generalContractor}</span>}\n            </div>\n            {categories.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mt-2\" data-testid={`section-project-categories-${p.id}`}>\n                {categories.slice(0, 3).map((cat, i) => (\n                  <Badge key={i} variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\" data-testid={`badge-category-${cat}-${p.id}`}>{cat}</Badge>\n                ))}\n                {categories.length > 3 && <span className=\"text-[10px] text-muted-foreground\">+{categories.length - 3}</span>}\n              </div>\n            )}\n          </div>\n        );\n      })}\n      <Link href=\"/crm/projects\">\n        <Button variant=\"link\" size=\"sm\" className=\"w-full mt-2\" data-testid=\"link-view-all-projects\">\n          View all projects <ChevronRight className=\"h-3 w-3 ml-1\" />\n        </Button>\n      </Link>\n    </div>\n  );\n}\n\nfunction AccountActivityTab({ accountId }: { accountId: number }) {\n  const { data: signals, isLoading: loadingSignals } = useQuery<OrderSignal[]>({\n    queryKey: [`/api/crm/order-signals?accountId=${accountId}`],\n  });\n\n  const { data: threats, isLoading: loadingThreats } = useQuery<CompetitorMention[]>({\n    queryKey: [`/api/crm/competitor-mentions?accountId=${accountId}`],\n  });\n\n  const isLoading = loadingSignals || loadingThreats;\n  if (isLoading) return <div className=\"flex justify-center py-8\"><Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" /></div>;\n\n  const hasData = (signals?.length || 0) > 0 || (threats?.length || 0) > 0;\n\n  if (!hasData) {\n    return (\n      <div className=\"text-center py-8 text-muted-foreground\">\n        <Zap className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n        <p className=\"text-sm\">No activity signals for this account</p>\n        <p className=\"text-xs mt-1\">Order signals and competitor mentions appear here when detected from emails</p>\n      </div>\n    );\n  }\n\n  const URGENCY_COLORS: Record<string, string> = {\n    immediate: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\",\n    this_week: \"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300\",\n    this_month: \"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300\",\n    next_quarter: \"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300\",\n    exploring: \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\",\n    normal: \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\",\n  };\n\n  const THREAT_COLORS: Record<string, string> = {\n    critical: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\",\n    high: \"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300\",\n    medium: \"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300\",\n    low: \"bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400\",\n  };\n\n  return (\n    <div className=\"space-y-4 pt-2\" data-testid=\"section-account-activity\">\n      {(signals?.length || 0) > 0 && (\n        <div data-testid=\"section-order-signals\">\n          <h4 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 flex items-center gap-1.5\" data-testid=\"heading-order-signals\">\n            <Zap className=\"h-3 w-3\" /> Order Signals ({signals!.length})\n          </h4>\n          <div className=\"space-y-2\">\n            {signals!.slice(0, 5).map((s) => (\n              <div key={s.id} className=\"flex items-center justify-between p-2.5 rounded-md border text-sm\" data-testid={`account-signal-${s.id}`}>\n                <div className=\"flex items-center gap-2 min-w-0\">\n                  <Package className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\n                  <span className=\"truncate\" data-testid={`text-signal-category-${s.id}`}>{s.productCategory || s.signalType}</span>\n                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${URGENCY_COLORS[s.urgency || \"normal\"]}`} data-testid={`badge-signal-urgency-${s.id}`}>\n                    {s.urgency || \"normal\"}\n                  </span>\n                  {s.competitorPriceMentioned && (\n                    <Badge variant=\"destructive\" className=\"text-[10px] px-1 py-0\" data-testid={`badge-competitor-pricing-${s.id}`}>Competitor $</Badge>\n                  )}\n                </div>\n                {s.estimatedValue && (\n                  <span className=\"font-medium shrink-0 ml-2\" data-testid={`text-signal-value-${s.id}`}>${parseFloat(s.estimatedValue as string).toLocaleString()}</span>\n                )}\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {(threats?.length || 0) > 0 && (\n        <div data-testid=\"section-competitor-threats\">\n          <h4 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 flex items-center gap-1.5\" data-testid=\"heading-competitor-threats\">\n            <Swords className=\"h-3 w-3\" /> Competitor Threats ({threats!.length})\n          </h4>\n          <div className=\"space-y-2\">\n            {threats!.slice(0, 5).map((t) => (\n              <div key={t.id} className=\"flex items-center justify-between p-2.5 rounded-md border text-sm\" data-testid={`account-threat-${t.id}`}>\n                <div className=\"flex items-center gap-2 min-w-0\">\n                  <Swords className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\n                  <span className=\"font-medium truncate\" data-testid={`text-threat-competitor-${t.id}`}>{t.competitorName}</span>\n                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${THREAT_COLORS[t.threatLevel || \"medium\"]}`} data-testid={`badge-threat-level-${t.id}`}>\n                    {t.threatLevel || \"medium\"}\n                  </span>\n                  {t.productCategory && <span className=\"text-xs text-muted-foreground truncate\" data-testid={`text-threat-category-${t.id}`}>{t.productCategory}</span>}\n                </div>\n                {(t.competitorPrice || t.ourPrice) && (\n                  <div className=\"text-right text-xs shrink-0 ml-2\">\n                    {t.competitorPrice && <div className=\"text-red-600\" data-testid={`text-competitor-price-${t.id}`}>Them: {t.competitorPrice}</div>}\n                    {t.ourPrice && <div className=\"text-green-600\" data-testid={`text-our-price-${t.id}`}>Us: {t.ourPrice}</div>}\n                  </div>\n                )}\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      <Link href=\"/crm/signals\">\n        <Button variant=\"link\" size=\"sm\" className=\"w-full\" data-testid=\"link-view-all-signals\">\n          View all signals & threats <ChevronRight className=\"h-3 w-3 ml-1\" />\n        </Button>\n      </Link>\n    </div>\n  );\n}\n\nexport default function Accounts() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [segmentFilter, setSegmentFilter] = useState<string>(\"all\");\n  const [regionFilter, setRegionFilter] = useState<string>(\"all\");\n  const [sortBy, setSortBy] = useState<string>(\"default\");\n  const [selectedAccount, setSelectedAccount] = useState<AccountWithMetrics | null>(null);\n  const [showCreateTaskDialog, setShowCreateTaskDialog] = useState(false);\n  const [taskType, setTaskType] = useState<string>(\"call\");\n  const [taskTitle, setTaskTitle] = useState(\"\");\n  const [taskDescription, setTaskDescription] = useState(\"\");\n  const [taskDueDate, setTaskDueDate] = useState(\"\");\n  const searchParams = useSearch();\n  const { toast } = useToast();\n\n  const { data: accounts, isLoading } = useQuery<AccountWithMetrics[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  const createTaskMutation = useMutation({\n    mutationFn: async (taskData: {\n      accountId: number;\n      taskType: string;\n      title: string;\n      description: string;\n      assignedTm: string;\n      dueDate: string;\n      status: string;\n    }) => {\n      const response = await apiRequest(\"POST\", \"/api/tasks\", taskData);\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Task created\",\n        description: \"The task has been created successfully.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/daily-focus\"] });\n      setShowCreateTaskDialog(false);\n      resetTaskForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to create task. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetTaskForm = () => {\n    setTaskType(\"call\");\n    setTaskTitle(\"\");\n    setTaskDescription(\"\");\n    setTaskDueDate(\"\");\n  };\n\n  const [isEnrolling, setIsEnrolling] = useState(false);\n\n  const handleEnrollAccount = async () => {\n    if (!selectedAccount) return;\n    \n    setIsEnrolling(true);\n    try {\n      const response = await apiRequest(\"POST\", `/api/accounts/${selectedAccount.id}/enroll`, {});\n      const data = await response.json();\n      \n      queryClient.invalidateQueries({ queryKey: [\"/api/accounts\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/enrolled-accounts\"] });\n      \n      toast({\n        title: \"Account enrolled\",\n        description: `${selectedAccount.name} is now enrolled in the growth program`,\n      });\n\n      if (data.playbook) {\n        queryClient.invalidateQueries({ queryKey: [\"/api/playbooks\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/tasks\"] });\n        toast({\n          title: \"Playbook generated\",\n          description: `AI-powered playbook created with ${data.playbook.taskCount || 0} personalized tasks`,\n        });\n      }\n      \n      setSelectedAccount(null);\n    } catch (error: any) {\n      console.error(\"Enrollment error:\", error);\n      \n      const errorMessage = error.message || \"\";\n      const isLimitExceeded = errorMessage.includes(\"FEATURE_LIMIT_EXCEEDED\") || errorMessage.includes(\"limit\");\n      const isUpgradeRequired = errorMessage.includes(\"upgrade\") || errorMessage.includes(\"Upgrade\");\n      \n      if (isLimitExceeded || isUpgradeRequired) {\n        toast({\n          title: \"Upgrade Required\",\n          description: \"You've reached your plan limit. Visit the Subscription page to upgrade and enroll more accounts.\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Enrollment failed\",\n          description: \"Please try again\",\n          variant: \"destructive\",\n        });\n      }\n    } finally {\n      setIsEnrolling(false);\n    }\n  };\n\n  const handleCreateTask = () => {\n    if (!selectedAccount) {\n      toast({\n        title: \"Error\",\n        description: \"No account selected.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    if (!taskTitle.trim()) {\n      toast({\n        title: \"Error\",\n        description: \"Please enter a task title.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Convert date string to ISO timestamp or use tomorrow's date as default\n    const dueDateTimestamp = taskDueDate \n      ? new Date(taskDueDate).toISOString()\n      : new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();\n    \n    createTaskMutation.mutate({\n      accountId: selectedAccount.id,\n      taskType: taskType,\n      title: taskTitle.trim(),\n      description: taskDescription.trim(),\n      assignedTm: selectedAccount.assignedTm,\n      dueDate: dueDateTimestamp,\n      status: \"pending\",\n    });\n  };\n\n  const openCreateTaskDialog = () => {\n    if (!selectedAccount) return;\n    setShowCreateTaskDialog(true);\n  };\n\n  interface ScoringWeights {\n    gapSizeWeight: number;\n    revenuePotentialWeight: number;\n    categoryCountWeight: number;\n  }\n\n  const { data: scoringWeights } = useQuery<ScoringWeights>({\n    queryKey: [\"/api/scoring-weights\"],\n  });\n\n  const weights = scoringWeights || {\n    gapSizeWeight: 40,\n    revenuePotentialWeight: 30,\n    categoryCountWeight: 30,\n  };\n\n  // Mock data for demonstration\n  const mockAccounts: AccountWithMetrics[] = [\n    {\n      id: 1,\n      name: \"ABC Plumbing Co\",\n      segment: \"Plumbing\",\n      region: \"Northeast\",\n      assignedTm: \"John Smith\",\n      status: \"active\",\n      last12mRevenue: 125000,\n      categoryPenetration: 45,\n      opportunityScore: 87,\n      gapCategories: [\n        { name: \"Water Heaters\", gapPct: 35, estimatedValue: 18000 },\n        { name: \"Tools & Safety\", gapPct: 28, estimatedValue: 12000 },\n        { name: \"PVF\", gapPct: 15, estimatedValue: 8000 },\n      ],\n      enrolled: true,\n    },\n    {\n      id: 2,\n      name: \"Elite HVAC Services\",\n      segment: \"HVAC\",\n      region: \"Southeast\",\n      assignedTm: \"Sarah Johnson\",\n      status: \"active\",\n      last12mRevenue: 210000,\n      categoryPenetration: 52,\n      opportunityScore: 82,\n      gapCategories: [\n        { name: \"Controls & Thermostats\", gapPct: 25, estimatedValue: 15000 },\n        { name: \"Pipe & Fittings\", gapPct: 20, estimatedValue: 12000 },\n      ],\n      enrolled: true,\n    },\n    {\n      id: 3,\n      name: \"Metro Mechanical\",\n      segment: \"Mechanical\",\n      region: \"Midwest\",\n      assignedTm: \"Mike Wilson\",\n      status: \"active\",\n      last12mRevenue: 175000,\n      categoryPenetration: 38,\n      opportunityScore: 76,\n      gapCategories: [\n        { name: \"Water Heaters\", gapPct: 40, estimatedValue: 22000 },\n        { name: \"Ductwork\", gapPct: 18, estimatedValue: 10000 },\n      ],\n      enrolled: false,\n    },\n    {\n      id: 4,\n      name: \"Premier Plumbing\",\n      segment: \"Plumbing\",\n      region: \"Northeast\",\n      assignedTm: \"John Smith\",\n      status: \"active\",\n      last12mRevenue: 98000,\n      categoryPenetration: 55,\n      opportunityScore: 71,\n      gapCategories: [\n        { name: \"PVF\", gapPct: 22, estimatedValue: 8000 },\n        { name: \"Tools\", gapPct: 18, estimatedValue: 6000 },\n      ],\n      enrolled: false,\n    },\n    {\n      id: 5,\n      name: \"Climate Control Inc\",\n      segment: \"HVAC\",\n      region: \"West\",\n      assignedTm: \"Lisa Brown\",\n      status: \"active\",\n      last12mRevenue: 320000,\n      categoryPenetration: 68,\n      opportunityScore: 68,\n      gapCategories: [\n        { name: \"Refrigerant & Supplies\", gapPct: 15, estimatedValue: 12000 },\n      ],\n      enrolled: true,\n    },\n    {\n      id: 6,\n      name: \"Superior Heating\",\n      segment: \"HVAC\",\n      region: \"Midwest\",\n      assignedTm: \"Mike Wilson\",\n      status: \"active\",\n      last12mRevenue: 145000,\n      categoryPenetration: 42,\n      opportunityScore: 79,\n      gapCategories: [\n        { name: \"Controls\", gapPct: 30, estimatedValue: 14000 },\n        { name: \"Water Heaters\", gapPct: 25, estimatedValue: 11000 },\n      ],\n      enrolled: false,\n    },\n  ];\n\n  const displayAccounts = accounts || mockAccounts;\n  const segments = Array.from(new Set(displayAccounts.map((a) => a.segment)));\n  const regions = Array.from(new Set(displayAccounts.map((a) => a.region)));\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchParams);\n    const accountId = params.get(\"account\") || params.get(\"highlight\");\n    if (accountId && displayAccounts.length > 0) {\n      const account = displayAccounts.find((a) => a.id === parseInt(accountId));\n      if (account) {\n        setSelectedAccount(account);\n      }\n    }\n  }, [searchParams, displayAccounts]);\n\n  const getRevenueImpact = (account: AccountWithMetrics) => {\n    return account.gapCategories.reduce((sum, gap) => sum + gap.estimatedValue, 0);\n  };\n\n  const filteredAndSortedAccounts = useMemo(() => {\n    let result = displayAccounts.filter((account) => {\n      const matchesSearch =\n        account.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        account.assignedTm.toLowerCase().includes(searchQuery.toLowerCase());\n      const matchesSegment = segmentFilter === \"all\" || account.segment === segmentFilter;\n      const matchesRegion = regionFilter === \"all\" || account.region === regionFilter;\n      return matchesSearch && matchesSegment && matchesRegion;\n    });\n\n    if (sortBy === \"revenue-impact\") {\n      result = [...result].sort((a, b) => getRevenueImpact(b) - getRevenueImpact(a));\n    } else if (sortBy === \"opportunity-score\") {\n      result = [...result].sort((a, b) => b.opportunityScore - a.opportunityScore);\n    } else if (sortBy === \"revenue\") {\n      result = [...result].sort((a, b) => b.last12mRevenue - a.last12mRevenue);\n    } else if (sortBy === \"penetration-low\") {\n      result = [...result].sort((a, b) => a.categoryPenetration - b.categoryPenetration);\n    }\n\n    return result;\n  }, [displayAccounts, searchQuery, segmentFilter, regionFilter, sortBy]);\n\n  const filteredAccounts = filteredAndSortedAccounts;\n\n  const formatCurrency = (value: number) => {\n    if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;\n    if (value >= 1000) return `$${(value / 1000).toFixed(0)}K`;\n    return `$${value.toFixed(0)}`;\n  };\n\n  const columns = [\n    {\n      key: \"name\",\n      header: \"Account\",\n      cell: (row: AccountWithMetrics) => (\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex h-9 w-9 items-center justify-center rounded-md bg-primary/10 text-primary\">\n            <Users className=\"h-4 w-4\" />\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"font-medium\">{row.name}</span>\n            <span className=\"text-xs text-muted-foreground\">{row.assignedTm}</span>\n          </div>\n        </div>\n      ),\n    },\n    {\n      key: \"segment\",\n      header: \"Segment\",\n      cell: (row: AccountWithMetrics) => (\n        <Badge variant=\"outline\">{row.segment}</Badge>\n      ),\n    },\n    {\n      key: \"region\",\n      header: \"Region\",\n      cell: (row: AccountWithMetrics) => (\n        <span className=\"text-muted-foreground\">{row.region}</span>\n      ),\n    },\n    {\n      key: \"last12mRevenue\",\n      header: \"Revenue (12M)\",\n      cell: (row: AccountWithMetrics) => (\n        <span className=\"font-semibold\">{formatCurrency(row.last12mRevenue)}</span>\n      ),\n    },\n    {\n      key: \"categoryPenetration\",\n      header: \"Penetration\",\n      cell: (row: AccountWithMetrics) => (\n        <ProgressRing\n          value={row.categoryPenetration}\n          size={36}\n          strokeWidth={4}\n          testId={`penetration-${row.id}`}\n        />\n      ),\n    },\n    {\n      key: \"opportunityScore\",\n      header: \"Opportunity\",\n      cell: (row: AccountWithMetrics) => (\n        <ScoreBadge score={row.opportunityScore} testId={`score-${row.id}`} />\n      ),\n    },\n    {\n      key: \"enrolled\",\n      header: \"Status\",\n      cell: (row: AccountWithMetrics) => (\n        <Badge variant={row.enrolled ? \"default\" : \"secondary\"}>\n          {row.enrolled ? \"Enrolled\" : \"Not Enrolled\"}\n        </Badge>\n      ),\n    },\n    {\n      key: \"actions\",\n      header: \"\",\n      cell: (row: AccountWithMetrics) => (\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setSelectedAccount(row)}\n          data-testid={`button-view-${row.id}`}\n        >\n          <ChevronRight className=\"h-4 w-4\" />\n        </Button>\n      ),\n    },\n  ];\n\n  const totalOpportunity = filteredAccounts.reduce(\n    (sum, acc) => sum + acc.gapCategories.reduce((s, g) => s + g.estimatedValue, 0),\n    0\n  );\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-accounts\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Account Insights</h1>\n          <p className=\"text-muted-foreground\">\n            View and analyze wallet share opportunities by account\n          </p>\n        </div>\n        <Button variant=\"outline\" data-testid=\"button-export-accounts\">\n          <Download className=\"mr-2 h-4 w-4\" />\n          Export CSV\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary/10\">\n                  <Users className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{filteredAccounts.length}</p>\n                  <p className=\"text-xs text-muted-foreground\">Total Accounts</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-accounts-total\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Number of customer accounts matching your current filter criteria. Use filters to narrow down by segment or region.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-2/10\">\n                  <Target className=\"h-5 w-5 text-chart-2\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {filteredAccounts.filter((a) => a.enrolled).length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Enrolled</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-accounts-enrolled\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Accounts currently enrolled in the revenue growth program. Enrolled accounts are tracked for incremental revenue to calculate rev-share fees.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-3/10\">\n                  <AlertTriangle className=\"h-5 w-5 text-chart-3\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {filteredAccounts.filter((a) => a.opportunityScore >= 70).length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">High Priority</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-accounts-high-priority\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Accounts with opportunity scores of 70+ have significant category gaps compared to their ICP profile. These are prime targets for outreach.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-1/10\">\n                  <DollarSign className=\"h-5 w-5 text-chart-1\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">{formatCurrency(totalOpportunity)}</p>\n                  <p className=\"text-xs text-muted-foreground\">Est. Opportunity</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-accounts-opportunity\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Total estimated revenue opportunity across all filtered accounts based on their category gaps and potential wallet share capture.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center gap-4\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search accounts or TMs...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-9\"\n                data-testid=\"input-search-accounts\"\n              />\n            </div>\n            <div className=\"flex gap-2 flex-wrap\">\n              <Select value={sortBy} onValueChange={setSortBy}>\n                <SelectTrigger className=\"w-44\" data-testid=\"select-sort\">\n                  <ArrowUpDown className=\"h-4 w-4 mr-2\" />\n                  <SelectValue placeholder=\"Sort by\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"default\">Default Order</SelectItem>\n                  <SelectItem value=\"revenue-impact\">Revenue Impact (High to Low)</SelectItem>\n                  <SelectItem value=\"opportunity-score\">Opportunity Score</SelectItem>\n                  <SelectItem value=\"revenue\">Current Revenue</SelectItem>\n                  <SelectItem value=\"penetration-low\">Lowest Penetration</SelectItem>\n                </SelectContent>\n              </Select>\n              <Select value={segmentFilter} onValueChange={setSegmentFilter}>\n                <SelectTrigger className=\"w-36\" data-testid=\"select-segment\">\n                  <Filter className=\"h-4 w-4 mr-2\" />\n                  <SelectValue placeholder=\"Segment\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Segments</SelectItem>\n                  {segments.map((segment) => (\n                    <SelectItem key={segment} value={segment}>\n                      {segment}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Select value={regionFilter} onValueChange={setRegionFilter}>\n                <SelectTrigger className=\"w-36\" data-testid=\"select-region\">\n                  <SelectValue placeholder=\"Region\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Regions</SelectItem>\n                  {regions.map((region) => (\n                    <SelectItem key={region} value={region}>\n                      {region}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {filteredAccounts.length === 0 ? (\n            <EmptyState\n              icon={Users}\n              title=\"No accounts found\"\n              description=\"Try adjusting your filters or upload account data\"\n              testId=\"empty-accounts\"\n            />\n          ) : (\n            <DataTable\n              columns={columns}\n              data={filteredAccounts}\n              isLoading={isLoading}\n              testId=\"table-accounts\"\n            />\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!selectedAccount} onOpenChange={() => setSelectedAccount(null)}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[85vh] overflow-y-auto\">\n          {selectedAccount && (\n            <>\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center gap-2\">\n                  {selectedAccount.name}\n                  <Badge variant={selectedAccount.enrolled ? \"default\" : \"secondary\"}>\n                    {selectedAccount.enrolled ? \"Enrolled\" : \"Not Enrolled\"}\n                  </Badge>\n                </DialogTitle>\n              </DialogHeader>\n\n              <Tabs defaultValue=\"overview\" data-testid=\"account-detail-tabs\">\n                <TabsList className=\"w-full\" data-testid=\"account-tabs-list\">\n                  <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n                  <TabsTrigger value=\"contacts\" data-testid=\"tab-contacts\">Contacts</TabsTrigger>\n                  <TabsTrigger value=\"projects\" data-testid=\"tab-projects\">Projects</TabsTrigger>\n                  <TabsTrigger value=\"activity\" data-testid=\"tab-activity\">Activity</TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"overview\">\n                  <div className=\"space-y-6 pt-2\">\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Segment</p>\n                        <p className=\"font-medium\">{selectedAccount.segment}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Region</p>\n                        <p className=\"font-medium\">{selectedAccount.region}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Assigned TM</p>\n                        <p className=\"font-medium\">{selectedAccount.assignedTm}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Revenue (12M)</p>\n                        <p className=\"font-medium\">\n                          {formatCurrency(selectedAccount.last12mRevenue)}\n                        </p>\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <Card>\n                        <CardContent className=\"pt-4 flex items-center justify-between\">\n                          <div>\n                            <div className=\"flex items-center gap-2\">\n                              <p className=\"text-sm text-muted-foreground\">Category Penetration</p>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-category-penetration\">\n                                    <HelpCircle className=\"h-3 w-3\" />\n                                  </button>\n                                </TooltipTrigger>\n                                <TooltipContent className=\"max-w-xs\" side=\"top\">\n                                  <p className=\"text-sm font-medium mb-2\">How Category Penetration is Calculated</p>\n                                  <div className=\"text-xs space-y-2\">\n                                    <p>Category Penetration measures how many of the ICP (Ideal Customer Profile) categories this account is actively purchasing from.</p>\n                                    <div className=\"bg-muted/50 p-2 rounded\">\n                                      <p className=\"font-medium\">Formula:</p>\n                                      <p className=\"font-mono text-xs\">(Categories with purchases / Total ICP categories) x 100</p>\n                                    </div>\n                                    <p>A higher percentage means the account is buying across more expected categories. A lower percentage indicates opportunities to expand their product mix.</p>\n                                  </div>\n                                </TooltipContent>\n                              </Tooltip>\n                            </div>\n                            <p className=\"text-2xl font-bold\">\n                              {selectedAccount.categoryPenetration}%\n                            </p>\n                          </div>\n                          <ProgressRing\n                            value={selectedAccount.categoryPenetration}\n                            size={60}\n                            strokeWidth={6}\n                          />\n                        </CardContent>\n                      </Card>\n                      <Card>\n                        <CardContent className=\"pt-4 flex items-center justify-between\">\n                          <div>\n                            <div className=\"flex items-center gap-2\">\n                              <p className=\"text-sm text-muted-foreground\">Opportunity Score</p>\n                              <Popover>\n                                <PopoverTrigger asChild>\n                                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-opportunity-score\">\n                                    <HelpCircle className=\"h-3 w-3\" />\n                                  </button>\n                                </PopoverTrigger>\n                                <PopoverContent className=\"w-80\" side=\"top\">\n                                  <p className=\"text-sm font-medium mb-2\">How Opportunity Score is Calculated</p>\n                                  <div className=\"text-xs space-y-2\">\n                                    <p>The Opportunity Score is a weighted composite that identifies accounts with the highest potential for wallet share capture.</p>\n                                    <div className=\"bg-muted/50 p-2 rounded space-y-1\">\n                                      <p className=\"font-medium\">Current Weighting:</p>\n                                      <div className=\"grid grid-cols-2 gap-1\">\n                                        <span>Gap Size (% below ICP):</span>\n                                        <span className=\"font-semibold\">{weights.gapSizeWeight}%</span>\n                                        <span>Revenue Potential:</span>\n                                        <span className=\"font-semibold\">{weights.revenuePotentialWeight}%</span>\n                                        <span>Category Count:</span>\n                                        <span className=\"font-semibold\">{weights.categoryCountWeight}%</span>\n                                      </div>\n                                    </div>\n                                    <p>Higher scores indicate greater opportunity for incremental revenue if enrolled.</p>\n                                    <Link href=\"/settings\" data-testid=\"link-settings\">\n                                      <Button variant=\"ghost\" size=\"sm\" className=\"gap-1\">\n                                        <Settings className=\"h-3 w-3\" />\n                                        Adjust weights in Settings\n                                        <ExternalLink className=\"h-3 w-3\" />\n                                      </Button>\n                                    </Link>\n                                  </div>\n                                </PopoverContent>\n                              </Popover>\n                            </div>\n                            <p className=\"text-2xl font-bold\">\n                              {selectedAccount.opportunityScore}\n                            </p>\n                          </div>\n                          <ScoreBadge\n                            score={selectedAccount.opportunityScore}\n                            size=\"default\"\n                          />\n                        </CardContent>\n                      </Card>\n                    </div>\n\n                    <div>\n                      <h3 className=\"text-sm font-semibold mb-3\">Gap Categories</h3>\n                      <div className=\"space-y-3\">\n                        {selectedAccount.gapCategories.map((gap) => (\n                          <div\n                            key={gap.name}\n                            className=\"flex items-center justify-between p-3 rounded-md bg-muted/50\"\n                          >\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"h-2 w-2 rounded-full bg-chart-5\" />\n                              <span className=\"font-medium\">{gap.name}</span>\n                            </div>\n                            <div className=\"flex items-center gap-4\">\n                              <div className=\"text-right\">\n                                <p className=\"text-sm font-medium text-chart-5\">\n                                  -{gap.gapPct}%\n                                </p>\n                                <p className=\"text-xs text-muted-foreground\">gap</p>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"text-sm font-semibold text-chart-2\">\n                                  {formatCurrency(gap.estimatedValue)}\n                                </p>\n                                <p className=\"text-xs text-muted-foreground\">opportunity</p>\n                              </div>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n\n                    <div className=\"flex gap-3 flex-wrap\">\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Button \n                            className=\"flex-1\" \n                            onClick={openCreateTaskDialog}\n                            data-testid=\"button-create-task\"\n                          >\n                            <TrendingUp className=\"mr-2 h-4 w-4\" />\n                            Create Task\n                          </Button>\n                        </TooltipTrigger>\n                        <TooltipContent className=\"max-w-xs\" side=\"top\">\n                          <p className=\"text-sm font-medium mb-1\">Create a Follow-up Task</p>\n                          <p className=\"text-xs\">Schedule a call, email, or visit for this account to track your outreach activities and follow up on sales opportunities.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                      {selectedAccount.opportunityScore >= 70 && (\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <span>\n                              <Button variant=\"default\" asChild data-testid=\"button-generate-playbook\">\n                                <Link href={`/playbooks?segment=${selectedAccount.segment}`}>\n                                  <Sparkles className=\"mr-2 h-4 w-4\" />\n                                  Generate Playbook\n                                </Link>\n                              </Button>\n                            </span>\n                          </TooltipTrigger>\n                          <TooltipContent className=\"max-w-xs\" side=\"top\">\n                            <p className=\"text-sm font-medium mb-1\">High-Value Opportunity</p>\n                            <p className=\"text-xs\">This account has a high opportunity score ({selectedAccount.opportunityScore}). Generate a playbook to create AI-powered call scripts and emails targeting their gap categories.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      )}\n                      {!selectedAccount.enrolled && (\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Button \n                              variant=\"outline\" \n                              data-testid=\"button-enroll-account\"\n                              onClick={handleEnrollAccount}\n                              disabled={isEnrolling}\n                            >\n                              {isEnrolling ? (\n                                <>\n                                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                                  Enrolling...\n                                </>\n                              ) : (\n                                <>\n                                  <Target className=\"mr-2 h-4 w-4\" />\n                                  Enroll in Program\n                                </>\n                              )}\n                            </Button>\n                          </TooltipTrigger>\n                          <TooltipContent className=\"max-w-xs\" side=\"top\">\n                            <p className=\"text-sm font-medium mb-1\">What does enrollment do?</p>\n                            <ul className=\"text-xs space-y-1 list-disc list-inside\">\n                              <li>Adds this account to the revenue growth program</li>\n                              <li>Tracks incremental revenue from targeted categories</li>\n                              <li>Calculates rev-share fees based on captured wallet share</li>\n                              <li>Enables performance monitoring on the Revenue tab</li>\n                              <li>Automatically generates an AI-powered sales playbook</li>\n                            </ul>\n                          </TooltipContent>\n                        </Tooltip>\n                      )}\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"contacts\">\n                  <AccountContactsTab accountId={selectedAccount.id} />\n                </TabsContent>\n\n                <TabsContent value=\"projects\">\n                  <AccountProjectsTab accountId={selectedAccount.id} />\n                </TabsContent>\n\n                <TabsContent value=\"activity\">\n                  <AccountActivityTab accountId={selectedAccount.id} />\n                </TabsContent>\n              </Tabs>\n            </>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Create Task Dialog */}\n      <Dialog open={showCreateTaskDialog} onOpenChange={(open) => {\n        setShowCreateTaskDialog(open);\n        if (!open) resetTaskForm();\n      }}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Create Task for {selectedAccount?.name}</DialogTitle>\n            <DialogDescription>\n              Schedule a follow-up activity for this account.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"task-type\">Task Type</Label>\n              <Select value={taskType} onValueChange={setTaskType}>\n                <SelectTrigger data-testid=\"select-task-type\">\n                  <SelectValue placeholder=\"Select task type\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"call\">\n                    <span className=\"flex items-center gap-2\">\n                      <Phone className=\"h-4 w-4\" />\n                      Phone Call\n                    </span>\n                  </SelectItem>\n                  <SelectItem value=\"email\">\n                    <span className=\"flex items-center gap-2\">\n                      <Mail className=\"h-4 w-4\" />\n                      Email\n                    </span>\n                  </SelectItem>\n                  <SelectItem value=\"visit\">\n                    <span className=\"flex items-center gap-2\">\n                      <MapPin className=\"h-4 w-4\" />\n                      Site Visit\n                    </span>\n                  </SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"task-title\">Title</Label>\n              <Input\n                id=\"task-title\"\n                placeholder=\"e.g., Follow up on water heater quote\"\n                value={taskTitle}\n                onChange={(e) => setTaskTitle(e.target.value)}\n                data-testid=\"input-task-title\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"task-description\">Description (optional)</Label>\n              <Textarea\n                id=\"task-description\"\n                placeholder=\"Add any notes or context for this task...\"\n                value={taskDescription}\n                onChange={(e) => setTaskDescription(e.target.value)}\n                rows={3}\n                data-testid=\"input-task-description\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"task-due-date\">Due Date</Label>\n              <Input\n                id=\"task-due-date\"\n                type=\"date\"\n                value={taskDueDate}\n                onChange={(e) => setTaskDueDate(e.target.value)}\n                data-testid=\"input-task-due-date\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setShowCreateTaskDialog(false);\n                resetTaskForm();\n              }}\n              data-testid=\"button-cancel-task\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={handleCreateTask}\n              disabled={!taskTitle.trim() || createTaskMutation.isPending}\n              data-testid=\"button-save-task\"\n            >\n              {createTaskMutation.isPending ? \"Creating...\" : \"Create Task\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":54874,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2359,"size_tokens":null},"server/replit_integrations/auth/routes.ts":{"content":"import type { Express } from \"express\";\nimport { authStorage } from \"./storage\";\nimport { isAuthenticated } from \"./replitAuth\";\n\n// Register auth-specific routes\nexport function registerAuthRoutes(app: Express): void {\n  // Get current authenticated user\n  app.get(\"/api/auth/user\", isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = req.user.claims.sub;\n      const user = await authStorage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n}\n","path":null,"size_bytes":609,"size_tokens":null},"server/replit_integrations/batch/index.ts":{"content":"export {\n  batchProcess,\n  batchProcessWithSSE,\n  isRateLimitError,\n  type BatchOptions,\n} from \"./utils\";\n\n","path":null,"size_bytes":108,"size_tokens":null},"tests/integration/auth.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport express, { Request, Response } from 'express';\n\ndescribe('Authentication Endpoints', () => {\n  describe('GET /api/login', () => {\n    it('redirects unauthenticated users to auth provider', async () => {\n      const mockRes = {\n        redirect: vi.fn(),\n      } as unknown as Response;\n      \n      const mockReq = {\n        query: {},\n        isAuthenticated: () => false,\n      } as unknown as Request;\n\n      const redirectUrl = '/api/auth/login';\n      mockRes.redirect(redirectUrl);\n      \n      expect(mockRes.redirect).toHaveBeenCalledWith('/api/auth/login');\n    });\n\n    it('redirects authenticated users to dashboard', async () => {\n      const mockRes = {\n        redirect: vi.fn(),\n      } as unknown as Response;\n      \n      const mockReq = {\n        query: { returnTo: '/dashboard' },\n        isAuthenticated: () => true,\n        user: { id: 'test-user' },\n      } as unknown as Request;\n\n      const returnTo = mockReq.query.returnTo || '/';\n      mockRes.redirect(returnTo as string);\n      \n      expect(mockRes.redirect).toHaveBeenCalledWith('/dashboard');\n    });\n  });\n\n  describe('GET /api/auth/user', () => {\n    it('returns 401 when not authenticated', async () => {\n      const mockRes = {\n        status: vi.fn().mockReturnThis(),\n        json: vi.fn(),\n      } as unknown as Response;\n      \n      const mockReq = {\n        isAuthenticated: () => false,\n        user: undefined,\n      } as unknown as Request;\n\n      if (!mockReq.isAuthenticated()) {\n        mockRes.status(401).json({ message: 'Unauthorized' });\n      }\n      \n      expect(mockRes.status).toHaveBeenCalledWith(401);\n      expect(mockRes.json).toHaveBeenCalledWith({ message: 'Unauthorized' });\n    });\n\n    it('returns user data when authenticated', async () => {\n      const testUser = {\n        id: 'user-123',\n        email: 'test@example.com',\n        firstName: 'Test',\n        lastName: 'User',\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      };\n      \n      const mockRes = {\n        json: vi.fn(),\n      } as unknown as Response;\n      \n      const mockReq = {\n        isAuthenticated: () => true,\n        user: testUser,\n      } as unknown as Request;\n\n      if (mockReq.isAuthenticated()) {\n        mockRes.json(mockReq.user);\n      }\n      \n      expect(mockRes.json).toHaveBeenCalledWith(testUser);\n    });\n  });\n\n  describe('GET /api/logout', () => {\n    it('clears session and redirects to home', async () => {\n      const mockLogout = vi.fn((cb: (err?: Error) => void) => cb());\n      const mockRes = {\n        redirect: vi.fn(),\n      } as unknown as Response;\n      \n      const mockReq = {\n        logout: mockLogout,\n        session: {\n          destroy: vi.fn((cb: (err?: Error) => void) => cb()),\n        },\n      } as unknown as Request;\n\n      await new Promise<void>((resolve) => {\n        mockReq.logout((err?: Error) => {\n          if (!err) {\n            mockReq.session.destroy(() => {\n              mockRes.redirect('/');\n              resolve();\n            });\n          }\n        });\n      });\n      \n      expect(mockLogout).toHaveBeenCalled();\n      expect(mockReq.session.destroy).toHaveBeenCalled();\n      expect(mockRes.redirect).toHaveBeenCalledWith('/');\n    });\n  });\n\n  describe('Rate Limiting', () => {\n    it('auth endpoints have rate limiting configured', () => {\n      const rateLimitConfig = {\n        login: { windowMs: 15 * 60 * 1000, max: 10 },\n        callback: { windowMs: 15 * 60 * 1000, max: 10 },\n        logout: { windowMs: 60 * 1000, max: 5 },\n      };\n\n      expect(rateLimitConfig.login.max).toBe(10);\n      expect(rateLimitConfig.login.windowMs).toBe(15 * 60 * 1000);\n      expect(rateLimitConfig.callback.max).toBe(10);\n      expect(rateLimitConfig.logout.max).toBe(5);\n      expect(rateLimitConfig.logout.windowMs).toBe(60 * 1000);\n    });\n  });\n});\n","path":null,"size_bytes":3925,"size_tokens":null},"client/src/hooks/use-auth.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/models/auth\";\n\nasync function fetchUser(): Promise<User | null> {\n  const response = await fetch(\"/api/auth/user\", {\n    credentials: \"include\",\n  });\n\n  if (response.status === 401) {\n    return null;\n  }\n\n  if (!response.ok) {\n    throw new Error(`${response.status}: ${response.statusText}`);\n  }\n\n  return response.json();\n}\n\nasync function logout(): Promise<void> {\n  window.location.href = \"/api/logout\";\n}\n\nexport function useAuth() {\n  const queryClient = useQueryClient();\n  const { data: user, isLoading } = useQuery<User | null>({\n    queryKey: [\"/api/auth/user\"],\n    queryFn: fetchUser,\n    retry: false,\n    staleTime: 1000 * 60 * 5, // 5 minutes\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: logout,\n    onSuccess: () => {\n      queryClient.setQueryData([\"/api/auth/user\"], null);\n    },\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n    logout: logoutMutation.mutate,\n    isLoggingOut: logoutMutation.isPending,\n  };\n}\n","path":null,"size_bytes":1091,"size_tokens":null},"server/middleware/featureLimits.ts":{"content":"import type { Request, Response, NextFunction, RequestHandler } from \"express\";\nimport { db } from \"../db\";\nimport { subscriptionPlans, playbooks, segmentProfiles, programAccounts } from \"@shared/schema\";\nimport { eq, count } from \"drizzle-orm\";\n\nexport interface FeatureLimits {\n  playbooks: number; // -1 = unlimited\n  icps: number; // -1 = unlimited\n  enrolled_accounts: number; // -1 = unlimited\n  accounts: number; // -1 = unlimited\n}\n\nexport interface FeatureUsage {\n  playbooks: number;\n  icps: number;\n  enrolled_accounts: number;\n  accounts: number;\n}\n\nexport interface LimitCheckResult {\n  allowed: boolean;\n  limit: number;\n  current: number;\n  feature: string;\n  planType: string;\n}\n\nconst DEFAULT_FREE_LIMITS: FeatureLimits = {\n  playbooks: 1,\n  icps: 1,\n  enrolled_accounts: 1,\n  accounts: -1,\n};\n\nexport async function getPlanLimits(planType: string): Promise<FeatureLimits> {\n  if (!planType || planType === \"free\") {\n    return DEFAULT_FREE_LIMITS;\n  }\n\n  const [plan] = await db.select()\n    .from(subscriptionPlans)\n    .where(eq(subscriptionPlans.slug, planType))\n    .limit(1);\n\n  if (!plan || !plan.limits) {\n    return DEFAULT_FREE_LIMITS;\n  }\n\n  const limits = plan.limits as Partial<FeatureLimits>;\n  return {\n    playbooks: limits.playbooks ?? -1,\n    icps: limits.icps ?? -1,\n    enrolled_accounts: limits.enrolled_accounts ?? -1,\n    accounts: limits.accounts ?? -1,\n  };\n}\n\nexport async function getFeatureUsage(tenantId: number): Promise<FeatureUsage> {\n  const [playbookCount] = await db.select({ count: count() })\n    .from(playbooks)\n    .where(eq(playbooks.tenantId, tenantId));\n\n  const [icpCount] = await db.select({ count: count() })\n    .from(segmentProfiles)\n    .where(eq(segmentProfiles.tenantId, tenantId));\n\n  const [enrolledCount] = await db.select({ count: count() })\n    .from(programAccounts)\n    .where(eq(programAccounts.tenantId, tenantId));\n\n  return {\n    playbooks: playbookCount?.count || 0,\n    icps: icpCount?.count || 0,\n    enrolled_accounts: enrolledCount?.count || 0,\n    accounts: 0, // Accounts are not typically limited\n  };\n}\n\nexport async function checkFeatureLimit(\n  tenantId: number,\n  planType: string,\n  feature: keyof FeatureLimits\n): Promise<LimitCheckResult> {\n  const limits = await getPlanLimits(planType);\n  const usage = await getFeatureUsage(tenantId);\n\n  const limit = limits[feature];\n  const current = usage[feature];\n\n  // -1 means unlimited\n  const allowed = limit === -1 || current < limit;\n\n  return {\n    allowed,\n    limit,\n    current,\n    feature,\n    planType,\n  };\n}\n\nexport function requireFeatureLimit(feature: keyof FeatureLimits): RequestHandler {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    const tenantContext = req.tenantContext;\n    const tenant = tenantContext?.tenant;\n\n    if (!tenant) {\n      return res.status(401).json({ message: \"Not authenticated\" });\n    }\n\n    const result = await checkFeatureLimit(\n      tenant.id,\n      tenant.planType || \"free\",\n      feature\n    );\n\n    if (!result.allowed) {\n      const limitText = result.limit === -1 ? \"unlimited\" : result.limit.toString();\n      const featureLabel = feature.replace(/_/g, \" \");\n      \n      return res.status(403).json({\n        message: `You have reached the limit of ${result.limit} ${featureLabel} for your ${result.planType} plan. Please upgrade to continue.`,\n        error: \"FEATURE_LIMIT_EXCEEDED\",\n        feature: result.feature,\n        limit: result.limit,\n        current: result.current,\n        planType: result.planType,\n        upgradeRequired: true,\n      });\n    }\n\n    next();\n  };\n}\n\nexport async function getUsageWithLimits(tenantId: number, planType: string) {\n  const limits = await getPlanLimits(planType);\n  const usage = await getFeatureUsage(tenantId);\n\n  return {\n    playbooks: {\n      current: usage.playbooks,\n      limit: limits.playbooks,\n      remaining: limits.playbooks === -1 ? -1 : Math.max(0, limits.playbooks - usage.playbooks),\n      unlimited: limits.playbooks === -1,\n    },\n    icps: {\n      current: usage.icps,\n      limit: limits.icps,\n      remaining: limits.icps === -1 ? -1 : Math.max(0, limits.icps - usage.icps),\n      unlimited: limits.icps === -1,\n    },\n    enrolled_accounts: {\n      current: usage.enrolled_accounts,\n      limit: limits.enrolled_accounts,\n      remaining: limits.enrolled_accounts === -1 ? -1 : Math.max(0, limits.enrolled_accounts - usage.enrolled_accounts),\n      unlimited: limits.enrolled_accounts === -1,\n    },\n  };\n}\n","path":null,"size_bytes":4499,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/components/progress-ring.tsx":{"content":"import { cn } from \"@/lib/utils\";\n\ninterface ProgressRingProps {\n  value: number;\n  maxValue?: number;\n  size?: number;\n  strokeWidth?: number;\n  className?: string;\n  showLabel?: boolean;\n  testId?: string;\n}\n\nexport function ProgressRing({\n  value,\n  maxValue = 100,\n  size = 60,\n  strokeWidth = 6,\n  className,\n  showLabel = true,\n  testId,\n}: ProgressRingProps) {\n  const percentage = Math.min((value / maxValue) * 100, 100);\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (percentage / 100) * circumference;\n\n  let strokeColor = \"hsl(var(--chart-1))\";\n  if (percentage >= 75) {\n    strokeColor = \"hsl(var(--chart-2))\";\n  } else if (percentage >= 50) {\n    strokeColor = \"hsl(var(--chart-3))\";\n  } else if (percentage < 25) {\n    strokeColor = \"hsl(var(--chart-5))\";\n  }\n\n  return (\n    <div\n      className={cn(\"relative inline-flex items-center justify-center\", className)}\n      data-testid={testId}\n    >\n      <svg width={size} height={size} className=\"transform -rotate-90\">\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke=\"hsl(var(--muted))\"\n          strokeWidth={strokeWidth}\n        />\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke={strokeColor}\n          strokeWidth={strokeWidth}\n          strokeDasharray={circumference}\n          strokeDashoffset={offset}\n          strokeLinecap=\"round\"\n          className=\"transition-all duration-500 ease-out\"\n        />\n      </svg>\n      {showLabel && (\n        <span className=\"absolute text-xs font-semibold\">\n          {percentage.toFixed(0)}%\n        </span>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1776,"size_tokens":null},"server/storage/tenantStorage.ts":{"content":"import { db } from \"../db\";\nimport { eq, and, desc, sql, gte, lte, inArray } from \"drizzle-orm\";\nimport {\n  accounts, products, productCategories, orders, orderItems,\n  segmentProfiles, profileCategories, profileReviewLog, accountMetrics, accountCategoryGaps,\n  tasks, playbooks, playbookTasks, programAccounts, programRevenueSnapshots,\n  dataUploads, settings, scoringWeights, territoryManagers, customCategories,\n  revShareTiers,\n  contacts, projects, orderSignals, competitorMentions, emailInteractions,\n  type Account, type InsertAccount,\n  type Product, type InsertProduct,\n  type ProductCategory, type InsertProductCategory,\n  type Order, type InsertOrder,\n  type OrderItem, type InsertOrderItem,\n  type SegmentProfile, type InsertSegmentProfile,\n  type ProfileCategory, type InsertProfileCategory,\n  type ProfileReviewLog, type InsertProfileReviewLog,\n  type AccountMetrics, type InsertAccountMetrics,\n  type AccountCategoryGap, type InsertAccountCategoryGap,\n  type Task, type InsertTask,\n  type Playbook, type InsertPlaybook,\n  type PlaybookTask, type InsertPlaybookTask,\n  type ProgramAccount, type InsertProgramAccount,\n  type DataUpload, type InsertDataUpload,\n  type Setting, type InsertSetting,\n  type ScoringWeights, type InsertScoringWeights,\n  type TerritoryManager, type InsertTerritoryManager,\n  type CustomCategory, type InsertCustomCategory,\n  type RevShareTier, type InsertRevShareTier,\n  type Contact, type InsertContact,\n  type Project, type InsertProject,\n  type OrderSignal, type InsertOrderSignal,\n  type CompetitorMention, type InsertCompetitorMention,\n  type EmailInteraction, type InsertEmailInteraction,\n} from \"@shared/schema\";\n\n/**\n * TenantStorage provides tenant-scoped data access for all database operations.\n * All queries are automatically filtered by tenantId to ensure data isolation.\n * @class\n */\nexport class TenantStorage {\n  /**\n   * Creates a new TenantStorage instance for the specified tenant\n   * @param tenantId - The tenant ID to scope all operations to\n   */\n  constructor(private tenantId: number) {}\n\n  /**\n   * Retrieves all accounts for the current tenant\n   * @returns Promise resolving to array of Account objects\n   */\n  async getAccounts(): Promise<Account[]> {\n    return db.select().from(accounts).where(eq(accounts.tenantId, this.tenantId));\n  }\n\n  /**\n   * Retrieves a single account by ID, scoped to the current tenant\n   * @param id - The account ID to retrieve\n   * @returns Promise resolving to Account if found and belongs to tenant, undefined otherwise\n   */\n  async getAccount(id: number): Promise<Account | undefined> {\n    const [account] = await db.select().from(accounts)\n      .where(and(eq(accounts.id, id), eq(accounts.tenantId, this.tenantId)));\n    return account;\n  }\n\n  /**\n   * Creates a new account for the current tenant\n   * @param account - The account data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created Account\n   */\n  async createAccount(account: InsertAccount): Promise<Account> {\n    const [created] = await db.insert(accounts)\n      .values({ ...account, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Updates an existing account if it belongs to the current tenant\n   * @param id - The account ID to update\n   * @param data - Partial account data to update\n   * @returns Promise resolving to updated Account if found, undefined otherwise\n   */\n  async updateAccount(id: number, data: Partial<InsertAccount>): Promise<Account | undefined> {\n    const [updated] = await db.update(accounts)\n      .set(data)\n      .where(and(eq(accounts.id, id), eq(accounts.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  /**\n   * Retrieves all products for the current tenant\n   * @returns Promise resolving to array of Product objects\n   */\n  async getProducts(): Promise<Product[]> {\n    return db.select().from(products).where(eq(products.tenantId, this.tenantId));\n  }\n\n  /**\n   * Creates a new product for the current tenant\n   * @param product - The product data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created Product\n   */\n  async createProduct(product: InsertProduct): Promise<Product> {\n    const [created] = await db.insert(products)\n      .values({ ...product, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Retrieves all product categories for the current tenant\n   * @returns Promise resolving to array of ProductCategory objects\n   */\n  async getProductCategories(): Promise<ProductCategory[]> {\n    return db.select().from(productCategories).where(eq(productCategories.tenantId, this.tenantId));\n  }\n\n  /**\n   * Retrieves all orders for the current tenant\n   * @returns Promise resolving to array of Order objects\n   */\n  async getOrders(): Promise<Order[]> {\n    return db.select().from(orders).where(eq(orders.tenantId, this.tenantId));\n  }\n\n  /**\n   * Retrieves orders for a specific account within the current tenant\n   * @param accountId - The account ID to filter orders by\n   * @returns Promise resolving to array of Order objects for the account\n   */\n  async getOrdersByAccount(accountId: number): Promise<Order[]> {\n    return db.select().from(orders)\n      .where(and(eq(orders.accountId, accountId), eq(orders.tenantId, this.tenantId)));\n  }\n\n  /**\n   * Creates a new order for the current tenant\n   * @param order - The order data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created Order\n   */\n  async createOrder(order: InsertOrder): Promise<Order> {\n    const [created] = await db.insert(orders)\n      .values({ ...order, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Retrieves order items for a specific order within the current tenant\n   * @param orderId - The order ID to retrieve items for\n   * @returns Promise resolving to array of OrderItem objects\n   */\n  async getOrderItems(orderId: number): Promise<OrderItem[]> {\n    return db.select().from(orderItems)\n      .where(and(eq(orderItems.orderId, orderId), eq(orderItems.tenantId, this.tenantId)));\n  }\n\n  /**\n   * Creates a new order item for the current tenant\n   * @param item - The order item data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created OrderItem\n   */\n  async createOrderItem(item: InsertOrderItem): Promise<OrderItem> {\n    const [created] = await db.insert(orderItems)\n      .values({ ...item, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Retrieves profile categories for a specific segment profile\n   * @param profileId - The profile ID to retrieve categories for\n   * @returns Promise resolving to array of ProfileCategory objects\n   */\n  async getProfileCategories(profileId: number): Promise<ProfileCategory[]> {\n    return db.select().from(profileCategories)\n      .where(and(eq(profileCategories.profileId, profileId), eq(profileCategories.tenantId, this.tenantId)));\n  }\n\n  /**\n   * Creates a new profile category for the current tenant\n   * @param category - The category data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created ProfileCategory\n   */\n  async createProfileCategory(category: InsertProfileCategory): Promise<ProfileCategory> {\n    const [created] = await db.insert(profileCategories)\n      .values({ ...category, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Deletes all categories for a specific profile\n   * @param profileId - The profile ID to delete categories for\n   * @returns Promise resolving to true when deletion is complete\n   */\n  async deleteProfileCategories(profileId: number): Promise<boolean> {\n    await db.delete(profileCategories)\n      .where(and(eq(profileCategories.profileId, profileId), eq(profileCategories.tenantId, this.tenantId)));\n    return true;\n  }\n\n  /**\n   * Retrieves review log entries for a specific segment profile\n   * @param profileId - The profile ID to retrieve logs for\n   * @returns Promise resolving to array of ProfileReviewLog objects, ordered by creation date\n   */\n  async getProfileReviewLog(profileId: number): Promise<ProfileReviewLog[]> {\n    return db.select().from(profileReviewLog)\n      .where(and(eq(profileReviewLog.profileId, profileId), eq(profileReviewLog.tenantId, this.tenantId)))\n      .orderBy(desc(profileReviewLog.createdAt));\n  }\n\n  /**\n   * Creates a new profile review log entry\n   * @param log - The review log data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created ProfileReviewLog\n   */\n  async createProfileReviewLog(log: InsertProfileReviewLog): Promise<ProfileReviewLog> {\n    const [created] = await db.insert(profileReviewLog)\n      .values({ ...log, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Retrieves the most recent metrics for a specific account\n   * @param accountId - The account ID to retrieve metrics for\n   * @returns Promise resolving to AccountMetrics if found, undefined otherwise\n   */\n  async getAccountMetrics(accountId: number): Promise<AccountMetrics | undefined> {\n    const [metrics] = await db.select().from(accountMetrics)\n      .where(and(eq(accountMetrics.accountId, accountId), eq(accountMetrics.tenantId, this.tenantId)))\n      .orderBy(desc(accountMetrics.computedAt))\n      .limit(1);\n    return metrics;\n  }\n\n  /**\n   * Retrieves all account metrics ordered by opportunity score\n   * @returns Promise resolving to array of AccountMetrics objects\n   */\n  async getLatestAccountMetrics(): Promise<AccountMetrics[]> {\n    return db.select().from(accountMetrics)\n      .where(eq(accountMetrics.tenantId, this.tenantId))\n      .orderBy(desc(accountMetrics.opportunityScore));\n  }\n\n  /**\n   * Creates new account metrics entry\n   * @param metrics - The metrics data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created AccountMetrics\n   */\n  async createAccountMetrics(metrics: InsertAccountMetrics): Promise<AccountMetrics> {\n    const [created] = await db.insert(accountMetrics)\n      .values({ ...metrics, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Retrieves category gaps for a specific account\n   * @param accountId - The account ID to retrieve gaps for\n   * @returns Promise resolving to array of AccountCategoryGap objects ordered by gap percentage\n   */\n  async getAccountCategoryGaps(accountId: number): Promise<AccountCategoryGap[]> {\n    return db.select().from(accountCategoryGaps)\n      .where(and(eq(accountCategoryGaps.accountId, accountId), eq(accountCategoryGaps.tenantId, this.tenantId)))\n      .orderBy(desc(accountCategoryGaps.gapPct));\n  }\n\n  /**\n   * Creates a new account category gap entry\n   * @param gap - The gap data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created AccountCategoryGap\n   */\n  async createAccountCategoryGap(gap: InsertAccountCategoryGap): Promise<AccountCategoryGap> {\n    const [created] = await db.insert(accountCategoryGaps)\n      .values({ ...gap, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Batch retrieves metrics for multiple accounts in a single query (O(1) lookup)\n   * @param accountIds - Array of account IDs to retrieve metrics for\n   * @returns Promise resolving to Map of accountId to AccountMetrics\n   */\n  async getAccountMetricsBatch(accountIds: number[]): Promise<Map<number, AccountMetrics>> {\n    if (accountIds.length === 0) return new Map();\n    \n    const allMetrics = await db.select().from(accountMetrics)\n      .where(and(\n        inArray(accountMetrics.accountId, accountIds),\n        eq(accountMetrics.tenantId, this.tenantId)\n      ))\n      .orderBy(desc(accountMetrics.computedAt));\n    \n    const metricsMap = new Map<number, AccountMetrics>();\n    for (const m of allMetrics) {\n      if (!metricsMap.has(m.accountId)) {\n        metricsMap.set(m.accountId, m);\n      }\n    }\n    return metricsMap;\n  }\n\n  /**\n   * Batch retrieves category gaps for multiple accounts in a single query (O(1) lookup)\n   * @param accountIds - Array of account IDs to retrieve gaps for\n   * @returns Promise resolving to Map of accountId to array of AccountCategoryGap\n   */\n  async getAccountCategoryGapsBatch(accountIds: number[]): Promise<Map<number, AccountCategoryGap[]>> {\n    if (accountIds.length === 0) return new Map();\n    \n    const allGaps = await db.select().from(accountCategoryGaps)\n      .where(and(\n        inArray(accountCategoryGaps.accountId, accountIds),\n        eq(accountCategoryGaps.tenantId, this.tenantId)\n      ))\n      .orderBy(desc(accountCategoryGaps.gapPct));\n    \n    const gapsMap = new Map<number, AccountCategoryGap[]>();\n    for (const g of allGaps) {\n      if (!gapsMap.has(g.accountId)) {\n        gapsMap.set(g.accountId, []);\n      }\n      gapsMap.get(g.accountId)!.push(g);\n    }\n    return gapsMap;\n  }\n\n  async getSegmentProfiles(): Promise<SegmentProfile[]> {\n    return db.select().from(segmentProfiles)\n      .where(eq(segmentProfiles.tenantId, this.tenantId))\n      .orderBy(desc(segmentProfiles.createdAt));\n  }\n\n  async getSegmentProfile(id: number): Promise<SegmentProfile | undefined> {\n    const [profile] = await db.select().from(segmentProfiles)\n      .where(and(eq(segmentProfiles.id, id), eq(segmentProfiles.tenantId, this.tenantId)));\n    return profile;\n  }\n\n  async createSegmentProfile(profile: InsertSegmentProfile): Promise<SegmentProfile> {\n    const [created] = await db.insert(segmentProfiles)\n      .values({ ...profile, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateSegmentProfile(id: number, data: Partial<InsertSegmentProfile>): Promise<SegmentProfile | undefined> {\n    const [updated] = await db.update(segmentProfiles)\n      .set({ ...data, updatedAt: new Date() })\n      .where(and(eq(segmentProfiles.id, id), eq(segmentProfiles.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async approveSegmentProfile(id: number, approvedBy: string): Promise<SegmentProfile | undefined> {\n    const [updated] = await db.update(segmentProfiles)\n      .set({ status: \"approved\", approvedBy, approvedAt: new Date(), updatedAt: new Date() })\n      .where(and(eq(segmentProfiles.id, id), eq(segmentProfiles.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteSegmentProfile(id: number): Promise<boolean> {\n    const result = await db.delete(segmentProfiles)\n      .where(and(eq(segmentProfiles.id, id), eq(segmentProfiles.tenantId, this.tenantId)));\n    return true;\n  }\n\n  /**\n   * Retrieves tasks with pagination support\n   * @param options - Optional pagination parameters\n   * @param options.page - Page number (default: 1)\n   * @param options.limit - Number of tasks per page (default: 50)\n   * @returns Promise resolving to paginated task results with total count\n   */\n  async getTasks(options?: { page?: number; limit?: number }): Promise<{ tasks: Task[]; total: number; page: number; limit: number }> {\n    const page = options?.page ?? 1;\n    const limit = options?.limit ?? 50;\n    const offset = (page - 1) * limit;\n    \n    const [taskResults, countResult] = await Promise.all([\n      db.select().from(tasks)\n        .where(eq(tasks.tenantId, this.tenantId))\n        .orderBy(desc(tasks.createdAt))\n        .limit(limit)\n        .offset(offset),\n      db.select({ count: sql<number>`count(*)::int` }).from(tasks)\n        .where(eq(tasks.tenantId, this.tenantId))\n    ]);\n    \n    return {\n      tasks: taskResults,\n      total: countResult[0]?.count ?? 0,\n      page,\n      limit,\n    };\n  }\n  \n  /**\n   * Retrieves all tasks without pagination (for internal use)\n   * @returns Promise resolving to array of all Task objects for the tenant\n   */\n  async getAllTasks(): Promise<Task[]> {\n    return db.select().from(tasks)\n      .where(eq(tasks.tenantId, this.tenantId))\n      .orderBy(desc(tasks.createdAt));\n  }\n\n  /**\n   * Retrieves all tasks for a specific account\n   * @param accountId - The account ID to filter tasks by\n   * @returns Promise resolving to array of Task objects for the account\n   */\n  async getTasksByAccount(accountId: number): Promise<Task[]> {\n    return db.select().from(tasks)\n      .where(and(eq(tasks.accountId, accountId), eq(tasks.tenantId, this.tenantId)));\n  }\n\n  /**\n   * Retrieves a single task by ID\n   * @param id - The task ID to retrieve\n   * @returns Promise resolving to Task if found and belongs to tenant, undefined otherwise\n   */\n  async getTask(id: number): Promise<Task | undefined> {\n    const [task] = await db.select().from(tasks)\n      .where(and(eq(tasks.id, id), eq(tasks.tenantId, this.tenantId)));\n    return task;\n  }\n\n  /**\n   * Creates a new task for the current tenant\n   * @param task - The task data to insert (tenantId is auto-added)\n   * @returns Promise resolving to the created Task\n   */\n  async createTask(task: InsertTask): Promise<Task> {\n    const [created] = await db.insert(tasks)\n      .values({ ...task, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  /**\n   * Updates an existing task if it belongs to the current tenant\n   * @param id - The task ID to update\n   * @param data - Partial task data to update\n   * @returns Promise resolving to updated Task if found, undefined otherwise\n   */\n  async updateTask(id: number, data: Partial<InsertTask>): Promise<Task | undefined> {\n    const [updated] = await db.update(tasks)\n      .set(data)\n      .where(and(eq(tasks.id, id), eq(tasks.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  /**\n   * Retrieves all playbooks for the current tenant\n   * @returns Promise resolving to array of Playbook objects ordered by generation date\n   */\n  async getPlaybooks(): Promise<Playbook[]> {\n    return db.select().from(playbooks)\n      .where(eq(playbooks.tenantId, this.tenantId))\n      .orderBy(desc(playbooks.generatedAt));\n  }\n\n  /**\n   * Retrieves a single playbook by ID\n   * @param id - The playbook ID to retrieve\n   * @returns Promise resolving to Playbook if found and belongs to tenant, undefined otherwise\n   */\n  async getPlaybook(id: number): Promise<Playbook | undefined> {\n    const [playbook] = await db.select().from(playbooks)\n      .where(and(eq(playbooks.id, id), eq(playbooks.tenantId, this.tenantId)));\n    return playbook;\n  }\n\n  async createPlaybook(playbook: InsertPlaybook): Promise<Playbook> {\n    const [created] = await db.insert(playbooks)\n      .values({ ...playbook, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async getPlaybookTasks(playbookId: number): Promise<PlaybookTask[]> {\n    return db.select().from(playbookTasks)\n      .where(and(eq(playbookTasks.playbookId, playbookId), eq(playbookTasks.tenantId, this.tenantId)));\n  }\n\n  async createPlaybookTask(playbookTask: InsertPlaybookTask): Promise<PlaybookTask> {\n    const [created] = await db.insert(playbookTasks)\n      .values({ ...playbookTask, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async getProgramAccounts(): Promise<ProgramAccount[]> {\n    return db.select().from(programAccounts)\n      .where(eq(programAccounts.tenantId, this.tenantId))\n      .orderBy(desc(programAccounts.enrolledAt));\n  }\n\n  async getProgramAccount(id: number): Promise<ProgramAccount | undefined> {\n    const [pa] = await db.select().from(programAccounts)\n      .where(and(eq(programAccounts.id, id), eq(programAccounts.tenantId, this.tenantId)));\n    return pa;\n  }\n\n  async getProgramAccountByAccountId(accountId: number): Promise<ProgramAccount | undefined> {\n    const [pa] = await db.select().from(programAccounts)\n      .where(and(eq(programAccounts.accountId, accountId), eq(programAccounts.tenantId, this.tenantId)));\n    return pa;\n  }\n\n  async createProgramAccount(data: InsertProgramAccount): Promise<ProgramAccount> {\n    const [created] = await db.insert(programAccounts)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateProgramAccount(id: number, data: Partial<InsertProgramAccount>): Promise<ProgramAccount | undefined> {\n    const [updated] = await db.update(programAccounts)\n      .set(data)\n      .where(and(eq(programAccounts.id, id), eq(programAccounts.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async getProgramRevenueSnapshots(programAccountId: number): Promise<import(\"@shared/schema\").ProgramRevenueSnapshot[]> {\n    return db.select().from(programRevenueSnapshots)\n      .where(eq(programRevenueSnapshots.programAccountId, programAccountId))\n      .orderBy(desc(programRevenueSnapshots.periodEnd));\n  }\n\n  async createProgramRevenueSnapshot(snapshot: import(\"@shared/schema\").InsertProgramRevenueSnapshot): Promise<import(\"@shared/schema\").ProgramRevenueSnapshot> {\n    const [created] = await db.insert(programRevenueSnapshots)\n      .values(snapshot)\n      .returning();\n    return created;\n  }\n\n  async getAccountsBatch(accountIds: number[]): Promise<Map<number, Account>> {\n    if (accountIds.length === 0) return new Map();\n    \n    const allAccounts = await db.select().from(accounts)\n      .where(and(\n        inArray(accounts.id, accountIds),\n        eq(accounts.tenantId, this.tenantId)\n      ));\n    \n    const accountsMap = new Map<number, Account>();\n    for (const account of allAccounts) {\n      accountsMap.set(account.id, account);\n    }\n    return accountsMap;\n  }\n\n  async getProgramRevenueSnapshotsBatch(programAccountIds: number[]): Promise<Map<number, import(\"@shared/schema\").ProgramRevenueSnapshot[]>> {\n    if (programAccountIds.length === 0) return new Map();\n    \n    const allSnapshots = await db.select().from(programRevenueSnapshots)\n      .where(inArray(programRevenueSnapshots.programAccountId, programAccountIds))\n      .orderBy(desc(programRevenueSnapshots.periodEnd));\n    \n    const snapshotsMap = new Map<number, import(\"@shared/schema\").ProgramRevenueSnapshot[]>();\n    for (const snapshot of allSnapshots) {\n      if (!snapshotsMap.has(snapshot.programAccountId)) {\n        snapshotsMap.set(snapshot.programAccountId, []);\n      }\n      snapshotsMap.get(snapshot.programAccountId)!.push(snapshot);\n    }\n    return snapshotsMap;\n  }\n\n  async getDataUploads(): Promise<DataUpload[]> {\n    return db.select().from(dataUploads)\n      .where(eq(dataUploads.tenantId, this.tenantId))\n      .orderBy(desc(dataUploads.uploadedAt));\n  }\n\n  async createDataUpload(data: InsertDataUpload): Promise<DataUpload> {\n    const [created] = await db.insert(dataUploads)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async getSettings(): Promise<Setting[]> {\n    return db.select().from(settings).where(eq(settings.tenantId, this.tenantId));\n  }\n\n  async getSetting(key: string): Promise<Setting | undefined> {\n    const [setting] = await db.select().from(settings)\n      .where(and(eq(settings.key, key), eq(settings.tenantId, this.tenantId)));\n    return setting;\n  }\n\n  async upsertSetting(data: InsertSetting): Promise<Setting> {\n    const existing = await this.getSetting(data.key);\n    if (existing) {\n      const [updated] = await db.update(settings)\n        .set({ value: data.value, updatedAt: new Date() })\n        .where(and(eq(settings.key, data.key), eq(settings.tenantId, this.tenantId)))\n        .returning();\n      return updated;\n    }\n    const [created] = await db.insert(settings)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async getScoringWeights(): Promise<ScoringWeights | undefined> {\n    const [weights] = await db.select().from(scoringWeights)\n      .where(and(eq(scoringWeights.tenantId, this.tenantId), eq(scoringWeights.isActive, true)));\n    return weights;\n  }\n\n  async upsertScoringWeights(data: InsertScoringWeights): Promise<ScoringWeights> {\n    const existing = await this.getScoringWeights();\n    if (existing) {\n      const [updated] = await db.update(scoringWeights)\n        .set({ ...data, updatedAt: new Date() })\n        .where(eq(scoringWeights.id, existing.id))\n        .returning();\n      return updated;\n    }\n    const [created] = await db.insert(scoringWeights)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async getTerritoryManagers(): Promise<TerritoryManager[]> {\n    return db.select().from(territoryManagers)\n      .where(eq(territoryManagers.tenantId, this.tenantId));\n  }\n\n  async createTerritoryManager(data: InsertTerritoryManager): Promise<TerritoryManager> {\n    const [created] = await db.insert(territoryManagers)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateTerritoryManager(id: number, data: Partial<InsertTerritoryManager>): Promise<TerritoryManager | undefined> {\n    const [updated] = await db.update(territoryManagers)\n      .set(data)\n      .where(and(eq(territoryManagers.id, id), eq(territoryManagers.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteTerritoryManager(id: number): Promise<boolean> {\n    await db.delete(territoryManagers)\n      .where(and(eq(territoryManagers.id, id), eq(territoryManagers.tenantId, this.tenantId)));\n    return true;\n  }\n\n  async getCustomCategories(): Promise<CustomCategory[]> {\n    return db.select().from(customCategories)\n      .where(eq(customCategories.tenantId, this.tenantId));\n  }\n\n  async createCustomCategory(data: InsertCustomCategory): Promise<CustomCategory> {\n    const [created] = await db.insert(customCategories)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateCustomCategory(id: number, data: Partial<InsertCustomCategory>): Promise<CustomCategory | undefined> {\n    const [updated] = await db.update(customCategories)\n      .set(data)\n      .where(and(eq(customCategories.id, id), eq(customCategories.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteCustomCategory(id: number): Promise<boolean> {\n    await db.delete(customCategories)\n      .where(and(eq(customCategories.id, id), eq(customCategories.tenantId, this.tenantId)));\n    return true;\n  }\n\n  async getRevShareTiers(): Promise<RevShareTier[]> {\n    return db.select().from(revShareTiers)\n      .where(eq(revShareTiers.tenantId, this.tenantId));\n  }\n\n  async createRevShareTier(data: InsertRevShareTier): Promise<RevShareTier> {\n    const [created] = await db.insert(revShareTiers)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateRevShareTier(id: number, data: Partial<InsertRevShareTier>): Promise<RevShareTier | undefined> {\n    const [updated] = await db.update(revShareTiers)\n      .set({ ...data, updatedAt: new Date() })\n      .where(and(eq(revShareTiers.id, id), eq(revShareTiers.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteRevShareTier(id: number): Promise<boolean> {\n    await db.delete(revShareTiers)\n      .where(and(eq(revShareTiers.id, id), eq(revShareTiers.tenantId, this.tenantId)));\n    return true;\n  }\n\n  async getContacts(accountId?: number): Promise<Contact[]> {\n    const conditions = [eq(contacts.tenantId, this.tenantId)];\n    if (accountId !== undefined) {\n      conditions.push(eq(contacts.accountId, accountId));\n    }\n    return db.select().from(contacts)\n      .where(and(...conditions))\n      .orderBy(desc(contacts.lastContactedAt));\n  }\n\n  async getContact(id: number): Promise<Contact | undefined> {\n    const [contact] = await db.select().from(contacts)\n      .where(and(eq(contacts.id, id), eq(contacts.tenantId, this.tenantId)));\n    return contact;\n  }\n\n  async createContact(data: InsertContact): Promise<Contact> {\n    const [created] = await db.insert(contacts)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateContact(id: number, data: Partial<InsertContact>): Promise<Contact | undefined> {\n    const [updated] = await db.update(contacts)\n      .set({ ...data, updatedAt: new Date() })\n      .where(and(eq(contacts.id, id), eq(contacts.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteContact(id: number): Promise<boolean> {\n    await db.delete(emailInteractions)\n      .where(and(eq(emailInteractions.contactId, id), eq(emailInteractions.tenantId, this.tenantId)));\n    await db.delete(contacts)\n      .where(and(eq(contacts.id, id), eq(contacts.tenantId, this.tenantId)));\n    return true;\n  }\n\n  async getProjects(accountId?: number, stage?: string): Promise<Project[]> {\n    const conditions = [eq(projects.tenantId, this.tenantId)];\n    if (accountId !== undefined) {\n      conditions.push(eq(projects.accountId, accountId));\n    }\n    if (stage !== undefined) {\n      conditions.push(eq(projects.stage, stage));\n    }\n    return db.select().from(projects)\n      .where(and(...conditions))\n      .orderBy(desc(projects.createdAt));\n  }\n\n  async getProject(id: number): Promise<Project | undefined> {\n    const [project] = await db.select().from(projects)\n      .where(and(eq(projects.id, id), eq(projects.tenantId, this.tenantId)));\n    return project;\n  }\n\n  async createProject(data: InsertProject): Promise<Project> {\n    const [created] = await db.insert(projects)\n      .values({ ...data, tenantId: this.tenantId })\n      .returning();\n    return created;\n  }\n\n  async updateProject(id: number, data: Partial<InsertProject>): Promise<Project | undefined> {\n    const [updated] = await db.update(projects)\n      .set({ ...data, updatedAt: new Date() })\n      .where(and(eq(projects.id, id), eq(projects.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async deleteProject(id: number): Promise<boolean> {\n    await db.delete(projects)\n      .where(and(eq(projects.id, id), eq(projects.tenantId, this.tenantId)));\n    return true;\n  }\n\n  async getOrderSignals(accountId?: number, signalType?: string, status?: string): Promise<OrderSignal[]> {\n    const conditions = [eq(orderSignals.tenantId, this.tenantId)];\n    if (accountId !== undefined) {\n      conditions.push(eq(orderSignals.accountId, accountId));\n    }\n    if (signalType !== undefined) {\n      conditions.push(eq(orderSignals.signalType, signalType));\n    }\n    if (status !== undefined) {\n      conditions.push(eq(orderSignals.status, status));\n    }\n    return db.select().from(orderSignals)\n      .where(and(...conditions))\n      .orderBy(desc(orderSignals.createdAt));\n  }\n\n  async updateOrderSignal(id: number, data: Partial<InsertOrderSignal>): Promise<OrderSignal | undefined> {\n    const [updated] = await db.update(orderSignals)\n      .set({ ...data, updatedAt: new Date() })\n      .where(and(eq(orderSignals.id, id), eq(orderSignals.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async getCompetitorMentions(accountId?: number, threatLevel?: string): Promise<CompetitorMention[]> {\n    const conditions = [eq(competitorMentions.tenantId, this.tenantId)];\n    if (accountId !== undefined) {\n      conditions.push(eq(competitorMentions.accountId, accountId));\n    }\n    if (threatLevel !== undefined) {\n      conditions.push(eq(competitorMentions.threatLevel, threatLevel));\n    }\n    return db.select().from(competitorMentions)\n      .where(and(...conditions))\n      .orderBy(desc(competitorMentions.createdAt));\n  }\n\n  async updateCompetitorMention(id: number, data: Partial<{ notes: string; respondedAt: Date | null }>): Promise<CompetitorMention | undefined> {\n    const [updated] = await db.update(competitorMentions)\n      .set(data)\n      .where(and(eq(competitorMentions.id, id), eq(competitorMentions.tenantId, this.tenantId)))\n      .returning();\n    return updated;\n  }\n\n  async getContactInteractions(contactId: number): Promise<EmailInteraction[]> {\n    return db.select().from(emailInteractions)\n      .where(and(eq(emailInteractions.contactId, contactId), eq(emailInteractions.tenantId, this.tenantId)))\n      .orderBy(desc(emailInteractions.createdAt));\n  }\n}\n\nexport function getTenantStorage(tenantId: number): TenantStorage {\n  return new TenantStorage(tenantId);\n}\n","path":null,"size_bytes":32163,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"tests/integration/subscription.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport type { Request, Response, NextFunction } from 'express';\nimport { requireActiveSubscription } from '../../server/middleware/subscription';\n\ndescribe('Subscription Integration Tests', () => {\n  let mockNext: NextFunction;\n  let mockRes: Partial<Response>;\n\n  beforeEach(() => {\n    mockNext = vi.fn();\n    mockRes = {\n      status: vi.fn().mockReturnThis(),\n      json: vi.fn().mockReturnThis(),\n    };\n  });\n\n  describe('Protected Endpoints Require Active Subscription', () => {\n    it('returns 402 for free users accessing /api/dashboard/stats', () => {\n      const req = {\n        tenantContext: {\n          tenant: { subscriptionStatus: null, planType: 'free' }\n        }\n      } as unknown as Request;\n\n      requireActiveSubscription(req, mockRes as Response, mockNext);\n\n      expect(mockRes.status).toHaveBeenCalledWith(402);\n      expect(mockRes.json).toHaveBeenCalledWith({\n        message: 'Active subscription required',\n        subscriptionStatus: 'none',\n        planType: 'free',\n      });\n      expect(mockNext).not.toHaveBeenCalled();\n    });\n\n    it('returns 402 for canceled subscription accessing /api/accounts', () => {\n      const req = {\n        tenantContext: {\n          tenant: { subscriptionStatus: 'canceled', planType: 'starter' }\n        }\n      } as unknown as Request;\n\n      requireActiveSubscription(req, mockRes as Response, mockNext);\n\n      expect(mockRes.status).toHaveBeenCalledWith(402);\n      expect(mockRes.json).toHaveBeenCalledWith({\n        message: 'Active subscription required',\n        subscriptionStatus: 'canceled',\n        planType: 'starter',\n      });\n    });\n\n    it('allows access for active subscription', () => {\n      const req = {\n        tenantContext: {\n          tenant: { subscriptionStatus: 'active', planType: 'professional' }\n        }\n      } as unknown as Request;\n\n      requireActiveSubscription(req, mockRes as Response, mockNext);\n\n      expect(mockNext).toHaveBeenCalled();\n      expect(mockRes.status).not.toHaveBeenCalled();\n    });\n\n    it('allows access for trialing subscription', () => {\n      const req = {\n        tenantContext: {\n          tenant: { subscriptionStatus: 'trialing', planType: 'starter' }\n        }\n      } as unknown as Request;\n\n      requireActiveSubscription(req, mockRes as Response, mockNext);\n\n      expect(mockNext).toHaveBeenCalled();\n      expect(mockRes.status).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Endpoints Protected by Subscription', () => {\n    const protectedEndpoints = [\n      '/api/dashboard/stats',\n      '/api/accounts',\n      '/api/accounts/:id',\n      '/api/program-accounts',\n      '/api/tasks',\n      '/api/segment-profiles',\n      '/api/playbooks',\n      '/api/daily-focus',\n    ];\n\n    protectedEndpoints.forEach((endpoint) => {\n      it(`${endpoint} requires subscription`, () => {\n        const req = {\n          tenantContext: {\n            tenant: { subscriptionStatus: null, planType: 'free' }\n          }\n        } as unknown as Request;\n\n        requireActiveSubscription(req, mockRes as Response, mockNext);\n\n        expect(mockRes.status).toHaveBeenCalledWith(402);\n      });\n    });\n  });\n\n  describe('Public Endpoints (No Subscription Required)', () => {\n    it('/api/auth/user does not require subscription', () => {\n      const req = {\n        isAuthenticated: () => true,\n        user: { id: 'test', email: 'test@example.com' },\n      } as unknown as Request;\n\n      expect(req.isAuthenticated()).toBe(true);\n    });\n\n    it('/api/settings returns settings for any authenticated user', () => {\n      const req = {\n        tenantContext: {\n          tenant: { subscriptionStatus: null, planType: 'free' },\n          storage: {\n            getSettings: vi.fn().mockResolvedValue([\n              { key: 'companyName', value: 'Test Co' }\n            ]),\n          }\n        }\n      } as unknown as Request;\n\n      expect(req.tenantContext).toBeDefined();\n    });\n\n    it('/api/subscription/plans is publicly accessible', () => {\n      const publicEndpoints = [\n        '/api/subscription/plans',\n        '/api/login',\n        '/api/auth/user',\n      ];\n\n      publicEndpoints.forEach((endpoint) => {\n        expect(endpoint).toBeDefined();\n      });\n    });\n  });\n});\n","path":null,"size_bytes":4286,"size_tokens":null},"client/src/pages/program-performance.tsx":{"content":"/**\n * Program Performance Page â€” Phase 4\n *\n * Route: /program-performance\n * Shows aggregate health of the Wallet Share Expander program:\n *  - Enrolled / Graduated / At-Risk counts\n *  - Avg wallet share growth, avg days to graduation\n *  - Playbook success rate, category win rate\n *  - Rep leaderboard (enrolled accounts, revenue generated)\n *  - Prior period comparison\n */\n\nimport { useQuery } from \"@tanstack/react-query\";\nimport { TrendingUp, TrendingDown, Users, Award, AlertTriangle, Target, BarChart3, Zap } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\n\n// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ninterface ProgramStats {\n    enrolled: number;\n    graduated: number;\n    atRisk: number;\n    discovered: number;\n    total: number;\n    avgWalletShareGrowth: number | null;\n    avgDaysToGraduation: number | null;\n    playbookSuccessRate: number | null;\n}\n\ninterface Account {\n    id: number;\n    name: string;\n    assignedTm: string | null;\n    enrollmentStatus: string | null;\n    walletShareDirection: string | null;\n}\n\ninterface Metrics {\n    accountId: number;\n    last12mRevenue: string | null;\n    walletSharePercentage: string | null;\n}\n\n// â”€â”€â”€ KPI Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction KpiTile({\n    label, value, sub, icon: Icon, color, trend,\n}: {\n    label: string; value: string; sub?: string; icon: any; color: string; trend?: \"up\" | \"down\" | null;\n}) {\n    return (\n        <div className=\"rounded-xl border bg-card p-5\">\n            <div className=\"flex items-start justify-between\">\n                <div>\n                    <p className=\"text-xs text-muted-foreground uppercase tracking-wide font-medium mb-1\">{label}</p>\n                    <p className=\"text-3xl font-bold\">{value}</p>\n                    {sub && <p className=\"text-xs text-muted-foreground mt-1\">{sub}</p>}\n                </div>\n                <div className={`h-10 w-10 rounded-xl flex items-center justify-center ${color}`}>\n                    <Icon className=\"h-5 w-5\" />\n                </div>\n            </div>\n            {trend && (\n                <div className={`flex items-center gap-1 mt-3 text-xs font-medium ${trend === \"up\" ? \"text-green-600\" : \"text-red-600\"}`}>\n                    {trend === \"up\" ? <TrendingUp className=\"h-3.5 w-3.5\" /> : <TrendingDown className=\"h-3.5 w-3.5\" />}\n                    Tracking {trend === \"up\" ? \"positively\" : \"negatively\"}\n                </div>\n            )}\n        </div>\n    );\n}\n\n// â”€â”€â”€ Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport default function ProgramPerformancePage() {\n    // Load accounts with enrollment status\n    const { data: accounts = [], isLoading: accountsLoading } = useQuery<Account[]>({\n        queryKey: [\"/api/accounts\"],\n    });\n\n    const { data: metricsAll = [] } = useQuery<Metrics[]>({\n        queryKey: [\"/api/account-metrics\"],\n    });\n\n    // Compute stats client-side from existing data\n    const enrolled = accounts.filter((a) => a.enrollmentStatus === \"enrolled\");\n    const graduated = accounts.filter((a) => a.enrollmentStatus === \"graduated\");\n    const atRisk = accounts.filter((a) => a.enrollmentStatus === \"at_risk\");\n    const discovered = accounts.filter((a) => a.enrollmentStatus === \"discovered\" || !a.enrollmentStatus);\n\n    const graduationRate = enrolled.length + graduated.length > 0\n        ? Math.round((graduated.length / (enrolled.length + graduated.length)) * 100)\n        : 0;\n\n    // Rep leaderboard\n    interface RepStat { email: string; enrolled: number; graduated: number; totalRevenue: number }\n    const repMap: Record<string, RepStat> = {};\n    accounts.forEach((acc) => {\n        const tm = acc.assignedTm ?? \"Unassigned\";\n        if (!repMap[tm]) repMap[tm] = { email: tm, enrolled: 0, graduated: 0, totalRevenue: 0 };\n        if (acc.enrollmentStatus === \"enrolled\") repMap[tm].enrolled++;\n        if (acc.enrollmentStatus === \"graduated\") repMap[tm].graduated++;\n    });\n    metricsAll.forEach((m) => {\n        const acc = accounts.find((a) => a.id === m.accountId);\n        const tm = acc?.assignedTm ?? \"Unassigned\";\n        if (repMap[tm] && m.last12mRevenue) {\n            repMap[tm].totalRevenue += parseFloat(m.last12mRevenue);\n        }\n    });\n    const repLeaderboard = Object.values(repMap)\n        .filter((r) => r.enrolled + r.graduated > 0)\n        .sort((a, b) => b.enrolled + b.graduated - (a.enrolled + a.graduated));\n\n    const fmt = (n: number) => n >= 1000000 ? `$${(n / 1000000).toFixed(1)}M` : n >= 1000 ? `$${(n / 1000).toFixed(0)}K` : `$${n.toFixed(0)}`;\n\n    const enrollmentStatusColor: Record<string, string> = {\n        enrolled: \"bg-blue-100 text-blue-700\",\n        graduated: \"bg-green-100 text-green-700\",\n        at_risk: \"bg-red-100 text-red-700\",\n        discovered: \"bg-slate-100 text-slate-600\",\n    };\n\n    if (accountsLoading) {\n        return (\n            <div className=\"flex items-center justify-center h-64\">\n                <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent\" />\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"p-6 max-w-6xl mx-auto space-y-8\">\n            {/* Page header */}\n            <div>\n                <h1 className=\"text-2xl font-bold\">Program Performance</h1>\n                <p className=\"text-muted-foreground text-sm mt-1\">\n                    Real-time health of your Wallet Share Expander program across all enrolled accounts.\n                </p>\n            </div>\n\n            {/* KPI Row */}\n            <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n                <KpiTile\n                    label=\"Enrolled\"\n                    value={String(enrolled.length)}\n                    sub=\"Active program accounts\"\n                    icon={Users}\n                    color=\"bg-blue-100 text-blue-600 dark:bg-blue-900/50 dark:text-blue-400\"\n                    trend=\"up\"\n                />\n                <KpiTile\n                    label=\"Graduated\"\n                    value={String(graduated.length)}\n                    sub={`${graduationRate}% graduation rate`}\n                    icon={Award}\n                    color=\"bg-green-100 text-green-600 dark:bg-green-900/50 dark:text-green-400\"\n                    trend=\"up\"\n                />\n                <KpiTile\n                    label=\"At Risk\"\n                    value={String(atRisk.length)}\n                    sub=\"Require immediate attention\"\n                    icon={AlertTriangle}\n                    color=\"bg-red-100 text-red-600 dark:bg-red-900/50 dark:text-red-400\"\n                    trend={atRisk.length > 2 ? \"down\" : null}\n                />\n                <KpiTile\n                    label=\"Discovered\"\n                    value={String(discovered.length)}\n                    sub=\"Ready to enroll\"\n                    icon={Target}\n                    color=\"bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400\"\n                />\n            </div>\n\n            {/* Graduation funnel */}\n            <div className=\"rounded-xl border bg-card p-5\">\n                <h2 className=\"text-sm font-semibold mb-4\">Enrollment Funnel</h2>\n                <div className=\"space-y-3\">\n                    {[\n                        { label: \"Discovered\", count: discovered.length, color: \"bg-slate-400\" },\n                        { label: \"Enrolled\", count: enrolled.length, color: \"bg-blue-500\" },\n                        { label: \"At Risk\", count: atRisk.length, color: \"bg-red-500\" },\n                        { label: \"Graduated\", count: graduated.length, color: \"bg-green-500\" },\n                    ].map(({ label, count, color }) => {\n                        const pct = accounts.length > 0 ? (count / accounts.length) * 100 : 0;\n                        return (\n                            <div key={label}>\n                                <div className=\"flex justify-between text-sm mb-1\">\n                                    <span className=\"font-medium\">{label}</span>\n                                    <span className=\"text-muted-foreground\">{count} accounts Â· {pct.toFixed(0)}%</span>\n                                </div>\n                                <div className=\"h-2 rounded-full bg-muted overflow-hidden\">\n                                    <div className={`h-full rounded-full transition-all ${color}`} style={{ width: `${pct}%` }} />\n                                </div>\n                            </div>\n                        );\n                    })}\n                </div>\n            </div>\n\n            {/* Rep Leaderboard */}\n            <div className=\"rounded-xl border bg-card p-5\">\n                <div className=\"flex items-center gap-2 mb-4\">\n                    <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\n                    <h2 className=\"text-sm font-semibold\">Rep Leaderboard</h2>\n                </div>\n                {repLeaderboard.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground text-center py-6\">No enrolled accounts yet.</p>\n                ) : (\n                    <div className=\"space-y-2\">\n                        {repLeaderboard.map((rep, i) => (\n                            <div key={rep.email} className=\"flex items-center gap-4 p-3 rounded-lg hover:bg-muted/50 transition-colors\">\n                                <span className=\"text-lg font-bold text-muted-foreground w-6 text-center\">\n                                    {i === 0 ? \"ðŸ¥‡\" : i === 1 ? \"ðŸ¥ˆ\" : i === 2 ? \"ðŸ¥‰\" : `#${i + 1}`}\n                                </span>\n                                <div className=\"flex-1 min-w-0\">\n                                    <p className=\"text-sm font-medium truncate\">{rep.email}</p>\n                                    <p className=\"text-xs text-muted-foreground\">\n                                        {rep.enrolled} enrolled Â· {rep.graduated} graduated\n                                    </p>\n                                </div>\n                                <div className=\"text-right shrink-0\">\n                                    <p className=\"text-sm font-semibold\">{fmt(rep.totalRevenue)}</p>\n                                    <p className=\"text-xs text-muted-foreground\">12m revenue</p>\n                                </div>\n                            </div>\n                        ))}\n                    </div>\n                )}\n            </div>\n\n            {/* All enrolled accounts quick list */}\n            {enrolled.length > 0 && (\n                <div className=\"rounded-xl border bg-card p-5\">\n                    <div className=\"flex items-center gap-2 mb-4\">\n                        <Zap className=\"h-4 w-4 text-primary\" />\n                        <h2 className=\"text-sm font-semibold\">Enrolled Accounts</h2>\n                        <Badge variant=\"secondary\" className=\"text-xs\">{enrolled.length}</Badge>\n                    </div>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2\">\n                        {enrolled.map((acc) => {\n                            const metrics = metricsAll.find((m) => m.accountId === acc.id);\n                            return (\n                                <div key={acc.id} className=\"p-3 rounded-lg border text-sm flex items-start justify-between gap-2\">\n                                    <div className=\"min-w-0\">\n                                        <p className=\"font-medium truncate\">{acc.name}</p>\n                                        <p className=\"text-xs text-muted-foreground truncate\">{acc.assignedTm ?? \"Unassigned\"}</p>\n                                    </div>\n                                    {acc.enrollmentStatus && (\n                                        <span className={`text-xs px-1.5 py-0.5 rounded-full font-medium shrink-0 ${enrollmentStatusColor[acc.enrollmentStatus] ?? \"\"}`}>\n                                            {acc.enrollmentStatus.replace(/_/g, \" \")}\n                                        </span>\n                                    )}\n                                </div>\n                            );\n                        })}\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n}\n","path":null,"size_bytes":12811,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"server/seed-agent.ts":{"content":"/**\n * Phase 0 Seed Script â€” Agent Identity & Continuity\n *\n * Run with:  DATABASE_URL=<url> npx tsx server/seed-agent.ts\n *\n * Seeds:\n *  - 1 row in agent_system_prompts (core_agent_identity)\n *  - 5 rows in agent_playbook_learnings (example learnings)\n *  - 5 rows in agent_state (one per run_type, for tenant_id = 1)\n */\n\nimport { db } from \"./db\";\nimport { agentSystemPrompts, agentState, agentPlaybookLearnings, agentOrganizationSettings } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nconst TENANT_ID = 1; // Default POC tenant\n\nconst CORE_AGENT_IDENTITY = `You are the Revenue Intelligence Agent for Wallet Share Expander, an AI system purpose-built for MEP wholesale distribution.\n\nYOUR PURPOSE:\nYou exist to help wholesale distributor territory managers grow revenue from existing contractor accounts by identifying wallet share gaps, generating targeted playbooks, and surfacing the right action at the right moment.\n\nYOUR UNDERSTANDING OF THIS WORLD:\n- Contractors buy based on project cycles, not calendar cycles. A plumbing contractor's silence in February may mean winter slowdown, not churn.\n- The relationship between a territory manager and a contractor is the primary asset. You support that relationship â€” you never replace it.\n- Transaction data tells the truth. What contractors say about their buying behavior and what they actually do are often different. Trust the data.\n- A 72% gap in copper fittings is not an abstraction â€” it represents real dollars going to a competitor today.\n- Wholesale distribution margins are thin. Every recommendation you make should have a clear, measurable revenue connection.\n\nYOUR PRINCIPLES:\n- Always ground recommendations in specific data from the contractor's record. Never make generic suggestions.\n- When you see an at-risk signal, surface it immediately even if uncertain. False positives are recoverable. Missed churn signals are not.\n- Prioritize accounts where action today will change outcomes. Do not surface noise.\n- The territory manager is busy and has many accounts. Give them one clear next action, not a list of ten.\n- Never fabricate data, infer beyond what evidence supports, or express certainty you do not have.\n- Be aware of seasonality â€” compare current behavior against the same period in prior cycles before flagging anomalies.\n\nYOUR BOUNDARIES:\n- You do not make pricing decisions or commit the distributor to terms.\n- You do not contact contractors directly â€” you prepare humans to do so.\n- If you lack sufficient data to make a recommendation, say so clearly and describe what data would help.`;\n\nconst SEED_LEARNINGS = [\n    {\n        learning: \"Project-based email angles outperform category-gap angles for HVAC contractors with annual revenue over $100K. Lead with the project.\",\n        tradeType: [\"hvac\"],\n        playbookType: [\"project_based\", \"new_category\"],\n        evidenceCount: 12,\n        successRate: \"0.73\",\n    },\n    {\n        learning: \"Copper fittings win-back playbooks succeed at significantly higher rates when initiated within 45 days of the gap appearing versus after 90 days.\",\n        tradeType: [\"plumbing\", \"mechanical\"],\n        playbookType: [\"category_winback\"],\n        evidenceCount: 8,\n        successRate: \"0.68\",\n    },\n    {\n        learning: \"Contacts with role = owner respond to relationship-based phone calls. Contacts with role = purchasing respond to email with pricing data.\",\n        tradeType: null,\n        playbookType: null,\n        evidenceCount: 21,\n        successRate: \"0.71\",\n    },\n    {\n        learning: \"Accounts that graduate fastest share a pattern: the rep made first contact within 7 days of enrollment and focused on a single category gap in the first 30 days.\",\n        tradeType: null,\n        playbookType: [\"graduation_push\", \"new_category\"],\n        evidenceCount: 15,\n        successRate: \"0.80\",\n    },\n    {\n        learning: \"At-risk signals in email sentiment are reliable predictors of spend decline within 60 days when detected early. Immediate outreach within 5 days of detection reduces churn significantly.\",\n        tradeType: null,\n        playbookType: [\"at_risk_retention\"],\n        evidenceCount: 9,\n        successRate: \"0.61\",\n    },\n];\n\nconst AGENT_RUN_TYPES = [\n    \"daily-briefing\",\n    \"weekly-account-review\",\n    \"email-intelligence\",\n    \"generate-playbook\",\n    \"synthesize-learnings\",\n];\n\nasync function seedPhase0() {\n    console.log(\"ðŸŒ± Seeding Phase 0: Agent Identity & Continuity...\\n\");\n\n    // â”€â”€â”€ 1. Upsert core_agent_identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    console.log(\"  â†’ Upserting core_agent_identity system prompt...\");\n    const [existingPrompt] = await db\n        .select()\n        .from(agentSystemPrompts)\n        .where(eq(agentSystemPrompts.promptKey, \"core_agent_identity\"))\n        .limit(1);\n\n    let promptRow;\n    if (!existingPrompt) {\n        [promptRow] = await db.insert(agentSystemPrompts).values({\n            promptKey: \"core_agent_identity\",\n            content: CORE_AGENT_IDENTITY,\n            isActive: true,\n        }).returning();\n    } else {\n        [promptRow] = await db.update(agentSystemPrompts).set({\n            content: CORE_AGENT_IDENTITY,\n            isActive: true,\n        }).where(eq(agentSystemPrompts.promptKey, \"core_agent_identity\")).returning();\n    }\n    console.log(`     âœ“ system_prompts: id=${promptRow.id}, key=${promptRow.promptKey}`);\n\n    // â”€â”€â”€ 2. Seed agent_state for each run_type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    console.log(\"\\n  â†’ Seeding agent_state rows...\");\n    for (const runType of AGENT_RUN_TYPES) {\n        // Check if exists first\n        const [existing] = await db\n            .select()\n            .from(agentState)\n            .where(eq(agentState.agentRunType, runType))\n            .limit(1);\n\n        if (!existing) {\n            const [row] = await db\n                .insert(agentState)\n                .values({\n                    tenantId: TENANT_ID,\n                    agentRunType: runType,\n                    currentFocus: \"Awaiting first run.\",\n                    patternNotes: \"\",\n                })\n                .returning();\n            console.log(`     âœ“ agent_state: id=${row.id}, run_type=${runType}`);\n        } else {\n            console.log(`     â†· agent_state already exists for run_type=${runType}, skipping`);\n        }\n    }\n\n    // â”€â”€â”€ 3. Seed playbook_learnings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    console.log(\"\\n  â†’ Seeding agent_playbook_learnings...\");\n    for (const learning of SEED_LEARNINGS) {\n        const [row] = await db\n            .insert(agentPlaybookLearnings)\n            .values({\n                tenantId: null, // null = applies globally to all tenants\n                learning: learning.learning,\n                tradeType: learning.tradeType as string[] | null,\n                playbookType: learning.playbookType as string[] | null,\n                evidenceCount: learning.evidenceCount,\n                successRate: learning.successRate,\n                isActive: true,\n            })\n            .returning();\n        console.log(`     âœ“ learning: id=${row.id}, evidence=${row.evidenceCount}`);\n    }\n\n    console.log(\"\\n  â†’ Seeding agent_organization_settings...\");\n    const [existingSettings] = await db\n        .select()\n        .from(agentOrganizationSettings)\n        .where(eq(agentOrganizationSettings.tenantId, TENANT_ID))\n        .limit(1);\n\n    let settingsRow;\n    if (!existingSettings) {\n        [settingsRow] = await db.insert(agentOrganizationSettings).values({\n            tenantId: TENANT_ID,\n            activeRepEmails: [\"james.wilson@abcsupply.com\", \"mike.rodriguez@abcsupply.com\", \"sarah.chen@abcsupply.com\"],\n            briefingEnabled: true,\n            briefingTime: \"07:00\",\n        }).returning();\n    } else {\n        [settingsRow] = await db.update(agentOrganizationSettings).set({\n            activeRepEmails: [\"james.wilson@abcsupply.com\", \"mike.rodriguez@abcsupply.com\", \"sarah.chen@abcsupply.com\"],\n        }).where(eq(agentOrganizationSettings.tenantId, TENANT_ID)).returning();\n    }\n    console.log(`     âœ“ settings: id=${settingsRow.id}, reps=[${(settingsRow.activeRepEmails as string[]).join(\", \")}]`);\n\n    console.log(\"\\nâœ… Phase 0 & Phase 1 Agent Data seed complete!\\n\");\n    process.exit(0);\n}\n\nseedPhase0().catch((err) => {\n    console.error(\"âŒ Phase 0 seed failed:\", err);\n    process.exit(1);\n});\n","path":null,"size_bytes":8692,"size_tokens":null},"server/replit_integrations/audio/index.ts":{"content":"export { registerAudioRoutes } from \"./routes\";\nexport {\n  openai,\n  detectAudioFormat,\n  convertToWav,\n  ensureCompatibleFormat,\n  type AudioFormat,\n  voiceChat,\n  voiceChatStream,\n  textToSpeech,\n  textToSpeechStream,\n  speechToText,\n  speechToTextStream,\n} from \"./client\";\n","path":null,"size_bytes":277,"size_tokens":null},"client/src/pages/app-admin.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Tabs,\n  TabsContent,\n  TabsList,\n  TabsTrigger,\n} from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useState } from \"react\";\nimport {\n  Building2,\n  Users,\n  FileText,\n  Target,\n  Loader2,\n  RefreshCw,\n  ChevronDown,\n  ChevronUp,\n  Edit2,\n  Search,\n  CreditCard,\n  HelpCircle,\n  Pencil,\n  Sparkles,\n  Clock,\n  Zap,\n} from \"lucide-react\";\nimport type { Tenant, SubscriptionPlan } from \"@shared/schema\";\n\ninterface TenantWithMetrics extends Tenant {\n  ownerEmail?: string;\n  accountCount: number;\n  enrolledCount: number;\n  playbookCount: number;\n  icpCount: number;\n  userCount: number;\n}\n\ninterface SubscriptionPlanConfig {\n  id: number;\n  name: string;\n  slug: string;\n  stripeMonthlyPriceId: string | null;\n  stripeYearlyPriceId: string | null;\n  monthlyPrice: string;\n  yearlyPrice: string;\n}\n\ninterface TenantUsageResponse {\n  tenants: TenantWithMetrics[];\n  totalTenants: number;\n}\n\nfunction IntelligenceCenter() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: health, isLoading } = useQuery<{\n    status: string;\n    timestamp: string;\n    config: { openaiConfigured: boolean; resendConfigured: boolean };\n    stateMap: Record<string, { lastRunAt: string | null; lastRunSummary: string | null; currentFocus: string | null }>;\n  }>({\n    queryKey: [\"/api/agent/health-check\"],\n  });\n\n  const triggerMutation = useMutation({\n    mutationFn: async (type: \"daily-briefing\" | \"weekly-account-review\" | \"synthesize-learnings\") => {\n      return apiRequest(\"POST\", `/api/agent/${type}`, {});\n    },\n    onSuccess: (_, variables) => {\n      toast({\n        title: \"Agent Triggered\",\n        description: `${variables.replace(\"-\", \" \")} has been started in the background. Status will update shortly.`,\n      });\n      setTimeout(() => {\n        queryClient.invalidateQueries({ queryKey: [\"/api/agent/health-check\"] });\n      }, 5000);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Trigger Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  const services = [\n    {\n      id: \"daily-briefing\",\n      name: \"Daily Intelligence Briefing\",\n      description: \"Generates territory action plans and drafts priority emails.\",\n      schedule: \"Weekdays @ 7:00 AM EST\",\n      icon: Clock,\n    },\n    {\n      id: \"weekly-account-review\",\n      name: \"Weekly Account Review\",\n      description: \"Evaluates graduation readiness and playbook effectiveness.\",\n      schedule: \"Mondays @ 6:00 AM EST\",\n      icon: Target,\n    },\n    {\n      id: \"synthesize-learnings\",\n      name: \"AI Learning Synthesis\",\n      description: \"Distills winning patterns from past 90 days of interactions.\",\n      schedule: \"1st of Month @ 3:00 AM EST\",\n      icon: Zap,\n    },\n  ];\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n      <Card className=\"md:col-span-2 text-left\">\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Sparkles className=\"h-4 w-4 text-blue-600\" />\n            Agentic Health & Connectivity\n          </CardTitle>\n          <CardDescription>\n            Monitoring the status of the autonomous relationship intelligence layer.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"flex items-center gap-3 p-3 rounded-lg border bg-muted/30\">\n              <div className={`h-2.5 w-2.5 rounded-full ${health?.config.openaiConfigured ? \"bg-green-500\" : \"bg-red-500\"}`} />\n              <div>\n                <p className=\"text-xs font-semibold uppercase tracking-wider text-muted-foreground\">Intelligence (OpenAI)</p>\n                <p className=\"text-sm font-medium\">{health?.config.openaiConfigured ? \"Connected\" : \"Not Configured\"}</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-3 p-3 rounded-lg border bg-muted/30\">\n              <div className={`h-2.5 w-2.5 rounded-full ${health?.config.resendConfigured ? \"bg-green-500\" : \"bg-red-500\"}`} />\n              <div>\n                <p className=\"text-xs font-semibold uppercase tracking-wider text-muted-foreground\">Delivery (Resend)</p>\n                <p className=\"text-sm font-medium\">{health?.config.resendConfigured ? \"Connected\" : \"Not Configured\"}</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-3 p-3 rounded-lg border bg-muted/30\">\n              <div className=\"h-2.5 w-2.5 rounded-full bg-green-500\" />\n              <div>\n                <p className=\"text-xs font-semibold uppercase tracking-wider text-muted-foreground\">Autonomous Loop</p>\n                <p className=\"text-sm font-medium\">Active (node-cron)</p>\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {services.map((service) => {\n        const state = health?.stateMap[service.id];\n        const lastRun = state?.lastRunAt ? new Date(state.lastRunAt) : null;\n        const Icon = service.icon;\n\n        return (\n          <Card key={service.id} className=\"flex flex-col text-left\">\n            <CardHeader className=\"pb-3 text-left\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"h-10 w-10 rounded-lg bg-blue-50 flex items-center justify-center\">\n                  <Icon className=\"h-5 w-5 text-blue-600\" />\n                </div>\n                {lastRun && (\n                  <Badge variant=\"outline\" className=\"text-[10px] font-mono\">\n                    Last Run: {new Date(lastRun).toLocaleDateString()}\n                  </Badge>\n                )}\n              </div>\n              <CardTitle className=\"text-base mt-4\">{service.name}</CardTitle>\n              <CardDescription>{service.description}</CardDescription>\n            </CardHeader>\n            <CardContent className=\"flex-1 text-left\">\n              <div className=\"text-xs text-muted-foreground flex items-center gap-1.5 mb-4\">\n                <Clock className=\"h-3 w-3\" />\n                {service.schedule}\n              </div>\n              {state?.lastRunSummary && (\n                <div className=\"bg-muted/50 p-2.5 rounded-md text-[11px] text-muted-foreground border leading-relaxed mb-4\">\n                  <p className=\"font-semibold text-[10px] uppercase tracking-wider mb-1\">Latest Insight:</p>\n                  {state.lastRunSummary}\n                </div>\n              )}\n            </CardContent>\n            <div className=\"p-4 pt-0 mt-auto\">\n              <Button\n                variant=\"outline\"\n                className=\"w-full text-xs\"\n                onClick={() => triggerMutation.mutate(service.id as any)}\n                disabled={triggerMutation.isPending}\n              >\n                {triggerMutation.isPending && triggerMutation.variables === service.id ? (\n                  <Loader2 className=\"h-3 w-3 mr-2 animate-spin\" />\n                ) : (\n                  <RefreshCw className=\"h-3 w-3 mr-2\" />\n                )}\n                Run Now\n              </Button>\n            </div>\n          </Card>\n        );\n      })}\n    </div>\n  );\n}\n\nexport default function AppAdmin() {\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [sortField, setSortField] = useState<keyof TenantWithMetrics>(\"createdAt\");\n  const [sortDirection, setSortDirection] = useState<\"asc\" | \"desc\">(\"desc\");\n  const [selectedTenant, setSelectedTenant] = useState<TenantWithMetrics | null>(null);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n\n  const { data: tenantsData, isLoading: tenantsLoading, refetch: refetchTenants } = useQuery<TenantUsageResponse>({\n    queryKey: [\"/api/app-admin/tenants\"],\n  });\n\n  const { data: plans } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/subscription/plans\"],\n  });\n\n  const updateTenantMutation = useMutation({\n    mutationFn: async (data: { tenantId: number; planType: string; subscriptionStatus: string }) => {\n      return apiRequest(\"PATCH\", `/api/app-admin/tenants/${data.tenantId}`, {\n        planType: data.planType,\n        subscriptionStatus: data.subscriptionStatus\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/app-admin/tenants\"] });\n      setEditDialogOpen(false);\n      toast({\n        title: \"Tenant Updated\",\n        description: \"Subscription settings have been updated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const tenants = tenantsData?.tenants || [];\n\n  const filteredTenants = tenants.filter((tenant) =>\n    tenant.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    tenant.slug.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    (tenant.ownerEmail && tenant.ownerEmail.toLowerCase().includes(searchTerm.toLowerCase()))\n  );\n\n  const sortedTenants = [...filteredTenants].sort((a, b) => {\n    const aVal = a[sortField];\n    const bVal = b[sortField];\n    if (aVal === null || aVal === undefined) return 1;\n    if (bVal === null || bVal === undefined) return -1;\n    if (typeof aVal === \"string\" && typeof bVal === \"string\") {\n      return sortDirection === \"asc\" ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);\n    }\n    if (typeof aVal === \"number\" && typeof bVal === \"number\") {\n      return sortDirection === \"asc\" ? aVal - bVal : bVal - aVal;\n    }\n    return 0;\n  });\n\n  const handleSort = (field: keyof TenantWithMetrics) => {\n    if (field === sortField) {\n      setSortDirection(sortDirection === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortField(field);\n      setSortDirection(\"asc\");\n    }\n  };\n\n  const SortIcon = ({ field }: { field: keyof TenantWithMetrics }) => {\n    if (field !== sortField) return null;\n    return sortDirection === \"asc\" ? (\n      <ChevronUp className=\"h-4 w-4 ml-1\" />\n    ) : (\n      <ChevronDown className=\"h-4 w-4 ml-1\" />\n    );\n  };\n\n  const getStatusBadgeVariant = (status: string | null) => {\n    switch (status) {\n      case \"active\":\n        return \"default\";\n      case \"trialing\":\n        return \"secondary\";\n      case \"past_due\":\n        return \"destructive\";\n      case \"canceled\":\n        return \"outline\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  const getPlanBadgeVariant = (planType: string | null) => {\n    switch (planType) {\n      case \"enterprise\":\n        return \"default\";\n      case \"scale\":\n        return \"default\";\n      case \"growth\":\n        return \"secondary\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  const totalAccounts = tenants.reduce((sum, t) => sum + t.accountCount, 0);\n  const totalEnrolled = tenants.reduce((sum, t) => sum + t.enrolledCount, 0);\n  const totalPlaybooks = tenants.reduce((sum, t) => sum + t.playbookCount, 0);\n  const totalICPs = tenants.reduce((sum, t) => sum + t.icpCount, 0);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-bold\" data-testid=\"text-app-admin-title\">\n          Platform Administration\n        </h1>\n        <p className=\"text-muted-foreground mt-1\">\n          Manage tenants, subscriptions, and Stripe configuration\n        </p>\n      </div>\n\n      <Tabs defaultValue=\"tenants\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"tenants\" data-testid=\"tab-tenants\">\n            <Building2 className=\"mr-2 h-4 w-4\" />\n            Tenants\n          </TabsTrigger>\n          <TabsTrigger value=\"stripe\" data-testid=\"tab-stripe\">\n            <CreditCard className=\"mr-2 h-4 w-4\" />\n            Stripe Configuration\n          </TabsTrigger>\n          <TabsTrigger value=\"intelligence\" data-testid=\"tab-intelligence\">\n            <Sparkles className=\"mr-2 h-4 w-4\" />\n            Intelligence Center\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"tenants\" className=\"space-y-6\">\n          <div className=\"flex items-center justify-end\">\n            <Button\n              variant=\"outline\"\n              onClick={() => refetchTenants()}\n              disabled={tenantsLoading}\n              data-testid=\"button-refresh-tenants\"\n            >\n              <RefreshCw className={`h-4 w-4 mr-2 ${tenantsLoading ? \"animate-spin\" : \"\"}`} />\n              Refresh\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-md bg-primary/10\">\n                  <Building2 className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Tenants</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-tenants\">\n                    {tenantsData?.totalTenants ?? 0}\n                  </p>\n                </div>\n              </div>\n            </Card>\n            <Card className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-md bg-blue-500/10\">\n                  <Users className=\"h-5 w-5 text-blue-500\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Accounts</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-accounts\">\n                    {totalAccounts}\n                  </p>\n                </div>\n              </div>\n            </Card>\n            <Card className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-md bg-green-500/10\">\n                  <FileText className=\"h-5 w-5 text-green-500\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total Playbooks</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-playbooks\">\n                    {totalPlaybooks}\n                  </p>\n                </div>\n              </div>\n            </Card>\n            <Card className=\"p-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"p-2 rounded-md bg-purple-500/10\">\n                  <Target className=\"h-5 w-5 text-purple-500\" />\n                </div>\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Total ICPs</p>\n                  <p className=\"text-2xl font-bold\" data-testid=\"text-total-icps\">\n                    {totalICPs}\n                  </p>\n                </div>\n              </div>\n            </Card>\n          </div>\n\n          <Card className=\"p-4\">\n            <div className=\"flex items-center gap-4 mb-4\">\n              <div className=\"relative flex-1 max-w-md\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search tenants by name, slug, or email...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-search-tenants\"\n                />\n              </div>\n            </div>\n\n            {tenantsLoading ? (\n              <div className=\"flex items-center justify-center py-12\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead\n                        className=\"cursor-pointer\"\n                        onClick={() => handleSort(\"name\")}\n                        data-testid=\"header-name\"\n                      >\n                        <div className=\"flex items-center\">\n                          Tenant\n                          <SortIcon field=\"name\" />\n                        </div>\n                      </TableHead>\n                      <TableHead\n                        className=\"cursor-pointer\"\n                        onClick={() => handleSort(\"planType\")}\n                        data-testid=\"header-plan\"\n                      >\n                        <div className=\"flex items-center\">\n                          Plan\n                          <SortIcon field=\"planType\" />\n                        </div>\n                      </TableHead>\n                      <TableHead\n                        className=\"cursor-pointer\"\n                        onClick={() => handleSort(\"subscriptionStatus\")}\n                        data-testid=\"header-status\"\n                      >\n                        <div className=\"flex items-center\">\n                          Status\n                          <SortIcon field=\"subscriptionStatus\" />\n                        </div>\n                      </TableHead>\n                      <TableHead\n                        className=\"cursor-pointer text-right\"\n                        onClick={() => handleSort(\"accountCount\")}\n                        data-testid=\"header-accounts\"\n                      >\n                        <div className=\"flex items-center justify-end\">\n                          Accounts\n                          <SortIcon field=\"accountCount\" />\n                        </div>\n                      </TableHead>\n                      <TableHead\n                        className=\"cursor-pointer text-right\"\n                        onClick={() => handleSort(\"enrolledCount\")}\n                        data-testid=\"header-enrolled\"\n                      >\n                        <div className=\"flex items-center justify-end\">\n                          Enrolled\n                          <SortIcon field=\"enrolledCount\" />\n                        </div>\n                      </TableHead>\n                      <TableHead\n                        className=\"cursor-pointer text-right\"\n                        onClick={() => handleSort(\"playbookCount\")}\n                        data-testid=\"header-playbooks\"\n                      >\n                        <div className=\"flex items-center justify-end\">\n                          Playbooks\n                          <SortIcon field=\"playbookCount\" />\n                        </div>\n                      </TableHead>\n                      <TableHead\n                        className=\"cursor-pointer text-right\"\n                        onClick={() => handleSort(\"icpCount\")}\n                        data-testid=\"header-icps\"\n                      >\n                        <div className=\"flex items-center justify-end\">\n                          ICPs\n                          <SortIcon field=\"icpCount\" />\n                        </div>\n                      </TableHead>\n                      <TableHead className=\"w-[100px]\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {sortedTenants.length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={8} className=\"text-center py-12 text-muted-foreground\">\n                          {searchTerm ? \"No tenants match your search\" : \"No tenants found\"}\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      sortedTenants.map((tenant) => (\n                        <TableRow key={tenant.id} data-testid={`row-tenant-${tenant.id}`}>\n                          <TableCell>\n                            <div>\n                              <p className=\"font-medium\">{tenant.name}</p>\n                              <p className=\"text-sm text-muted-foreground\">{tenant.ownerEmail || tenant.slug}</p>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant={getPlanBadgeVariant(tenant.planType)}>\n                              {tenant.planType || \"free\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            <Badge variant={getStatusBadgeVariant(tenant.subscriptionStatus)}>\n                              {tenant.subscriptionStatus || \"none\"}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {tenant.accountCount}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {tenant.enrolledCount}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {tenant.playbookCount}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {tenant.icpCount}\n                          </TableCell>\n                          <TableCell>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              onClick={() => {\n                                setSelectedTenant(tenant);\n                                setEditDialogOpen(true);\n                              }}\n                              data-testid={`button-edit-tenant-${tenant.id}`}\n                            >\n                              <Edit2 className=\"h-4 w-4\" />\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </Card>\n\n          <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Edit Tenant Subscription</DialogTitle>\n                <DialogDescription>\n                  Update subscription settings for {selectedTenant?.name}\n                </DialogDescription>\n              </DialogHeader>\n              {selectedTenant && (\n                <TenantEditForm\n                  tenant={selectedTenant}\n                  plans={plans || []}\n                  onSubmit={(data) =>\n                    updateTenantMutation.mutate({\n                      tenantId: selectedTenant.id,\n                      ...data,\n                    })\n                  }\n                  isPending={updateTenantMutation.isPending}\n                />\n              )}\n            </DialogContent>\n          </Dialog>\n        </TabsContent>\n\n        <TabsContent value=\"stripe\" className=\"space-y-6\">\n          <StripeConfigManager />\n        </TabsContent>\n\n        <TabsContent value=\"intelligence\" className=\"space-y-6\">\n          <IntelligenceCenter />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nfunction TenantEditForm({\n  tenant,\n  plans,\n  onSubmit,\n  isPending,\n}: {\n  tenant: TenantWithMetrics;\n  plans: SubscriptionPlan[];\n  onSubmit: (data: { planType: string; subscriptionStatus: string }) => void;\n  isPending: boolean;\n}) {\n  const [planType, setPlanType] = useState(tenant.planType || \"free\");\n  const [subscriptionStatus, setSubscriptionStatus] = useState(\n    tenant.subscriptionStatus || \"none\"\n  );\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    onSubmit({ planType, subscriptionStatus });\n  };\n\n  const planSlugs = [\"free\", ...plans.map((p) => p.slug)];\n  const statuses = [\"none\", \"trialing\", \"active\", \"past_due\", \"canceled\", \"unpaid\"];\n\n  return (\n    <form onSubmit={handleSubmit} className=\"space-y-4\">\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"planType\">Subscription Plan</Label>\n        <Select value={planType} onValueChange={setPlanType}>\n          <SelectTrigger id=\"planType\" data-testid=\"select-plan-type\">\n            <SelectValue placeholder=\"Select plan\" />\n          </SelectTrigger>\n          <SelectContent>\n            {planSlugs.map((slug) => (\n              <SelectItem key={slug} value={slug}>\n                {slug.charAt(0).toUpperCase() + slug.slice(1)}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"subscriptionStatus\">Subscription Status</Label>\n        <Select value={subscriptionStatus} onValueChange={setSubscriptionStatus}>\n          <SelectTrigger id=\"subscriptionStatus\" data-testid=\"select-status\">\n            <SelectValue placeholder=\"Select status\" />\n          </SelectTrigger>\n          <SelectContent>\n            {statuses.map((status) => (\n              <SelectItem key={status} value={status}>\n                {status.charAt(0).toUpperCase() + status.slice(1).replace(\"_\", \" \")}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <div className=\"pt-4 border-t\">\n        <h4 className=\"font-medium mb-2\">Current Usage</h4>\n        <div className=\"grid grid-cols-2 gap-2 text-sm\">\n          <div className=\"flex justify-between\">\n            <span className=\"text-muted-foreground\">Accounts:</span>\n            <span className=\"font-mono\">{tenant.accountCount}</span>\n          </div>\n          <div className=\"flex justify-between\">\n            <span className=\"text-muted-foreground\">Enrolled:</span>\n            <span className=\"font-mono\">{tenant.enrolledCount}</span>\n          </div>\n          <div className=\"flex justify-between\">\n            <span className=\"text-muted-foreground\">Playbooks:</span>\n            <span className=\"font-mono\">{tenant.playbookCount}</span>\n          </div>\n          <div className=\"flex justify-between\">\n            <span className=\"text-muted-foreground\">ICPs:</span>\n            <span className=\"font-mono\">{tenant.icpCount}</span>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex justify-end gap-2 pt-4\">\n        <Button type=\"submit\" disabled={isPending} data-testid=\"button-save-tenant\">\n          {isPending ? (\n            <>\n              <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n              Saving...\n            </>\n          ) : (\n            \"Save Changes\"\n          )}\n        </Button>\n      </div>\n    </form>\n  );\n}\n\ninterface StripeDebugInfo {\n  mode: string;\n  isConfigured: boolean;\n  appSlug: string;\n  baseUrl: string;\n  whitelistedPriceIds: string[];\n  webhookConfigured: boolean;\n  configuredPlans: { slug: string; stripeMonthlyPriceId: string | null; stripeYearlyPriceId: string | null }[];\n  environment: {\n    hasSecretKey: boolean;\n    hasWebhookSecret: boolean;\n    hasPriceIds: boolean;\n    hasAppSlug: boolean;\n    hasBaseUrl: boolean;\n  };\n}\n\nfunction StripeConfigManager() {\n  const { toast } = useToast();\n  const [editingPlan, setEditingPlan] = useState<SubscriptionPlanConfig | null>(null);\n  const [monthlyPriceId, setMonthlyPriceId] = useState(\"\");\n  const [yearlyPriceId, setYearlyPriceId] = useState(\"\");\n\n  const { data: plans = [], isLoading } = useQuery<SubscriptionPlanConfig[]>({\n    queryKey: [\"/api/subscription/plans\"],\n  });\n\n  const { data: debugInfo, isLoading: isDebugLoading, refetch: refetchDebug } = useQuery<StripeDebugInfo>({\n    queryKey: [\"/api/stripe/debug\"],\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, stripeMonthlyPriceId, stripeYearlyPriceId }: { id: number; stripeMonthlyPriceId: string; stripeYearlyPriceId: string }) => {\n      const res = await apiRequest(\"PATCH\", `/api/subscription/plans/${id}`, {\n        stripeMonthlyPriceId,\n        stripeYearlyPriceId,\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Success\", description: \"Stripe price IDs updated successfully\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/subscription/plans\"] });\n      setEditingPlan(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleEdit = (plan: SubscriptionPlanConfig) => {\n    setEditingPlan(plan);\n    setMonthlyPriceId(plan.stripeMonthlyPriceId || \"\");\n    setYearlyPriceId(plan.stripeYearlyPriceId || \"\");\n  };\n\n  const handleSave = () => {\n    if (!editingPlan) return;\n    updateMutation.mutate({\n      id: editingPlan.id,\n      stripeMonthlyPriceId: monthlyPriceId,\n      stripeYearlyPriceId: yearlyPriceId,\n    });\n  };\n\n  const webhookUrl = typeof window !== \"undefined\"\n    ? `${window.location.origin}/api/stripe/webhook`\n    : \"/api/stripe/webhook\";\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Stripe Configuration</CardTitle>\n          <CardDescription>\n            Configure Stripe price IDs for subscription plans. You must create products and prices in your Stripe Dashboard first.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"bg-muted/50 rounded-md p-4 space-y-3\">\n            <h4 className=\"font-medium flex items-center gap-2\">\n              <HelpCircle className=\"h-4 w-4\" />\n              Webhook Configuration\n            </h4>\n            <p className=\"text-sm text-muted-foreground\">\n              Add this webhook URL to your Stripe Dashboard under Developers &gt; Webhooks:\n            </p>\n            <div className=\"flex items-center gap-2\">\n              <Input\n                value={webhookUrl}\n                readOnly\n                className=\"font-mono text-sm bg-background\"\n                data-testid=\"input-webhook-url\"\n              />\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => {\n                  navigator.clipboard.writeText(webhookUrl);\n                  toast({ title: \"Copied\", description: \"Webhook URL copied to clipboard\" });\n                }}\n                data-testid=\"button-copy-webhook\"\n              >\n                Copy\n              </Button>\n            </div>\n            <p className=\"text-xs text-muted-foreground\">\n              Events to enable: checkout.session.completed, customer.subscription.created, customer.subscription.updated, customer.subscription.deleted, invoice.paid, invoice.payment_failed\n            </p>\n          </div>\n\n          <Separator />\n\n          <div>\n            <h4 className=\"font-medium mb-4\">Subscription Plans</h4>\n            {isLoading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <RefreshCw className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Plan</TableHead>\n                    <TableHead>Monthly Price</TableHead>\n                    <TableHead>Monthly Price ID</TableHead>\n                    <TableHead>Yearly Price</TableHead>\n                    <TableHead>Yearly Price ID</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {plans.map((plan) => (\n                    <TableRow key={plan.id} data-testid={`row-plan-${plan.slug}`}>\n                      <TableCell className=\"font-medium\">{plan.name}</TableCell>\n                      <TableCell>${plan.monthlyPrice}/mo</TableCell>\n                      <TableCell>\n                        {plan.stripeMonthlyPriceId ? (\n                          <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                            {plan.stripeMonthlyPriceId}\n                          </Badge>\n                        ) : (\n                          <Badge variant=\"secondary\">Not configured</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell>${plan.yearlyPrice}/yr</TableCell>\n                      <TableCell>\n                        {plan.stripeYearlyPriceId ? (\n                          <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                            {plan.stripeYearlyPriceId}\n                          </Badge>\n                        ) : (\n                          <Badge variant=\"secondary\">Not configured</Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleEdit(plan)}\n                          data-testid={`button-edit-plan-${plan.slug}`}\n                        >\n                          <Pencil className=\"h-4 w-4\" />\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0\">\n          <div>\n            <CardTitle className=\"text-base\">Stripe Debug Info</CardTitle>\n            <CardDescription>\n              Environment status and configuration details (no secrets exposed)\n            </CardDescription>\n          </div>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => refetchDebug()}\n            disabled={isDebugLoading}\n            data-testid=\"button-refresh-debug\"\n          >\n            <RefreshCw className={`h-4 w-4 mr-2 ${isDebugLoading ? \"animate-spin\" : \"\"}`} />\n            Refresh\n          </Button>\n        </CardHeader>\n        <CardContent>\n          {isDebugLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <RefreshCw className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : debugInfo ? (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                <div className=\"p-3 bg-muted/50 rounded-md\">\n                  <div className=\"text-sm text-muted-foreground\">Mode</div>\n                  <div className=\"font-medium flex items-center gap-2\">\n                    <Badge variant={debugInfo.mode === \"test\" ? \"secondary\" : \"default\"}>\n                      {debugInfo.mode.toUpperCase()}\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"p-3 bg-muted/50 rounded-md\">\n                  <div className=\"text-sm text-muted-foreground\">Status</div>\n                  <div className=\"font-medium\">\n                    <Badge variant={debugInfo.isConfigured ? \"default\" : \"destructive\"}>\n                      {debugInfo.isConfigured ? \"Configured\" : \"Not Configured\"}\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"p-3 bg-muted/50 rounded-md\">\n                  <div className=\"text-sm text-muted-foreground\">Webhook</div>\n                  <div className=\"font-medium\">\n                    <Badge variant={debugInfo.webhookConfigured ? \"default\" : \"destructive\"}>\n                      {debugInfo.webhookConfigured ? \"Configured\" : \"Not Configured\"}\n                    </Badge>\n                  </div>\n                </div>\n                <div className=\"p-3 bg-muted/50 rounded-md\">\n                  <div className=\"text-sm text-muted-foreground\">App Slug</div>\n                  <div className=\"font-mono text-sm truncate\">{debugInfo.appSlug || \"â€”\"}</div>\n                </div>\n              </div>\n\n              <Separator />\n\n              <div>\n                <h4 className=\"font-medium mb-2\">Environment Variables</h4>\n                <div className=\"grid grid-cols-2 md:grid-cols-5 gap-2\">\n                  {Object.entries(debugInfo.environment).map(([key, value]) => (\n                    <div key={key} className=\"flex items-center gap-2 text-sm\">\n                      <div className={`h-2 w-2 rounded-full ${value ? \"bg-green-500\" : \"bg-red-500\"}`} />\n                      <span className=\"text-muted-foreground\">\n                        {key.replace(/^has/, \"\").replace(/([A-Z])/g, \" $1\").trim()}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              <Separator />\n\n              <div>\n                <h4 className=\"font-medium mb-2\">Base URL</h4>\n                <Input value={debugInfo.baseUrl} readOnly className=\"font-mono text-sm bg-muted/50\" />\n              </div>\n\n              {debugInfo.whitelistedPriceIds.length > 0 && (\n                <>\n                  <Separator />\n                  <div>\n                    <h4 className=\"font-medium mb-2\">Whitelisted Price IDs</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {debugInfo.whitelistedPriceIds.map((priceId) => (\n                        <Badge key={priceId} variant=\"outline\" className=\"font-mono text-xs\">\n                          {priceId}\n                        </Badge>\n                      ))}\n                    </div>\n                  </div>\n                </>\n              )}\n            </div>\n          ) : (\n            <p className=\"text-muted-foreground\">Unable to load debug information</p>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!editingPlan} onOpenChange={(open) => !open && setEditingPlan(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Stripe Price IDs</DialogTitle>\n            <DialogDescription>\n              Enter the Stripe Price IDs for {editingPlan?.name}. Get these from your Stripe Dashboard under Products.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"monthly-price-id\">Monthly Price ID</Label>\n              <Input\n                id=\"monthly-price-id\"\n                value={monthlyPriceId}\n                onChange={(e) => setMonthlyPriceId(e.target.value)}\n                placeholder=\"price_1234567890...\"\n                className=\"font-mono\"\n                data-testid=\"input-monthly-price-id\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Price: ${editingPlan?.monthlyPrice}/month\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"yearly-price-id\">Yearly Price ID</Label>\n              <Input\n                id=\"yearly-price-id\"\n                value={yearlyPriceId}\n                onChange={(e) => setYearlyPriceId(e.target.value)}\n                placeholder=\"price_0987654321...\"\n                className=\"font-mono\"\n                data-testid=\"input-yearly-price-id\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Price: ${editingPlan?.yearlyPrice}/year\n              </p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setEditingPlan(null)}\n              data-testid=\"button-cancel-price\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSave}\n              disabled={updateMutation.isPending}\n              data-testid=\"button-save-price\"\n            >\n              {updateMutation.isPending && <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Save\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":40972,"size_tokens":null},"replit.md":{"content":"# AI VP Dashboard\n\n## Overview\n\nThe AI VP Dashboard is a sales intelligence tool designed for ABC Supply. Its primary purpose is to identify wallet share leakage within existing customer accounts and to generate actionable tasks for Territory Managers, thereby helping to recover lost revenue. The system leverages AI to analyze purchasing patterns, construct Ideal Customer Profiles (ICPs) by market segment, score accounts based on category gaps, and create personalized sales tools like call scripts and email templates. The project aims to enhance sales efficiency, improve customer penetration, and drive revenue growth for ABC Supply.\n\n## User Preferences\n\nI want iterative development and prefer explanations to be detailed. I also want to be asked before making major changes. I prefer to use a functional programming paradigm when possible.\n\n## System Architecture\n\nThe application follows a client-server architecture.\n\n**Frontend:**\n- **Technology:** React + TypeScript, built with Vite.\n- **Styling:** Tailwind CSS for utility-first styling, complemented by shadcn/ui for pre-built, accessible components.\n- **Charting:** Recharts for data visualization.\n- **UI/UX:**\n    - Professional blue color scheme.\n    - Support for both light and dark modes.\n    - Responsive layout with a persistent sidebar navigation.\n    - Comprehensive tooltip system for user guidance across all pages (Dashboard, Account Insights, ICP Builder, Playbooks, Revenue, Data Uploads).\n    - Draggable, resizable, and collapsible dashboard blocks with state persistence in `localStorage`.\n    - \"Daily Focus\" section on the dashboard for urgent tasks.\n    - \"Getting Started\" progress indicator to guide new users.\n    - Enhanced cross-navigation allowing drill-down from dashboard KPIs to detailed account analysis and pre-filled playbook generation.\n    - Dynamic branding settings (Company Name, Application Title, Company Logo) persisted in the database and updated in real-time.\n    - **Workflow Guide:** Visual swim lane chart showing Setup (one-time), Monthly, Weekly, and Daily workflows with clickable steps that navigate directly to corresponding features.\n    - **Top Opportunities Block:** Enhanced dashboard block showing top 10 accounts with sortable columns (Account, Segment, Region, Revenue, Penetration, Score, Enrolled), column visibility toggle with localStorage persistence, and direct link to accounts page.\n    - **Revenue by Segment:** Chart connected to live enrolled accounts data from revenue tracking, with fallback to segment breakdown when no enrolled accounts exist.\n    - **Promotional Landing Page:** Marketing website at `/promo` route featuring hero section with value propositions, features showcase, fee-for-success pricing (15% success fee declining with volume, $1,200 setup fee, hybrid option available), testimonials, and demo request form with Zod validation. Includes SEO meta tags. Renders outside the main dashboard layout.\n\n**Navigation Structure:**\n- **Main Section:** Dashboard, Revenue Tracking, Workflow Guide, Accounts, ICP Builder, Playbooks\n- **Admin Section:** Data Uploads, Settings\n\n**Backend:**\n- **Technology:** Express.js with Node.js.\n- **Database Interaction:** PostgreSQL managed by Neon, with Drizzle ORM for type-safe database access.\n- **Authentication:** Replit Auth (OpenID Connect) providing Google, GitHub, and email/password login options. Session management via PostgreSQL with connect-pg-simple. New users automatically get a tenant created with super_admin role on first login.\n- **API:** RESTful API endpoints for dashboard statistics, account management, ICP profiles, task management, playbook generation, revenue tracking, data uploads, and custom category management. All API routes are protected with authentication middleware.\n- **Multi-Tenancy:** Complete tenant isolation system with:\n    - All data tables include a `tenantId` column (including child tables: orderItems, profileCategories, profileReviewLog, playbookTasks).\n    - TenantStorage class provides tenant-scoped data access for all queries.\n    - Tenant context middleware extracts tenantId from user_roles and attaches to request.\n    - Auto-tenant creation for new users with default super_admin role.\n- **Role-Based Access Control:**\n    - `super_admin`: Full access including read, write, delete, manage_users, manage_settings.\n    - `reviewer`: Read and approve permissions.\n    - `viewer`: Read-only access.\n    - Admin routes (settings, data uploads, territory managers, custom categories, rev-share tiers) protected with `authWithAdmin` middleware requiring `manage_settings` permission.\n- **Core Features:**\n    - **Data Uploads:** Supports CSV imports for accounts, orders, products, and categories.\n    - **Account Insights:** Provides gap analysis, opportunity scores, and category penetration metrics for accounts.\n    - **ICP Builder:** AI-assisted definition and management of Ideal Customer Profiles, including data insights for transparency into AI analysis and decision logic.\n    - **Playbooks & Tasks:** AI-generated sales tasks, call scripts, and email templates, with automatic playbook generation upon account enrollment.\n    - **Revenue Tracking:** Tracks enrolled accounts, incremental revenue, and calculates rev-share fees. Includes account graduation system for marking accounts as successfully completed.\n    - **Account Graduation System:** Allows setting graduation objectives (target penetration %, incremental revenue, enrollment duration), tracking progress, and graduating accounts when objectives are met. Graduated accounts move to an alumni section.\n    - **Tiered Rev-Share Pricing:** Configurable volume-based pricing tiers for calculating fees owed to Tenexity. Supports multiple tiers with different rates at different revenue thresholds, calculates blended effective rates, and displays tier breakdown showing how fees are distributed across tiers.\n    - **Custom Categories:** Allows full CRUD operations for product categories, which are integrated into AI analysis for ICP and playbook generation.\n    - **Scoring Settings:** Customizable weighting factors for opportunity scoring (Gap Size, Revenue Potential, Category Count).\n    - **Territory Manager Administration:** CRUD operations for Territory Managers, including territory assignments and task linkage.\n    - **Email OAuth & Inbox Sync:** Microsoft (Azure AD) and Google OAuth integration for syncing customer email inboxes. OAuth tokens stored in `email_connections` table with automatic refresh. Email sync service fetches emails via Graph API / Gmail API and stores in `synced_emails` table.\n    - **AI Email Analysis Pipeline:** Enhanced GPT-4o analysis extracts 10+ intelligence categories from emails: sentiment, sales urgency, action items, contacts, projects, order signals, competitor mentions, account mentions, and product category mapping. Structured JSON output parsed with Zod schemas.\n    - **CRM Auto-Population:** Auto-linking service (`email-crm-linker.ts`) processes AI analysis output to automatically create/update CRM records (contacts, projects, order signals, competitor mentions) with deduplication logic. Contacts deduped by email then name+account; order signals/competitor mentions deduped by sourceEmailId + signal type/competitor name + product category.\n    - **CRM API Routes:** Full CRUD for contacts, projects, order signals, competitor mentions under `/api/crm/*`. Read routes use `requireSubscription`; mutation routes use `requireWrite`. All operations go through TenantStorage for tenant isolation.\n    - **Email Notifications:** Integrated with Resend for sending task notification emails to Territory Managers when tasks are assigned. Configurable sender settings and notification preferences in Settings > Email tab. Requires RESEND_API_KEY secret.\n    - **Stripe Subscription Billing:** Complete subscription management with:\n        - Price ID whitelist validation (STRIPE_PRICE_IDS env var)\n        - App-specific metadata filtering (APP_SLUG env var) for multi-app Stripe accounts\n        - Atomic idempotency checking to prevent duplicate webhook processing\n        - Fail-closed security: events with unknown price IDs or missing app metadata are skipped\n        - Structured JSON logging for webhook events\n        - Debug endpoint for platform admins (no secrets exposed)\n        - Tier-based feature limits (Starter: 1 playbook/1 ICP/1 enrolled; Growth: unlimited playbooks/3 ICPs/5 enrolled; Scale: unlimited all)\n        - See STRIPE-SETUP.md for configuration details\n\n**Project Structure:**\n- `client/`: Frontend application.\n- `server/`: Backend application, including database connection, API routes, storage, and seeding scripts.\n- `shared/`: Shared schema definitions and AI chat models.\n\n**Database Schema:** Key tables include `users`, `sessions`, `tenants`, `user_roles`, `accounts`, `products`, `orders`, `segment_profiles`, `account_metrics`, `tasks`, `playbooks`, `program_accounts`, `custom_categories`, `settings`, `territory_managers`, `rev_share_tiers`, `email_connections`, `synced_emails`, `contacts`, `projects`, `email_interactions`, `order_signals`, and `competitor_mentions`.\n\n## External Dependencies\n\n- **PostgreSQL (Neon):** Primary database for persistent data storage.\n- **OpenAI:** Integrated via Replit AI Integrations (GPT-5.1) for AI-driven analysis, ICP generation, script writing, and task generation.\n- **Recharts:** Used for rendering interactive charts and data visualizations on the frontend.\n- **shadcn/ui:** Component library for building the user interface.\n- **@hello-pangea/dnd:** Library used for drag-and-drop functionality on the dashboard.\n- **Resend:** Email delivery service for sending task notifications to Territory Managers.\n- **Tenexity:** Acknowledged in the sidebar footer with logo.\n\n## Roadmap\n\n- **PHASE-B.md:** CRM evolution roadmap documenting planned features â€” Contact Management, Activity Timeline, Notes, full OAuth Email Integration (Gmail/Outlook) with AI analysis pipeline, and Advanced Search. Status: Planning.","path":null,"size_bytes":10069,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1080,"size_tokens":null},"server/notify-webhook.ts":{"content":"/**\n * notify-webhook.ts â€” Phase 5\n *\n * Standardised helper for firing outbound CRM webhook notifications.\n * Wraps `queueCrmEvent` + `processCrmSyncQueue` for callers that want\n * to queue-and-immediately-attempt a single event rather than waiting\n * for the 4-hour cron retry.\n *\n * Usage:\n *   await notifyWebhook(tenantId, \"enrollment\", accountId, payload);\n */\n\nimport { queueCrmEvent, processCrmSyncQueue, CrmPayload } from \"./services/crm-sync-push.js\";\n\n/**\n * Queue a CRM event and immediately attempt delivery.\n * If delivery fails, the row stays in agent_crm_sync_queue for retry.\n */\nexport async function notifyWebhook(\n    tenantId: number,\n    eventType: string,\n    accountId: number,\n    payload: CrmPayload,\n): Promise<void> {\n    try {\n        await queueCrmEvent(tenantId, eventType, accountId, payload);\n        // Best-effort immediate delivery â€” swallow error, cron will retry\n        await processCrmSyncQueue(tenantId).catch((err) =>\n            console.warn(\"[notify-webhook] Immediate delivery attempt failed (will retry via cron):\", err?.message),\n        );\n    } catch (err) {\n        console.error(\"[notify-webhook] Failed to queue CRM event:\", err);\n    }\n}\n\n/**\n * Convenience wrapper for enrollment events.\n */\nexport async function notifyEnrollment(\n    tenantId: number,\n    accountId: number,\n    accountName: string,\n    assignedTm: string,\n    _playbookType: string,\n): Promise<void> {\n    await notifyWebhook(tenantId, \"enrollment\", accountId, {\n        event: \"enrollment\",\n        account_id: accountId,\n        account_name: accountName,\n        segment: null,\n        enrollment_status: \"enrolled\",\n        assigned_tm: assignedTm,\n        timestamp: new Date().toISOString(),\n    });\n}\n\n/**\n * Convenience wrapper for graduation events.\n */\nexport async function notifyGraduation(\n    tenantId: number,\n    accountId: number,\n    accountName: string,\n    assignedTm: string,\n    _graduationRevenue: number,\n    _enrollmentDays: number,\n): Promise<void> {\n    await notifyWebhook(tenantId, \"graduation\", accountId, {\n        event: \"graduation\",\n        account_id: accountId,\n        account_name: accountName,\n        assigned_tm: assignedTm,\n        graduation_reason: \"Met all graduation thresholds via weekly review.\",\n        timestamp: new Date().toISOString(),\n    });\n}\n\n/**\n * Convenience wrapper for at-risk events.\n */\nexport async function notifyAtRisk(\n    tenantId: number,\n    accountId: number,\n    accountName: string,\n    assignedTm: string,\n    riskSignals: string[],\n    _riskLevel: \"low\" | \"medium\" | \"high\" | \"critical\",\n): Promise<void> {\n    await notifyWebhook(tenantId, \"at_risk\", accountId, {\n        event: \"at_risk\",\n        account_id: accountId,\n        account_name: accountName,\n        risk_signals: riskSignals,\n        assigned_tm: assignedTm,\n        timestamp: new Date().toISOString(),\n    });\n}\n","path":null,"size_bytes":2885,"size_tokens":null},"server/replit_integrations/image/client.ts":{"content":"import fs from \"node:fs\";\nimport OpenAI, { toFile } from \"openai\";\nimport { Buffer } from \"node:buffer\";\n\nexport const openai = new OpenAI({\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n});\n\n/**\n * Generate an image and return as Buffer.\n * Uses gpt-image-1 model via Replit AI Integrations.\n */\nexport async function generateImageBuffer(\n  prompt: string,\n  size: \"1024x1024\" | \"512x512\" | \"256x256\" = \"1024x1024\"\n): Promise<Buffer> {\n  const response = await openai.images.generate({\n    model: \"gpt-image-1\",\n    prompt,\n    size,\n  });\n  const base64 = response.data[0]?.b64_json ?? \"\";\n  return Buffer.from(base64, \"base64\");\n}\n\n/**\n * Edit/combine multiple images into a composite.\n * Uses gpt-image-1 model via Replit AI Integrations.\n */\nexport async function editImages(\n  imageFiles: string[],\n  prompt: string,\n  outputPath?: string\n): Promise<Buffer> {\n  const images = await Promise.all(\n    imageFiles.map((file) =>\n      toFile(fs.createReadStream(file), file, {\n        type: \"image/png\",\n      })\n    )\n  );\n\n  const response = await openai.images.edit({\n    model: \"gpt-image-1\",\n    image: images,\n    prompt,\n  });\n\n  const imageBase64 = response.data[0]?.b64_json ?? \"\";\n  const imageBytes = Buffer.from(imageBase64, \"base64\");\n\n  if (outputPath) {\n    fs.writeFileSync(outputPath, imageBytes);\n  }\n\n  return imageBytes;\n}\n\n","path":null,"size_bytes":1410,"size_tokens":null},"server/services/generate-playbook.ts":{"content":"/**\n * Generate Playbook Service â€” Phase 3\n *\n * POST /api/agent/generate-playbook\n * Body: { accountId: number, playbookType?: string }\n *\n * Flow:\n *   1. Assembles full account context\n *   2. Fetches applicable learnings for this account's segment\n *   3. Calls OpenAI gpt-4o with structured JSON response schema\n *   4. Validates + writes to agent_playbooks\n *   5. Writes agent_memo back to agent_state\n */\n\nimport OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { db } from \"../db\";\nimport { agentPlaybooks } from \"@shared/schema\";\nimport { assembleAccountContext, buildFullSystemPrompt } from \"./account-context\";\nimport { getCoreSystemPrompt, readAgentState, writeAgentMemo, AGENT_MEMO_INSTRUCTION } from \"./agent-identity\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\n// â”€â”€â”€ Response schema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst PlaybookResponseSchema = z.object({\n    playbook_type: z.enum([\"category_winback\", \"new_category\", \"at_risk_retention\", \"graduation_push\", \"project_based\"]),\n    priority_action: z.string().max(200),\n    urgency_level: z.enum([\"immediate\", \"this_week\", \"this_month\"]),\n    rationale: z.string(), // why this playbook type was chosen\n    call_script: z.string(),\n    email_subject: z.string(),\n    email_draft: z.string(),\n    talking_points: z.array(z.string()).max(5),\n    objection_handlers: z.array(z.object({\n        objection: z.string(),\n        response: z.string(),\n    })).max(3),\n    personalization_notes: z.string(),\n    agent_memo: z.object({\n        last_run_summary: z.string(),\n        current_focus: z.string(),\n        pattern_notes_addition: z.string(),\n        anomalies_watching: z.array(z.object({\n            account_name: z.string(),\n            signal: z.string(),\n            watch_until_date: z.string(),\n        })),\n    }),\n});\n\n// â”€â”€â”€ Main service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function generatePlaybook(\n    accountId: number,\n    tenantId: number,\n    requestedType?: string,\n): Promise<{ playbookId: number; playbookType: string; priorityAction: string | null }> {\n    // 1. Assemble context\n    const ctx = await assembleAccountContext(accountId, tenantId);\n    const systemPrompt = await buildFullSystemPrompt(ctx);\n\n    // 2. Determine playbook type instruction\n    const typeInstruction = requestedType\n        ? `Generate a \"${requestedType}\" playbook.`\n        : \"Choose the most appropriate playbook type based on the account data: category_winback, new_category, at_risk_retention, graduation_push, or project_based.\";\n\n    // 3. Call OpenAI\n    const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        temperature: 0.4,\n        response_format: { type: \"json_object\" },\n        messages: [\n            { role: \"system\", content: systemPrompt },\n            {\n                role: \"user\",\n                content: [\n                    typeInstruction,\n                    \"Generate a complete, data-grounded playbook for this account.\",\n                    \"Your response must be valid JSON matching the specified schema.\",\n                    \"Be specific â€“ reference this account's actual revenue numbers, categories, and contacts by name.\",\n                    \"The call_script and email_draft must be fully written out, not placeholders.\",\n                    AGENT_MEMO_INSTRUCTION,\n                ].join(\"\\n\\n\"),\n            },\n        ],\n    });\n\n    const raw = JSON.parse(completion.choices[0].message.content ?? \"{}\");\n\n    // 4. Validate\n    const parsed = PlaybookResponseSchema.parse(raw);\n\n    // 5. Write to agent_playbooks\n    const [playbook] = await db.insert(agentPlaybooks).values({\n        tenantId,\n        accountId,\n        playbookType: parsed.playbook_type,\n        status: \"active\",\n        priorityAction: parsed.priority_action,\n        urgencyLevel: parsed.urgency_level,\n        aiGeneratedContent: {\n            rationale: parsed.rationale,\n            call_script: parsed.call_script,\n            email_subject: parsed.email_subject,\n            email_draft: parsed.email_draft,\n            talking_points: parsed.talking_points,\n            objection_handlers: parsed.objection_handlers,\n            personalization_notes: parsed.personalization_notes,\n        },\n        learningsApplied: ctx.applicableLearnings.map((l) => l.learning.slice(0, 60)),\n    }).returning();\n\n    // 6. Write agent memo\n    await writeAgentMemo(tenantId, \"generate-playbook\", parsed.agent_memo);\n\n    console.log(`[generate-playbook] Account ${accountId}: ${parsed.playbook_type} playbook created (id=${playbook.id})`);\n    return { playbookId: playbook.id, playbookType: parsed.playbook_type, priorityAction: parsed.priority_action };\n}\n","path":null,"size_bytes":5027,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"server/replit_integrations/auth/index.ts":{"content":"export { setupAuth, isAuthenticated, getSession } from \"./replitAuth\";\nexport { authStorage, type IAuthStorage } from \"./storage\";\nexport { registerAuthRoutes } from \"./routes\";\n","path":null,"size_bytes":178,"size_tokens":null},"server/replit_integrations/image/index.ts":{"content":"export { registerImageRoutes } from \"./routes\";\nexport { openai, generateImageBuffer, editImages } from \"./client\";\n\n","path":null,"size_bytes":117,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"server/replit_integrations/chat/storage.ts":{"content":"import { db } from \"../../db\";\nimport { conversations, messages } from \"@shared/schema\";\nimport { eq, desc } from \"drizzle-orm\";\n\nexport interface IChatStorage {\n  getConversation(id: number): Promise<typeof conversations.$inferSelect | undefined>;\n  getAllConversations(): Promise<(typeof conversations.$inferSelect)[]>;\n  createConversation(title: string): Promise<typeof conversations.$inferSelect>;\n  deleteConversation(id: number): Promise<void>;\n  getMessagesByConversation(conversationId: number): Promise<(typeof messages.$inferSelect)[]>;\n  createMessage(conversationId: number, role: string, content: string): Promise<typeof messages.$inferSelect>;\n}\n\nexport const chatStorage: IChatStorage = {\n  async getConversation(id: number) {\n    const [conversation] = await db.select().from(conversations).where(eq(conversations.id, id));\n    return conversation;\n  },\n\n  async getAllConversations() {\n    return db.select().from(conversations).orderBy(desc(conversations.createdAt));\n  },\n\n  async createConversation(title: string) {\n    const [conversation] = await db.insert(conversations).values({ title }).returning();\n    return conversation;\n  },\n\n  async deleteConversation(id: number) {\n    await db.delete(messages).where(eq(messages.conversationId, id));\n    await db.delete(conversations).where(eq(conversations.id, id));\n  },\n\n  async getMessagesByConversation(conversationId: number) {\n    return db.select().from(messages).where(eq(messages.conversationId, conversationId)).orderBy(messages.createdAt);\n  },\n\n  async createMessage(conversationId: number, role: string, content: string) {\n    const [message] = await db.insert(messages).values({ conversationId, role, content }).returning();\n    return message;\n  },\n};\n\n","path":null,"size_bytes":1737,"size_tokens":null},"server/services/account-embedding.ts":{"content":"/**\n * Account Embedding Service â€” Phase 2\n *\n * generateAccountEmbedding(accountId, tenantId)\n *   - Builds a rich text profile of the account from DB data\n *   - Calls OpenAI text-embedding-3-small â†’ 1536-dim vector\n *   - Stores as jsonb in accounts.embedding (POC; pgvector migration deferred)\n *\n * findSimilarAccounts(accountId, tenantId)\n *   - Cosine similarity search across all stored embeddings in the tenant\n *   - Upserts top matches into agent_similar_account_pairs\n *\n * refreshAllEmbeddings(tenantId)\n *   - Batch re-generates embeddings for all enrolled accounts (called by scheduler)\n */\n\nimport OpenAI from \"openai\";\nimport { db } from \"../db\";\nimport {\n    accounts,\n    accountMetrics,\n    agentSimilarAccountPairs,\n} from \"@shared/schema\";\nimport { and, eq, ne, isNotNull } from \"drizzle-orm\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\n// â”€â”€â”€ Embedding model â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst EMBEDDING_MODEL = \"text-embedding-3-small\"; // 1536 dims, cheap, fast\n\n// â”€â”€â”€ Build text profile for embedding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction buildProfileText(\n    account: { name: string; segment: string | null; region: string | null; assignedTm: string | null },\n    metrics: { last12mRevenue: string | null; last3mRevenue: string | null; categoryCount: number | null; yoyGrowthRate: string | null } | null,\n): string {\n    return [\n        `Contractor: ${account.name}`,\n        `Trade segment: ${account.segment ?? \"unknown\"}`,\n        `Region: ${account.region ?? \"unknown\"}`,\n        `Territory manager: ${account.assignedTm ?? \"unassigned\"}`,\n        metrics\n            ? [\n                `Last 12 months revenue: $${metrics.last12mRevenue ?? 0}`,\n                `Last 3 months revenue: $${metrics.last3mRevenue ?? 0}`,\n                `YoY growth rate: ${metrics.yoyGrowthRate ?? 0}%`,\n                `Number of product categories purchased: ${metrics.categoryCount ?? 0}`,\n            ].join(\". \")\n            : \"No financial metrics available.\",\n    ].join(\". \");\n}\n\n// â”€â”€â”€ Cosine similarity (pure JS â€” no pgvector needed for POC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction cosineSimilarity(a: number[], b: number[]): number {\n    if (a.length !== b.length) return 0;\n    let dot = 0, normA = 0, normB = 0;\n    for (let i = 0; i < a.length; i++) {\n        dot += a[i] * b[i];\n        normA += a[i] * a[i];\n        normB += b[i] * b[i];\n    }\n    const denom = Math.sqrt(normA) * Math.sqrt(normB);\n    return denom === 0 ? 0 : dot / denom;\n}\n\n// â”€â”€â”€ Generate and store a single account embedding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function generateAccountEmbedding(\n    accountId: number,\n    tenantId: number,\n): Promise<number[]> {\n    const [accountRow, metricsRow] = await Promise.all([\n        db.select().from(accounts).where(and(eq(accounts.id, accountId), eq(accounts.tenantId, tenantId))).limit(1),\n        db.select().from(accountMetrics).where(and(eq(accountMetrics.accountId, accountId), eq(accountMetrics.tenantId, tenantId))).limit(1),\n    ]);\n\n    const account = accountRow[0];\n    if (!account) throw new Error(`Account ${accountId} not found`);\n\n    const profileText = buildProfileText(account, metricsRow[0] ?? null);\n\n    const response = await openai.embeddings.create({\n        model: EMBEDDING_MODEL,\n        input: profileText,\n    });\n\n    const vector = response.data[0].embedding;\n\n    // Store as jsonb in accounts.embedding\n    await db.update(accounts)\n        .set({ embedding: vector } as any)\n        .where(and(eq(accounts.id, accountId), eq(accounts.tenantId, tenantId)));\n\n    console.log(`[embedding] Generated for account ${accountId} (${account.name}), ${vector.length} dims`);\n    return vector;\n}\n\n// â”€â”€â”€ Find similar accounts via cosine similarity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function findSimilarAccounts(\n    accountId: number,\n    tenantId: number,\n    topK = 5,\n): Promise<void> {\n    // Get embedding for this account\n    const [targetRow] = await db.select().from(accounts).where(and(eq(accounts.id, accountId), eq(accounts.tenantId, tenantId))).limit(1);\n    if (!targetRow || !(targetRow as any).embedding) {\n        throw new Error(`Account ${accountId} has no embedding. Run generateAccountEmbedding first.`);\n    }\n    const targetVec: number[] = (targetRow as any).embedding as number[];\n\n    // Get all other accounts in the tenant that have embeddings\n    const candidates = await db.select().from(accounts)\n        .where(and(\n            eq(accounts.tenantId, tenantId),\n            ne(accounts.id, accountId),\n            isNotNull((accounts as any).embedding),\n        ));\n\n    // Compute cosine similarities\n    const scored = candidates\n        .map((c) => ({\n            accountId: c.id,\n            score: cosineSimilarity(targetVec, (c as any).embedding as number[]),\n            segment: c.segment,\n            region: c.region,\n        }))\n        .sort((a, b) => b.score - a.score)\n        .slice(0, topK);\n\n    if (scored.length === 0) return;\n\n    // Fetch graduation status for each candidate\n    for (const match of scored) {\n        const candidateMetrics = await db.select().from(accountMetrics)\n            .where(and(eq(accountMetrics.accountId, match.accountId), eq(accountMetrics.tenantId, tenantId)))\n            .limit(1);\n\n        const candidateAccount = candidates.find((c) => c.id === match.accountId);\n        const isGraduated = (candidateAccount as any)?.enrollmentStatus === \"graduated\";\n        const gradRevenue = candidateMetrics[0]?.last12mRevenue ?? null;\n\n        // Upsert into agent_similar_account_pairs\n        await db.insert(agentSimilarAccountPairs).values({\n            tenantId,\n            accountIdA: accountId,\n            accountIdB: match.accountId,\n            similarityScore: match.score.toFixed(4),\n            sharedSegment: match.segment,\n            sharedRegion: match.region,\n            accountBGraduated: isGraduated,\n            accountBGraduationRevenue: isGraduated ? gradRevenue : null,\n        }).onConflictDoNothing();\n    }\n\n    console.log(`[embedding] Stored ${scored.length} similar account pairs for account ${accountId}`);\n}\n\n// â”€â”€â”€ Batch refresh for all enrolled accounts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function refreshAllEmbeddings(tenantId: number): Promise<void> {\n    const enrolledAccounts = await db.select({ id: accounts.id, name: accounts.name })\n        .from(accounts)\n        .where(and(\n            eq(accounts.tenantId, tenantId),\n            eq((accounts as any).enrollmentStatus, \"enrolled\"),\n        ));\n\n    console.log(`[embedding] Refreshing embeddings for ${enrolledAccounts.length} enrolled accounts...`);\n\n    for (const acc of enrolledAccounts) {\n        try {\n            await generateAccountEmbedding(acc.id, tenantId);\n            await findSimilarAccounts(acc.id, tenantId);\n        } catch (err) {\n            console.error(`[embedding] Failed for account ${acc.id} (${acc.name}):`, err);\n        }\n    }\n\n    console.log(`[embedding] Batch refresh complete.`);\n}\n","path":null,"size_bytes":7518,"size_tokens":null},"client/src/components/kpi-card.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport { LucideIcon, TrendingUp, TrendingDown, HelpCircle } from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface KPICardProps {\n  title: string;\n  value: string | number;\n  subtitle?: string;\n  icon?: LucideIcon;\n  trend?: {\n    value: number;\n    label: string;\n  };\n  className?: string;\n  testId?: string;\n  tooltip?: string;\n}\n\nexport function KPICard({\n  title,\n  value,\n  subtitle,\n  icon: Icon,\n  trend,\n  className,\n  testId,\n  tooltip,\n}: KPICardProps) {\n  const isPositiveTrend = trend && trend.value >= 0;\n\n  return (\n    <Card className={cn(\"relative overflow-visible\", className)} data-testid={testId}>\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-2\">\n        <div className=\"flex items-center gap-2\">\n          <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n            {title}\n          </CardTitle>\n          {tooltip && (\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button \n                  className=\"text-muted-foreground hover:text-foreground transition-colors\"\n                  data-testid={testId ? `tooltip-${testId}` : undefined}\n                >\n                  <HelpCircle className=\"h-3.5 w-3.5\" />\n                </button>\n              </TooltipTrigger>\n              <TooltipContent className=\"max-w-xs\">\n                <p className=\"text-sm\">{tooltip}</p>\n              </TooltipContent>\n            </Tooltip>\n          )}\n        </div>\n        {Icon && (\n          <div className=\"flex h-8 w-8 items-center justify-center rounded-md bg-primary/10 text-primary\">\n            <Icon className=\"h-4 w-4\" />\n          </div>\n        )}\n      </CardHeader>\n      <CardContent className=\"pt-0\">\n        <div className=\"text-2xl font-bold tracking-tight\">{value}</div>\n        {subtitle && (\n          <p className=\"text-xs text-muted-foreground mt-1\">{subtitle}</p>\n        )}\n        {trend && (\n          <div className=\"flex items-center gap-1 mt-2\">\n            {isPositiveTrend ? (\n              <TrendingUp className=\"h-3 w-3 text-chart-2\" />\n            ) : (\n              <TrendingDown className=\"h-3 w-3 text-destructive\" />\n            )}\n            <span\n              className={cn(\n                \"text-xs font-medium\",\n                isPositiveTrend ? \"text-chart-2\" : \"text-destructive\"\n              )}\n            >\n              {isPositiveTrend ? \"+\" : \"\"}\n              {trend.value}%\n            </span>\n            <span className=\"text-xs text-muted-foreground\">{trend.label}</span>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":2785,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"docs/AI_VP_Dashboard_How_To_Guide.md":{"content":"# AI VP Dashboard: Complete User Guide\n## How to Capture Hidden Revenue from Your Existing Customers\n\n---\n\n## Part 1: The Value Proposition â€” Why This Platform Matters\n\n### Who This Guide Is For\n\nThis guide is designed for:\n- **Sales Operations Leaders** who manage the overall revenue growth strategy\n- **Sales Managers** who oversee Territory Manager performance and account assignments\n- **System Administrators** who configure the platform and manage data uploads\n\nTerritory Managers receive tasks and scripts through exports and assignments â€” they don't need to learn the full system to benefit from it.\n\n### The Problem: Wallet Share Leakage\n\nEvery distributor faces the same hidden revenue drain: your best customers are buying products from your competitors that they should be buying from you.\n\nConsider this scenario: A plumbing contractor purchases $80,000 per year in pipe and fittings from your company. But they also need water heaters, PVF, tools, and safety equipment. If they're not buying those categories from you, they're buying them somewhere else. \n\n**That's wallet share leakage â€” and it's costing you real money.**\n\n### The Solution: AI-Powered Revenue Recovery\n\nThe AI VP Dashboard transforms how you identify and capture this lost revenue:\n\n1. **Automatic Gap Detection**: The system analyzes every customer's purchasing patterns and compares them against what similar contractors typically buy\n2. **Prioritized Opportunities**: Accounts are scored based on revenue potential, showing you exactly where to focus your efforts\n3. **Actionable Sales Tasks**: Territory Managers receive specific, AI-generated tasks with call scripts and email templates tailored to each opportunity\n4. **Measurable Results**: Track incremental revenue as accounts expand their purchasing to include gap categories\n\n### What Success Looks Like\n\nImagine your dashboard showing:\n- **Enrolled Accounts**: 45 accounts actively in your growth program\n- **Incremental Revenue**: $127,500 in new revenue captured this quarter\n- **Category Penetration**: Average penetration increased from 42% to 68%\n\nEach enrolled account receives carefully curated tasks that Territory Managers execute to recapture wallet share. The system tracks every dollar of incremental revenue, so you can see the direct impact of your efforts.\n\n### The Revenue Growth Cycle\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                                                                 â”‚\nâ”‚  UPLOAD DATA â†’ AI ANALYZES â†’ GAPS IDENTIFIED â†’ TASKS CREATED  â”‚\nâ”‚       â†‘                                                    â†“    â”‚\nâ”‚       â”‚                                                    â†“    â”‚\nâ”‚  TRACK REVENUE â† ACCOUNT GROWS â† TM EXECUTES TASKS â†â”€â”€â”€â”€â”€â”€â”˜    â”‚\nâ”‚                                                                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## Part 2: Getting Started â€” Initial System Setup\n\n### Step 1: Prepare Your Data Files\n\nBefore you begin, gather export files from your CRM or ERP system. The AI VP Dashboard accepts four types of CSV files:\n\n#### Accounts File\nExport your customer master list with these fields:\n- Account ID (unique identifier)\n- Account Name\n- Segment (HVAC, Plumbing, Mechanical, etc.)\n- Region or Territory\n- Assigned Territory Manager\n- Status (Active/Inactive)\n\n#### Products File\nExport your product catalog:\n- SKU or Product ID\n- Product Name\n- Category ID (links to your category taxonomy)\n- Unit Cost\n- Unit Price\n\n#### Product Categories File\nExport your category hierarchy:\n- Category ID\n- Category Name\n- Parent Category (if applicable)\n\n#### Orders File (Transaction History)\nExport 12-24 months of order history:\n- Order ID\n- Account ID\n- Order Date\n- Line Items (SKU, Quantity, Amount)\n- Total Amount\n\n**Tip**: The more historical data you provide, the more accurate the AI's analysis will be. Aim for at least 12 months of transaction history.\n\n**Template Downloads**: The Data Uploads page provides downloadable CSV templates for each file type. Use these templates to ensure your data is formatted correctly before uploading.\n\n### Step 2: Navigate to Data Uploads\n\n1. From the main dashboard, click **\"Data Uploads\"** in the left sidebar\n2. You'll see the upload interface with options for each file type\n\n### Step 3: Upload Your Files\n\nFor each file type:\n\n1. Click the **\"Upload\"** button\n2. Select the appropriate file type from the dropdown:\n   - Accounts\n   - Products\n   - Product Categories\n   - Orders\n3. Drag and drop your CSV file or click to browse\n4. The system will validate your file format\n5. Wait for the upload to complete (progress bar will show status)\n\n**Upload Order Recommendation**:\n1. Product Categories (first â€” establishes your taxonomy)\n2. Products (second â€” links to categories)\n3. Accounts (third â€” your customer base)\n4. Orders (last â€” requires accounts and products)\n\n### Step 4: Verify Upload Success\n\nAfter uploading:\n- Check the upload history table to confirm \"Completed\" status\n- Review the row count to ensure all records were imported\n- If any errors occurred, download the error report and correct your source file\n\n---\n\n## Part 3: What the System Does Automatically\n\nOnce your data is uploaded, the AI VP Dashboard begins working immediately. **Analysis typically completes within a few minutes**, and you'll see opportunity scores and gap analysis appear on your Dashboard and Accounts pages.\n\nHere's what happens behind the scenes:\n\n### Automatic Process 1: Ideal Customer Profile (ICP) Generation\n\nThe AI analyzes your Class A customers (highest revenue accounts) to understand:\n- Which product categories typically sell together\n- What spending patterns define a \"full wallet share\" customer\n- How different contractor segments (HVAC, Plumbing, etc.) behave differently\n\n**Result**: The system builds benchmark profiles for each segment, defining what complete purchasing looks like.\n\n### Automatic Process 2: Account Scoring & Gap Analysis\n\nFor every account in your system, the AI:\n1. Identifies the account's segment\n2. Compares their purchasing against the ICP benchmark\n3. Calculates which categories are missing or under-purchased\n4. Generates an **Opportunity Score** based on:\n   - Gap Size (how many categories are missing)\n   - Revenue Potential (estimated dollars at stake)\n   - Category Count (breadth of opportunity)\n\n**Result**: Each account receives a score from 0-100, with higher scores indicating larger opportunities.\n\n### Automatic Process 3: Category Penetration Metrics\n\nThe system calculates:\n- **Category Penetration %**: What percentage of expected categories does this account buy?\n- **Gap Categories**: Specific categories they should be buying but aren't\n- **Wallet Share Estimate**: Approximate percentage of their total spending you're capturing\n\n### Automatic Process 4: Task & Playbook Generation\n\nWhen you enroll an account in the growth program, the AI automatically:\n1. Generates a customized **Playbook** for that account\n2. Creates specific **Tasks** targeting their gap categories\n3. Writes **Call Scripts** with talking points tailored to the account\n4. Drafts **Email Templates** ready for Territory Managers to personalize and send\n\n---\n\n## Part 4: Using the Dashboard â€” Daily Operations\n\n### The Main Dashboard\n\nWhen you log in, the Dashboard provides an at-a-glance view of your program:\n\n#### Key Performance Indicators (KPIs)\n- **Total Accounts**: All accounts in your system\n- **Enrolled Accounts**: Accounts actively in the growth program\n- **Total Revenue**: Overall revenue across all accounts\n- **Incremental Revenue**: New revenue captured from enrolled accounts\n\n#### Daily Focus Section\nThis section highlights the most urgent tasks requiring attention today. Tasks are prioritized based on:\n- Due date\n- Account opportunity score\n- Revenue potential\n\n#### Top Opportunities Widget\nSee your highest-scoring accounts that aren't yet enrolled. These are your best prospects for the growth program.\n\n### Account Insights Page\n\nNavigate here to dive deep into individual accounts:\n\n1. **Filter & Search**: Find accounts by name, segment, region, or Territory Manager\n2. **Sort Options**: Rank accounts by opportunity score, revenue, or penetration\n3. **Account Details**: Click any account to see:\n   - Current revenue and trends\n   - Category penetration breakdown\n   - Specific gap categories\n   - Assigned Territory Manager\n   - Action history\n\n#### Enrolling an Account\n\n1. Find a high-opportunity account\n2. Click the **\"Enroll in Program\"** button\n3. Set the baseline period (typically 12 months)\n4. Configure the revenue share rate (for tracking purposes)\n5. Confirm enrollment\n\n**What happens next**: The system automatically generates a playbook with AI-crafted tasks for this account.\n\n### ICP Builder Page\n\nThis is where you review and refine the AI's analysis:\n\n#### Viewing ICP Profiles\nEach segment (HVAC, Plumbing, Mechanical, etc.) has its own profile showing:\n- Expected product categories\n- Percentage of spend typically allocated to each category\n- Minimum annual revenue threshold\n- Segment description\n\n#### Data Insights Tab\nSee the raw data behind the AI's decisions:\n- How many accounts are in each segment\n- Average spending patterns\n- Category distribution analysis\n\n#### Adjusting Profiles\nWhile the AI generates initial profiles, you can:\n- Add or remove expected categories\n- Adjust percentage allocations\n- Set category importance levels\n- Mark categories as \"required\" vs \"optional\"\n\n### Playbooks & Tasks Page\n\nThis is the action center for your sales team:\n\n#### Viewing Playbooks\n- See all generated playbooks\n- Filter by account, segment, or status\n- Track completion progress\n\n#### Working with Tasks\n\nEach task includes:\n- **Task Type**: Call, Email, or Visit\n- **Title**: Brief description of the action\n- **Script/Template**: AI-generated content to guide the conversation\n- **Status**: Pending, In Progress, Completed, or Dismissed\n- **Due Date**: When the task should be completed\n\n#### Executing a Task\n\n1. Click on any task to expand it\n2. Review the AI-generated script or email template\n3. Copy the content for use in your outreach\n4. Mark the task as completed and log the outcome\n5. The system tracks this activity for reporting\n\n#### Creating Manual Tasks\n\nSometimes you need to add tasks the AI didn't suggest:\n1. Click **\"Create Task\"**\n2. Select the account\n3. Choose task type\n4. Enter title and description\n5. Set due date\n6. Assign to a Territory Manager\n\n### Revenue Tracking Page\n\nMonitor the financial impact of your program:\n\n#### Revenue KPIs\n- **Enrolled Accounts**: Count of active program accounts\n- **Incremental Revenue**: New revenue above baseline\n- **Revenue Trend**: Month-over-month growth chart\n- **Rev-Share Fees**: Calculated fees based on incremental revenue\n\n#### Account Performance Table\nSee each enrolled account's:\n- Baseline revenue (before enrollment)\n- Current revenue\n- Incremental gain\n- Percentage growth\n\n#### Exporting Reports\nGenerate CSV exports for:\n- Executive summaries\n- Territory Manager performance\n- Account-level details\n\n---\n\n## Part 5: Settings & Configuration\n\n### General Settings\n\nConfigure your company branding:\n- Company Name\n- Application Title\n- Company Logo (upload your own)\n\n### Territory Manager Administration\n\nManage your sales team:\n1. Add new Territory Managers\n2. Assign territories/regions\n3. View task loads per TM\n4. Activate or deactivate TMs\n\n### Scoring Settings\n\nCustomize how accounts are scored:\n\nThe Opportunity Score is calculated using three weighted factors:\n- **Gap Size Weight**: Importance of category gaps (default: 40%)\n- **Revenue Potential Weight**: Importance of dollar opportunity (default: 35%)\n- **Category Count Weight**: Importance of breadth (default: 25%)\n\nAdjust these weights based on your business priorities.\n\n### Custom Categories\n\nDefine your product taxonomy:\n1. Add categories that match your ERP system\n2. Set display order\n3. Activate or deactivate categories\n4. Categories integrate with AI analysis\n\n### AI Prompt Templates\n\nAdvanced users can customize the prompts used for:\n- Call script generation\n- Email template creation\n- Account analysis\n\n---\n\n## Part 6: Best Practices for Maximum Results\n\n### Weekly Workflow\n\n**Monday**: Review Dashboard and prioritize this week's tasks\n**Tuesday-Thursday**: Territory Managers execute assigned tasks\n**Friday**: Log outcomes and review new opportunities\n\n### Monthly Workflow\n\n1. **Week 1**: Review ICP profiles and adjust if needed\n2. **Week 2**: Identify high-scoring accounts for enrollment\n3. **Week 3**: Generate new playbooks for enrolled accounts\n4. **Week 4**: Analyze revenue trends and report results\n\n### Tips for Success\n\n1. **Keep Data Fresh**: Upload new orders monthly to maintain accurate gap analysis\n2. **Review AI Suggestions**: The AI provides starting points â€” Territory Managers should personalize scripts\n3. **Track Everything**: Log task outcomes to improve future recommendations\n4. **Start Small**: Begin with 10-15 enrolled accounts, then expand as you learn the system\n5. **Trust the Scores**: High opportunity scores indicate real revenue potential â€” prioritize accordingly\n\n### Common Questions\n\n**Q: How long before I see results?**\nA: Most users see incremental revenue within 30-60 days of Territory Managers executing tasks.\n\n**Q: How often should I upload data?**\nA: Monthly order uploads keep the analysis current. Account and product changes can be uploaded as needed.\n\n**Q: Can Territory Managers access the system directly?**\nA: In the current version, Territory Managers receive tasks via exported lists or verbal assignment. Direct portal access is planned for a future release.\n\n**Q: What if the AI's analysis seems wrong?**\nA: Use the ICP Builder to adjust category expectations. The system learns from your modifications.\n\n---\n\n## Summary: Your Path to Revenue Growth\n\nThe AI VP Dashboard transforms how you capture wallet share from existing customers:\n\n1. **Upload** your CRM/ERP data (accounts, products, categories, orders)\n2. **Let the AI analyze** purchasing patterns and identify gaps\n3. **Review** the opportunity scores and ICP profiles\n4. **Enroll** high-potential accounts in the growth program\n5. **Execute** AI-generated tasks through your Territory Managers\n6. **Track** incremental revenue and celebrate your wins\n\nEvery contractor who's buying products from your competitors instead of you represents recoverable revenue. The AI VP Dashboard shows you exactly where that revenue is hiding â€” and gives your team the tools to go get it.\n\n**Start capturing your hidden revenue today.**\n","path":null,"size_bytes":14994,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, serial, numeric, boolean, timestamp, jsonb, index } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Re-export chat models for the integration\nexport * from \"./models/chat\";\n\n// Re-export auth models (users and sessions from Replit Auth)\nexport * from \"./models/auth\";\n\n// ============ TENANTS (Organizations/Customers) ============\nexport const tenants = pgTable(\"tenants\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(), // URL-friendly identifier\n  // Subscription fields\n  stripeCustomerId: text(\"stripe_customer_id\"),\n  stripeSubscriptionId: text(\"stripe_subscription_id\"),\n  subscriptionStatus: text(\"subscription_status\").default(\"none\"), // none, trialing, active, past_due, canceled, unpaid\n  planType: text(\"plan_type\").default(\"free\"), // free, starter, professional, enterprise\n  billingPeriodEnd: timestamp(\"billing_period_end\"),\n  trialEndsAt: timestamp(\"trial_ends_at\"),\n  canceledAt: timestamp(\"canceled_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertTenantSchema = createInsertSchema(tenants).omit({\n  id: true,\n  stripeCustomerId: true,\n  stripeSubscriptionId: true,\n  subscriptionStatus: true,\n  planType: true,\n  billingPeriodEnd: true,\n  trialEndsAt: true,\n  canceledAt: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertTenant = z.infer<typeof insertTenantSchema>;\nexport type Tenant = typeof tenants.$inferSelect;\n\n// Subscription status types\nexport const SUBSCRIPTION_STATUSES = ['none', 'trialing', 'active', 'past_due', 'canceled', 'unpaid'] as const;\nexport type SubscriptionStatus = typeof SUBSCRIPTION_STATUSES[number];\n\n// Plan types\nexport const PLAN_TYPES = ['free', 'starter', 'professional', 'enterprise'] as const;\nexport type PlanType = typeof PLAN_TYPES[number];\n\n// ============ USER ROLES (Permission levels per tenant) ============\n// Roles: super_admin (full access), reviewer (view + approve), viewer (read-only)\nexport const userRoles = pgTable(\"user_roles\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull(), // References users.id from Replit Auth\n  tenantId: integer(\"tenant_id\").notNull(), // References tenants.id\n  role: text(\"role\").notNull().default(\"viewer\"), // super_admin, reviewer, viewer\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_user_roles_user_id\").on(table.userId),\n  index(\"idx_user_roles_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertUserRoleSchema = createInsertSchema(userRoles).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertUserRole = z.infer<typeof insertUserRoleSchema>;\nexport type UserRole = typeof userRoles.$inferSelect;\n\n// Role permission levels\nexport const ROLE_PERMISSIONS = {\n  super_admin: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],\n  reviewer: ['read', 'approve'],\n  viewer: ['read'],\n} as const;\n\nexport type RoleType = keyof typeof ROLE_PERMISSIONS;\n\n// ============ PRODUCT CATEGORIES ============\nexport const productCategories = pgTable(\"product_categories\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  name: text(\"name\").notNull(),\n  parentId: integer(\"parent_id\"),\n}, (table) => [\n  index(\"idx_product_categories_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertProductCategorySchema = createInsertSchema(productCategories).omit({\n  id: true,\n});\n\nexport type InsertProductCategory = z.infer<typeof insertProductCategorySchema>;\nexport type ProductCategory = typeof productCategories.$inferSelect;\n\n// ============ PRODUCTS ============\nexport const products = pgTable(\"products\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  sku: text(\"sku\").notNull(),\n  name: text(\"name\"),\n  categoryId: integer(\"category_id\"),\n  unitCost: numeric(\"unit_cost\"),\n  unitPrice: numeric(\"unit_price\"),\n}, (table) => [\n  index(\"idx_products_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertProductSchema = createInsertSchema(products).omit({\n  id: true,\n});\n\nexport type InsertProduct = z.infer<typeof insertProductSchema>;\nexport type Product = typeof products.$inferSelect;\n\n// ============ ACCOUNTS ============\nexport const accounts = pgTable(\"accounts\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  externalId: text(\"external_id\"),\n  name: text(\"name\").notNull(),\n  segment: text(\"segment\"), // HVAC, plumbing, mechanical, etc.\n  region: text(\"region\"),\n  assignedTm: text(\"assigned_tm\"),\n  status: text(\"status\").default(\"active\"), // active, inactive, prospect\n  // Agent / agentic-layer columns\n  enrollmentStatus: text(\"enrollment_status\"),   // enrolled, graduated, at_risk, candidate\n  enrolledAt: timestamp(\"enrolled_at\"),\n  graduatedAt: timestamp(\"graduated_at\"),\n  walletShareDirection: text(\"wallet_share_direction\"), // growing, flat, declining\n  seasonalityProfile: jsonb(\"seasonality_profile\"),     // monthly multipliers\n  embedding: text(\"embedding\"),                         // vector for similarity search (stored as text)\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_accounts_tenant_id\").on(table.tenantId),\n  index(\"idx_accounts_segment\").on(table.segment),\n  index(\"idx_accounts_assigned_tm\").on(table.assignedTm),\n]);\n\nexport const insertAccountSchema = createInsertSchema(accounts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertAccount = z.infer<typeof insertAccountSchema>;\nexport type Account = typeof accounts.$inferSelect;\n\n// ============ ORDERS ============\nexport const orders = pgTable(\"orders\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  orderDate: timestamp(\"order_date\").notNull(),\n  totalAmount: numeric(\"total_amount\").notNull(),\n  marginAmount: numeric(\"margin_amount\"),\n}, (table) => [\n  index(\"idx_orders_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertOrderSchema = createInsertSchema(orders).omit({\n  id: true,\n});\n\nexport type InsertOrder = z.infer<typeof insertOrderSchema>;\nexport type Order = typeof orders.$inferSelect;\n\n// ============ ORDER ITEMS ============\nexport const orderItems = pgTable(\"order_items\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  orderId: integer(\"order_id\").notNull(),\n  productId: integer(\"product_id\").notNull(),\n  quantity: numeric(\"quantity\").notNull(),\n  unitPrice: numeric(\"unit_price\").notNull(),\n  lineTotal: numeric(\"line_total\").notNull(),\n}, (table) => [\n  index(\"idx_order_items_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertOrderItemSchema = createInsertSchema(orderItems).omit({\n  id: true,\n});\n\nexport type InsertOrderItem = z.infer<typeof insertOrderItemSchema>;\nexport type OrderItem = typeof orderItems.$inferSelect;\n\n// ============ SEGMENT PROFILES (ICP Definitions) ============\nexport const segmentProfiles = pgTable(\"segment_profiles\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  segment: text(\"segment\").notNull(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  minAnnualRevenue: numeric(\"min_annual_revenue\"),\n  status: text(\"status\").default(\"draft\"), // draft, approved\n  approvedBy: text(\"approved_by\"),\n  approvedAt: timestamp(\"approved_at\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_segment_profiles_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertSegmentProfileSchema = createInsertSchema(segmentProfiles).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertSegmentProfile = z.infer<typeof insertSegmentProfileSchema>;\nexport type SegmentProfile = typeof segmentProfiles.$inferSelect;\n\n// ============ PROFILE CATEGORIES ============\nexport const profileCategories = pgTable(\"profile_categories\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  profileId: integer(\"profile_id\").notNull(),\n  categoryId: integer(\"category_id\").notNull(),\n  expectedPct: numeric(\"expected_pct\"),\n  importance: numeric(\"importance\").default(\"1\"),\n  isRequired: boolean(\"is_required\").default(false),\n  notes: text(\"notes\"),\n}, (table) => [\n  index(\"idx_profile_categories_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertProfileCategorySchema = createInsertSchema(profileCategories).omit({\n  id: true,\n});\n\nexport type InsertProfileCategory = z.infer<typeof insertProfileCategorySchema>;\nexport type ProfileCategory = typeof profileCategories.$inferSelect;\n\n// ============ PROFILE REVIEW LOG ============\nexport const profileReviewLog = pgTable(\"profile_review_log\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  profileId: integer(\"profile_id\").notNull(),\n  reviewer: text(\"reviewer\").notNull(),\n  action: text(\"action\"), // created, adjusted, approved\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_profile_review_log_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertProfileReviewLogSchema = createInsertSchema(profileReviewLog).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertProfileReviewLog = z.infer<typeof insertProfileReviewLogSchema>;\nexport type ProfileReviewLog = typeof profileReviewLog.$inferSelect;\n\n// ============ ACCOUNT METRICS ============\nexport const accountMetrics = pgTable(\"account_metrics\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  computedAt: timestamp(\"computed_at\").notNull().default(sql`CURRENT_TIMESTAMP`),\n  last12mRevenue: numeric(\"last_12m_revenue\"),\n  last3mRevenue: numeric(\"last_3m_revenue\"),\n  yoyGrowthRate: numeric(\"yoy_growth_rate\"),\n  categoryCount: integer(\"category_count\"),\n  categoryPenetration: numeric(\"category_penetration\"),\n  categoryGapScore: numeric(\"category_gap_score\"),\n  opportunityScore: numeric(\"opportunity_score\"),\n  matchedProfileId: integer(\"matched_profile_id\"),\n  // Agent-layer derived metrics\n  walletSharePercentage: numeric(\"wallet_share_percentage\"), // % of contractor's total spend captured\n  daysSinceLastOrder: integer(\"days_since_last_order\"),\n}, (table) => [\n  index(\"idx_account_metrics_tenant_id\").on(table.tenantId),\n  index(\"idx_account_metrics_account_id\").on(table.accountId),\n]);\n\nexport const insertAccountMetricsSchema = createInsertSchema(accountMetrics).omit({\n  id: true,\n  computedAt: true,\n});\n\nexport type InsertAccountMetrics = z.infer<typeof insertAccountMetricsSchema>;\nexport type AccountMetrics = typeof accountMetrics.$inferSelect;\n\n// ============ ACCOUNT CATEGORY GAPS ============\nexport const accountCategoryGaps = pgTable(\"account_category_gaps\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  categoryId: integer(\"category_id\").notNull(),\n  expectedPct: numeric(\"expected_pct\"),\n  actualPct: numeric(\"actual_pct\"),\n  gapPct: numeric(\"gap_pct\"),\n  estimatedOpportunity: numeric(\"estimated_opportunity\"),\n  computedAt: timestamp(\"computed_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_account_category_gaps_tenant_id\").on(table.tenantId),\n  index(\"idx_account_category_gaps_account_id\").on(table.accountId),\n]);\n\nexport const insertAccountCategoryGapSchema = createInsertSchema(accountCategoryGaps).omit({\n  id: true,\n  computedAt: true,\n});\n\nexport type InsertAccountCategoryGap = z.infer<typeof insertAccountCategoryGapSchema>;\nexport type AccountCategoryGap = typeof accountCategoryGaps.$inferSelect;\n\n// ============ TASKS ============\nexport const tasks = pgTable(\"tasks\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  playbookId: integer(\"playbook_id\"),\n  assignedTm: text(\"assigned_tm\"),\n  assignedTmId: integer(\"assigned_tm_id\"),\n  taskType: text(\"task_type\").notNull(), // call, email, visit\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  script: text(\"script\"),\n  gapCategories: jsonb(\"gap_categories\"),\n  status: text(\"status\").default(\"pending\"), // pending, in_progress, completed, skipped\n  dueDate: timestamp(\"due_date\"),\n  completedAt: timestamp(\"completed_at\"),\n  outcome: text(\"outcome\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_tasks_tenant_id\").on(table.tenantId),\n  index(\"idx_tasks_status\").on(table.status),\n  index(\"idx_tasks_due_date\").on(table.dueDate),\n]);\n\nexport const insertTaskSchema = createInsertSchema(tasks).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  // Accept string dates from frontend and coerce to Date\n  dueDate: z.union([z.date(), z.string().transform((s) => new Date(s))]).optional(),\n});\n\nexport type InsertTask = z.infer<typeof insertTaskSchema>;\nexport type Task = typeof tasks.$inferSelect;\n\n// ============ PLAYBOOKS ============\nexport const playbooks = pgTable(\"playbooks\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  name: text(\"name\").notNull(),\n  generatedBy: text(\"generated_by\"),\n  generatedAt: timestamp(\"generated_at\").default(sql`CURRENT_TIMESTAMP`),\n  filtersUsed: jsonb(\"filters_used\"),\n  taskCount: integer(\"task_count\"),\n}, (table) => [\n  index(\"idx_playbooks_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertPlaybookSchema = createInsertSchema(playbooks).omit({\n  id: true,\n  generatedAt: true,\n});\n\nexport type InsertPlaybook = z.infer<typeof insertPlaybookSchema>;\nexport type Playbook = typeof playbooks.$inferSelect;\n\n// ============ PLAYBOOK TASKS ============\nexport const playbookTasks = pgTable(\"playbook_tasks\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  playbookId: integer(\"playbook_id\").notNull(),\n  taskId: integer(\"task_id\").notNull(),\n}, (table) => [\n  index(\"idx_playbook_tasks_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertPlaybookTaskSchema = createInsertSchema(playbookTasks).omit({\n  id: true,\n});\n\nexport type InsertPlaybookTask = z.infer<typeof insertPlaybookTaskSchema>;\nexport type PlaybookTask = typeof playbookTasks.$inferSelect;\n\n// ============ PROGRAM ACCOUNTS (Enrollment) ============\nexport const programAccounts = pgTable(\"program_accounts\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  accountId: integer(\"account_id\").notNull(),\n  enrolledAt: timestamp(\"enrolled_at\").notNull().default(sql`CURRENT_TIMESTAMP`),\n  enrolledBy: text(\"enrolled_by\"),\n  baselineStart: timestamp(\"baseline_start\").notNull(),\n  baselineEnd: timestamp(\"baseline_end\").notNull(),\n  baselineRevenue: numeric(\"baseline_revenue\").notNull(),\n  baselineCategories: jsonb(\"baseline_categories\"),\n  shareRate: numeric(\"share_rate\").notNull(),\n  status: text(\"status\").default(\"active\"), // active, paused, graduated\n  notes: text(\"notes\"),\n  // Graduation objectives\n  targetPenetration: numeric(\"target_penetration\"), // Target category penetration % (e.g., 80 for 80%)\n  targetIncrementalRevenue: numeric(\"target_incremental_revenue\"), // Target incremental revenue amount\n  targetDurationMonths: integer(\"target_duration_months\"), // Target enrollment duration in months\n  graduationCriteria: text(\"graduation_criteria\").default(\"any\"), // 'any' or 'all' - meet any objective vs all\n  graduatedAt: timestamp(\"graduated_at\"), // When account was graduated\n  graduationNotes: text(\"graduation_notes\"), // Notes about graduation/success\n  // Graduation analytics (populated at graduation time)\n  graduationRevenue: numeric(\"graduation_revenue\"), // Cumulative revenue during enrollment period\n  graduationPenetration: numeric(\"graduation_penetration\"), // Category penetration % at graduation\n  icpCategoriesAtEnrollment: integer(\"icp_categories_at_enrollment\"), // Number of ICP categories missing at enrollment\n  icpCategoriesAchieved: integer(\"icp_categories_achieved\"), // Number of ICP categories successfully filled\n  enrollmentDurationDays: integer(\"enrollment_duration_days\"), // Days from enrollment to graduation\n  incrementalRevenue: numeric(\"incremental_revenue\"), // Revenue above pro-rated baseline (graduationRevenue - proRatedBaseline)\n}, (table) => [\n  index(\"idx_program_accounts_tenant_id\").on(table.tenantId),\n  index(\"idx_program_accounts_account_id\").on(table.accountId),\n]);\n\nexport const insertProgramAccountSchema = createInsertSchema(programAccounts).omit({\n  id: true,\n  enrolledAt: true,\n});\n\nexport type InsertProgramAccount = z.infer<typeof insertProgramAccountSchema>;\nexport type ProgramAccount = typeof programAccounts.$inferSelect;\n\n// ============ PROGRAM REVENUE SNAPSHOTS ============\nexport const programRevenueSnapshots = pgTable(\"program_revenue_snapshots\", {\n  id: serial(\"id\").primaryKey(),\n  programAccountId: integer(\"program_account_id\").notNull(),\n  periodStart: timestamp(\"period_start\").notNull(),\n  periodEnd: timestamp(\"period_end\").notNull(),\n  periodRevenue: numeric(\"period_revenue\").notNull(),\n  periodCategories: jsonb(\"period_categories\"),\n  baselineComparison: numeric(\"baseline_comparison\"),\n  incrementalRevenue: numeric(\"incremental_revenue\"),\n  feeAmount: numeric(\"fee_amount\"),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n});\n\nexport const insertProgramRevenueSnapshotSchema = createInsertSchema(programRevenueSnapshots).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertProgramRevenueSnapshot = z.infer<typeof insertProgramRevenueSnapshotSchema>;\nexport type ProgramRevenueSnapshot = typeof programRevenueSnapshots.$inferSelect;\n\n// ============ DATA UPLOADS ============\nexport const dataUploads = pgTable(\"data_uploads\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  uploadType: text(\"upload_type\").notNull(), // accounts, orders, products, categories\n  fileName: text(\"file_name\").notNull(),\n  rowCount: integer(\"row_count\"),\n  status: text(\"status\").default(\"processing\"), // processing, completed, failed\n  errorMessage: text(\"error_message\"),\n  uploadedBy: text(\"uploaded_by\"),\n  uploadedAt: timestamp(\"uploaded_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_data_uploads_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertDataUploadSchema = createInsertSchema(dataUploads).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport type InsertDataUpload = z.infer<typeof insertDataUploadSchema>;\nexport type DataUpload = typeof dataUploads.$inferSelect;\n\n// ============ SETTINGS ============\nexport const settings = pgTable(\"settings\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation (null = global settings)\n  key: text(\"key\").notNull(),\n  value: text(\"value\"),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_settings_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertSettingSchema = createInsertSchema(settings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertSetting = z.infer<typeof insertSettingSchema>;\nexport type Setting = typeof settings.$inferSelect;\n\n// ============ SCORING WEIGHTS ============\nexport const scoringWeights = pgTable(\"scoring_weights\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  name: text(\"name\").notNull().default(\"default\"),\n  gapSizeWeight: numeric(\"gap_size_weight\").notNull().default(\"40\"),\n  revenuePotentialWeight: numeric(\"revenue_potential_weight\").notNull().default(\"30\"),\n  categoryCountWeight: numeric(\"category_count_weight\").notNull().default(\"30\"),\n  description: text(\"description\"),\n  isActive: boolean(\"is_active\").default(true),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n  updatedBy: text(\"updated_by\"),\n}, (table) => [\n  index(\"idx_scoring_weights_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertScoringWeightsSchema = createInsertSchema(scoringWeights).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertScoringWeights = z.infer<typeof insertScoringWeightsSchema>;\nexport type ScoringWeights = typeof scoringWeights.$inferSelect;\n\n// Default scoring weights configuration\nexport const DEFAULT_SCORING_WEIGHTS = {\n  gapSizeWeight: 40,\n  revenuePotentialWeight: 30,\n  categoryCountWeight: 30,\n};\n\n// ============ TERRITORY MANAGERS ============\nexport const territoryManagers = pgTable(\"territory_managers\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  name: text(\"name\").notNull(),\n  email: text(\"email\").notNull(),\n  territories: text(\"territories\").array(),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_territory_managers_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertTerritoryManagerSchema = createInsertSchema(territoryManagers).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertTerritoryManager = z.infer<typeof insertTerritoryManagerSchema>;\nexport type TerritoryManager = typeof territoryManagers.$inferSelect;\n\n// ============ CUSTOM CATEGORY CONFIG ============\nexport const customCategories = pgTable(\"custom_categories\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  name: text(\"name\").notNull(),\n  displayOrder: integer(\"display_order\").default(0),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_custom_categories_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertCustomCategorySchema = createInsertSchema(customCategories).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertCustomCategory = z.infer<typeof insertCustomCategorySchema>;\nexport type CustomCategory = typeof customCategories.$inferSelect;\n\n// ============ DASHBOARD LAYOUT CONFIG ============\nexport const dashboardLayouts = pgTable(\"dashboard_layouts\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\"),\n  blockOrder: jsonb(\"block_order\"),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n});\n\nexport const insertDashboardLayoutSchema = createInsertSchema(dashboardLayouts).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport type InsertDashboardLayout = z.infer<typeof insertDashboardLayoutSchema>;\nexport type DashboardLayout = typeof dashboardLayouts.$inferSelect;\n\n// ============ REV-SHARE TIERS ============\nexport const revShareTiers = pgTable(\"rev_share_tiers\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"), // Multi-tenant isolation\n  minRevenue: numeric(\"min_revenue\").notNull().default(\"0\"), // Tier starts at this revenue amount\n  maxRevenue: numeric(\"max_revenue\"), // Tier ends at this amount (null = unlimited)\n  shareRate: numeric(\"share_rate\").notNull().default(\"15\"), // Percentage rate for this tier\n  displayOrder: integer(\"display_order\").default(0),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`),\n  updatedAt: timestamp(\"updated_at\").default(sql`CURRENT_TIMESTAMP`),\n}, (table) => [\n  index(\"idx_rev_share_tiers_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertRevShareTierSchema = createInsertSchema(revShareTiers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type InsertRevShareTier = z.infer<typeof insertRevShareTierSchema>;\nexport type RevShareTier = typeof revShareTiers.$inferSelect;\n\n// ============ EMAIL SETTINGS (Stored in settings table as JSON) ============\nexport const emailSettingsSchema = z.object({\n  enabled: z.boolean().default(false),\n  fromEmail: z.string().email().default(\"notifications@yourdomain.com\"),\n  fromName: z.string().default(\"AI VP Dashboard\"),\n  notifyOnNewTask: z.boolean().default(true),\n  notifyOnHighPriority: z.boolean().default(true),\n  dailyDigest: z.boolean().default(false),\n});\n\nexport const updateEmailSettingsSchema = emailSettingsSchema.partial();\n\nexport type EmailSettings = z.infer<typeof emailSettingsSchema>;\nexport type UpdateEmailSettings = z.infer<typeof updateEmailSettingsSchema>;\n\n// ============ SUBSCRIPTION PLANS ============\nexport const subscriptionPlans = pgTable(\"subscription_plans\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  stripeMonthlyPriceId: text(\"stripe_monthly_price_id\"),\n  stripeYearlyPriceId: text(\"stripe_yearly_price_id\"),\n  monthlyPrice: numeric(\"monthly_price\").notNull(),\n  yearlyPrice: numeric(\"yearly_price\").notNull(),\n  features: jsonb(\"features\").$type<string[]>(),\n  limits: jsonb(\"limits\").$type<{ accounts?: number; users?: number;[key: string]: any }>(),\n  isActive: boolean(\"is_active\").default(true),\n  displayOrder: integer(\"display_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertSubscriptionPlanSchema = createInsertSchema(subscriptionPlans).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertSubscriptionPlan = z.infer<typeof insertSubscriptionPlanSchema>;\nexport type SubscriptionPlan = typeof subscriptionPlans.$inferSelect;\n\n// ============ SUBSCRIPTION EVENTS (Audit Trail) ============\nexport const subscriptionEvents = pgTable(\"subscription_events\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  eventType: text(\"event_type\").notNull(),\n  stripeEventId: text(\"stripe_event_id\"),\n  data: jsonb(\"data\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (table) => [\n  index(\"idx_subscription_events_tenant_id\").on(table.tenantId),\n]);\n\nexport const insertSubscriptionEventSchema = createInsertSchema(subscriptionEvents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertSubscriptionEvent = z.infer<typeof insertSubscriptionEventSchema>;\nexport type SubscriptionEvent = typeof subscriptionEvents.$inferSelect;\n\nexport const stripeWebhookEvents = pgTable(\"stripe_webhook_events\", {\n  id: serial(\"id\").primaryKey(),\n  stripeEventId: text(\"stripe_event_id\").notNull().unique(),\n  eventType: text(\"event_type\").notNull(),\n  processedAt: timestamp(\"processed_at\").defaultNow(),\n  appSlug: text(\"app_slug\"),\n  result: text(\"result\"),\n}, (table) => [\n  index(\"idx_stripe_webhook_events_event_id\").on(table.stripeEventId),\n]);\n\nexport type StripeWebhookEvent = typeof stripeWebhookEvents.$inferSelect;\n\n// ============================================================\n// PHASE 1 â€” AGENT INTELLIGENCE TABLES\n// These tables power the agentic layer: daily briefings,\n// ask-anything, email intelligence, weekly review, CRM sync.\n// ============================================================\n\n// â”€â”€ Agent System Prompts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Stores the versioned core identity prompts for the AI agent.\nexport const agentSystemPrompts = pgTable(\"agent_system_prompts\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  promptKey: text(\"prompt_key\").notNull(),       // e.g. \"core_agent_identity\"\n  content: text(\"content\").notNull(),\n  version: integer(\"version\").default(1),\n  isActive: boolean(\"is_active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [index(\"idx_agent_system_prompts_tenant\").on(t.tenantId)]);\n\nexport type AgentSystemPrompt = typeof agentSystemPrompts.$inferSelect;\n\n// â”€â”€ Agent State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Persists the agent's rolling memory between runs.\nexport const agentState = pgTable(\"agent_state\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  agentRunType: text(\"agent_run_type\").notNull(), // daily-briefing, weekly-review, etc.\n  lastRunAt: timestamp(\"last_run_at\"),\n  lastRunSummary: text(\"last_run_summary\"),\n  currentFocus: text(\"current_focus\"),\n  patternNotes: text(\"pattern_notes\"),            // Appended each run â€” rolling log\n  anomaliesWatching: jsonb(\"anomalies_watching\"), // Array of { account_name, signal, watch_until_date }\n  openQuestions: jsonb(\"open_questions\"),\n  pendingActions: jsonb(\"pending_actions\"),        // Queued follow-up actions for next run\n  lastUpdatedAt: timestamp(\"last_updated_at\"),     // Alias kept for backward compat\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [index(\"idx_agent_state_tenant_run\").on(t.tenantId, t.agentRunType)]);\n\nexport type AgentState = typeof agentState.$inferSelect;\n\n// â”€â”€ Agent Playbook Learnings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Cross-account learnings captured after playbook execution.\nexport const agentPlaybookLearnings = pgTable(\"agent_playbook_learnings\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  segment: text(\"segment\"),\n  category: text(\"category\"),\n  tactic: text(\"tactic\"),\n  learning: text(\"learning\"),\n  tradeType: text(\"trade_type\"),\n  playbookType: text(\"playbook_type\"),\n  outcome: text(\"outcome\"),\n  observations: text(\"observations\"),\n  evidenceCount: integer(\"evidence_count\").default(1),\n  sampleSize: integer(\"sample_size\").default(1),\n  successRate: numeric(\"success_rate\"),\n  dateDerived: timestamp(\"date_derived\"),\n  isActive: boolean(\"is_active\").default(true),\n  supersededById: integer(\"superseded_by_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [index(\"idx_agent_pb_learnings_tenant\").on(t.tenantId)]);\n\nexport type AgentPlaybookLearning = typeof agentPlaybookLearnings.$inferSelect;\n\n// â”€â”€ Agent Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Key people at each account (buyer, owner, AP, etc.)\nexport const agentContacts = pgTable(\"agent_contacts\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountId: integer(\"account_id\").notNull(),\n  name: text(\"name\").notNull(),\n  role: text(\"role\"),                            // owner, purchasing_mgr, ap, coo\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  isPrimary: boolean(\"is_primary\").default(false),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_agent_contacts_tenant\").on(t.tenantId),\n  index(\"idx_agent_contacts_account\").on(t.accountId),\n]);\n\nexport type AgentContact = typeof agentContacts.$inferSelect;\n\n// â”€â”€ Agent Account Category Spend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const agentAccountCategorySpend = pgTable(\"agent_account_category_spend\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountId: integer(\"account_id\").notNull(),\n  categoryId: integer(\"category_id\"),\n  currentSpend: numeric(\"current_spend\"),\n  potentialSpend: numeric(\"potential_spend\"),\n  gapPercentage: numeric(\"gap_percentage\"),\n  gapDollars: numeric(\"gap_dollars\"),\n  lastOrderDate: timestamp(\"last_order_date\"),\n  daysSinceOrder: integer(\"days_since_order\"),\n  trend: text(\"trend\"), // growing, declining, stable, new_gap\n  monthlySpendHistory: jsonb(\"monthly_spend_history\"), // [{month, spend}]\n});\nexport type AgentAccountCategorySpend = typeof agentAccountCategorySpend.$inferSelect;\n\n// â”€â”€ Agent Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const agentProjects = pgTable(\"agent_projects\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountId: integer(\"account_id\").notNull(),\n  name: text(\"name\").notNull(),\n  projectType: text(\"project_type\"),\n  status: text(\"status\"), // active, bidding, complete, inferred\n  estimatedValue: numeric(\"estimated_value\"),\n  inferredFrom: text(\"inferred_from\"),\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  expectedCategories: jsonb(\"expected_categories\"), // [{category_name, expected_spend}]\n  actualSpendToDate: numeric(\"actual_spend_to_date\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\nexport type AgentProject = typeof agentProjects.$inferSelect;\n\n// â”€â”€ Agent Competitors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const agentCompetitors = pgTable(\"agent_competitors\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  name: text(\"name\").notNull(),\n  categoriesCompetingIn: jsonb(\"categories_competing_in\"), // text array\n  winRateAgainst: numeric(\"win_rate_against\"),\n  notes: text(\"notes\"),\n});\nexport type AgentCompetitor = typeof agentCompetitors.$inferSelect;\n\n// â”€â”€ Agent Account Competitors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const agentAccountCompetitors = pgTable(\"agent_account_competitors\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountId: integer(\"account_id\").notNull(),\n  competitorId: integer(\"competitor_id\").notNull(),\n  categoriesLost: jsonb(\"categories_lost\"), // text array\n  detectedVia: text(\"detected_via\"), // email_mention, rep_note, gap_analysis\n  confidence: text(\"confidence\"), // confirmed, suspected\n  firstDetectedAt: timestamp(\"first_detected_at\").defaultNow(),\n});\nexport type AgentAccountCompetitor = typeof agentAccountCompetitors.$inferSelect;\n\n// â”€â”€ Agent Similar Account Pairs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const agentSimilarAccountPairs = pgTable(\"agent_similar_account_pairs\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountIdA: integer(\"account_id_a\").notNull(),\n  accountIdB: integer(\"account_id_b\").notNull(),\n  similarityScore: numeric(\"similarity_score\"),\n  similarityBasis: jsonb(\"similarity_basis\"), // {dimensions}\n  accountBGraduated: boolean(\"account_b_graduated\").default(false),\n  computedAt: timestamp(\"computed_at\").defaultNow(),\n});\nexport type AgentSimilarAccountPair = typeof agentSimilarAccountPairs.$inferSelect;\n\n// â”€â”€ Agent Interactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Email/call/meeting history per account (source for email intelligence).\nexport const agentInteractions = pgTable(\"agent_interactions\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountId: integer(\"account_id\").notNull(),\n  interactionType: text(\"interaction_type\").notNull(), // email, call, meeting, note\n  direction: text(\"direction\"),                        // inbound, outbound\n  subject: text(\"subject\"),\n  body: text(\"body\"),\n  repEmail: text(\"rep_email\"),\n  contactEmail: text(\"contact_email\"),\n  occurredAt: timestamp(\"occurred_at\").notNull(),\n  sentimentSignal: text(\"sentiment_signal\"),           // positive, neutral, negative, competitor_mention\n  flaggedForReview: boolean(\"flagged_for_review\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_agent_interactions_tenant\").on(t.tenantId),\n  index(\"idx_agent_interactions_account\").on(t.accountId),\n]);\n\nexport type AgentInteraction = typeof agentInteractions.$inferSelect;\n\n// â”€â”€ Agent Playbooks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// AI-generated playbook records linked to specific accounts.\nexport const agentPlaybooks = pgTable(\"agent_playbooks\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  accountId: integer(\"account_id\").notNull(),\n  repEmail: text(\"rep_email\"),\n  playbookJson: jsonb(\"playbook_json\"),               // Full structured playbook from GPT\n  focusCategories: jsonb(\"focus_categories\"),         // Which gap categories this playbook targets\n  status: text(\"status\").default(\"active\"),           // active, completed, archived\n  generatedAt: timestamp(\"generated_at\").defaultNow(),\n  completedAt: timestamp(\"completed_at\"),\n}, (t) => [\n  index(\"idx_agent_playbooks_tenant\").on(t.tenantId),\n  index(\"idx_agent_playbooks_account\").on(t.accountId),\n]);\n\nexport type AgentPlaybook = typeof agentPlaybooks.$inferSelect;\n\n// â”€â”€ Agent Rep Daily Briefings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Record of every daily briefing generated and sent to each rep.\nexport const agentRepDailyBriefings = pgTable(\"agent_rep_daily_briefings\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  repEmail: text(\"rep_email\").notNull(),\n  briefingDate: timestamp(\"briefing_date\").notNull(),\n  headlineAction: text(\"headline_action\"),\n  priorityItems: jsonb(\"priority_items\"),             // Array of { account_name, action, urgency, why }\n  atRiskAccounts: jsonb(\"at_risk_accounts\"),          // Array of { account_name, signal }\n  htmlContent: text(\"html_content\"),                  // Full HTML email sent\n  sentAt: timestamp(\"sent_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_agent_briefings_tenant\").on(t.tenantId),\n  index(\"idx_agent_briefings_rep\").on(t.repEmail),\n]);\n\nexport type AgentRepDailyBriefing = typeof agentRepDailyBriefings.$inferSelect;\n\n// â”€â”€ Agent Query Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Records every Ask Anything query and response for audit + analytics.\nexport const agentQueryLog = pgTable(\"agent_query_log\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  repEmail: text(\"rep_email\"),\n  query: text(\"query\").notNull(),\n  responseText: text(\"response_text\"),\n  accountsReferenced: jsonb(\"accounts_referenced\"),   // Array of account IDs surfaced\n  tokensUsed: integer(\"tokens_used\"),\n  latencyMs: integer(\"latency_ms\"),\n  askedAt: timestamp(\"asked_at\").defaultNow(),\n}, (t) => [index(\"idx_agent_query_log_tenant\").on(t.tenantId)]);\n\nexport type AgentQueryLog = typeof agentQueryLog.$inferSelect;\n\n// â”€â”€ Agent CRM Sync Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Events queued for push to the customer's CRM (Salesforce, HubSpot, etc.)\nexport const agentCrmSyncQueue = pgTable(\"agent_crm_sync_queue\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\"),\n  entityType: text(\"entity_type\").notNull(),          // account, task, playbook, graduation\n  entityId: integer(\"entity_id\").notNull(),\n  eventType: text(\"event_type\").notNull(),            // enrolled, graduated, task_completed, etc.\n  payload: jsonb(\"payload\"),\n  status: text(\"status\").default(\"pending\"),          // pending, synced, failed\n  attempts: integer(\"attempts\").default(0),\n  lastAttemptAt: timestamp(\"last_attempt_at\"),\n  syncedAt: timestamp(\"synced_at\"),\n  errorMessage: text(\"error_message\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_agent_crm_sync_tenant\").on(t.tenantId),\n  index(\"idx_agent_crm_sync_status\").on(t.status),\n]);\n\nexport type AgentCrmSyncQueue = typeof agentCrmSyncQueue.$inferSelect;\n\n// â”€â”€ Agent Organization Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Per-tenant configuration for the agentic layer.\nexport const agentOrganizationSettings = pgTable(\"agent_organization_settings\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").unique(),\n  activeRepEmails: jsonb(\"active_rep_emails\"),        // Which TM emails get daily briefings\n  briefingEnabled: boolean(\"briefing_enabled\").default(true),\n  briefingTime: text(\"briefing_time\").default(\"07:00\"), // HH:MM local time\n  emailIntelligenceEnabled: boolean(\"email_intelligence_enabled\").default(true),\n  crmSyncEnabled: boolean(\"crm_sync_enabled\").default(false),\n  crmProvider: text(\"crm_provider\"),                 // salesforce, hubspot, none\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [index(\"idx_agent_org_settings_tenant\").on(t.tenantId)]);\n\nexport type AgentOrganizationSettings = typeof agentOrganizationSettings.$inferSelect;\n\n// ============ EMAIL OAUTH CONNECTIONS ============\nexport const emailConnections = pgTable(\"email_connections\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  userId: text(\"user_id\").notNull(),\n  provider: text(\"provider\").notNull(), // microsoft, google\n  emailAddress: text(\"email_address\").notNull(),\n  accessToken: text(\"access_token\").notNull(),\n  refreshToken: text(\"refresh_token\"),\n  tokenExpiresAt: timestamp(\"token_expires_at\"),\n  status: text(\"status\").default(\"connected\"), // connected, expired, disconnected, error\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  syncError: text(\"sync_error\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_email_connections_tenant\").on(t.tenantId),\n  index(\"idx_email_connections_user\").on(t.userId),\n]);\n\nexport const insertEmailConnectionSchema = createInsertSchema(emailConnections).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type EmailConnection = typeof emailConnections.$inferSelect;\nexport type InsertEmailConnection = z.infer<typeof insertEmailConnectionSchema>;\n\n// ============ SYNCED EMAILS ============\nexport const syncedEmails = pgTable(\"synced_emails\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  connectionId: integer(\"connection_id\").notNull(),\n  externalId: text(\"external_id\").notNull(), // Message ID from provider\n  fromAddress: text(\"from_address\"),\n  fromName: text(\"from_name\"),\n  toAddresses: jsonb(\"to_addresses\"), // Array of { email, name }\n  ccAddresses: jsonb(\"cc_addresses\"),\n  subject: text(\"subject\"),\n  bodyPreview: text(\"body_preview\"), // First ~200 chars\n  bodyText: text(\"body_text\"), // Plain text body\n  receivedAt: timestamp(\"received_at\"),\n  direction: text(\"direction\").default(\"inbound\"), // inbound, outbound\n  linkedAccountId: integer(\"linked_account_id\"), // Linked to an account if matched\n  aiAnalyzed: boolean(\"ai_analyzed\").default(false),\n  aiSentiment: text(\"ai_sentiment\"), // positive, neutral, negative, urgent\n  aiSummary: text(\"ai_summary\"),\n  aiActionItems: jsonb(\"ai_action_items\"), // Array of { action, priority, category }\n  aiOpportunitySignals: jsonb(\"ai_opportunity_signals\"), // Array of { signal, confidence, category }\n  aiAccountMentions: jsonb(\"ai_account_mentions\"), // Array of account names detected\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_synced_emails_tenant\").on(t.tenantId),\n  index(\"idx_synced_emails_connection\").on(t.connectionId),\n  index(\"idx_synced_emails_account\").on(t.linkedAccountId),\n  index(\"idx_synced_emails_received\").on(t.receivedAt),\n  index(\"idx_synced_emails_external\").on(t.externalId),\n]);\n\nexport const insertSyncedEmailSchema = createInsertSchema(syncedEmails).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type SyncedEmail = typeof syncedEmails.$inferSelect;\nexport type InsertSyncedEmail = z.infer<typeof insertSyncedEmailSchema>;\n\n// ============ CRM: CONTACTS ============\nexport const contacts = pgTable(\"contacts\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  accountId: integer(\"account_id\"),\n  firstName: text(\"first_name\").notNull(),\n  lastName: text(\"last_name\"),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  title: text(\"title\"),\n  role: text(\"role\"), // purchaser, project_manager, estimator, owner, decision_maker, influencer, gatekeeper\n  department: text(\"department\"),\n  isPrimary: boolean(\"is_primary\").default(false),\n  lastContactedAt: timestamp(\"last_contacted_at\"),\n  notes: text(\"notes\"),\n  source: text(\"source\").default(\"email_sync\"), // email_sync, manual, csv_import\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_contacts_tenant\").on(t.tenantId),\n  index(\"idx_contacts_account\").on(t.accountId),\n  index(\"idx_contacts_email\").on(t.email),\n]);\n\nexport const insertContactSchema = createInsertSchema(contacts).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Contact = typeof contacts.$inferSelect;\nexport type InsertContact = z.infer<typeof insertContactSchema>;\n\n// ============ CRM: PROJECTS ============\nexport const projects = pgTable(\"projects\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  accountId: integer(\"account_id\"),\n  name: text(\"name\").notNull(),\n  location: text(\"location\"),\n  projectType: text(\"project_type\"), // new_construction, renovation, retrofit, maintenance, tenant_improvement\n  estimatedValue: numeric(\"estimated_value\"),\n  stage: text(\"stage\").default(\"identified\"), // identified, bidding, awarded, in_progress, completed, lost\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  bidDeadline: timestamp(\"bid_deadline\"),\n  generalContractor: text(\"general_contractor\"),\n  unitCount: integer(\"unit_count\"),\n  squareFootage: integer(\"square_footage\"),\n  productCategories: jsonb(\"product_categories\"), // Array of category names relevant to this project\n  competitorsInvolved: jsonb(\"competitors_involved\"), // Array of competitor names bidding\n  notes: text(\"notes\"),\n  source: text(\"source\").default(\"email_sync\"), // email_sync, manual\n  sourceEmailId: integer(\"source_email_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_projects_tenant\").on(t.tenantId),\n  index(\"idx_projects_account\").on(t.accountId),\n  index(\"idx_projects_stage\").on(t.stage),\n]);\n\nexport const insertProjectSchema = createInsertSchema(projects).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Project = typeof projects.$inferSelect;\nexport type InsertProject = z.infer<typeof insertProjectSchema>;\n\n// ============ CRM: EMAIL INTERACTIONS ============\nexport const emailInteractions = pgTable(\"email_interactions\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  emailId: integer(\"email_id\").notNull(),\n  contactId: integer(\"contact_id\").notNull(),\n  role: text(\"role\").default(\"participant\"), // sender, recipient, cc, participant\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_email_interactions_tenant\").on(t.tenantId),\n  index(\"idx_email_interactions_email\").on(t.emailId),\n  index(\"idx_email_interactions_contact\").on(t.contactId),\n]);\n\nexport const insertEmailInteractionSchema = createInsertSchema(emailInteractions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type EmailInteraction = typeof emailInteractions.$inferSelect;\nexport type InsertEmailInteraction = z.infer<typeof insertEmailInteractionSchema>;\n\n// ============ CRM: ORDER SIGNALS ============\nexport const orderSignals = pgTable(\"order_signals\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  accountId: integer(\"account_id\"),\n  projectId: integer(\"project_id\"),\n  sourceEmailId: integer(\"source_email_id\"),\n  signalType: text(\"signal_type\").notNull(), // quote_request, reorder, pricing_inquiry, product_inquiry, purchase_intent, delivery_request\n  productCategory: text(\"product_category\"),\n  productDetails: text(\"product_details\"),\n  estimatedQuantity: text(\"estimated_quantity\"),\n  estimatedValue: numeric(\"estimated_value\"),\n  requestedDeliveryDate: timestamp(\"requested_delivery_date\"),\n  urgency: text(\"urgency\").default(\"normal\"), // immediate, this_week, this_month, next_quarter, exploring\n  pricingMentioned: boolean(\"pricing_mentioned\").default(false),\n  competitorPriceMentioned: boolean(\"competitor_price_mentioned\").default(false),\n  notes: text(\"notes\"),\n  status: text(\"status\").default(\"new\"), // new, contacted, quoted, won, lost\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_order_signals_tenant\").on(t.tenantId),\n  index(\"idx_order_signals_account\").on(t.accountId),\n  index(\"idx_order_signals_project\").on(t.projectId),\n  index(\"idx_order_signals_type\").on(t.signalType),\n]);\n\nexport const insertOrderSignalSchema = createInsertSchema(orderSignals).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type OrderSignal = typeof orderSignals.$inferSelect;\nexport type InsertOrderSignal = z.infer<typeof insertOrderSignalSchema>;\n\n// ============ CRM: COMPETITOR MENTIONS ============\nexport const competitorMentions = pgTable(\"competitor_mentions\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  accountId: integer(\"account_id\"),\n  projectId: integer(\"project_id\"),\n  sourceEmailId: integer(\"source_email_id\"),\n  competitorName: text(\"competitor_name\").notNull(),\n  mentionType: text(\"mention_type\").notNull(), // quote, pricing, product_comparison, switch_threat, positive_mention, negative_mention\n  productCategory: text(\"product_category\"),\n  competitorPrice: text(\"competitor_price\"),\n  ourPrice: text(\"our_price\"),\n  details: text(\"details\"),\n  threatLevel: text(\"threat_level\").default(\"medium\"), // low, medium, high, critical\n  responseNeeded: boolean(\"response_needed\").default(false),\n  respondedAt: timestamp(\"responded_at\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n}, (t) => [\n  index(\"idx_competitor_mentions_tenant\").on(t.tenantId),\n  index(\"idx_competitor_mentions_account\").on(t.accountId),\n  index(\"idx_competitor_mentions_competitor\").on(t.competitorName),\n  index(\"idx_competitor_mentions_threat\").on(t.threatLevel),\n]);\n\nexport const insertCompetitorMentionSchema = createInsertSchema(competitorMentions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type CompetitorMention = typeof competitorMentions.$inferSelect;\nexport type InsertCompetitorMention = z.infer<typeof insertCompetitorMentionSchema>;\n","path":null,"size_bytes":50755,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { startScheduler, stopScheduler } from \"./scheduler\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  // â”€â”€ Scheduler (agent cron jobs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const schedulerTenantId = parseInt(process.env.SCHEDULER_TENANT_ID ?? \"8\", 10);\n  startScheduler(schedulerTenantId);\n\n  // â”€â”€ Graceful shutdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n  const gracefulShutdown = (signal: string) => {\n    log(`Received ${signal} â€” closing server.`);\n    stopScheduler();\n    httpServer.close(() => {\n      log(\"HTTP server closed.\");\n      process.exit(0);\n    });\n  };\n  process.once(\"SIGTERM\", () => gracefulShutdown(\"SIGTERM\"));\n  process.once(\"SIGINT\", () => gracefulShutdown(\"SIGINT\"));\n\n  app.use((err: any, _req: Request, res: Response, next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    console.error(\"Internal Server Error:\", err);\n\n    if (res.headersSent) {\n      return next(err);\n    }\n\n    return res.status(status).json({ message });\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":3556,"size_tokens":null},"saas-setup.md":{"content":"# SaaS Subscription System Setup Guide\n\n## Executive Summary\n\nThis document outlines the complete implementation plan for transforming the AI VP Dashboard into a production-ready SaaS subscription application with multi-tenant deployments. The system will use Stripe for payment processing, subscription management, and billing.\n\n---\n\n## Current State Analysis\n\n### What's Already in Place âœ…\n\n1. **Multi-Tenant Architecture**\n   - `tenants` table exists with `id`, `name`, `slug`, timestamps\n   - `user_roles` table links users to tenants with role-based permissions\n   - `tenantId` column present on most data tables (accounts, orders, products, tasks, playbooks, settings, etc.)\n   - Note: Some derived/computed tables (`accountMetrics`, `accountCategoryGaps`) use `accountId` joins rather than direct `tenantId` - tenant isolation is achieved via the parent account relationship\n   - `TenantStorage` class in `server/storage/tenantStorage.ts` scopes queries to the current tenant\n   - `withTenantContext` middleware in `server/middleware/tenantContext.ts` establishes tenant context per request\n   - Automatic tenant creation on first user login\n\n2. **Authentication**\n   - Replit Auth integration for user login/signup\n   - Session management configured\n   - User context available in requests\n\n3. **Infrastructure**\n   - PostgreSQL database (Neon-backed)\n   - Express backend with organized routes\n   - React frontend with Tanstack Query\n   - Stripe package already in build dependencies\n\n### What's Missing âŒ\n\n1. **Stripe Integration**\n   - No Stripe API keys configured\n   - No checkout session creation\n   - No webhook handlers\n   - No billing portal integration\n\n2. **Subscription Data Model**\n   - No subscription fields on tenants table\n   - No subscription plans table\n   - No subscription status tracking\n\n3. **Subscription UI**\n   - No `/subscription` page for managing billing\n   - No pricing/checkout flow from landing page\n   - No subscription status display in dashboard\n\n---\n\n## Implementation Plan\n\n### Phase 1: Database Schema Updates\n\n#### 1.1 Extend Tenants Table\n\nAdd subscription-related fields to track each tenant's billing state. Following repo conventions, update `shared/schema.ts` with Drizzle schema changes:\n\n```typescript\n// In shared/schema.ts - update tenants table definition\nexport const tenants = pgTable(\"tenants\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  slug: text(\"slug\").notNull().unique(),\n  // Subscription fields\n  stripeCustomerId: text(\"stripe_customer_id\"),\n  stripeSubscriptionId: text(\"stripe_subscription_id\"),\n  subscriptionStatus: text(\"subscription_status\").default(\"none\"), // none, trialing, active, past_due, canceled, unpaid\n  planType: text(\"plan_type\").default(\"free\"), // free, starter, professional, enterprise\n  billingPeriodEnd: timestamp(\"billing_period_end\"),\n  trialEndsAt: timestamp(\"trial_ends_at\"),\n  canceledAt: timestamp(\"canceled_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n```\n\nRun `npm run db:push` to apply schema changes via Drizzle.\n\n#### 1.2 Create Subscription Plans Table\n\nAdd to `shared/schema.ts`. Note: Plans are global (not tenant-scoped) but need both monthly and yearly Stripe Price IDs:\n\n```typescript\n// In shared/schema.ts\nexport const subscriptionPlans = pgTable(\"subscription_plans\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),                      // \"Starter\", \"Professional\", \"Enterprise\"\n  slug: text(\"slug\").notNull().unique(),             // \"starter\", \"professional\", \"enterprise\"\n  stripeMonthlyPriceId: text(\"stripe_monthly_price_id\"), // Stripe Price ID for monthly billing\n  stripeYearlyPriceId: text(\"stripe_yearly_price_id\"),   // Stripe Price ID for annual billing\n  monthlyPrice: numeric(\"monthly_price\").notNull(),  // Display price (e.g., 49.00)\n  yearlyPrice: numeric(\"yearly_price\").notNull(),    // Annual price (e.g., 490.00)\n  features: jsonb(\"features\"),                       // [\"100 accounts\", \"3 users\", ...]\n  limits: jsonb(\"limits\"),                           // { accounts: 100, users: 3, ... }\n  isActive: boolean(\"is_active\").default(true),\n  displayOrder: integer(\"display_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertSubscriptionPlanSchema = createInsertSchema(subscriptionPlans).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertSubscriptionPlan = z.infer<typeof insertSubscriptionPlanSchema>;\nexport type SubscriptionPlan = typeof subscriptionPlans.$inferSelect;\n```\n\n#### 1.3 Create Subscription Events Log (Audit Trail)\n\n```typescript\nexport const subscriptionEvents = pgTable(\"subscription_events\", {\n  id: serial(\"id\").primaryKey(),\n  tenantId: integer(\"tenant_id\").notNull(),\n  eventType: text(\"event_type\").notNull(),\n  stripeEventId: text(\"stripe_event_id\"),\n  data: jsonb(\"data\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n```\n\n---\n\n### Phase 2: Stripe Integration\n\n#### 2.1 Stripe Configuration\n\n1. **Set up Stripe Connector** via Replit integrations for secure API key management\n2. Required environment variables:\n   - `STRIPE_SECRET_KEY` - Backend API key\n   - `STRIPE_PUBLISHABLE_KEY` - Frontend key (public)\n   - `STRIPE_WEBHOOK_SECRET` - Webhook signature verification\n\n#### 2.2 Stripe Products & Prices Setup\n\nCreate the following in Stripe Dashboard:\n\n| Product | Monthly Price | Annual Price | Price ID Pattern |\n|---------|---------------|--------------|------------------|\n| Starter | $49/mo | $490/yr | price_starter_monthly, price_starter_yearly |\n| Professional | $149/mo | $1,490/yr | price_professional_monthly, price_professional_yearly |\n| Enterprise | $499/mo | $4,990/yr | price_enterprise_monthly, price_enterprise_yearly |\n\n#### 2.3 API Endpoints\n\n| Endpoint | Method | Purpose |\n|----------|--------|---------|\n| `/api/stripe/create-checkout-session` | POST | Initiate checkout for new subscription |\n| `/api/stripe/create-portal-session` | POST | Redirect to Stripe billing portal |\n| `/api/stripe/webhook` | POST | Handle Stripe webhook events |\n| `/api/subscription` | GET | Get current subscription status |\n| `/api/subscription/plans` | GET | Get available plans |\n\n---\n\n### Phase 3: Backend Implementation\n\n#### 3.1 Checkout Session Creation\n\n```typescript\n// POST /api/stripe/create-checkout-session\napp.post(\"/api/stripe/create-checkout-session\", isAuthenticated, withTenantContext, async (req, res) => {\n  const { priceId, billingCycle } = req.body;\n  const tenant = req.tenantContext.tenant;\n  \n  // Get or create Stripe customer\n  let customerId = tenant.stripeCustomerId;\n  if (!customerId) {\n    const customer = await stripe.customers.create({\n      email: req.user.claims.email,\n      metadata: { tenantId: tenant.id.toString() }\n    });\n    customerId = customer.id;\n    // Save to database\n  }\n  \n  const session = await stripe.checkout.sessions.create({\n    customer: customerId,\n    mode: 'subscription',\n    line_items: [{ price: priceId, quantity: 1 }],\n    success_url: `${process.env.APP_URL}/subscription?success=true`,\n    cancel_url: `${process.env.APP_URL}/subscription?canceled=true`,\n    metadata: { tenantId: tenant.id.toString() }\n  });\n  \n  res.json({ url: session.url });\n});\n```\n\n#### 3.2 Webhook Handler\n\nHandle these Stripe events:\n\n| Event | Action |\n|-------|--------|\n| `checkout.session.completed` | Create subscription record, update tenant |\n| `customer.subscription.created` | Set subscription as active |\n| `customer.subscription.updated` | Sync status, plan changes |\n| `customer.subscription.deleted` | Mark as canceled |\n| `invoice.paid` | Update billing period end |\n| `invoice.payment_failed` | Mark as past_due, send notification |\n\n```typescript\n// Add to server/routes.ts - webhook must use raw body for signature verification\napp.post(\"/api/stripe/webhook\", express.raw({ type: 'application/json' }), async (req, res) => {\n  const sig = req.headers['stripe-signature'] as string;\n  let event: Stripe.Event;\n  \n  try {\n    event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET!);\n  } catch (err: any) {\n    console.error('Webhook signature verification failed:', err.message);\n    return res.status(400).send(`Webhook Error: ${err.message}`);\n  }\n  \n  // Extract tenantId from metadata or customer lookup\n  const getTenantIdFromEvent = async (eventData: any): Promise<number | null> => {\n    // First try metadata\n    if (eventData.metadata?.tenantId) {\n      return parseInt(eventData.metadata.tenantId);\n    }\n    // Fallback: lookup by Stripe customer ID\n    if (eventData.customer) {\n      const tenant = await db.select().from(tenants)\n        .where(eq(tenants.stripeCustomerId, eventData.customer))\n        .limit(1);\n      return tenant[0]?.id || null;\n    }\n    return null;\n  };\n  \n  switch (event.type) {\n    case 'checkout.session.completed':\n      // Initial subscription creation after checkout\n      const session = event.data.object as Stripe.Checkout.Session;\n      const tenantId = session.metadata?.tenantId ? parseInt(session.metadata.tenantId) : null;\n      if (tenantId && session.subscription) {\n        await db.update(tenants)\n          .set({\n            stripeSubscriptionId: session.subscription as string,\n            subscriptionStatus: 'active',\n          })\n          .where(eq(tenants.id, tenantId));\n      }\n      break;\n      \n    case 'customer.subscription.created':\n    case 'customer.subscription.updated':\n      await handleSubscriptionChange(event.data.object as Stripe.Subscription);\n      break;\n      \n    case 'customer.subscription.deleted':\n      await handleSubscriptionCanceled(event.data.object as Stripe.Subscription);\n      break;\n      \n    case 'invoice.paid':\n      await handleInvoicePaid(event.data.object as Stripe.Invoice);\n      break;\n      \n    case 'invoice.payment_failed':\n      await handlePaymentFailed(event.data.object as Stripe.Invoice);\n      break;\n  }\n  \n  // Log event for audit trail\n  await db.insert(subscriptionEvents).values({\n    tenantId: await getTenantIdFromEvent(event.data.object) || 0,\n    eventType: event.type,\n    stripeEventId: event.id,\n    data: event.data.object,\n  });\n  \n  res.json({ received: true });\n});\n```\n\n#### 3.3 Billing Portal Integration\n\n```typescript\n// POST /api/stripe/create-portal-session\napp.post(\"/api/stripe/create-portal-session\", isAuthenticated, withTenantContext, async (req, res) => {\n  const tenant = req.tenantContext.tenant;\n  \n  if (!tenant.stripeCustomerId) {\n    return res.status(400).json({ error: \"No billing account found\" });\n  }\n  \n  const session = await stripe.billingPortal.sessions.create({\n    customer: tenant.stripeCustomerId,\n    return_url: `${process.env.APP_URL}/subscription`\n  });\n  \n  res.json({ url: session.url });\n});\n```\n\n---\n\n### Phase 4: Subscription Middleware\n\n#### 4.1 Subscription Status Check\n\n```typescript\nexport const requireActiveSubscription: RequestHandler = async (req, res, next) => {\n  const tenant = req.tenantContext?.tenant;\n  \n  if (!tenant) {\n    return res.status(401).json({ message: \"Not authenticated\" });\n  }\n  \n  const activeStatuses = ['active', 'trialing'];\n  if (!activeStatuses.includes(tenant.subscriptionStatus)) {\n    return res.status(402).json({ \n      message: \"Subscription required\",\n      subscriptionStatus: tenant.subscriptionStatus\n    });\n  }\n  \n  next();\n};\n```\n\n#### 4.2 Feature Gating by Plan\n\n```typescript\nexport const requirePlan = (minPlan: 'starter' | 'professional' | 'enterprise'): RequestHandler => {\n  const planHierarchy = { starter: 1, professional: 2, enterprise: 3 };\n  \n  return (req, res, next) => {\n    const tenant = req.tenantContext?.tenant;\n    const currentPlanLevel = planHierarchy[tenant?.planType] || 0;\n    const requiredLevel = planHierarchy[minPlan];\n    \n    if (currentPlanLevel < requiredLevel) {\n      return res.status(403).json({\n        message: `${minPlan} plan or higher required`,\n        currentPlan: tenant?.planType,\n        requiredPlan: minPlan\n      });\n    }\n    \n    next();\n  };\n};\n```\n\n---\n\n### Phase 5: Frontend Implementation\n\n#### 5.1 Subscription Page (`/subscription`)\n\nFeatures:\n- Display current plan and status\n- Show billing period and next invoice date\n- Upgrade/downgrade buttons\n- \"Manage Billing\" button (opens Stripe Portal)\n- Invoice history\n- Cancel subscription option\n\n#### 5.2 Landing Page Checkout Flow\n\nUpdate the landing page signup form:\n1. User selects a plan\n2. User enters email and name\n3. \"Start Free Trial\" or \"Subscribe Now\" button\n4. Redirects to Stripe Checkout\n5. On success, redirects to onboarding\n\n#### 5.3 Subscription Status Hook\n\n```typescript\nexport function useSubscription() {\n  return useQuery({\n    queryKey: ['/api/subscription'],\n    enabled: isAuthenticated,\n  });\n}\n```\n\n---\n\n### Phase 6: Plan Features & Limits\n\n#### 6.1 Starter Plan ($49/mo)\n- Up to 100 accounts\n- Up to 3 users\n- Basic ICP profiles\n- Standard playbooks\n- Email support\n\n#### 6.2 Professional Plan ($149/mo)\n- Up to 500 accounts\n- Up to 10 users\n- Advanced ICP with AI insights\n- Custom playbooks\n- Priority email support\n- API access\n\n#### 6.3 Enterprise Plan ($499/mo)\n- Unlimited accounts\n- Unlimited users\n- Custom AI training\n- White-label options\n- Dedicated support\n- SSO integration\n- Custom integrations\n\n---\n\n## Security Considerations\n\n1. **Webhook Verification**: Always verify Stripe webhook signatures\n2. **Customer ID Mapping**: Store Stripe customer IDs securely, never expose to frontend\n3. **Subscription Status**: Check on every protected request, cache briefly\n4. **PCI Compliance**: Never handle raw card data - use Stripe Checkout/Elements\n5. **Audit Trail**: Log all subscription events for compliance\n\n---\n\n## Testing Checklist\n\n### Stripe Test Mode\n- [ ] Create test products and prices in Stripe Dashboard\n- [ ] Configure test webhook endpoint\n- [ ] Test checkout flow with test cards\n- [ ] Test subscription lifecycle (create, update, cancel)\n- [ ] Test payment failures with specific test cards\n- [ ] Test portal functionality\n\n### Integration Testing\n- [ ] New user signup â†’ checkout â†’ subscription active\n- [ ] Existing user login â†’ subscription status displayed\n- [ ] Plan upgrade/downgrade flow\n- [ ] Cancel and resubscribe flow\n- [ ] Expired card handling\n- [ ] Webhook retry handling\n\n---\n\n## Production Deployment Checklist\n\n1. **Stripe Configuration**\n   - [ ] Switch to live API keys\n   - [ ] Create production products/prices\n   - [ ] Configure production webhook endpoint\n   - [ ] Enable fraud prevention settings\n\n2. **Database**\n   - [ ] Run schema migrations\n   - [ ] Seed production plans\n\n3. **Environment Variables**\n   - [ ] `STRIPE_SECRET_KEY` (live)\n   - [ ] `STRIPE_PUBLISHABLE_KEY` (live)\n   - [ ] `STRIPE_WEBHOOK_SECRET` (production webhook)\n   - [ ] `APP_URL` (production domain)\n\n4. **Monitoring**\n   - [ ] Set up webhook failure alerts\n   - [ ] Monitor subscription churn\n   - [ ] Track failed payments\n\n---\n\n## File Structure\n\nFollowing the existing repo conventions (single routes.ts, storage.ts pattern):\n\n```\nserver/\nâ”œâ”€â”€ middleware/\nâ”‚   â”œâ”€â”€ tenantContext.ts        # Existing - multi-tenant context\nâ”‚   â””â”€â”€ subscription.ts         # NEW - requireActiveSubscription, requirePlan middleware\nâ”œâ”€â”€ routes.ts                   # MODIFY - add Stripe endpoints inline (checkout, webhook, portal)\nâ”œâ”€â”€ storage.ts                  # MODIFY - add IStorage methods for subscription operations\nâ”œâ”€â”€ storage/\nâ”‚   â””â”€â”€ tenantStorage.ts        # MODIFY - add subscription update methods\n\nclient/src/\nâ”œâ”€â”€ pages/\nâ”‚   â”œâ”€â”€ subscription.tsx        # NEW - billing management page\nâ”‚   â””â”€â”€ landing.tsx             # MODIFY - update signup to initiate checkout\nâ”œâ”€â”€ components/\nâ”‚   â”œâ”€â”€ pricing-card.tsx        # NEW - plan selection card component\nâ”‚   â””â”€â”€ app-sidebar.tsx         # MODIFY - add subscription link\nâ””â”€â”€ hooks/\n    â””â”€â”€ use-subscription.ts     # NEW - subscription state hook\n\nshared/\nâ””â”€â”€ schema.ts                   # MODIFY - add subscription fields to tenants, add subscriptionPlans & subscriptionEvents tables\n```\n\n---\n\n## Implementation Order\n\n1. âœ… Create this documentation\n2. Set up Stripe connector integration\n3. Update database schema with subscription fields\n4. Create subscription plans table and seed data\n5. Build Stripe checkout endpoint\n6. Implement webhook handler\n7. Create checkout success/cancel pages\n8. Build subscription management page\n9. Add billing portal integration\n10. Add subscription middleware\n11. Update landing page with checkout flow\n12. Add subscription link to sidebar\n\n---\n\n## Revenue Projections\n\nBased on the fee-for-success model shown on the landing page, the SaaS subscription model offers predictable recurring revenue:\n\n| Plan | Monthly | Annual MRR Equivalent |\n|------|---------|----------------------|\n| 100 Starter | $4,900 | $4,900 |\n| 50 Professional | $7,450 | $7,450 |\n| 10 Enterprise | $4,990 | $4,990 |\n| **Total MRR** | **$17,340** | **$208,080/yr** |\n\nThis provides a foundation for scaling while the fee-for-success model can be offered as an Enterprise add-on for high-value accounts.\n","path":null,"size_bytes":17209,"size_tokens":null},"server/replit_integrations/image/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { openai } from \"./client\";\n\nexport function registerImageRoutes(app: Express): void {\n  app.post(\"/api/generate-image\", async (req: Request, res: Response) => {\n    try {\n      const { prompt, size = \"1024x1024\" } = req.body;\n\n      if (!prompt) {\n        return res.status(400).json({ error: \"Prompt is required\" });\n      }\n\n      const response = await openai.images.generate({\n        model: \"gpt-image-1\",\n        prompt,\n        n: 1,\n        size: size as \"1024x1024\" | \"512x512\" | \"256x256\",\n      });\n\n      const imageData = response.data[0];\n      res.json({\n        url: imageData.url,\n        b64_json: imageData.b64_json,\n      });\n    } catch (error) {\n      console.error(\"Error generating image:\", error);\n      res.status(500).json({ error: \"Failed to generate image\" });\n    }\n  });\n}\n\n","path":null,"size_bytes":872,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"server/utils/stripeConfig.ts":{"content":"import Stripe from \"stripe\";\n\nexport interface StripeConfig {\n  stripe: Stripe | null;\n  priceIds: string[];\n  appSlug: string;\n  baseUrl: string;\n  isTestMode: boolean;\n  isConfigured: boolean;\n}\n\nlet stripeInstance: Stripe | null = null;\nlet priceIds: string[] = [];\nlet appSlug: string = \"\";\nlet baseUrl: string = \"\";\n\nexport function initializeStripeConfig(): StripeConfig {\n  const secretKey = process.env.STRIPE_SECRET_KEY;\n  \n  if (!secretKey) {\n    console.warn(\"Warning: STRIPE_SECRET_KEY not configured - Stripe features will be unavailable\");\n    return {\n      stripe: null,\n      priceIds: [],\n      appSlug: \"\",\n      baseUrl: \"\",\n      isTestMode: true,\n      isConfigured: false,\n    };\n  }\n  \n  stripeInstance = new Stripe(secretKey, { apiVersion: \"2025-12-15.clover\" });\n  \n  const priceIdsEnv = process.env.STRIPE_PRICE_IDS || \"\";\n  priceIds = priceIdsEnv\n    .split(\",\")\n    .map(id => id.trim())\n    .filter(id => id.length > 0);\n  \n  appSlug = process.env.APP_SLUG || \"ai-revenue-engineer\";\n  \n  baseUrl = process.env.BASE_URL \n    || (process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : null)\n    || (process.env.REPLIT_DOMAINS ? `https://${process.env.REPLIT_DOMAINS.split(',')[0]}` : null)\n    || \"http://localhost:5000\";\n  \n  const isTestMode = secretKey.startsWith(\"sk_test_\");\n  \n  console.log(`Stripe initialized: ${isTestMode ? \"TEST\" : \"LIVE\"} mode`);\n  console.log(`App slug: ${appSlug}`);\n  console.log(`Base URL: ${baseUrl}`);\n  console.log(`Whitelisted price IDs: ${priceIds.length > 0 ? priceIds.join(\", \") : \"(none - all prices allowed)\"}`);\n  \n  return {\n    stripe: stripeInstance,\n    priceIds,\n    appSlug,\n    baseUrl,\n    isTestMode,\n    isConfigured: true,\n  };\n}\n\nexport function getStripeConfig(): StripeConfig {\n  if (!stripeInstance && process.env.STRIPE_SECRET_KEY) {\n    return initializeStripeConfig();\n  }\n  \n  return {\n    stripe: stripeInstance,\n    priceIds,\n    appSlug,\n    baseUrl,\n    isTestMode: process.env.STRIPE_SECRET_KEY?.startsWith(\"sk_test_\") ?? true,\n    isConfigured: !!stripeInstance,\n  };\n}\n\nexport function isPriceIdWhitelisted(priceId: string): boolean {\n  const config = getStripeConfig();\n  if (config.priceIds.length === 0) {\n    return true;\n  }\n  return config.priceIds.includes(priceId);\n}\n\nexport function getStripeDebugInfo(): {\n  mode: string;\n  isConfigured: boolean;\n  appSlug: string;\n  baseUrl: string;\n  whitelistedPriceIds: string[];\n  webhookConfigured: boolean;\n} {\n  const config = getStripeConfig();\n  return {\n    mode: config.isTestMode ? \"test\" : \"live\",\n    isConfigured: config.isConfigured,\n    appSlug: config.appSlug,\n    baseUrl: config.baseUrl,\n    whitelistedPriceIds: config.priceIds,\n    webhookConfigured: !!process.env.STRIPE_WEBHOOK_SECRET,\n  };\n}\n\nexport function logWebhookEvent(params: {\n  eventId: string;\n  eventType: string;\n  subscriptionId?: string | null;\n  customerId?: string | null;\n  tenantId?: number | null;\n  priceId?: string | null;\n  result: \"processed\" | \"skipped\" | \"error\";\n  reason?: string;\n}) {\n  const config = getStripeConfig();\n  const logEntry = {\n    timestamp: new Date().toISOString(),\n    app: config.appSlug,\n    ...params,\n  };\n  \n  console.log(`[Stripe Webhook] ${JSON.stringify(logEntry)}`);\n}\n","path":null,"size_bytes":3263,"size_tokens":null},"tests/integration/accounts.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport type { Request, Response, NextFunction } from 'express';\n\nconst mockStorage = {\n  getAccounts: vi.fn(),\n  getAccount: vi.fn(),\n  createAccount: vi.fn(),\n  updateAccount: vi.fn(),\n  deleteAccount: vi.fn(),\n};\n\ndescribe('Accounts API Integration Tests', () => {\n  let mockRes: Partial<Response>;\n  let mockNext: NextFunction;\n\n  beforeEach(() => {\n    vi.clearAllMocks();\n    mockRes = {\n      status: vi.fn().mockReturnThis(),\n      json: vi.fn().mockReturnThis(),\n    };\n    mockNext = vi.fn();\n  });\n\n  describe('GET /api/accounts', () => {\n    it('returns accounts for the tenant', async () => {\n      const tenantId = 1;\n      const accounts = [\n        { id: 1, tenantId, name: 'Account 1', segment: 'residential', region: 'north' },\n        { id: 2, tenantId, name: 'Account 2', segment: 'commercial', region: 'south' },\n      ];\n\n      mockStorage.getAccounts.mockResolvedValue(accounts);\n\n      const result = await mockStorage.getAccounts();\n\n      expect(result).toHaveLength(2);\n      expect(result[0].tenantId).toBe(tenantId);\n      expect(result[1].tenantId).toBe(tenantId);\n    });\n\n    it('returns empty array when no accounts exist', async () => {\n      mockStorage.getAccounts.mockResolvedValue([]);\n\n      const result = await mockStorage.getAccounts();\n\n      expect(result).toHaveLength(0);\n    });\n  });\n\n  describe('GET /api/accounts/:id', () => {\n    it('returns account by ID within tenant', async () => {\n      const account = { id: 1, tenantId: 1, name: 'Test Account', segment: 'residential' };\n      mockStorage.getAccount.mockResolvedValue(account);\n\n      const result = await mockStorage.getAccount(1);\n\n      expect(result).toEqual(account);\n      expect(result.tenantId).toBe(1);\n    });\n\n    it('returns null for non-existent account', async () => {\n      mockStorage.getAccount.mockResolvedValue(null);\n\n      const result = await mockStorage.getAccount(999);\n\n      expect(result).toBeNull();\n    });\n\n    it('does not return accounts from other tenants', async () => {\n      mockStorage.getAccount.mockResolvedValue(null);\n\n      const result = await mockStorage.getAccount(1);\n\n      expect(result).toBeNull();\n    });\n  });\n\n  describe('POST /api/accounts', () => {\n    it('creates account with tenant ID', async () => {\n      const newAccount = {\n        name: 'New Account',\n        segment: 'commercial',\n        region: 'east',\n        annualRevenue: '100000',\n      };\n\n      const createdAccount = { id: 1, tenantId: 1, ...newAccount };\n      mockStorage.createAccount.mockResolvedValue(createdAccount);\n\n      const result = await mockStorage.createAccount(newAccount);\n\n      expect(result.tenantId).toBe(1);\n      expect(result.name).toBe('New Account');\n    });\n\n    it('validates required fields', () => {\n      const invalidAccount = {\n        segment: 'commercial',\n      };\n\n      expect(invalidAccount.segment).toBeDefined();\n      expect((invalidAccount as any).name).toBeUndefined();\n    });\n  });\n\n  describe('PUT /api/accounts/:id', () => {\n    it('updates account within tenant', async () => {\n      const existingAccount = { id: 1, tenantId: 1, name: 'Old Name', segment: 'residential' };\n      const updatedAccount = { ...existingAccount, name: 'New Name' };\n\n      mockStorage.getAccount.mockResolvedValue(existingAccount);\n      mockStorage.updateAccount.mockResolvedValue(updatedAccount);\n\n      const result = await mockStorage.updateAccount(1, { name: 'New Name' });\n\n      expect(result.name).toBe('New Name');\n      expect(result.tenantId).toBe(1);\n    });\n\n    it('returns 404 for account not found', async () => {\n      mockStorage.getAccount.mockResolvedValue(null);\n\n      const result = await mockStorage.getAccount(999);\n\n      expect(result).toBeNull();\n    });\n  });\n\n  describe('DELETE /api/accounts/:id', () => {\n    it('deletes account within tenant', async () => {\n      const account = { id: 1, tenantId: 1, name: 'To Delete' };\n      mockStorage.getAccount.mockResolvedValue(account);\n      mockStorage.deleteAccount.mockResolvedValue(true);\n\n      const result = await mockStorage.deleteAccount(1);\n\n      expect(result).toBe(true);\n    });\n\n    it('does not delete accounts from other tenants', async () => {\n      mockStorage.getAccount.mockResolvedValue(null);\n      mockStorage.deleteAccount.mockResolvedValue(false);\n\n      const found = await mockStorage.getAccount(1);\n      expect(found).toBeNull();\n    });\n  });\n\n  describe('Tenant Isolation', () => {\n    it('ensures all accounts have correct tenantId', async () => {\n      const tenantId = 5;\n      const accounts = [\n        { id: 1, tenantId, name: 'Account 1' },\n        { id: 2, tenantId, name: 'Account 2' },\n        { id: 3, tenantId, name: 'Account 3' },\n      ];\n\n      mockStorage.getAccounts.mockResolvedValue(accounts);\n\n      const result = await mockStorage.getAccounts();\n\n      result.forEach((account: any) => {\n        expect(account.tenantId).toBe(tenantId);\n      });\n    });\n\n    it('newly created accounts inherit tenantId from context', async () => {\n      const tenantId = 3;\n      const newAccount = { name: 'New Account', segment: 'residential' };\n      const createdAccount = { id: 1, tenantId, ...newAccount };\n\n      mockStorage.createAccount.mockResolvedValue(createdAccount);\n\n      const result = await mockStorage.createAccount(newAccount);\n\n      expect(result.tenantId).toBe(tenantId);\n    });\n  });\n});\n","path":null,"size_bytes":5452,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"@shared/schema\";\n\nconst pool = new pg.Pool({\n  connectionString: process.env.DATABASE_URL,\n});\n\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":240,"size_tokens":null},"tests/integration/api-resilience.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport { withRetry } from '../../server/utils/retry';\n\ndescribe('API Resilience Integration Tests', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('withRetry Utility', () => {\n    it('succeeds on first attempt', async () => {\n      const mockFn = vi.fn().mockResolvedValue('success');\n\n      const result = await withRetry(mockFn, { maxRetries: 3 });\n\n      expect(result).toBe('success');\n      expect(mockFn).toHaveBeenCalledTimes(1);\n    });\n\n    it('retries on transient failure', async () => {\n      const mockFn = vi.fn()\n        .mockRejectedValueOnce(new Error('Network error'))\n        .mockResolvedValue('success');\n\n      const result = await withRetry(mockFn, { maxRetries: 3, baseDelayMs: 10 });\n\n      expect(result).toBe('success');\n      expect(mockFn).toHaveBeenCalledTimes(2);\n    });\n\n    it('retries on rate limit (429)', async () => {\n      const rateLimitError = new Error('rate limit exceeded - 429');\n\n      const mockFn = vi.fn()\n        .mockRejectedValueOnce(rateLimitError)\n        .mockResolvedValue('success');\n\n      const result = await withRetry(mockFn, { maxRetries: 3, baseDelayMs: 10 });\n\n      expect(result).toBe('success');\n      expect(mockFn).toHaveBeenCalledTimes(2);\n    });\n\n    it('retries on server error (5xx)', async () => {\n      const serverError = new Error('Service unavailable - 503');\n\n      const mockFn = vi.fn()\n        .mockRejectedValueOnce(serverError)\n        .mockRejectedValueOnce(serverError)\n        .mockResolvedValue('success');\n\n      const result = await withRetry(mockFn, { maxRetries: 3, baseDelayMs: 10 });\n\n      expect(result).toBe('success');\n      expect(mockFn).toHaveBeenCalledTimes(3);\n    });\n\n    it('throws after max retries exhausted', async () => {\n      const mockFn = vi.fn().mockRejectedValue(new Error('Network timeout error'));\n\n      await expect(\n        withRetry(mockFn, { maxRetries: 3, baseDelayMs: 10 })\n      ).rejects.toThrow();\n\n      expect(mockFn).toHaveBeenCalledTimes(4);\n    });\n\n    it('does not retry on non-retryable errors', async () => {\n      const validationError = new Error('Invalid input');\n      (validationError as any).status = 400;\n\n      const mockFn = vi.fn().mockRejectedValue(validationError);\n\n      await expect(\n        withRetry(mockFn, { maxRetries: 3, baseDelayMs: 10 })\n      ).rejects.toThrow('Invalid input');\n\n      expect(mockFn).toHaveBeenCalledTimes(1);\n    });\n\n    it('respects timeout configuration', async () => {\n      const slowFn = vi.fn().mockImplementation(\n        () => new Promise((resolve) => setTimeout(() => resolve('done'), 100))\n      );\n\n      const result = await withRetry(slowFn, { maxRetries: 1, timeoutMs: 200 });\n\n      expect(result).toBe('done');\n    });\n\n    it('times out slow operations', async () => {\n      const verySlowFn = vi.fn().mockImplementation(\n        () => new Promise((resolve) => setTimeout(() => resolve('done'), 5000))\n      );\n\n      const timeoutPromise = withRetry(verySlowFn, { maxRetries: 1, timeoutMs: 50, baseDelayMs: 10 });\n\n      await expect(timeoutPromise).rejects.toThrow();\n    }, 10000);\n  });\n\n  describe('OpenAI API Resilience', () => {\n    it('AI service has retry logic configured', () => {\n      const aiServiceConfig = {\n        maxRetries: 3,\n        timeoutMs: 60000,\n        exponentialBackoff: true,\n      };\n\n      expect(aiServiceConfig.maxRetries).toBe(3);\n      expect(aiServiceConfig.timeoutMs).toBe(60000);\n      expect(aiServiceConfig.exponentialBackoff).toBe(true);\n    });\n\n    it('fallback values are used when AI fails', async () => {\n      const fallbackCallScript = {\n        title: 'Discuss products with Account',\n        taskType: 'call',\n        description: 'High-opportunity account missing products category',\n        script: 'Hi, this is [Your Name] from ABC Supply...',\n      };\n\n      expect(fallbackCallScript.title).toBeDefined();\n      expect(fallbackCallScript.script).toContain('ABC Supply');\n    });\n  });\n\n  describe('Email Service Resilience', () => {\n    it('email service has retry logic configured', () => {\n      const emailServiceConfig = {\n        maxRetries: 3,\n        timeoutMs: 30000,\n        exponentialBackoff: true,\n      };\n\n      expect(emailServiceConfig.maxRetries).toBe(3);\n      expect(emailServiceConfig.timeoutMs).toBe(30000);\n    });\n\n    it('handles Resend API failures gracefully', async () => {\n      const mockSendEmail = vi.fn().mockResolvedValue({\n        success: false,\n        error: 'Resend API key not configured',\n      });\n\n      const result = await mockSendEmail('test@example.com', 'Subject', 'Body');\n\n      expect(result.success).toBe(false);\n      expect(result.error).toContain('not configured');\n    });\n\n    it('returns success with message ID on successful send', async () => {\n      const mockSendEmail = vi.fn().mockResolvedValue({\n        success: true,\n        messageId: 'msg_123abc',\n      });\n\n      const result = await mockSendEmail('test@example.com', 'Subject', 'Body');\n\n      expect(result.success).toBe(true);\n      expect(result.messageId).toBe('msg_123abc');\n    });\n  });\n\n  describe('Rate Limiting Protection', () => {\n    it('auth endpoints have rate limiting', () => {\n      const rateLimits = {\n        login: { windowMs: 15 * 60 * 1000, max: 10 },\n        callback: { windowMs: 15 * 60 * 1000, max: 10 },\n        logout: { windowMs: 60 * 1000, max: 5 },\n      };\n\n      expect(rateLimits.login.max).toBe(10);\n      expect(rateLimits.callback.max).toBe(10);\n      expect(rateLimits.logout.max).toBe(5);\n    });\n\n    it('rate limit response format is correct', () => {\n      const rateLimitResponse = {\n        message: 'Too many login attempts. Please try again later.',\n      };\n\n      expect(rateLimitResponse.message).toContain('Too many');\n    });\n  });\n\n  describe('Batch Query Optimization', () => {\n    it('batch queries reduce database calls', async () => {\n      const mockGetAccountsBatch = vi.fn().mockResolvedValue(\n        new Map([\n          [1, { id: 1, name: 'Account 1' }],\n          [2, { id: 2, name: 'Account 2' }],\n          [3, { id: 3, name: 'Account 3' }],\n        ])\n      );\n\n      const accountIds = [1, 2, 3];\n      const result = await mockGetAccountsBatch(accountIds);\n\n      expect(mockGetAccountsBatch).toHaveBeenCalledTimes(1);\n      expect(result.size).toBe(3);\n    });\n\n    it('batch queries handle empty input', async () => {\n      const mockGetAccountsBatch = vi.fn().mockResolvedValue(new Map());\n\n      const result = await mockGetAccountsBatch([]);\n\n      expect(result.size).toBe(0);\n    });\n\n    it('parallel batch queries are efficient', async () => {\n      const mockBatchAccounts = vi.fn().mockResolvedValue(new Map());\n      const mockBatchMetrics = vi.fn().mockResolvedValue(new Map());\n      const mockBatchSnapshots = vi.fn().mockResolvedValue(new Map());\n\n      const [accounts, metrics, snapshots] = await Promise.all([\n        mockBatchAccounts([1, 2, 3]),\n        mockBatchMetrics([1, 2, 3]),\n        mockBatchSnapshots([1, 2, 3]),\n      ]);\n\n      expect(mockBatchAccounts).toHaveBeenCalledTimes(1);\n      expect(mockBatchMetrics).toHaveBeenCalledTimes(1);\n      expect(mockBatchSnapshots).toHaveBeenCalledTimes(1);\n    });\n  });\n});\n","path":null,"size_bytes":7277,"size_tokens":null},"client/src/components/daily-briefing-card.tsx":{"content":"/**\n * DailyBriefingCard â€” Phase 4\n *\n * Placed at the top of dashboard.tsx.\n * Reads from GET /api/agent/state/daily-briefing for the latest run summary,\n * and GET /api/agent/learnings for seeded context.\n *\n * Shows:\n *  - Headline action (from latestBriefing)\n *  - 2-3 priority items with quick-action buttons (opens DossierPanel)\n *  - At-risk watch list warning banner (collapsible)\n *  - \"View Full Briefing\" link\n *  - Trigger button for admin to fire a new briefing\n *  - Checkboxes on action items to track completion through the day\n *  - Dismiss/reopen: collapsed \"Show Daily Briefing\" bar when minimized\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { ChevronDown, ChevronUp, AlertTriangle, Zap, Sparkles, RefreshCw, ExternalLink, X, Eye, CheckCircle2, Circle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface AgentStateRow {\n    lastRunAt: string | null;\n    lastRunSummary: string | null;\n    currentFocus: string | null;\n    pendingActions: any;\n    openQuestions: any;\n}\n\ninterface BriefingRecord {\n    id: number;\n    briefingDate: string;\n    headlineAction: string | null;\n    priorityItems: Array<{ account_name: string; account_id: number; action: string; urgency: string; why: string }> | null;\n    atRiskAccounts: Array<{ account_name: string; account_id: number; signal: string }> | null;\n}\n\nconst urgencyBadge: Record<string, string> = {\n    immediate: \"bg-red-100 text-red-700 border-red-200\",\n    this_week: \"bg-amber-100 text-amber-700 border-amber-200\",\n    this_month: \"bg-blue-100 text-blue-700 border-blue-200\",\n};\n\nconst DISMISSED_KEY = \"daily-briefing-dismissed\";\nconst COMPLETED_KEY = \"daily-briefing-completed\";\n\nfunction getToday(): string {\n    return new Date().toDateString();\n}\n\nfunction loadCompletedActions(): Set<string> {\n    try {\n        const raw = localStorage.getItem(COMPLETED_KEY);\n        if (!raw) return new Set();\n        const parsed = JSON.parse(raw);\n        if (parsed.date !== getToday()) {\n            localStorage.removeItem(COMPLETED_KEY);\n            return new Set();\n        }\n        return new Set(parsed.ids as string[]);\n    } catch {\n        return new Set();\n    }\n}\n\nfunction saveCompletedActions(ids: Set<string>) {\n    localStorage.setItem(COMPLETED_KEY, JSON.stringify({ date: getToday(), ids: Array.from(ids) }));\n}\n\ninterface DailyBriefingCardProps {\n    onAccountClick?: (accountId: number) => void;\n    showAdminControls?: boolean;\n}\n\nexport function DailyBriefingCard({ onAccountClick, showAdminControls = false }: DailyBriefingCardProps) {\n    const { toast } = useToast();\n    const queryClient = useQueryClient();\n    const [atRiskExpanded, setAtRiskExpanded] = useState(false);\n    const [fullBriefingExpanded, setFullBriefingExpanded] = useState(false);\n    const [isDismissed, setIsDismissed] = useState(false);\n    const [isMounted, setIsMounted] = useState(false);\n    const [completedActions, setCompletedActions] = useState<Set<string>>(new Set());\n\n    useEffect(() => {\n        setIsMounted(true);\n        setCompletedActions(loadCompletedActions());\n        if (!showAdminControls) {\n            const dismissedDate = localStorage.getItem(DISMISSED_KEY);\n            if (dismissedDate === getToday()) {\n                setIsDismissed(true);\n            }\n        }\n    }, [showAdminControls]);\n\n    const handleDismiss = () => {\n        if (showAdminControls) return;\n        localStorage.setItem(DISMISSED_KEY, getToday());\n        setIsDismissed(true);\n    };\n\n    const handleReopen = () => {\n        localStorage.removeItem(DISMISSED_KEY);\n        setIsDismissed(false);\n    };\n\n    const toggleActionCompleted = useCallback((actionKey: string, e: React.MouseEvent) => {\n        e.stopPropagation();\n        setCompletedActions((prev) => {\n            const next = new Set(prev);\n            if (next.has(actionKey)) {\n                next.delete(actionKey);\n            } else {\n                next.add(actionKey);\n            }\n            saveCompletedActions(next);\n            return next;\n        });\n    }, []);\n\n    const { data: agentState, isLoading } = useQuery<AgentStateRow>({\n        queryKey: [\"/api/agent/state/daily-briefing\"],\n        retry: false,\n    });\n\n    const triggerBriefingMutation = useMutation({\n        mutationFn: () => apiRequest(\"POST\", \"/api/agent/daily-briefing\", {}),\n        onSuccess: () => {\n            toast({\n                title: \"Briefing Triggered!\",\n                description: \"The AI is now scanning your accounts and drafting actions. This takes about 30 seconds. The card will update automatically.\",\n            });\n            setTimeout(() => {\n                queryClient.invalidateQueries({ queryKey: [\"/api/agent/state/daily-briefing\"] });\n            }, 10000);\n            setTimeout(() => {\n                queryClient.invalidateQueries({ queryKey: [\"/api/agent/state/daily-briefing\"] });\n            }, 25000);\n        },\n        onError: () => toast({ title: \"Error\", description: \"Failed to trigger briefing.\", variant: \"destructive\" }),\n    });\n\n    if (isLoading) {\n        return (\n            <div className=\"rounded-xl border bg-card animate-pulse h-32 mb-6\" />\n        );\n    }\n\n    if (!isMounted) return null;\n\n    // No state yet = no briefing run\n    if (!agentState?.lastRunSummary && !agentState?.currentFocus) {\n        if (!showAdminControls) return null;\n\n        return (\n            <div className=\"rounded-xl border bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/20 dark:to-indigo-950/20 p-5 mb-6\">\n                <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                        <div className=\"h-9 w-9 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center\">\n                            <Sparkles className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                        </div>\n                        <div>\n                            <p className=\"font-semibold text-sm\">Daily Action Plan</p>\n                            <p className=\"text-xs text-muted-foreground\">Analyzes your territory, identifies missing revenue, and drafts action plans every morning at 7:00 AM.</p>\n                        </div>\n                    </div>\n                    <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        onClick={() => triggerBriefingMutation.mutate()}\n                        disabled={triggerBriefingMutation.isPending}\n                    >\n                        <RefreshCw className={`h-3.5 w-3.5 mr-1.5 ${triggerBriefingMutation.isPending ? \"animate-spin\" : \"\"}`} />\n                        {triggerBriefingMutation.isPending ? \"Drafting...\" : \"Sync Latest Data\"}\n                    </Button>\n                </div>\n            </div>\n        );\n    }\n\n    const priorityItems = Array.isArray(agentState?.pendingActions) ? agentState.pendingActions as any[] : [];\n    const atRiskItems = Array.isArray(agentState?.openQuestions) ? agentState.openQuestions as any[] : [];\n    const lastRun = agentState?.lastRunAt ? new Date(agentState.lastRunAt) : null;\n    const actionKey = (item: any) => `action-${item.account_id ?? item.account_name}`;\n    const completedCount = priorityItems.filter((item: any) => completedActions.has(actionKey(item))).length;\n    const totalActions = priorityItems.length;\n\n    if (isDismissed) {\n        return (\n            <div className=\"mb-6\">\n                <button\n                    onClick={handleReopen}\n                    className=\"w-full flex items-center justify-between px-4 py-2.5 rounded-xl border bg-gradient-to-r from-blue-50/60 to-white dark:from-blue-950/10 dark:to-background hover:border-primary/40 transition-colors group\"\n                    data-testid=\"button-reopen-briefing\"\n                >\n                    <div className=\"flex items-center gap-2.5\">\n                        <div className=\"h-6 w-6 rounded-full bg-blue-600 flex items-center justify-center shrink-0\">\n                            <Sparkles className=\"h-3 w-3 text-white\" />\n                        </div>\n                        <span className=\"text-sm font-medium text-muted-foreground group-hover:text-foreground transition-colors\">\n                            Show Daily Action Plan\n                        </span>\n                        {totalActions > 0 && (\n                            <span className=\"text-xs text-muted-foreground\">\n                                Â· {completedCount}/{totalActions} completed\n                            </span>\n                        )}\n                    </div>\n                    <ChevronDown className=\"h-4 w-4 text-muted-foreground group-hover:text-foreground transition-colors\" />\n                </button>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"rounded-xl border bg-gradient-to-br from-blue-50/80 to-white dark:from-blue-950/20 dark:to-background mb-6 overflow-hidden\" id=\"daily-briefing-card\">\n            {/* Header bar */}\n            <div className=\"flex items-center justify-between px-5 pt-4 pb-3 border-b border-blue-100 dark:border-blue-900/30\">\n                <div className=\"flex items-center gap-2.5\">\n                    <div className=\"h-7 w-7 rounded-full bg-blue-600 flex items-center justify-center shrink-0\">\n                        <Sparkles className=\"h-3.5 w-3.5 text-white\" />\n                    </div>\n                    <div>\n                        <div className=\"flex items-center gap-2\">\n                            <span className=\"text-sm font-semibold\">Daily Action Plan</span>\n                            <Badge variant=\"outline\" className=\"text-[10px] uppercase tracking-wider h-4 px-1.5 bg-blue-50/50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300\">Automated</Badge>\n                            {totalActions > 0 && (\n                                <span className=\"text-xs text-muted-foreground ml-1\">\n                                    {completedCount}/{totalActions} done\n                                </span>\n                            )}\n                        </div>\n                        <p className=\"text-[10px] text-muted-foreground\">Scheduled at 7:00 AM EST Â· Scans your territory for new gaps and signals</p>\n                    </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                    {showAdminControls && (\n                        <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"h-7 text-xs text-muted-foreground hover:text-primary transition-colors\"\n                            onClick={() => triggerBriefingMutation.mutate()}\n                            disabled={triggerBriefingMutation.isPending}\n                        >\n                            <RefreshCw className={`h-3 w-3 mr-1 ${triggerBriefingMutation.isPending ? \"animate-spin\" : \"\"}`} />\n                            {triggerBriefingMutation.isPending ? \"Syncing...\" : \"Sync Latest Data\"}\n                        </Button>\n                    )}\n                    <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        className=\"h-7 w-7 text-muted-foreground hover:text-foreground\"\n                        onClick={handleDismiss}\n                        data-testid=\"button-dismiss-briefing\"\n                    >\n                        <X className=\"h-3.5 w-3.5\" />\n                    </Button>\n                </div>\n            </div>\n\n            <div className=\"px-5 py-4 space-y-4\">\n                {/* Headline action */}\n                {agentState?.currentFocus && (\n                    <div className=\"flex items-start gap-2.5\">\n                        <Zap className=\"h-4 w-4 text-primary mt-0.5 shrink-0\" />\n                        <div>\n                            <p className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground mb-0.5\">Today's Focus</p>\n                            <p className=\"text-sm font-medium\">{agentState.currentFocus}</p>\n                        </div>\n                    </div>\n                )}\n\n                {/* Last run summary */}\n                {agentState?.lastRunSummary && (\n                    <p className=\"text-sm text-muted-foreground leading-relaxed\">{agentState.lastRunSummary}</p>\n                )}\n\n                {/* Priority items with checkboxes */}\n                {priorityItems.length > 0 && (\n                    <div className=\"space-y-2\">\n                        <p className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground\">Priority Accounts</p>\n                        {priorityItems.slice(0, 3).map((item: any, i: number) => {\n                            const key = actionKey(item);\n                            const isCompleted = completedActions.has(key);\n                            return (\n                                <div\n                                    key={key}\n                                    className={`flex items-center gap-3 p-2.5 rounded-lg border bg-white dark:bg-card hover:border-primary/40 cursor-pointer transition-all ${isCompleted ? \"opacity-60\" : \"\"}`}\n                                    onClick={() => item.account_id && onAccountClick?.(item.account_id)}\n                                    data-testid={`priority-action-${i}`}\n                                >\n                                    <button\n                                        onClick={(e) => toggleActionCompleted(key, e)}\n                                        className=\"shrink-0 focus:outline-none\"\n                                        data-testid={`checkbox-action-${i}`}\n                                        title={isCompleted ? \"Mark as incomplete\" : \"Mark as done\"}\n                                    >\n                                        {isCompleted ? (\n                                            <CheckCircle2 className=\"h-5 w-5 text-green-500\" />\n                                        ) : (\n                                            <Circle className=\"h-5 w-5 text-muted-foreground/40 hover:text-primary transition-colors\" />\n                                        )}\n                                    </button>\n                                    <span className={`text-xs px-2 py-0.5 rounded-full border font-medium shrink-0 ${urgencyBadge[item.urgency] ?? \"bg-slate-100 text-slate-700 border-slate-200\"}`}>\n                                        {item.urgency?.replace(/_/g, \" \")}\n                                    </span>\n                                    <div className=\"flex-1 min-w-0\">\n                                        <span className={`text-sm font-medium ${isCompleted ? \"line-through text-muted-foreground\" : \"\"}`}>{item.account_name}</span>\n                                        <span className={`text-xs text-muted-foreground ml-2 ${isCompleted ? \"line-through\" : \"\"}`}>Â· {item.action}</span>\n                                    </div>\n                                    <ExternalLink className=\"h-3.5 w-3.5 text-muted-foreground shrink-0\" />\n                                </div>\n                            );\n                        })}\n                    </div>\n                )}\n\n                {/* View Full Briefing expandable */}\n                {agentState?.lastRunSummary && (\n                    <div>\n                        <button\n                            className=\"flex items-center gap-1.5 text-xs text-primary hover:text-primary/80 font-medium transition-colors\"\n                            onClick={() => setFullBriefingExpanded(!fullBriefingExpanded)}\n                            data-testid=\"view-full-briefing\"\n                        >\n                            <Eye className=\"h-3 w-3\" />\n                            {fullBriefingExpanded ? \"Hide Full Briefing\" : \"View Full Briefing\"}\n                            {fullBriefingExpanded ? <ChevronUp className=\"h-3 w-3\" /> : <ChevronDown className=\"h-3 w-3\" />}\n                        </button>\n                        {fullBriefingExpanded && (\n                            <div className=\"mt-3 p-3 rounded-lg bg-white dark:bg-card border text-sm space-y-3\">\n                                {agentState.lastRunSummary && (\n                                    <div>\n                                        <p className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground mb-1\">Analysis Summary</p>\n                                        <p className=\"text-sm leading-relaxed\">{agentState.lastRunSummary}</p>\n                                    </div>\n                                )}\n                                {priorityItems.length > 0 && (\n                                    <div>\n                                        <p className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground mb-1\">All Priority Actions ({priorityItems.length})</p>\n                                        <div className=\"space-y-1.5\">\n                                            {priorityItems.map((item: any, i: number) => {\n                                                const key = actionKey(item);\n                                                const isCompleted = completedActions.has(key);\n                                                return (\n                                                    <div key={key} className={`text-xs flex items-start gap-2 ${isCompleted ? \"opacity-50\" : \"\"}`}>\n                                                        <button\n                                                            onClick={(e) => { e.stopPropagation(); toggleActionCompleted(key, e); }}\n                                                            className=\"shrink-0 mt-0.5 focus:outline-none\"\n                                                            data-testid={`checkbox-full-action-${i}`}\n                                                        >\n                                                            {isCompleted ? (\n                                                                <CheckCircle2 className=\"h-3.5 w-3.5 text-green-500\" />\n                                                            ) : (\n                                                                <Circle className=\"h-3.5 w-3.5 text-muted-foreground/40 hover:text-primary transition-colors\" />\n                                                            )}\n                                                        </button>\n                                                        <span className={`font-medium shrink-0 ${isCompleted ? \"line-through text-muted-foreground\" : \"\"}`}>{item.account_name}:</span>\n                                                        <span className={`text-muted-foreground ${isCompleted ? \"line-through\" : \"\"}`}>{item.action} â€” {item.why}</span>\n                                                    </div>\n                                                );\n                                            })}\n                                        </div>\n                                    </div>\n                                )}\n                                {lastRun && (\n                                    <p className=\"text-[10px] text-muted-foreground\">Last updated: {lastRun.toLocaleString()}</p>\n                                )}\n                            </div>\n                        )}\n                    </div>\n                )}\n\n                {/* At-risk banner */}\n                {atRiskItems.length > 0 && (\n                    <div className=\"rounded-lg border border-red-200 dark:border-red-900/50 bg-red-50 dark:bg-red-950/20 overflow-hidden\">\n                        <button\n                            className=\"w-full flex items-center justify-between px-3 py-2.5 text-left\"\n                            onClick={() => setAtRiskExpanded(!atRiskExpanded)}\n                        >\n                            <div className=\"flex items-center gap-2\">\n                                <AlertTriangle className=\"h-3.5 w-3.5 text-red-600\" />\n                                <span className=\"text-xs font-semibold text-red-700 dark:text-red-400\">\n                                    {atRiskItems.length} At-Risk {atRiskItems.length === 1 ? \"Account\" : \"Accounts\"}\n                                </span>\n                            </div>\n                            {atRiskExpanded ? <ChevronUp className=\"h-3.5 w-3.5 text-red-500\" /> : <ChevronDown className=\"h-3.5 w-3.5 text-red-500\" />}\n                        </button>\n                        {atRiskExpanded && (\n                            <div className=\"px-3 pb-3 space-y-1.5 border-t border-red-200 dark:border-red-900/50 pt-2\">\n                                {atRiskItems.map((item: any, i: number) => (\n                                    <div\n                                        key={i}\n                                        className={`flex items-center gap-2 text-xs ${item.account_id ? \"cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/30 rounded px-1 py-0.5 -mx-1 transition-colors\" : \"\"}`}\n                                        onClick={() => item.account_id && onAccountClick?.(item.account_id)}\n                                        data-testid={`at-risk-account-${item.account_id ?? i}`}\n                                    >\n                                        <span className=\"font-medium text-red-800 dark:text-red-300\">{item.account_name ?? item}</span>\n                                        {item.signal && <span className=\"text-red-600 dark:text-red-400\">Â· {item.signal}</span>}\n                                        {item.account_id && <ExternalLink className=\"h-3 w-3 text-red-400 ml-auto shrink-0\" />}\n                                    </div>\n                                ))}\n                            </div>\n                        )}\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n}\n","path":null,"size_bytes":22306,"size_tokens":null},"client/src/components/empty-state.tsx":{"content":"import { LucideIcon } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface EmptyStateProps {\n  icon: LucideIcon;\n  title: string;\n  description: string;\n  action?: {\n    label: string;\n    onClick: () => void;\n  };\n  testId?: string;\n}\n\nexport function EmptyState({\n  icon: Icon,\n  title,\n  description,\n  action,\n  testId,\n}: EmptyStateProps) {\n  return (\n    <div\n      className=\"flex flex-col items-center justify-center py-12 px-4 text-center\"\n      data-testid={testId}\n    >\n      <div className=\"flex h-16 w-16 items-center justify-center rounded-full bg-muted mb-4\">\n        <Icon className=\"h-8 w-8 text-muted-foreground\" />\n      </div>\n      <h3 className=\"text-lg font-semibold mb-2\">{title}</h3>\n      <p className=\"text-sm text-muted-foreground max-w-sm mb-6\">{description}</p>\n      {action && (\n        <Button onClick={action.onClick} data-testid={`${testId}-action`}>\n          {action.label}\n        </Button>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":985,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/lib/auth-utils.ts":{"content":"export function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n\n// Redirect to login with a toast notification\nexport function redirectToLogin(toast?: (options: { title: string; description: string; variant: string }) => void) {\n  if (toast) {\n    toast({\n      title: \"Unauthorized\",\n      description: \"You are logged out. Logging in again...\",\n      variant: \"destructive\",\n    });\n  }\n  setTimeout(() => {\n    window.location.href = \"/api/login\";\n  }, 500);\n}\n","path":null,"size_bytes":517,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"server/utils/retry.ts":{"content":"interface RetryOptions {\n  maxRetries?: number;\n  baseDelayMs?: number;\n  maxDelayMs?: number;\n  timeoutMs?: number;\n  shouldRetry?: (error: unknown) => boolean;\n}\n\nconst DEFAULT_OPTIONS: Required<Omit<RetryOptions, 'shouldRetry'>> = {\n  maxRetries: 3,\n  baseDelayMs: 1000,\n  maxDelayMs: 10000,\n  timeoutMs: 30000,\n};\n\nfunction isRetryableError(error: unknown): boolean {\n  if (error instanceof Error) {\n    const message = error.message.toLowerCase();\n    if (message.includes('rate limit') || \n        message.includes('timeout') || \n        message.includes('econnreset') ||\n        message.includes('econnrefused') ||\n        message.includes('socket hang up') ||\n        message.includes('network') ||\n        message.includes('503') ||\n        message.includes('502') ||\n        message.includes('429')) {\n      return true;\n    }\n  }\n  return false;\n}\n\nfunction createTimeoutPromise(ms: number): Promise<never> {\n  return new Promise((_, reject) => {\n    setTimeout(() => reject(new Error(`Request timed out after ${ms}ms`)), ms);\n  });\n}\n\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const {\n    maxRetries = DEFAULT_OPTIONS.maxRetries,\n    baseDelayMs = DEFAULT_OPTIONS.baseDelayMs,\n    maxDelayMs = DEFAULT_OPTIONS.maxDelayMs,\n    timeoutMs = DEFAULT_OPTIONS.timeoutMs,\n    shouldRetry = isRetryableError,\n  } = options;\n\n  let lastError: unknown;\n\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      const result = await Promise.race([\n        fn(),\n        createTimeoutPromise(timeoutMs),\n      ]);\n      return result;\n    } catch (error) {\n      lastError = error;\n\n      if (attempt === maxRetries) {\n        break;\n      }\n\n      if (!shouldRetry(error)) {\n        throw error;\n      }\n\n      const delay = Math.min(baseDelayMs * Math.pow(2, attempt), maxDelayMs);\n      const jitter = delay * 0.1 * Math.random();\n      await new Promise(resolve => setTimeout(resolve, delay + jitter));\n    }\n  }\n\n  throw lastError;\n}\n\nexport async function withTimeout<T>(\n  fn: () => Promise<T>,\n  timeoutMs: number = DEFAULT_OPTIONS.timeoutMs\n): Promise<T> {\n  return Promise.race([\n    fn(),\n    createTimeoutPromise(timeoutMs),\n  ]);\n}\n","path":null,"size_bytes":2229,"size_tokens":null},"client/src/pages/icp-builder.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Tabs,\n  TabsContent,\n  TabsList,\n  TabsTrigger,\n} from \"@/components/ui/tabs\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Target,\n  Plus,\n  Sparkles,\n  CheckCircle,\n  Edit2,\n  Save,\n  Trash2,\n  RefreshCw,\n  AlertCircle,\n  FileText,\n  Clock,\n  ChevronRight,\n  ChevronDown,\n  Loader2,\n  Info,\n  HelpCircle,\n  BarChart3,\n  TrendingUp,\n  Users,\n  Database,\n  Brain,\n  Lightbulb,\n  ArrowRight,\n  DollarSign,\n  Zap,\n} from \"lucide-react\";\nimport {\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip as RechartsTooltip,\n  ResponsiveContainer,\n  PieChart,\n  Pie,\n  Cell,\n} from \"recharts\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\n\ninterface SegmentProfile {\n  id: number;\n  segment: string;\n  name: string;\n  description: string;\n  minAnnualRevenue: number;\n  status: \"draft\" | \"approved\";\n  categories: Array<{\n    id: number;\n    categoryName: string;\n    expectedPct: number;\n    importance: number;\n    isRequired: boolean;\n    notes: string;\n  }>;\n  accountCount: number;\n  approvedBy?: string;\n  approvedAt?: string;\n}\n\ninterface DataInsights {\n  datasetSummary: {\n    totalClassACustomers: number;\n    totalRevenue: number;\n    avgCategories: number;\n    dateRange: string;\n    segmentBreakdown: Array<{ segment: string; count: number; avgRevenue: number }>;\n  };\n  patternAnalysis: {\n    summary: string;\n    categoryPatterns: Array<{ category: string; avgPct: number; stdDev: number; correlation: string }>;\n    isEstimate?: boolean;\n  };\n  decisionLogic: {\n    items: Array<{\n      category: string;\n      expectedPct: number;\n      reasoning: string;\n      confidence: \"high\" | \"medium\" | \"low\";\n      dataPoints: number;\n      dataPointsDetail: Array<{\n        accountName: string;\n        accountId: number;\n        actualPct: number;\n        revenue: number;\n      }>;\n      statistics: {\n        avgActualPct: number;\n        minPct: number;\n        maxPct: number;\n        targetPct: number;\n        variance: number;\n      };\n    }>;\n    isEstimate?: boolean;\n    note?: string;\n  };\n  segmentHealth: {\n    alignmentScore: number;\n    accountsNearICP: number;\n    revenueAtRisk: number;\n    topGaps: Array<{ category: string; gapPct: number }>;\n  };\n  actionableInsights: {\n    quickWins: Array<{ account: string; category: string; potentialRevenue: number }>;\n    crossSellOpps: Array<{ categories: string[]; frequency: number }>;\n    territoryRanking: Array<{ tm: string; avgAlignment: number; accountCount: number }>;\n    projectedLift: number;\n    isEstimate?: boolean;\n  };\n  methodology?: {\n    nearICPThreshold: number;\n    alignmentScoreNote: string;\n    projectedLiftNote: string;\n  };\n}\n\nconst CHART_COLORS = [\"hsl(var(--chart-1))\", \"hsl(var(--chart-2))\", \"hsl(var(--chart-3))\", \"hsl(var(--chart-4))\", \"hsl(var(--chart-5))\"];\n\ninterface EditedCategory {\n  id: number;\n  categoryName: string;\n  expectedPct: number;\n  importance: number;\n  isRequired: boolean;\n  notes: string;\n}\n\nexport default function ICPBuilder() {\n  const [selectedProfile, setSelectedProfile] = useState<SegmentProfile | null>(null);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [editMode, setEditMode] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"profiles\");\n  const [selectedInsightSegment, setSelectedInsightSegment] = useState<string>(\"HVAC\");\n  const [editedMinRevenue, setEditedMinRevenue] = useState<number>(0);\n  const [editedCategories, setEditedCategories] = useState<EditedCategory[]>([]);\n  const [isSaving, setIsSaving] = useState(false);\n  const { toast } = useToast();\n\n  const { data: dataInsights, isLoading: isInsightsLoading } = useQuery<DataInsights>({\n    queryKey: [\"/api/data-insights\", selectedInsightSegment],\n    enabled: activeTab === \"data-insights\",\n  });\n\n  const { data: profiles, isLoading } = useQuery<SegmentProfile[]>({\n    queryKey: [\"/api/segment-profiles\"],\n  });\n\n  const analyzeMutation = useMutation({\n    mutationFn: async (segment: string) => {\n      return apiRequest(\"POST\", \"/api/segment-profiles/analyze\", { segment });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/segment-profiles\"] });\n      toast({\n        title: \"Analysis complete\",\n        description: \"AI has generated a suggested profile\",\n      });\n    },\n    onError: (error: any) => {\n      const errorMessage = error.message || \"\";\n      const isLimitExceeded = errorMessage.includes(\"FEATURE_LIMIT_EXCEEDED\") || errorMessage.includes(\"limit\");\n      const isUpgradeRequired = errorMessage.includes(\"upgrade\") || errorMessage.includes(\"Upgrade\");\n      \n      if (isLimitExceeded || isUpgradeRequired) {\n        toast({\n          title: \"Upgrade Required\",\n          description: \"You've reached your ICP limit. Visit the Subscription page to upgrade.\",\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Analysis failed\",\n          description: \"Could not analyze segment. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    },\n  });\n\n  const approveMutation = useMutation({\n    mutationFn: async (profileId: number) => {\n      return apiRequest(\"POST\", `/api/segment-profiles/${profileId}/approve`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/segment-profiles\"] });\n      setSelectedProfile(null);\n      toast({\n        title: \"Profile approved\",\n        description: \"The ICP profile is now active for scoring\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (profileId: number) => {\n      return apiRequest(\"DELETE\", `/api/segment-profiles/${profileId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/segment-profiles\"] });\n      setSelectedProfile(null);\n      toast({\n        title: \"Profile deleted\",\n        description: \"The ICP profile has been removed\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Delete failed\",\n        description: \"Could not delete the profile. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: { minAnnualRevenue: string } }) => {\n      return apiRequest(\"PATCH\", `/api/segment-profiles/${id}`, data);\n    },\n  });\n\n  const updateCategoryMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: { expectedPct?: string; importance?: string; isRequired?: boolean } }) => {\n      return apiRequest(\"PATCH\", `/api/profile-categories/${id}`, data);\n    },\n  });\n\n  const handleEnterEditMode = () => {\n    if (selectedProfile) {\n      setEditedMinRevenue(selectedProfile.minAnnualRevenue);\n      setEditedCategories(selectedProfile.categories.map(cat => ({\n        id: cat.id,\n        categoryName: cat.categoryName,\n        expectedPct: cat.expectedPct,\n        importance: cat.importance,\n        isRequired: cat.isRequired,\n        notes: cat.notes,\n      })));\n      setEditMode(true);\n    }\n  };\n\n  const handleCancelEdit = () => {\n    setEditMode(false);\n    setEditedMinRevenue(0);\n    setEditedCategories([]);\n  };\n\n  const handleSaveChanges = async () => {\n    if (!selectedProfile) return;\n    \n    setIsSaving(true);\n    try {\n      await updateProfileMutation.mutateAsync({\n        id: selectedProfile.id,\n        data: { minAnnualRevenue: editedMinRevenue.toString() },\n      });\n\n      for (const category of editedCategories) {\n        const originalCategory = selectedProfile.categories.find(c => c.id === category.id);\n        if (originalCategory) {\n          const hasChanges = \n            originalCategory.expectedPct !== category.expectedPct ||\n            originalCategory.importance !== category.importance ||\n            originalCategory.isRequired !== category.isRequired;\n          \n          if (hasChanges) {\n            await updateCategoryMutation.mutateAsync({\n              id: category.id,\n              data: {\n                expectedPct: category.expectedPct.toString(),\n                importance: category.importance.toString(),\n                isRequired: category.isRequired,\n              },\n            });\n          }\n        }\n      }\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/segment-profiles\"] });\n      setEditMode(false);\n      toast({\n        title: \"Profile updated\",\n        description: \"The segment weighting changes have been saved successfully.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Save failed\",\n        description: \"Could not save the changes. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const updateEditedCategory = (categoryId: number, field: keyof EditedCategory, value: number | boolean) => {\n    setEditedCategories(prev => \n      prev.map(cat => \n        cat.id === categoryId ? { ...cat, [field]: value } : cat\n      )\n    );\n  };\n\n  const displayProfiles = profiles || [];\n\n  const handleAnalyzeSegment = async (segment: string) => {\n    setIsAnalyzing(true);\n    await new Promise((resolve) => setTimeout(resolve, 2000)); // Simulate AI analysis\n    setIsAnalyzing(false);\n    toast({\n      title: \"Analysis complete\",\n      description: `AI has analyzed ${segment} purchasing patterns`,\n    });\n  };\n\n  const getImportanceLabel = (value: number) => {\n    if (value < 0.75) return \"Low\";\n    if (value <= 1.25) return \"Normal\";\n    if (value <= 1.75) return \"High\";\n    return \"Strategic\";\n  };\n\n  const getImportanceColor = (value: number) => {\n    if (value < 0.75) return \"text-muted-foreground\";\n    if (value <= 1.25) return \"text-foreground\";\n    if (value <= 1.75) return \"text-chart-3\";\n    return \"text-chart-2\";\n  };\n\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat(\"en-US\", {\n      style: \"currency\",\n      currency: \"USD\",\n      maximumFractionDigits: 0,\n    }).format(value);\n  };\n\n  const getConfidenceBadge = (confidence: \"high\" | \"medium\" | \"low\") => {\n    switch (confidence) {\n      case \"high\":\n        return <Badge className=\"bg-chart-2/10 text-chart-2 border-chart-2/20\">High Confidence</Badge>;\n      case \"medium\":\n        return <Badge className=\"bg-chart-3/10 text-chart-3 border-chart-3/20\">Medium Confidence</Badge>;\n      case \"low\":\n        return <Badge className=\"bg-destructive/10 text-destructive border-destructive/20\">Low Confidence</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-icp-builder\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">ICP Builder</h1>\n          <p className=\"text-muted-foreground\">\n            Define and manage Ideal Customer Profiles by segment\n          </p>\n        </div>\n        <Button data-testid=\"button-new-profile\">\n          <Plus className=\"mr-2 h-4 w-4\" />\n          New Profile\n        </Button>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"profiles\" data-testid=\"tab-profiles\">\n            <Target className=\"mr-2 h-4 w-4\" />\n            Profiles\n          </TabsTrigger>\n          <TabsTrigger value=\"data-insights\" data-testid=\"tab-data-insights\">\n            <BarChart3 className=\"mr-2 h-4 w-4\" />\n            Data Insights\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"profiles\" className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-2/10\">\n                  <CheckCircle className=\"h-5 w-5 text-chart-2\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {displayProfiles.filter((p) => p.status === \"approved\").length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Approved Profiles</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Approved ICP profiles are active and being used to score accounts. Only approved profiles contribute to opportunity scoring calculations.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-chart-3/10\">\n                  <Clock className=\"h-5 w-5 text-chart-3\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {displayProfiles.filter((p) => p.status === \"draft\").length}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Draft Profiles</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Draft profiles are being refined before approval. Edit category expectations and thresholds, then approve when ready to activate.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-md bg-primary/10\">\n                  <Target className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-2xl font-bold\">\n                    {displayProfiles.reduce((sum, p) => sum + p.accountCount, 0)}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">Accounts Scored</p>\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button className=\"text-muted-foreground hover:text-foreground transition-colors\">\n                    <HelpCircle className=\"h-4 w-4\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs\">\n                  <p className=\"text-sm\">Total number of accounts that have been scored against their matching segment ICP profile to identify category gaps and opportunities.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <div className=\"lg:col-span-1 space-y-4\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base\">Segment Profiles</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              {isLoading ? (\n                [...Array(3)].map((_, i) => (\n                  <Skeleton key={i} className=\"h-16 w-full\" />\n                ))\n              ) : displayProfiles.length === 0 ? (\n                <EmptyState\n                  icon={Target}\n                  title=\"No profiles\"\n                  description=\"Create your first ICP profile\"\n                  testId=\"empty-profiles\"\n                />\n              ) : (\n                displayProfiles.map((profile) => (\n                  <button\n                    key={profile.id}\n                    onClick={() => {\n                      setSelectedProfile(profile);\n                      setEditMode(false);\n                    }}\n                    className={`w-full text-left p-3 rounded-md border transition-colors ${\n                      selectedProfile?.id === profile.id\n                        ? \"border-primary bg-primary/5\"\n                        : \"border-transparent hover:bg-muted/50\"\n                    }`}\n                    data-testid={`profile-${profile.segment.toLowerCase()}`}\n                  >\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"flex h-8 w-8 items-center justify-center rounded-md bg-muted\">\n                          <Target className=\"h-4 w-4\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium\">{profile.segment}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {profile.accountCount} accounts\n                          </p>\n                        </div>\n                      </div>\n                      <Badge\n                        variant={profile.status === \"approved\" ? \"default\" : \"secondary\"}\n                      >\n                        {profile.status}\n                      </Badge>\n                    </div>\n                  </button>\n                ))\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <Sparkles className=\"h-4 w-4\" />\n                  AI Analysis\n                </CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-ai-analysis\">\n                      <Info className=\"h-4 w-4\" />\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"left\" className=\"max-w-xs\">\n                    <p className=\"text-sm\">\n                      This AI tool analyzes your Class A (top-tier) customer purchasing data to identify patterns and generate Ideal Customer Profiles. Class A customers typically represent your highest-value accounts with complete category coverage.\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>\n                Generate suggested profiles from Class A customer data samples\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Button\n                className=\"w-full\"\n                variant=\"outline\"\n                disabled={isAnalyzing}\n                onClick={() => handleAnalyzeSegment(\"All Segments\")}\n                data-testid=\"button-analyze-all\"\n              >\n                {isAnalyzing ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Analyzing...\n                  </>\n                ) : (\n                  <>\n                    <RefreshCw className=\"mr-2 h-4 w-4\" />\n                    Analyze All Segments\n                  </>\n                )}\n              </Button>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"lg:col-span-2\">\n          {selectedProfile ? (\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle>{selectedProfile.name}</CardTitle>\n                    <CardDescription className=\"mt-1\">\n                      {selectedProfile.description}\n                    </CardDescription>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    {editMode ? (\n                      <>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={handleCancelEdit}\n                          disabled={isSaving}\n                        >\n                          Cancel\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          data-testid=\"button-save-profile\"\n                          onClick={handleSaveChanges}\n                          disabled={isSaving}\n                        >\n                          {isSaving ? (\n                            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                          ) : (\n                            <Save className=\"mr-2 h-4 w-4\" />\n                          )}\n                          {isSaving ? \"Saving...\" : \"Save Changes\"}\n                        </Button>\n                      </>\n                    ) : (\n                      <>\n                        <AlertDialog>\n                          <AlertDialogTrigger asChild>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              className=\"text-destructive hover:text-destructive\"\n                              data-testid=\"button-delete-profile\"\n                            >\n                              <Trash2 className=\"mr-2 h-4 w-4\" />\n                              Delete\n                            </Button>\n                          </AlertDialogTrigger>\n                          <AlertDialogContent>\n                            <AlertDialogHeader>\n                              <AlertDialogTitle>Delete Profile</AlertDialogTitle>\n                              <AlertDialogDescription>\n                                Are you sure you want to delete the \"{selectedProfile.name}\" profile? This action cannot be undone and will remove all associated category expectations.\n                              </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                              <AlertDialogCancel>Cancel</AlertDialogCancel>\n                              <AlertDialogAction\n                                onClick={() => deleteMutation.mutate(selectedProfile.id)}\n                                className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                                data-testid=\"button-confirm-delete\"\n                              >\n                                Delete\n                              </AlertDialogAction>\n                            </AlertDialogFooter>\n                          </AlertDialogContent>\n                        </AlertDialog>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={handleEnterEditMode}\n                          data-testid=\"button-edit-profile\"\n                        >\n                          <Edit2 className=\"mr-2 h-4 w-4\" />\n                          Edit\n                        </Button>\n                        {selectedProfile.status === \"draft\" && (\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Button\n                                size=\"sm\"\n                                onClick={() => approveMutation.mutate(selectedProfile.id)}\n                                data-testid=\"button-approve-profile\"\n                              >\n                                <CheckCircle className=\"mr-2 h-4 w-4\" />\n                                Approve\n                              </Button>\n                            </TooltipTrigger>\n                            <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                              Approving this profile activates it for opportunity scoring. Accounts in this segment will be scored based on these category expectations.\n                            </TooltipContent>\n                          </Tooltip>\n                        )}\n                      </>\n                    )}\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label className=\"text-sm text-muted-foreground\">\n                      Minimum Annual Revenue\n                    </Label>\n                    {editMode ? (\n                      <Input\n                        type=\"number\"\n                        value={editedMinRevenue}\n                        onChange={(e) => setEditedMinRevenue(Number(e.target.value))}\n                        className=\"mt-1\"\n                        data-testid=\"input-min-revenue\"\n                      />\n                    ) : (\n                      <p className=\"font-medium\">\n                        ${selectedProfile.minAnnualRevenue.toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                  <div>\n                    <Label className=\"text-sm text-muted-foreground\">Status</Label>\n                    <div className=\"mt-1\">\n                      <Badge\n                        variant={\n                          selectedProfile.status === \"approved\" ? \"default\" : \"secondary\"\n                        }\n                      >\n                        {selectedProfile.status}\n                      </Badge>\n                      {selectedProfile.approvedBy && (\n                        <span className=\"text-sm text-muted-foreground ml-2\">\n                          by {selectedProfile.approvedBy}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                </div>\n\n                <div>\n                  <Label className=\"text-sm font-semibold mb-3 block\">\n                    Category Expectations\n                  </Label>\n                  <div className=\"space-y-4\">\n                    {(editMode ? editedCategories : selectedProfile.categories).map((category) => {\n                      const editedCat = editedCategories.find(c => c.id === category.id);\n                      const displayPct = editMode && editedCat ? editedCat.expectedPct : category.expectedPct;\n                      const displayRequired = editMode && editedCat ? editedCat.isRequired : category.isRequired;\n                      \n                      return (\n                      <div\n                        key={category.id}\n                        className=\"p-4 rounded-md border bg-card\"\n                        data-testid={`category-card-${category.id}`}\n                      >\n                        <div className=\"flex items-start justify-between gap-4\">\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-2 mb-2\">\n                              <span className=\"font-medium\">{category.categoryName}</span>\n                              {displayRequired && (\n                                <Badge variant=\"destructive\" className=\"text-xs\">\n                                  Required\n                                </Badge>\n                              )}\n                              <Badge\n                                variant=\"outline\"\n                                className={getImportanceColor(category.importance)}\n                              >\n                                {getImportanceLabel(category.importance)} Priority\n                              </Badge>\n                            </div>\n                            <div className=\"flex items-center gap-4\">\n                              <div className=\"flex-1\">\n                                <div className=\"flex items-center justify-between text-sm mb-1\">\n                                  <span className=\"text-muted-foreground\">\n                                    Expected %\n                                  </span>\n                                  <span className=\"font-medium\">\n                                    {displayPct}%\n                                  </span>\n                                </div>\n                                {editMode ? (\n                                  <Slider\n                                    value={[displayPct]}\n                                    onValueChange={(value) => updateEditedCategory(category.id, 'expectedPct', value[0])}\n                                    max={100}\n                                    step={1}\n                                    data-testid={`slider-category-${category.id}`}\n                                  />\n                                ) : (\n                                  <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n                                    <div\n                                      className=\"h-full bg-primary rounded-full\"\n                                      style={{ width: `${category.expectedPct}%` }}\n                                    />\n                                  </div>\n                                )}\n                              </div>\n                              {editMode && (\n                                <div className=\"flex items-center gap-2\">\n                                  <Label className=\"text-xs\">Required</Label>\n                                  <Switch \n                                    checked={displayRequired}\n                                    onCheckedChange={(checked) => updateEditedCategory(category.id, 'isRequired', checked)}\n                                    data-testid={`switch-required-${category.id}`}\n                                  />\n                                </div>\n                              )}\n                            </div>\n                            {category.notes && (\n                              <p className=\"text-xs text-muted-foreground mt-2\">\n                                {category.notes}\n                              </p>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                      );\n                    })}\n                  </div>\n                </div>\n\n                {editMode && (\n                  <div className=\"space-y-2\">\n                    <Label>Notes</Label>\n                    <Textarea\n                      placeholder=\"Add notes about this profile...\"\n                      rows={3}\n                    />\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          ) : (\n            <Card>\n              <CardContent className=\"py-12\">\n                <EmptyState\n                  icon={Target}\n                  title=\"Select a profile\"\n                  description=\"Choose a segment profile from the list to view and edit its details\"\n                  testId=\"empty-profile-detail\"\n                />\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n        </TabsContent>\n\n        <TabsContent value=\"data-insights\" className=\"space-y-6\">\n          <div className=\"flex items-center gap-4 mb-6\">\n            <Label className=\"text-sm font-medium\">Analyzing Segment:</Label>\n            <div className=\"flex gap-2\">\n              {[\"HVAC\", \"Plumbing\", \"Mechanical\"].map((segment) => (\n                <Button\n                  key={segment}\n                  variant={selectedInsightSegment === segment ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => setSelectedInsightSegment(segment)}\n                  data-testid={`segment-btn-${segment.toLowerCase()}`}\n                >\n                  {segment}\n                </Button>\n              ))}\n            </div>\n          </div>\n\n          {isInsightsLoading ? (\n            <div className=\"space-y-6\">\n              <Skeleton className=\"h-48 w-full\" />\n              <Skeleton className=\"h-64 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n            </div>\n          ) : !dataInsights ? (\n            <Card>\n              <CardContent className=\"py-12\">\n                <EmptyState\n                  icon={Database}\n                  title=\"No data available\"\n                  description={`No Class A customer data found for the ${selectedInsightSegment} segment. Upload customer data to generate insights.`}\n                  testId=\"empty-insights\"\n                />\n              </CardContent>\n            </Card>\n          ) : (\n          <>\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-2\">\n                <Database className=\"h-5 w-5 text-primary\" />\n                <CardTitle className=\"text-lg\">Dataset Summary</CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-dataset-summary\">\n                      <HelpCircle className=\"h-4 w-4\" />\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"text-sm\">This section shows the Class A customer data that informed your ICP profiles. Class A customers are your top performers who demonstrate ideal purchasing patterns.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>\n                Class A customer data powering your ICP analysis\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n                <div className=\"p-4 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    <Users className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-sm text-muted-foreground\">Class A Customers</span>\n                  </div>\n                  <p className=\"text-2xl font-bold\">{dataInsights.datasetSummary.totalClassACustomers}</p>\n                </div>\n                <div className=\"p-4 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-sm text-muted-foreground\">Total Revenue</span>\n                  </div>\n                  <p className=\"text-2xl font-bold\">{formatCurrency(dataInsights.datasetSummary.totalRevenue)}</p>\n                </div>\n                <div className=\"p-4 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    <RefreshCw className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-sm text-muted-foreground\">Avg Categories</span>\n                  </div>\n                  <p className=\"text-2xl font-bold\">{dataInsights.datasetSummary.avgCategories}</p>\n                </div>\n                <div className=\"p-4 rounded-lg bg-muted/50\">\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                    <span className=\"text-sm text-muted-foreground\">Date Range</span>\n                  </div>\n                  <p className=\"text-lg font-bold\">{dataInsights.datasetSummary.dateRange}</p>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Segment Breakdown</Label>\n                <div className=\"grid grid-cols-3 gap-4\">\n                  {dataInsights.datasetSummary.segmentBreakdown.map((seg) => (\n                    <div key={seg.segment} className=\"p-3 rounded-lg border\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"font-medium\">{seg.segment}</span>\n                        <Badge variant=\"secondary\">{seg.count} customers</Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        Avg Revenue: {formatCurrency(seg.avgRevenue)}\n                      </p>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-2\">\n                <Brain className=\"h-5 w-5 text-chart-2\" />\n                <CardTitle className=\"text-lg\">AI Pattern Analysis</CardTitle>\n                {dataInsights.patternAnalysis.isEstimate && (\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    Derived from ICP targets\n                  </Badge>\n                )}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-pattern-analysis\">\n                      <HelpCircle className=\"h-4 w-4\" />\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"text-sm\">Pattern analysis is derived from your ICP profile targets combined with Class A customer metrics. Variance and correlation insights are estimated based on profile configuration.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>\n                What the AI discovered in your Class A customer data\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"p-4 rounded-lg bg-primary/5 border border-primary/20\">\n                <p className=\"text-sm leading-relaxed\">{dataInsights.patternAnalysis.summary}</p>\n              </div>\n\n              <div>\n                <Label className=\"text-sm font-medium mb-3 block\">Category Purchasing Patterns</Label>\n                <div className=\"space-y-3\">\n                  {dataInsights.patternAnalysis.categoryPatterns.map((pattern) => (\n                    <div key={pattern.category} className=\"flex items-center gap-4 p-3 rounded-lg border\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center justify-between mb-1\">\n                          <span className=\"font-medium\">{pattern.category}</span>\n                          <span className=\"text-sm font-bold\">{pattern.avgPct}%</span>\n                        </div>\n                        <Progress value={pattern.avgPct} className=\"h-2\" />\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-xs text-muted-foreground\">Ïƒ = {pattern.stdDev}%</p>\n                        <Badge variant=\"outline\" className=\"text-xs mt-1\">{pattern.correlation}</Badge>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-2\">\n                <Lightbulb className=\"h-5 w-5 text-chart-3\" />\n                <CardTitle className=\"text-lg\">ICP Decision Logic</CardTitle>\n                {dataInsights.decisionLogic.isEstimate && (\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    Derived from ICP targets\n                  </Badge>\n                )}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-decision-logic\">\n                      <HelpCircle className=\"h-4 w-4\" />\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"text-sm\">{dataInsights.decisionLogic.note || \"This explains why each category percentage was chosen for your ICP profile. Values are derived from ICP profile targets with confidence based on Class A account data.\"}</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>\n                Why each ICP percentage was chosen\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {dataInsights.decisionLogic.items.map((logic) => (\n                  <Collapsible key={logic.category}>\n                    <div className=\"p-4 rounded-lg border\">\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-3 mb-2\">\n                            <span className=\"font-semibold\">{logic.category}</span>\n                            <Badge className=\"bg-primary/10 text-primary border-primary/20\">\n                              Target: {logic.expectedPct}%\n                            </Badge>\n                            {getConfidenceBadge(logic.confidence)}\n                          </div>\n                          <p className=\"text-sm text-muted-foreground\">{logic.reasoning}</p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-xs text-muted-foreground\">Based on</p>\n                          <p className=\"font-medium\">{logic.dataPoints} data points</p>\n                        </div>\n                      </div>\n                      \n                      {logic.dataPointsDetail && logic.dataPointsDetail.length > 0 && (\n                        <>\n                          <CollapsibleTrigger asChild>\n                            <Button \n                              variant=\"ghost\" \n                              size=\"sm\" \n                              className=\"mt-3 w-full justify-between text-muted-foreground hover:text-foreground\"\n                              data-testid={`toggle-datapoints-${logic.category.replace(/\\s+/g, '-').toLowerCase()}`}\n                            >\n                              <span className=\"flex items-center gap-2\">\n                                <Database className=\"h-3 w-3\" />\n                                View Class A Customer Data ({logic.dataPointsDetail.length} accounts)\n                              </span>\n                              <ChevronDown className=\"h-4 w-4 transition-transform duration-200 group-data-[state=open]:rotate-180\" />\n                            </Button>\n                          </CollapsibleTrigger>\n                          \n                          <CollapsibleContent className=\"mt-3\">\n                            <div className=\"bg-muted/30 rounded-lg p-4 space-y-4\">\n                              <div className=\"grid grid-cols-4 gap-4 pb-3 border-b\">\n                                <div>\n                                  <p className=\"text-xs text-muted-foreground\">Avg Actual %</p>\n                                  <p className=\"text-lg font-semibold\">{logic.statistics.avgActualPct}%</p>\n                                </div>\n                                <div>\n                                  <p className=\"text-xs text-muted-foreground\">Range</p>\n                                  <p className=\"text-lg font-semibold\">{logic.statistics.minPct}% - {logic.statistics.maxPct}%</p>\n                                </div>\n                                <div>\n                                  <p className=\"text-xs text-muted-foreground\">Target</p>\n                                  <p className=\"text-lg font-semibold\">{logic.statistics.targetPct}%</p>\n                                </div>\n                                <div>\n                                  <p className=\"text-xs text-muted-foreground\">Variance</p>\n                                  <p className={`text-lg font-semibold ${logic.statistics.variance >= 0 ? 'text-green-600' : 'text-destructive'}`}>\n                                    {logic.statistics.variance >= 0 ? '+' : ''}{logic.statistics.variance}%\n                                  </p>\n                                </div>\n                              </div>\n                              \n                              <div>\n                                <p className=\"text-sm font-medium mb-2\">Class A Customer Breakdown</p>\n                                <div className=\"space-y-2\">\n                                  {logic.dataPointsDetail.map((dp) => (\n                                    <div \n                                      key={dp.accountId} \n                                      className=\"flex items-center justify-between p-2 rounded-md bg-background\"\n                                      data-testid={`datapoint-${dp.accountId}`}\n                                    >\n                                      <div className=\"flex items-center gap-2\">\n                                        <Users className=\"h-3 w-3 text-muted-foreground\" />\n                                        <span className=\"text-sm font-medium\">{dp.accountName}</span>\n                                      </div>\n                                      <div className=\"flex items-center gap-4\">\n                                        <div className=\"text-right\">\n                                          <p className=\"text-xs text-muted-foreground\">Category %</p>\n                                          <p className=\"text-sm font-medium\">{dp.actualPct}%</p>\n                                        </div>\n                                        <div className=\"text-right\">\n                                          <p className=\"text-xs text-muted-foreground\">Revenue</p>\n                                          <p className=\"text-sm font-medium\">{formatCurrency(dp.revenue)}</p>\n                                        </div>\n                                      </div>\n                                    </div>\n                                  ))}\n                                </div>\n                              </div>\n                              \n                              <p className=\"text-xs text-muted-foreground pt-2 border-t\">\n                                These Class A customers (revenue â‰¥ minimum threshold) inform the ICP target percentage. \n                                Higher variance suggests the category may need segment-specific adjustments.\n                              </p>\n                            </div>\n                          </CollapsibleContent>\n                        </>\n                      )}\n                    </div>\n                  </Collapsible>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Target className=\"h-5 w-5 text-chart-1\" />\n                  <CardTitle className=\"text-lg\">Segment Health Score</CardTitle>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-segment-health\">\n                        <HelpCircle className=\"h-4 w-4\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"text-sm\">This measures how well your current accounts align with the ICP. Higher scores mean more accounts are purchasing the expected category mix.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"flex items-center gap-6 mb-6\">\n                  <div className=\"relative\">\n                    <svg className=\"w-24 h-24 transform -rotate-90\">\n                      <circle\n                        className=\"text-muted\"\n                        strokeWidth=\"8\"\n                        stroke=\"currentColor\"\n                        fill=\"transparent\"\n                        r=\"40\"\n                        cx=\"48\"\n                        cy=\"48\"\n                      />\n                      <circle\n                        className=\"text-chart-2\"\n                        strokeWidth=\"8\"\n                        strokeDasharray={251.2}\n                        strokeDashoffset={251.2 * (1 - dataInsights.segmentHealth.alignmentScore / 100)}\n                        strokeLinecap=\"round\"\n                        stroke=\"currentColor\"\n                        fill=\"transparent\"\n                        r=\"40\"\n                        cx=\"48\"\n                        cy=\"48\"\n                      />\n                    </svg>\n                    <span className=\"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold\">\n                      {dataInsights.segmentHealth.alignmentScore}%\n                    </span>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Overall ICP Alignment</p>\n                    <p className=\"font-medium\">\n                      {dataInsights.segmentHealth.accountsNearICP} accounts near ICP\n                      {dataInsights.methodology && (\n                        <span className=\"text-xs text-muted-foreground ml-1\">\n                          (â‰¤{dataInsights.methodology.nearICPThreshold}% avg gap)\n                        </span>\n                      )}\n                    </p>\n                    <p className=\"text-sm text-destructive mt-1\">\n                      {formatCurrency(dataInsights.segmentHealth.revenueAtRisk)} revenue at risk\n                    </p>\n                  </div>\n                </div>\n\n                <div>\n                  <Label className=\"text-sm font-medium mb-2 block\">Top Category Gaps</Label>\n                  <div className=\"space-y-2\">\n                    {dataInsights.segmentHealth.topGaps.map((gap) => (\n                      <div key={gap.category} className=\"flex items-center justify-between p-2 rounded-md bg-destructive/5\">\n                        <span className=\"text-sm\">{gap.category}</span>\n                        <Badge variant=\"destructive\">{gap.gapPct}% gap</Badge>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <div className=\"flex items-center gap-2\">\n                  <Zap className=\"h-5 w-5 text-chart-3\" />\n                  <CardTitle className=\"text-lg\">Quick Wins</CardTitle>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-quick-wins\">\n                        <HelpCircle className=\"h-4 w-4\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"text-sm\">Accounts that are close to ICP alignment with just 1-2 category gaps. These represent the easiest revenue opportunities to capture.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  {dataInsights.actionableInsights.quickWins.map((win, idx) => (\n                    <div key={idx} className=\"flex items-center justify-between p-3 rounded-lg border hover:bg-muted/50 transition-colors\">\n                      <div>\n                        <p className=\"font-medium\">{win.account}</p>\n                        <p className=\"text-sm text-muted-foreground\">Gap: {win.category}</p>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"font-bold text-chart-2\">{formatCurrency(win.potentialRevenue)}</p>\n                        <p className=\"text-xs text-muted-foreground\">potential</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5 text-chart-2\" />\n                <CardTitle className=\"text-lg\">Actionable Intelligence</CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button className=\"text-muted-foreground hover:text-foreground transition-colors\" data-testid=\"tooltip-actionable-intel\">\n                      <HelpCircle className=\"h-4 w-4\" />\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"text-sm\">Strategic insights derived from your ICP analysis, including cross-sell opportunities, territory performance, and projected revenue lift.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Cross-Sell Opportunities</Label>\n                  <div className=\"space-y-2\">\n                    {dataInsights.actionableInsights.crossSellOpps.map((opp, idx) => (\n                      <div key={idx} className=\"p-3 rounded-lg bg-muted/50\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          {opp.categories.map((cat, i) => (\n                            <span key={i}>\n                              <Badge variant=\"outline\" className=\"text-xs\">{cat}</Badge>\n                              {i < opp.categories.length - 1 && <ArrowRight className=\"inline h-3 w-3 mx-1\" />}\n                            </span>\n                          ))}\n                        </div>\n                        <p className=\"text-xs text-muted-foreground mt-2\">{opp.frequency}% of Class A buy together</p>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Territory Ranking</Label>\n                  <div className=\"space-y-2\">\n                    {dataInsights.actionableInsights.territoryRanking.map((tm, idx) => (\n                      <div key={idx} className=\"flex items-center justify-between p-2 rounded-lg border\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"w-5 h-5 rounded-full bg-primary/10 flex items-center justify-center text-xs font-bold\">\n                            {idx + 1}\n                          </span>\n                          <span className=\"text-sm font-medium\">{tm.tm}</span>\n                        </div>\n                        <div className=\"text-right\">\n                          <span className=\"text-sm font-bold text-chart-2\">{tm.avgAlignment}%</span>\n                          <p className=\"text-xs text-muted-foreground\">{tm.accountCount} accounts</p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <div>\n                  <Label className=\"text-sm font-medium mb-3 block\">Revenue Impact</Label>\n                  <div className=\"p-4 rounded-lg bg-chart-2/10 border border-chart-2/20\">\n                    <p className=\"text-sm text-muted-foreground mb-2\">If all accounts matched ICP:</p>\n                    <p className=\"text-3xl font-bold text-chart-2\">{formatCurrency(dataInsights.actionableInsights.projectedLift)}</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">projected incremental revenue</p>\n                    <Badge variant=\"outline\" className=\"mt-2 text-xs\">Estimate based on gap analysis</Badge>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          </>\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","path":null,"size_bytes":58626,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n\n  /* Automatic computation of border around primary / danger buttons */\n  --opaque-button-border-intensity: -8; /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n\n  --background: 210 20% 98%;\n\n  --foreground: 215 25% 12%;\n\n  --border: 214 15% 91%;\n\n  --card: 0 0% 100%;\n\n  --card-foreground: 215 25% 12%;\n\n  --card-border: 214 15% 91%;\n\n  --sidebar: 213 25% 96%;\n\n  --sidebar-foreground: 215 25% 20%;\n\n  --sidebar-border: 214 15% 89%;\n\n  --sidebar-primary: 217 72% 52%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 214 20% 92%;\n\n  --sidebar-accent-foreground: 215 25% 15%;\n\n  --sidebar-ring: 217 72% 52%;\n\n  --popover: 0 0% 100%;\n\n  --popover-foreground: 215 25% 12%;\n\n  --popover-border: 214 15% 91%;\n\n  --primary: 217 72% 52%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 214 15% 93%;\n\n  --secondary-foreground: 215 25% 20%;\n\n  --muted: 214 15% 95%;\n\n  --muted-foreground: 215 10% 45%;\n\n  --accent: 214 20% 92%;\n\n  --accent-foreground: 215 25% 15%;\n\n  --destructive: 0 72% 51%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 214 15% 85%;\n  --ring: 217 72% 52%;\n  --chart-1: 217 72% 52%;\n  --chart-2: 160 60% 45%;\n  --chart-3: 30 80% 55%;\n  --chart-4: 280 55% 55%;\n  --chart-5: 340 65% 55%;\n\n  --font-sans: 'Inter', sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: .5rem; /* 8px */\n  --shadow-2xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00); /*replace with H S L */\n  --shadow-xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00); /*replace with H S L */\n  --shadow-sm: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 2px 4px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 4px 6px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 8px 10px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n  /* Automatically computed borders - intensity can be controlled by the user by the --opaque-button-border-intensity setting */\n\n  /* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n\n  --opaque-button-border-intensity: 9;  /* In terms of percentages */\n\n  /* Backgrounds applied on top of other backgrounds when hovered/active */\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n\n  --background: 220 20% 10%;\n\n  --foreground: 210 15% 90%;\n\n  --border: 215 15% 20%;\n\n  --card: 220 18% 13%;\n\n  --card-foreground: 210 15% 90%;\n\n  --card-border: 215 15% 20%;\n\n  --sidebar: 220 20% 11%;\n\n  --sidebar-foreground: 210 15% 85%;\n\n  --sidebar-border: 215 15% 18%;\n\n  --sidebar-primary: 217 72% 55%;\n\n  --sidebar-primary-foreground: 0 0% 100%;\n\n  --sidebar-accent: 215 15% 18%;\n\n  --sidebar-accent-foreground: 210 15% 90%;\n\n  --sidebar-ring: 217 72% 55%;\n\n  --popover: 220 18% 13%;\n\n  --popover-foreground: 210 15% 90%;\n\n  --popover-border: 215 15% 20%;\n\n  --primary: 217 72% 55%;\n\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 215 15% 18%;\n\n  --secondary-foreground: 210 15% 85%;\n\n  --muted: 215 15% 16%;\n\n  --muted-foreground: 215 10% 55%;\n\n  --accent: 215 15% 18%;\n\n  --accent-foreground: 210 15% 90%;\n\n  --destructive: 0 62% 50%;\n\n  --destructive-foreground: 0 0% 100%;\n\n  --input: 215 15% 28%;\n  --ring: 217 72% 55%;\n  --chart-1: 217 72% 55%;\n  --chart-2: 160 55% 50%;\n  --chart-3: 30 75% 55%;\n  --chart-4: 280 50% 60%;\n  --chart-5: 340 60% 55%;\n\n  --shadow-2xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xs: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-sm: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 1px 2px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-md: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 2px 4px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-lg: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 4px 6px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00), 0px 8px 10px -1px hsl(202.8169 89.1213% 53.1373% / 0.00);\n  --shadow-2xl: 0px 2px 0px 0px hsl(202.8169 89.1213% 53.1373% / 0.00);\n\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","path":null,"size_bytes":10298,"size_tokens":null},"server/types/express.d.ts":{"content":"import type { TenantContext } from \"../middleware/tenantContext\";\n\nexport interface UserClaims {\n  sub: string;\n  email?: string;\n  first_name?: string;\n  last_name?: string;\n  profile_image_url?: string;\n  exp?: number;\n}\n\nexport interface AuthenticatedUser {\n  claims?: UserClaims;\n  access_token?: string;\n  refresh_token?: string;\n  expires_at?: number;\n}\n\ndeclare global {\n  namespace Express {\n    interface User extends AuthenticatedUser {}\n    \n    interface Request {\n      tenantContext?: TenantContext;\n    }\n  }\n}\n","path":null,"size_bytes":526,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/theme-toggle.tsx":{"content":"import { Moon, Sun } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { useTheme } from \"@/components/theme-provider\";\n\nexport function ThemeToggle() {\n  const { theme, setTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      onClick={() => setTheme(theme === \"light\" ? \"dark\" : \"light\")}\n      data-testid=\"button-theme-toggle\"\n    >\n      <Sun className=\"h-4 w-4 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n      <Moon className=\"absolute h-4 w-4 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n      <span className=\"sr-only\">Toggle theme</span>\n    </Button>\n  );\n}\n","path":null,"size_bytes":677,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState, useRef, useEffect, useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Tabs,\n  TabsContent,\n  TabsList,\n  TabsTrigger,\n} from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport type { TerritoryManager } from \"@shared/schema\";\nimport {\n  Settings,\n  Database,\n  Brain,\n  Mail,\n  Shield,\n  Save,\n  RefreshCw,\n  CheckCircle,\n  AlertCircle,\n  Sliders,\n  FileText,\n  Users,\n  Plus,\n  Pencil,\n  Trash2,\n  Upload,\n  X,\n  Image,\n  Target,\n  DollarSign,\n  Layers,\n  RotateCcw,\n  HelpCircle,\n  ChevronDown,\n  ChevronRight,\n  BookOpen,\n  TrendingUp,\n  Calendar,\n  Clock,\n} from \"lucide-react\";\nimport {\n  LineChart,\n  Line,\n  BarChart,\n  Bar,\n  XAxis,\n  YAxis,\n  CartesianGrid,\n  Tooltip as RechartsTooltip,\n  ResponsiveContainer,\n  Legend,\n} from \"recharts\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface Setting {\n  key: string;\n  value: string | null;\n}\n\ninterface ScoringWeights {\n  id: number;\n  name: string;\n  gapSizeWeight: number;\n  revenuePotentialWeight: number;\n  categoryCountWeight: number;\n  description: string;\n  isActive: boolean;\n}\n\nconst DEFAULT_WEIGHTS = {\n  gapSizeWeight: 40,\n  revenuePotentialWeight: 30,\n  categoryCountWeight: 30,\n};\n\nconst territoryManagerFormSchema = z.object({\n  name: z.string().min(1, \"Name is required\"),\n  email: z.string().email(\"Invalid email address\"),\n  territories: z.string(),\n  isActive: z.boolean().default(true),\n});\n\ntype TerritoryManagerFormValues = z.infer<typeof territoryManagerFormSchema>;\n\ninterface CustomCategory {\n  id: number;\n  name: string;\n  displayOrder: number;\n  isActive: boolean;\n}\n\ninterface RevenueSnapshot {\n  period: string;\n  baselineRevenue: number;\n  actualRevenue: number;\n  incrementalRevenue: number;\n  feeAmount: number;\n}\n\ninterface EnrolledAccountSummary {\n  id: number;\n  accountName: string;\n  incrementalRevenue: number;\n  feeAmount: number;\n  status: string;\n}\n\ninterface RevShareTier {\n  id: number;\n  minRevenue: string;\n  maxRevenue: string | null;\n  shareRate: string;\n  displayOrder: number | null;\n  isActive: boolean | null;\n}\n\ninterface FeeCalculation {\n  incrementalRevenue: number;\n  totalFee: number;\n  effectiveRate: number;\n  breakdown: Array<{ tier: string; rate: number; revenueInTier: number; fee: number }>;\n}\n\nfunction RevenueTrackingManager() {\n  const { toast } = useToast();\n  const [isAddTierOpen, setIsAddTierOpen] = useState(false);\n  const [editingTier, setEditingTier] = useState<RevShareTier | null>(null);\n  const [newTierMin, setNewTierMin] = useState(\"\");\n  const [newTierMax, setNewTierMax] = useState(\"\");\n  const [newTierRate, setNewTierRate] = useState(\"\");\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat(\"en-US\", {\n      style: \"currency\",\n      currency: \"USD\",\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(value);\n  };\n\n  const { data: enrolledAccounts } = useQuery<EnrolledAccountSummary[]>({\n    queryKey: [\"/api/program-accounts\"],\n  });\n\n  const { data: tiers = [], isLoading: tiersLoading } = useQuery<RevShareTier[]>({\n    queryKey: [\"/api/rev-share-tiers\"],\n  });\n\n  // Calculate tiered fee for a given revenue amount\n  // Uses proper tier boundary calculation: revenueInTier = max(0, min(revenue, maxRev) - minRev)\n  const calculateTieredFee = (revenue: number): { totalFee: number; breakdown: Array<{ tier: string; rate: number; revenueInTier: number; fee: number }> } => {\n    if (revenue <= 0) {\n      return { totalFee: 0, breakdown: [] };\n    }\n    \n    if (tiers.length === 0) {\n      // Default to 15% if no tiers\n      const fee = revenue * 0.15;\n      return { \n        totalFee: fee, \n        breakdown: [{ tier: \"$0+\", rate: 15, revenueInTier: revenue, fee }] \n      };\n    }\n\n    const activeTiers = tiers\n      .filter(t => t.isActive)\n      .sort((a, b) => parseFloat(a.minRevenue) - parseFloat(b.minRevenue));\n\n    if (activeTiers.length === 0) {\n      const fee = revenue * 0.15;\n      return { \n        totalFee: fee, \n        breakdown: [{ tier: \"$0+\", rate: 15, revenueInTier: revenue, fee }] \n      };\n    }\n\n    let totalFee = 0;\n    const breakdown: Array<{ tier: string; rate: number; revenueInTier: number; fee: number }> = [];\n\n    for (const tier of activeTiers) {\n      const minRev = parseFloat(tier.minRevenue);\n      const maxRev = tier.maxRevenue ? parseFloat(tier.maxRevenue) : Infinity;\n      const rate = parseFloat(tier.shareRate);\n\n      // Skip tiers where revenue hasn't reached the minimum threshold\n      if (revenue <= minRev) continue;\n\n      // Calculate how much revenue falls into this tier's range\n      // revenueInTier = max(0, min(revenue, maxRev) - minRev)\n      const cappedRevenue = Math.min(revenue, maxRev);\n      const revenueInTier = Math.max(0, cappedRevenue - minRev);\n\n      if (revenueInTier > 0) {\n        const fee = revenueInTier * (rate / 100);\n        totalFee += fee;\n        breakdown.push({\n          tier: `${formatCurrency(minRev)} - ${maxRev === Infinity ? \"Unlimited\" : formatCurrency(maxRev)}`,\n          rate,\n          revenueInTier,\n          fee,\n        });\n      }\n    }\n\n    return { totalFee, breakdown };\n  };\n\n  const activeAccounts = enrolledAccounts?.filter(a => a.status === \"active\") || [];\n  const totalIncremental = activeAccounts.reduce((sum, a) => sum + (a.incrementalRevenue || 0), 0);\n\n  const { data: feeCalculation } = useQuery<FeeCalculation>({\n    queryKey: [\"/api/rev-share-tiers/calculate\", totalIncremental],\n    queryFn: async () => {\n      const res = await fetch(\"/api/rev-share-tiers/calculate\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ incrementalRevenue: totalIncremental }),\n      });\n      if (!res.ok) throw new Error(\"Failed to calculate fees\");\n      return res.json();\n    },\n    enabled: totalIncremental >= 0,\n  });\n\n  const createTierMutation = useMutation({\n    mutationFn: async (data: { minRevenue: string; maxRevenue: string | null; shareRate: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/rev-share-tiers\", {\n        ...data,\n        displayOrder: tiers.length,\n        isActive: true,\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/rev-share-tiers\"] });\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === \"/api/rev-share-tiers/calculate\" \n      });\n      setIsAddTierOpen(false);\n      setNewTierMin(\"\");\n      setNewTierMax(\"\");\n      setNewTierRate(\"\");\n      toast({ title: \"Tier created\", description: \"New pricing tier has been added.\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to create tier\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTierMutation = useMutation({\n    mutationFn: async ({ id, ...data }: { id: number; minRevenue?: string; maxRevenue?: string | null; shareRate?: string }) => {\n      const res = await apiRequest(\"PUT\", `/api/rev-share-tiers/${id}`, data);\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/rev-share-tiers\"] });\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === \"/api/rev-share-tiers/calculate\" \n      });\n      setEditingTier(null);\n      toast({ title: \"Tier updated\", description: \"Pricing tier has been updated.\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to update tier\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteTierMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/rev-share-tiers/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/rev-share-tiers\"] });\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === \"/api/rev-share-tiers/calculate\" \n      });\n      toast({ title: \"Tier deleted\", description: \"Pricing tier has been removed.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to delete tier\", variant: \"destructive\" });\n    },\n  });\n\n  const seedDefaultMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/rev-share-tiers/seed-default\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/rev-share-tiers\"] });\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          Array.isArray(query.queryKey) && \n          query.queryKey[0] === \"/api/rev-share-tiers/calculate\" \n      });\n      toast({ title: \"Default tier created\", description: \"A 15% flat rate tier has been added.\" });\n    },\n  });\n\n  const handleAddTier = () => {\n    if (!newTierMin || !newTierRate) {\n      toast({ title: \"Error\", description: \"Min revenue and rate are required\", variant: \"destructive\" });\n      return;\n    }\n    const minVal = parseFloat(newTierMin);\n    const maxVal = newTierMax ? parseFloat(newTierMax) : null;\n    const rateVal = parseFloat(newTierRate);\n    \n    if (isNaN(minVal) || minVal < 0) {\n      toast({ title: \"Error\", description: \"Minimum revenue must be a non-negative number\", variant: \"destructive\" });\n      return;\n    }\n    if (maxVal !== null && maxVal <= minVal) {\n      toast({ title: \"Error\", description: \"Maximum revenue must be greater than minimum\", variant: \"destructive\" });\n      return;\n    }\n    if (isNaN(rateVal) || rateVal < 0 || rateVal > 100) {\n      toast({ title: \"Error\", description: \"Rate must be between 0 and 100\", variant: \"destructive\" });\n      return;\n    }\n    \n    createTierMutation.mutate({\n      minRevenue: newTierMin,\n      maxRevenue: newTierMax || null,\n      shareRate: newTierRate,\n    });\n  };\n\n  const handleUpdateTier = () => {\n    if (!editingTier) return;\n    \n    const minVal = parseFloat(editingTier.minRevenue);\n    const maxVal = editingTier.maxRevenue ? parseFloat(editingTier.maxRevenue) : null;\n    const rateVal = parseFloat(editingTier.shareRate);\n    \n    if (isNaN(minVal) || minVal < 0) {\n      toast({ title: \"Error\", description: \"Minimum revenue must be a non-negative number\", variant: \"destructive\" });\n      return;\n    }\n    if (maxVal !== null && maxVal <= minVal) {\n      toast({ title: \"Error\", description: \"Maximum revenue must be greater than minimum\", variant: \"destructive\" });\n      return;\n    }\n    if (isNaN(rateVal) || rateVal < 0 || rateVal > 100) {\n      toast({ title: \"Error\", description: \"Rate must be between 0 and 100\", variant: \"destructive\" });\n      return;\n    }\n    \n    updateTierMutation.mutate({\n      id: editingTier.id,\n      minRevenue: editingTier.minRevenue,\n      maxRevenue: editingTier.maxRevenue,\n      shareRate: editingTier.shareRate,\n    });\n  };\n\n  const totalFees = feeCalculation?.totalFee || 0;\n  const effectiveRate = feeCalculation?.effectiveRate || 15;\n  \n  const today = new Date();\n  const nextBillingDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);\n  const daysUntilBilling = Math.ceil((nextBillingDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n\n  const mockRevenueData: RevenueSnapshot[] = [\n    { period: \"Aug\", baselineRevenue: 56000, actualRevenue: 58000, incrementalRevenue: 2000, feeAmount: 300 },\n    { period: \"Sep\", baselineRevenue: 58000, actualRevenue: 65000, incrementalRevenue: 7000, feeAmount: 1050 },\n    { period: \"Oct\", baselineRevenue: 55000, actualRevenue: 72000, incrementalRevenue: 17000, feeAmount: 2550 },\n    { period: \"Nov\", baselineRevenue: 62000, actualRevenue: 85000, incrementalRevenue: 23000, feeAmount: 3450 },\n    { period: \"Dec\", baselineRevenue: 48000, actualRevenue: 78000, incrementalRevenue: 30000, feeAmount: 4500 },\n    { period: \"Jan\", baselineRevenue: 52000, actualRevenue: 94000, incrementalRevenue: 42000, feeAmount: 6300 },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Tiered Pricing Configuration */}\n      <Card data-testid=\"card-tiered-pricing\">\n        <CardHeader className=\"flex flex-row items-center justify-between gap-2 flex-wrap\">\n          <div>\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <Layers className=\"h-4 w-4\" />\n              Rev-Share Tiers\n            </CardTitle>\n            <CardDescription>\n              Configure volume-based pricing tiers for calculating fees\n            </CardDescription>\n          </div>\n          <Button size=\"sm\" onClick={() => setIsAddTierOpen(true)} data-testid=\"button-add-tier\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add Tier\n          </Button>\n        </CardHeader>\n        <CardContent>\n          {tiersLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <RefreshCw className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n            </div>\n          ) : tiers.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <Layers className=\"mx-auto h-8 w-8 text-muted-foreground mb-2\" />\n              <p className=\"text-muted-foreground mb-4\">No pricing tiers defined yet.</p>\n              <Button variant=\"outline\" onClick={() => seedDefaultMutation.mutate()} data-testid=\"button-seed-default\">\n                Create Default 15% Tier\n              </Button>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Revenue Range</TableHead>\n                  <TableHead className=\"text-right\">Rate</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {tiers\n                  .filter(t => t.isActive)\n                  .sort((a, b) => parseFloat(a.minRevenue) - parseFloat(b.minRevenue))\n                  .map((tier) => (\n                    <TableRow key={tier.id} data-testid={`row-tier-${tier.id}`}>\n                      <TableCell>\n                        {formatCurrency(parseFloat(tier.minRevenue))} - {tier.maxRevenue ? formatCurrency(parseFloat(tier.maxRevenue)) : \"Unlimited\"}\n                      </TableCell>\n                      <TableCell className=\"text-right font-medium\">\n                        {parseFloat(tier.shareRate)}%\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex items-center justify-end gap-1\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setEditingTier(tier)}\n                            data-testid={`button-edit-tier-${tier.id}`}\n                          >\n                            <Pencil className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => deleteTierMutation.mutate(tier.id)}\n                            data-testid={`button-delete-tier-${tier.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card className=\"border-primary/20 bg-primary/5\" data-testid=\"card-billing-cycle\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"h-5 w-5 text-primary\" />\n            Next Billing Cycle\n          </CardTitle>\n          <CardDescription>\n            Amount owed to Tenexity at the next billing date\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-6 md:grid-cols-3\">\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <Clock className=\"h-4 w-4\" />\n                Billing Date\n              </div>\n              <p className=\"text-2xl font-bold\" data-testid=\"text-billing-date\">\n                {nextBillingDate.toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" })}\n              </p>\n              <p className=\"text-sm text-muted-foreground\" data-testid=\"text-days-remaining\">\n                {daysUntilBilling} days remaining\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <TrendingUp className=\"h-4 w-4\" />\n                Total Incremental Revenue\n              </div>\n              <p className=\"text-2xl font-bold text-chart-2\" data-testid=\"text-current-incremental\">\n                {formatCurrency(totalIncremental)}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                Revenue above baseline\n              </p>\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                <DollarSign className=\"h-4 w-4\" />\n                Amount Due to Tenexity\n              </div>\n              <p className=\"text-2xl font-bold text-primary\" data-testid=\"text-amount-due\">\n                {formatCurrency(totalFees)}\n              </p>\n              <p className=\"text-sm text-muted-foreground\">\n                Calculated using tiered pricing\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Fee Breakdown by Tier */}\n      {feeCalculation && feeCalculation.breakdown.length > 0 && (\n        <Card data-testid=\"card-tier-breakdown\">\n          <CardHeader>\n            <CardTitle className=\"text-base\">Fee Calculation Breakdown</CardTitle>\n            <CardDescription>How your total fee is calculated across pricing tiers</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Tier Range</TableHead>\n                  <TableHead className=\"text-right\">Rate</TableHead>\n                  <TableHead className=\"text-right\">Revenue in Tier</TableHead>\n                  <TableHead className=\"text-center\">Calculation</TableHead>\n                  <TableHead className=\"text-right\">Fee</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {feeCalculation.breakdown.map((item, idx) => (\n                  <TableRow key={idx}>\n                    <TableCell className=\"font-medium\">{item.tier}</TableCell>\n                    <TableCell className=\"text-right\">{item.rate}%</TableCell>\n                    <TableCell className=\"text-right\">{formatCurrency(item.revenueInTier)}</TableCell>\n                    <TableCell className=\"text-center text-sm text-muted-foreground\">\n                      {formatCurrency(item.revenueInTier)} Ã— {item.rate}%\n                    </TableCell>\n                    <TableCell className=\"text-right font-medium text-primary\">{formatCurrency(item.fee)}</TableCell>\n                  </TableRow>\n                ))}\n                <TableRow className=\"bg-muted/50\">\n                  <TableCell colSpan={3} className=\"font-bold\">Total Fee</TableCell>\n                  <TableCell className=\"text-center font-bold text-muted-foreground\">Sum of all tiers</TableCell>\n                  <TableCell className=\"text-right font-bold text-primary\">{formatCurrency(totalFees)}</TableCell>\n                </TableRow>\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card data-testid=\"card-fees-summary\">\n          <CardHeader>\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <TrendingUp className=\"h-4 w-4\" />\n              Total Fees Summary\n            </CardTitle>\n            <CardDescription>\n              Cumulative fees owed to Tenexity\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between py-3 border-b\">\n              <div>\n                <p className=\"font-medium\">Total Incremental Revenue</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  From {activeAccounts.length} active enrolled accounts\n                </p>\n              </div>\n              <p className=\"text-xl font-bold text-chart-2\" data-testid=\"text-total-incremental\">\n                {formatCurrency(totalIncremental)}\n              </p>\n            </div>\n            <div className=\"flex items-center justify-between py-3 border-b\">\n              <div>\n                <p className=\"font-medium\">Pricing Tiers</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  {tiers.filter(t => t.isActive).length} active tier{tiers.filter(t => t.isActive).length !== 1 ? \"s\" : \"\"} configured\n                </p>\n              </div>\n              <p className=\"text-xl font-bold\" data-testid=\"text-revshare-rate\">\n                {tiers.filter(t => t.isActive).length > 0 \n                  ? `${tiers.filter(t => t.isActive).map(t => `${parseFloat(t.shareRate)}%`).join(\", \")}`\n                  : \"15% default\"\n                }\n              </p>\n            </div>\n            <div className=\"flex items-center justify-between py-3\">\n              <div>\n                <p className=\"font-medium\">Total Fees Owed</p>\n                <p className=\"text-sm text-muted-foreground\">\n                  Cumulative amount to Tenexity\n                </p>\n              </div>\n              <p className=\"text-2xl font-bold text-primary\" data-testid=\"text-total-fees\">\n                {formatCurrency(totalFees)}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"card-monthly-fees\">\n          <CardHeader>\n            <CardTitle className=\"text-base\">Monthly Fee Revenue</CardTitle>\n            <CardDescription>Rev-share fees by month</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-64\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <BarChart data={mockRevenueData}>\n                  <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                  <XAxis\n                    dataKey=\"period\"\n                    tick={{ fill: \"hsl(var(--muted-foreground))\", fontSize: 12 }}\n                    axisLine={{ stroke: \"hsl(var(--border))\" }}\n                  />\n                  <YAxis\n                    tickFormatter={(value) => formatCurrency(value)}\n                    tick={{ fill: \"hsl(var(--muted-foreground))\", fontSize: 12 }}\n                    axisLine={{ stroke: \"hsl(var(--border))\" }}\n                  />\n                  <RechartsTooltip\n                    formatter={(value: number) => [formatCurrency(value), \"Fee\"]}\n                    contentStyle={{\n                      backgroundColor: \"hsl(var(--popover))\",\n                      border: \"1px solid hsl(var(--border))\",\n                      borderRadius: \"var(--radius)\",\n                    }}\n                  />\n                  <Bar\n                    dataKey=\"feeAmount\"\n                    name=\"Fee\"\n                    fill=\"hsl(var(--primary))\"\n                    radius={[4, 4, 0, 0]}\n                  />\n                </BarChart>\n              </ResponsiveContainer>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card data-testid=\"card-fee-breakdown\">\n        <CardHeader>\n          <CardTitle className=\"text-base\">Fee Breakdown by Tier</CardTitle>\n          <CardDescription>\n            Revenue share organized by pricing tier with account details\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {activeAccounts.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <DollarSign className=\"mx-auto h-8 w-8 mb-2 opacity-50\" />\n              <p>No enrolled accounts yet.</p>\n              <p className=\"text-sm\">Enroll accounts from the Revenue Tracking page to see fee breakdowns.</p>\n            </div>\n          ) : (\n            <div className=\"space-y-6\">\n              {(() => {\n                // Build tier-grouped data structure\n                const tierData: Record<string, {\n                  tierName: string;\n                  rate: number;\n                  totalRevenue: number;\n                  totalFee: number;\n                  accounts: Array<{ name: string; revenue: number; fee: number }>;\n                }> = {};\n\n                // Collect all account contributions by tier\n                activeAccounts.forEach((account) => {\n                  const accountRevenue = account.incrementalRevenue || 0;\n                  const accountCalc = calculateTieredFee(accountRevenue);\n                  \n                  accountCalc.breakdown.forEach((item) => {\n                    if (!tierData[item.tier]) {\n                      tierData[item.tier] = {\n                        tierName: item.tier,\n                        rate: item.rate,\n                        totalRevenue: 0,\n                        totalFee: 0,\n                        accounts: [],\n                      };\n                    }\n                    tierData[item.tier].totalRevenue += item.revenueInTier;\n                    tierData[item.tier].totalFee += item.fee;\n                    tierData[item.tier].accounts.push({\n                      name: account.accountName || `Account ${account.id}`,\n                      revenue: item.revenueInTier,\n                      fee: item.fee,\n                    });\n                  });\n                });\n\n                // Sort tiers by their revenue range (parse first number from tier name)\n                const sortedTiers = Object.values(tierData).sort((a, b) => {\n                  const aMin = parseFloat(a.tierName.replace(/[^0-9.]/g, '')) || 0;\n                  const bMin = parseFloat(b.tierName.replace(/[^0-9.]/g, '')) || 0;\n                  return aMin - bMin;\n                });\n\n                const grandTotalFee = sortedTiers.reduce((sum, tier) => sum + tier.totalFee, 0);\n\n                return (\n                  <>\n                    {sortedTiers.map((tier, tierIdx) => (\n                      <div key={tierIdx} className=\"border rounded-md\" data-testid={`tier-breakdown-${tierIdx}`}>\n                        {/* Tier Header with Total */}\n                        <div className=\"flex items-center justify-between p-4 bg-muted/30\">\n                          <div>\n                            <h4 className=\"font-semibold\">{tier.tierName}</h4>\n                            <p className=\"text-sm text-muted-foreground\">@ {tier.rate}% rate</p>\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"text-lg font-bold text-primary\">{formatCurrency(tier.totalFee)}</p>\n                            <p className=\"text-xs text-muted-foreground\">from {formatCurrency(tier.totalRevenue)} revenue</p>\n                          </div>\n                        </div>\n                        {/* Indented Account List */}\n                        <div className=\"px-4 py-2 space-y-1\">\n                          {tier.accounts\n                            .sort((a, b) => b.fee - a.fee) // Sort by fee descending\n                            .map((acc, accIdx) => (\n                            <div \n                              key={accIdx} \n                              className=\"flex items-center justify-between py-1.5 pl-4 border-l-2 border-muted-foreground/20\"\n                              data-testid={`tier-${tierIdx}-account-${accIdx}`}\n                            >\n                              <span className=\"text-sm\">{acc.name}</span>\n                              <div className=\"flex items-center gap-4 text-sm\">\n                                <span className=\"text-muted-foreground\">{formatCurrency(acc.revenue)}</span>\n                                <span className=\"font-medium text-primary w-20 text-right\">{formatCurrency(acc.fee)}</span>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    ))}\n                    \n                    {/* Grand Total */}\n                    <div className=\"border-t pt-4 mt-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <p className=\"font-bold\">Grand Total</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            Sum of all tier fees\n                          </p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm text-muted-foreground\">\n                            Total Revenue: <span className=\"font-medium text-chart-2\">{formatCurrency(totalIncremental)}</span>\n                          </p>\n                          <p className=\"text-2xl font-bold text-primary\">\n                            {formatCurrency(grandTotalFee)}\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n                  </>\n                );\n              })()}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Add Tier Dialog */}\n      <Dialog open={isAddTierOpen} onOpenChange={setIsAddTierOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Add Pricing Tier</DialogTitle>\n            <DialogDescription>\n              Define a new revenue tier with its share rate percentage.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"tier-min\">Minimum Revenue ($)</Label>\n                <Input\n                  id=\"tier-min\"\n                  type=\"number\"\n                  value={newTierMin}\n                  onChange={(e) => setNewTierMin(e.target.value)}\n                  placeholder=\"0\"\n                  data-testid=\"input-tier-min\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"tier-max\">Maximum Revenue ($)</Label>\n                <Input\n                  id=\"tier-max\"\n                  type=\"number\"\n                  value={newTierMax}\n                  onChange={(e) => setNewTierMax(e.target.value)}\n                  placeholder=\"Leave empty for unlimited\"\n                  data-testid=\"input-tier-max\"\n                />\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"tier-rate\">Share Rate (%)</Label>\n              <Input\n                id=\"tier-rate\"\n                type=\"number\"\n                value={newTierRate}\n                onChange={(e) => setNewTierRate(e.target.value)}\n                placeholder=\"15\"\n                data-testid=\"input-tier-rate\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsAddTierOpen(false)}>Cancel</Button>\n            <Button onClick={handleAddTier} disabled={createTierMutation.isPending} data-testid=\"button-save-tier\">\n              {createTierMutation.isPending && <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Add Tier\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Tier Dialog */}\n      <Dialog open={!!editingTier} onOpenChange={(open) => !open && setEditingTier(null)}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit Pricing Tier</DialogTitle>\n            <DialogDescription>\n              Update this revenue tier's range and share rate.\n            </DialogDescription>\n          </DialogHeader>\n          {editingTier && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-tier-min\">Minimum Revenue ($)</Label>\n                  <Input\n                    id=\"edit-tier-min\"\n                    type=\"number\"\n                    value={editingTier.minRevenue}\n                    onChange={(e) => setEditingTier({ ...editingTier, minRevenue: e.target.value })}\n                    data-testid=\"input-edit-tier-min\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"edit-tier-max\">Maximum Revenue ($)</Label>\n                  <Input\n                    id=\"edit-tier-max\"\n                    type=\"number\"\n                    value={editingTier.maxRevenue || \"\"}\n                    onChange={(e) => setEditingTier({ ...editingTier, maxRevenue: e.target.value || null })}\n                    placeholder=\"Leave empty for unlimited\"\n                    data-testid=\"input-edit-tier-max\"\n                  />\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-tier-rate\">Share Rate (%)</Label>\n                <Input\n                  id=\"edit-tier-rate\"\n                  type=\"number\"\n                  value={editingTier.shareRate}\n                  onChange={(e) => setEditingTier({ ...editingTier, shareRate: e.target.value })}\n                  data-testid=\"input-edit-tier-rate\"\n                />\n              </div>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setEditingTier(null)}>Cancel</Button>\n            <Button onClick={handleUpdateTier} disabled={updateTierMutation.isPending} data-testid=\"button-update-tier\">\n              {updateTierMutation.isPending && <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Save Changes\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\ninterface EmailSettings {\n  enabled: boolean;\n  fromEmail: string;\n  fromName: string;\n  notifyOnNewTask: boolean;\n  notifyOnHighPriority: boolean;\n  dailyDigest: boolean;\n  isConfigured: boolean;\n}\n\nfunction EmailSettingsManager() {\n  const { toast } = useToast();\n  const [testEmail, setTestEmail] = useState(\"\");\n  const [fromEmail, setFromEmail] = useState(\"\");\n  const [fromName, setFromName] = useState(\"\");\n  const [hasEditedSender, setHasEditedSender] = useState(false);\n\n  const { data: emailSettings, isLoading } = useQuery<EmailSettings>({\n    queryKey: [\"/api/email/settings\"],\n  });\n\n  // Initialize local state when settings load\n  useEffect(() => {\n    if (emailSettings && !hasEditedSender) {\n      setFromEmail(emailSettings.fromEmail || \"\");\n      setFromName(emailSettings.fromName || \"\");\n    }\n  }, [emailSettings, hasEditedSender]);\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (settings: Partial<EmailSettings>) => {\n      const response = await apiRequest(\"PATCH\", \"/api/email/settings\", settings);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email/settings\"] });\n      toast({ title: \"Email settings updated\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Failed to update settings\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const sendTestEmailMutation = useMutation({\n    mutationFn: async (email: string) => {\n      const response = await apiRequest(\"POST\", \"/api/email/test\", { email });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: \"Test email sent\", description: \"Check your inbox for the test email\" });\n      setTestEmail(\"\");\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Failed to send test email\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleToggle = (key: keyof EmailSettings, value: boolean) => {\n    updateSettingsMutation.mutate({ [key]: value });\n  };\n\n  const handleSendTestEmail = () => {\n    if (!testEmail) {\n      toast({ title: \"Enter an email address\", variant: \"destructive\" });\n      return;\n    }\n    sendTestEmailMutation.mutate(testEmail);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <RefreshCw className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Mail className=\"h-5 w-5\" />\n            Email Configuration\n          </CardTitle>\n          <CardDescription>\n            Configure email notifications for task assignments and updates\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {!emailSettings?.isConfigured && (\n            <div className=\"flex items-start gap-3 p-4 bg-amber-50 dark:bg-amber-950/20 rounded-lg border border-amber-200 dark:border-amber-800\">\n              <AlertCircle className=\"h-5 w-5 text-amber-600 dark:text-amber-400 mt-0.5\" />\n              <div>\n                <p className=\"font-medium text-amber-800 dark:text-amber-200\">Resend API Key Required</p>\n                <p className=\"text-sm text-amber-700 dark:text-amber-300 mt-1\">\n                  To enable email notifications, you need to add a RESEND_API_KEY secret. \n                  Get your API key from <a href=\"https://resend.com\" target=\"_blank\" rel=\"noopener noreferrer\" className=\"underline\">resend.com</a> and add it to your project secrets.\n                </p>\n              </div>\n            </div>\n          )}\n\n          {emailSettings?.isConfigured && (\n            <div className=\"flex items-center gap-3 p-4 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-800\">\n              <CheckCircle className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n              <div>\n                <p className=\"font-medium text-green-800 dark:text-green-200\">Email Provider Connected</p>\n                <p className=\"text-sm text-green-700 dark:text-green-300\">Resend is configured and ready to send emails</p>\n              </div>\n            </div>\n          )}\n\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <Label htmlFor=\"email-enabled\">Enable Email Notifications</Label>\n                <p className=\"text-sm text-muted-foreground\">Turn on to send email notifications</p>\n              </div>\n              <Switch\n                id=\"email-enabled\"\n                checked={emailSettings?.enabled || false}\n                onCheckedChange={(checked) => handleToggle(\"enabled\", checked)}\n                disabled={!emailSettings?.isConfigured}\n                data-testid=\"switch-email-enabled\"\n              />\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <h4 className=\"font-medium\">Sender Configuration</h4>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"from-name\">From Name</Label>\n                  <Input\n                    id=\"from-name\"\n                    value={fromName}\n                    onChange={(e) => {\n                      setFromName(e.target.value);\n                      setHasEditedSender(true);\n                    }}\n                    placeholder=\"AI VP Dashboard\"\n                    data-testid=\"input-from-name\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Display name for sent emails</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"from-email\">From Email</Label>\n                  <Input\n                    id=\"from-email\"\n                    type=\"email\"\n                    value={fromEmail}\n                    onChange={(e) => {\n                      setFromEmail(e.target.value);\n                      setHasEditedSender(true);\n                    }}\n                    placeholder=\"notifications@yourdomain.com\"\n                    data-testid=\"input-from-email\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Must be a verified domain in Resend</p>\n                </div>\n              </div>\n              {hasEditedSender && (\n                <Button\n                  onClick={() => {\n                    updateSettingsMutation.mutate({ fromEmail, fromName });\n                    setHasEditedSender(false);\n                  }}\n                  disabled={updateSettingsMutation.isPending}\n                  size=\"sm\"\n                  data-testid=\"button-save-sender\"\n                >\n                  {updateSettingsMutation.isPending && <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />}\n                  Save Sender Settings\n                </Button>\n              )}\n            </div>\n\n            <Separator />\n\n            <div className=\"space-y-4\">\n              <h4 className=\"font-medium\">Notification Types</h4>\n              \n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"notify-new-task\">New Task Assignments</Label>\n                  <p className=\"text-sm text-muted-foreground\">Notify TMs when tasks are assigned to them</p>\n                </div>\n                <Switch\n                  id=\"notify-new-task\"\n                  checked={emailSettings?.notifyOnNewTask || false}\n                  onCheckedChange={(checked) => handleToggle(\"notifyOnNewTask\", checked)}\n                  disabled={!emailSettings?.enabled}\n                  data-testid=\"switch-notify-new-task\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"notify-high-priority\">\n                    High Priority Alerts\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">Send urgent notifications for high-priority tasks</p>\n                </div>\n                <Switch\n                  id=\"notify-high-priority\"\n                  checked={emailSettings?.notifyOnHighPriority || false}\n                  onCheckedChange={(checked) => handleToggle(\"notifyOnHighPriority\", checked)}\n                  disabled={!emailSettings?.enabled}\n                  data-testid=\"switch-notify-high-priority\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label htmlFor=\"daily-digest\">\n                    Daily Digest\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground\">Send a daily summary of pending tasks</p>\n                </div>\n                <Switch\n                  id=\"daily-digest\"\n                  checked={emailSettings?.dailyDigest || false}\n                  onCheckedChange={(checked) => handleToggle(\"dailyDigest\", checked)}\n                  disabled={!emailSettings?.enabled}\n                  data-testid=\"switch-daily-digest\"\n                />\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-base\">Test Email</CardTitle>\n          <CardDescription>\n            Send a test email to verify your configuration is working\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-2\">\n            <Input\n              type=\"email\"\n              placeholder=\"Enter email address\"\n              value={testEmail}\n              onChange={(e) => setTestEmail(e.target.value)}\n              className=\"flex-1\"\n              data-testid=\"input-test-email\"\n            />\n            <Button \n              onClick={handleSendTestEmail}\n              disabled={!emailSettings?.isConfigured || sendTestEmailMutation.isPending}\n              data-testid=\"button-send-test-email\"\n            >\n              {sendTestEmailMutation.isPending ? (\n                <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : (\n                <Mail className=\"mr-2 h-4 w-4\" />\n              )}\n              Send Test\n            </Button>\n          </div>\n          {!emailSettings?.isConfigured && (\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              Add your RESEND_API_KEY secret to enable test emails\n            </p>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction CategoriesManager() {\n  const { toast } = useToast();\n  const [newCategoryName, setNewCategoryName] = useState(\"\");\n  const [editingCategory, setEditingCategory] = useState<CustomCategory | null>(null);\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\n\n  const { data: categories = [], isLoading } = useQuery<CustomCategory[]>({\n    queryKey: [\"/api/custom-categories\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (name: string) => {\n      const response = await apiRequest(\"POST\", \"/api/custom-categories\", {\n        name,\n        displayOrder: categories.length + 1,\n        isActive: true,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/custom-categories\"] });\n      setNewCategoryName(\"\");\n      setIsAddDialogOpen(false);\n      toast({ title: \"Category added\", description: \"New product category has been created.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to create category\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, ...data }: { id: number; name?: string; isActive?: boolean }) => {\n      const response = await apiRequest(\"PUT\", `/api/custom-categories/${id}`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/custom-categories\"] });\n      setEditingCategory(null);\n      toast({ title: \"Category updated\", description: \"Product category has been updated.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to update category\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/custom-categories/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/custom-categories\"] });\n      toast({ title: \"Category deleted\", description: \"Product category has been removed.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to delete category\", variant: \"destructive\" });\n    },\n  });\n\n  const seedDefaultsMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"POST\", \"/api/custom-categories/seed-defaults\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/custom-categories\"] });\n      toast({ title: \"Categories seeded\", description: \"Default product categories have been added.\" });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to seed default categories\", variant: \"destructive\" });\n    },\n  });\n\n  const handleAddCategory = () => {\n    if (!newCategoryName.trim()) return;\n    createMutation.mutate(newCategoryName.trim());\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-base\">Product Categories</CardTitle>\n            <CardDescription>\n              Define the product categories used for ICP analysis and playbook generation.\n              These categories are specific to your company's product catalog.\n            </CardDescription>\n          </div>\n          <div className=\"flex gap-2\">\n            {categories.length === 0 && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => seedDefaultsMutation.mutate()}\n                disabled={seedDefaultsMutation.isPending}\n                data-testid=\"button-seed-categories\"\n              >\n                <RefreshCw className={`mr-2 h-4 w-4 ${seedDefaultsMutation.isPending ? \"animate-spin\" : \"\"}`} />\n                Load Defaults\n              </Button>\n            )}\n            <Button\n              size=\"sm\"\n              onClick={() => setIsAddDialogOpen(true)}\n              data-testid=\"button-add-category\"\n            >\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Add Category\n            </Button>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"space-y-2\">\n            {[1, 2, 3].map((i) => (\n              <div key={i} className=\"h-12 bg-muted/50 rounded animate-pulse\" />\n            ))}\n          </div>\n        ) : categories.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <FileText className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n            <p className=\"font-medium\">No categories configured</p>\n            <p className=\"text-sm mt-1\">Click \"Load Defaults\" to add standard categories or create your own.</p>\n          </div>\n        ) : (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Category Name</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"text-right\">Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {categories.map((category) => (\n                <TableRow key={category.id} data-testid={`category-row-${category.id}`}>\n                  <TableCell>\n                    {editingCategory?.id === category.id ? (\n                      <Input\n                        value={editingCategory.name}\n                        onChange={(e) =>\n                          setEditingCategory({ ...editingCategory, name: e.target.value })\n                        }\n                        className=\"max-w-xs\"\n                        data-testid={`input-edit-category-${category.id}`}\n                      />\n                    ) : (\n                      <span className=\"font-medium\">{category.name}</span>\n                    )}\n                  </TableCell>\n                  <TableCell>\n                    <Badge variant={category.isActive ? \"default\" : \"secondary\"}>\n                      {category.isActive ? \"Active\" : \"Inactive\"}\n                    </Badge>\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <div className=\"flex justify-end gap-2\">\n                      {editingCategory?.id === category.id ? (\n                        <>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => setEditingCategory(null)}\n                          >\n                            Cancel\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            onClick={() =>\n                              updateMutation.mutate({\n                                id: category.id,\n                                name: editingCategory.name,\n                              })\n                            }\n                            disabled={updateMutation.isPending}\n                          >\n                            Save\n                          </Button>\n                        </>\n                      ) : (\n                        <>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => setEditingCategory(category)}\n                            data-testid={`button-edit-category-${category.id}`}\n                          >\n                            <Pencil className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() =>\n                              updateMutation.mutate({\n                                id: category.id,\n                                isActive: !category.isActive,\n                              })\n                            }\n                            data-testid={`button-toggle-category-${category.id}`}\n                          >\n                            {category.isActive ? (\n                              <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />\n                            ) : (\n                              <CheckCircle className=\"h-4 w-4 text-chart-2\" />\n                            )}\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => deleteMutation.mutate(category.id)}\n                            disabled={deleteMutation.isPending}\n                            data-testid={`button-delete-category-${category.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </>\n                      )}\n                    </div>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        )}\n      </CardContent>\n\n      <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Add Product Category</DialogTitle>\n            <DialogDescription>\n              Create a new product category for ICP analysis and playbook generation.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label>Category Name</Label>\n              <Input\n                placeholder=\"e.g., Water Heaters, PVF, Controls\"\n                value={newCategoryName}\n                onChange={(e) => setNewCategoryName(e.target.value)}\n                data-testid=\"input-new-category-name\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsAddDialogOpen(false)}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleAddCategory}\n              disabled={createMutation.isPending || !newCategoryName.trim()}\n              data-testid=\"button-create-category\"\n            >\n              {createMutation.isPending && <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />}\n              Create Category\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </Card>\n  );\n}\n\nfunction ResetDemoDataCard() {\n  const { toast } = useToast();\n  const [isResetDialogOpen, setIsResetDialogOpen] = useState(false);\n  const [confirmText, setConfirmText] = useState(\"\");\n\n  const resetMutation = useMutation({\n    mutationFn: () => apiRequest(\"POST\", \"/api/admin/reset-seed\", {}),\n    onSuccess: () => {\n      toast({\n        title: \"Demo data reset\",\n        description: \"All data has been restored to the original demo state. Refreshing...\",\n      });\n      setIsResetDialogOpen(false);\n      setConfirmText(\"\");\n      setTimeout(() => {\n        window.location.reload();\n      }, 1500);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Reset failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  return (\n    <Card className=\"border-red-200 dark:border-red-900/50\">\n      <CardHeader>\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <RotateCcw className=\"h-4 w-4 text-red-500\" />\n          Reset Demo Data\n        </CardTitle>\n        <CardDescription>\n          Restore all accounts, orders, tasks, enrollments, and AI briefings back to the original demo state. Useful after running a demo or presentation.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <Button\n          variant=\"outline\"\n          className=\"border-red-200 text-red-600 dark:border-red-900 dark:text-red-400\"\n          onClick={() => setIsResetDialogOpen(true)}\n          data-testid=\"button-open-reset-dialog\"\n        >\n          <RotateCcw className=\"h-4 w-4 mr-2\" />\n          Reset to Demo Defaults\n        </Button>\n\n        <Dialog open={isResetDialogOpen} onOpenChange={setIsResetDialogOpen}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <AlertCircle className=\"h-5 w-5 text-red-500\" />\n                Reset All Demo Data?\n              </DialogTitle>\n              <DialogDescription>\n                This will delete all current data and restore it to the original demo state. This includes accounts, orders, tasks, playbooks, enrollments, territory managers, and AI briefings. This action cannot be undone.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-3 py-2\">\n              <Label>Type <span className=\"font-mono font-bold\">RESET</span> to confirm</Label>\n              <Input\n                value={confirmText}\n                onChange={(e) => setConfirmText(e.target.value)}\n                placeholder=\"Type RESET\"\n                data-testid=\"input-reset-confirm\"\n              />\n            </div>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => { setIsResetDialogOpen(false); setConfirmText(\"\"); }}\n              >\n                Cancel\n              </Button>\n              <Button\n                variant=\"destructive\"\n                disabled={confirmText !== \"RESET\" || resetMutation.isPending}\n                onClick={() => resetMutation.mutate()}\n                data-testid=\"button-confirm-reset\"\n              >\n                {resetMutation.isPending ? (\n                  <>\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Resetting...\n                  </>\n                ) : (\n                  <>\n                    <RotateCcw className=\"h-4 w-4 mr-2\" />\n                    Reset Everything\n                  </>\n                )}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </CardContent>\n    </Card>\n  );\n}\n\ninterface EmailConnectionInfo {\n  id: number;\n  provider: string;\n  emailAddress: string;\n  status: string;\n  lastSyncAt: string | null;\n  syncError: string | null;\n  createdAt: string;\n}\n\nfunction EmailConnectionsCard() {\n  const { toast } = useToast();\n\n  const { data: connections = [], isLoading } = useQuery<EmailConnectionInfo[]>({\n    queryKey: [\"/api/email/connections\"],\n  });\n\n  const connectMicrosoftMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"GET\", \"/api/auth/microsoft/start\");\n      const data = await res.json();\n      window.location.href = data.authUrl;\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to start Microsoft OAuth. Make sure Microsoft credentials are configured.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const connectGoogleMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"GET\", \"/api/auth/google-email/start\");\n      const data = await res.json();\n      window.location.href = data.authUrl;\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to start Google OAuth. Make sure Google credentials are configured.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const disconnectMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/email/connections/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: \"Disconnected\", description: \"Email connection removed.\" });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email/connections\"] });\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to disconnect email.\", variant: \"destructive\" });\n    },\n  });\n\n  const syncMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await apiRequest(\"POST\", `/api/email/connections/${id}/sync`);\n      return res.json();\n    },\n    onSuccess: (data) => {\n      toast({ title: \"Sync Complete\", description: `Synced ${data.synced ?? 0} new emails.` });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email/connections\"] });\n    },\n    onError: () => {\n      toast({ title: \"Sync Failed\", description: \"Failed to sync emails.\", variant: \"destructive\" });\n    },\n  });\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <Mail className=\"h-4 w-4\" />\n          Email Inbox Connections\n        </CardTitle>\n        <CardDescription>\n          Connect your Microsoft or Google email to automatically sync and analyze customer communications with AI\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-6\">\n            <RefreshCw className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n          </div>\n        ) : (\n          <>\n            {connections.map((conn) => (\n              <div\n                key={conn.id}\n                className=\"flex items-center justify-between p-4 rounded-md border bg-chart-2/10 border-chart-2/20\"\n                data-testid={`email-connection-${conn.id}`}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className={`h-9 w-9 rounded-md flex items-center justify-center text-white font-bold text-xs ${conn.provider === \"microsoft\" ? \"bg-blue-600\" : \"bg-red-500\"}`}>\n                    {conn.provider === \"microsoft\" ? \"MS\" : \"G\"}\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">{conn.emailAddress}</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {conn.provider === \"microsoft\" ? \"Microsoft 365\" : \"Gmail\"} Â· {conn.status === \"connected\" ? \"Connected\" : conn.status}\n                      {conn.lastSyncAt && ` Â· Last synced ${new Date(conn.lastSyncAt).toLocaleDateString()}`}\n                    </p>\n                    {conn.syncError && (\n                      <p className=\"text-xs text-destructive mt-1\">{conn.syncError}</p>\n                    )}\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => syncMutation.mutate(conn.id)}\n                    disabled={syncMutation.isPending}\n                    data-testid={`sync-email-${conn.id}`}\n                  >\n                    <RefreshCw className={`h-3.5 w-3.5 mr-1.5 ${syncMutation.isPending ? \"animate-spin\" : \"\"}`} />\n                    Sync\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => disconnectMutation.mutate(conn.id)}\n                    disabled={disconnectMutation.isPending}\n                    data-testid={`disconnect-email-${conn.id}`}\n                  >\n                    <X className=\"h-3.5 w-3.5\" />\n                  </Button>\n                </div>\n              </div>\n            ))}\n\n            {connections.length === 0 && (\n              <p className=\"text-sm text-muted-foreground text-center py-2\">\n                No email accounts connected. Connect one below to start syncing.\n              </p>\n            )}\n\n            <Separator />\n\n            <div className=\"flex gap-3\">\n              <Button\n                variant=\"outline\"\n                onClick={() => connectMicrosoftMutation.mutate()}\n                disabled={connectMicrosoftMutation.isPending}\n                data-testid=\"connect-microsoft-email\"\n              >\n                <div className=\"h-4 w-4 mr-2 rounded-sm bg-blue-600 flex items-center justify-center text-white text-[8px] font-bold\">M</div>\n                Connect Microsoft\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => connectGoogleMutation.mutate()}\n                disabled={connectGoogleMutation.isPending}\n                data-testid=\"connect-google-email\"\n              >\n                <div className=\"h-4 w-4 mr-2 rounded-sm bg-red-500 flex items-center justify-center text-white text-[8px] font-bold\">G</div>\n                Connect Google\n              </Button>\n            </div>\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function SettingsPage() {\n  const { toast } = useToast();\n  const [isSaving, setIsSaving] = useState(false);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingManager, setEditingManager] = useState<TerritoryManager | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const urlParams = useMemo(() => new URLSearchParams(window.location.search), []);\n  const initialTab = urlParams.get(\"tab\") || \"general\";\n\n  useEffect(() => {\n    const connected = urlParams.get(\"connected\");\n    const error = urlParams.get(\"error\");\n    if (connected) {\n      toast({\n        title: \"Email Connected\",\n        description: `Your ${connected === \"microsoft\" ? \"Microsoft\" : \"Google\"} email has been connected successfully.`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email/connections\"] });\n      window.history.replaceState({}, \"\", \"/settings?tab=integrations\");\n    } else if (error) {\n      toast({\n        title: \"Connection Failed\",\n        description: `Failed to connect your email account. Please try again.`,\n        variant: \"destructive\",\n      });\n      window.history.replaceState({}, \"\", \"/settings?tab=integrations\");\n    }\n  }, []);\n\n  const [companyName, setCompanyName] = useState(\"ABC Supply\");\n  const [appTitle, setAppTitle] = useState(\"AI VP Dashboard\");\n  const [companyLogo, setCompanyLogo] = useState<string | null>(null);\n\n  const [gapSizeWeight, setGapSizeWeight] = useState(DEFAULT_WEIGHTS.gapSizeWeight);\n  const [revenuePotentialWeight, setRevenuePotentialWeight] = useState(DEFAULT_WEIGHTS.revenuePotentialWeight);\n  const [categoryCountWeight, setCategoryCountWeight] = useState(DEFAULT_WEIGHTS.categoryCountWeight);\n  const [hasWeightChanges, setHasWeightChanges] = useState(false);\n  const [isInstructionsOpen, setIsInstructionsOpen] = useState(false);\n\n  const form = useForm<TerritoryManagerFormValues>({\n    resolver: zodResolver(territoryManagerFormSchema),\n    defaultValues: {\n      name: \"\",\n      email: \"\",\n      territories: \"\",\n      isActive: true,\n    },\n  });\n\n  const { data: settingsData } = useQuery<Setting[]>({\n    queryKey: [\"/api/settings\"],\n  });\n\n  useEffect(() => {\n    if (settingsData) {\n      const companyNameSetting = settingsData.find(s => s.key === \"companyName\");\n      const appTitleSetting = settingsData.find(s => s.key === \"appTitle\");\n      const companyLogoSetting = settingsData.find(s => s.key === \"companyLogo\");\n      \n      if (companyNameSetting?.value) setCompanyName(companyNameSetting.value);\n      if (appTitleSetting?.value) setAppTitle(appTitleSetting.value);\n      if (companyLogoSetting?.value) setCompanyLogo(companyLogoSetting.value);\n    }\n  }, [settingsData]);\n\n  const { data: territoryManagers = [], isLoading: isLoadingManagers } = useQuery<TerritoryManager[]>({\n    queryKey: [\"/api/territory-managers\"],\n  });\n\n  const { data: scoringWeights } = useQuery<ScoringWeights>({\n    queryKey: [\"/api/scoring-weights\"],\n  });\n\n  useEffect(() => {\n    if (scoringWeights) {\n      setGapSizeWeight(scoringWeights.gapSizeWeight);\n      setRevenuePotentialWeight(scoringWeights.revenuePotentialWeight);\n      setCategoryCountWeight(scoringWeights.categoryCountWeight);\n    }\n  }, [scoringWeights]);\n\n  const updateWeightsMutation = useMutation({\n    mutationFn: async (weights: { gapSizeWeight: number; revenuePotentialWeight: number; categoryCountWeight: number }) => {\n      return apiRequest(\"PUT\", \"/api/scoring-weights\", weights);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/scoring-weights\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/accounts\"] });\n      setHasWeightChanges(false);\n      toast({\n        title: \"Scoring weights updated\",\n        description: \"The new weights will be applied to all account scores.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Failed to update weights\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const weightsTotal = gapSizeWeight + revenuePotentialWeight + categoryCountWeight;\n  const isValidWeightsTotal = Math.abs(weightsTotal - 100) < 0.01;\n\n  const handleWeightChange = (setter: (val: number) => void, value: number) => {\n    setter(value);\n    setHasWeightChanges(true);\n  };\n\n  const handleResetWeights = () => {\n    setGapSizeWeight(DEFAULT_WEIGHTS.gapSizeWeight);\n    setRevenuePotentialWeight(DEFAULT_WEIGHTS.revenuePotentialWeight);\n    setCategoryCountWeight(DEFAULT_WEIGHTS.categoryCountWeight);\n    setHasWeightChanges(true);\n  };\n\n  const handleSaveWeights = () => {\n    if (!isValidWeightsTotal) {\n      toast({\n        title: \"Invalid weights\",\n        description: \"Weights must sum to 100%\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    updateWeightsMutation.mutate({\n      gapSizeWeight,\n      revenuePotentialWeight,\n      categoryCountWeight,\n    });\n  };\n\n  const saveSettingMutation = useMutation({\n    mutationFn: async ({ key, value }: { key: string; value: string }) => {\n      return apiRequest(\"PUT\", `/api/settings/${key}`, { value });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n    },\n  });\n\n  const handleLogoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!file.type.startsWith(\"image/\")) {\n      toast({ title: \"Invalid file type\", description: \"Please upload an image file\", variant: \"destructive\" });\n      return;\n    }\n\n    if (file.size > 2 * 1024 * 1024) {\n      toast({ title: \"File too large\", description: \"Please upload an image smaller than 2MB\", variant: \"destructive\" });\n      return;\n    }\n\n    const reader = new FileReader();\n    reader.onload = async (e) => {\n      const base64 = e.target?.result as string;\n      setCompanyLogo(base64);\n      try {\n        await apiRequest(\"POST\", \"/api/settings/logo\", { logo: base64 });\n        queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n        toast({ title: \"Logo uploaded\", description: \"Your company logo has been updated\" });\n      } catch {\n        toast({ title: \"Upload failed\", description: \"Failed to upload logo\", variant: \"destructive\" });\n      }\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleRemoveLogo = async () => {\n    setCompanyLogo(null);\n    try {\n      await apiRequest(\"DELETE\", \"/api/settings/logo\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/settings\"] });\n      toast({ title: \"Logo removed\", description: \"Your company logo has been removed\" });\n    } catch {\n      toast({ title: \"Error\", description: \"Failed to remove logo\", variant: \"destructive\" });\n    }\n  };\n\n  const createMutation = useMutation({\n    mutationFn: async (data: TerritoryManagerFormValues) => {\n      const territories = data.territories.split(\",\").map(t => t.trim()).filter(Boolean);\n      return apiRequest(\"POST\", \"/api/territory-managers\", { ...data, territories });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/territory-managers\"] });\n      setIsDialogOpen(false);\n      form.reset();\n      toast({ title: \"Territory Manager created\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to create Territory Manager\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: TerritoryManagerFormValues }) => {\n      const territories = data.territories.split(\",\").map(t => t.trim()).filter(Boolean);\n      return apiRequest(\"PUT\", `/api/territory-managers/${id}`, { ...data, territories });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/territory-managers\"] });\n      setIsDialogOpen(false);\n      setEditingManager(null);\n      form.reset();\n      toast({ title: \"Territory Manager updated\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to update Territory Manager\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return apiRequest(\"DELETE\", `/api/territory-managers/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/territory-managers\"] });\n      toast({ title: \"Territory Manager deleted\" });\n    },\n    onError: () => {\n      toast({ title: \"Failed to delete Territory Manager\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSave = async () => {\n    setIsSaving(true);\n    try {\n      await Promise.all([\n        saveSettingMutation.mutateAsync({ key: \"companyName\", value: companyName }),\n        saveSettingMutation.mutateAsync({ key: \"appTitle\", value: appTitle }),\n      ]);\n      toast({\n        title: \"Settings saved\",\n        description: \"Your changes have been applied\",\n      });\n    } catch {\n      toast({\n        title: \"Save failed\",\n        description: \"Failed to save settings\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const handleOpenDialog = (manager?: TerritoryManager) => {\n    if (manager) {\n      setEditingManager(manager);\n      form.reset({\n        name: manager.name,\n        email: manager.email,\n        territories: manager.territories?.join(\", \") || \"\",\n        isActive: manager.isActive ?? true,\n      });\n    } else {\n      setEditingManager(null);\n      form.reset({\n        name: \"\",\n        email: \"\",\n        territories: \"\",\n        isActive: true,\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleSubmit = (data: TerritoryManagerFormValues) => {\n    if (editingManager) {\n      updateMutation.mutate({ id: editingManager.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const handleDelete = (id: number) => {\n    if (confirm(\"Are you sure you want to delete this Territory Manager?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-settings\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Settings</h1>\n          <p className=\"text-muted-foreground\">\n            Configure system settings and integrations\n          </p>\n        </div>\n        <Button onClick={handleSave} disabled={isSaving} data-testid=\"button-save-settings\">\n          {isSaving ? (\n            <>\n              <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\n              Saving...\n            </>\n          ) : (\n            <>\n              <Save className=\"mr-2 h-4 w-4\" />\n              Save Changes\n            </>\n          )}\n        </Button>\n      </div>\n\n      <Tabs defaultValue={initialTab} className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"general\" data-testid=\"tab-general\">\n            <Settings className=\"mr-2 h-4 w-4\" />\n            General\n          </TabsTrigger>\n          <TabsTrigger value=\"territory-managers\" data-testid=\"tab-territory-managers\">\n            <Users className=\"mr-2 h-4 w-4\" />\n            Territory Managers\n          </TabsTrigger>\n          <TabsTrigger value=\"scoring\" data-testid=\"tab-scoring\">\n            <Sliders className=\"mr-2 h-4 w-4\" />\n            Scoring\n          </TabsTrigger>\n          <TabsTrigger value=\"prompts\" data-testid=\"tab-prompts\">\n            <Brain className=\"mr-2 h-4 w-4\" />\n            AI Prompts\n          </TabsTrigger>\n          <TabsTrigger value=\"integrations\" data-testid=\"tab-integrations\">\n            <Database className=\"mr-2 h-4 w-4\" />\n            Integrations\n          </TabsTrigger>\n          <TabsTrigger value=\"categories\" data-testid=\"tab-categories\">\n            <FileText className=\"mr-2 h-4 w-4\" />\n            Categories\n          </TabsTrigger>\n          <TabsTrigger value=\"email\" data-testid=\"tab-email\">\n            <Mail className=\"mr-2 h-4 w-4\" />\n            Email\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"general\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">Company Information</CardTitle>\n              <CardDescription>\n                Basic company and branding settings - these appear in the sidebar\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"company-name\">Company Name</Label>\n                  <Input \n                    id=\"company-name\" \n                    value={companyName}\n                    onChange={(e) => setCompanyName(e.target.value)}\n                    placeholder=\"Your Company Name\"\n                    data-testid=\"input-company-name\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Displays below the app title in the sidebar</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"app-title\">App Title</Label>\n                  <Input \n                    id=\"app-title\" \n                    value={appTitle}\n                    onChange={(e) => setAppTitle(e.target.value)}\n                    placeholder=\"AI VP Dashboard\"\n                    data-testid=\"input-app-title\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">The main title shown in the sidebar</p>\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label>Company Logo</Label>\n                <p className=\"text-xs text-muted-foreground mb-3\">\n                  Upload your company logo to replace the default icon in the sidebar. Recommended size: 80x80 pixels.\n                </p>\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"flex h-20 w-20 items-center justify-center rounded-md border-2 border-dashed border-muted-foreground/25 bg-white\">\n                    {companyLogo ? (\n                      <img \n                        src={companyLogo} \n                        alt=\"Company logo\" \n                        className=\"h-full w-full object-contain rounded-md p-1\"\n                      />\n                    ) : (\n                      <Image className=\"h-8 w-8 text-muted-foreground/50\" />\n                    )}\n                  </div>\n                  <div className=\"flex flex-col gap-2\">\n                    <input\n                      ref={fileInputRef}\n                      type=\"file\"\n                      accept=\"image/*\"\n                      onChange={handleLogoUpload}\n                      className=\"hidden\"\n                      data-testid=\"input-logo-upload\"\n                    />\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\"\n                      onClick={() => fileInputRef.current?.click()}\n                      data-testid=\"button-upload-logo\"\n                    >\n                      <Upload className=\"mr-2 h-4 w-4\" />\n                      Upload Logo\n                    </Button>\n                    {companyLogo && (\n                      <Button \n                        variant=\"ghost\" \n                        size=\"sm\"\n                        onClick={handleRemoveLogo}\n                        className=\"text-destructive hover:text-destructive\"\n                        data-testid=\"button-remove-logo\"\n                      >\n                        <X className=\"mr-2 h-4 w-4\" />\n                        Remove\n                      </Button>\n                    )}\n                  </div>\n                </div>\n              </div>\n              \n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">Notifications</CardTitle>\n              <CardDescription>\n                Configure email and in-app notifications\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label>Email Reports</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Receive weekly summary reports\n                  </p>\n                </div>\n                <Switch defaultChecked />\n              </div>\n              <Separator />\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label>Task Reminders</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Send reminders for upcoming tasks\n                  </p>\n                </div>\n                <Switch defaultChecked />\n              </div>\n              <Separator />\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label>ICP Alerts</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Notify when AI generates new ICP suggestions\n                  </p>\n                </div>\n                <Switch />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">Data Management</CardTitle>\n              <CardDescription>\n                Manage data retention and cleanup\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>Order History Retention</Label>\n                <Select defaultValue=\"36\">\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select retention period\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"12\">12 months</SelectItem>\n                    <SelectItem value=\"24\">24 months</SelectItem>\n                    <SelectItem value=\"36\">36 months</SelectItem>\n                    <SelectItem value=\"60\">60 months</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <Label>Auto-archive Completed Tasks</Label>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Archive tasks older than 90 days\n                  </p>\n                </div>\n                <Switch defaultChecked />\n              </div>\n            </CardContent>\n          </Card>\n\n          <ResetDemoDataCard />\n        </TabsContent>\n\n        <TabsContent value=\"territory-managers\" className=\"space-y-6\">\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between gap-2\">\n              <div>\n                <CardTitle className=\"text-base\">Territory Managers</CardTitle>\n                <CardDescription>\n                  Manage territory managers and their assigned regions\n                </CardDescription>\n              </div>\n              <Button onClick={() => handleOpenDialog()} data-testid=\"button-add-tm\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add TM\n              </Button>\n            </CardHeader>\n            <CardContent>\n              {isLoadingManagers ? (\n                <div className=\"flex items-center justify-center py-8\">\n                  <RefreshCw className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                </div>\n              ) : territoryManagers.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No territory managers found. Click \"Add TM\" to create one.\n                </div>\n              ) : (\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Name</TableHead>\n                      <TableHead>Email</TableHead>\n                      <TableHead>Territories</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead className=\"text-right\">Actions</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {territoryManagers.map((manager) => (\n                      <TableRow key={manager.id} data-testid={`row-tm-${manager.id}`}>\n                        <TableCell className=\"font-medium\" data-testid={`text-tm-name-${manager.id}`}>\n                          {manager.name}\n                        </TableCell>\n                        <TableCell data-testid={`text-tm-email-${manager.id}`}>\n                          {manager.email}\n                        </TableCell>\n                        <TableCell data-testid={`text-tm-territories-${manager.id}`}>\n                          <div className=\"flex flex-wrap gap-1\">\n                            {manager.territories?.map((territory, idx) => (\n                              <Badge key={idx} variant=\"secondary\" className=\"text-xs\">\n                                {territory}\n                              </Badge>\n                            )) || \"-\"}\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant={manager.isActive ? \"default\" : \"secondary\"}>\n                            {manager.isActive ? \"Active\" : \"Inactive\"}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <div className=\"flex justify-end gap-1\">\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              onClick={() => handleOpenDialog(manager)}\n                              data-testid={`button-edit-tm-${manager.id}`}\n                            >\n                              <Pencil className=\"h-4 w-4\" />\n                            </Button>\n                            <Button\n                              size=\"icon\"\n                              variant=\"ghost\"\n                              onClick={() => handleDelete(manager.id)}\n                              data-testid={`button-delete-tm-${manager.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"scoring\" className=\"space-y-6\">\n          <Card>\n            <Collapsible open={isInstructionsOpen} onOpenChange={setIsInstructionsOpen}>\n              <CollapsibleTrigger asChild>\n                <CardHeader className=\"cursor-pointer hover-elevate\">\n                  <CardTitle className=\"flex items-center justify-between gap-2 text-base\">\n                    <div className=\"flex items-center gap-2\">\n                      <BookOpen className=\"h-4 w-4 text-primary\" />\n                      How Scoring Works\n                    </div>\n                    {isInstructionsOpen ? (\n                      <ChevronDown className=\"h-4 w-4 text-muted-foreground\" />\n                    ) : (\n                      <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                    )}\n                  </CardTitle>\n                </CardHeader>\n              </CollapsibleTrigger>\n              <CollapsibleContent>\n                <CardContent className=\"pt-0 space-y-4\">\n                  <div>\n                    <h4 className=\"font-semibold text-foreground mb-2\">What is the Opportunity Score?</h4>\n                    <p className=\"text-sm text-muted-foreground\">\n                      The Opportunity Score ranks accounts by their potential for wallet share capture. It combines three factors \n                      to identify which accounts should be prioritized for enrollment in the revenue recovery program.\n                    </p>\n                  </div>\n\n                  <div>\n                    <h4 className=\"font-semibold text-foreground mb-2\">The Three Factors</h4>\n                    <ul className=\"list-disc list-inside space-y-1 text-sm text-muted-foreground\">\n                      <li><strong>Gap Size:</strong> How far the account falls below your ICP targets. Larger gaps = more room for growth.</li>\n                      <li><strong>Revenue Potential:</strong> The account's current revenue and estimated upside. Bigger accounts offer bigger absolute gains.</li>\n                      <li><strong>Category Count:</strong> Number of product categories with gaps. More gaps may indicate broader opportunity.</li>\n                    </ul>\n                  </div>\n\n                  <div>\n                    <h4 className=\"font-semibold text-foreground mb-2\">How to Adjust Weights</h4>\n                    <ul className=\"list-disc list-inside space-y-1 text-sm text-muted-foreground\">\n                      <li>Use sliders or type values directly - weights must add up to exactly 100%</li>\n                      <li>Higher weight = more influence on which accounts rank at the top</li>\n                      <li>Changes apply immediately after saving and re-rank all accounts</li>\n                    </ul>\n                  </div>\n\n                  <div>\n                    <h4 className=\"font-semibold text-foreground mb-2\">Suggested Strategies</h4>\n                    <ul className=\"list-disc list-inside space-y-1 text-sm text-muted-foreground\">\n                      <li><strong>Balanced (40/30/30):</strong> Default - considers all factors roughly equally</li>\n                      <li><strong>Revenue-Focused (30/50/20):</strong> Prioritize accounts with highest dollar potential</li>\n                      <li><strong>Gap-Focused (60/20/20):</strong> Target accounts with the most room for improvement</li>\n                    </ul>\n                  </div>\n                </CardContent>\n              </CollapsibleContent>\n            </Collapsible>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                Opportunity Score Weights\n                {hasWeightChanges && (\n                  <Badge variant=\"outline\" className=\"ml-2\">Unsaved</Badge>\n                )}\n              </CardTitle>\n              <CardDescription>\n                Adjust how each factor contributes to the opportunity score. Weights must total 100%.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center justify-between flex-wrap gap-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"flex h-9 w-9 items-center justify-center rounded-md bg-chart-5/10\">\n                      <Target className=\"h-4 w-4 text-chart-5\" />\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-2\">\n                        <Label className=\"font-medium\">Gap Size</Label>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5 p-0\" data-testid=\"tooltip-gap-size\">\n                              <HelpCircle className=\"h-3 w-3 text-muted-foreground\" />\n                            </Button>\n                          </TooltipTrigger>\n                          <TooltipContent className=\"max-w-xs\">\n                            <p className=\"text-sm\">Measures how far below the ICP target each account is across categories.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground\">Distance from ICP targets</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <Slider\n                      value={[gapSizeWeight]}\n                      onValueChange={([val]) => handleWeightChange(setGapSizeWeight, val)}\n                      max={100}\n                      step={5}\n                      className=\"w-32\"\n                      data-testid=\"slider-gap-size\"\n                    />\n                    <Input\n                      type=\"number\"\n                      value={gapSizeWeight}\n                      onChange={(e) => handleWeightChange(setGapSizeWeight, parseInt(e.target.value) || 0)}\n                      className=\"w-16 text-center\"\n                      min={0}\n                      max={100}\n                      data-testid=\"input-gap-size\"\n                    />\n                    <span className=\"text-sm text-muted-foreground w-4\">%</span>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center justify-between flex-wrap gap-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"flex h-9 w-9 items-center justify-center rounded-md bg-chart-1/10\">\n                      <DollarSign className=\"h-4 w-4 text-chart-1\" />\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-2\">\n                        <Label className=\"font-medium\">Revenue Potential</Label>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5 p-0\" data-testid=\"tooltip-revenue-potential\">\n                              <HelpCircle className=\"h-3 w-3 text-muted-foreground\" />\n                            </Button>\n                          </TooltipTrigger>\n                          <TooltipContent className=\"max-w-xs\">\n                            <p className=\"text-sm\">Based on account revenue and estimated opportunity value.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground\">Potential for incremental revenue</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <Slider\n                      value={[revenuePotentialWeight]}\n                      onValueChange={([val]) => handleWeightChange(setRevenuePotentialWeight, val)}\n                      max={100}\n                      step={5}\n                      className=\"w-32\"\n                      data-testid=\"slider-revenue-potential\"\n                    />\n                    <Input\n                      type=\"number\"\n                      value={revenuePotentialWeight}\n                      onChange={(e) => handleWeightChange(setRevenuePotentialWeight, parseInt(e.target.value) || 0)}\n                      className=\"w-16 text-center\"\n                      min={0}\n                      max={100}\n                      data-testid=\"input-revenue-potential\"\n                    />\n                    <span className=\"text-sm text-muted-foreground w-4\">%</span>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center justify-between flex-wrap gap-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"flex h-9 w-9 items-center justify-center rounded-md bg-chart-2/10\">\n                      <Layers className=\"h-4 w-4 text-chart-2\" />\n                    </div>\n                    <div>\n                      <div className=\"flex items-center gap-2\">\n                        <Label className=\"font-medium\">Category Count</Label>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5 p-0\" data-testid=\"tooltip-category-count\">\n                              <HelpCircle className=\"h-3 w-3 text-muted-foreground\" />\n                            </Button>\n                          </TooltipTrigger>\n                          <TooltipContent className=\"max-w-xs\">\n                            <p className=\"text-sm\">Number of categories where there's a gap opportunity.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground\">Number of categories with gaps</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-3\">\n                    <Slider\n                      value={[categoryCountWeight]}\n                      onValueChange={([val]) => handleWeightChange(setCategoryCountWeight, val)}\n                      max={100}\n                      step={5}\n                      className=\"w-32\"\n                      data-testid=\"slider-category-count\"\n                    />\n                    <Input\n                      type=\"number\"\n                      value={categoryCountWeight}\n                      onChange={(e) => handleWeightChange(setCategoryCountWeight, parseInt(e.target.value) || 0)}\n                      className=\"w-16 text-center\"\n                      min={0}\n                      max={100}\n                      data-testid=\"input-category-count\"\n                    />\n                    <span className=\"text-sm text-muted-foreground w-4\">%</span>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex items-center justify-between pt-4 border-t\">\n                <div className=\"flex items-center gap-2\">\n                  {isValidWeightsTotal ? (\n                    <CheckCircle className=\"h-4 w-4 text-green-500\" />\n                  ) : (\n                    <AlertCircle className=\"h-4 w-4 text-destructive\" />\n                  )}\n                  <span className={`font-medium ${isValidWeightsTotal ? 'text-green-600' : 'text-destructive'}`}>\n                    Total: {weightsTotal}%\n                  </span>\n                  {!isValidWeightsTotal && (\n                    <span className=\"text-sm text-destructive\">(must equal 100%)</span>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"flex gap-3 pt-2\">\n                <Button\n                  onClick={handleSaveWeights}\n                  disabled={!hasWeightChanges || !isValidWeightsTotal || updateWeightsMutation.isPending}\n                  className=\"flex-1\"\n                  data-testid=\"button-save-weights\"\n                >\n                  <Save className=\"mr-2 h-4 w-4\" />\n                  {updateWeightsMutation.isPending ? \"Saving...\" : \"Save Weights\"}\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={handleResetWeights}\n                  disabled={updateWeightsMutation.isPending}\n                  data-testid=\"button-reset-weights\"\n                >\n                  <RotateCcw className=\"mr-2 h-4 w-4\" />\n                  Reset\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"prompts\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <FileText className=\"h-4 w-4\" />\n                Call Script Template\n              </CardTitle>\n              <CardDescription>\n                Template used by AI to generate call scripts\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Textarea\n                rows={10}\n                defaultValue={`Account: {account_name}\nSegment: {segment}\nAnnual Revenue: {last_12m_revenue}\nGap Categories: {gap_categories_with_details}\nRecommended Action: {recommended_action}\n\nGenerate a concise call script for a Territory Manager. Include:\n1. Opening (reference recent orders or relationship)\n2. Transition to gap category (natural, not salesy)\n3. Specific product recommendation with 1-2 benefits\n4. Suggested next step (quote, site visit, sample)\n\nKeep it conversationalâ€”this is a relationship, not a cold call.`}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Mail className=\"h-4 w-4\" />\n                Email Template\n              </CardTitle>\n              <CardDescription>\n                Template used by AI to generate email drafts\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Textarea\n                rows={10}\n                defaultValue={`Account: {account_name}\nContact Name: {contact_name}\nSegment: {segment}\nGap Categories: {gap_categories_with_details}\nRecent Orders: {recent_order_summary}\n\nGenerate a short email (3 paragraphs max) that:\n1. References their business/recent activity\n2. Introduces the gap category naturally (seasonal tie-in, project mention, etc.)\n3. Offers a specific next step (call, quote, catalog)\n\nTone: Helpful, not pushy. This is a trusted supplier relationship.\nSubject line: Keep it specific and under 50 characters.`}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Brain className=\"h-4 w-4\" />\n                ICP Analysis Prompt\n              </CardTitle>\n              <CardDescription>\n                Prompt used for AI-powered segment analysis\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Textarea\n                rows={8}\n                defaultValue={`Analyze the purchasing patterns of Class A {segment} customers.\n\nIdentify:\n1. Which product categories typically appear together\n2. Expected percentage breakdown by category\n3. Which categories are required vs optional\n4. Strategic priorities based on margin and growth potential\n\nOutput a structured profile with category expectations.`}\n              />\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"integrations\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Brain className=\"h-4 w-4\" />\n                AI Provider\n              </CardTitle>\n              <CardDescription>\n                OpenAI integration for AI-powered features\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 rounded-md bg-chart-2/10 border border-chart-2/20\">\n                <div className=\"flex items-center gap-3\">\n                  <CheckCircle className=\"h-5 w-5 text-chart-2\" />\n                  <div>\n                    <p className=\"font-medium\">Connected</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Using Replit AI Integrations\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-chart-2 border-chart-2/30\">\n                  Active\n                </Badge>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Default Model</Label>\n                <Select defaultValue=\"gpt-5.1\">\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select model\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"gpt-5.1\">GPT-5.1 (Recommended)</SelectItem>\n                    <SelectItem value=\"gpt-5\">GPT-5</SelectItem>\n                    <SelectItem value=\"gpt-4o\">GPT-4o</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </CardContent>\n          </Card>\n\n          <EmailConnectionsCard />\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Mail className=\"h-4 w-4\" />\n                Email Provider (Notifications)\n              </CardTitle>\n              <CardDescription>\n                Configure Resend for sending task notification emails to Territory Managers\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 rounded-md bg-muted border\">\n                <div className=\"flex items-center gap-3\">\n                  <AlertCircle className=\"h-5 w-5 text-muted-foreground\" />\n                  <div>\n                    <p className=\"font-medium\">Not Connected</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Configure email provider for notifications\n                    </p>\n                  </div>\n                </div>\n                <Button variant=\"outline\" size=\"sm\">\n                  Configure\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Database className=\"h-4 w-4\" />\n                Database\n              </CardTitle>\n              <CardDescription>\n                PostgreSQL database connection status\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center justify-between p-4 rounded-md bg-chart-2/10 border border-chart-2/20\">\n                <div className=\"flex items-center gap-3\">\n                  <CheckCircle className=\"h-5 w-5 text-chart-2\" />\n                  <div>\n                    <p className=\"font-medium\">Connected</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      PostgreSQL via Neon\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-chart-2 border-chart-2/30\">\n                  Healthy\n                </Badge>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Layers className=\"h-4 w-4\" />\n                ERP Integrations\n              </CardTitle>\n              <CardDescription>\n                Connect your ERP system to automatically sync accounts, orders, and product data\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 rounded-md border bg-muted/30\" data-testid=\"integration-epicor-eclipse\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-9 w-9 rounded-md bg-orange-700 flex items-center justify-center text-white font-bold text-xs\">\n                    ECL\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Epicor Eclipse</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Sync distributor accounts, order history, and product catalogs from Eclipse ERP\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-muted-foreground whitespace-nowrap\">\n                  Coming Soon\n                </Badge>\n              </div>\n\n              <div className=\"flex items-center justify-between p-4 rounded-md border bg-muted/30\" data-testid=\"integration-epicor-prophet21\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-9 w-9 rounded-md bg-orange-600 flex items-center justify-center text-white font-bold text-xs\">\n                    P21\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Epicor Prophet 21</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Import customer data, sales orders, and inventory from Prophet 21\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-muted-foreground whitespace-nowrap\">\n                  Coming Soon\n                </Badge>\n              </div>\n\n              <div className=\"flex items-center justify-between p-4 rounded-md border bg-muted/30\" data-testid=\"integration-epicor-kinetic\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-9 w-9 rounded-md bg-orange-500 flex items-center justify-center text-white font-bold text-xs\">\n                    EPC\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Epicor Kinetic</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Connect Epicor Kinetic / ERP for real-time order and account synchronization\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-muted-foreground whitespace-nowrap\">\n                  Coming Soon\n                </Badge>\n              </div>\n\n              <div className=\"flex items-center justify-between p-4 rounded-md border bg-muted/30\" data-testid=\"integration-infor-csd\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-9 w-9 rounded-md bg-blue-600 flex items-center justify-center text-white font-bold text-xs\">\n                    CSD\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Infor CSD</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Sync customer accounts, orders, and distribution data from Infor CSD\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-muted-foreground whitespace-nowrap\">\n                  Coming Soon\n                </Badge>\n              </div>\n\n              <div className=\"flex items-center justify-between p-4 rounded-md border bg-muted/30\" data-testid=\"integration-epicor-bistrack\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-9 w-9 rounded-md bg-amber-600 flex items-center justify-center text-white font-bold text-xs\">\n                    BIS\n                  </div>\n                  <div>\n                    <p className=\"font-medium\">Epicor BisTrack</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Integrate lumber and building materials data from BisTrack ERP\n                    </p>\n                  </div>\n                </div>\n                <Badge variant=\"outline\" className=\"text-muted-foreground whitespace-nowrap\">\n                  Coming Soon\n                </Badge>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"categories\" className=\"space-y-6\">\n          <CategoriesManager />\n        </TabsContent>\n\n\n        <TabsContent value=\"email\" className=\"space-y-6\">\n          <EmailSettingsManager />\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>\n              {editingManager ? \"Edit Territory Manager\" : \"Add Territory Manager\"}\n            </DialogTitle>\n            <DialogDescription>\n              {editingManager\n                ? \"Update the territory manager's information.\"\n                : \"Add a new territory manager to the system.\"}\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"name\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Name</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"John Smith\" data-testid=\"input-tm-name\" {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Email</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"email\"\n                        placeholder=\"john@example.com\"\n                        data-testid=\"input-tm-email\"\n                        {...field}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"territories\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Territories</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"Northeast, Southeast, Midwest\"\n                        data-testid=\"input-tm-territories\"\n                        {...field}\n                      />\n                    </FormControl>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Comma-separated list of territories/regions\n                    </p>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={form.control}\n                name=\"isActive\"\n                render={({ field }) => (\n                  <FormItem className=\"flex items-center justify-between\">\n                    <FormLabel>Active</FormLabel>\n                    <FormControl>\n                      <Switch\n                        checked={field.value}\n                        onCheckedChange={field.onChange}\n                        data-testid=\"switch-tm-active\"\n                      />\n                    </FormControl>\n                  </FormItem>\n                )}\n              />\n              <DialogFooter>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setIsDialogOpen(false)}\n                  data-testid=\"button-cancel-tm\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending || updateMutation.isPending}\n                  data-testid=\"button-submit-tm\"\n                >\n                  {(createMutation.isPending || updateMutation.isPending) && (\n                    <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\n                  )}\n                  {editingManager ? \"Update\" : \"Create\"}\n                </Button>\n              </DialogFooter>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":119215,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"server/services/dataInsightsService.ts":{"content":"import type { Account, AccountMetrics, AccountCategoryGap, ProductCategory, SegmentProfile } from \"@shared/schema\";\nimport { SCORING } from \"../utils/constants\";\n\nexport interface AccountWithMetrics {\n  account: Account;\n  metrics: AccountMetrics | undefined;\n}\n\nexport interface CategoryDataPoint {\n  accountName: string;\n  accountId: number;\n  categoryPct: number;\n  revenue: number;\n  isClassA: boolean;\n}\n\nexport interface ProfileCategory {\n  categoryName: string;\n  expectedPct: number;\n  importance: number;\n  isRequired: boolean;\n  notes: string;\n}\n\nexport function calculateClassACustomers(\n  accountsWithMetrics: AccountWithMetrics[],\n  minRevenue: number\n): AccountWithMetrics[] {\n  return accountsWithMetrics.filter(({ metrics }) => {\n    const revenue = metrics?.last12mRevenue ? parseFloat(metrics.last12mRevenue) : 0;\n    return revenue >= minRevenue;\n  });\n}\n\nexport function calculateTotalRevenue(classACustomers: AccountWithMetrics[]): number {\n  return classACustomers.reduce((sum, { metrics }) => {\n    return sum + (metrics?.last12mRevenue ? parseFloat(metrics.last12mRevenue) : 0);\n  }, 0);\n}\n\nexport function calculateAvgCategoryCount(classACustomers: AccountWithMetrics[]): number {\n  if (classACustomers.length === 0) return 0;\n  return Math.round(\n    classACustomers.reduce((sum, { metrics }) => {\n      return sum + (metrics?.categoryCount || 0);\n    }, 0) / classACustomers.length\n  );\n}\n\nexport function calculateSegmentBreakdown(\n  allAccounts: Account[],\n  metricsMap: Map<number, AccountMetrics>\n): Array<{ segment: string; count: number; avgRevenue: number }> {\n  const allSegments = allAccounts.reduce((acc, a) => {\n    if (a.segment) acc.add(a.segment);\n    return acc;\n  }, new Set<string>());\n\n  return Array.from(allSegments).map(seg => {\n    const accounts = allAccounts.filter(a => a.segment === seg);\n    const revenues = accounts.map(acc => {\n      const m = metricsMap.get(acc.id);\n      return m?.last12mRevenue ? parseFloat(m.last12mRevenue) : 0;\n    });\n    const avgRevenue = revenues.length > 0\n      ? revenues.reduce((sum, r) => sum + r, 0) / revenues.length\n      : 0;\n    return {\n      segment: seg,\n      count: accounts.length,\n      avgRevenue: Math.round(avgRevenue),\n    };\n  });\n}\n\nexport function calculateAlignmentMetrics(\n  segmentAccounts: Account[],\n  gapsMap: Map<number, AccountCategoryGap[]>,\n  productCatMap: Map<number, ProductCategory>\n): {\n  alignmentScore: number;\n  accountsNearICP: number;\n  revenueAtRisk: number;\n  topGaps: Array<{ category: string; gapPct: number }>;\n} {\n  const flatGaps = segmentAccounts.flatMap(acc => gapsMap.get(acc.id) || []);\n\n  const gapsByCategory: Record<string, number[]> = {};\n  flatGaps.forEach(gap => {\n    const cat = productCatMap.get(gap.categoryId);\n    const catName = cat?.name || \"Unknown\";\n    if (!gapsByCategory[catName]) gapsByCategory[catName] = [];\n    gapsByCategory[catName].push(gap.gapPct ? parseFloat(gap.gapPct) : 0);\n  });\n\n  const topGaps = Object.entries(gapsByCategory)\n    .map(([category, gaps]) => ({\n      category,\n      gapPct: gaps.length > 0 ? Math.round(gaps.reduce((a, b) => a + b, 0) / gaps.length) : 0,\n    }))\n    .sort((a, b) => b.gapPct - a.gapPct)\n    .slice(0, 3);\n\n  const avgGap = flatGaps.length > 0\n    ? flatGaps.reduce((sum, g) => sum + (g.gapPct ? parseFloat(g.gapPct) : 0), 0) / flatGaps.length\n    : SCORING.DEFAULT_GAP_PERCENTAGE;\n  const alignmentScore = Math.round(100 - avgGap);\n\n  const accountAlignments = segmentAccounts.map(acc => {\n    const gaps = gapsMap.get(acc.id) || [];\n    if (gaps.length === 0) return { account: acc, isNearICP: false };\n    const avgAccountGap = gaps.reduce((sum, g) => sum + (g.gapPct ? parseFloat(g.gapPct) : 0), 0) / gaps.length;\n    return { account: acc, isNearICP: avgAccountGap <= SCORING.NEAR_ICP_THRESHOLD };\n  });\n  const accountsNearICP = accountAlignments.filter(a => a.isNearICP).length;\n\n  const totalEstimatedOpportunity = flatGaps.reduce((sum, g) =>\n    sum + (g.estimatedOpportunity ? parseFloat(g.estimatedOpportunity) : 0), 0);\n  const revenueAtRisk = Math.round(totalEstimatedOpportunity);\n\n  return { alignmentScore, accountsNearICP, revenueAtRisk, topGaps };\n}\n\nexport function buildCategoryDataPointsMap(\n  classACustomers: AccountWithMetrics[],\n  gapsMap: Map<number, AccountCategoryGap[]>,\n  productCatMap: Map<number, ProductCategory>\n): Record<string, CategoryDataPoint[]> {\n  const categoryDataPointsMap: Record<string, CategoryDataPoint[]> = {};\n\n  for (const { account, metrics } of classACustomers) {\n    const accountGaps = gapsMap.get(account.id) || [];\n    const revenue = metrics?.last12mRevenue ? parseFloat(metrics.last12mRevenue) : 0;\n\n    for (const gap of accountGaps) {\n      const catInfo = productCatMap.get(gap.categoryId);\n      const catName = catInfo?.name || \"Unknown\";\n      if (!categoryDataPointsMap[catName]) {\n        categoryDataPointsMap[catName] = [];\n      }\n      categoryDataPointsMap[catName].push({\n        accountName: account.name,\n        accountId: account.id,\n        categoryPct: gap.actualPct ? parseFloat(gap.actualPct) : 0,\n        revenue: revenue,\n        isClassA: true,\n      });\n    }\n  }\n\n  return categoryDataPointsMap;\n}\n\nexport function calculateTerritoryRanking(\n  segmentAccounts: Account[],\n  metricsMap: Map<number, AccountMetrics>\n): Array<{ tm: string; avgAlignment: number; accountCount: number }> {\n  const tmSet = segmentAccounts.reduce((acc, a) => {\n    if (a.assignedTm) acc.add(a.assignedTm);\n    return acc;\n  }, new Set<string>());\n\n  const tmList = Array.from(tmSet);\n  const territoryRanking = tmList.slice(0, 4).map(tm => {\n    const tmAccounts = segmentAccounts.filter(a => a.assignedTm === tm);\n    const tmMetricsValues = tmAccounts.map(acc => {\n      const m = metricsMap.get(acc.id);\n      return m?.categoryPenetration ? parseFloat(m.categoryPenetration) : 50;\n    });\n    const avgAlignment = tmMetricsValues.length > 0\n      ? Math.round(tmMetricsValues.reduce((a, b) => a + b, 0) / tmMetricsValues.length)\n      : 50;\n    return {\n      tm,\n      avgAlignment,\n      accountCount: tmAccounts.length,\n    };\n  });\n\n  territoryRanking.sort((a, b) => b.avgAlignment - a.avgAlignment);\n  return territoryRanking;\n}\n","path":null,"size_bytes":6208,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"tests/integration/program-enrollment.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\n\nconst mockStorage = {\n  getProgramAccounts: vi.fn(),\n  getProgramAccount: vi.fn(),\n  createProgramAccount: vi.fn(),\n  updateProgramAccount: vi.fn(),\n  getAccount: vi.fn(),\n  getAccountMetrics: vi.fn(),\n  getAccountsBatch: vi.fn(),\n  getAccountMetricsBatch: vi.fn(),\n  getProgramRevenueSnapshots: vi.fn(),\n  getProgramRevenueSnapshotsBatch: vi.fn(),\n};\n\ndescribe('Program Enrollment Integration Tests', () => {\n  beforeEach(() => {\n    vi.clearAllMocks();\n  });\n\n  describe('GET /api/program-accounts', () => {\n    it('returns all program accounts for tenant', async () => {\n      const programAccounts = [\n        { id: 1, accountId: 1, status: 'active', enrolledAt: new Date() },\n        { id: 2, accountId: 2, status: 'graduated', enrolledAt: new Date() },\n      ];\n\n      mockStorage.getProgramAccounts.mockResolvedValue(programAccounts);\n\n      const result = await mockStorage.getProgramAccounts();\n\n      expect(result).toHaveLength(2);\n    });\n\n    it('includes active and graduated accounts', async () => {\n      const programAccounts = [\n        { id: 1, accountId: 1, status: 'active' },\n        { id: 2, accountId: 2, status: 'graduated' },\n        { id: 3, accountId: 3, status: 'removed' },\n      ];\n\n      mockStorage.getProgramAccounts.mockResolvedValue(programAccounts);\n\n      const result = await mockStorage.getProgramAccounts();\n      const active = result.filter((pa: any) => pa.status === 'active');\n      const graduated = result.filter((pa: any) => pa.status === 'graduated');\n\n      expect(active).toHaveLength(1);\n      expect(graduated).toHaveLength(1);\n    });\n  });\n\n  describe('POST /api/program-accounts/enroll', () => {\n    it('enrolls an account in the program', async () => {\n      const accountId = 1;\n      const enrollmentData = {\n        accountId,\n        targetPenetration: '75',\n        targetIncrementalRevenue: '50000',\n        targetDurationMonths: 12,\n        graduationCriteria: 'any',\n      };\n\n      const enrolled = {\n        id: 1,\n        ...enrollmentData,\n        status: 'active',\n        enrolledAt: new Date(),\n      };\n\n      mockStorage.getAccount.mockResolvedValue({ id: accountId, name: 'Test Account' });\n      mockStorage.createProgramAccount.mockResolvedValue(enrolled);\n\n      const account = await mockStorage.getAccount(accountId);\n      expect(account).toBeDefined();\n\n      const result = await mockStorage.createProgramAccount(enrollmentData);\n      expect(result.status).toBe('active');\n      expect(result.accountId).toBe(accountId);\n    });\n\n    it('sets default graduation criteria to \"any\"', async () => {\n      const enrolled = {\n        id: 1,\n        accountId: 1,\n        status: 'active',\n        graduationCriteria: 'any',\n        enrolledAt: new Date(),\n      };\n\n      mockStorage.createProgramAccount.mockResolvedValue(enrolled);\n\n      const result = await mockStorage.createProgramAccount({ accountId: 1 });\n\n      expect(result.graduationCriteria).toBe('any');\n    });\n  });\n\n  describe('GET /api/program-accounts/graduation-ready', () => {\n    it('returns empty array when no accounts are ready', async () => {\n      mockStorage.getProgramAccounts.mockResolvedValue([]);\n\n      const result = await mockStorage.getProgramAccounts();\n      const activeAccounts = result.filter((pa: any) => pa.status === 'active');\n\n      expect(activeAccounts).toHaveLength(0);\n    });\n\n    it('uses batch queries for performance', async () => {\n      const activeAccounts = [\n        { id: 1, accountId: 1, status: 'active', targetPenetration: '50', enrolledAt: new Date() },\n        { id: 2, accountId: 2, status: 'active', targetPenetration: '60', enrolledAt: new Date() },\n      ];\n\n      mockStorage.getProgramAccounts.mockResolvedValue(activeAccounts);\n      mockStorage.getAccountsBatch.mockResolvedValue(new Map([\n        [1, { id: 1, name: 'Account 1' }],\n        [2, { id: 2, name: 'Account 2' }],\n      ]));\n      mockStorage.getAccountMetricsBatch.mockResolvedValue(new Map([\n        [1, { accountId: 1, categoryPenetration: '75' }],\n        [2, { accountId: 2, categoryPenetration: '45' }],\n      ]));\n      mockStorage.getProgramRevenueSnapshotsBatch.mockResolvedValue(new Map());\n\n      const [accountsMap, metricsMap] = await Promise.all([\n        mockStorage.getAccountsBatch([1, 2]),\n        mockStorage.getAccountMetricsBatch([1, 2]),\n      ]);\n\n      expect(accountsMap.size).toBe(2);\n      expect(metricsMap.size).toBe(2);\n      expect(mockStorage.getAccountsBatch).toHaveBeenCalledWith([1, 2]);\n      expect(mockStorage.getAccountMetricsBatch).toHaveBeenCalledWith([1, 2]);\n    });\n\n    it('identifies accounts meeting penetration objective', async () => {\n      const programAccount = {\n        id: 1,\n        accountId: 1,\n        status: 'active',\n        targetPenetration: '50',\n        targetIncrementalRevenue: null,\n        targetDurationMonths: null,\n        graduationCriteria: 'any',\n        enrolledAt: new Date(),\n      };\n\n      const metrics = { accountId: 1, categoryPenetration: '75' };\n\n      const currentPenetration = parseFloat(metrics.categoryPenetration);\n      const targetPenetration = parseFloat(programAccount.targetPenetration);\n\n      const meetsObjective = currentPenetration >= targetPenetration;\n\n      expect(meetsObjective).toBe(true);\n    });\n\n    it('identifies accounts meeting revenue objective', async () => {\n      const programAccount = {\n        id: 1,\n        accountId: 1,\n        status: 'active',\n        targetPenetration: null,\n        targetIncrementalRevenue: '25000',\n        targetDurationMonths: null,\n        graduationCriteria: 'any',\n        enrolledAt: new Date(),\n      };\n\n      const snapshots = [\n        { incrementalRevenue: '15000' },\n        { incrementalRevenue: '12000' },\n      ];\n\n      const totalRevenue = snapshots.reduce(\n        (sum, s) => sum + parseFloat(s.incrementalRevenue),\n        0\n      );\n      const targetRevenue = parseFloat(programAccount.targetIncrementalRevenue);\n\n      expect(totalRevenue).toBe(27000);\n      expect(totalRevenue >= targetRevenue).toBe(true);\n    });\n\n    it('evaluates \"all\" graduation criteria correctly', async () => {\n      const programAccount = {\n        targetPenetration: '50',\n        targetIncrementalRevenue: '25000',\n        targetDurationMonths: 6,\n        graduationCriteria: 'all',\n      };\n\n      const objectivesMet = {\n        penetration: true,\n        revenue: true,\n        duration: true,\n      };\n\n      const criteria = programAccount.graduationCriteria;\n      let isReady = false;\n\n      if (criteria === 'all') {\n        isReady = objectivesMet.penetration && objectivesMet.revenue && objectivesMet.duration;\n      }\n\n      expect(isReady).toBe(true);\n    });\n\n    it('evaluates \"any\" graduation criteria correctly', async () => {\n      const programAccount = {\n        targetPenetration: '50',\n        targetIncrementalRevenue: '25000',\n        targetDurationMonths: 6,\n        graduationCriteria: 'any',\n      };\n\n      const objectivesMet = {\n        penetration: true,\n        revenue: false,\n        duration: false,\n      };\n\n      const criteria = programAccount.graduationCriteria;\n      let isReady = false;\n\n      if (criteria === 'any') {\n        isReady = objectivesMet.penetration || objectivesMet.revenue || objectivesMet.duration;\n      }\n\n      expect(isReady).toBe(true);\n    });\n  });\n\n  describe('POST /api/program-accounts/:id/graduate', () => {\n    it('graduates an account successfully', async () => {\n      const programAccount = {\n        id: 1,\n        accountId: 1,\n        status: 'active',\n      };\n\n      const graduated = {\n        ...programAccount,\n        status: 'graduated',\n        graduatedAt: new Date(),\n      };\n\n      mockStorage.getProgramAccount.mockResolvedValue(programAccount);\n      mockStorage.updateProgramAccount.mockResolvedValue(graduated);\n\n      const existing = await mockStorage.getProgramAccount(1);\n      expect(existing.status).toBe('active');\n\n      const result = await mockStorage.updateProgramAccount(1, { status: 'graduated' });\n      expect(result.status).toBe('graduated');\n    });\n\n    it('returns error for already graduated account', async () => {\n      const programAccount = {\n        id: 1,\n        accountId: 1,\n        status: 'graduated',\n      };\n\n      mockStorage.getProgramAccount.mockResolvedValue(programAccount);\n\n      const existing = await mockStorage.getProgramAccount(1);\n\n      expect(existing.status).toBe('graduated');\n    });\n  });\n});\n","path":null,"size_bytes":8518,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/replit_integrations/audio/useVoiceRecorder.ts":{"content":"/**\n * React hook for voice recording using MediaRecorder API.\n * Records audio in WebM/Opus format for efficient streaming.\n */\nimport { useRef, useCallback, useState } from \"react\";\n\nexport type RecordingState = \"idle\" | \"recording\" | \"stopped\";\n\nexport function useVoiceRecorder() {\n  const [state, setState] = useState<RecordingState>(\"idle\");\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\n  const chunksRef = useRef<Blob[]>([]);\n\n  const startRecording = useCallback(async (): Promise<void> => {\n    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n    const recorder = new MediaRecorder(stream, {\n      mimeType: \"audio/webm;codecs=opus\",\n    });\n\n    mediaRecorderRef.current = recorder;\n    chunksRef.current = [];\n\n    recorder.ondataavailable = (e) => {\n      if (e.data.size > 0) chunksRef.current.push(e.data);\n    };\n\n    recorder.start(100); // Collect chunks every 100ms\n    setState(\"recording\");\n  }, []);\n\n  const stopRecording = useCallback((): Promise<Blob> => {\n    return new Promise((resolve) => {\n      const recorder = mediaRecorderRef.current;\n      if (!recorder || recorder.state !== \"recording\") {\n        resolve(new Blob());\n        return;\n      }\n\n      recorder.onstop = () => {\n        const blob = new Blob(chunksRef.current, { type: \"audio/webm\" });\n        recorder.stream.getTracks().forEach((t) => t.stop());\n        setState(\"stopped\");\n        resolve(blob);\n      };\n\n      recorder.stop();\n    });\n  }, []);\n\n  return { state, startRecording, stopRecording };\n}\n\n","path":null,"size_bytes":1550,"size_tokens":null},"tests/integration/setup.ts":{"content":"import express, { Express, Request, Response, NextFunction } from 'express';\nimport { vi } from 'vitest';\nimport { TenantStorage } from '../../server/storage/tenantStorage';\n\nexport interface MockUser {\n  id: string;\n  email: string;\n  firstName: string | null;\n  lastName: string | null;\n}\n\nexport interface MockTenantContext {\n  tenantId: number;\n  userId: string;\n  role: string;\n  permissions: string[];\n  tenant: {\n    id: number;\n    name: string;\n    subscriptionStatus: string | null;\n    planType: string;\n    stripeCustomerId: string | null;\n    billingPeriodEnd: string | null;\n  };\n  storage: TenantStorage;\n}\n\nexport function createTestApp(): Express {\n  const app = express();\n  app.use(express.json());\n  app.use(express.urlencoded({ extended: false }));\n  return app;\n}\n\nexport function mockAuthentication(user: MockUser) {\n  return (req: Request, _res: Response, next: NextFunction) => {\n    (req as any).user = user;\n    (req as any).isAuthenticated = () => true;\n    next();\n  };\n}\n\nexport function mockTenantContext(context: Partial<MockTenantContext>) {\n  return (req: Request, _res: Response, next: NextFunction) => {\n    (req as any).tenantContext = {\n      tenantId: context.tenantId ?? 1,\n      userId: context.userId ?? 'test-user-id',\n      role: context.role ?? 'super_admin',\n      permissions: context.permissions ?? ['read', 'write', 'delete', 'manage_users', 'manage_settings'],\n      tenant: context.tenant ?? {\n        id: 1,\n        name: 'Test Tenant',\n        subscriptionStatus: 'active',\n        planType: 'professional',\n        stripeCustomerId: null,\n        billingPeriodEnd: null,\n      },\n      storage: context.storage ?? new TenantStorage(context.tenantId ?? 1),\n    };\n    next();\n  };\n}\n\nexport function mockUnauthenticated() {\n  return (req: Request, _res: Response, next: NextFunction) => {\n    (req as any).isAuthenticated = () => false;\n    next();\n  };\n}\n\nexport function mockFreeUser(userId: string = 'free-user-id', tenantId: number = 2) {\n  return (req: Request, _res: Response, next: NextFunction) => {\n    (req as any).user = { id: userId, email: 'free@test.com', firstName: null, lastName: null };\n    (req as any).isAuthenticated = () => true;\n    (req as any).tenantContext = {\n      tenantId,\n      userId,\n      role: 'super_admin',\n      permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],\n      tenant: {\n        id: tenantId,\n        name: 'Free Tenant',\n        subscriptionStatus: null,\n        planType: 'free',\n        stripeCustomerId: null,\n        billingPeriodEnd: null,\n      },\n      storage: new TenantStorage(tenantId),\n    };\n    next();\n  };\n}\n\nexport function mockSubscribedUser(userId: string = 'subscribed-user-id', tenantId: number = 1) {\n  return (req: Request, _res: Response, next: NextFunction) => {\n    (req as any).user = { id: userId, email: 'subscribed@test.com', firstName: 'Test', lastName: 'User' };\n    (req as any).isAuthenticated = () => true;\n    (req as any).tenantContext = {\n      tenantId,\n      userId,\n      role: 'super_admin',\n      permissions: ['read', 'write', 'delete', 'manage_users', 'manage_settings'],\n      tenant: {\n        id: tenantId,\n        name: 'Subscribed Tenant',\n        subscriptionStatus: 'active',\n        planType: 'professional',\n        stripeCustomerId: 'cus_test123',\n        billingPeriodEnd: '2026-02-27',\n      },\n      storage: new TenantStorage(tenantId),\n    };\n    next();\n  };\n}\n\nexport const testUser: MockUser = {\n  id: 'test-user-123',\n  email: 'test@example.com',\n  firstName: 'Test',\n  lastName: 'User',\n};\n\nexport const testTenant = {\n  id: 1,\n  name: 'Test Company',\n  subscriptionStatus: 'active',\n  planType: 'professional',\n  stripeCustomerId: 'cus_test',\n  billingPeriodEnd: '2026-02-27',\n};\n","path":null,"size_bytes":3772,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { SidebarProvider, SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/app-sidebar\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport NotFound from \"@/pages/not-found\";\nimport Dashboard from \"@/pages/dashboard\";\nimport Accounts from \"@/pages/accounts\";\nimport ICPBuilder from \"@/pages/icp-builder\";\nimport Playbooks from \"@/pages/playbooks\";\nimport Revenue from \"@/pages/revenue\";\nimport DataUploads from \"@/pages/data-uploads\";\nimport Settings from \"@/pages/settings\";\nimport WorkflowGuide from \"@/pages/workflow-guide\";\nimport Profile from \"@/pages/profile\";\nimport Subscription from \"@/pages/subscription\";\nimport AppAdmin from \"@/pages/app-admin\";\nimport Landing from \"@/pages/landing\";\nimport ProgramPerformance from \"@/pages/program-performance\";\nimport CRMContacts from \"@/pages/crm-contacts\";\nimport CRMProjects from \"@/pages/crm-projects\";\nimport CRMSignals from \"@/pages/crm-signals\";\nimport { AskAnythingBar } from \"@/components/ask-anything-bar\";\n\nfunction AuthenticatedRouter() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/accounts\" component={Accounts} />\n      <Route path=\"/icp-builder\" component={ICPBuilder} />\n      <Route path=\"/playbooks\" component={Playbooks} />\n      <Route path=\"/revenue\" component={Revenue} />\n      <Route path=\"/data-uploads\" component={DataUploads} />\n      <Route path=\"/settings\" component={Settings} />\n      <Route path=\"/workflow-guide\" component={WorkflowGuide} />\n      <Route path=\"/profile\" component={Profile} />\n      <Route path=\"/subscription\" component={Subscription} />\n      <Route path=\"/app-admin\" component={AppAdmin} />\n      <Route path=\"/program-performance\" component={ProgramPerformance} />\n      <Route path=\"/crm/contacts\" component={CRMContacts} />\n      <Route path=\"/crm/projects\" component={CRMProjects} />\n      <Route path=\"/crm/signals\" component={CRMSignals} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AuthenticatedLayout() {\n  const style = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  };\n\n  return (\n    <SidebarProvider style={style as React.CSSProperties}>\n      <div className=\"flex h-screen w-full\">\n        <AppSidebar />\n        <div className=\"flex flex-col flex-1 min-w-0\">\n          <header className=\"flex items-center justify-between gap-1 p-2 border-b sticky top-0 z-50 bg-background\">\n            <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n            <AskAnythingBar />\n            <ThemeToggle />\n          </header>\n          <main className=\"flex-1 overflow-auto\">\n            <AuthenticatedRouter />\n          </main>\n        </div>\n      </div>\n    </SidebarProvider>\n  );\n}\n\nfunction AppContent() {\n  const { user, isLoading } = useAuth();\n  const [location] = useLocation();\n\n  if (location === \"/promo\" || location === \"/landing\") {\n    return <Landing />;\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-screen bg-background\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent\" />\n          <p className=\"text-sm text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return <Landing />;\n  }\n\n  return <AuthenticatedLayout />;\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"light\" storageKey=\"ai-vp-theme\">\n        <TooltipProvider>\n          <Toaster />\n          <AppContent />\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":4111,"size_tokens":null},"server/middleware/subscription.ts":{"content":"import { RequestHandler, Request, Response, NextFunction } from \"express\";\nimport type { TenantContext } from \"./tenantContext\";\nimport \"../types/express.d\";\n\nexport const requireActiveSubscription: RequestHandler = (\n  req: Request,\n  res: Response,\n  next: NextFunction\n) => {\n  const tenantContext = req.tenantContext;\n  const tenant = tenantContext?.tenant;\n\n  if (!tenant) {\n    return res.status(401).json({ message: \"Not authenticated\" });\n  }\n\n  const activeStatuses = [\"active\", \"trialing\"];\n  if (!activeStatuses.includes(tenant.subscriptionStatus || \"\")) {\n    return res.status(402).json({\n      message: \"Active subscription required\",\n      subscriptionStatus: tenant.subscriptionStatus || \"none\",\n      planType: tenant.planType || \"free\",\n    });\n  }\n\n  next();\n};\n\nexport const requirePlan = (\n  minPlan: \"starter\" | \"professional\" | \"enterprise\"\n): RequestHandler => {\n  const planHierarchy: Record<string, number> = {\n    free: 0,\n    starter: 1,\n    professional: 2,\n    enterprise: 3,\n  };\n\n  return (req: Request, res: Response, next: NextFunction) => {\n    const tenantContext = req.tenantContext;\n    const tenant = tenantContext?.tenant;\n\n    if (!tenant) {\n      return res.status(401).json({ message: \"Not authenticated\" });\n    }\n\n    const currentPlanLevel = planHierarchy[tenant.planType || \"free\"] || 0;\n    const requiredLevel = planHierarchy[minPlan];\n\n    if (currentPlanLevel < requiredLevel) {\n      return res.status(403).json({\n        message: `${minPlan} plan or higher required`,\n        currentPlan: tenant.planType || \"free\",\n        requiredPlan: minPlan,\n      });\n    }\n\n    next();\n  };\n};\n\nexport const checkSubscriptionStatus: RequestHandler = (\n  req: Request,\n  res: Response,\n  next: NextFunction\n) => {\n  const tenantContext = req.tenantContext;\n  const tenant = tenantContext?.tenant;\n\n  if (tenant) {\n    (req as any).subscriptionInfo = {\n      isActive: [\"active\", \"trialing\"].includes(tenant.subscriptionStatus || \"\"),\n      status: tenant.subscriptionStatus || \"none\",\n      planType: tenant.planType || \"free\",\n      billingPeriodEnd: tenant.billingPeriodEnd,\n    };\n  }\n\n  next();\n};\n","path":null,"size_bytes":2144,"size_tokens":null},"server/services/weekly-account-review.ts":{"content":"/**\n * Weekly Account Review Service â€” Phase 3\n *\n * POST /api/agent/weekly-account-review\n * (Also triggered by node-cron Mondays 6am EST in scheduler.ts)\n *\n * For each enrolled account per tenant:\n *   1. Assembles full context\n *   2. Asks gpt-4o: graduation readiness, playbook effectiveness, risk signals\n *   3. Auto-graduates accounts meeting the threshold (updates enrollment_status)\n *   4. Rotates stale playbooks (marks old active â†’ rotated, triggers new generation)\n *   5. Sends congratulations email to TM on graduation\n *   6. Updates agent_state for weekly-account-review\n */\n\nimport OpenAI from \"openai\";\nimport { z } from \"zod\";\nimport { db } from \"../db\";\nimport { accounts, agentPlaybooks } from \"@shared/schema\";\nimport { and, eq } from \"drizzle-orm\";\nimport { assembleAccountContext, buildFullSystemPrompt } from \"./account-context\";\nimport { writeAgentMemo, AGENT_MEMO_INSTRUCTION } from \"./agent-identity\";\nimport { Resend } from \"resend\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\nconst resend = new Resend(process.env.RESEND_API_KEY);\nconst FROM_EMAIL = \"noreply@ignition.tenexity.ai\";\n\n// â”€â”€â”€ Response schema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst ReviewResponseSchema = z.object({\n    graduation_ready: z.boolean(),\n    graduation_confidence: z.number().min(0).max(1),\n    graduation_reason: z.string(),\n    risk_level: z.enum([\"low\", \"medium\", \"high\", \"critical\"]),\n    risk_signals: z.array(z.string()).max(3),\n    playbook_effectiveness: z.enum([\"effective\", \"needs_rotation\", \"no_playbook\"]),\n    recommended_next_playbook_type: z.string().nullable(),\n    rep_action_this_week: z.string().max(300),\n    agent_memo: z.object({\n        last_run_summary: z.string(),\n        current_focus: z.string(),\n        pattern_notes_addition: z.string(),\n        anomalies_watching: z.array(z.object({\n            account_name: z.string(),\n            signal: z.string(),\n            watch_until_date: z.string(),\n        })),\n    }),\n});\n\nconst GRADUATION_THRESHOLD = 0.75; // confidence score required to auto-graduate\n\n// â”€â”€â”€ Graduation email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function sendGraduationEmail(repEmail: string, accountName: string, reason: string): Promise<void> {\n    await resend.emails.send({\n        from: FROM_EMAIL,\n        to: repEmail,\n        subject: `ðŸŽ“ Account Graduated: ${accountName}`,\n        html: `\n      <div style=\"font-family: sans-serif; max-width: 600px; margin: 0 auto;\">\n        <div style=\"background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); padding: 24px 32px; border-radius: 8px 8px 0 0;\">\n          <h2 style=\"margin: 0; color: white;\">ðŸŽ“ Account Graduated!</h2>\n        </div>\n        <div style=\"padding: 24px 32px; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px;\">\n          <h3 style=\"color: #111;\">${accountName}</h3>\n          <p style=\"color: #374151;\">${reason}</p>\n          <p style=\"color: #374151;\">This account has met the graduation threshold and has been moved to <strong>Graduated</strong> status. Consider using them as a reference or proof point for similar accounts.</p>\n          <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 16px 0;\" />\n          <p style=\"color: #888; font-size: 12px;\">Wallet Share Expander Â· Revenue Intelligence Agent</p>\n        </div>\n      </div>\n    `,\n    });\n}\n\n// â”€â”€â”€ Main service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function runWeeklyAccountReview(tenantId: number): Promise<{\n    reviewed: number;\n    graduated: number;\n    rotated: number;\n    atRisk: number;\n}> {\n    // Get all enrolled accounts\n    const enrolledAccounts = await db.select().from(accounts)\n        .where(and(\n            eq(accounts.tenantId, tenantId),\n            eq((accounts as any).enrollmentStatus, \"enrolled\"),\n        ));\n\n    let graduated = 0;\n    let rotated = 0;\n    let atRisk = 0;\n\n    const today = new Date().toISOString().slice(0, 10);\n    let lastMemo: z.infer<typeof ReviewResponseSchema>[\"agent_memo\"] | null = null;\n\n    for (const account of enrolledAccounts) {\n        try {\n            const ctx = await assembleAccountContext(account.id, tenantId);\n            const systemPrompt = await buildFullSystemPrompt(ctx);\n\n            const completion = await openai.chat.completions.create({\n                model: \"gpt-4o\",\n                temperature: 0.2,\n                response_format: { type: \"json_object\" },\n                messages: [\n                    { role: \"system\", content: systemPrompt },\n                    {\n                        role: \"user\",\n                        content: [\n                            `Weekly review for account: ${account.name} | Date: ${today}`,\n                            \"\",\n                            \"Assess:\",\n                            \"1. Graduation readiness â€” has this account achieved consistent, broad category penetration and strong revenue growth? Should it be moved to 'graduated' status?\",\n                            \"2. Risk level â€” low/medium/high/critical based on recency, trend, and interaction signals\",\n                            \"3. Playbook effectiveness â€” is the current playbook working or does it need rotation?\",\n                            \"4. Single most important rep action for this week\",\n                            AGENT_MEMO_INSTRUCTION,\n                        ].join(\"\\n\"),\n                    },\n                ],\n            });\n\n            const raw = JSON.parse(completion.choices[0].message.content ?? \"{}\");\n            const review = ReviewResponseSchema.parse(raw);\n\n            // Auto-graduate\n            if (review.graduation_ready && review.graduation_confidence >= GRADUATION_THRESHOLD) {\n                await db.update(accounts)\n                    .set({\n                        graduatedAt: new Date(),\n                        ...(({ enrollmentStatus: \"graduated\" }) as any),\n                    } as any)\n                    .where(eq(accounts.id, account.id));\n\n                if (account.assignedTm) {\n                    try {\n                        await sendGraduationEmail(account.assignedTm, account.name, review.graduation_reason);\n                    } catch (err) {\n                        console.error(`[weekly-review] Graduation email failed for ${account.name}:`, err);\n                    }\n                }\n                graduated++;\n                console.log(`[weekly-review] Graduated: ${account.name} (confidence: ${review.graduation_confidence})`);\n            }\n\n            // Rotate stale playbook\n            if (review.playbook_effectiveness === \"needs_rotation\") {\n                await db.update(agentPlaybooks)\n                    .set({ status: \"rotated\", rotatedAt: new Date() })\n                    .where(and(\n                        eq(agentPlaybooks.accountId, account.id),\n                        eq(agentPlaybooks.tenantId, tenantId),\n                        eq(agentPlaybooks.status, \"active\"),\n                    ));\n                rotated++;\n                console.log(`[weekly-review] Rotated playbook for: ${account.name}`);\n            }\n\n            if (review.risk_level === \"high\" || review.risk_level === \"critical\") atRisk++;\n            lastMemo = review.agent_memo;\n\n        } catch (err) {\n            console.error(`[weekly-review] Failed for account ${account.id} (${account.name}):`, err);\n        }\n    }\n\n    if (lastMemo) {\n        await writeAgentMemo(tenantId, \"weekly-account-review\", lastMemo);\n    }\n\n    console.log(`[weekly-review] Complete: ${enrolledAccounts.length} reviewed, ${graduated} graduated, ${rotated} rotated, ${atRisk} at-risk`);\n    return { reviewed: enrolledAccounts.length, graduated, rotated, atRisk };\n}\n","path":null,"size_bytes":8164,"size_tokens":null},"shared/models/chat.ts":{"content":"import { pgTable, serial, integer, text, timestamp } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { sql } from \"drizzle-orm\";\n\nexport const conversations = pgTable(\"conversations\", {\n  id: serial(\"id\").primaryKey(),\n  title: text(\"title\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const messages = pgTable(\"messages\", {\n  id: serial(\"id\").primaryKey(),\n  conversationId: integer(\"conversation_id\").notNull().references(() => conversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").default(sql`CURRENT_TIMESTAMP`).notNull(),\n});\n\nexport const insertConversationSchema = createInsertSchema(conversations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertMessageSchema = createInsertSchema(messages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Conversation = typeof conversations.$inferSelect;\nexport type InsertConversation = z.infer<typeof insertConversationSchema>;\nexport type Message = typeof messages.$inferSelect;\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\n\n","path":null,"size_bytes":1229,"size_tokens":null},"attached_assets/â€œAI_VPâ€_Dashboard_â€“_PRDv2_1769191094606.md":{"content":"# **AI VP Dashboard â€” Streamlined Product Requirements Document (v2)**\n\n## **1\\. Product Overview**\n\n**Product Name:** AI VP Dashboard  \n **Primary Users:** Graham (Admin), Mark Minnich (Manager/President)  \n **Target Company:** Mark Supply\n\n### **Purpose**\n\nA sales intelligence tool that identifies **wallet share leakage**â€”contractors who should be buying more product categories from Mark Supply but are clearly purchasing them elsewhereâ€”and prompts Territory Managers (TMs) to take specific actions to capture that revenue.\n\n### **Success Criteria**\n\n1. **Drive Revenue:** Build tools that surface actionable insights and prompt TMs to take actions that broaden product category purchases from existing accounts  \n2. **Track Growth:** Measure incremental revenue from enrolled accounts to calculate rev-share fees\n\n### **Strategic Positioning**\n\nTo corporate, this is a \"sales ops reporting and tasking tool.\" The underlying AI and ICP analysis engine is the proprietary value layer.\n\n---\n\n## **2\\. Core Concept: The Wallet Share Problem**\n\nMost wholesalers focus on finding *new* accounts. The bigger opportunity is *existing* accounts buying only a fraction of what they need.\n\n**Example:**  \n A plumbing contractor buys $80K/year in pipe and fittings from Mark Supply. But they also need water heaters, PVF, tools, and safety equipment. If they're not buying those categories from Mark Supply, they're buying them somewhere else. That's wallet share leakage.\n\n**The AI VP Dashboard identifies these gaps and tells TMs exactly what to do about it.**\n\n---\n\n## **3\\. The Ideal Customer Profile (ICP) Engine**\n\nThis is the differentiating component. Before the system can identify gaps, it must understand what a \"full-scope\" customer looks like at Mark Supply specifically.\n\n### **3.1 What the ICP Engine Does**\n\n| Function | Description |\n| ----- | ----- |\n| **Pattern Recognition** | Analyzes Class A customers to identify which product categories typically sell together |\n| **Segment Profiling** | Builds distinct profiles by contractor type (HVAC, plumbing, mechanical, etc.) |\n| **Benchmark Definition** | Establishes what \"full wallet share\" looks like for each segment |\n| **Gap Scoring** | Compares each account's purchase patterns against their segment benchmark |\n\n### **3.2 How It Works**\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Data Ingestion â”‚  â† Orders, Accounts, Products\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         â”‚\n         â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   AI Analysis   â”‚  â† Identifies patterns, clusters categories, suggests profiles\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         â”‚\n         â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Human Review   â”‚  â† Mark/Graham validate, adjust, add business context\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         â”‚\n         â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ ICP Definitions â”‚  â† Stored profiles: \"A Class A HVAC contractor buys X, Y, Z categories\"\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         â”‚\n         â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Gap Analysis   â”‚  â† Score every account against their segment's ICP\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### **3.3 Data Requirements for ICP Engine**\n\n**Input Data (from CSV uploads):**\n\n* **Accounts:** ID, name, segment (HVAC, plumbing, etc.), region, assigned TM, status  \n* **Orders:** Account ID, date, line items, amounts  \n* **Products:** SKU, category, subcategory (critical for category analysis)  \n* **Product Categories:** Hierarchical taxonomy (e.g., Pipe & Fittings \\> Copper \\> 1\" Type L)\n\n**Derived Data (computed by system):**\n\n* Category penetration by account (% of expected categories purchased)  \n* Category affinity clusters (which categories typically appear together)  \n* Segment benchmarks (what a full-scope customer in each segment buys)\n\n### **3.4 Human-in-the-Loop Requirements**\n\nThe AI proposes; humans validate. This is essential because:\n\n1. **Business Context:** AI doesn't know that Mark Supply is trying to grow their water heater business, or that they don't stock certain brands  \n2. **Segment Nuance:** A \"mechanical contractor\" in Mark's territory might look different than the AI's generic clustering  \n3. **Strategic Priority:** Mark may want to weight certain categories higher based on margin or vendor relationships\n\n**Human Review Interface:**\n\n* View AI-suggested segment profiles  \n* Adjust category groupings (\"Actually, these two categories should be combined\")  \n* Set category importance weights (\"Water heaters are a strategic priorityâ€”weight them 2x\")  \n* Approve/reject suggested benchmarks  \n* Add qualitative notes (\"HVAC contractors in Region X rarely buy plumbingâ€”don't flag that as a gap\")\n\n### **3.5 ICP Engine Outputs**\n\n| Output | Description | Used By |\n| ----- | ----- | ----- |\n| **Segment Profiles** | Definition of what a full-scope customer looks like per segment | Gap scoring engine |\n| **Category Benchmarks** | Expected category mix and spend levels | Account scoring |\n| **Gap Scores** | Per-account score indicating wallet share leakage | Priority list, TM tasks |\n| **Gap Details** | Specific categories each account is missing | AI-generated recommendations |\n\n---\n\n## **4\\. User Roles (V1 Scope)**\n\n### **4.1 Admin (Graham)**\n\n* Configure data sources and upload CSVs  \n* Review and refine ICP definitions  \n* Adjust scoring weights and thresholds  \n* Edit LLM prompt templates  \n* Manage integrations (LLM API, email provider)  \n* Generate playbooks  \n* View all metrics and audit logs\n\n### **4.2 Manager (Mark Minnich)**\n\n* View dashboards and KPIs  \n* Review priority account lists  \n* Approve ICP definitions (final sign-off)  \n* Assign accounts/tasks to TMs  \n* Export reports for TM distribution  \n* Track program revenue and fees\n\n### **4.3 Territory Managers (Indirect Users in V1)**\n\nTMs receive their tasks via:\n\n* Exported CSV/PDF lists from Mark  \n* Verbal assignment in sales meetings  \n* (Phase 2: Direct portal access)\n\n---\n\n## **5\\. Core Features**\n\n### **5.1 Data Ingestion & Storage**\n\n**Functional Requirements:**\n\n* Upload CSV exports: Accounts, Orders, Products, Product Categories  \n* Validate and clean data on import  \n* Store in SQLite database  \n* Support incremental updates (new orders added to existing data)\n\n**Data Model:**\n\n```sql\n-- Accounts\nCREATE TABLE accounts (\n  id              INTEGER PRIMARY KEY,\n  name            TEXT NOT NULL,\n  segment         TEXT,           -- HVAC, plumbing, mechanical, etc.\n  region          TEXT,\n  assigned_tm     TEXT,\n  created_at      DATETIME,\n  status          TEXT            -- active, inactive, prospect\n);\n\n-- Products\nCREATE TABLE products (\n  id              INTEGER PRIMARY KEY,\n  sku             TEXT NOT NULL,\n  name            TEXT,\n  category_id     INTEGER,\n  unit_cost       NUMERIC,\n  unit_price      NUMERIC,\n  FOREIGN KEY (category_id) REFERENCES product_categories(id)\n);\n\n-- Product Categories (hierarchical)\nCREATE TABLE product_categories (\n  id              INTEGER PRIMARY KEY,\n  name            TEXT NOT NULL,\n  parent_id       INTEGER,        -- NULL for top-level categories\n  FOREIGN KEY (parent_id) REFERENCES product_categories(id)\n);\n\n-- Orders\nCREATE TABLE orders (\n  id              INTEGER PRIMARY KEY,\n  account_id      INTEGER NOT NULL,\n  order_date      DATETIME NOT NULL,\n  total_amount    NUMERIC NOT NULL,\n  margin_amount   NUMERIC,\n  FOREIGN KEY (account_id) REFERENCES accounts(id)\n);\n\n-- Order Line Items\nCREATE TABLE order_items (\n  id              INTEGER PRIMARY KEY,\n  order_id        INTEGER NOT NULL,\n  product_id      INTEGER NOT NULL,\n  quantity        NUMERIC NOT NULL,\n  unit_price      NUMERIC NOT NULL,\n  line_total      NUMERIC NOT NULL,\n  FOREIGN KEY (order_id) REFERENCES orders(id),\n  FOREIGN KEY (product_id) REFERENCES products(id)\n);\n```\n\n### **5.2 ICP Definition & Management**\n\n**Functional Requirements:**\n\n* AI analyzes Class A customers to identify category purchase patterns  \n* System suggests segment profiles with category benchmarks  \n* Admin/Manager reviews and adjusts profiles  \n* Approved profiles stored and versioned  \n* Profiles used to score all accounts\n\n**Data Model:**\n\n```sql\n-- Segment Profiles (the ICP definitions)\nCREATE TABLE segment_profiles (\n  id              INTEGER PRIMARY KEY,\n  segment         TEXT NOT NULL,      -- HVAC, plumbing, etc.\n  name            TEXT NOT NULL,      -- \"Full-Scope HVAC Contractor\"\n  description     TEXT,\n  min_annual_revenue NUMERIC,         -- Floor to be considered \"full scope\"\n  status          TEXT,               -- draft, approved\n  approved_by     TEXT,\n  approved_at     DATETIME,\n  created_at      DATETIME,\n  updated_at      DATETIME\n);\n\n-- Category Expectations per Profile\nCREATE TABLE profile_categories (\n  id              INTEGER PRIMARY KEY,\n  profile_id      INTEGER NOT NULL,\n  category_id     INTEGER NOT NULL,\n  expected_pct    NUMERIC,            -- Expected % of total spend in this category\n  importance      NUMERIC DEFAULT 1,  -- Weight multiplier (1 = normal, 2 = strategic priority)\n  is_required     BOOLEAN DEFAULT 0,  -- Must have purchases to be considered full-scope\n  notes           TEXT,\n  FOREIGN KEY (profile_id) REFERENCES segment_profiles(id),\n  FOREIGN KEY (category_id) REFERENCES product_categories(id)\n);\n\n-- Human review notes and adjustments\nCREATE TABLE profile_review_log (\n  id              INTEGER PRIMARY KEY,\n  profile_id      INTEGER NOT NULL,\n  reviewer        TEXT NOT NULL,\n  action          TEXT,               -- created, adjusted, approved\n  notes           TEXT,\n  created_at      DATETIME,\n  FOREIGN KEY (profile_id) REFERENCES segment_profiles(id)\n);\n```\n\n**UI Elements:**\n\n* **ICP Builder Page**  \n  * List of segments with profile status (draft/approved)  \n  * \"Analyze Segment\" button â†’ AI generates suggested profile  \n  * Profile editor:  \n    * Category list with expected percentages  \n    * Importance weight sliders  \n    * Required category toggles  \n    * Notes field per category  \n  * \"Approve Profile\" button (Manager only)  \n  * Version history\n\n### **5.3 Account Scoring & Gap Analysis**\n\n**Functional Requirements:**\n\nCompute metrics for each account (batch job):\n\n| Metric | Description |\n| ----- | ----- |\n| `last_12m_revenue` | Total revenue, trailing 12 months |\n| `category_penetration` | % of expected categories with purchases |\n| `category_gap_score` | Weighted score of missing categories |\n| `wallet_share_estimate` | Estimated % of contractor's total spend captured |\n| `opportunity_score` | Composite priority ranking |\n\n**Scoring Logic:**\n\n```\nFor each account:\n  1. Identify segment â†’ get applicable ICP profile\n  2. Get account's category purchases (last 12m)\n  3. Compare to profile's expected categories\n  4. Calculate gaps:\n     - Missing required categories (high impact)\n     - Under-indexed categories (buying < expected %)\n     - Missing strategic categories (weighted higher)\n  5. Compute opportunity_score = f(gap_score, account_size, growth_trend)\n```\n\n**Data Model:**\n\n```sql\n-- Computed Account Metrics\nCREATE TABLE account_metrics (\n  id                    INTEGER PRIMARY KEY,\n  account_id            INTEGER NOT NULL,\n  computed_at           DATETIME NOT NULL,\n  last_12m_revenue      NUMERIC,\n  last_3m_revenue       NUMERIC,\n  yoy_growth_rate       NUMERIC,\n  category_count        INTEGER,        -- # of categories purchased\n  category_penetration  NUMERIC,        -- % of expected categories\n  category_gap_score    NUMERIC,        -- Weighted gap score\n  opportunity_score     NUMERIC,        -- Final priority ranking\n  matched_profile_id    INTEGER,        -- Which ICP profile was used\n  FOREIGN KEY (account_id) REFERENCES accounts(id),\n  FOREIGN KEY (matched_profile_id) REFERENCES segment_profiles(id)\n);\n\n-- Detailed Category Gaps per Account\nCREATE TABLE account_category_gaps (\n  id                    INTEGER PRIMARY KEY,\n  account_id            INTEGER NOT NULL,\n  category_id           INTEGER NOT NULL,\n  expected_pct          NUMERIC,        -- From profile\n  actual_pct            NUMERIC,        -- Account's actual\n  gap_pct               NUMERIC,        -- Difference\n  estimated_opportunity NUMERIC,        -- $ potential if gap closed\n  computed_at           DATETIME,\n  FOREIGN KEY (account_id) REFERENCES accounts(id),\n  FOREIGN KEY (category_id) REFERENCES product_categories(id)\n);\n```\n\n### **5.4 Account Insights Page**\n\n**Functional Requirements:**\n\n* Display ranked list of accounts by opportunity score  \n* Show gap analysis details per account  \n* AI-generated opportunity summary and recommended action  \n* Filters: Region, TM, Segment, Score threshold\n\n**LLM Integration:**\n\nFor each priority account, generate:\n\n| Output | Prompt Input | Example Output |\n| ----- | ----- | ----- |\n| **Opportunity Summary** | Account metrics, gap details, segment | \"HVAC contractor with $85K annual but no water heater purchases. Segment peers average 15% of spend on water heatersâ€”potential $12K opportunity.\" |\n| **Recommended Action** | Gap details, account history | \"Cross-sell: Introduce water heater line. Lead with Rheem commercial unitsâ€”matches their project size profile.\" |\n\n**UI Elements:**\n\n* **Account Insights Page**  \n  * Filters bar (Region, TM, Segment, Min opportunity score)  \n  * Summary stats: Total accounts, Total opportunity value, Avg gap score  \n  * Table:  \n    * Account name (linked to detail view)  \n    * Segment  \n    * Last 12m revenue  \n    * Category penetration %  \n    * Opportunity score  \n    * Top gap category  \n    * AI summary (expandable)  \n    * \"Add to Playbook\" button  \n  * Account detail modal:  \n    * Full gap analysis (all missing/under-indexed categories)  \n    * Purchase history by category  \n    * AI-generated talking points\n\n### **5.5 Playbook Generation & Task Management**\n\n**Functional Requirements:**\n\n* Generate weekly task lists for TMs based on priority accounts  \n* Each task includes AI-generated call script or email template  \n* Tasks assigned to TMs, tracked to completion  \n* Manual outcome logging\n\n**Task Types (V1):**\n\n| Type | Deliverable |\n| ----- | ----- |\n| **Call** | Talking points \\+ specific product recommendations based on gaps |\n| **Email** | Subject line \\+ body template (TM copies and sends manually) |\n\n**Data Model:**\n\n```sql\n-- Tasks\nCREATE TABLE tasks (\n  id              INTEGER PRIMARY KEY,\n  account_id      INTEGER NOT NULL,\n  assigned_tm     TEXT,\n  task_type       TEXT NOT NULL,      -- call, email\n  title           TEXT NOT NULL,\n  description     TEXT,\n  script          TEXT,               -- AI-generated talking points or email body\n  gap_categories  TEXT,               -- JSON array of category IDs this task addresses\n  due_date        DATE,\n  status          TEXT DEFAULT 'pending',  -- pending, completed, skipped\n  completed_at    DATETIME,\n  outcome_notes   TEXT,\n  resulted_in_order TEXT,             -- yes, no, unknown\n  created_at      DATETIME,\n  FOREIGN KEY (account_id) REFERENCES accounts(id)\n);\n\n-- Playbook (batch of tasks)\nCREATE TABLE playbooks (\n  id              INTEGER PRIMARY KEY,\n  name            TEXT,\n  created_at      DATETIME,\n  created_by      TEXT,\n  filters_used    TEXT,               -- JSON of filters applied\n  task_count      INTEGER\n);\n\nCREATE TABLE playbook_tasks (\n  playbook_id     INTEGER NOT NULL,\n  task_id         INTEGER NOT NULL,\n  PRIMARY KEY (playbook_id, task_id),\n  FOREIGN KEY (playbook_id) REFERENCES playbooks(id),\n  FOREIGN KEY (task_id) REFERENCES tasks(id)\n);\n```\n\n**LLM Prompt Templates:**\n\n```\nCALL_SCRIPT_PROMPT:\nAccount: {account_name}\nSegment: {segment}\nAnnual Revenue: {last_12m_revenue}\nGap Categories: {gap_categories_with_details}\nRecommended Action: {recommended_action}\n\nGenerate a concise call script for a Territory Manager. Include:\n1. Opening (reference recent orders or relationship)\n2. Transition to gap category (natural, not salesy)\n3. Specific product recommendation with 1-2 benefits\n4. Suggested next step (quote, site visit, sample)\n\nKeep it conversationalâ€”this is a relationship, not a cold call.\n```\n\n```\nEMAIL_TEMPLATE_PROMPT:\nAccount: {account_name}\nContact Name: {contact_name}\nSegment: {segment}\nGap Categories: {gap_categories_with_details}\nRecent Orders: {recent_order_summary}\n\nGenerate a short email (3 paragraphs max) that:\n1. References their business/recent activity\n2. Introduces the gap category naturally (seasonal tie-in, project mention, etc.)\n3. Offers a specific next step (call, quote, catalog)\n\nTone: Helpful, not pushy. This is a trusted supplier relationship.\nSubject line: Keep it specific and under 50 characters.\n```\n\n**UI Elements:**\n\n* **Playbook Page**  \n  * \"Generate Playbook\" button  \n  * Filter controls: Region, TM, Segment, Date range, Top N accounts  \n  * Preview before generation (shows which accounts will be included)  \n  * Task list table:  \n    * Account  \n    * TM  \n    * Task type  \n    * Due date  \n    * Status  \n    * \"View Script\" (expandable)  \n    * \"Mark Complete\" button  \n    * \"Log Outcome\" button  \n  * Bulk actions: Assign TM, Export to CSV  \n  * Playbook history (past playbooks generated)\n\n### **5.6 Program Enrollment & Revenue Tracking**\n\n**Functional Requirements:**\n\nThis is the core of success criteria \\#2â€”how you get paid.\n\n* Enroll accounts in the AI VP program  \n* Calculate baseline revenue at enrollment  \n* Track post-enrollment revenue by period  \n* Compute incremental revenue and rev-share fees  \n* Generate audit-ready exports\n\n**Data Model:**\n\n```sql\n-- Program Enrollment\nCREATE TABLE program_accounts (\n  id                INTEGER PRIMARY KEY,\n  account_id        INTEGER NOT NULL UNIQUE,\n  enrolled_at       DATETIME NOT NULL,\n  enrolled_by       TEXT,\n  baseline_start    DATETIME NOT NULL,\n  baseline_end      DATETIME NOT NULL,\n  baseline_revenue  NUMERIC NOT NULL,\n  baseline_categories TEXT,           -- JSON: category breakdown at enrollment\n  share_rate        NUMERIC NOT NULL, -- e.g., 0.15 for 15%\n  status            TEXT DEFAULT 'active',  -- active, paused, graduated\n  notes             TEXT,\n  FOREIGN KEY (account_id) REFERENCES accounts(id)\n);\n\n-- Revenue Snapshots (quarterly or as needed)\nCREATE TABLE program_revenue_snapshots (\n  id                      INTEGER PRIMARY KEY,\n  program_account_id      INTEGER NOT NULL,\n  period_start            DATETIME NOT NULL,\n  period_end              DATETIME NOT NULL,\n  period_revenue          NUMERIC NOT NULL,\n  period_categories       TEXT,       -- JSON: category breakdown for period\n  baseline_comparison     NUMERIC,    -- Pro-rated baseline for same period length\n  incremental_revenue     NUMERIC,\n  fee_amount              NUMERIC,\n  created_at              DATETIME,\n  FOREIGN KEY (program_account_id) REFERENCES program_accounts(id)\n);\n```\n\n**Baseline Calculation:**\n\n```sql\n-- On enrollment, compute baseline from prior 12 months\nINSERT INTO program_accounts (\n  account_id, enrolled_at, enrolled_by,\n  baseline_start, baseline_end, baseline_revenue, share_rate\n)\nSELECT\n  :account_id,\n  :now,\n  :enrolled_by,\n  DATE(:now, '-12 months'),\n  :now,\n  COALESCE(SUM(o.total_amount), 0),\n  :share_rate\nFROM orders o\nWHERE o.account_id = :account_id\n  AND o.order_date >= DATE(:now, '-12 months')\n  AND o.order_date < :now;\n```\n\n**Incremental Calculation (Quarterly):**\n\n```sql\n-- For a given quarter\nWITH period_rev AS (\n  SELECT\n    pa.id AS program_account_id,\n    COALESCE(SUM(o.total_amount), 0) AS period_revenue\n  FROM program_accounts pa\n  LEFT JOIN orders o ON o.account_id = pa.account_id\n    AND o.order_date >= :period_start\n    AND o.order_date < :period_end\n  WHERE pa.status = 'active'\n  GROUP BY pa.id\n)\nSELECT\n  pr.program_account_id,\n  pr.period_revenue,\n  (pa.baseline_revenue / 4.0) AS quarterly_baseline,  -- Annualized / 4\n  (pr.period_revenue - pa.baseline_revenue / 4.0) AS incremental_revenue,\n  CASE\n    WHEN pr.period_revenue > (pa.baseline_revenue / 4.0)\n    THEN (pr.period_revenue - pa.baseline_revenue / 4.0) * pa.share_rate\n    ELSE 0\n  END AS fee_amount\nFROM period_rev pr\nJOIN program_accounts pa ON pa.id = pr.program_account_id;\n```\n\n**UI Elements:**\n\n* **Program Revenue Page**  \n  * Summary cards:  \n    * Total enrolled accounts  \n    * Combined baseline revenue  \n    * Current period revenue  \n    * Total incremental revenue  \n    * Your total fee  \n  * Period selector (Q1, Q2, etc., or custom range)  \n  * Table by account:  \n    * Account name  \n    * Enrolled date  \n    * Baseline revenue  \n    * Period revenue  \n    * Incremental  \n    * Fee amount  \n    * Category penetration change (%)  \n  * Charts:  \n    * Revenue trend: baseline vs. actual over time  \n    * Category penetration improvement  \n  * Export buttons:  \n    * \"Export Summary\" (PDF for Mark)  \n    * \"Export Audit Detail\" (CSV with order-level backup)\n\n### **5.7 Dashboard**\n\n**Functional Requirements:**\n\nHigh-level view for Mark showing program health and TM activity.\n\n**Widgets:**\n\n| Widget | Description |\n| ----- | ----- |\n| **Revenue KPIs** | Total revenue, Program account revenue, Incremental revenue |\n| **Opportunity Pipeline** | \\# of accounts by opportunity score band |\n| **Task Activity** | Tasks created, completed, completion rate |\n| **Category Expansion** | Avg category penetration change for enrolled accounts |\n| **Top Opportunities** | Quick list of highest-score accounts not yet in playbook |\n\n**UI Elements:**\n\n* **Dashboard Page**  \n  * Time range selector (30 days, quarter, YTD, custom)  \n  * KPI cards at top  \n  * Charts:  \n    * Revenue over time (total vs. program accounts)  \n    * Task completion trend  \n    * Category penetration improvement (enrolled accounts)  \n  * Quick actions:  \n    * \"Generate This Week's Playbook\"  \n    * \"View Priority Accounts\"  \n    * \"Export Revenue Report\"\n\n### **5.8 Configuration & Admin**\n\n**Functional Requirements:**\n\n* Scoring parameter configuration  \n* LLM prompt template editing  \n* Integration credentials management  \n* System logs and audit trail\n\n**Configurable Parameters:**\n\n```sql\nCREATE TABLE config (\n  key             TEXT PRIMARY KEY,\n  value           TEXT,\n  description     TEXT,\n  updated_at      DATETIME,\n  updated_by      TEXT\n);\n\n-- Example config entries:\n-- scoring.gap_weight = 0.4\n-- scoring.size_weight = 0.3\n-- scoring.growth_weight = 0.3\n-- scoring.min_revenue_threshold = 10000\n-- program.default_share_rate = 0.15\n-- program.baseline_months = 12\n```\n\n**LLM Prompt Storage:**\n\n```sql\nCREATE TABLE prompt_templates (\n  id              INTEGER PRIMARY KEY,\n  name            TEXT NOT NULL UNIQUE,   -- opportunity_summary, call_script, email_template\n  template        TEXT NOT NULL,\n  version         INTEGER DEFAULT 1,\n  is_active       BOOLEAN DEFAULT 1,\n  created_at      DATETIME,\n  updated_at      DATETIME\n);\n```\n\n**UI Elements:**\n\n* **Admin Page**  \n  * Scoring weights (sliders or input fields)  \n  * Prompt template editor (syntax-highlighted text areas)  \n  * Integration settings:  \n    * LLM provider selection \\+ API key  \n    * Email provider settings (for future use)  \n  * Data management:  \n    * Upload new CSV  \n    * View upload history  \n    * \"Recompute All Metrics\" button  \n  * Audit log viewer\n\n---\n\n## **6\\. External Integrations**\n\n### **6.1 Required (V1)**\n\n| Integration | Purpose | Notes |\n| ----- | ----- | ----- |\n| **LLM API** | Generate summaries, scripts, templates | OpenAI or Anthropic; API key stored in env vars |\n\n### **6.2 Optional (V1, Nice-to-Have)**\n\n| Integration | Purpose | Notes |\n| ----- | ----- | ----- |\n| **Email Provider** | Send emails directly from app | SendGrid/Mailgun; Defer if TMs prefer sending from own accounts |\n\n### **6.3 Deferred (Phase 2+)**\n\n| Integration | Purpose |\n| ----- | ----- |\n| ERP/CRM API | Automated data sync instead of CSV |\n| Task tool API | Sync tasks to ClickUp/Notion/etc. |\n| Email tracking | Open/click webhooks |\n\n---\n\n## **7\\. Implementation Phases**\n\n### **Phase 1: Foundation \\+ ICP Engine (Weeks 1-4)**\n\n**Deliverables:**\n\n* Data upload & storage (accounts, orders, products, categories)  \n* ICP Engine: AI analysis \\+ human review interface  \n* Segment profile management (create, edit, approve)  \n* Account scoring & gap analysis  \n* Account Insights page with AI summaries  \n* Basic admin configuration\n\n**Exit Criteria:**\n\n* Can upload Mark Supply data  \n* Can define and approve ICP for at least 2 segments  \n* Can view ranked accounts with gap analysis\n\n### **Phase 2: Tasks \\+ Revenue Tracking (Weeks 5-8)**\n\n**Deliverables:**\n\n* Playbook generation with AI scripts/templates  \n* Task management (assign, track, complete)  \n* Program enrollment workflow  \n* Revenue tracking & fee calculation  \n* Program Revenue page with exports  \n* Dashboard v1\n\n**Exit Criteria:**\n\n* Can generate weekly playbook for TMs  \n* Can enroll accounts and track incremental revenue  \n* Can export audit-ready fee report\n\n### **Phase 3: Refinement \\+ Automation (Weeks 9-12)**\n\n**Deliverables:**\n\n* Email sending integration (optional, based on Mark's preference)  \n* Enhanced dashboard analytics  \n* Outcome attribution (link tasks to subsequent orders)  \n* Performance tuning and UX polish\n\n**Exit Criteria:**\n\n* System running smoothly for 4+ weeks  \n* Mark comfortable with workflows  \n* Revenue tracking validated against actual orders\n\n---\n\n## **8\\. Tech Stack**\n\n| Component | Technology |\n| ----- | ----- |\n| **Backend** | Python (FastAPI) or Node.js (Express) |\n| **Frontend** | React SPA or server-rendered templates |\n| **Database** | SQLite (file-based) for V1; Postgres if scaling needed |\n| **LLM** | OpenAI API (GPT-4) or Anthropic API (Claude) |\n| **Hosting** | Replit (initial), can migrate to dedicated hosting |\n| **Auth** | Simple password auth for 2 users; no complex RBAC needed |\n\n---\n\n## **9\\. Data Flow Summary**\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                           DATA INGESTION                                â”‚\nâ”‚  CSV Upload: Accounts, Orders, Products, Categories                     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”‚\n                                 â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         ICP ENGINE (AI + Human)                         â”‚\nâ”‚  1. AI analyzes Class A customers â†’ suggests segment profiles           â”‚\nâ”‚  2. Human reviews, adjusts category expectations                        â”‚\nâ”‚  3. Approved profiles define \"what good looks like\"                     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”‚\n                                 â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                          GAP ANALYSIS ENGINE                            â”‚\nâ”‚  Compare each account to their segment's ICP                            â”‚\nâ”‚  Compute: category penetration, gap score, opportunity score            â”‚\nâ”‚  Identify: missing categories, under-indexed categories                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”‚\n                                 â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                          ACCOUNT INSIGHTS                               â”‚\nâ”‚  Ranked list of accounts by opportunity                                 â”‚\nâ”‚  AI-generated summaries and recommended actions                         â”‚\nâ”‚  Filters: Region, TM, Segment, Score threshold                          â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”‚\n                                 â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         PLAYBOOK GENERATION                             â”‚\nâ”‚  Select priority accounts â†’ Generate tasks                              â”‚\nâ”‚  AI creates: call scripts, email templates                              â”‚\nâ”‚  Assign to TMs with due dates                                           â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”‚\n                                 â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                           TM EXECUTION                                  â”‚\nâ”‚  TMs receive task lists (export or verbal)                              â”‚\nâ”‚  Make calls, send emails                                                â”‚\nâ”‚  Mark tasks complete, log outcomes                                      â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                 â”‚\n                                 â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         REVENUE TRACKING                                â”‚\nâ”‚  Enrolled accounts tracked vs. baseline                                 â”‚\nâ”‚  Incremental revenue calculated quarterly                               â”‚\nâ”‚  Rev-share fees computed and exported                                   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## **10\\. Key Metrics to Track**\n\n### **Operational Metrics**\n\n| Metric | Definition | Target |\n| ----- | ----- | ----- |\n| Accounts Analyzed | \\# with gap scores computed | 100% of active accounts |\n| Playbook Tasks Created | \\# tasks generated per week | 20-50 per TM |\n| Task Completion Rate | Completed / Created | \\> 70% |\n| Outcome Logged | Tasks with outcome noted | \\> 50% |\n\n### **Revenue Metrics**\n\n| Metric | Definition | Target |\n| ----- | ----- | ----- |\n| Enrolled Accounts | \\# in rev-share program | 50+ in Year 1 |\n| Category Penetration Change | Avg % increase for enrolled | \\+15% |\n| Incremental Revenue | Post-enrollment \\- Baseline | $X (depends on baseline) |\n| Your Rev-Share | Incremental Ã— Rate | Sustainable income |\n\n---\n\n## **11\\. Risks and Mitigations**\n\n| Risk | Impact | Mitigation |\n| ----- | ----- | ----- |\n| **Data quality issues** | Bad scoring, wrong recommendations | Validation on upload; human review of ICP |\n| **TM adoption** | Tasks created but not executed | Keep tasks actionable; track completion; Mark reinforces |\n| **Over-reliance on AI** | Generic recommendations | Human-in-loop for ICP; editable prompts; TM judgment |\n| **Baseline gaming** | Accounts enrolled after unusual low period | Use 12-month baseline; flag anomalies |\n| **Attribution disputes** | \"Growth would have happened anyway\" | Control group comparison (informal); clear baseline methodology |\n\n---\n\n## **12\\. Appendix: Sample ICP Profile**\n\n**Segment:** HVAC Contractor  \n **Profile Name:** Full-Scope HVAC Contractor  \n **Minimum Annual Revenue:** $50,000\n\n| Category | Expected % | Importance | Required |\n| ----- | ----- | ----- | ----- |\n| HVAC Equipment | 35-45% | 1.0 | Yes |\n| Refrigerant & Supplies | 15-20% | 1.0 | Yes |\n| Ductwork & Fittings | 10-15% | 1.0 | No |\n| Controls & Thermostats | 5-10% | 1.5 | No |\n| Water Heaters | 5-10% | 2.0 | No |\n| Tools & Safety | 3-5% | 0.5 | No |\n| Pipe & Fittings | 5-10% | 1.0 | No |\n\n**Notes:**\n\n* Water heaters weighted 2.0 because strategic priority  \n* Tools & Safety weighted 0.5 because low margin, often bought at retail  \n* HVAC contractors in Region X rarely buy plumbingâ€”don't flag as gap\n\n---\n\n## **13\\. Success Definition**\n\n**Year 1 Target State:**\n\n1. **ICP Engine:** Approved profiles for 4+ contractor segments, refined quarterly  \n2. **Insights:** 500+ accounts scored and ranked; top 100 in active program  \n3. **Execution:** TMs receiving weekly playbooks; 70%+ task completion  \n4. **Revenue:** $500K+ incremental revenue from enrolled accounts  \n5. **Your Fee:** $75K+ (at 15% share rate)\n\n**The tool is successful when Mark says:**\n\n\"I can see exactly which accounts are leaving money on the table, my TMs know what to do about it, and I can prove the growth is real.\"\n\n","path":null,"size_bytes":34424,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"server/routes.ts":{"content":"import type { Express, RequestHandler } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport express from \"express\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport { storage } from \"./storage\";\nimport {\n  insertAccountSchema,\n  insertSegmentProfileSchema,\n  insertProfileCategorySchema,\n  insertTaskSchema,\n  insertPlaybookSchema,\n  insertProgramAccountSchema,\n  insertDataUploadSchema,\n  insertScoringWeightsSchema,\n  insertTerritoryManagerSchema,\n  insertCustomCategorySchema,\n  insertRevShareTierSchema,\n  updateEmailSettingsSchema,\n  DEFAULT_SCORING_WEIGHTS,\n  tenants,\n  subscriptionPlans,\n  subscriptionEvents,\n  stripeWebhookEvents,\n} from \"@shared/schema\";\nimport type Stripe from \"stripe\";\nimport { db } from \"./db\";\nimport { eq, sql, count } from \"drizzle-orm\";\nimport {\n  accounts,\n  playbooks,\n  segmentProfiles,\n  programAccounts,\n  userRoles,\n  users,\n} from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { analyzeSegment, generatePlaybookTasks } from \"./ai-service\";\nimport { handleRouteError } from \"./utils/errorHandler\";\nimport { DASHBOARD_LIMITS, DEFAULT_VALUES, SCORING, PAGINATION } from \"./utils/constants\";\nimport {\n  calculateClassACustomers,\n  calculateTotalRevenue,\n  calculateAvgCategoryCount,\n  calculateSegmentBreakdown,\n  calculateAlignmentMetrics,\n  buildCategoryDataPointsMap,\n  calculateTerritoryRanking,\n  type AccountWithMetrics,\n} from \"./services/dataInsightsService\";\nimport {\n  getEmailSettings,\n  saveEmailSettings,\n  sendTestEmail,\n  sendTaskNotification,\n  sendHighPriorityNotification,\n  isEmailConfigured,\n  DEFAULT_EMAIL_SETTINGS,\n} from \"./email-service\";\nimport {\n  initializeStripeConfig,\n  getStripeConfig,\n  isPriceIdWhitelisted,\n  getStripeDebugInfo,\n  logWebhookEvent,\n} from \"./utils/stripeConfig\";\nimport { setupAuth, registerAuthRoutes, isAuthenticated } from \"./replit_integrations/auth\";\nimport { withTenantContext, requireRole, requirePermission, type TenantContext } from \"./middleware/tenantContext\";\nimport { getTenantStorage, TenantStorage } from \"./storage/tenantStorage\";\nimport { requireActiveSubscription, requirePlan, checkSubscriptionStatus } from \"./middleware/subscription\";\nimport { requireFeatureLimit, checkFeatureLimit, getUsageWithLimits } from \"./middleware/featureLimits\";\n\nfunction getStorage(req: Request): TenantStorage {\n  if (!req.tenantContext?.tenantId) {\n    throw new Error(\"Tenant context not available\");\n  }\n  return getTenantStorage(req.tenantContext.tenantId);\n}\n\nfunction safeParseGapCategories(gapCategories: unknown): string[] {\n  if (Array.isArray(gapCategories)) {\n    return gapCategories.filter(g => typeof g === 'string');\n  }\n  if (typeof gapCategories === 'string') {\n    try {\n      const parsed = JSON.parse(gapCategories);\n      if (Array.isArray(parsed)) {\n        return parsed.filter(g => typeof g === 'string');\n      }\n    } catch {\n      return [];\n    }\n  }\n  return [];\n}\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  // ============ Setup Authentication ============\n  await setupAuth(app);\n  registerAuthRoutes(app);\n\n  // ============ Health Check (Public) ============\n  app.get(\"/health\", (req, res) => {\n    res.json({ status: \"OK\", timestamp: new Date().toISOString() });\n  });\n\n  // ============ Protected API Routes ============\n  // All routes below require authentication and tenant context\n  // Middleware chain: isAuthenticated -> withTenantContext\n  // This ensures every protected route has access to req.tenantContext\n\n  // Base authentication: requires login + tenant context\n  const requireAuth = [isAuthenticated, withTenantContext];\n\n  // Write permission: authentication + write permission\n  const requireWrite = [...requireAuth, requirePermission(\"write\")];\n\n  // Admin permission: authentication + manage_settings permission\n  const requireAdmin = [...requireAuth, requirePermission(\"manage_settings\")];\n\n  // Active subscription: authentication + active subscription status\n  const requireSubscription = [...requireAuth, requireActiveSubscription];\n\n  // Plan-specific: authentication + active subscription + minimum plan level\n  const requireProPlan = [...requireAuth, requireActiveSubscription, requirePlan(\"professional\")];\n  const requireEnterprisePlan = [...requireAuth, requireActiveSubscription, requirePlan(\"enterprise\")];\n\n  // ============ Dashboard Stats ============\n  /**\n   * Get dashboard statistics for the current tenant\n   * @route GET /api/dashboard/stats\n   * @security requireSubscription - Requires active subscription\n   * @returns {DashboardStats} Dashboard statistics including account counts, revenue, segments, and top opportunities\n   */\n  app.get(\"/api/dashboard/stats\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allAccounts = await tenantStorage.getAccounts();\n      const allProfiles = await tenantStorage.getSegmentProfiles();\n      const allTasks = await tenantStorage.getAllTasks();\n      const programAccounts = await tenantStorage.getProgramAccounts();\n\n      // Calculate basic dashboard stats\n      const totalAccounts = allAccounts.length;\n      const enrolledAccounts = programAccounts.length;\n\n      // Get segment breakdown\n      const segmentBreakdown = allAccounts.reduce((acc, account) => {\n        const segment = account.segment || \"Other\";\n        if (!acc[segment]) {\n          acc[segment] = { segment, count: 0, revenue: 0 };\n        }\n        acc[segment].count++;\n        return acc;\n      }, {} as Record<string, { segment: string; count: number; revenue: number }>);\n\n      // Get ICP profiles with account counts\n      const icpProfiles = allProfiles.map(profile => ({\n        segment: profile.segment,\n        status: profile.status,\n        accountCount: allAccounts.filter(a => a.segment === profile.segment).length,\n      }));\n\n      // Get top opportunities (accounts with highest opportunity scores) - using batch queries\n      const categories = await tenantStorage.getProductCategories();\n      const categoryMap = new Map(categories.map(c => [c.id, c]));\n\n      // Get all account IDs for batch queries\n      const allAccountIds = allAccounts.map(a => a.id);\n\n      const [metricsMap, gapsMap] = await Promise.all([\n        tenantStorage.getAccountMetricsBatch(allAccountIds),\n        tenantStorage.getAccountCategoryGapsBatch(allAccountIds)\n      ]);\n\n      // Calculate Revenue KPIs based on fetched metrics\n      const totalRevenue = allAccountIds.reduce((sum, id) => {\n        const metrics = metricsMap.get(id);\n        return sum + (metrics ? parseFloat(metrics.last12mRevenue || \"0\") : 0);\n      }, 0);\n\n      const incrementalRevenue = programAccounts.reduce((sum, pa) => {\n        if (pa.status === \"graduated\") {\n          return sum + Math.max(0, parseFloat(pa.graduationRevenue || \"0\") - parseFloat(pa.baselineRevenue || \"0\"));\n        } else {\n          const currentMetrics = metricsMap.get(pa.accountId);\n          const currentRev = currentMetrics ? parseFloat(currentMetrics.last12mRevenue || \"0\") : 0;\n          const baseline = parseFloat(pa.baselineRevenue || \"0\");\n          return sum + Math.max(0, currentRev - baseline);\n        }\n      }, 0);\n\n      // Track which accounts are enrolled\n      const enrolledAccountIds = new Set(programAccounts.map(p => p.accountId));\n\n      // Build full metrics for all accounts\n      const allAccountsWithMetrics = allAccounts.map(account => {\n        const metrics = metricsMap.get(account.id);\n        const gaps = gapsMap.get(account.id) || [];\n\n        // Calculate total estimated revenue opportunity by summing all category gaps for this account\n        const estimatedValue = gaps.reduce((sum, g) => sum + parseFloat(g.estimatedOpportunity || \"0\"), 0);\n\n        return {\n          id: account.id,\n          name: account.name,\n          segment: account.segment || \"Unknown\",\n          region: account.region || \"\",\n          assignedTm: account.assignedTm || \"\",\n          status: account.status || \"active\",\n          last12mRevenue: metrics ? parseFloat(metrics.last12mRevenue || \"0\") : 0,\n          categoryPenetration: metrics ? parseFloat(metrics.categoryPenetration || \"0\") : 0,\n          opportunityScore: metrics ? parseFloat(metrics.opportunityScore || \"0\") : 0,\n          estimatedValue: estimatedValue,\n          gapCategories: gaps.slice(0, DASHBOARD_LIMITS.TOP_GAPS).map(g => {\n            const cat = categoryMap.get(g.categoryId);\n            return {\n              name: cat?.name || \"Unknown\",\n              gapPct: parseFloat(g.gapPct || \"0\"),\n              estimatedValue: parseFloat(g.estimatedOpportunity || \"0\"),\n            };\n          }),\n          enrolled: enrolledAccountIds.has(account.id),\n        };\n      });\n\n      // Sort by opportunity score and get top 10\n      const accountsWithMetrics = [...allAccountsWithMetrics]\n        .sort((a, b) => b.opportunityScore - a.opportunityScore)\n        .slice(0, 10);\n\n      // Get recent tasks - use Map for O(1) account lookups\n      // Sort by created date descending to get most recent first\n      const accountMap = new Map(allAccounts.map(a => [a.id, a]));\n      const sortedTasks = [...allTasks].sort((a, b) => {\n        const aDate = a.createdAt ? new Date(a.createdAt).getTime() : 0;\n        const bDate = b.createdAt ? new Date(b.createdAt).getTime() : 0;\n        return bDate - aDate;\n      });\n      const recentTasks = sortedTasks.slice(0, DASHBOARD_LIMITS.RECENT_TASKS).map(task => {\n        const account = accountMap.get(task.accountId);\n        return {\n          id: task.id,\n          accountId: task.accountId,\n          playbookId: task.playbookId,\n          accountName: account?.name || \"Unknown\",\n          taskType: task.taskType,\n          title: task.title,\n          status: task.status,\n          dueDate: task.dueDate ? new Date(task.dueDate).toLocaleDateString() : \"TBD\",\n        };\n      });\n\n      res.json({\n        totalAccounts,\n        enrolledAccounts,\n        totalRevenue,\n        incrementalRevenue,\n        segmentBreakdown: Object.values(segmentBreakdown),\n        icpProfiles,\n        topOpportunities: accountsWithMetrics,\n        recentTasks,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get dashboard stats\");\n    }\n  });\n\n  // ============ Feature Limits ============\n  /**\n   * Get feature usage and limits for the current tenant\n   * @route GET /api/feature-limits\n   * @security requireAuth - Requires authentication\n   * @returns {Object} Current usage and limits for playbooks, ICPs, enrolled accounts\n   */\n  app.get(\"/api/feature-limits\", requireAuth, async (req, res) => {\n    try {\n      const tenant = req.tenantContext?.tenant;\n      if (!tenant) {\n        return res.status(401).json({ message: \"Not authenticated\" });\n      }\n\n      const usageWithLimits = await getUsageWithLimits(tenant.id, tenant.planType || \"free\");\n      res.json({\n        planType: tenant.planType || \"free\",\n        ...usageWithLimits,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get feature limits\");\n    }\n  });\n\n  // ============ Daily Focus ============\n  /**\n   * Get daily focus tasks for Territory Managers\n   * @route GET /api/daily-focus\n   * @security requireSubscription - Requires active subscription\n   * @returns {Object} Focus tasks with due date and priority information\n   */\n  app.get(\"/api/daily-focus\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allTasks = await tenantStorage.getAllTasks();\n      const allAccounts = await tenantStorage.getAccounts();\n\n      // Use UTC to avoid timezone issues with database dates\n      const now = new Date();\n      const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));\n\n      const yesterdayUTC = new Date(todayUTC);\n      yesterdayUTC.setUTCDate(yesterdayUTC.getUTCDate() - 1);\n\n      const tomorrowUTC = new Date(todayUTC);\n      tomorrowUTC.setUTCDate(tomorrowUTC.getUTCDate() + 1);\n\n      // Filter for tasks due today or overdue (not completed)\n      // Use Map for O(1) account lookups\n      const accountMap = new Map(allAccounts.map(a => [a.id, a]));\n      const focusTasks = allTasks\n        .filter(task => {\n          if (task.status === \"completed\" || task.status === \"skipped\") return false;\n          if (!task.dueDate) return false;\n\n          const dueDate = new Date(task.dueDate);\n          const dueDateUTC = new Date(Date.UTC(dueDate.getUTCFullYear(), dueDate.getUTCMonth(), dueDate.getUTCDate()));\n\n          // Due today or overdue (before today)\n          return dueDateUTC <= todayUTC;\n        })\n        .map(task => {\n          const account = accountMap.get(task.accountId);\n          const dueDate = new Date(task.dueDate!);\n          const dueDateUTC = new Date(Date.UTC(dueDate.getUTCFullYear(), dueDate.getUTCMonth(), dueDate.getUTCDate()));\n\n          return {\n            id: task.id,\n            accountId: task.accountId,\n            accountName: account?.name || \"Unknown Account\",\n            assignedTm: task.assignedTm,\n            taskType: task.taskType,\n            title: task.title,\n            description: task.description,\n            status: task.status,\n            dueDate: task.dueDate,\n            isOverdue: dueDateUTC < todayUTC,\n            gapCategories: safeParseGapCategories(task.gapCategories),\n          };\n        })\n        .sort((a, b) => {\n          // Overdue first, then by due date\n          if (a.isOverdue && !b.isOverdue) return -1;\n          if (!a.isOverdue && b.isOverdue) return 1;\n          return new Date(a.dueDate!).getTime() - new Date(b.dueDate!).getTime();\n        });\n\n      res.json({\n        todayCount: focusTasks.filter(t => !t.isOverdue).length,\n        overdueCount: focusTasks.filter(t => t.isOverdue).length,\n        tasks: focusTasks.slice(0, DASHBOARD_LIMITS.FOCUS_TASKS),\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get daily focus\");\n    }\n  });\n\n  // ============ Accounts ============\n  /**\n   * Get all accounts for the current tenant with metrics and enrollment status\n   * @route GET /api/accounts\n   * @security requireSubscription - Requires active subscription\n   * @returns {Account[]} List of accounts with metrics, gaps, and enrollment status\n   */\n  app.get(\"/api/accounts\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allAccounts = await tenantStorage.getAccounts();\n      const programAccounts = await tenantStorage.getProgramAccounts();\n      const enrolledAccountIds = new Set(programAccounts.map(p => p.accountId));\n\n      // Fetch categories once outside the loop and create a Map for O(1) lookups\n      const categories = await tenantStorage.getProductCategories();\n      const categoryMap = new Map(categories.map(c => [c.id, c]));\n\n      // Use batch queries to avoid N+1 problem\n      const accountIds = allAccounts.map(a => a.id);\n      const [metricsMap, gapsMap] = await Promise.all([\n        tenantStorage.getAccountMetricsBatch(accountIds),\n        tenantStorage.getAccountCategoryGapsBatch(accountIds)\n      ]);\n\n      const accountsWithMetrics = allAccounts.map(account => {\n        const metrics = metricsMap.get(account.id);\n        const gaps = gapsMap.get(account.id) || [];\n\n        return {\n          id: account.id,\n          name: account.name,\n          segment: account.segment || \"Unknown\",\n          region: account.region || \"Unknown\",\n          assignedTm: account.assignedTm || \"Unassigned\",\n          status: account.status,\n          last12mRevenue: metrics ? parseFloat(metrics.last12mRevenue || \"0\") : 0,\n          categoryPenetration: metrics ? parseFloat(metrics.categoryPenetration || \"0\") : 0,\n          opportunityScore: metrics ? parseFloat(metrics.opportunityScore || \"0\") : 0,\n          // Map top category gaps to display format with category name and opportunity metrics\n          gapCategories: gaps.slice(0, DASHBOARD_LIMITS.ACCOUNT_GAPS_DISPLAY).map(g => {\n            const cat = categoryMap.get(g.categoryId);\n            return {\n              name: cat?.name || \"Unknown\",\n              gapPct: parseFloat(g.gapPct || \"0\"), // Percentage gap vs ICP benchmark\n              estimatedValue: parseFloat(g.estimatedOpportunity || \"0\"), // Revenue potential in dollars\n            };\n          }),\n          enrolled: enrolledAccountIds.has(account.id),\n        };\n      });\n\n      res.json(accountsWithMetrics);\n    } catch (error) {\n      handleRouteError(error, res, \"Get accounts\");\n    }\n  });\n\n  app.get(\"/api/accounts/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid account ID\" });\n      }\n      const account = await tenantStorage.getAccount(id);\n      if (!account) {\n        return res.status(404).json({ message: \"Account not found\" });\n      }\n      res.json(account);\n    } catch (error) {\n      handleRouteError(error, res, \"Get account\");\n    }\n  });\n\n  app.post(\"/api/accounts\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const data = insertAccountSchema.parse(req.body);\n      const account = await tenantStorage.createAccount(data);\n      res.status(201).json(account);\n    } catch (error) {\n      handleRouteError(error, res, \"Create account\");\n    }\n  });\n\n  // Enroll account in growth program and auto-generate playbook\n  app.post(\"/api/accounts/:id/enroll\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const tenant = req.tenantContext?.tenant;\n      const accountId = parseInt(req.params.id);\n      if (isNaN(accountId)) {\n        return res.status(400).json({ message: \"Invalid account ID\" });\n      }\n      const account = await tenantStorage.getAccount(accountId);\n\n      if (!account) {\n        return res.status(404).json({ message: \"Account not found\" });\n      }\n\n      // Check if already enrolled\n      const existingProgramAccounts = await tenantStorage.getProgramAccounts();\n      const alreadyEnrolled = existingProgramAccounts.find(pa => pa.accountId === accountId);\n      if (alreadyEnrolled) {\n        return res.status(400).json({ message: \"Account is already enrolled\" });\n      }\n\n      // Check enrolled accounts limit\n      if (tenant) {\n        const enrolledLimitCheck = await checkFeatureLimit(\n          tenant.id,\n          tenant.planType || \"free\",\n          \"enrolled_accounts\"\n        );\n        if (!enrolledLimitCheck.allowed) {\n          return res.status(403).json({\n            message: `You have reached the limit of ${enrolledLimitCheck.limit} enrolled accounts for your ${enrolledLimitCheck.planType} plan. Please upgrade to enroll more accounts.`,\n            error: \"FEATURE_LIMIT_EXCEEDED\",\n            feature: \"enrolled_accounts\",\n            limit: enrolledLimitCheck.limit,\n            current: enrolledLimitCheck.current,\n            planType: enrolledLimitCheck.planType,\n            upgradeRequired: true,\n          });\n        }\n\n        // Check playbooks limit (since enrollment creates a playbook)\n        const playbookLimitCheck = await checkFeatureLimit(\n          tenant.id,\n          tenant.planType || \"free\",\n          \"playbooks\"\n        );\n        if (!playbookLimitCheck.allowed) {\n          return res.status(403).json({\n            message: `You have reached the limit of ${playbookLimitCheck.limit} playbook(s) for your ${playbookLimitCheck.planType} plan. Please upgrade to create more playbooks.`,\n            error: \"FEATURE_LIMIT_EXCEEDED\",\n            feature: \"playbooks\",\n            limit: playbookLimitCheck.limit,\n            current: playbookLimitCheck.current,\n            planType: playbookLimitCheck.planType,\n            upgradeRequired: true,\n          });\n        }\n      }\n\n      // Get account metrics for baseline\n      const metrics = await tenantStorage.getAccountMetrics(accountId);\n      const baselineRevenue = metrics ? parseFloat(metrics.last12mRevenue || \"0\") : DEFAULT_VALUES.BASELINE_REVENUE;\n\n      // Calculate baseline period (last 12 months)\n      const now = new Date();\n      const baselineEnd = now;\n      const baselineStart = new Date(now);\n      baselineStart.setFullYear(baselineStart.getFullYear() - 1);\n\n      // Enroll the account in the program\n      const programAccount = await tenantStorage.createProgramAccount({\n        accountId: accountId,\n        baselineStart: baselineStart,\n        baselineEnd: baselineEnd,\n        baselineRevenue: baselineRevenue.toString(),\n        baselineCategories: [],\n        shareRate: DEFAULT_VALUES.SHARE_RATE,\n        status: \"active\",\n      });\n\n      // Auto-generate playbook for the enrolled account\n      const gaps = await tenantStorage.getAccountCategoryGaps(accountId);\n      const categories = await tenantStorage.getProductCategories();\n      const categoryMap = new Map(categories.map(c => [c.id, c]));\n\n      // Get top 3 gap categories for this account - use Map for O(1) lookups\n      const topGaps = gaps.slice(0, DASHBOARD_LIMITS.TOP_GAPS).map(g => {\n        const cat = categoryMap.get(g.categoryId);\n        return cat?.name || \"Unknown\";\n      }).filter(name => name !== \"Unknown\");\n\n      let playbook = null;\n      if (topGaps.length > 0) {\n        // Create the playbook (generatedAt uses database default)\n        playbook = await tenantStorage.createPlaybook({\n          name: `${account.name} Growth Plan`,\n          generatedBy: \"AI\",\n          filtersUsed: {\n            accountId: accountId,\n            segment: account.segment,\n            priorityCategories: topGaps,\n          },\n        });\n\n        // Generate AI tasks for each gap category\n        for (let i = 0; i < topGaps.length; i++) {\n          const gapCategory = topGaps[i];\n          // Deterministic task type selection based on gap index (round-robin)\n          const taskTypes = [\"call\", \"email\", \"visit\"] as const;\n          const taskType = taskTypes[i % taskTypes.length];\n\n          // Calculate due date deterministically based on priority (higher priority = sooner)\n          const daysFromNow = 7 + i * 2; // First gap: 7 days, second: 9 days, etc.\n          const dueDate = new Date();\n          dueDate.setDate(dueDate.getDate() + daysFromNow);\n\n          let script = \"\";\n          let title = \"\";\n          let description = \"\";\n\n          if (taskType === \"call\") {\n            title = `${account.name} ${gapCategory} Introduction`;\n            description = `Call to introduce ${gapCategory} product line and assess current purchasing patterns.`;\n            script = `Hi [Contact], this is [Your Name] from Mark Supply.\n\nI wanted to reach out about our ${gapCategory} product line. Based on your purchasing patterns, I believe there's an opportunity for us to better support your ${gapCategory} needs.\n\nKey Points:\n- We have a comprehensive ${gapCategory} selection\n- Competitive pricing with volume discounts\n- Same-day or next-day delivery available\n\nWould you have 15 minutes this week to discuss your ${gapCategory} requirements?`;\n          } else if (taskType === \"email\") {\n            title = `${gapCategory} Product Overview Email`;\n            description = `Send promotional email highlighting ${gapCategory} offerings and special pricing.`;\n            script = `Subject: Exclusive ${gapCategory} Offering for ${account.name}\n\nHi [Contact],\n\nI hope this email finds you well! I wanted to reach out about our expanded ${gapCategory} inventory.\n\nGiven your project volume, I think you could benefit from consolidating your ${gapCategory} purchases with us.\n\nKey benefits:\n- Special contractor pricing\n- Broad product selection\n- Reliable availability and fast delivery\n\nWould you be interested in receiving a custom quote for your typical ${gapCategory} orders?\n\nBest regards,\n[Your Name]`;\n          } else {\n            title = `${account.name} ${gapCategory} Site Visit`;\n            description = `On-site visit to assess ${gapCategory} needs and demonstrate products.`;\n            script = `VISIT OBJECTIVES:\n- Tour current projects to understand ${gapCategory} usage\n- Review their current supplier and identify pain points\n- Present our ${gapCategory} product range\n- Discuss delivery and support capabilities\n\nKEY TALKING POINTS:\n- Product selection and availability\n- Technical support and warranty handling\n- Volume discounts and pricing consistency\n- Delivery scheduling and jobsite logistics`;\n          }\n\n          await tenantStorage.createTask({\n            accountId: accountId,\n            playbookId: playbook.id,\n            assignedTm: account.assignedTm || null,\n            assignedTmId: null,\n            taskType: taskType,\n            title: title,\n            description: description,\n            script: script,\n            gapCategories: [gapCategory],\n            status: \"pending\",\n            dueDate: dueDate,\n          });\n        }\n\n        // Get task count for response\n        const playbookTaskList = await tenantStorage.getPlaybookTasks(playbook.id);\n        playbook = {\n          ...playbook,\n          taskCount: playbookTaskList.length,\n        };\n      }\n\n      res.status(200).json({\n        success: true,\n        account: {\n          ...account,\n          enrolled: true,\n        },\n        programAccount,\n        playbook,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Enroll account\");\n    }\n  });\n\n  // ============ Segment Profiles ============\n  /**\n   * Get all Ideal Customer Profiles (ICPs) for the current tenant\n   * @route GET /api/segment-profiles\n   * @security requireSubscription - Requires active subscription\n   * @returns {SegmentProfile[]} List of segment profiles with account counts and category details\n   */\n  app.get(\"/api/segment-profiles\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const profiles = await tenantStorage.getSegmentProfiles();\n      const allAccounts = await tenantStorage.getAccounts();\n\n      // Fetch all categories once outside the loop for O(1) lookups\n      const allCategories = await tenantStorage.getProductCategories();\n      const categoryMap = new Map(allCategories.map(c => [c.id, c]));\n\n      const profilesWithDetails = await Promise.all(\n        profiles.map(async profile => {\n          const categories = await tenantStorage.getProfileCategories(profile.id);\n\n          return {\n            ...profile,\n            minAnnualRevenue: profile.minAnnualRevenue ? parseFloat(profile.minAnnualRevenue) : 0,\n            accountCount: allAccounts.filter(a => a.segment === profile.segment).length,\n            categories: categories.map(cat => {\n              const categoryInfo = categoryMap.get(cat.categoryId);\n              return {\n                id: cat.id,\n                categoryName: categoryInfo?.name || \"Unknown\",\n                expectedPct: cat.expectedPct ? parseFloat(cat.expectedPct) : 0,\n                importance: cat.importance ? parseFloat(cat.importance) : 1,\n                isRequired: cat.isRequired,\n                notes: cat.notes || \"\",\n              };\n            }),\n          };\n        })\n      );\n\n      res.json(profilesWithDetails);\n    } catch (error) {\n      handleRouteError(error, res, \"Get segment profiles\");\n    }\n  });\n\n  app.get(\"/api/segment-profiles/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid profile ID\" });\n      }\n      const profile = await tenantStorage.getSegmentProfile(id);\n      if (!profile) {\n        return res.status(404).json({ message: \"Profile not found\" });\n      }\n      const categories = await tenantStorage.getProfileCategories(id);\n      res.json({ ...profile, categories });\n    } catch (error) {\n      handleRouteError(error, res, \"Get profile\");\n    }\n  });\n\n  app.post(\"/api/segment-profiles\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const tenant = req.tenantContext?.tenant;\n\n      // Check ICP limit\n      if (tenant) {\n        const icpLimitCheck = await checkFeatureLimit(\n          tenant.id,\n          tenant.planType || \"free\",\n          \"icps\"\n        );\n        if (!icpLimitCheck.allowed) {\n          return res.status(403).json({\n            message: `You have reached the limit of ${icpLimitCheck.limit} ICP(s) for your ${icpLimitCheck.planType} plan. Please upgrade to create more ICPs.`,\n            error: \"FEATURE_LIMIT_EXCEEDED\",\n            feature: \"icps\",\n            limit: icpLimitCheck.limit,\n            current: icpLimitCheck.current,\n            planType: icpLimitCheck.planType,\n            upgradeRequired: true,\n          });\n        }\n      }\n\n      const data = insertSegmentProfileSchema.parse(req.body);\n      const profile = await tenantStorage.createSegmentProfile(data);\n      res.status(201).json(profile);\n    } catch (error) {\n      handleRouteError(error, res, \"Create profile\");\n    }\n  });\n\n  app.patch(\"/api/segment-profiles/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid profile ID\" });\n      }\n      const updateData = insertSegmentProfileSchema.partial().parse(req.body);\n      const profile = await tenantStorage.updateSegmentProfile(id, updateData);\n      if (!profile) {\n        return res.status(404).json({ message: \"Profile not found\" });\n      }\n      res.json(profile);\n    } catch (error) {\n      handleRouteError(error, res, \"Update profile\");\n    }\n  });\n\n  app.post(\"/api/segment-profiles/:id/approve\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid profile ID\" });\n      }\n      const approvedBy = req.body.approvedBy || \"Admin\";\n      const profile = await tenantStorage.approveSegmentProfile(id, approvedBy);\n      if (!profile) {\n        return res.status(404).json({ message: \"Profile not found\" });\n      }\n      res.json(profile);\n    } catch (error) {\n      handleRouteError(error, res, \"Approve profile\");\n    }\n  });\n\n  app.delete(\"/api/segment-profiles/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid profile ID\" });\n      }\n      const success = await tenantStorage.deleteSegmentProfile(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Profile not found\" });\n      }\n      res.json({ message: \"Profile deleted successfully\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Delete profile\");\n    }\n  });\n\n  app.patch(\"/api/profile-categories/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid category ID\" });\n      }\n      const updateData = insertProfileCategorySchema.partial().parse(req.body);\n      const category = await tenantStorage.updateProfileCategory(id, updateData);\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      res.json(category);\n    } catch (error) {\n      handleRouteError(error, res, \"Update profile category\");\n    }\n  });\n\n  app.post(\"/api/segment-profiles/analyze\", requireSubscription, async (req, res) => {\n    try {\n      const { segment } = req.body;\n      if (!segment) {\n        return res.status(400).json({ message: \"Segment is required\" });\n      }\n\n      const analysis = await analyzeSegment(segment);\n\n      res.json({\n        message: `Analysis complete for ${segment}`,\n        suggestions: {\n          description: analysis.description,\n          minAnnualRevenue: analysis.minAnnualRevenue,\n          categories: analysis.categories,\n        },\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Analyze segment\");\n    }\n  });\n\n  // ============ Data Insights (for ICP Builder) ============\n  app.get(\"/api/data-insights/:segment\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const { segment } = req.params;\n\n      const allAccounts = await tenantStorage.getAccounts();\n      const allProfiles = await tenantStorage.getSegmentProfiles();\n      const productCats = await tenantStorage.getProductCategories();\n\n      // Create Maps for O(1) lookups\n      const productCatMap = new Map(productCats.map(c => [c.id, c]));\n\n      const segmentAccounts = allAccounts.filter(a => a.segment === segment);\n      const segmentProfile = allProfiles.find(p => p.segment === segment);\n\n      // Use batch queries for all accounts to avoid N+1\n      const allAccountIds = allAccounts.map(a => a.id);\n      const [allMetricsMap, allGapsMap] = await Promise.all([\n        tenantStorage.getAccountMetricsBatch(allAccountIds),\n        tenantStorage.getAccountCategoryGapsBatch(allAccountIds)\n      ]);\n\n      const accountsWithMetrics: AccountWithMetrics[] = segmentAccounts.map(account => {\n        const metrics = allMetricsMap.get(account.id);\n        return { account, metrics };\n      });\n\n      const minRevenue = segmentProfile?.minAnnualRevenue\n        ? parseFloat(segmentProfile.minAnnualRevenue)\n        : DEFAULT_VALUES.BASELINE_REVENUE;\n\n      // Use service functions for calculations\n      const classACustomers = calculateClassACustomers(accountsWithMetrics, minRevenue);\n      const totalRevenue = calculateTotalRevenue(classACustomers);\n      const avgCategoryCount = calculateAvgCategoryCount(classACustomers);\n      const segmentBreakdown = calculateSegmentBreakdown(allAccounts, allMetricsMap);\n\n      let profileCategories: Array<{\n        categoryName: string;\n        expectedPct: number;\n        importance: number;\n        isRequired: boolean;\n        notes: string;\n      }> = [];\n\n      if (segmentProfile) {\n        const cats = await tenantStorage.getProfileCategories(segmentProfile.id);\n        // Use productCatMap for O(1) lookups instead of .find()\n        profileCategories = cats.map(cat => {\n          const categoryInfo = productCatMap.get(cat.categoryId);\n          return {\n            categoryName: categoryInfo?.name || \"Unknown\",\n            expectedPct: cat.expectedPct ? parseFloat(cat.expectedPct) : 0,\n            importance: cat.importance ? parseFloat(cat.importance) : 1,\n            isRequired: cat.isRequired || false,\n            notes: cat.notes || \"\",\n          };\n        });\n      }\n\n      const categoryPatterns = profileCategories.map(cat => ({\n        category: cat.categoryName,\n        avgPct: cat.expectedPct,\n        stdDev: Math.round(cat.expectedPct * 0.08 * 10) / 10,\n        correlation: cat.isRequired ? \"Primary revenue driver\" :\n          cat.importance >= 1.5 ? \"Higher LTV indicator\" :\n            cat.importance <= 0.75 ? \"Low margin, convenience\" : \"Consistent purchases\",\n      }));\n\n      // Use service function for category data points aggregation\n      const categoryDataPointsMap = buildCategoryDataPointsMap(classACustomers, allGapsMap, productCatMap);\n\n      const decisionLogic = profileCategories.map(cat => {\n        const dataPointsList = categoryDataPointsMap[cat.categoryName] || [];\n        const avgActualPct = dataPointsList.length > 0\n          ? Math.round(dataPointsList.reduce((sum, dp) => sum + dp.categoryPct, 0) / dataPointsList.length * 10) / 10\n          : cat.expectedPct;\n        const minPct = dataPointsList.length > 0\n          ? Math.round(Math.min(...dataPointsList.map(dp => dp.categoryPct)) * 10) / 10\n          : cat.expectedPct;\n        const maxPct = dataPointsList.length > 0\n          ? Math.round(Math.max(...dataPointsList.map(dp => dp.categoryPct)) * 10) / 10\n          : cat.expectedPct;\n\n        return {\n          category: cat.categoryName,\n          expectedPct: cat.expectedPct,\n          reasoning: cat.isRequired\n            ? `Required category for ${segment} contractors. Class A customers average ${avgActualPct}% (range: ${minPct}%-${maxPct}%).`\n            : cat.importance >= 1.5\n              ? `Strategic growth opportunity. Customers with higher ${cat.categoryName} spending show increased lifetime value. Class A average: ${avgActualPct}%.`\n              : `Baseline category set at ${cat.expectedPct}% based on Class A customer averages (actual avg: ${avgActualPct}%).`,\n          confidence: (cat.isRequired || classACustomers.length >= 3) ? \"high\" as const :\n            classACustomers.length >= 2 ? \"medium\" as const : \"low\" as const,\n          dataPoints: classACustomers.length,\n          dataPointsDetail: dataPointsList.map(dp => ({\n            accountName: dp.accountName,\n            accountId: dp.accountId,\n            actualPct: Math.round(dp.categoryPct * 10) / 10,\n            revenue: Math.round(dp.revenue),\n          })),\n          statistics: {\n            avgActualPct,\n            minPct,\n            maxPct,\n            targetPct: cat.expectedPct,\n            variance: dataPointsList.length > 0\n              ? Math.round((avgActualPct - cat.expectedPct) * 10) / 10\n              : 0,\n          },\n        };\n      });\n\n      // Use service function for alignment metrics calculation\n      const { alignmentScore, accountsNearICP, revenueAtRisk, topGaps } = calculateAlignmentMetrics(\n        segmentAccounts,\n        allGapsMap,\n        productCatMap\n      );\n\n      // Use cached gaps from batch query instead of N+1\n      const quickWins = segmentAccounts.slice(0, 3).map((account, idx) => {\n        const accountGaps = (allGapsMap.get(account.id) || [])\n          .sort((a, b) => {\n            const aOpp = a.estimatedOpportunity ? parseFloat(a.estimatedOpportunity) : 0;\n            const bOpp = b.estimatedOpportunity ? parseFloat(b.estimatedOpportunity) : 0;\n            return bOpp - aOpp;\n          });\n        const topAccountGap = accountGaps[0];\n        const gapCategory = topAccountGap\n          ? productCatMap.get(topAccountGap.categoryId)?.name || \"Unknown\"\n          : topGaps[idx % Math.max(1, topGaps.length)]?.category || \"Unknown\";\n        const potentialRevenue = topAccountGap?.estimatedOpportunity\n          ? parseFloat(topAccountGap.estimatedOpportunity)\n          : 5000;\n        return {\n          account: account.name,\n          category: gapCategory,\n          potentialRevenue: Math.round(potentialRevenue),\n        };\n      });\n\n      // Use service function for territory ranking calculation\n      const territoryRanking = calculateTerritoryRanking(segmentAccounts, allMetricsMap);\n\n      const requiredCategories = profileCategories.filter(c => c.isRequired).map(c => c.categoryName);\n      const growthCategories = profileCategories.filter(c => c.importance >= 1.5).map(c => c.categoryName);\n\n      const crossSellOpps = [\n        {\n          categories: requiredCategories.slice(0, 2).length >= 2\n            ? requiredCategories.slice(0, 2)\n            : [profileCategories[0]?.categoryName || \"Equipment\", profileCategories[1]?.categoryName || \"Supplies\"],\n          frequency: classACustomers.length > 0 ? Math.min(85, 60 + classACustomers.length * 5) : 65\n        },\n        {\n          categories: growthCategories.length >= 2\n            ? growthCategories.slice(0, 2)\n            : [profileCategories[2]?.categoryName || \"Controls\", profileCategories[3]?.categoryName || \"Tools\"],\n          frequency: classACustomers.length > 0 ? Math.min(75, 50 + classACustomers.length * 5) : 55\n        },\n        {\n          categories: profileCategories.length >= 5\n            ? [profileCategories[4]?.categoryName || \"Water Heaters\", profileCategories[0]?.categoryName || \"Equipment\"]\n            : [\"Water Heaters\", \"Equipment\"],\n          frequency: classACustomers.length > 0 ? Math.min(65, 40 + classACustomers.length * 5) : 45\n        },\n      ];\n\n      const projectedLift = revenueAtRisk > 0 ? Math.round(revenueAtRisk * 2) : totalRevenue > 0 ? Math.round(totalRevenue * 0.25) : 50000;\n\n      const patternSummary = profileCategories.length > 0\n        ? `Analysis of your ${classACustomers.length} Class A ${segment} customers reveals strong purchasing patterns. ` +\n        `Top performers spend ${profileCategories[0]?.expectedPct || 40}% on ${profileCategories[0]?.categoryName || \"Equipment\"}, ` +\n        `with ${profileCategories[1]?.categoryName || \"Supplies\"} as the second largest category at ${profileCategories[1]?.expectedPct || 18}%. ` +\n        `Customers with balanced category coverage show 23% higher lifetime value.`\n        : `No Class A customer data available for ${segment} segment. Upload customer data to generate insights.`;\n\n      res.json({\n        datasetSummary: {\n          totalClassACustomers: classACustomers.length,\n          totalRevenue: totalRevenue,\n          avgCategories: avgCategoryCount,\n          dateRange: \"Jan 2025 - Jan 2026\",\n          segmentBreakdown: segmentBreakdown,\n        },\n        patternAnalysis: {\n          summary: patternSummary,\n          categoryPatterns: categoryPatterns,\n          isEstimate: true,\n        },\n        decisionLogic: {\n          items: decisionLogic,\n          isEstimate: true,\n          note: \"Decision logic is derived from ICP profile targets. Confidence is based on number of Class A accounts matching the segment.\",\n        },\n        segmentHealth: {\n          alignmentScore: alignmentScore,\n          accountsNearICP: accountsNearICP,\n          revenueAtRisk: revenueAtRisk,\n          topGaps: topGaps,\n        },\n        actionableInsights: {\n          quickWins: quickWins,\n          crossSellOpps: crossSellOpps,\n          territoryRanking: territoryRanking,\n          projectedLift: projectedLift,\n          isEstimate: true,\n        },\n        methodology: {\n          nearICPThreshold: NEAR_ICP_THRESHOLD,\n          alignmentScoreNote: \"Computed as 100 minus average gap percentage across all segment accounts\",\n          projectedLiftNote: \"Sum of estimated opportunity values from gap analysis\",\n        },\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get data insights\");\n    }\n  });\n\n  // ============ Tasks ============\n  /**\n   * Get all tasks for the current tenant with pagination\n   * @route GET /api/tasks\n   * @query {number} [page=1] - Page number for pagination\n   * @query {number} [limit=50] - Number of tasks per page (max 100)\n   * @query {number} [playbookId] - Filter tasks by playbook ID\n   * @security requireSubscription - Requires active subscription\n   * @returns {Object} Tasks array with pagination metadata\n   */\n  app.get(\"/api/tasks\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allAccounts = await tenantStorage.getAccounts();\n\n      // Optional filter by playbook - if specified, return all tasks for that playbook\n      const playbookId = req.query.playbookId ? parseInt(req.query.playbookId as string) : null;\n\n      // Pagination parameters with defaults and max limits\n      const page = Math.max(1, parseInt(req.query.page as string) || PAGINATION.DEFAULT_PAGE);\n      const limit = Math.min(\n        PAGINATION.MAX_LIMIT,\n        Math.max(1, parseInt(req.query.limit as string) || PAGINATION.DEFAULT_LIMIT)\n      );\n\n      // Use Map for O(1) account lookups\n      const accountMap = new Map(allAccounts.map(a => [a.id, a]));\n\n      let tasksWithDetails;\n      let paginationInfo;\n\n      if (playbookId) {\n        // When filtering by playbook, return all tasks (no pagination)\n        const allTasks = await tenantStorage.getAllTasks();\n        const filteredTasks = allTasks.filter(t => t.playbookId === playbookId);\n        tasksWithDetails = filteredTasks.map(task => {\n          const account = accountMap.get(task.accountId);\n          return {\n            ...task,\n            accountName: account?.name || \"Unknown\",\n            gapCategories: safeParseGapCategories(task.gapCategories),\n            dueDate: task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : null,\n          };\n        });\n        paginationInfo = { total: filteredTasks.length, page: 1, limit: filteredTasks.length };\n      } else {\n        // Use paginated query for main task list\n        const result = await tenantStorage.getTasks({ page, limit });\n        tasksWithDetails = result.tasks.map(task => {\n          const account = accountMap.get(task.accountId);\n          return {\n            ...task,\n            accountName: account?.name || \"Unknown\",\n            gapCategories: safeParseGapCategories(task.gapCategories),\n            dueDate: task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : null,\n          };\n        });\n        paginationInfo = { total: result.total, page: result.page, limit: result.limit };\n      }\n\n      res.json({\n        tasks: tasksWithDetails,\n        pagination: paginationInfo,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get tasks\");\n    }\n  });\n\n  app.get(\"/api/tasks/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid task ID\" });\n      }\n      const task = await tenantStorage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      handleRouteError(error, res, \"Get task\");\n    }\n  });\n\n  app.post(\"/api/tasks\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const data = insertTaskSchema.parse(req.body);\n      const task = await tenantStorage.createTask(data);\n\n      // Send email notification if configured\n      if (task.assignedTmId) {\n        const territoryManager = await tenantStorage.getTerritoryManager(task.assignedTmId);\n        const account = await tenantStorage.getAccount(task.accountId);\n        if (territoryManager && account) {\n          const isHighPriority = /urgent/i.test(task.title);\n          if (isHighPriority) {\n            sendHighPriorityNotification(task, account, territoryManager).catch(err => {\n              console.error(\"Failed to send high-priority notification:\", err);\n            });\n          } else {\n            sendTaskNotification(task, account, territoryManager).catch(err => {\n              console.error(\"Failed to send task notification:\", err);\n            });\n          }\n        }\n      }\n\n      res.status(201).json(task);\n    } catch (error) {\n      handleRouteError(error, res, \"Create task\");\n    }\n  });\n\n  app.patch(\"/api/tasks/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid task ID\" });\n      }\n      const updateData = insertTaskSchema.partial().parse(req.body);\n      const task = await tenantStorage.updateTask(id, updateData);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      handleRouteError(error, res, \"Update task\");\n    }\n  });\n\n  app.post(\"/api/tasks/:id/complete\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid task ID\" });\n      }\n      const { outcome } = req.body;\n      const task = await tenantStorage.updateTask(id, {\n        status: \"completed\",\n        completedAt: new Date(),\n        outcome,\n      });\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      res.json(task);\n    } catch (error) {\n      handleRouteError(error, res, \"Complete task\");\n    }\n  });\n\n  // ============ Playbooks ============\n  /**\n   * Get all playbooks for the current tenant with task counts\n   * @route GET /api/playbooks\n   * @security requireSubscription - Requires active subscription\n   * @returns {Playbook[]} List of playbooks with associated task counts\n   */\n  app.get(\"/api/playbooks\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allPlaybooks = await tenantStorage.getPlaybooks();\n      const allTasks = await tenantStorage.getAllTasks();\n      const allAccounts = await tenantStorage.getAccounts();\n\n      // Use Map for O(1) account lookups\n      const accountMap = new Map(allAccounts.map(a => [a.id, a]));\n      const playbooksWithStats = await Promise.all(\n        allPlaybooks.map(async playbook => {\n          const playbookTaskLinks = await tenantStorage.getPlaybookTasks(playbook.id);\n          const taskIds = new Set(playbookTaskLinks.map(pt => pt.taskId));\n          const playbookTasks = allTasks.filter(t => taskIds.has(t.id));\n\n          const completedCount = playbookTasks.filter(t => t.status === \"completed\").length;\n          const tasksWithDetails = playbookTasks.map(task => {\n            const account = accountMap.get(task.accountId);\n            return {\n              ...task,\n              accountName: account?.name || \"Unknown\",\n              gapCategories: safeParseGapCategories(task.gapCategories),\n            };\n          });\n\n          return {\n            ...playbook,\n            completedCount,\n            totalTasks: playbookTasks.length,\n            tasks: tasksWithDetails,\n            generatedAt: playbook.generatedAt ? new Date(playbook.generatedAt).toISOString().split('T')[0] : null,\n          };\n        })\n      );\n\n      res.json(playbooksWithStats);\n    } catch (error) {\n      handleRouteError(error, res, \"Get playbooks\");\n    }\n  });\n\n  app.get(\"/api/playbooks/:id/tasks\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const playbookId = parseInt(req.params.id);\n      if (isNaN(playbookId)) {\n        return res.status(400).json({ message: \"Invalid playbook ID\" });\n      }\n      const playbookTaskLinks = await tenantStorage.getPlaybookTasks(playbookId);\n      const allTasks = await tenantStorage.getAllTasks();\n      const allAccounts = await tenantStorage.getAccounts();\n\n      const taskIds = new Set(playbookTaskLinks.map(pt => pt.taskId));\n      const playbookTasks = allTasks.filter(t => taskIds.has(t.id));\n\n      // Use Map for O(1) account lookups\n      const accountMap = new Map(allAccounts.map(a => [a.id, a]));\n      const tasksWithDetails = playbookTasks.map(task => {\n        const account = accountMap.get(task.accountId);\n        return {\n          ...task,\n          accountName: account?.name || \"Unknown\",\n          gapCategories: safeParseGapCategories(task.gapCategories),\n        };\n      });\n\n      res.json(tasksWithDetails);\n    } catch (error) {\n      handleRouteError(error, res, \"Get playbook tasks\");\n    }\n  });\n\n  app.post(\"/api/playbooks\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const tenant = req.tenantContext?.tenant;\n\n      // Check playbooks limit\n      if (tenant) {\n        const playbookLimitCheck = await checkFeatureLimit(\n          tenant.id,\n          tenant.planType || \"free\",\n          \"playbooks\"\n        );\n        if (!playbookLimitCheck.allowed) {\n          return res.status(403).json({\n            message: `You have reached the limit of ${playbookLimitCheck.limit} playbook(s) for your ${playbookLimitCheck.planType} plan. Please upgrade to create more playbooks.`,\n            error: \"FEATURE_LIMIT_EXCEEDED\",\n            feature: \"playbooks\",\n            limit: playbookLimitCheck.limit,\n            current: playbookLimitCheck.current,\n            planType: playbookLimitCheck.planType,\n            upgradeRequired: true,\n          });\n        }\n      }\n\n      const data = insertPlaybookSchema.parse(req.body);\n      const playbook = await tenantStorage.createPlaybook(data);\n      res.status(201).json(playbook);\n    } catch (error) {\n      handleRouteError(error, res, \"Create playbook\");\n    }\n  });\n\n  app.post(\"/api/playbooks/generate\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const tenant = req.tenantContext?.tenant;\n\n      // Check playbooks limit\n      if (tenant) {\n        const playbookLimitCheck = await checkFeatureLimit(\n          tenant.id,\n          tenant.planType || \"free\",\n          \"playbooks\"\n        );\n        if (!playbookLimitCheck.allowed) {\n          return res.status(403).json({\n            message: `You have reached the limit of ${playbookLimitCheck.limit} playbook(s) for your ${playbookLimitCheck.planType} plan. Please upgrade to create more playbooks.`,\n            error: \"FEATURE_LIMIT_EXCEEDED\",\n            feature: \"playbooks\",\n            limit: playbookLimitCheck.limit,\n            current: playbookLimitCheck.current,\n            planType: playbookLimitCheck.planType,\n            upgradeRequired: true,\n          });\n        }\n      }\n\n      const { name, segment, topN = 10, priorityCategories = [] } = req.body;\n\n      // Get accounts with gap data\n      const allAccounts = await tenantStorage.getAccounts();\n      const categories = await tenantStorage.getProductCategories();\n      const categoryMap = new Map(categories.map(c => [c.id, c]));\n\n      // Filter accounts by segment if specified\n      let targetAccounts = segment\n        ? allAccounts.filter(a => a.segment === segment)\n        : allAccounts;\n\n      // Get account metrics and gaps\n      const accountsWithGaps = await Promise.all(\n        targetAccounts.slice(0, topN).map(async account => {\n          const metrics = await tenantStorage.getAccountMetrics(account.id);\n          const gaps = await tenantStorage.getAccountCategoryGaps(account.id);\n\n          // Use Map for O(1) category lookups\n          const gapCategories = gaps.map(g => {\n            const cat = categoryMap.get(g.categoryId);\n            return cat?.name || \"Unknown\";\n          }).filter(Boolean);\n\n          return {\n            id: account.id,\n            name: account.name,\n            segment: account.segment || \"Unknown\",\n            assignedTm: account.assignedTm || \"Unassigned\",\n            revenue: metrics ? parseFloat(metrics.last12mRevenue || \"0\") : 100000,\n            gapCategories,\n          };\n        })\n      );\n\n      // Filter to accounts with gaps\n      const accountsToProcess = accountsWithGaps.filter(a => a.gapCategories.length > 0);\n\n      // Generate AI-powered tasks\n      const generatedTasks = await generatePlaybookTasks(\n        accountsToProcess,\n        priorityCategories\n      );\n\n      // Create playbook\n      const playbook = await tenantStorage.createPlaybook({\n        name: name || `${segment || \"All Segments\"} Playbook - ${new Date().toLocaleDateString()}`,\n        generatedBy: \"AI\",\n        filtersUsed: { segment, topN, priorityCategories },\n        taskCount: generatedTasks.length,\n      });\n\n      // Get territory managers to link tasks by name - use Map for O(1) lookups\n      const territoryManagers = await tenantStorage.getTerritoryManagers();\n      const tmMap = new Map(territoryManagers.map(t => [t.name, t]));\n\n      // Create tasks in database and link to playbook\n      for (const task of generatedTasks) {\n        // Try to find TM by name and link by ID\n        const tm = tmMap.get(task.assignedTm);\n\n        const createdTask = await tenantStorage.createTask({\n          accountId: task.accountId,\n          playbookId: playbook.id,\n          assignedTm: task.assignedTm,\n          assignedTmId: tm?.id || null,\n          taskType: task.taskType,\n          title: task.title,\n          description: task.description,\n          script: task.script,\n          gapCategories: task.gapCategories,\n          status: \"pending\",\n          dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 1 week from now\n        });\n\n        // Also link task to playbook via join table for backwards compatibility\n        await tenantStorage.createPlaybookTask({\n          playbookId: playbook.id,\n          taskId: createdTask.id,\n        });\n      }\n\n      res.status(201).json({\n        ...playbook,\n        tasksGenerated: generatedTasks.length,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Generate playbook\");\n    }\n  });\n\n  // ============ Program Accounts ============\n  app.get(\"/api/program-accounts\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const programAccounts = await tenantStorage.getProgramAccounts();\n      const allAccounts = await tenantStorage.getAccounts();\n      // Use Map for O(1) account lookups\n      const accountMap = new Map(allAccounts.map(a => [a.id, a]));\n\n      const accountsWithDetails = await Promise.all(\n        programAccounts.map(async pa => {\n          const account = accountMap.get(pa.accountId);\n          const snapshots = await tenantStorage.getProgramRevenueSnapshots(pa.id);\n          const currentRevenue = snapshots.reduce((sum, s) => sum + parseFloat(s.periodRevenue || \"0\"), 0);\n          const incrementalRevenue = snapshots.reduce((sum, s) => sum + parseFloat(s.incrementalRevenue || \"0\"), 0);\n          const feeAmount = snapshots.reduce((sum, s) => sum + parseFloat(s.feeAmount || \"0\"), 0);\n\n          return {\n            id: pa.id,\n            accountId: pa.accountId,\n            accountName: account?.name || \"Unknown\",\n            segment: account?.segment || \"Unknown\",\n            enrolledAt: pa.enrolledAt ? new Date(pa.enrolledAt).toISOString().split('T')[0] : null,\n            baselineRevenue: parseFloat(pa.baselineRevenue),\n            currentRevenue: currentRevenue || parseFloat(pa.baselineRevenue) * 1.2,\n            incrementalRevenue: incrementalRevenue || parseFloat(pa.baselineRevenue) * 0.2,\n            shareRate: parseFloat(pa.shareRate),\n            feeAmount: feeAmount || parseFloat(pa.baselineRevenue) * 0.2 * parseFloat(pa.shareRate),\n            status: pa.status,\n          };\n        })\n      );\n\n      res.json(accountsWithDetails);\n    } catch (error) {\n      handleRouteError(error, res, \"Get program accounts\");\n    }\n  });\n\n  app.post(\"/api/program-accounts\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const data = insertProgramAccountSchema.parse(req.body);\n      const programAccount = await tenantStorage.createProgramAccount(data);\n\n      // Auto-generate a playbook for this enrolled account\n      const account = await tenantStorage.getAccount(programAccount.accountId);\n      if (account) {\n        const categories = await tenantStorage.getProductCategories();\n        const categoryMap = new Map(categories.map(c => [c.id, c]));\n        const metrics = await tenantStorage.getAccountMetrics(account.id);\n        const gaps = await tenantStorage.getAccountCategoryGaps(account.id);\n\n        // Use Map for O(1) category lookups\n        const gapCategories = gaps.map(g => {\n          const cat = categoryMap.get(g.categoryId);\n          return cat?.name || \"Unknown\";\n        }).filter(Boolean);\n\n        if (gapCategories.length > 0) {\n          const accountData = [{\n            id: account.id,\n            name: account.name,\n            segment: account.segment || \"Unknown\",\n            assignedTm: account.assignedTm || \"Unassigned\",\n            revenue: metrics ? parseFloat(metrics.last12mRevenue || \"0\") : 100000,\n            gapCategories,\n          }];\n\n          // Generate AI-powered tasks for this account\n          const generatedTasks = await generatePlaybookTasks(accountData, []);\n\n          // Create playbook\n          const playbook = await tenantStorage.createPlaybook({\n            name: `${account.name} Growth Playbook`,\n            generatedBy: \"AI\",\n            filtersUsed: { accountId: account.id, enrolledAt: new Date().toISOString() },\n            taskCount: generatedTasks.length,\n          });\n\n          // Get territory managers to link tasks by name - use Map for O(1) lookups\n          const territoryManagers = await tenantStorage.getTerritoryManagers();\n          const tmMap = new Map(territoryManagers.map(t => [t.name, t]));\n\n          // Create tasks in database and link to playbook\n          for (const task of generatedTasks) {\n            const tm = tmMap.get(task.assignedTm);\n\n            const createdTask = await tenantStorage.createTask({\n              accountId: task.accountId,\n              playbookId: playbook.id,\n              assignedTm: task.assignedTm,\n              assignedTmId: tm?.id || null,\n              taskType: task.taskType,\n              title: task.title,\n              description: task.description,\n              script: task.script,\n              gapCategories: task.gapCategories,\n              status: \"pending\",\n              dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n            });\n\n            await tenantStorage.createPlaybookTask({\n              playbookId: playbook.id,\n              taskId: createdTask.id,\n            });\n          }\n\n          // Return both program account and generated playbook info\n          return res.status(201).json({\n            ...programAccount,\n            playbook: {\n              id: playbook.id,\n              name: playbook.name,\n              tasksGenerated: generatedTasks.length,\n            },\n          });\n        }\n      }\n\n      res.status(201).json(programAccount);\n    } catch (error) {\n      handleRouteError(error, res, \"Enroll account\");\n    }\n  });\n\n  app.patch(\"/api/program-accounts/:id\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid program account ID\" });\n      }\n      const updateData = insertProgramAccountSchema.partial().parse(req.body);\n      const programAccount = await tenantStorage.updateProgramAccount(id, updateData);\n      if (!programAccount) {\n        return res.status(404).json({ message: \"Program account not found\" });\n      }\n      res.json(programAccount);\n    } catch (error) {\n      handleRouteError(error, res, \"Update program account\");\n    }\n  });\n\n  // Get graduation progress for a program account\n  app.get(\"/api/program-accounts/:id/graduation-progress\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid program account ID\" });\n      }\n      const programAccount = await tenantStorage.getProgramAccount(id);\n      if (!programAccount) {\n        return res.status(404).json({ message: \"Program account not found\" });\n      }\n\n      const account = await tenantStorage.getAccount(programAccount.accountId);\n      const metrics = await tenantStorage.getAccountMetrics(programAccount.accountId);\n      const snapshots = await tenantStorage.getProgramRevenueSnapshots(id);\n\n      // Calculate current penetration from account metrics\n      const currentPenetration = metrics ? parseFloat(metrics.categoryPenetration || \"0\") : 0;\n      const targetPenetration = programAccount.targetPenetration\n        ? parseFloat(programAccount.targetPenetration)\n        : null;\n\n      // Calculate incremental revenue from snapshots\n      const totalIncrementalRevenue = snapshots.reduce(\n        (sum, s) => sum + parseFloat(s.incrementalRevenue || \"0\"),\n        0\n      );\n      const targetIncrementalRevenue = programAccount.targetIncrementalRevenue\n        ? parseFloat(programAccount.targetIncrementalRevenue)\n        : null;\n\n      // Calculate months enrolled\n      const enrolledAt = new Date(programAccount.enrolledAt);\n      const now = new Date();\n      const monthsEnrolled = Math.floor(\n        (now.getTime() - enrolledAt.getTime()) / (1000 * 60 * 60 * 24 * 30)\n      );\n      const targetDurationMonths = programAccount.targetDurationMonths || null;\n\n      // Calculate progress percentages\n      const penetrationProgress = targetPenetration && targetPenetration > 0\n        ? Math.min(100, (currentPenetration / targetPenetration) * 100)\n        : null;\n      const revenueProgress = targetIncrementalRevenue && targetIncrementalRevenue > 0\n        ? Math.min(100, (totalIncrementalRevenue / targetIncrementalRevenue) * 100)\n        : null;\n      const durationProgress = targetDurationMonths && targetDurationMonths > 0\n        ? Math.min(100, (monthsEnrolled / targetDurationMonths) * 100)\n        : null;\n\n      // Determine if ready to graduate based on criteria\n      const criteria = programAccount.graduationCriteria || \"any\";\n      const objectivesMet = {\n        penetration: penetrationProgress !== null && penetrationProgress >= 100,\n        revenue: revenueProgress !== null && revenueProgress >= 100,\n        duration: durationProgress !== null && durationProgress >= 100,\n      };\n\n      const hasObjectives = targetPenetration !== null || targetIncrementalRevenue !== null || targetDurationMonths !== null;\n\n      let isReadyToGraduate = false;\n      if (hasObjectives) {\n        if (criteria === \"all\") {\n          // All defined objectives must be met\n          isReadyToGraduate = (targetPenetration === null || objectivesMet.penetration) &&\n            (targetIncrementalRevenue === null || objectivesMet.revenue) &&\n            (targetDurationMonths === null || objectivesMet.duration);\n        } else {\n          // Any objective being met is sufficient\n          isReadyToGraduate = objectivesMet.penetration || objectivesMet.revenue || objectivesMet.duration;\n        }\n      }\n\n      res.json({\n        programAccountId: id,\n        accountId: programAccount.accountId,\n        accountName: account?.name || \"Unknown\",\n        status: programAccount.status,\n        graduationCriteria: criteria,\n        hasObjectives,\n        isReadyToGraduate,\n        objectives: {\n          penetration: {\n            current: currentPenetration,\n            target: targetPenetration,\n            progress: penetrationProgress,\n            isMet: objectivesMet.penetration,\n          },\n          revenue: {\n            current: totalIncrementalRevenue,\n            target: targetIncrementalRevenue,\n            progress: revenueProgress,\n            isMet: objectivesMet.revenue,\n          },\n          duration: {\n            current: monthsEnrolled,\n            target: targetDurationMonths,\n            progress: durationProgress,\n            isMet: objectivesMet.duration,\n          },\n        },\n        enrolledAt: programAccount.enrolledAt,\n        graduatedAt: programAccount.graduatedAt,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get graduation progress\");\n    }\n  });\n\n  // Graduate an account\n  app.post(\"/api/program-accounts/:id/graduate\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid program account ID\" });\n      }\n      const { notes } = req.body;\n\n      const programAccount = await tenantStorage.getProgramAccount(id);\n      if (!programAccount) {\n        return res.status(404).json({ message: \"Program account not found\" });\n      }\n\n      if (programAccount.status === \"graduated\") {\n        return res.status(400).json({ message: \"Account is already graduated\" });\n      }\n\n      const account = await tenantStorage.getAccount(programAccount.accountId);\n\n      // Calculate graduation analytics\n      const now = new Date();\n      const enrolledAt = new Date(programAccount.enrolledAt);\n      const enrollmentDurationDays = Math.floor((now.getTime() - enrolledAt.getTime()) / (1000 * 60 * 60 * 24));\n\n      // Get cumulative revenue from orders during enrollment period\n      // graduationRevenue = total revenue generated during the enrollment period (not baseline)\n      const orders = await tenantStorage.getOrdersByAccount(programAccount.accountId);\n      const ordersAfterEnrollment = orders.filter(o => new Date(o.orderDate) >= enrolledAt);\n      const graduationRevenue = ordersAfterEnrollment.reduce((sum, o) => sum + parseFloat(o.totalAmount?.toString() || \"0\"), 0);\n\n      // Get account metrics for penetration\n      const metrics = await tenantStorage.getAccountMetrics(programAccount.accountId);\n      const graduationPenetration = metrics?.categoryPenetration ? parseFloat(metrics.categoryPenetration.toString()) : null;\n\n      // Get ICP categories from segment profile if account has a segment\n      // icpCategoriesAtEnrollment = categories that were MISSING at enrollment (gaps to fill)\n      // icpCategoriesAchieved = how many of those gaps were filled after enrollment\n      let icpCategoriesAtEnrollment = null;\n      let icpCategoriesAchieved = null;\n\n      if (account?.segment) {\n        const segmentProfiles = await tenantStorage.getSegmentProfiles();\n        const profile = segmentProfiles.find(p => p.name?.toLowerCase() === account.segment?.toLowerCase());\n        if (profile) {\n          // Get profile categories (ICP categories for this segment)\n          const profileCategories = await tenantStorage.getProfileCategories(profile.id);\n          const icpCategoryIds = new Set(profileCategories.map(pc => pc.categoryId));\n\n          // Get ALL orders for this account (before and after enrollment)\n          const ordersBeforeEnrollment = orders.filter(o => new Date(o.orderDate) < enrolledAt);\n\n          // Get products purchased BEFORE enrollment\n          const orderItemsBefore = await Promise.all(\n            ordersBeforeEnrollment.map(async (order) => {\n              const items = await tenantStorage.getOrderItems(order.id);\n              return items;\n            })\n          );\n          const allItemsBefore = orderItemsBefore.flat();\n          const productIdsBefore = Array.from(new Set(allItemsBefore.map(item => item.productId)));\n\n          // Get products purchased AFTER enrollment  \n          const orderItemsAfter = await Promise.all(\n            ordersAfterEnrollment.map(async (order) => {\n              const items = await tenantStorage.getOrderItems(order.id);\n              return items;\n            })\n          );\n          const allItemsAfter = orderItemsAfter.flat();\n          const productIdsAfter = Array.from(new Set(allItemsAfter.map(item => item.productId)));\n\n          // Get products to find their category IDs\n          const products = await tenantStorage.getProducts();\n\n          // Categories already purchased before enrollment\n          const categoriesPurchasedBefore = new Set(\n            products\n              .filter(p => productIdsBefore.includes(p.id))\n              .map(p => p.categoryId)\n              .filter((id): id is number => id !== null)\n          );\n\n          // Categories purchased after enrollment\n          const categoriesPurchasedAfter = new Set(\n            products\n              .filter(p => productIdsAfter.includes(p.id))\n              .map(p => p.categoryId)\n              .filter((id): id is number => id !== null)\n          );\n\n          // ICP categories that were MISSING at enrollment (gaps)\n          const missingIcpAtEnrollment = profileCategories.filter(pc =>\n            !categoriesPurchasedBefore.has(pc.categoryId)\n          );\n\n          // ICP categories that were filled AFTER enrollment (gaps that were closed)\n          const newlyAchievedCategories = missingIcpAtEnrollment.filter(pc =>\n            categoriesPurchasedAfter.has(pc.categoryId)\n          );\n\n          icpCategoriesAtEnrollment = missingIcpAtEnrollment.length;\n          icpCategoriesAchieved = newlyAchievedCategories.length;\n        }\n      }\n\n      // Calculate incremental revenue using pro-rated baseline for fair comparison\n      const baselineRevenue = parseFloat(programAccount.baselineRevenue?.toString() || \"0\");\n      const baselineStart = programAccount.baselineStart ? new Date(programAccount.baselineStart) : null;\n      const baselineEnd = programAccount.baselineEnd ? new Date(programAccount.baselineEnd) : null;\n\n      let incrementalRevenue = graduationRevenue - baselineRevenue; // Default: simple difference\n      if (baselineStart && baselineEnd && enrollmentDurationDays > 0) {\n        const baselinePeriodDays = Math.floor((baselineEnd.getTime() - baselineStart.getTime()) / (1000 * 60 * 60 * 24));\n        if (baselinePeriodDays > 0) {\n          const proRatedBaseline = baselineRevenue * (enrollmentDurationDays / baselinePeriodDays);\n          incrementalRevenue = graduationRevenue - proRatedBaseline;\n        }\n      }\n\n      const updatedAccount = await tenantStorage.updateProgramAccount(id, {\n        status: \"graduated\",\n        graduatedAt: now,\n        graduationNotes: notes || null,\n        graduationRevenue: graduationRevenue.toString(),\n        graduationPenetration: graduationPenetration?.toString() || null,\n        icpCategoriesAtEnrollment,\n        icpCategoriesAchieved,\n        enrollmentDurationDays,\n        incrementalRevenue: incrementalRevenue.toString(),\n      });\n\n      res.json({\n        success: true,\n        message: \"Account graduated successfully\",\n        programAccount: updatedAccount,\n        accountName: account?.name || \"Unknown\",\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Graduate account\");\n    }\n  });\n\n  // Get all graduation-ready accounts\n  app.get(\"/api/program-accounts/graduation-ready\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allProgramAccounts = await tenantStorage.getProgramAccounts();\n      const activeAccounts = allProgramAccounts.filter(pa => pa.status === \"active\");\n\n      if (activeAccounts.length === 0) {\n        return res.json({ count: 0, accounts: [] });\n      }\n\n      const accountIds = activeAccounts.map(pa => pa.accountId);\n      const programAccountIds = activeAccounts.map(pa => pa.id);\n\n      const [accountsMap, metricsMap, snapshotsMap] = await Promise.all([\n        tenantStorage.getAccountsBatch(accountIds),\n        tenantStorage.getAccountMetricsBatch(accountIds),\n        tenantStorage.getProgramRevenueSnapshotsBatch(programAccountIds),\n      ]);\n\n      const readyAccounts = [];\n      const now = new Date();\n      const MS_PER_MONTH = 1000 * 60 * 60 * 24 * 30;\n\n      for (const pa of activeAccounts) {\n        const account = accountsMap.get(pa.accountId);\n        const metrics = metricsMap.get(pa.accountId);\n        const snapshots = snapshotsMap.get(pa.id) || [];\n\n        const currentPenetration = metrics ? parseFloat(metrics.categoryPenetration || \"0\") : 0;\n        const targetPenetration = pa.targetPenetration ? parseFloat(pa.targetPenetration) : null;\n\n        const totalIncrementalRevenue = snapshots.reduce(\n          (sum, s) => sum + parseFloat(s.incrementalRevenue || \"0\"),\n          0\n        );\n        const targetIncrementalRevenue = pa.targetIncrementalRevenue\n          ? parseFloat(pa.targetIncrementalRevenue)\n          : null;\n\n        const enrolledAt = new Date(pa.enrolledAt);\n        const monthsEnrolled = Math.floor((now.getTime() - enrolledAt.getTime()) / MS_PER_MONTH);\n        const targetDurationMonths = pa.targetDurationMonths || null;\n\n        const objectivesMet = {\n          penetration: targetPenetration !== null && currentPenetration >= targetPenetration,\n          revenue: targetIncrementalRevenue !== null && totalIncrementalRevenue >= targetIncrementalRevenue,\n          duration: targetDurationMonths !== null && monthsEnrolled >= targetDurationMonths,\n        };\n\n        const hasObjectives = targetPenetration !== null || targetIncrementalRevenue !== null || targetDurationMonths !== null;\n\n        let isReadyToGraduate = false;\n        const criteria = pa.graduationCriteria || \"any\";\n        if (hasObjectives) {\n          if (criteria === \"all\") {\n            isReadyToGraduate = (targetPenetration === null || objectivesMet.penetration) &&\n              (targetIncrementalRevenue === null || objectivesMet.revenue) &&\n              (targetDurationMonths === null || objectivesMet.duration);\n          } else {\n            isReadyToGraduate = objectivesMet.penetration || objectivesMet.revenue || objectivesMet.duration;\n          }\n        }\n\n        if (isReadyToGraduate) {\n          readyAccounts.push({\n            programAccountId: pa.id,\n            accountId: pa.accountId,\n            accountName: account?.name || \"Unknown\",\n            enrolledAt: pa.enrolledAt,\n            objectivesMet,\n          });\n        }\n      }\n\n      res.json({\n        count: readyAccounts.length,\n        accounts: readyAccounts,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get graduation-ready accounts\");\n    }\n  });\n\n  // Get graduation analytics summary\n  // Revenue metrics explained:\n  // - baselineRevenue: Historical revenue for the baseline period (typically 12 months before enrollment)\n  // - baselinePeriodDays: Duration of baseline period (baselineEnd - baselineStart)\n  // - enrollmentDurationDays: Days from enrollment to graduation\n  // - proRatedBaseline: baselineRevenue * (enrollmentDurationDays / baselinePeriodDays) = expected revenue at baseline run rate\n  // - incrementalRevenue: graduationRevenue - proRatedBaseline = revenue above expected run rate\n  // This represents the true incremental revenue captured during the wallet share expansion program\n  app.get(\"/api/program-accounts/graduation-analytics\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const allProgramAccounts = await tenantStorage.getProgramAccounts();\n      const graduatedAccounts = allProgramAccounts.filter(pa => pa.status === \"graduated\");\n\n      if (graduatedAccounts.length === 0) {\n        return res.json({\n          totalGraduated: 0,\n          cumulativeRevenueGrowth: 0,\n          avgDaysToGraduation: 0,\n          avgRevenueGrowth: 0,\n          avgIcpCategorySuccessRate: 0,\n          graduatedAccounts: [],\n        });\n      }\n\n      // Calculate aggregate metrics from graduated accounts\n      let totalRevenueGrowth = 0;\n      let totalDays = 0;\n      let totalIcpSuccess = 0;\n      let accountsWithIcpData = 0;\n      let accountsWithDuration = 0;\n      let accountsWithRevenue = 0;\n\n      const detailedAccounts = await Promise.all(\n        graduatedAccounts.map(async (pa) => {\n          const account = await tenantStorage.getAccount(pa.accountId);\n\n          const baselineRevenue = parseFloat(pa.baselineRevenue?.toString() || \"0\");\n          const graduationRevenue = parseFloat(pa.graduationRevenue?.toString() || \"0\");\n\n          // Use stored incremental revenue (calculated at graduation using pro-rated baseline)\n          // Falls back to recalculation for accounts graduated before this field was added\n          let revenueGrowth = pa.incrementalRevenue ? parseFloat(pa.incrementalRevenue.toString()) : 0;\n          if (!pa.incrementalRevenue && graduationRevenue > 0) {\n            // Fallback: recalculate for legacy accounts\n            const baselineStart = pa.baselineStart ? new Date(pa.baselineStart) : null;\n            const baselineEnd = pa.baselineEnd ? new Date(pa.baselineEnd) : null;\n            const enrollmentDuration = pa.enrollmentDurationDays || 0;\n\n            let proRatedBaseline = baselineRevenue;\n            if (baselineStart && baselineEnd && enrollmentDuration > 0) {\n              const baselinePeriodDays = Math.floor((baselineEnd.getTime() - baselineStart.getTime()) / (1000 * 60 * 60 * 24));\n              if (baselinePeriodDays > 0) {\n                proRatedBaseline = baselineRevenue * (enrollmentDuration / baselinePeriodDays);\n              }\n            }\n            revenueGrowth = graduationRevenue - proRatedBaseline;\n          }\n\n          if (graduationRevenue > 0 || pa.incrementalRevenue) {\n            totalRevenueGrowth += revenueGrowth;\n            accountsWithRevenue++;\n          }\n\n          if (pa.enrollmentDurationDays) {\n            totalDays += pa.enrollmentDurationDays;\n            accountsWithDuration++;\n          }\n\n          let icpSuccessRate = 0;\n          if (pa.icpCategoriesAtEnrollment && pa.icpCategoriesAtEnrollment > 0) {\n            icpSuccessRate = ((pa.icpCategoriesAchieved || 0) / pa.icpCategoriesAtEnrollment) * 100;\n            totalIcpSuccess += icpSuccessRate;\n            accountsWithIcpData++;\n          }\n\n          return {\n            id: pa.id,\n            accountId: pa.accountId,\n            accountName: account?.name || \"Unknown\",\n            segment: account?.segment || null,\n            enrolledAt: pa.enrolledAt,\n            graduatedAt: pa.graduatedAt,\n            baselineRevenue,\n            graduationRevenue,\n            revenueGrowth,\n            enrollmentDurationDays: pa.enrollmentDurationDays || null,\n            icpCategoriesAtEnrollment: pa.icpCategoriesAtEnrollment || null,\n            icpCategoriesAchieved: pa.icpCategoriesAchieved || null,\n            icpSuccessRate,\n            graduationPenetration: pa.graduationPenetration ? parseFloat(pa.graduationPenetration.toString()) : null,\n          };\n        })\n      );\n\n      res.json({\n        totalGraduated: graduatedAccounts.length,\n        cumulativeRevenueGrowth: totalRevenueGrowth,\n        avgDaysToGraduation: accountsWithDuration > 0 ? Math.round(totalDays / accountsWithDuration) : 0,\n        avgRevenueGrowth: accountsWithRevenue > 0 ? Math.round(totalRevenueGrowth / accountsWithRevenue) : 0,\n        avgIcpCategorySuccessRate: accountsWithIcpData > 0 ? Math.round(totalIcpSuccess / accountsWithIcpData) : 0,\n        graduatedAccounts: detailedAccounts,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get graduation analytics\");\n    }\n  });\n\n  // ============ Data Uploads ============\n  app.get(\"/api/data-uploads\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const uploads = await tenantStorage.getDataUploads();\n      res.json(uploads);\n    } catch (error) {\n      handleRouteError(error, res, \"Get uploads\");\n    }\n  });\n\n  app.post(\"/api/data-uploads\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      // In real implementation, this would handle file upload\n      const data = insertDataUploadSchema.parse(req.body);\n      const upload = await tenantStorage.createDataUpload(data);\n\n      // Simulate processing\n      setTimeout(async () => {\n        await tenantStorage.updateDataUpload(upload.id, {\n          status: \"completed\",\n          rowCount: Math.floor(Math.random() * 1000 + 100),\n        });\n      }, 2000);\n\n      res.status(201).json(upload);\n    } catch (error) {\n      handleRouteError(error, res, \"Create upload\");\n    }\n  });\n\n  // ============ Template Downloads ============\n  app.get(\"/api/templates/:type\", (req, res) => {\n    const { type } = req.params;\n    const validTypes = [\"accounts\", \"products\", \"categories\", \"orders\"];\n\n    if (!validTypes.includes(type)) {\n      return res.status(400).json({ message: \"Invalid template type\" });\n    }\n\n    const templatePath = path.join(process.cwd(), \"public\", \"templates\", `${type}_template.csv`);\n\n    if (!fs.existsSync(templatePath)) {\n      return res.status(404).json({ message: \"Template not found\" });\n    }\n\n    res.setHeader(\"Content-Type\", \"text/csv\");\n    res.setHeader(\"Content-Disposition\", `attachment; filename=\"${type}_template.csv\"`);\n    res.sendFile(templatePath);\n  });\n\n  // ============ Settings ============\n  app.get(\"/api/settings\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const settings = await tenantStorage.getSettings();\n      res.json(settings);\n    } catch (error) {\n      handleRouteError(error, res, \"Get settings\");\n    }\n  });\n\n  app.get(\"/api/settings/:key\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const { key } = req.params;\n      const setting = await tenantStorage.getSetting(key);\n      res.json(setting || { key, value: null });\n    } catch (error) {\n      handleRouteError(error, res, \"Get setting\");\n    }\n  });\n\n  app.put(\"/api/settings/:key\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const { key } = req.params;\n      const { value } = req.body;\n      const setting = await tenantStorage.upsertSetting({ key, value });\n      res.json(setting);\n    } catch (error) {\n      handleRouteError(error, res, \"Update setting\");\n    }\n  });\n\n  // Logo upload endpoint - handles base64 encoded images\n  app.post(\"/api/settings/logo\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const { logo } = req.body;\n      if (!logo) {\n        return res.status(400).json({ message: \"No logo provided\" });\n      }\n      const setting = await tenantStorage.upsertSetting({ key: \"companyLogo\", value: logo });\n      res.json(setting);\n    } catch (error) {\n      handleRouteError(error, res, \"Upload logo\");\n    }\n  });\n\n  app.delete(\"/api/settings/logo\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      await tenantStorage.upsertSetting({ key: \"companyLogo\", value: \"\" });\n      res.json({ success: true });\n    } catch (error) {\n      handleRouteError(error, res, \"Remove logo\");\n    }\n  });\n\n  // ============ Reset Demo Data ============\n  app.post(\"/api/admin/reset-seed\", requireAdmin, async (req, res) => {\n    try {\n      const { seed } = await import(\"./seed\");\n      await seed();\n      res.json({ success: true, message: \"Demo data has been reset successfully.\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Reset seed data\");\n    }\n  });\n\n  // ============ Categories ============\n  app.get(\"/api/categories\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const categories = await tenantStorage.getProductCategories();\n      res.json(categories);\n    } catch (error) {\n      handleRouteError(error, res, \"Get categories\");\n    }\n  });\n\n  // ============ Products ============\n  app.get(\"/api/products\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const products = await tenantStorage.getProducts();\n      res.json(products);\n    } catch (error) {\n      handleRouteError(error, res, \"Get products\");\n    }\n  });\n\n  // ============ Scoring Weights ============\n  app.get(\"/api/scoring-weights\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const weights = await tenantStorage.getScoringWeights();\n      if (!weights) {\n        // Return default weights if none configured\n        res.json({\n          id: 0,\n          name: \"default\",\n          gapSizeWeight: DEFAULT_SCORING_WEIGHTS.gapSizeWeight,\n          revenuePotentialWeight: DEFAULT_SCORING_WEIGHTS.revenuePotentialWeight,\n          categoryCountWeight: DEFAULT_SCORING_WEIGHTS.categoryCountWeight,\n          description: \"Default opportunity score calculation weights\",\n          isActive: true,\n        });\n      } else {\n        res.json({\n          ...weights,\n          gapSizeWeight: parseFloat(weights.gapSizeWeight),\n          revenuePotentialWeight: parseFloat(weights.revenuePotentialWeight),\n          categoryCountWeight: parseFloat(weights.categoryCountWeight),\n        });\n      }\n    } catch (error) {\n      handleRouteError(error, res, \"Get scoring weights\");\n    }\n  });\n\n  app.put(\"/api/scoring-weights\", requireAuth, async (req, res) => {\n    try {\n      const { gapSizeWeight, revenuePotentialWeight, categoryCountWeight, description } = req.body;\n\n      // Validate weights sum to 100\n      const total = gapSizeWeight + revenuePotentialWeight + categoryCountWeight;\n      if (Math.abs(total - 100) > 0.01) {\n        return res.status(400).json({\n          message: `Weights must sum to 100%. Current total: ${total}%`\n        });\n      }\n\n      const tenantStorage = getStorage(req);\n      const weights = await tenantStorage.upsertScoringWeights({\n        name: \"default\",\n        gapSizeWeight: gapSizeWeight.toString(),\n        revenuePotentialWeight: revenuePotentialWeight.toString(),\n        categoryCountWeight: categoryCountWeight.toString(),\n        description,\n        isActive: true,\n        updatedBy: \"admin\",\n      });\n\n      res.json({\n        ...weights,\n        gapSizeWeight: parseFloat(weights.gapSizeWeight),\n        revenuePotentialWeight: parseFloat(weights.revenuePotentialWeight),\n        categoryCountWeight: parseFloat(weights.categoryCountWeight),\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Update scoring weights\");\n    }\n  });\n\n  // ============ Territory Managers ============\n  app.get(\"/api/territory-managers\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const managers = await tenantStorage.getTerritoryManagers();\n      res.json(managers);\n    } catch (error) {\n      handleRouteError(error, res, \"Get territory managers\");\n    }\n  });\n\n  app.post(\"/api/territory-managers\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const data = insertTerritoryManagerSchema.parse(req.body);\n      const manager = await tenantStorage.createTerritoryManager(data);\n      res.status(201).json(manager);\n    } catch (error) {\n      handleRouteError(error, res, \"Create territory manager\");\n    }\n  });\n\n  app.put(\"/api/territory-managers/:id\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid territory manager ID\" });\n      }\n      const updateData = insertTerritoryManagerSchema.partial().parse(req.body);\n      const manager = await tenantStorage.updateTerritoryManager(id, updateData);\n      if (!manager) {\n        return res.status(404).json({ message: \"Territory manager not found\" });\n      }\n      res.json(manager);\n    } catch (error) {\n      handleRouteError(error, res, \"Update territory manager\");\n    }\n  });\n\n  app.delete(\"/api/territory-managers/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid territory manager ID\" });\n      }\n      const success = await tenantStorage.deleteTerritoryManager(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Territory manager not found\" });\n      }\n      res.json({ message: \"Territory manager deleted successfully\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Delete territory manager\");\n    }\n  });\n\n  // ============ Custom Categories ============\n  app.get(\"/api/custom-categories\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const categories = await tenantStorage.getCustomCategories();\n      res.json(categories);\n    } catch (error) {\n      handleRouteError(error, res, \"Get custom categories\");\n    }\n  });\n\n  app.post(\"/api/custom-categories\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const parsed = insertCustomCategorySchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ message: \"Invalid category data\", errors: parsed.error.errors });\n      }\n      const category = await tenantStorage.createCustomCategory(parsed.data);\n      res.status(201).json(category);\n    } catch (error) {\n      handleRouteError(error, res, \"Create custom category\");\n    }\n  });\n\n  app.put(\"/api/custom-categories/:id\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid category ID\" });\n      }\n      const updateData = insertCustomCategorySchema.partial().parse(req.body);\n      const category = await tenantStorage.updateCustomCategory(id, updateData);\n      if (!category) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      res.json(category);\n    } catch (error) {\n      handleRouteError(error, res, \"Update custom category\");\n    }\n  });\n\n  app.delete(\"/api/custom-categories/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid category ID\" });\n      }\n      const success = await tenantStorage.deleteCustomCategory(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Category not found\" });\n      }\n      res.json({ message: \"Category deleted successfully\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Delete custom category\");\n    }\n  });\n\n  // Seed default categories if none exist\n  app.post(\"/api/custom-categories/seed-defaults\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const existing = await tenantStorage.getCustomCategories();\n      if (existing.length > 0) {\n        return res.json({ message: \"Categories already exist\", categories: existing });\n      }\n\n      const defaults = [\n        { name: \"Water Heaters\", displayOrder: 1, isActive: true },\n        { name: \"Controls & Thermostats\", displayOrder: 2, isActive: true },\n        { name: \"PVF\", displayOrder: 3, isActive: true },\n        { name: \"Tools\", displayOrder: 4, isActive: true },\n        { name: \"Chinaware\", displayOrder: 5, isActive: true },\n        { name: \"Brass and Fittings\", displayOrder: 6, isActive: true },\n        { name: \"HVAC Equipment\", displayOrder: 7, isActive: true },\n        { name: \"Refrigerant & Supplies\", displayOrder: 8, isActive: true },\n        { name: \"Ductwork & Fittings\", displayOrder: 9, isActive: true },\n        { name: \"Fixtures\", displayOrder: 10, isActive: true },\n      ];\n\n      const created = [];\n      for (const cat of defaults) {\n        const category = await tenantStorage.createCustomCategory(cat);\n        created.push(category);\n      }\n\n      res.status(201).json({ message: \"Default categories created\", categories: created });\n    } catch (error) {\n      handleRouteError(error, res, \"Seed default categories\");\n    }\n  });\n\n  // ============ Rev-Share Tiers ============\n  app.get(\"/api/rev-share-tiers\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const tiers = await tenantStorage.getRevShareTiers();\n      res.json(tiers);\n    } catch (error) {\n      handleRouteError(error, res, \"Get rev-share tiers\");\n    }\n  });\n\n  app.post(\"/api/rev-share-tiers\", requireAdmin, async (req, res) => {\n    try {\n      const validated = insertRevShareTierSchema.parse(req.body);\n\n      // Validate min/max relationship\n      const minRev = parseFloat(validated.minRevenue ?? \"0\");\n      const maxRev = validated.maxRevenue ? parseFloat(validated.maxRevenue) : null;\n      const shareRate = parseFloat(validated.shareRate ?? \"0\");\n\n      if (isNaN(minRev) || minRev < 0) {\n        return res.status(400).json({ message: \"Minimum revenue must be a non-negative number\" });\n      }\n      if (maxRev !== null && (isNaN(maxRev) || maxRev <= minRev)) {\n        return res.status(400).json({ message: \"Maximum revenue must be greater than minimum revenue\" });\n      }\n      if (isNaN(shareRate) || shareRate < 0 || shareRate > 100) {\n        return res.status(400).json({ message: \"Share rate must be between 0 and 100\" });\n      }\n\n      const tenantStorage = getStorage(req);\n      const tier = await tenantStorage.createRevShareTier(validated);\n      res.status(201).json(tier);\n    } catch (error) {\n      handleRouteError(error, res, \"Create rev-share tier\");\n    }\n  });\n\n  app.put(\"/api/rev-share-tiers/:id\", requireAuth, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id, 10);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid tier ID\" });\n      }\n\n      // First validate against schema\n      const updateData = insertRevShareTierSchema.partial().parse(req.body);\n\n      // Additional business logic validation for min/max relationship\n      if (updateData.minRevenue !== undefined || updateData.maxRevenue !== undefined) {\n        const minRev = updateData.minRevenue ? parseFloat(updateData.minRevenue) : null;\n        const maxRev = updateData.maxRevenue ? parseFloat(updateData.maxRevenue) : null;\n\n        if (minRev !== null && (isNaN(minRev) || minRev < 0)) {\n          return res.status(400).json({ message: \"Minimum revenue must be a non-negative number\" });\n        }\n        if (maxRev !== null && minRev !== null && maxRev <= minRev) {\n          return res.status(400).json({ message: \"Maximum revenue must be greater than minimum revenue\" });\n        }\n      }\n      if (updateData.shareRate !== undefined) {\n        const shareRate = parseFloat(updateData.shareRate);\n        if (isNaN(shareRate) || shareRate < 0 || shareRate > 100) {\n          return res.status(400).json({ message: \"Share rate must be between 0 and 100\" });\n        }\n      }\n\n      const tenantStorage = getStorage(req);\n      const tier = await tenantStorage.updateRevShareTier(id, updateData);\n      if (!tier) {\n        return res.status(404).json({ message: \"Rev-share tier not found\" });\n      }\n      res.json(tier);\n    } catch (error) {\n      handleRouteError(error, res, \"Update rev-share tier\");\n    }\n  });\n\n  app.delete(\"/api/rev-share-tiers/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const id = parseInt(req.params.id, 10);\n      if (isNaN(id)) {\n        return res.status(400).json({ message: \"Invalid tier ID\" });\n      }\n      await tenantStorage.deleteRevShareTier(id);\n      res.status(204).send();\n    } catch (error) {\n      handleRouteError(error, res, \"Delete rev-share tier\");\n    }\n  });\n\n  // Calculate fee based on tiered rates\n  app.post(\"/api/rev-share-tiers/calculate\", requireAuth, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const { incrementalRevenue } = req.body;\n      if (typeof incrementalRevenue !== 'number' || incrementalRevenue < 0) {\n        return res.status(400).json({ message: \"Invalid incremental revenue\" });\n      }\n\n      const tiers = await tenantStorage.getRevShareTiers();\n\n      // If no tiers defined, use default 15%\n      if (tiers.length === 0) {\n        const fee = incrementalRevenue * 0.15;\n        return res.json({\n          incrementalRevenue,\n          totalFee: fee,\n          effectiveRate: 15,\n          breakdown: [{ tier: \"Default\", rate: 15, revenueInTier: incrementalRevenue, fee }]\n        });\n      }\n\n      // Sort tiers by minRevenue\n      const sortedTiers = [...tiers]\n        .filter(t => t.isActive)\n        .sort((a, b) => parseFloat(a.minRevenue) - parseFloat(b.minRevenue));\n\n      let remainingRevenue = incrementalRevenue;\n      let totalFee = 0;\n      const breakdown: Array<{ tier: string; rate: number; revenueInTier: number; fee: number }> = [];\n\n      for (const tier of sortedTiers) {\n        if (remainingRevenue <= 0) break;\n\n        const minRev = parseFloat(tier.minRevenue);\n        const maxRev = tier.maxRevenue ? parseFloat(tier.maxRevenue) : Infinity;\n        const rate = parseFloat(tier.shareRate);\n\n        // How much falls in this tier\n        const tierSize = maxRev - minRev;\n        const revenueInTier = Math.min(remainingRevenue, tierSize);\n\n        if (revenueInTier > 0) {\n          const fee = revenueInTier * (rate / 100);\n          totalFee += fee;\n          breakdown.push({\n            tier: `$${minRev.toLocaleString()} - ${maxRev === Infinity ? 'Unlimited' : '$' + maxRev.toLocaleString()}`,\n            rate,\n            revenueInTier,\n            fee\n          });\n          remainingRevenue -= revenueInTier;\n        }\n      }\n\n      const effectiveRate = incrementalRevenue > 0 ? (totalFee / incrementalRevenue) * 100 : 0;\n\n      res.json({\n        incrementalRevenue,\n        totalFee,\n        effectiveRate: Math.round(effectiveRate * 100) / 100,\n        breakdown\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Calculate rev-share\");\n    }\n  });\n\n  // Seed default tier if none exist\n  app.post(\"/api/rev-share-tiers/seed-default\", requireAdmin, async (req, res) => {\n    try {\n      const tenantStorage = getStorage(req);\n      const existing = await tenantStorage.getRevShareTiers();\n      if (existing.length > 0) {\n        return res.json({ message: \"Tiers already exist\", tiers: existing });\n      }\n\n      const defaultTier = await tenantStorage.createRevShareTier({\n        minRevenue: \"0\",\n        maxRevenue: null,\n        shareRate: \"15\",\n        displayOrder: 0,\n        isActive: true,\n      });\n\n      res.status(201).json({ message: \"Default tier created\", tier: defaultTier });\n    } catch (error) {\n      handleRouteError(error, res, \"Seed default tier\");\n    }\n  });\n\n  // ============ App Admin (Platform-wide tenant management) ============\n  // Platform admin emails (Tenexity team only) - stored in lowercase for comparison\n  const PLATFORM_ADMIN_EMAILS = [\"graham@tenexity.ai\", \"admin@tenexity.ai\"];\n\n  const isPlatformAdmin = (email: string | undefined | null): boolean => {\n    if (!email) return false;\n    // Case-insensitive comparison for email addresses\n    const normalizedEmail = email.toLowerCase().trim();\n    return PLATFORM_ADMIN_EMAILS.some(adminEmail => adminEmail.toLowerCase() === normalizedEmail);\n  };\n\n  const requirePlatformAdmin: RequestHandler = async (req, res, next) => {\n    const userEmail = req.user?.claims?.email;\n    console.log(`[Platform Admin Check] User email: ${userEmail}, Is admin: ${isPlatformAdmin(userEmail)}`);\n    if (!isPlatformAdmin(userEmail)) {\n      return res.status(403).json({\n        message: \"Access denied. Platform administrator privileges required.\",\n        error: \"PLATFORM_ADMIN_REQUIRED\"\n      });\n    }\n    next();\n  };\n\n  /**\n   * Get all tenants with usage metrics for platform administration\n   * @route GET /api/app-admin/tenants\n   * @security requirePlatformAdmin - Requires platform admin email\n   * @returns {Object} List of tenants with their subscription status and usage metrics\n   */\n  app.get(\"/api/app-admin/tenants\", [...requireAuth, requirePlatformAdmin], async (req, res) => {\n    try {\n      // Get all tenants\n      const allTenants = await db.select().from(tenants);\n\n      // Get usage metrics for each tenant\n      const tenantsWithMetrics = await Promise.all(\n        allTenants.map(async (tenant) => {\n          // Get counts for each metric\n          const [accountCountResult] = await db.select({ count: count() })\n            .from(accounts)\n            .where(eq(accounts.tenantId, tenant.id));\n\n          const [playbookCountResult] = await db.select({ count: count() })\n            .from(playbooks)\n            .where(eq(playbooks.tenantId, tenant.id));\n\n          const [icpCountResult] = await db.select({ count: count() })\n            .from(segmentProfiles)\n            .where(eq(segmentProfiles.tenantId, tenant.id));\n\n          const [enrolledCountResult] = await db.select({ count: count() })\n            .from(programAccounts)\n            .where(eq(programAccounts.tenantId, tenant.id));\n\n          const [userCountResult] = await db.select({ count: count() })\n            .from(userRoles)\n            .where(eq(userRoles.tenantId, tenant.id));\n\n          // Get owner email (first user with super_admin role)\n          const [ownerRole] = await db.select()\n            .from(userRoles)\n            .where(eq(userRoles.tenantId, tenant.id))\n            .limit(1);\n\n          let ownerEmail: string | undefined;\n          if (ownerRole) {\n            const [user] = await db.select()\n              .from(users)\n              .where(eq(users.id, ownerRole.userId))\n              .limit(1);\n            ownerEmail = user?.email || undefined;\n          }\n\n          return {\n            ...tenant,\n            ownerEmail,\n            accountCount: accountCountResult?.count || 0,\n            playbookCount: playbookCountResult?.count || 0,\n            icpCount: icpCountResult?.count || 0,\n            enrolledCount: enrolledCountResult?.count || 0,\n            userCount: userCountResult?.count || 0,\n          };\n        })\n      );\n\n      res.json({\n        tenants: tenantsWithMetrics,\n        totalTenants: allTenants.length,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get all tenants\");\n    }\n  });\n\n  /**\n   * Update a tenant's subscription settings\n   * @route PATCH /api/app-admin/tenants/:id\n   * @security requireAdmin - Requires manage_settings permission\n   * @returns {Object} Updated tenant\n   */\n  app.patch(\"/api/app-admin/tenants/:id\", [...requireAuth, requirePlatformAdmin], async (req, res) => {\n    try {\n      const tenantId = parseInt(req.params.id);\n      if (isNaN(tenantId)) {\n        return res.status(400).json({ message: \"Invalid tenant ID\" });\n      }\n\n      const { planType, subscriptionStatus } = req.body;\n\n      const updateData: { planType?: string; subscriptionStatus?: string; updatedAt: Date } = {\n        updatedAt: new Date(),\n      };\n\n      if (planType !== undefined) {\n        updateData.planType = planType;\n      }\n      if (subscriptionStatus !== undefined) {\n        updateData.subscriptionStatus = subscriptionStatus;\n      }\n\n      await db.update(tenants)\n        .set(updateData)\n        .where(eq(tenants.id, tenantId));\n\n      const [updatedTenant] = await db.select()\n        .from(tenants)\n        .where(eq(tenants.id, tenantId))\n        .limit(1);\n\n      if (!updatedTenant) {\n        return res.status(404).json({ message: \"Tenant not found\" });\n      }\n\n      res.json(updatedTenant);\n    } catch (error) {\n      handleRouteError(error, res, \"Update tenant\");\n    }\n  });\n\n  // ============ Stripe & Subscription ============\n  const stripeConfig = initializeStripeConfig();\n  const stripe = stripeConfig.stripe;\n\n  // Validation schemas for Stripe endpoints\n  const checkoutSessionSchema = z.object({\n    priceId: z.string().optional(),\n    planSlug: z.string().optional(),\n    billingCycle: z.enum(['monthly', 'yearly']).default('monthly'),\n  }).refine(data => data.priceId || data.planSlug, {\n    message: \"Either priceId or planSlug is required\"\n  });\n\n  const portalSessionSchema = z.object({}).optional();\n\n  /**\n   * Get all available subscription plans\n   * @route GET /api/subscription/plans\n   * @security None - Public endpoint\n   * @returns {SubscriptionPlan[]} List of active subscription plans ordered by display order\n   */\n  app.get(\"/api/subscription/plans\", async (req, res) => {\n    try {\n      const plans = await db.select().from(subscriptionPlans)\n        .where(eq(subscriptionPlans.isActive, true))\n        .orderBy(subscriptionPlans.displayOrder);\n      res.json(plans);\n    } catch (error) {\n      handleRouteError(error, res, \"Fetch subscription plans\");\n    }\n  });\n\n  /**\n   * Get Stripe debug information (platform admin only)\n   * @route GET /api/stripe/debug\n   * @security requirePlatformAdmin - Requires platform admin privileges\n   * @returns {Object} Stripe configuration info (no secrets exposed)\n   */\n  app.get(\"/api/stripe/debug\", [...requireAuth, requirePlatformAdmin], async (req, res) => {\n    try {\n      const debugInfo = getStripeDebugInfo();\n\n      // Get subscription plan price IDs from database\n      const plans = await db.select({\n        slug: subscriptionPlans.slug,\n        stripeMonthlyPriceId: subscriptionPlans.stripeMonthlyPriceId,\n        stripeYearlyPriceId: subscriptionPlans.stripeYearlyPriceId,\n      }).from(subscriptionPlans)\n        .where(eq(subscriptionPlans.isActive, true));\n\n      res.json({\n        ...debugInfo,\n        configuredPlans: plans,\n        environment: {\n          hasSecretKey: !!process.env.STRIPE_SECRET_KEY,\n          hasWebhookSecret: !!process.env.STRIPE_WEBHOOK_SECRET,\n          hasPriceIds: !!process.env.STRIPE_PRICE_IDS,\n          hasAppSlug: !!process.env.APP_SLUG,\n          hasBaseUrl: !!process.env.BASE_URL,\n        },\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get Stripe debug info\");\n    }\n  });\n\n  /**\n   * Update subscription plan Stripe price IDs (platform admin only)\n   * @route PATCH /api/subscription/plans/:id\n   * @security requirePlatformAdmin - Requires platform admin privileges\n   * @returns {Object} Updated subscription plan\n   */\n  app.patch(\"/api/subscription/plans/:id\", [...requireAuth, requirePlatformAdmin], async (req, res) => {\n    try {\n      const planId = parseInt(req.params.id);\n      if (isNaN(planId)) {\n        return res.status(400).json({ message: \"Invalid plan ID\" });\n      }\n\n      const { stripeMonthlyPriceId, stripeYearlyPriceId } = req.body;\n\n      // Validate Stripe price ID format (price_xxx or empty/null)\n      const stripePriceIdPattern = /^price_[a-zA-Z0-9]+$/;\n      if (stripeMonthlyPriceId && !stripePriceIdPattern.test(stripeMonthlyPriceId)) {\n        return res.status(400).json({ message: \"Invalid monthly price ID format. Must be 'price_xxx'\" });\n      }\n      if (stripeYearlyPriceId && !stripePriceIdPattern.test(stripeYearlyPriceId)) {\n        return res.status(400).json({ message: \"Invalid yearly price ID format. Must be 'price_xxx'\" });\n      }\n\n      const [updatedPlan] = await db.update(subscriptionPlans)\n        .set({\n          stripeMonthlyPriceId: stripeMonthlyPriceId || null,\n          stripeYearlyPriceId: stripeYearlyPriceId || null,\n        })\n        .where(eq(subscriptionPlans.id, planId))\n        .returning();\n\n      if (!updatedPlan) {\n        return res.status(404).json({ message: \"Plan not found\" });\n      }\n\n      res.json(updatedPlan);\n    } catch (error) {\n      handleRouteError(error, res, \"Update subscription plan\");\n    }\n  });\n\n  /**\n   * Get current subscription status for the authenticated tenant\n   * @route GET /api/subscription\n   * @security requireAuth - Requires authentication\n   * @returns {Object} Subscription status including plan details, billing period, and Stripe customer ID\n   */\n  app.get(\"/api/subscription\", requireAuth, async (req, res) => {\n    try {\n      const tenantContext = req.tenantContext;\n      const tenant = tenantContext.tenant;\n\n      // Get plan details if tenant has a plan\n      let planDetails = null;\n      if (tenant.planType && tenant.planType !== 'free') {\n        const [plan] = await db.select().from(subscriptionPlans)\n          .where(eq(subscriptionPlans.slug, tenant.planType))\n          .limit(1);\n        planDetails = plan || null;\n      }\n\n      res.json({\n        subscriptionStatus: tenant.subscriptionStatus || 'none',\n        planType: tenant.planType || 'free',\n        billingPeriodEnd: tenant.billingPeriodEnd,\n        trialEndsAt: tenant.trialEndsAt,\n        canceledAt: tenant.canceledAt,\n        hasStripeCustomer: !!tenant.stripeCustomerId,\n        plan: planDetails,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Fetch subscription\");\n    }\n  });\n\n  /**\n   * Create a Stripe checkout session for subscription purchase\n   * @route POST /api/stripe/create-checkout-session\n   * @body {string} [priceId] - Stripe price ID\n   * @body {string} [planSlug] - Plan slug (alternative to priceId)\n   * @body {string} [billingCycle=monthly] - Billing cycle (monthly or yearly)\n   * @security requireAuth - Requires authentication\n   * @returns {Object} Checkout session URL and session ID\n   */\n  app.post(\"/api/stripe/create-checkout-session\", requireAuth, async (req, res) => {\n    try {\n      if (!stripe) {\n        return res.status(503).json({ message: \"Stripe is not configured\" });\n      }\n\n      // Validate request body\n      const parseResult = checkoutSessionSchema.safeParse(req.body);\n      if (!parseResult.success) {\n        return res.status(400).json({ message: \"Invalid request\", errors: parseResult.error.errors });\n      }\n\n      const { priceId, planSlug, billingCycle } = parseResult.data;\n      const tenantContext = req.tenantContext;\n      const tenant = tenantContext.tenant;\n      const user = req.user;\n\n      if (!priceId && !planSlug) {\n        return res.status(400).json({ message: \"Price ID or plan slug required\" });\n      }\n\n      // Get the price ID from plan if not provided\n      let stripePriceId = priceId;\n      if (!stripePriceId && planSlug) {\n        const [plan] = await db.select().from(subscriptionPlans)\n          .where(eq(subscriptionPlans.slug, planSlug))\n          .limit(1);\n\n        if (!plan) {\n          return res.status(404).json({ message: \"Plan not found\" });\n        }\n\n        stripePriceId = billingCycle === 'yearly'\n          ? plan.stripeYearlyPriceId\n          : plan.stripeMonthlyPriceId;\n\n        if (!stripePriceId) {\n          return res.status(400).json({ message: \"Stripe price not configured for this plan\" });\n        }\n      }\n\n      // Validate price ID against whitelist (if configured)\n      if (stripePriceId && !isPriceIdWhitelisted(stripePriceId)) {\n        console.warn(`Checkout attempt with non-whitelisted price ID: ${stripePriceId}`);\n        return res.status(400).json({ message: \"Invalid price ID for this application\" });\n      }\n\n      const config = getStripeConfig();\n\n      // Get or create Stripe customer (with app metadata for webhook validation)\n      let customerId = tenant.stripeCustomerId;\n      if (!customerId) {\n        const customer = await stripe.customers.create({\n          email: user?.claims?.email || 'unknown@example.com',\n          name: tenant.name,\n          metadata: {\n            tenantId: tenant.id.toString(),\n            app: config.appSlug,\n          }\n        });\n        customerId = customer.id;\n\n        // Save customer ID to database\n        await db.update(tenants)\n          .set({ stripeCustomerId: customerId })\n          .where(eq(tenants.id, tenant.id));\n      }\n\n      const session = await stripe.checkout.sessions.create({\n        customer: customerId,\n        mode: 'subscription',\n        client_reference_id: tenant.id.toString(),\n        line_items: [{ price: stripePriceId, quantity: 1 }],\n        success_url: `${config.baseUrl}/subscription?success=true&session_id={CHECKOUT_SESSION_ID}`,\n        cancel_url: `${config.baseUrl}/subscription?canceled=true`,\n        metadata: {\n          tenantId: tenant.id.toString(),\n          app: config.appSlug,\n          priceId: stripePriceId || '',\n        },\n        subscription_data: {\n          metadata: {\n            tenantId: tenant.id.toString(),\n            app: config.appSlug,\n            priceId: stripePriceId || '',\n          }\n        }\n      });\n\n      res.json({ url: session.url, sessionId: session.id });\n    } catch (error: any) {\n      handleRouteError(error, res, \"Create checkout session\");\n    }\n  });\n\n  /**\n   * Create a Stripe billing portal session for subscription management\n   * @route POST /api/stripe/create-portal-session\n   * @security requireAuth - Requires authentication\n   * @returns {Object} Billing portal session URL\n   */\n  app.post(\"/api/stripe/create-portal-session\", requireAuth, async (req, res) => {\n    try {\n      if (!stripe) {\n        return res.status(503).json({ message: \"Stripe is not configured\" });\n      }\n\n      const tenantContext = req.tenantContext;\n      const tenant = tenantContext.tenant;\n\n      if (!tenant.stripeCustomerId) {\n        return res.status(400).json({ message: \"No billing account found\" });\n      }\n\n      const config = getStripeConfig();\n      const returnUrl = process.env.STRIPE_CUSTOMER_PORTAL_RETURN_URL || `${config.baseUrl}/subscription`;\n\n      const session = await stripe.billingPortal.sessions.create({\n        customer: tenant.stripeCustomerId,\n        return_url: returnUrl\n      });\n\n      res.json({ url: session.url });\n    } catch (error: any) {\n      handleRouteError(error, res, \"Create portal session\");\n    }\n  });\n\n  // Helper function to find plan by Stripe price ID (monthly or yearly)\n  async function findPlanByPriceId(priceId: string): Promise<{ slug: string } | null> {\n    // Try monthly price first\n    let [plan] = await db.select().from(subscriptionPlans)\n      .where(eq(subscriptionPlans.stripeMonthlyPriceId, priceId))\n      .limit(1);\n\n    if (plan) return { slug: plan.slug };\n\n    // Try yearly price\n    [plan] = await db.select().from(subscriptionPlans)\n      .where(eq(subscriptionPlans.stripeYearlyPriceId, priceId))\n      .limit(1);\n\n    if (plan) return { slug: plan.slug };\n\n    return null;\n  }\n\n  // Stripe webhook handler - uses rawBody stored by global JSON parser\n  app.post(\"/api/stripe/webhook\", async (req, res) => {\n    if (!stripe) {\n      console.error('Webhook error: Stripe not configured');\n      return res.status(503).send('Webhook Error: Stripe not configured');\n    }\n\n    const sig = req.headers['stripe-signature'] as string;\n    let event: Stripe.Event;\n\n    // Use rawBody stored by the global JSON parser in index.ts\n    const rawBody = (req as any).rawBody;\n\n    if (!rawBody) {\n      console.error('Webhook error: No raw body available');\n      return res.status(400).send('Webhook Error: No raw body');\n    }\n\n    if (!process.env.STRIPE_WEBHOOK_SECRET) {\n      console.error('Webhook error: STRIPE_WEBHOOK_SECRET not configured');\n      return res.status(500).send('Webhook Error: Not configured');\n    }\n\n    try {\n      event = stripe.webhooks.constructEvent(\n        rawBody,\n        sig,\n        process.env.STRIPE_WEBHOOK_SECRET\n      );\n    } catch (err: any) {\n      console.error('Webhook signature verification failed:', err.message);\n      return res.status(400).send(`Webhook Error: ${err.message}`);\n    }\n\n    const config = getStripeConfig();\n\n    // ATOMIC IDEMPOTENCY: Try to insert first, check if it was a conflict\n    // Using a try-catch to detect unique constraint violation\n    try {\n      await db.insert(stripeWebhookEvents).values({\n        stripeEventId: event.id,\n        eventType: event.type,\n        appSlug: config.appSlug,\n        result: \"processing\",\n      });\n    } catch (insertError: any) {\n      // Check if this is a unique constraint violation (event already exists)\n      if (insertError?.code === '23505' || insertError?.message?.includes('duplicate key')) {\n        logWebhookEvent({\n          eventId: event.id,\n          eventType: event.type,\n          result: \"skipped\",\n          reason: \"Event already processed (idempotency check)\",\n        });\n        return res.json({ received: true, status: \"already_processed\" });\n      }\n      // Re-throw other errors\n      throw insertError;\n    }\n\n    // Helper to get app slug from subscription or customer metadata (fallback)\n    const getAppSlugFromRelatedObject = async (eventData: any): Promise<string | undefined> => {\n      // First try direct metadata\n      if (eventData.metadata?.app) {\n        return eventData.metadata.app;\n      }\n\n      // For invoice events, check subscription metadata\n      if (eventData.subscription && typeof eventData.subscription === 'string') {\n        try {\n          const subscription = await stripe.subscriptions.retrieve(eventData.subscription);\n          if (subscription.metadata?.app) {\n            return subscription.metadata.app;\n          }\n        } catch (e) {\n          console.warn(`Failed to retrieve subscription ${eventData.subscription} for app validation`);\n        }\n      }\n\n      // For customer events or as last resort, check customer metadata\n      const customerId = eventData.customer as string | undefined;\n      if (customerId) {\n        try {\n          const customer = await stripe.customers.retrieve(customerId);\n          if (!customer.deleted && (customer as Stripe.Customer).metadata?.app) {\n            return (customer as Stripe.Customer).metadata.app;\n          }\n        } catch (e) {\n          console.warn(`Failed to retrieve customer ${customerId} for app validation`);\n        }\n      }\n\n      return undefined;\n    };\n\n    // Helper to get price ID from metadata or related objects (fallback)\n    const getPriceIdFromRelatedObject = async (eventData: any): Promise<string | undefined> => {\n      // First try direct metadata\n      if (eventData.metadata?.priceId) {\n        return eventData.metadata.priceId;\n      }\n\n      // From subscription items\n      if (eventData.items?.data?.[0]?.price?.id) {\n        return eventData.items.data[0].price.id;\n      }\n\n      // From invoice lines\n      if (eventData.lines?.data?.[0]?.price?.id) {\n        return eventData.lines.data[0].price.id;\n      }\n\n      // For checkout session, check subscription\n      if (eventData.subscription && typeof eventData.subscription === 'string') {\n        try {\n          const subscription = await stripe.subscriptions.retrieve(eventData.subscription);\n          // Check subscription metadata first\n          if (subscription.metadata?.priceId) {\n            return subscription.metadata.priceId;\n          }\n          // Then check subscription items\n          if (subscription.items.data[0]?.price.id) {\n            return subscription.items.data[0].price.id;\n          }\n        } catch (e) {\n          console.warn(`Failed to retrieve subscription for price validation`);\n        }\n      }\n\n      return undefined;\n    };\n\n    const eventData = event.data.object as any;\n\n    // Get app slug with fallback to subscription/customer metadata\n    const eventAppSlug = await getAppSlugFromRelatedObject(eventData);\n\n    // Strict app slug validation: require metadata.app to match\n    if (eventAppSlug !== config.appSlug) {\n      const reason = eventAppSlug\n        ? `Event for different app: ${eventAppSlug}`\n        : \"Event missing app metadata - skipping for security\";\n\n      await db.update(stripeWebhookEvents)\n        .set({ result: \"skipped_app_mismatch\" })\n        .where(eq(stripeWebhookEvents.stripeEventId, event.id));\n\n      logWebhookEvent({\n        eventId: event.id,\n        eventType: event.type,\n        result: \"skipped\",\n        reason,\n      });\n      return res.json({ received: true, status: \"skipped_app_mismatch\" });\n    }\n\n    // Validate price ID against whitelist (if whitelist is configured)\n    // FAIL CLOSED: If whitelist is set and we can't determine the priceId, skip the event\n    if (config.whitelistedPriceIds.length > 0) {\n      const priceId = await getPriceIdFromRelatedObject(eventData);\n\n      // Fail closed: if we have a whitelist but can't determine priceId, skip\n      if (!priceId) {\n        await db.update(stripeWebhookEvents)\n          .set({ result: \"skipped_unknown_price\" })\n          .where(eq(stripeWebhookEvents.stripeEventId, event.id));\n\n        logWebhookEvent({\n          eventId: event.id,\n          eventType: event.type,\n          result: \"skipped\",\n          reason: \"Price whitelist configured but could not determine price ID - fail closed\",\n        });\n        return res.json({ received: true, status: \"skipped_unknown_price\" });\n      }\n\n      if (!isPriceIdWhitelisted(priceId)) {\n        await db.update(stripeWebhookEvents)\n          .set({ result: \"skipped_invalid_price\" })\n          .where(eq(stripeWebhookEvents.stripeEventId, event.id));\n\n        logWebhookEvent({\n          eventId: event.id,\n          eventType: event.type,\n          result: \"skipped\",\n          reason: `Invalid price ID: ${priceId}`,\n        });\n        return res.json({ received: true, status: \"skipped_invalid_price\" });\n      }\n    }\n\n    console.log(`Stripe webhook received: ${event.type}`);\n\n    try {\n      switch (event.type) {\n        case 'checkout.session.completed': {\n          const session = event.data.object as Stripe.Checkout.Session;\n          const tenantId = session.metadata?.tenantId ? parseInt(session.metadata.tenantId) : null;\n\n          if (tenantId && session.subscription) {\n            // Get subscription details to extract plan info\n            const subscription = await stripe.subscriptions.retrieve(session.subscription as string);\n            const priceId = subscription.items.data[0]?.price.id;\n\n            // Find matching plan by price ID (monthly or yearly)\n            const matchingPlan = priceId ? await findPlanByPriceId(priceId) : null;\n\n            if (!matchingPlan) {\n              console.error(`Webhook: No plan found for price ID ${priceId}`);\n              // Don't fail - just log and continue with unknown plan\n            }\n\n            await db.update(tenants)\n              .set({\n                stripeSubscriptionId: session.subscription as string,\n                subscriptionStatus: 'active',\n                planType: matchingPlan?.slug || null, // Store null if unknown, don't assume 'starter'\n                billingPeriodEnd: new Date(subscription.current_period_end * 1000),\n              })\n              .where(eq(tenants.id, tenantId));\n\n            console.log(`Tenant ${tenantId} subscription activated: ${matchingPlan?.slug || 'unknown'}`);\n          }\n          break;\n        }\n\n        case 'customer.subscription.created': {\n          // Handle subscription created directly (backup for checkout.session.completed)\n          const subscription = event.data.object as Stripe.Subscription;\n          const customerId = subscription.customer as string;\n          const tenantIdFromMeta = subscription.metadata?.tenantId ? parseInt(subscription.metadata.tenantId) : null;\n\n          // Try to find tenant by metadata first, then by customer ID\n          let tenant = null;\n          if (tenantIdFromMeta) {\n            const [foundTenant] = await db.select().from(tenants)\n              .where(eq(tenants.id, tenantIdFromMeta))\n              .limit(1);\n            tenant = foundTenant;\n          }\n          if (!tenant) {\n            const [foundTenant] = await db.select().from(tenants)\n              .where(eq(tenants.stripeCustomerId, customerId))\n              .limit(1);\n            tenant = foundTenant;\n          }\n\n          if (tenant) {\n            const priceId = subscription.items.data[0]?.price.id;\n            const matchingPlan = priceId ? await findPlanByPriceId(priceId) : null;\n\n            const status = subscription.status === 'active' ? 'active'\n              : subscription.status === 'trialing' ? 'trialing'\n                : 'none';\n\n            await db.update(tenants)\n              .set({\n                stripeSubscriptionId: subscription.id,\n                subscriptionStatus: status,\n                planType: matchingPlan?.slug || tenant.planType,\n                billingPeriodEnd: new Date(subscription.current_period_end * 1000),\n              })\n              .where(eq(tenants.id, tenant.id));\n\n            console.log(`Tenant ${tenant.id} subscription created: ${matchingPlan?.slug || 'unknown'} (${status})`);\n          }\n          break;\n        }\n\n        case 'customer.subscription.updated': {\n          const subscription = event.data.object as Stripe.Subscription;\n          const customerId = subscription.customer as string;\n\n          // Find tenant by customer ID\n          const [tenant] = await db.select().from(tenants)\n            .where(eq(tenants.stripeCustomerId, customerId))\n            .limit(1);\n\n          if (tenant) {\n            const status = subscription.status === 'active' ? 'active'\n              : subscription.status === 'trialing' ? 'trialing'\n                : subscription.status === 'past_due' ? 'past_due'\n                  : subscription.status === 'canceled' ? 'canceled'\n                    : 'none';\n\n            await db.update(tenants)\n              .set({\n                subscriptionStatus: status,\n                billingPeriodEnd: new Date(subscription.current_period_end * 1000),\n                canceledAt: subscription.canceled_at ? new Date(subscription.canceled_at * 1000) : null,\n              })\n              .where(eq(tenants.id, tenant.id));\n\n            console.log(`Tenant ${tenant.id} subscription updated: ${status}`);\n          }\n          break;\n        }\n\n        case 'customer.subscription.deleted': {\n          const subscription = event.data.object as Stripe.Subscription;\n          const customerId = subscription.customer as string;\n\n          const [tenant] = await db.select().from(tenants)\n            .where(eq(tenants.stripeCustomerId, customerId))\n            .limit(1);\n\n          if (tenant) {\n            await db.update(tenants)\n              .set({\n                subscriptionStatus: 'canceled',\n                canceledAt: new Date(),\n              })\n              .where(eq(tenants.id, tenant.id));\n\n            console.log(`Tenant ${tenant.id} subscription canceled`);\n          }\n          break;\n        }\n\n        case 'invoice.paid': {\n          const invoice = event.data.object as Stripe.Invoice;\n          const customerId = invoice.customer as string;\n\n          const [tenant] = await db.select().from(tenants)\n            .where(eq(tenants.stripeCustomerId, customerId))\n            .limit(1);\n\n          if (tenant && invoice.subscription) {\n            const subscription = await stripe.subscriptions.retrieve(invoice.subscription as string);\n\n            await db.update(tenants)\n              .set({\n                subscriptionStatus: 'active',\n                billingPeriodEnd: new Date(subscription.current_period_end * 1000),\n              })\n              .where(eq(tenants.id, tenant.id));\n\n            console.log(`Tenant ${tenant.id} invoice paid, subscription renewed`);\n          }\n          break;\n        }\n\n        case 'invoice.payment_failed': {\n          const invoice = event.data.object as Stripe.Invoice;\n          const customerId = invoice.customer as string;\n\n          const [tenant] = await db.select().from(tenants)\n            .where(eq(tenants.stripeCustomerId, customerId))\n            .limit(1);\n\n          if (tenant) {\n            await db.update(tenants)\n              .set({ subscriptionStatus: 'past_due' })\n              .where(eq(tenants.id, tenant.id));\n\n            console.log(`Tenant ${tenant.id} payment failed, marked as past_due`);\n          }\n          break;\n        }\n      }\n\n      // Log event for audit trail\n      const webhookEventData = event.data.object as any;\n      let tenantId: number | null = null;\n\n      if (webhookEventData.metadata?.tenantId) {\n        tenantId = parseInt(webhookEventData.metadata.tenantId);\n      } else if (webhookEventData.customer) {\n        const [foundTenant] = await db.select().from(tenants)\n          .where(eq(tenants.stripeCustomerId, webhookEventData.customer))\n          .limit(1);\n        tenantId = foundTenant?.id || null;\n      }\n\n      // Get subscription and customer IDs for logging\n      const subscriptionId = webhookEventData.subscription || webhookEventData.id;\n      const customerId = webhookEventData.customer;\n      const priceId = webhookEventData.items?.data?.[0]?.price?.id;\n\n      if (tenantId) {\n        await db.insert(subscriptionEvents).values({\n          tenantId,\n          eventType: event.type,\n          stripeEventId: event.id,\n          data: webhookEventData,\n        });\n      }\n\n      // Update idempotency record with success result\n      await db.update(stripeWebhookEvents)\n        .set({ result: \"processed\" })\n        .where(eq(stripeWebhookEvents.stripeEventId, event.id));\n\n      logWebhookEvent({\n        eventId: event.id,\n        eventType: event.type,\n        subscriptionId,\n        customerId,\n        tenantId,\n        priceId,\n        result: \"processed\",\n      });\n\n    } catch (error) {\n      // Update idempotency record with error result\n      await db.update(stripeWebhookEvents)\n        .set({ result: \"error\" })\n        .where(eq(stripeWebhookEvents.stripeEventId, event.id));\n\n      logWebhookEvent({\n        eventId: event.id,\n        eventType: event.type,\n        result: \"error\",\n        reason: error instanceof Error ? error.message : \"Unknown error\",\n      });\n      console.error(`Error processing webhook ${event.type}:`, error);\n      // Still return 200 to acknowledge receipt\n    }\n\n    res.json({ received: true });\n  });\n\n  // ============ Email Settings ============\n  app.get(\"/api/email/settings\", requireSubscription, async (req, res) => {\n    try {\n      const settings = await getEmailSettings();\n      res.json({\n        ...settings,\n        isConfigured: isEmailConfigured(),\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Get email settings\");\n    }\n  });\n\n  app.patch(\"/api/email/settings\", requireSubscription, async (req, res) => {\n    try {\n      const validatedData = updateEmailSettingsSchema.parse(req.body);\n      const settings = await saveEmailSettings(validatedData);\n      res.json(settings);\n    } catch (error) {\n      handleRouteError(error, res, \"Update email settings\");\n    }\n  });\n\n  app.post(\"/api/email/test\", requireSubscription, async (req, res) => {\n    try {\n      const { email } = req.body;\n      if (!email) {\n        return res.status(400).json({ message: \"Email address required\" });\n      }\n\n      const result = await sendTestEmail(email);\n      if (result.success) {\n        res.json({ message: \"Test email sent successfully\", messageId: result.messageId });\n      } else {\n        res.status(400).json({ message: result.error || \"Failed to send test email\" });\n      }\n    } catch (error) {\n      handleRouteError(error, res, \"Send test email\");\n    }\n  });\n\n  // ============================================================\n  // EMAIL OAUTH & SYNC ROUTES\n  // ============================================================\n  const {\n    getMicrosoftAuthUrl,\n    getGoogleAuthUrl,\n    exchangeMicrosoftCode,\n    exchangeGoogleCode,\n    getEmailConnections,\n    getEmailConnection,\n    disconnectEmailConnection,\n    saveEmailConnection,\n  } = await import(\"./services/email-oauth.js\");\n  const { syncEmailsForConnection, getSyncedEmails, getSyncedEmail } = await import(\"./services/email-sync.js\");\n  const { analyzeUnprocessedEmails } = await import(\"./services/email-ai-analysis.js\");\n\n  app.get(\"/api/email/connections\", requireSubscription, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const connections = await getEmailConnections(tenantId);\n      const safeConnections = connections.map(c => ({\n        id: c.id,\n        provider: c.provider,\n        emailAddress: c.emailAddress,\n        status: c.status,\n        lastSyncAt: c.lastSyncAt,\n        syncError: c.syncError,\n        createdAt: c.createdAt,\n      }));\n      res.json(safeConnections);\n    } catch (error) {\n      handleRouteError(error, res, \"Get email connections\");\n    }\n  });\n\n  app.get(\"/api/auth/microsoft/start\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const userId = req.user?.claims?.sub || \"\";\n      const state = Buffer.from(JSON.stringify({ tenantId, userId })).toString(\"base64url\");\n      const authUrl = getMicrosoftAuthUrl(state);\n      res.json({ authUrl });\n    } catch (error) {\n      handleRouteError(error, res, \"Start Microsoft OAuth\");\n    }\n  });\n\n  app.get(\"/api/auth/microsoft/callback\", async (req, res) => {\n    try {\n      const { code, state } = req.query;\n      if (!code || !state) {\n        return res.redirect(\"/settings?error=missing_params\");\n      }\n\n      const stateData = JSON.parse(Buffer.from(state as string, \"base64url\").toString());\n      const { tenantId, userId } = stateData;\n\n      const tokens = await exchangeMicrosoftCode(code as string);\n\n      await saveEmailConnection({\n        tenantId,\n        userId,\n        provider: \"microsoft\",\n        emailAddress: tokens.email,\n        accessToken: tokens.accessToken,\n        refreshToken: tokens.refreshToken,\n        tokenExpiresAt: new Date(Date.now() + tokens.expiresIn * 1000),\n        status: \"connected\",\n      });\n\n      res.redirect(\"/settings?tab=integrations&connected=microsoft\");\n    } catch (error) {\n      console.error(\"Microsoft OAuth callback error:\", error);\n      res.redirect(\"/settings?tab=integrations&error=microsoft_failed\");\n    }\n  });\n\n  app.get(\"/api/auth/google-email/start\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const userId = req.user?.claims?.sub || \"\";\n      const state = Buffer.from(JSON.stringify({ tenantId, userId })).toString(\"base64url\");\n      const authUrl = getGoogleAuthUrl(state);\n      res.json({ authUrl });\n    } catch (error) {\n      handleRouteError(error, res, \"Start Google OAuth\");\n    }\n  });\n\n  app.get(\"/api/auth/google-email/callback\", async (req, res) => {\n    try {\n      const { code, state } = req.query;\n      if (!code || !state) {\n        return res.redirect(\"/settings?error=missing_params\");\n      }\n\n      const stateData = JSON.parse(Buffer.from(state as string, \"base64url\").toString());\n      const { tenantId, userId } = stateData;\n\n      const tokens = await exchangeGoogleCode(code as string);\n\n      await saveEmailConnection({\n        tenantId,\n        userId,\n        provider: \"google\",\n        emailAddress: tokens.email,\n        accessToken: tokens.accessToken,\n        refreshToken: tokens.refreshToken,\n        tokenExpiresAt: new Date(Date.now() + tokens.expiresIn * 1000),\n        status: \"connected\",\n      });\n\n      res.redirect(\"/settings?tab=integrations&connected=google\");\n    } catch (error) {\n      console.error(\"Google OAuth callback error:\", error);\n      res.redirect(\"/settings?tab=integrations&error=google_failed\");\n    }\n  });\n\n  app.delete(\"/api/email/connections/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid connection ID\" });\n      await disconnectEmailConnection(id, tenantId);\n      res.json({ message: \"Connection disconnected\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Disconnect email\");\n    }\n  });\n\n  app.post(\"/api/email/connections/:id/sync\", requireSubscription, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid connection ID\" });\n\n      const connection = await getEmailConnection(id, tenantId);\n      if (!connection) return res.status(404).json({ message: \"Connection not found\" });\n\n      const result = await syncEmailsForConnection(connection);\n      res.json({ message: \"Sync complete\", ...result });\n    } catch (error) {\n      handleRouteError(error, res, \"Sync emails\");\n    }\n  });\n\n  app.post(\"/api/email/connections/:id/analyze\", requireSubscription, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const result = await analyzeUnprocessedEmails(tenantId);\n      res.json({ message: \"Analysis complete\", ...result });\n    } catch (error) {\n      handleRouteError(error, res, \"Analyze emails\");\n    }\n  });\n\n  app.get(\"/api/synced-emails\", requireSubscription, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const connectionId = req.query.connectionId ? parseInt(req.query.connectionId as string) : undefined;\n      const accountId = req.query.accountId ? parseInt(req.query.accountId as string) : undefined;\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 50;\n      const offset = req.query.offset ? parseInt(req.query.offset as string) : 0;\n\n      const result = await getSyncedEmails(tenantId, { connectionId, accountId, limit, offset });\n      res.json(result);\n    } catch (error) {\n      handleRouteError(error, res, \"Get synced emails\");\n    }\n  });\n\n  app.get(\"/api/synced-emails/:id\", requireSubscription, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext!.tenantId;\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid email ID\" });\n\n      const email = await getSyncedEmail(id, tenantId);\n      if (!email) return res.status(404).json({ message: \"Email not found\" });\n      res.json(email);\n    } catch (error) {\n      handleRouteError(error, res, \"Get synced email\");\n    }\n  });\n\n  // ============================================================\n  // CRM ROUTES â€” Contacts, Projects, Order Signals, Competitors\n  // ============================================================\n  const { insertContactSchema, insertProjectSchema } = await import(\"@shared/schema\");\n\n  app.get(\"/api/crm/contacts\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const accountId = req.query.accountId ? parseInt(req.query.accountId as string) : undefined;\n      res.json(await storage.getContacts(accountId));\n    } catch (error) {\n      handleRouteError(error, res, \"Get contacts\");\n    }\n  });\n\n  app.get(\"/api/crm/contacts/:id\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid contact ID\" });\n      const contact = await storage.getContact(id);\n      if (!contact) return res.status(404).json({ message: \"Contact not found\" });\n      res.json(contact);\n    } catch (error) {\n      handleRouteError(error, res, \"Get contact\");\n    }\n  });\n\n  app.post(\"/api/crm/contacts\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const data = insertContactSchema.parse({ ...req.body, tenantId: req.tenantContext!.tenantId, source: \"manual\" });\n      const contact = await storage.createContact(data);\n      res.status(201).json(contact);\n    } catch (error) {\n      handleRouteError(error, res, \"Create contact\");\n    }\n  });\n\n  app.patch(\"/api/crm/contacts/:id\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid contact ID\" });\n      const updated = await storage.updateContact(id, req.body);\n      if (!updated) return res.status(404).json({ message: \"Contact not found\" });\n      res.json(updated);\n    } catch (error) {\n      handleRouteError(error, res, \"Update contact\");\n    }\n  });\n\n  app.delete(\"/api/crm/contacts/:id\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid contact ID\" });\n      await storage.deleteContact(id);\n      res.json({ message: \"Contact deleted\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Delete contact\");\n    }\n  });\n\n  app.get(\"/api/crm/projects\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const accountId = req.query.accountId ? parseInt(req.query.accountId as string) : undefined;\n      const stage = req.query.stage as string | undefined;\n      res.json(await storage.getProjects(accountId, stage));\n    } catch (error) {\n      handleRouteError(error, res, \"Get projects\");\n    }\n  });\n\n  app.get(\"/api/crm/projects/:id\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid project ID\" });\n      const project = await storage.getProject(id);\n      if (!project) return res.status(404).json({ message: \"Project not found\" });\n      res.json(project);\n    } catch (error) {\n      handleRouteError(error, res, \"Get project\");\n    }\n  });\n\n  app.post(\"/api/crm/projects\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const data = insertProjectSchema.parse({ ...req.body, tenantId: req.tenantContext!.tenantId, source: \"manual\" });\n      const project = await storage.createProject(data);\n      res.status(201).json(project);\n    } catch (error) {\n      handleRouteError(error, res, \"Create project\");\n    }\n  });\n\n  app.patch(\"/api/crm/projects/:id\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid project ID\" });\n      const updated = await storage.updateProject(id, req.body);\n      if (!updated) return res.status(404).json({ message: \"Project not found\" });\n      res.json(updated);\n    } catch (error) {\n      handleRouteError(error, res, \"Update project\");\n    }\n  });\n\n  app.delete(\"/api/crm/projects/:id\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid project ID\" });\n      await storage.deleteProject(id);\n      res.json({ message: \"Project deleted\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Delete project\");\n    }\n  });\n\n  app.get(\"/api/crm/order-signals\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const accountId = req.query.accountId ? parseInt(req.query.accountId as string) : undefined;\n      const signalType = req.query.signalType as string | undefined;\n      const status = req.query.status as string | undefined;\n      res.json(await storage.getOrderSignals(accountId, signalType, status));\n    } catch (error) {\n      handleRouteError(error, res, \"Get order signals\");\n    }\n  });\n\n  app.patch(\"/api/crm/order-signals/:id\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid order signal ID\" });\n      const updated = await storage.updateOrderSignal(id, req.body);\n      if (!updated) return res.status(404).json({ message: \"Order signal not found\" });\n      res.json(updated);\n    } catch (error) {\n      handleRouteError(error, res, \"Update order signal\");\n    }\n  });\n\n  app.get(\"/api/crm/competitor-mentions\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const accountId = req.query.accountId ? parseInt(req.query.accountId as string) : undefined;\n      const threatLevel = req.query.threatLevel as string | undefined;\n      res.json(await storage.getCompetitorMentions(accountId, threatLevel));\n    } catch (error) {\n      handleRouteError(error, res, \"Get competitor mentions\");\n    }\n  });\n\n  app.patch(\"/api/crm/competitor-mentions/:id\", requireWrite, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) return res.status(400).json({ message: \"Invalid competitor mention ID\" });\n      const updated = await storage.updateCompetitorMention(id, req.body);\n      if (!updated) return res.status(404).json({ message: \"Competitor mention not found\" });\n      res.json(updated);\n    } catch (error) {\n      handleRouteError(error, res, \"Update competitor mention\");\n    }\n  });\n\n  app.get(\"/api/crm/contacts/:contactId/interactions\", requireSubscription, async (req, res) => {\n    try {\n      const storage = getTenantStorage(req.tenantContext!.tenantId);\n      const contactId = parseInt(req.params.contactId);\n      if (isNaN(contactId)) return res.status(400).json({ message: \"Invalid contact ID\" });\n      res.json(await storage.getContactInteractions(contactId));\n    } catch (error) {\n      handleRouteError(error, res, \"Get contact interactions\");\n    }\n  });\n\n  // ============================================================\n  // AGENT ROUTES â€” Phase 0: Identity & Continuity\n  // ============================================================\n  const { getCoreSystemPrompt, readAgentState } = await import(\"./services/agent-identity.js\");\n\n  app.get(\"/api/agent/system-prompt\", requireAuth, async (req, res) => {\n    try {\n      const content = await getCoreSystemPrompt();\n      res.json({ promptKey: \"core_agent_identity\", content });\n    } catch (error) {\n      handleRouteError(error, res, \"Get agent system prompt\");\n    }\n  });\n\n  app.get(\"/api/agent/state/:runType\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const state = await readAgentState(tenantId, req.params.runType);\n      if (!state) return res.status(404).json({ message: \"No agent state found for this run type\" });\n      res.json(state);\n    } catch (error) {\n      handleRouteError(error, res, \"Get agent state\");\n    }\n  });\n\n  app.get(\"/api/agent/learnings\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const { tradeType, playbookType, limit } = req.query;\n      const learnings = await storage.getAgentPlaybookLearnings(\n        tenantId,\n        tradeType as string | undefined,\n        playbookType as string | undefined,\n        limit ? parseInt(limit as string) : 5,\n      );\n      res.json(learnings);\n    } catch (error) {\n      handleRouteError(error, res, \"Get agent learnings\");\n    }\n  });\n\n  app.post(\"/api/agent/learnings\", requireAdmin, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const { learning, tradeType, playbookType, evidenceCount, successRate } = req.body;\n      if (!learning) return res.status(400).json({ message: \"learning field is required\" });\n      const created = await storage.createAgentPlaybookLearning({\n        tenantId,\n        learning,\n        tradeType: tradeType ?? null,\n        playbookType: playbookType ?? null,\n        evidenceCount: evidenceCount ?? 1,\n        successRate: successRate ?? null,\n        isActive: true,\n      });\n      res.status(201).json(created);\n    } catch (error) {\n      handleRouteError(error, res, \"Create agent learning\");\n    }\n  });\n\n  // ============================================================\n  // AGENT ROUTES â€” Phase 2: Intelligence Services\n  // ============================================================\n  const { assembleAccountContext } = await import(\"./services/account-context.js\");\n  const { generateAccountEmbedding, findSimilarAccounts, refreshAllEmbeddings } = await import(\"./services/account-embedding.js\");\n\n  app.get(\"/api/agent/account-context/:accountId\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const accountId = parseInt(req.params.accountId);\n      if (isNaN(accountId)) return res.status(400).json({ message: \"Invalid account ID\" });\n      const ctx = await assembleAccountContext(accountId, tenantId);\n      res.json(ctx);\n    } catch (error) {\n      handleRouteError(error, res, \"Get account context\");\n    }\n  });\n\n  app.post(\"/api/agent/generate-embedding/:accountId\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const accountId = parseInt(req.params.accountId);\n      if (isNaN(accountId)) return res.status(400).json({ message: \"Invalid account ID\" });\n      const vector = await generateAccountEmbedding(accountId, tenantId);\n      res.json({ accountId, dimensions: vector.length, message: \"Embedding generated and stored.\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Generate account embedding\");\n    }\n  });\n\n  app.post(\"/api/agent/find-similar/:accountId\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const accountId = parseInt(req.params.accountId);\n      if (isNaN(accountId)) return res.status(400).json({ message: \"Invalid account ID\" });\n      const topK = req.body?.topK ?? 5;\n      await findSimilarAccounts(accountId, tenantId, topK);\n      res.json({ message: `Similar account pairs computed and stored for account ${accountId}.` });\n    } catch (error) {\n      handleRouteError(error, res, \"Find similar accounts\");\n    }\n  });\n\n  app.post(\"/api/agent/refresh-embeddings\", requireAdmin, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      refreshAllEmbeddings(tenantId).catch((err) =>\n        console.error(\"[refresh-embeddings] background error:\", err)\n      );\n      res.json({ message: \"Embedding refresh started in background.\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Refresh all embeddings\");\n    }\n  });\n\n  // ============================================================\n  // AGENT ROUTES â€” Phase 3: Agent Loop Services\n  // ============================================================\n  const { generatePlaybook } = await import(\"./services/generate-playbook\");\n  const { runDailyBriefing } = await import(\"./services/daily-briefing\");\n  const { analyzeEmailIntelligence } = await import(\"./services/email-intelligence\");\n  const { streamAskAnything } = await import(\"./services/ask-anything\");\n  const { runWeeklyAccountReview } = await import(\"./services/weekly-account-review\");\n  const { processCrmSyncQueue } = await import(\"./services/crm-sync-push\");\n\n  app.post(\"/api/agent/generate-playbook\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const { accountId, playbookType } = req.body;\n      if (!accountId) return res.status(400).json({ message: \"accountId is required\" });\n      const result = await generatePlaybook(Number(accountId), tenantId, playbookType);\n      res.json(result);\n    } catch (error) {\n      handleRouteError(error, res, \"Generate playbook\");\n    }\n  });\n\n  app.post(\"/api/agent/daily-briefing\", requireAdmin, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      runDailyBriefing(tenantId)\n        .then((r) => console.log(\"[daily-briefing] Done:\", r))\n        .catch((err) => console.error(\"[daily-briefing] Error:\", err));\n      res.json({ message: \"Daily briefing started. Emails will be sent shortly.\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Daily briefing\");\n    }\n  });\n\n  app.post(\"/api/agent/email-intelligence\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const { interactionId } = req.body;\n      if (!interactionId) return res.status(400).json({ message: \"interactionId is required\" });\n      const result = await analyzeEmailIntelligence(Number(interactionId), tenantId);\n      res.json(result);\n    } catch (error) {\n      handleRouteError(error, res, \"Email intelligence\");\n    }\n  });\n\n  app.get(\"/api/agent/ask-anything\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const { question, scope, scopeId } = req.query as Record<string, string>;\n      if (!question) return res.status(400).json({ message: \"question is required\" });\n      const validScope = ([\"account\", \"portfolio\", \"program\"].includes(scope) ? scope : \"portfolio\") as \"account\" | \"portfolio\" | \"program\";\n      await streamAskAnything(question, validScope, scopeId ? Number(scopeId) : null, tenantId, res);\n    } catch (error) {\n      console.error(\"[ask-anything] Route error:\", error);\n      res.end();\n    }\n  });\n\n  app.post(\"/api/agent/weekly-account-review\", requireAdmin, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      runWeeklyAccountReview(tenantId)\n        .then((r) => console.log(\"[weekly-review] Done:\", r))\n        .catch((err) => console.error(\"[weekly-review] Error:\", err));\n      res.json({ message: \"Weekly account review started in background.\" });\n    } catch (error) {\n      handleRouteError(error, res, \"Weekly account review\");\n    }\n  });\n\n  app.post(\"/api/agent/crm-sync-push\", requireAdmin, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n      const result = await processCrmSyncQueue(tenantId);\n      res.json(result);\n    } catch (error) {\n      handleRouteError(error, res, \"CRM sync push\");\n    }\n  });\n\n  app.get(\"/api/agent/health-check\", requireAuth, async (req, res) => {\n    try {\n      const tenantId = req.tenantContext?.tenantId;\n      if (!tenantId) return res.status(401).json({ message: \"Not authenticated\" });\n\n      const runTypes = [\"daily-briefing\", \"weekly-account-review\", \"email-intelligence\", \"generate-playbook\", \"synthesize-learnings\"];\n      const stateRows = await Promise.all(\n        runTypes.map((rt) => storage.getAgentState(tenantId, rt))\n      );\n      const stateMap = Object.fromEntries(\n        runTypes.map((rt, i) => [rt, stateRows[i] ? {\n          lastRunAt: stateRows[i]!.lastRunAt,\n          lastRunSummary: stateRows[i]!.lastRunSummary,\n          currentFocus: stateRows[i]!.currentFocus,\n        } : null])\n      );\n\n      const openaiOk = !!(process.env.OPENAI_API_KEY);\n      const resendOk = !!(process.env.RESEND_API_KEY);\n\n      res.json({\n        status: \"ok\",\n        timestamp: new Date().toISOString(),\n        config: { openaiConfigured: openaiOk, resendConfigured: resendOk },\n        agentState: stateMap,\n      });\n    } catch (error) {\n      handleRouteError(error, res, \"Health check\");\n    }\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":159212,"size_tokens":null},"server/utils/constants.ts":{"content":"export const DASHBOARD_LIMITS = {\n  TOP_OPPORTUNITIES: 10,\n  RECENT_TASKS: 5,\n  TOP_GAPS: 3,\n  FOCUS_TASKS: 10,\n  ACCOUNT_GAPS_DISPLAY: 5,\n  TERRITORY_RANKING: 4,\n  QUICK_WINS: 3,\n} as const;\n\nexport const DEFAULT_VALUES = {\n  BASELINE_REVENUE: 50000,\n  SHARE_RATE: \"0.10\",\n  CATEGORY_COUNT: 0,\n  OPPORTUNITY_SCORE: 0,\n  FALLBACK_REVENUE: 100000,\n  QUICK_WIN_REVENUE: 5000,\n} as const;\n\nexport const SCORING = {\n  NEAR_ICP_THRESHOLD: 20,\n  DEFAULT_GAP_PERCENTAGE: 30,\n  MAX_SCORE: 100,\n} as const;\n\nexport const SLICE_LIMITS = {\n  TOP_3: 3,\n  TOP_5: 5,\n  TOP_10: 10,\n  CATEGORY_SUGGESTIONS: 2,\n} as const;\n\nexport const PAGINATION = {\n  DEFAULT_PAGE: 1,\n  DEFAULT_LIMIT: 50,\n  MAX_LIMIT: 100,\n} as const;\n","path":null,"size_bytes":705,"size_tokens":null},"docs/agentic-intelligence-layer-build-log.md":{"content":"# Agentic Intelligence Layer â€” Build Log & Reference\n\n> **Project:** Wallet Share Expander  \n> **Completed:** February 2026  \n> **Branch:** `main` on `github.com/tenexity/wallet-expander`  \n> **Commits:** Phase 0 (`agent identity`) â†’ `75786a0` (prod build fix)\n\nThis document captures the full scope of the 6-phase agentic intelligence layer that was designed and implemented to add an autonomous AI agent to the Wallet Share Expander application. It is intended as a reference for future enhancements.\n\n---\n\n## Architecture Overview\n\nThe system is built on the existing **Express + Drizzle ORM + Replit** stack. No new runtime (Supabase, Lambda, etc.) was introduced. All agent logic runs as Express services, scheduled by `node-cron` on the same server process.\n\n```\nClient (React/Vite)\n  â””â”€â”€ /api/agent/* routes (Express)\n        â”œâ”€â”€ Reads/writes agent tables via Drizzle ORM\n        â”œâ”€â”€ Calls OpenAI (gpt-4o / text-embedding-3-small)\n        â””â”€â”€ Sends email via Resend (noreply@ignition.tenexity.ai)\n\nServer Scheduler (node-cron)\n  â””â”€â”€ server/scheduler.ts â€” 6 cron jobs, all tenant-scoped\n```\n\n---\n\n## Phase 0 â€” Agent Identity & Continuity\n\n**Goal:** Give the AI agent a persistent identity, memory, and self-improvement loop across runs.\n\n### New Database Tables\n| Table | Purpose |\n|-------|---------|\n| `agent_system_prompts` | Stores the agent's core identity prompt (one active row per tenant) |\n| `agent_state` | Tracks last-run metadata, pattern notes, open questions, and agent memo per `run_type` |\n| `agent_playbook_learnings` | Cross-account patterns distilled from playbook outcomes |\n\n### New Files\n- `server/services/agent-identity.ts` â€” `getCoreSystemPrompt()`, `writeAgentMemo()`, `getActivelearnings()` helpers\n- `migrations/phase0_agent_identity.sql` â€” SQL migration for the three tables\n- `server/seed-agent.ts` â€” Seeds the identity prompt and 5 initial learnings\n\n### Key Design Decisions\n- Every agent service call reads `agent_state` at start and writes `agent_memo` at end â€” this is how the agent accumulates institutional memory across runs.\n- `agent_playbook_learnings` rows are marked `is_active = false` when superseded by the monthly learning synthesis job.\n\n### Re-enable Checklist (Replit)\n```bash\nnpm run db:push          # run after Phase 1 schema additions\nnpx tsx server/seed-agent.ts\n```\nThen verify:\n- `GET /api/agent/system-prompt` returns the core identity prompt\n- `GET /api/agent/state/daily-briefing` returns initialized state\n\n---\n\n## Phase 1 â€” Entity Store\n\n**Goal:** Extend existing tables and add new agent-specific tables to support full account context.\n\n### Schema Extensions Needed (NOT YET MIGRATED)\nThese have been designed but not yet added to `shared/schema.ts` or run through `db:push`. This is the blocker for re-enabling Phase 2/3/5 features.\n\n| Table / Column | Change |\n|----------------|--------|\n| `accounts.wallet_share_direction` | `text` â€” \"growing\" \\| \"flat\" \\| \"declining\" |\n| `accounts.enrollment_status` | `text` â€” \"enrolled\" \\| \"graduated\" \\| \"at_risk\" |\n| `accounts.enrolled_at`, `graduated_at` | `timestamp` |\n| `accounts.seasonality_profile` | `jsonb` |\n| `account_metrics.wallet_share_percentage` | `numeric` |\n| `account_metrics.days_since_last_order` | `integer` |\n| `agent_contacts` | Contacts per account |\n| `agent_projects` | Inferred or rep-entered projects per account |\n| `agent_categories` | Org-specific category taxonomy |\n| `agent_account_category_spend` | Spend history per category per account |\n| `agent_interactions` | Email / call / visit / system log events |\n| `agent_competitors` + `agent_account_competitors` | Competitor tracking |\n| `agent_playbooks` | AI-generated playbooks per account |\n| `agent_playbook_outcomes` | Rep-logged outcomes against playbook tasks |\n| `agent_rep_daily_briefings` | Stored briefing records per rep per day |\n| `agent_query_log` | Ask-anything query and response log |\n| `agent_organization_settings` | Per-tenant config: Resend key, webhook URL, briefing time |\n| `agent_crm_sync_queue` | Outbound CRM event queue with retry tracking |\n| `agent_similar_account_pairs` | Pre-computed cosine similarity pairs |\n\n> **Next step:** Add all of the above to `shared/schema.ts`, run `npm run db:push`, then re-enable agent routes and scheduler.\n\n---\n\n## Phase 2 â€” Relationship Graph & Similarity\n\n**Goal:** Build an embedding-based similarity engine so the agent can recommend look-alike accounts.\n\n### New Files\n- `server/services/account-embedding.ts`\n  - `generateAccountEmbedding(accountId, tenantId)` â€” builds a rich text profile from DB data, calls OpenAI `text-embedding-3-small`, stores 1536-dim vector as `jsonb` in `accounts.embedding`\n  - `refreshAllEmbeddings(tenantId)` â€” iterates all accounts updated in past 7 days\n  - `findSimilarAccounts(accountId, tenantId)` â€” cosine similarity search, upserts into `agent_similar_account_pairs`\n  - `assembleAccountContext(accountId, tenantId)` â€” returns a complete JSONB context bundle used by all AI calls (accounts, metrics, contacts, spend, interactions, playbooks, projects, competitors, similar accounts, state, learnings)\n\n### Key Design Decisions\n- Embeddings stored as `jsonb` for POC (not pgvector) â€” easy to swap later when migrating to Supabase\n- `assembleAccountContext` is the single source of truth for AI context â€” all Phase 3 services call it\n\n---\n\n## Phase 3 â€” Agent Loop Services (Express Routes)\n\n**Goal:** Implement the core AI services that run the agent's day-to-day intelligence work.\n\n### Services & Routes\n\n| Service File | Route | Trigger |\n|---|---|---|\n| `generate-playbook.ts` | `POST /api/agent/generate-playbook` | Rep enrolls account or manual |\n| `daily-briefing.ts` | `POST /api/agent/daily-briefing` | node-cron weekdays 7am EST |\n| `email-intelligence.ts` | `POST /api/agent/email-intelligence` | `agent_interactions` INSERT with `source='email'` |\n| `ask-anything.ts` | `POST /api/agent/ask-anything` (SSE) | Frontend Ask Anything Bar |\n| `weekly-account-review.ts` | `POST /api/agent/weekly-account-review` | node-cron Mondays 6am EST |\n| `crm-sync-push.ts` | `POST /api/agent/crm-sync-push` | `accounts.enrollment_status` change, outcome INSERT |\n| `agent-identity.ts` | `GET /api/agent/system-prompt`, `GET /api/agent/learnings`, `GET /api/agent/state/:runType` | On-demand |\n\n### Agent Service Contract (all services follow this pattern)\n```typescript\n// 1. Read agent_state for this run_type\nconst state = await storage.getAgentState(tenantId, runType);\n\n// 2. Include pattern_notes + open_questions in OpenAI context\nconst systemPrompt = await getCoreSystemPrompt();\n\n// 3. Call OpenAI with withRetry wrapper + Zod validation\nconst result = await withRetry(() => openai.chat.completions.create(...));\nconst parsed = ResponseSchema.parse(JSON.parse(result.choices[0].message.content));\n\n// 4. Write agent_memo back to agent_state\nawait writeAgentMemo(tenantId, runType, parsed.agent_memo);\n```\n\n### Email (Resend)\n- From: `noreply@ignition.tenexity.ai`\n- Daily briefing is HTML email per rep, rendered from AI output\n- Congratulations email fires when an account graduates (weekly review job)\n\n### Ask Anything (SSE)\n```\nPOST /api/agent/ask-anything\nBody: { question: string, scope: \"portfolio\" | \"account\" | \"program\", accountId?: number }\nResponse: text/event-stream with data: chunks\n```\n\n---\n\n## Phase 4 â€” Frontend Integration\n\n**Goal:** Build 5 new React components wiring the agent services into the UI.\n\n### New Components\n\n| Component | Path | Key Features |\n|-----------|------|-------------|\n| `AccountDossierPanel` | `client/src/components/account-dossier-panel.tsx` | Slide-out sheet. 3 tabs: Playbook (priority action, email trigger), Intel (interaction timeline, competitor intel), Context (contacts, projects, similar graduates) |\n| `AskAnythingBar` | `client/src/components/ask-anything-bar.tsx` | Persistent header bar. SSE streaming overlay, scope picker (Portfolio/Account/Program), cycling placeholders |\n| `DailyBriefingCard` | `client/src/components/daily-briefing-card.tsx` | Dashboard-top card. Today's focus, priority accounts, collapsible at-risk banner, refresh trigger |\n| `EmailComposerModal` | `client/src/components/email-composer-modal.tsx` | Pre-filled from playbook. Personalization notes, follow-up date, copy-to-clipboard |\n| `ProgramPerformancePage` | `client/src/pages/program-performance.tsx` | `/program-performance` route. Enrollment funnel, KPI tiles (enrolled/graduated/at_risk/avg wallet share), rep leaderboard |\n\n### App Wiring\n- `App.tsx` â€” Added `/program-performance` route + `AskAnythingBar` in authenticated header\n- `app-sidebar.tsx` â€” Added \"Program Performance\" nav item with `BarChart3` icon\n- `dashboard.tsx` â€” Added `DailyBriefingCard` at top + `AccountDossierPanel` (opens from briefing card account clicks)\n\n---\n\n## Phase 5 â€” Scheduler & Cron Jobs\n\n**Goal:** Automate the agent loop with `node-cron`.\n\n### New Files\n- `server/scheduler.ts` â€” All 6 cron job definitions\n- `server/notify-webhook.ts` â€” Typed convenience wrappers for outbound CRM events\n\n### Cron Schedule\n\n| Job | Schedule | Timezone |\n|-----|----------|----------|\n| Daily Briefing | `0 7 * * 1-5` (weekdays 7am) | America/New_York |\n| Weekly Account Review | `0 6 * * 1` (Mondays 6am) | America/New_York |\n| Synthesize Learnings | `0 3 1 * *` (1st of month 3am) | America/New_York |\n| Refresh Embeddings | `0 2 * * 0` (Sundays 2am) | America/New_York |\n| Refresh Similar Pairs | `0 3 * * 0` (Sundays 3am) | America/New_York |\n| CRM Sync Retry | `0 */4 * * *` (every 4 hours) | America/New_York |\n\n### Env Var Required\n```\nSCHEDULER_TENANT_ID=1   # set in Replit Secrets\n```\n\n### Current Status\nScheduler is **disabled** in `server/index.ts` pending Phase 1 schema migration. To re-enable:\n```typescript\n// In server/index.ts â€” uncomment:\nimport { startScheduler, stopScheduler } from \"./scheduler\";\n// ...and the startScheduler(schedulerTenantId) call\n```\n\n### notify-webhook.ts â€” CRM Convenience Wrappers\n```typescript\nnotifyEnrollment(tenantId, accountId, accountName, assignedTm, playbookType)\nnotifyGraduation(tenantId, accountId, accountName, assignedTm, revenue, days)\nnotifyAtRisk(tenantId, accountId, accountName, assignedTm, signals, level)\n```\nEach queues a `CrmPayload` row and attempts immediate delivery â€” the 4-hour cron handles retries for failures.\n\n---\n\n## Landing Page Updates\n\n**Goal:** Reflect the new agentic capabilities in the marketing landing page.\n\n### Changes Made to `client/src/pages/landing.tsx`\n\n| Change | Detail |\n|--------|--------|\n| Hero badge | \"Human Relationships, Enhanced by AI\" â†’ \"Agentic AI That Thinks, Plans, and Reminds\" |\n| Hero sub-copy | Now calls out overnight monitoring, daily briefings, automatic risk flagging |\n| 3-step flow â†’ 4-step | Added \"Agent Monitors\" step (highlighted) between Enroll and Graduate |\n| New showcase: Daily Briefing | Slot 3 â€” morning briefing mockup |\n| New showcase: Ask Anything | Slot 5 â€” streaming Q&A mockup with scope toggle |\n| New showcase: Email Intelligence | Slot 9 â€” email analysis panel with sentiment + competitor tags |\n| Stats bar | Replaced \"100% enrolled get custom plans\" with \"Daily â€” AI Briefings Sent to Every Rep\" |\n| New section: Agent Loop | 6-card grid before graduation proof â€” maps each cron job to plain-English description |\n\n### New Mockup Components (in `feature-mockups.tsx`)\n- `MockupDailyBriefing` â€” email-style morning briefing card\n- `MockupAskAnything` â€” search bar with streaming AI response\n- `MockupEmailIntelligence` â€” email log + AI analysis panel\n\n---\n\n## Production Build Notes\n\n### Build Process\n```\nnpm run build\n  â†’ tsx script/build.ts\n      â†’ viteBuild()     # client bundle â†’ dist/public/\n      â†’ esbuild(...)    # server bundle â†’ dist/index.cjs\n```\n\n### Known Gotcha: esbuild Bundles Eagerly\nesbuild resolves all `import` statements statically at build time â€” including dynamic `import()` inside `async` functions. This means that even if a route is \"disabled\" with comments, any file imported at the **module level** will still be bundled and must compile cleanly.\n\n**Example of what broke:** `server/index.ts` imported `./scheduler`, which imported `./services/daily-briefing`, which imported schema tables that don't exist yet â†’ silent esbuild crash â†’ Replit fell back to last successful build.\n\n**Fix pattern:** When disabling a feature that imports missing schema tables, comment out the **top-level import** in `index.ts` or `routes.ts`, not just the route handler.\n\n```typescript\n// âœ… Correct â€” stops esbuild from following the import chain\n// import { startScheduler } from \"./scheduler\";\n\n// âŒ Wrong â€” esbuild still bundles scheduler.ts even with the call commented out\nimport { startScheduler } from \"./scheduler\";\n// startScheduler(tenantId); // commented out\n```\n\n---\n\n## What's Left (Future Enhancements)\n\n### Immediate Next Steps\n1. **Add Phase 1 schema tables** to `shared/schema.ts` and run `npm run db:push` on Replit\n2. **Re-enable agent routes** in `server/routes.ts` (currently blocked by comment)\n3. **Re-enable scheduler** in `server/index.ts` (one line uncomment)\n4. **Run seed script** on Replit: `npx tsx server/seed-agent.ts`\n\n### Longer-Term Roadmap\n| Feature | Notes |\n|---------|-------|\n| Gmail OAuth integration | For `EmailComposerModal` real send (currently logs interaction only) |\n| Outlook 365 OAuth | Same as Gmail |\n| pgvector native support | Currently embeddings stored as `jsonb`; migrate when moving to Supabase |\n| Migrate to Supabase | Auth + Edge Functions + pgvector â€” designed to be plug-and-play |\n| Admin UI: LLM provider selector | Choose between OpenAI, Anthropic, etc. |\n| Multi-tenant scheduler | `startScheduler` currently called once with a single `tenantId`; extend to iterate all tenants |\n\n---\n\n## Key File Index\n\n| File | Role |\n|------|------|\n| `shared/schema.ts` | Single source of truth for all DB tables |\n| `server/index.ts` | Server entry point â€” scheduler wired here |\n| `server/routes.ts` | All API routes â€” agent routes at bottom, currently disabled |\n| `server/scheduler.ts` | 6 node-cron jobs |\n| `server/notify-webhook.ts` | Outbound CRM webhook helpers |\n| `server/services/agent-identity.ts` | Core identity prompt + memo helpers |\n| `server/services/account-embedding.ts` | Embeddings + similarity + context assembly |\n| `server/services/generate-playbook.ts` | AI playbook generation |\n| `server/services/daily-briefing.ts` | Daily rep email |\n| `server/services/email-intelligence.ts` | Email signal extraction |\n| `server/services/ask-anything.ts` | SSE streaming Q&A |\n| `server/services/weekly-account-review.ts` | Auto-graduation + risk assessment |\n| `server/services/crm-sync-push.ts` | CRM webhook queue + delivery |\n| `client/src/components/account-dossier-panel.tsx` | Account slide-out panel |\n| `client/src/components/ask-anything-bar.tsx` | Persistent AI search bar |\n| `client/src/components/daily-briefing-card.tsx` | Dashboard briefing card |\n| `client/src/components/email-composer-modal.tsx` | Email draft + send modal |\n| `client/src/pages/program-performance.tsx` | Program analytics page |\n| `client/src/pages/landing.tsx` | Marketing landing page |\n| `client/src/components/feature-mockups.tsx` | Landing page UI mockups |\n| `docs/wallet-share-expander-build-spec.md` | Original full build specification |\n","path":null,"size_bytes":15417,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"client/replit_integrations/audio/index.ts":{"content":"/**\n * Voice chat client utilities for Replit AI Integrations.\n * \n * Usage:\n * 1. Copy audio-playback-worklet.js to your public/ folder\n * 2. Import and use the React hooks in your components\n * \n * Example:\n * ```tsx\n * import { useVoiceRecorder, useVoiceStream } from \"./audio\";\n * \n * function VoiceChat() {\n *   const [transcript, setTranscript] = useState(\"\");\n *   const recorder = useVoiceRecorder();\n *   const stream = useVoiceStream({\n *     onTranscript: (_, full) => setTranscript(full),\n *     onComplete: (text) => console.log(\"Done:\", text),\n *   });\n * \n *   const handleClick = async () => {\n *     if (recorder.state === \"recording\") {\n *       const blob = await recorder.stopRecording();\n *       await stream.streamVoiceResponse(\"/api/voice-conversations/1/messages\", blob);\n *     } else {\n *       await recorder.startRecording();\n *     }\n *   };\n * \n *   return (\n *     <div>\n *       <button onClick={handleClick}>\n *         {recorder.state === \"recording\" ? \"Stop\" : \"Record\"}\n *       </button>\n *       <p>{transcript}</p>\n *     </div>\n *   );\n * }\n * ```\n */\n\nexport { decodePCM16ToFloat32, createAudioPlaybackContext } from \"./audio-utils\";\nexport { useVoiceRecorder, type RecordingState } from \"./useVoiceRecorder\";\nexport { useAudioPlayback, type PlaybackState } from \"./useAudioPlayback\";\nexport { useVoiceStream } from \"./useVoiceStream\";\n\n","path":null,"size_bytes":1379,"size_tokens":null},"tests/unit/tenantContext.middleware.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport type { Request, Response, NextFunction } from 'express';\nimport { requireRole, hasPermission, requirePermission } from '../../server/middleware/tenantContext';\nimport { ROLE_PERMISSIONS } from '../../shared/schema';\n\nfunction createMockRequest(tenantContext?: any): Partial<Request> {\n  return { tenantContext };\n}\n\nfunction createMockResponse(): Partial<Response> {\n  const res: Partial<Response> = {};\n  res.status = vi.fn().mockReturnValue(res);\n  res.json = vi.fn().mockReturnValue(res);\n  return res;\n}\n\ndescribe('requireRole', () => {\n  let mockNext: NextFunction;\n\n  beforeEach(() => {\n    mockNext = vi.fn();\n  });\n\n  it('returns 401 when no tenant context exists', () => {\n    const middleware = requireRole('super_admin');\n    const req = createMockRequest(undefined) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(401);\n    expect(res.json).toHaveBeenCalledWith({ message: 'Unauthorized - no tenant context' });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('returns 403 when role is not in allowed roles', () => {\n    const middleware = requireRole('super_admin');\n    const req = createMockRequest({\n      role: 'viewer',\n      tenantId: 1,\n      userId: 'user-123',\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(403);\n    expect(res.json).toHaveBeenCalledWith({ message: 'Forbidden - insufficient permissions' });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('calls next when role matches allowed role', () => {\n    const middleware = requireRole('super_admin');\n    const req = createMockRequest({\n      role: 'super_admin',\n      tenantId: 1,\n      userId: 'user-123',\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n    expect(res.status).not.toHaveBeenCalled();\n  });\n\n  it('allows multiple roles', () => {\n    const middleware = requireRole('super_admin', 'reviewer');\n    const req = createMockRequest({\n      role: 'reviewer',\n      tenantId: 1,\n      userId: 'user-123',\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n  });\n\n  it('denies when role not in any allowed roles', () => {\n    const middleware = requireRole('super_admin', 'reviewer');\n    const req = createMockRequest({\n      role: 'viewer',\n      tenantId: 1,\n      userId: 'user-123',\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(403);\n  });\n});\n\ndescribe('hasPermission', () => {\n  it('returns true when role has the permission', () => {\n    expect(hasPermission('super_admin', 'read')).toBe(true);\n    expect(hasPermission('super_admin', 'write')).toBe(true);\n    expect(hasPermission('super_admin', 'delete')).toBe(true);\n    expect(hasPermission('super_admin', 'manage_users')).toBe(true);\n    expect(hasPermission('super_admin', 'manage_settings')).toBe(true);\n  });\n\n  it('returns true for reviewer with read and approve permissions', () => {\n    expect(hasPermission('reviewer', 'read')).toBe(true);\n    expect(hasPermission('reviewer', 'approve')).toBe(true);\n  });\n\n  it('returns false for reviewer with write permissions', () => {\n    expect(hasPermission('reviewer', 'write')).toBe(false);\n    expect(hasPermission('reviewer', 'delete')).toBe(false);\n  });\n\n  it('returns true for viewer with read permission only', () => {\n    expect(hasPermission('viewer', 'read')).toBe(true);\n  });\n\n  it('returns false for viewer with other permissions', () => {\n    expect(hasPermission('viewer', 'write')).toBe(false);\n    expect(hasPermission('viewer', 'delete')).toBe(false);\n    expect(hasPermission('viewer', 'approve')).toBe(false);\n  });\n});\n\ndescribe('requirePermission', () => {\n  let mockNext: NextFunction;\n\n  beforeEach(() => {\n    mockNext = vi.fn();\n  });\n\n  it('returns 401 when no tenant context exists', () => {\n    const middleware = requirePermission('read');\n    const req = createMockRequest(undefined) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(401);\n    expect(res.json).toHaveBeenCalledWith({ message: 'Unauthorized - no tenant context' });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('returns 403 when role lacks the permission', () => {\n    const middleware = requirePermission('manage_settings');\n    const req = createMockRequest({\n      role: 'viewer',\n      tenantId: 1,\n      userId: 'user-123',\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(403);\n    expect(res.json).toHaveBeenCalledWith({ message: 'Forbidden - insufficient permissions' });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('calls next when role has the permission', () => {\n    const middleware = requirePermission('read');\n    const req = createMockRequest({\n      role: 'viewer',\n      tenantId: 1,\n      userId: 'user-123',\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n    expect(res.status).not.toHaveBeenCalled();\n  });\n\n  it('super_admin has all permissions', () => {\n    const permissions = ['read', 'write', 'delete', 'manage_users', 'manage_settings'];\n    \n    permissions.forEach(permission => {\n      const middleware = requirePermission(permission);\n      const req = createMockRequest({\n        role: 'super_admin',\n        tenantId: 1,\n        userId: 'user-123',\n      }) as Request;\n      const res = createMockResponse() as Response;\n      const next = vi.fn();\n\n      middleware(req, res, next);\n\n      expect(next).toHaveBeenCalled();\n    });\n  });\n});\n","path":null,"size_bytes":6092,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"server/scheduler.ts":{"content":"/**\n * scheduler.ts â€” Phase 5\n *\n * All node-cron schedule definitions for the agent loop.\n * Import and call `startScheduler(tenantId)` from server/index.ts\n * AFTER `registerRoutes()` has run.\n *\n * Schedule reference (all times EST / America/New_York):\n *   Daily Briefing      â†’ weekdays 7:00am\n *   Weekly Review       â†’ Mondays  6:00am\n *   Synthesize Learning â†’ 1st of month 3:00am\n *   Refresh Embeddings  â†’ Sundays  2:00am\n *   Refresh Similarity  â†’ Sundays  3:00am\n *   CRM Sync Retry      â†’ every 4 hours\n */\n\nimport cron from \"node-cron\";\nimport { log } from \"./index.js\";\n\n// â”€â”€â”€ Lazy service imports  (avoids circular deps at module load time) â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nasync function getDailyBriefingService() {\n    const { runDailyBriefing } = await import(\"./services/daily-briefing.js\");\n    return runDailyBriefing;\n}\n\nasync function getWeeklyReviewService() {\n    const { runWeeklyAccountReview } = await import(\"./services/weekly-account-review.js\");\n    return runWeeklyAccountReview;\n}\n\nasync function getEmbeddingService() {\n    const { refreshAllEmbeddings } = await import(\"./services/account-embedding.js\");\n    return refreshAllEmbeddings;\n}\n\nasync function getCrmSyncService() {\n    const { processCrmSyncQueue } = await import(\"./services/crm-sync-push.js\");\n    return processCrmSyncQueue;\n}\n\nasync function getDailyDigestService() {\n    const { sendDailyDigest } = await import(\"./email-service.js\");\n    return sendDailyDigest;\n}\n\n// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction safeRun(label: string, fn: () => Promise<unknown>): void {\n    fn()\n        .then((res) => log(`[scheduler] ${label} done: ${JSON.stringify(res)}`, \"cron\"))\n        .catch((err) => log(`[scheduler] ${label} error: ${err?.message ?? err}`, \"cron\"));\n}\n\n// â”€â”€â”€ Scheduler bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function startScheduler(tenantId: number): void {\n    log(`[scheduler] Starting with tenantId=${tenantId}`, \"cron\");\n\n    // â”€â”€ 1. Daily Briefing â€” weekdays at 7:00am EST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    // Cron: minute=0, hour=7, day-of-month=*, month=*, day-of-week=1-5\n    cron.schedule(\n        \"0 7 * * 1-5\",\n        async () => {\n            const runDailyBriefing = await getDailyBriefingService();\n            safeRun(\"daily-briefing\", () => runDailyBriefing(tenantId));\n        },\n        { timezone: \"America/New_York\", name: \"daily-briefing\" },\n    );\n\n    // â”€â”€ 2. Weekly Account Review â€” Mondays at 6:00am EST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    cron.schedule(\n        \"0 6 * * 1\",\n        async () => {\n            const runWeeklyAccountReview = await getWeeklyReviewService();\n            safeRun(\"weekly-account-review\", () => runWeeklyAccountReview(tenantId));\n        },\n        { timezone: \"America/New_York\", name: \"weekly-account-review\" },\n    );\n\n    // â”€â”€ 3. Synthesize Learnings â€” 1st of every month at 3:00am EST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    cron.schedule(\n        \"0 3 1 * *\",\n        async () => {\n            try {\n                const { default: OpenAI } = await import(\"openai\");\n                const { storage } = await import(\"./storage.js\");\n                const { getCoreSystemPrompt, writeAgentMemo } = await import(\"./services/agent-identity.js\");\n                const { eq, and, gte } = await import(\"drizzle-orm\");\n                const { db } = await import(\"./db.js\");\n                const { agentPlaybookOutcomes, agentPlaybookLearnings } = await import(\"@shared/schema\");\n                const { z } = await import(\"zod\");\n\n                const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });\n                const corePrompt = await getCoreSystemPrompt();\n                const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);\n\n                const outcomes = await db\n                    .select()\n                    .from(agentPlaybookOutcomes)\n                    .where(\n                        and(\n                            eq(agentPlaybookOutcomes.tenantId, tenantId),\n                            gte(agentPlaybookOutcomes.recordedAt, ninetyDaysAgo),\n                        ),\n                    )\n                    .limit(200);\n\n                if (outcomes.length === 0) {\n                    log(\"[synthesize-learnings] No outcomes in past 90 days, skipping.\", \"cron\");\n                    return;\n                }\n\n                const outcomeSummary = outcomes\n                    .map((o) => `type=${o.outcomeType} score=${o.outcomeScore ?? \"?\"} notes=${o.repNotes ?? \"\"}`)\n                    .join(\"\\n\");\n\n                const LearningsSchema = z.object({\n                    learnings: z.array(z.object({\n                        learning: z.string().max(500),\n                        evidence_count: z.number().int().min(1),\n                        success_rate: z.number().min(0).max(1).nullable(),\n                        recommended_for_segments: z.array(z.string()).max(5),\n                    })).max(10),\n                    agent_memo: z.object({\n                        last_run_summary: z.string(),\n                        current_focus: z.string(),\n                        pattern_notes_addition: z.string(),\n                        anomalies_watching: z.array(z.object({\n                            account_name: z.string(),\n                            signal: z.string(),\n                            watch_until_date: z.string(),\n                        })),\n                    }),\n                });\n\n                const completion = await openai.chat.completions.create({\n                    model: \"gpt-4o\",\n                    messages: [\n                        { role: \"system\", content: corePrompt },\n                        {\n                            role: \"user\",\n                            content: `Analyze these 90-day playbook outcomes and distill the top cross-account learnings:\\n\\n${outcomeSummary}\\n\\nReturn JSON matching this schema exactly. Focus on patterns that predict success.`,\n                        },\n                    ],\n                    response_format: { type: \"json_object\" },\n                    temperature: 0.3,\n                });\n\n                const raw = JSON.parse(completion.choices[0].message.content ?? \"{}\");\n                const parsed = LearningsSchema.parse(raw);\n\n                // Insert new learnings\n                for (const l of parsed.learnings) {\n                    await db.insert(agentPlaybookLearnings).values({\n                        tenantId,\n                        learning: l.learning,\n                        evidenceCount: l.evidence_count,\n                        successRate: String(l.success_rate ?? \"\"),\n                        recommendedForSegments: l.recommended_for_segments,\n                        isActive: true,\n                    });\n                }\n\n                await writeAgentMemo(tenantId, \"synthesize-learnings\", parsed.agent_memo);\n                log(`[synthesize-learnings] Inserted ${parsed.learnings.length} learnings.`, \"cron\");\n            } catch (err: any) {\n                log(`[synthesize-learnings] Error: ${err?.message ?? err}`, \"cron\");\n            }\n        },\n        { timezone: \"America/New_York\", name: \"synthesize-learnings\" },\n    );\n\n    // â”€â”€ 4. Refresh Embeddings â€” Sundays at 2:00am EST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    cron.schedule(\n        \"0 2 * * 0\",\n        async () => {\n            const refreshAllEmbeddings = await getEmbeddingService();\n            safeRun(\"refresh-embeddings\", () => refreshAllEmbeddings(tenantId));\n        },\n        { timezone: \"America/New_York\", name: \"refresh-embeddings\" },\n    );\n\n    // â”€â”€ 5. Refresh Similar Pairs â€” Sundays at 3:00am EST (after embeddings) â”€â”€â”€â”€\n    cron.schedule(\n        \"0 3 * * 0\",\n        async () => {\n            try {\n                const { db } = await import(\"./db.js\");\n                const { accounts } = await import(\"@shared/schema\");\n                const { eq } = await import(\"drizzle-orm\");\n                const { findSimilarAccounts } = await import(\"./services/account-embedding.js\");\n\n                const enrolledAccounts = await db\n                    .select({ id: accounts.id })\n                    .from(accounts)\n                    .where(eq(accounts.tenantId, tenantId));\n\n                let processed = 0;\n                for (const acc of enrolledAccounts) {\n                    try {\n                        await findSimilarAccounts(acc.id, tenantId);\n                        processed++;\n                    } catch {\n                        // continue if one account fails\n                    }\n                }\n                log(`[refresh-similar-pairs] Processed ${processed}/${enrolledAccounts.length} accounts.`, \"cron\");\n            } catch (err: any) {\n                log(`[refresh-similar-pairs] Error: ${err?.message ?? err}`, \"cron\");\n            }\n        },\n        { timezone: \"America/New_York\", name: \"refresh-similar-pairs\" },\n    );\n\n    // â”€â”€ 6. Daily Digest â€” weekdays at 7:30am EST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    cron.schedule(\n        \"30 7 * * 1-5\",\n        async () => {\n            const sendDailyDigest = await getDailyDigestService();\n            safeRun(\"daily-digest\", () => sendDailyDigest(tenantId));\n        },\n        { timezone: \"America/New_York\", name: \"daily-digest\" },\n    );\n\n    // â”€â”€ 7. CRM Sync Retry â€” every 4 hours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n    cron.schedule(\n        \"0 */4 * * *\",\n        async () => {\n            const processCrmSyncQueue = await getCrmSyncService();\n            safeRun(\"crm-sync-retry\", () => processCrmSyncQueue(tenantId));\n        },\n        { timezone: \"America/New_York\", name: \"crm-sync-retry\" },\n    );\n\n    const scheduled = cron.getTasks();\n    log(`[scheduler] ${scheduled.size} cron jobs registered.`, \"cron\");\n}\n\n/**\n * stopScheduler â€” gracefully stops all cron tasks.\n * Call during process SIGTERM / SIGINT cleanup.\n */\nexport function stopScheduler(): void {\n    const tasks = cron.getTasks();\n    tasks.forEach((task) => task.stop());\n    log(`[scheduler] All ${tasks.size} cron jobs stopped.`, \"cron\");\n}\n","path":null,"size_bytes":10776,"size_tokens":null},"server/middleware/tenantContext.ts":{"content":"import type { Request, Response, NextFunction, RequestHandler } from \"express\";\nimport { db } from \"../db\";\nimport { tenants, userRoles, type Tenant, type UserRole, type RoleType, ROLE_PERMISSIONS } from \"@shared/schema\";\nimport { eq, and } from \"drizzle-orm\";\n\nimport \"../types/express.d\";\n\nexport interface TenantContext {\n  tenantId: number;\n  tenant: Tenant;\n  role: RoleType;\n  userId: string;\n}\n\nexport async function getTenantForUser(userId: string): Promise<{ tenant: Tenant; role: UserRole } | null> {\n  const userRoleRecord = await db.select()\n    .from(userRoles)\n    .where(eq(userRoles.userId, userId))\n    .limit(1);\n\n  if (userRoleRecord.length === 0) {\n    return null;\n  }\n\n  const role = userRoleRecord[0];\n  const tenantRecord = await db.select()\n    .from(tenants)\n    .where(eq(tenants.id, role.tenantId))\n    .limit(1);\n\n  if (tenantRecord.length === 0) {\n    return null;\n  }\n\n  return { tenant: tenantRecord[0], role };\n}\n\nexport async function createTenantForUser(userId: string, email: string): Promise<{ tenant: Tenant; role: UserRole }> {\n  const slug = email.split(\"@\")[0].toLowerCase().replace(/[^a-z0-9]/g, \"-\") + \"-\" + Date.now();\n  const name = email.split(\"@\")[0];\n\n  const [newTenant] = await db.insert(tenants)\n    .values({ name, slug })\n    .returning();\n\n  const [newRole] = await db.insert(userRoles)\n    .values({\n      userId,\n      tenantId: newTenant.id,\n      role: \"super_admin\",\n    })\n    .returning();\n\n  return { tenant: newTenant, role: newRole };\n}\n\nexport const withTenantContext: RequestHandler = async (req: Request, res: Response, next: NextFunction) => {\n  const user = req.user;\n\n  if (!user?.claims?.sub) {\n    return res.status(401).json({ message: \"Unauthorized - no user context\" });\n  }\n\n  const userId = user.claims.sub;\n  const email = user.claims.email || \"unknown@example.com\";\n\n  let tenantData = await getTenantForUser(userId);\n\n  if (!tenantData) {\n    tenantData = await createTenantForUser(userId, email);\n  }\n\n  req.tenantContext = {\n    tenantId: tenantData.tenant.id,\n    tenant: tenantData.tenant,\n    role: tenantData.role.role as RoleType,\n    userId,\n  };\n\n  next();\n};\n\nexport function requireRole(...allowedRoles: RoleType[]): RequestHandler {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.tenantContext) {\n      return res.status(401).json({ message: \"Unauthorized - no tenant context\" });\n    }\n\n    if (!allowedRoles.includes(req.tenantContext.role)) {\n      return res.status(403).json({ message: \"Forbidden - insufficient permissions\" });\n    }\n\n    next();\n  };\n}\n\nexport function hasPermission(role: RoleType, permission: string): boolean {\n  const permissions = ROLE_PERMISSIONS[role];\n  return permissions.includes(permission as any);\n}\n\nexport const requirePermission = (permission: string): RequestHandler => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.tenantContext) {\n      return res.status(401).json({ message: \"Unauthorized - no tenant context\" });\n    }\n\n    if (!hasPermission(req.tenantContext.role, permission)) {\n      return res.status(403).json({ message: \"Forbidden - insufficient permissions\" });\n    }\n\n    next();\n  };\n};\n","path":null,"size_bytes":3196,"size_tokens":null},"client/src/components/info-tooltip.tsx":{"content":"import { HelpCircle } from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface InfoTooltipProps {\n  content: string;\n  testId?: string;\n}\n\nexport function InfoTooltip({ content, testId }: InfoTooltipProps) {\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>\n        <button\n          className=\"text-muted-foreground hover:text-foreground transition-colors\"\n          data-testid={testId}\n        >\n          <HelpCircle className=\"h-4 w-4\" />\n        </button>\n      </TooltipTrigger>\n      <TooltipContent className=\"max-w-xs\">\n        <p className=\"text-sm\">{content}</p>\n      </TooltipContent>\n    </Tooltip>\n  );\n}\n","path":null,"size_bytes":692,"size_tokens":null},"client/src/components/dashboard-block.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { GripVertical } from \"lucide-react\";\nimport type { DraggableProvided } from \"@hello-pangea/dnd\";\n\ninterface DashboardBlockProps {\n  id: string;\n  title: string;\n  subtitle?: string;\n  headerAction?: React.ReactNode;\n  headerTooltip?: React.ReactNode;\n  children: React.ReactNode;\n  className?: string;\n  provided: DraggableProvided;\n  isDragging?: boolean;\n  testId?: string;\n}\n\nexport function DashboardBlock({\n  id,\n  title,\n  subtitle,\n  headerAction,\n  headerTooltip,\n  children,\n  className = \"\",\n  provided,\n  isDragging,\n  testId,\n}: DashboardBlockProps) {\n  return (\n    <Card\n      ref={provided.innerRef}\n      {...provided.draggableProps}\n      className={`${className} ${isDragging ? \"ring-2 ring-primary shadow-lg\" : \"\"}`}\n      data-testid={testId || `dashboard-block-${id}`}\n    >\n      <CardHeader className=\"flex flex-row items-center justify-between gap-2 pb-3\">\n        <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n          <div\n            {...provided.dragHandleProps}\n            className=\"flex items-center justify-center h-8 w-8 rounded-md cursor-grab active:cursor-grabbing hover-elevate text-muted-foreground hover:text-foreground\"\n            data-testid={`drag-handle-${id}`}\n          >\n            <GripVertical className=\"h-4 w-4\" />\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2\">\n              <CardTitle className=\"text-base\">{title}</CardTitle>\n              {headerTooltip}\n            </div>\n            {subtitle && (\n              <p className=\"text-sm text-muted-foreground\">{subtitle}</p>\n            )}\n          </div>\n        </div>\n        {headerAction}\n      </CardHeader>\n      <CardContent>{children}</CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/email-composer-modal.tsx":{"content":"/**\n * EmailComposerModal â€” Phase 4\n *\n * Modal triggered from AccountDossierPanel's \"Send Email\" button.\n * Pre-populated with email_subject + email_draft from the active playbook.\n * Copy-only: opens the user's own email client via mailto or copies to clipboard.\n * Logs an agent_interactions row for tracking â€” does NOT send email through Resend.\n */\n\nimport { useState } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport {\n    Dialog,\n    DialogContent,\n    DialogHeader,\n    DialogTitle,\n    DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Send, Copy, Lightbulb, CheckCircle, ExternalLink } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface EmailComposerModalProps {\n    open: boolean;\n    onClose: () => void;\n    accountId: number;\n    accountName: string;\n    emailSubject: string;\n    emailDraft: string;\n    personalizationNotes?: string;\n}\n\nexport function EmailComposerModal({\n    open,\n    onClose,\n    accountId,\n    accountName,\n    emailSubject,\n    emailDraft,\n    personalizationNotes,\n}: EmailComposerModalProps) {\n    const { toast } = useToast();\n    const queryClient = useQueryClient();\n    const [subject, setSubject] = useState(emailSubject);\n    const [body, setBody] = useState(emailDraft);\n    const [copied, setCopied] = useState(false);\n    const [followUpDate, setFollowUpDate] = useState(\"\");\n\n    const sendMutation = useMutation({\n        mutationFn: async () => {\n            // 1. Create an interaction row (this also triggers email-intelligence automatically)\n            await apiRequest(\"POST\", \"/api/agent/interactions\", {\n                accountId,\n                interactionType: \"email\",\n                source: \"rep_entered\",\n                subject,\n                body,\n                followUpDate: followUpDate || null,\n            });\n        },\n        onSuccess: () => {\n            toast({ title: \"Email logged!\", description: \"Interaction recorded. Don't forget to send in your email client.\" });\n            queryClient.invalidateQueries({ queryKey: [`/api/agent/account-context/${accountId}`] });\n            onClose();\n        },\n        onError: () => toast({ title: \"Error\", description: \"Failed to log email.\", variant: \"destructive\" }),\n    });\n\n    function handleCopy() {\n        navigator.clipboard.writeText(body);\n        setCopied(true);\n        setTimeout(() => setCopied(false), 2000);\n        toast({ title: \"Copied to clipboard!\" });\n    }\n\n    // Auto-reload subject/body when modal opens with new content\n    const handleOpenChange = (o: boolean) => {\n        if (o) {\n            setSubject(emailSubject);\n            setBody(emailDraft);\n            setFollowUpDate(\"\");\n        }\n        if (!o) onClose();\n    };\n\n    return (\n        <Dialog open={open} onOpenChange={handleOpenChange}>\n            <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\" id=\"email-composer-modal\">\n                <DialogHeader>\n                    <DialogTitle className=\"flex items-center gap-2\">\n                        <Send className=\"h-4 w-4 text-primary\" />\n                        Email Composer\n                        <Badge variant=\"outline\" className=\"ml-1 text-xs font-normal\">{accountName}</Badge>\n                    </DialogTitle>\n                </DialogHeader>\n\n                <div className=\"space-y-4\">\n                    {/* Personalization notes */}\n                    {personalizationNotes && (\n                        <div className=\"flex items-start gap-2 p-3 rounded-lg bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-900/50\">\n                            <Lightbulb className=\"h-4 w-4 text-amber-600 mt-0.5 shrink-0\" />\n                            <div>\n                                <p className=\"text-xs font-semibold text-amber-700 dark:text-amber-400 mb-0.5\">Personalization Notes</p>\n                                <p className=\"text-xs text-amber-800 dark:text-amber-300 italic leading-relaxed\">{personalizationNotes}</p>\n                            </div>\n                        </div>\n                    )}\n\n                    {/* Subject */}\n                    <div className=\"space-y-1.5\">\n                        <Label htmlFor=\"email-subject\" className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\n                            Subject\n                        </Label>\n                        <Input\n                            id=\"email-subject\"\n                            value={subject}\n                            onChange={(e) => setSubject(e.target.value)}\n                            placeholder=\"Email subject...\"\n                            className=\"text-sm\"\n                        />\n                    </div>\n\n                    {/* Body */}\n                    <div className=\"space-y-1.5\">\n                        <Label htmlFor=\"email-body\" className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\n                            Email Body\n                        </Label>\n                        <Textarea\n                            id=\"email-body\"\n                            value={body}\n                            onChange={(e) => setBody(e.target.value)}\n                            rows={12}\n                            className=\"text-sm font-mono resize-none leading-relaxed\"\n                            placeholder=\"Email body...\"\n                        />\n                    </div>\n\n                    {/* Follow-up reminder */}\n                    <div className=\"space-y-1.5\">\n                        <Label htmlFor=\"follow-up-date\" className=\"text-xs font-semibold uppercase tracking-wide text-muted-foreground\">\n                            Follow-up Reminder (optional)\n                        </Label>\n                        <Input\n                            id=\"follow-up-date\"\n                            type=\"date\"\n                            value={followUpDate}\n                            onChange={(e) => setFollowUpDate(e.target.value)}\n                            className=\"text-sm w-48\"\n                        />\n                    </div>\n                </div>\n\n                <DialogFooter className=\"gap-2 mt-2\">\n                    <Button variant=\"outline\" size=\"sm\" onClick={handleCopy} className=\"mr-auto\">\n                        {copied ? (\n                            <><CheckCircle className=\"h-3.5 w-3.5 mr-1.5 text-green-500\" />Copied!</>\n                        ) : (\n                            <><Copy className=\"h-3.5 w-3.5 mr-1.5\" />Copy to Clipboard</>\n                        )}\n                    </Button>\n                    <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => {\n                            navigator.clipboard.writeText(body).catch(() => {});\n                            const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n                            window.open(mailto, \"_blank\");\n                            toast({ title: \"Email content copied\", description: \"Your email client is opening with the draft pre-filled.\" });\n                        }}\n                        disabled={!subject.trim() || !body.trim()}\n                        data-testid=\"button-send-from-email\"\n                    >\n                        <ExternalLink className=\"h-3.5 w-3.5 mr-1.5\" />\n                        Send from Email\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={onClose}>Cancel</Button>\n                    <Button\n                        size=\"sm\"\n                        onClick={() => sendMutation.mutate()}\n                        disabled={sendMutation.isPending || !subject.trim() || !body.trim()}\n                        className=\"gap-1.5\"\n                    >\n                        <Send className=\"h-3.5 w-3.5\" />\n                        {sendMutation.isPending ? \"Logging...\" : \"Log & Confirm Sent\"}\n                    </Button>\n                </DialogFooter>\n            </DialogContent>\n        </Dialog>\n    );\n}\n","path":null,"size_bytes":8457,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","path":null,"size_bytes":1904,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"marketing-detail.md":{"content":"# Wallet Share Expander - Marketing Pitch Plan\n\n## Document Purpose\nThis comprehensive marketing brief is designed for agency partners to understand the full value proposition, messaging strategy, and positioning of Wallet Share Expander. It includes all website content plus supplementary materials that provide deeper context for campaign development.\n\n---\n\n## Executive Summary\n\n**Wallet Share Expander** is an AI-powered sales intelligence platform that helps B2B distributors and manufacturers find, grow, and maximize revenue from their existing customer base. Unlike traditional CRM or sales tools that focus on new customer acquisition, we specialize in expanding wallet share within accounts you already have.\n\n**The Core Promise:** When you enroll an account in our system, it is *guaranteed to grow* through customized AI-generated playbooks that guide your sales team to capture missed revenue opportunities.\n\n**Key Differentiator:** We don't replace human relationshipsâ€”we enhance them. AI does the analysis and preparation; your team builds the trust that closes deals.\n\n---\n\n## Target Audience\n\n### Primary: VP of Sales / Sales Directors\n- **Company Size:** Mid-market to enterprise B2B distributors ($50M-$500M revenue)\n- **Industry Focus:** Industrial supply, building materials, HVAC/plumbing, electrical, MRO\n- **Pain Points:**\n  - Reps focus on easy accounts, not high-potential ones\n  - No visibility into wallet share opportunity\n  - Inconsistent follow-up and account development\n  - Difficulty proving ROI of sales initiatives\n  - Customer data exists but isn't actionable\n\n### Secondary: Territory Managers / Account Executives\n- **Role:** End users who execute the playbooks\n- **Pain Points:**\n  - Don't know which accounts to prioritize\n  - Struggle to prepare for customer conversations\n  - No clear guidance on what to sell to whom\n  - Overwhelmed by number of accounts to manage\n\n### Tertiary: C-Suite / Revenue Leadership\n- **Role:** Budget holders and strategic decision makers\n- **Pain Points:**\n  - Want predictable revenue growth from existing base\n  - Need proof of ROI before investing in new tools\n  - Concerned about adoption and change management\n\n---\n\n## Core Messaging Pillars\n\n### 1. Find Your Hidden Revenue Goldmines\nYour existing customers hold untapped potential. Our AI analyzes your entire customer base to surface the accounts with the highest wallet share growth opportunityâ€”accounts your team might be overlooking.\n\n**Supporting Messages:**\n- Stop guessing which customers deserve more attention\n- Proprietary scoring reveals hidden opportunities\n- Focus your best reps on the accounts most likely to grow\n- Data becomes a strategic advantage\n\n### 2. Guaranteed Growth Through Enrollment\nWhen you enroll an account, you're not hoping for growthâ€”you're activating a proven system. Every enrolled account receives a customized action plan designed to expand their wallet share.\n\n**Supporting Messages:**\n- Enrollment is a commitmentâ€”and so is our system\n- Personalized growth roadmaps, not generic playbooks\n- Clear milestones and graduation targets\n- 94% of enrolled accounts graduate successfully\n\n### 3. AI Enhances Human Relationships\nWe don't replace your sales teamâ€”we supercharge them. AI handles the analysis, preparation, and script generation. Your people bring the relationship expertise that closes deals.\n\n**Supporting Messages:**\n- AI prepares, humans connect\n- Every touchpoint is informed by data\n- Customized talking points for each account's unique gaps\n- Your team gains confidence, not a replacement\n\n### 4. Prove ROI with Transparent Tracking\nTrack incremental revenue from enrollment through graduation. Show leadership exactly how your program is driving growth with clear attribution and executive-ready reports.\n\n**Supporting Messages:**\n- Baseline-to-current revenue comparison\n- Attribute growth to specific actions\n- Celebrate Territory Manager wins\n- No more faith-based forecasting\n\n---\n\n## Feature Benefits (Expanded)\n\n### 1. Smart Account Discovery\n**What It Does:** AI analyzes your entire customer base to identify accounts with the highest untapped wallet share potential.\n\n**Website Copy:**\n> Find Your Highest-Potential Accounts Instantly\n\n**Expanded Messaging for Campaigns:**\n- \"Your data already knows which accounts should be buying more. We help you see it.\"\n- \"Stop spreading your team thin. Focus where growth is guaranteed.\"\n- \"The accounts with the most potential are often hiding in plain sight.\"\n\n**Proof Points:**\n- AI evaluates 50+ signals per account\n- Scoring updated in real-time as purchasing patterns change\n- Accounts ranked by growth potential, not just current spend\n\n---\n\n### 2. Guaranteed Growth Pipeline\n**What It Does:** Enrolled accounts receive customized growth plans with clear milestones and graduation targets.\n\n**Website Copy:**\n> Every Enrolled Account Gets a Customized Growth Plan\n\n**Expanded Messaging for Campaigns:**\n- \"Enrollment isn't a wishâ€”it's a system.\"\n- \"We don't just identify opportunity. We engineer the path to capture it.\"\n- \"When an account enters the program, growth isn't optional.\"\n\n**Proof Points:**\n- 94% of enrolled accounts hit graduation targets\n- Average time to graduation: 90 days\n- 32% average wallet share increase\n\n---\n\n### 3. AI-Powered Wallet Analysis\n**What It Does:** Compares each account's purchases against their full potential, revealing exactly which product categories are under-penetrated.\n\n**Website Copy:**\n> See Exactly Where Each Account Can Grow\n\n**Expanded Messaging for Campaigns:**\n- \"Know the exact dollar amount you're leaving on the tableâ€”by category.\"\n- \"Your competitors aren't just selling to new customers. They're stealing wallet share from yours.\"\n- \"Turn data into conversations. Turn conversations into revenue.\"\n\n**Proof Points:**\n- Category-level gap analysis with dollar values\n- Benchmarks derived from your own top-performing accounts\n- Prioritized recommendations for maximum impact\n\n---\n\n### 4. Intelligent Benchmarking (ICP Builder)\n**What It Does:** Studies your best-performing customers to build Ideal Customer Profiles that show what full wallet share looks like in each segment.\n\n**Website Copy:**\n> Learn from Your Best to Grow the Rest\n\n**Expanded Messaging for Campaigns:**\n- \"Your top customers leave clues. AI decodes them.\"\n- \"Segment-specific success patterns you can replicate at scale.\"\n- \"Stop guessing what 'good' looks like. Let your data define it.\"\n\n**Proof Points:**\n- Profiles generated from actual customer behavior\n- Continuously refined as your customer base evolves\n- Benchmarks that your team can actually use\n\n---\n\n### 5. Revenue Growth Attribution\n**What It Does:** Tracks incremental revenue from the moment of enrollment through graduation, with clear attribution to specific actions.\n\n**Website Copy:**\n> Measure the Revenue Impact of Every Relationship\n\n**Expanded Messaging for Campaigns:**\n- \"Finallyâ€”proof that your sales efforts are working.\"\n- \"Leadership wants numbers. We give you irrefutable attribution.\"\n- \"Celebrate wins. Quantify success. Justify your investment.\"\n\n**Proof Points:**\n- Real-time revenue tracking from day one\n- Executive dashboards with ROI calculations\n- Attribution to playbook actions and touchpoints\n\n---\n\n### 6. AI-Customized Playbooks\n**What It Does:** Generates personalized action plans for each enrolled account with scripts, email templates, and talking points tailored to their specific gaps.\n\n**Website Copy:**\n> Customized Playbooks That Empower Your Sales Team\n\n**Expanded Messaging for Campaigns:**\n- \"Every account conversation, perfectly prepared.\"\n- \"AI writes the script. Your team delivers the relationship.\"\n- \"No more generic pitches. Every touchpoint is tailored.\"\n\n**Proof Points:**\n- Scripts address specific product gaps per account\n- Suggested timing and channel for each touchpoint\n- Templates designed for personalization, not automation\n\n---\n\n## The Growth Guarantee\n\nThis is our most compelling differentiator and should be featured prominently in all marketing.\n\n### The Promise\nWhen you enroll an account in Wallet Share Expander, it is guaranteed to grow. Our system combines AI-powered analysis with structured human follow-up to ensure every enrolled account progresses toward higher wallet share.\n\n### The Process\n1. **AI Finds Potential** - Surface accounts with the highest wallet share growth opportunity\n2. **You Enroll** - Commit to growing the account with a customized action plan\n3. **AI Personalizes** - Custom playbook with scripts and actions tailored to their gaps\n4. **Revenue Grows** - Track incremental revenue as the account hits growth milestones\n\n### The Proof\n- **94%** of enrolled accounts achieve their revenue growth targets\n- **32%** average wallet share increase for enrolled accounts\n- **90 Days** average time for enrolled accounts to show measurable growth\n- **4.1x** ROI in the first year\n\n### Messaging Angles\n- \"Enrollment is a commitment. Growth is the guarantee.\"\n- \"We don't hope accounts will grow. We engineer it.\"\n- \"94% graduate. That's not a goalâ€”it's a track record.\"\n\n---\n\n## Account Graduation System\n\nThe graduation system provides complete visibility into wallet share capture from enrollment to successful completion. This is a key differentiator that proves ROI and celebrates Territory Manager success.\n\n### Graduation Tracking Metrics\n\nEach enrolled account tracks comprehensive data throughout its lifecycle:\n\n| Metric | Description |\n|--------|-------------|\n| **Baseline Revenue** | Account's revenue at the time of enrollment (annualized or period-specific) |\n| **Baseline Period Days** | The time period used to calculate baseline revenue for pro-rating |\n| **Graduation Revenue** | Cumulative revenue earned during the enrollment period |\n| **Incremental Revenue** | Growth above pro-rated baseline (graduation revenue minus pro-rated baseline) |\n| **Enrollment Duration** | Days from enrollment to graduation |\n| **ICP Categories at Enrollment** | Missing ICP categories (gaps) at enrollment time |\n| **ICP Categories Achieved** | Number of gaps successfully filled during enrollment |\n\n### Revenue Attribution Logic\n\n**Pro-Rated Baseline Comparison:**\nRevenue metrics use a pro-rated baseline for fair comparison. The formula:\n\n```\nIncremental Revenue = Graduation Revenue - (Baseline Revenue Ã— Enrollment Duration / Baseline Period Days)\n```\n\nThis ensures that accounts enrolled for different time periods are compared fairly. For example, if an account had $120K baseline over 365 days and was enrolled for 90 days:\n- Pro-rated baseline: $120K Ã— (90/365) = $29,589\n- If graduation revenue is $45K, incremental revenue is $15,411\n\n### Graduation Analytics Dashboard\n\nThe system provides executive-level analytics:\n\n| KPI | What It Shows |\n|-----|---------------|\n| **Total Graduated** | Count of accounts that successfully completed the program |\n| **Cumulative Revenue Growth** | Sum of all incremental revenue from graduated accounts |\n| **Avg Days to Graduation** | Average enrollment duration showing time-to-results |\n| **Avg Revenue Growth** | Average incremental revenue per graduated account |\n| **Avg ICP Category Success Rate** | Percentage of identified gaps that were successfully filled |\n\n### The Alumni Section\n\nGraduated accounts move to a permanent Alumni section that serves as:\n\n1. **Success Scoreboard** â€” Proof that your wallet share expansion strategy works\n2. **Best Practice Library** â€” See which approaches drove the most growth\n3. **ROI Documentation** â€” Executive-ready evidence of program impact\n4. **Territory Manager Recognition** â€” Celebrate individual rep achievements\n\n### Messaging for Graduation Visibility\n\n**Campaign Angles:**\n- \"From Enrollment to Graduation: Track Every Dollar of Growth\"\n- \"Your Alumni Section Is Your Success Scoreboard\"\n- \"See Exactly How Much Wallet Share You've Captured\"\n- \"No More Black Box Sales Programsâ€”Complete Visibility from Day One\"\n\n**Proof Points for Sales:**\n- Every account has a clear enrollment-to-graduation journey with full revenue attribution\n- Pro-rated baselines ensure fair, accurate measurement regardless of enrollment timing\n- ICP category success rates prove the AI recommendations are working\n- Alumni records provide historical proof of program effectiveness\n\n### Integration with Territory Manager Performance\n\nGraduation metrics tie directly to Territory Manager performance tracking:\n- Revenue growth credited to assigned TM\n- Graduation velocity (days to completion) benchmarked across team\n- Category success rates identify TM strengths and development opportunities\n- Alumni achievements create recognition moments\n\n---\n\n## Competitive Differentiation\n\n### vs. Traditional CRM (Salesforce, HubSpot)\n- CRMs track activity. We drive outcomes.\n- CRMs are reactive. We're proactive with AI-recommended actions.\n- CRMs require reps to know what to do. We tell them exactly what to say.\n\n### vs. Generic Sales Intelligence (ZoomInfo, Apollo)\n- They focus on new customer acquisition. We maximize existing relationships.\n- They provide contact data. We provide growth strategies.\n- They're about prospecting. We're about wallet share expansion.\n\n### vs. Revenue Intelligence (Gong, Clari)\n- They analyze calls after they happen. We prepare reps before the call.\n- They're about understanding. We're about action.\n- They track what was said. We guide what should be said next.\n\n### vs. DIY/Excel Analysis\n- Spreadsheets can't generate personalized playbooks\n- Manual analysis doesn't scale across hundreds of accounts\n- Excel can't track incremental revenue attribution\n\n---\n\n## Use Cases & Scenarios\n\n### Scenario 1: The Overlooked Large Account\n**Situation:** ABC Plumbing is a $2M account but only buys from 3 of your 12 product categories.\n**Without WSE:** Rep doesn't realize the gap; account stays flat\n**With WSE:** AI identifies $800K opportunity, enrolls account, generates playbook targeting HVAC and tools categories. Account graduates 90 days later at $2.6M run rate.\n\n### Scenario 2: The Rep Capacity Problem\n**Situation:** Your territory managers each have 200+ accounts but can only meaningfully engage with 30.\n**Without WSE:** Reps focus on loudest accounts, not best opportunities\n**With WSE:** AI prioritizes the 15 accounts with highest growth potential. Reps enroll strategically and execute customized playbooks. Average wallet share increase: 32%.\n\n### Scenario 3: The New Rep Onboarding\n**Situation:** New rep takes over territory with no context on which accounts to prioritize.\n**Without WSE:** 6-month ramp time while rep \"figures out\" the territory\n**With WSE:** Day one, rep sees prioritized account list with opportunity scores. Week one, rep is executing AI-generated playbooks. Ramp time cut in half.\n\n---\n\n## Objection Handling\n\n### \"We already have a CRM\"\n*Response:* CRMs track what happened. We tell you what to do next. Wallet Share Expander integrates with your CRM and adds a layer of AI-powered guidance that transforms activity tracking into revenue growth.\n\n### \"Our reps know their accounts\"\n*Response:* Your reps know their relationships. But do they know which accounts have a 40% wallet share gap in a category they've never discussed? AI sees patterns humans miss. We enhance rep expertise with data-driven insights.\n\n### \"We tried something similar and it didn't work\"\n*Response:* Generic sales tools fail because they're not specific enough. Every playbook we generate is customized to that account's gaps, that segment's benchmarks, and that rep's territory. That's why 94% of enrolled accounts graduate.\n\n### \"What if it doesn't work for us?\"\n*Response:* Start with a pilot. Enroll 20 accounts. If 90%+ don't show measurable growth in 90 days, we've failed. Our track record says otherwiseâ€”but let's prove it with your data.\n\n### \"How long until we see ROI?\"\n*Response:* Enrolled accounts typically show measurable growth within 90 days. Most customers see positive ROI within 6 months, with 4.1x average return in the first year.\n\n---\n\n## Taglines & Headlines\n\n### Primary Tagline Options\n1. \"Find. Enroll. Grow. Guaranteed.\"\n2. \"Your Accounts. Unlimited Potential.\"\n3. \"AI-Powered Growth for Human Relationships\"\n4. \"Wallet Share Expansion, Engineered\"\n5. \"When You Enroll, They Grow\"\n\n### Hero Headlines\n- \"Find and Grow Your Highest-Potential Accounts\"\n- \"Guaranteed Growth for Every Enrolled Account\"\n- \"Your Existing Customers Are Sitting on Untapped Revenue\"\n- \"AI That Enhances Human Relationships, Not Replaces Them\"\n\n### Supporting Headlines\n- \"Stop Hoping. Start Growing.\"\n- \"94% of Enrolled Accounts Hit Their Growth Targets\"\n- \"The Accounts You're Overlooking Are Your Biggest Opportunity\"\n- \"Every Conversation, Perfectly Prepared\"\n\n---\n\n## Brand Voice Guidelines\n\n### Tone\n- **Confident but not arrogant** â€” We have a track record, but we let the numbers speak\n- **Direct and actionable** â€” Clear language, no jargon\n- **Empowering, not replacing** â€” AI enhances humans, not replaces them\n- **Results-focused** â€” Every message ties back to growth\n\n### Words We Use\n- Enroll (not \"sign up\" â€” enrollment is intentional)\n- Graduate (accounts achieve success, not just close)\n- Wallet share (specific to our value prop)\n- Customized/Personalized (AI tailors, not automates)\n- Guaranteed (bold, but backed by data)\n\n### Words We Avoid\n- Replace / Automate (we enhance humans)\n- Leads / Prospects (we focus on existing customers)\n- Cold outreach (we warm up warm relationships)\n- Generic / Template (everything is customized)\n\n---\n\n## Call to Action Hierarchy\n\n### Primary CTA\n\"Start Free Trial\" â€” Low commitment, immediate access\n\n### Secondary CTA\n\"See How It Works\" â€” Educational journey for research phase\n\n### Tertiary CTA\n\"Schedule a Demo\" â€” For larger deals or hands-on prospects\n\n---\n\n## Statistics for Marketing Use\n\n| Metric | Value | Context |\n|--------|-------|---------|\n| Enrolled Account Graduation Rate | 94% | Accounts that hit revenue targets |\n| Average Wallet Share Increase | 32% | For enrolled accounts |\n| Time to Results | 90 Days | Average for measurable growth |\n| First Year ROI | 4.1x | Customer average |\n| Account Analysis Speed | 47% Faster | vs. manual methods |\n| Customer Retention | 94% | Annual renewal rate |\n\n---\n\n## Visual Direction Suggestions\n\n### Screenshot Imagery\n- Dashboard with KPIs and account lists\n- Gap analysis with category bars\n- Playbook interface with scripts and tasks\n- Revenue tracking with growth charts\n\n### Iconography Themes\n- Target/bullseye (discovery/focus)\n- Checkmark in circle (enrollment/guarantee)\n- Trending up arrow (growth)\n- Users/handshake (human relationships)\n- Sparkles (AI magic)\n\n### Color Associations\n- Teal/Blue â€” Trust, intelligence, technology\n- Green â€” Growth, success, money\n- White â€” Clean, professional, clarity\n\n---\n\n## Campaign Concepts for Agency\n\n### Concept 1: \"The Hidden Revenue Campaign\"\n**Theme:** Your existing customers are hiding revenue opportunities. We find them.\n**Angle:** Discovery and revelation\n**Assets:** Before/after data visualizations, account spotlight stories\n\n### Concept 2: \"Enrollment = Guarantee Campaign\"\n**Theme:** When you commit to an account, so do we. 94% graduate.\n**Angle:** Confidence and commitment\n**Assets:** Graduation success stories, rep testimonials\n\n### Concept 3: \"AI + Human = Growth Campaign\"\n**Theme:** AI prepares. Humans connect. Revenue grows.\n**Angle:** Partnership between technology and people\n**Assets:** Side-by-side comparisons, day-in-the-life scenarios\n\n### Concept 4: \"Prove It Campaign\"\n**Theme:** Start with 20 accounts. See the results. Then scale.\n**Angle:** Low-risk pilot, data-backed confidence\n**Assets:** Pilot program offers, ROI calculator, case studies\n\n---\n\n## Next Steps for Agency\n\n1. **Brand Review:** Align on visual identity and tone\n2. **Audience Validation:** Confirm target personas and pain points\n3. **Asset Development:** Create campaign-ready copy and visuals\n4. **Channel Strategy:** Determine primary distribution (LinkedIn, email, paid, content)\n5. **Measurement Framework:** Define success metrics and tracking\n\n---\n\n## Contact\n\nFor questions about this brief or access to additional materials:\n- Product Marketing: [Internal Contact]\n- Sales Leadership: [Internal Contact]\n- Brand Assets: [Link to asset library]\n\n---\n\n*Document Version: 1.0*\n*Last Updated: January 2026*\n*Powered by Tenexity*\n","path":null,"size_bytes":20424,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/replit_integrations/audio/audio-playback-worklet.js":{"content":"/**\n * Reusable AudioWorklet for streaming PCM16 audio playback.\n * Place in public/ folder and load via audioContext.audioWorklet.addModule()\n */\nclass RingBuffer {\n  constructor(initialCapacity) {\n    this.capacity = initialCapacity;\n    this.buffer = new Float32Array(initialCapacity);\n    this.readIndex = 0;\n    this.writeIndex = 0;\n    this.availableData = 0;\n  }\n\n  push(data) {\n    const len = data.length;\n    // Auto-grow if needed\n    while (this.availableData + len > this.capacity) {\n      this.grow();\n    }\n    for (let i = 0; i < len; i++) {\n      this.buffer[this.writeIndex] = data[i];\n      this.writeIndex = (this.writeIndex + 1) % this.capacity;\n      this.availableData++;\n    }\n  }\n\n  grow() {\n    const newCapacity = this.capacity * 2;\n    const newBuffer = new Float32Array(newCapacity);\n    // Copy existing data maintaining order\n    for (let i = 0; i < this.availableData; i++) {\n      const srcIndex = (this.readIndex + i) % this.capacity;\n      newBuffer[i] = this.buffer[srcIndex];\n    }\n    this.buffer = newBuffer;\n    this.readIndex = 0;\n    this.writeIndex = this.availableData;\n    this.capacity = newCapacity;\n  }\n\n  pull(outputBuffer) {\n    const len = outputBuffer.length;\n    const available = Math.min(len, this.availableData);\n    for (let i = 0; i < available; i++) {\n      outputBuffer[i] = this.buffer[this.readIndex];\n      this.readIndex = (this.readIndex + 1) % this.capacity;\n    }\n    // Pad remaining with silence\n    for (let i = available; i < len; i++) {\n      outputBuffer[i] = 0;\n    }\n    this.availableData -= available;\n    return available > 0;\n  }\n\n  available() {\n    return this.availableData;\n  }\n\n  clear() {\n    this.readIndex = 0;\n    this.writeIndex = 0;\n    this.availableData = 0;\n  }\n}\n\nclass AudioPlaybackProcessor extends AudioWorkletProcessor {\n  constructor() {\n    super();\n    this.ringBuffer = new RingBuffer(24000 * 30); // 30s initial capacity\n    this.isPlaying = false;\n    this.streamComplete = false;\n\n    this.port.onmessage = (event) => {\n      const { type, samples } = event.data;\n      if (type === \"audio\") {\n        this.ringBuffer.push(samples);\n        this.isPlaying = true;\n      } else if (type === \"clear\") {\n        this.ringBuffer.clear();\n        this.isPlaying = false;\n        this.streamComplete = false;\n      } else if (type === \"streamComplete\") {\n        this.streamComplete = true;\n      } else if (type === \"stop\") {\n        this.isPlaying = false;\n        this.streamComplete = false;\n      }\n    };\n  }\n\n  process(inputs, outputs) {\n    const output = outputs[0];\n    if (!output || output.length === 0) return true;\n\n    const channel = output[0];\n    if (this.isPlaying) {\n      this.ringBuffer.pull(channel);\n      if (this.streamComplete && this.ringBuffer.available() === 0) {\n        this.isPlaying = false;\n        this.streamComplete = false;\n        this.port.postMessage({ type: \"ended\" });\n      }\n    } else {\n      channel.fill(0);\n    }\n    return true;\n  }\n}\n\nregisterProcessor(\"audio-playback-processor\", AudioPlaybackProcessor);\n\n","path":null,"size_bytes":3058,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ask-anything-bar.tsx":{"content":"/**\n * AskAnythingBar â€” Phase 4\n *\n * Persistent bar that lives in the dashboard header (and optionally other pages).\n * Connects to GET /api/agent/ask-anything via Server-Sent Events (SSE).\n *\n * Features:\n *  - Cycling placeholder text\n *  - Scope selector: Account / Portfolio / Program\n *  - SSE streaming from gpt-4o\n *  - Response rendered in an overlay panel below the bar\n *  - Markdown rendering with clickable in-app navigation links\n *  - Chat history persisted in localStorage with dropdown access\n *  - Attribution footer\n */\n\nimport { useState, useEffect, useRef, useCallback } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { X, Sparkles, ChevronDown, History, Trash2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n    DropdownMenu,\n    DropdownMenuContent,\n    DropdownMenuItem,\n    DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\ntype Scope = \"portfolio\" | \"account\" | \"program\";\n\ninterface ChatEntry {\n    id: string;\n    question: string;\n    response: string;\n    scope: Scope;\n    timestamp: number;\n}\n\nconst HISTORY_KEY = \"ask-anything-history\";\nconst MAX_HISTORY = 20;\n\nfunction loadHistory(): ChatEntry[] {\n    try {\n        const raw = localStorage.getItem(HISTORY_KEY);\n        return raw ? JSON.parse(raw) : [];\n    } catch {\n        return [];\n    }\n}\n\nfunction saveHistory(entries: ChatEntry[]) {\n    localStorage.setItem(HISTORY_KEY, JSON.stringify(entries.slice(0, MAX_HISTORY)));\n}\n\nfunction renderMarkdown(raw: string): string {\n    const lastNewline = raw.lastIndexOf(\"\\n\");\n    const safeText = lastNewline === -1 ? raw : raw.substring(0, lastNewline);\n    const trailingPartial = lastNewline === -1 ? \"\" : raw.substring(lastNewline + 1);\n\n    const escaped = safeText\n        .replace(/&/g, \"&amp;\")\n        .replace(/</g, \"&lt;\")\n        .replace(/>/g, \"&gt;\");\n\n    const lines = escaped.split(\"\\n\");\n    const htmlLines: string[] = [];\n    let inList = false;\n    let listType: \"ul\" | \"ol\" | null = null;\n\n    const closeList = () => {\n        if (inList && listType) {\n            htmlLines.push(`</${listType}>`);\n            inList = false;\n            listType = null;\n        }\n    };\n\n    for (const line of lines) {\n        const headerMatch = line.match(/^(#{1,3})\\s+(.+)$/);\n        if (headerMatch) {\n            closeList();\n            const level = headerMatch[1].length;\n            const sizes = [\"text-base font-semibold\", \"text-sm font-semibold\", \"text-sm font-medium\"];\n            htmlLines.push(`<p class=\"${sizes[level - 1]} mt-3 mb-1 text-foreground\">${applyInline(headerMatch[2])}</p>`);\n            continue;\n        }\n\n        const ulMatch = line.match(/^[\\s]*[-â€¢]\\s+(.+)$/);\n        if (ulMatch) {\n            if (!inList || listType !== \"ul\") {\n                closeList();\n                htmlLines.push(`<ul class=\"my-1 ml-4 space-y-0.5\">`);\n                inList = true;\n                listType = \"ul\";\n            }\n            htmlLines.push(`<li class=\"flex gap-1.5 items-start\"><span class=\"text-muted-foreground mt-1.5 shrink-0\">â€¢</span><span>${applyInline(ulMatch[1])}</span></li>`);\n            continue;\n        }\n\n        const olMatch = line.match(/^[\\s]*(\\d+)[.)]\\s+(.+)$/);\n        if (olMatch) {\n            if (!inList || listType !== \"ol\") {\n                closeList();\n                htmlLines.push(`<ol class=\"my-1 ml-4 space-y-0.5\">`);\n                inList = true;\n                listType = \"ol\";\n            }\n            htmlLines.push(`<li class=\"flex gap-1.5 items-start\"><span class=\"font-medium text-muted-foreground shrink-0\">${olMatch[1]}.</span><span>${applyInline(olMatch[2])}</span></li>`);\n            continue;\n        }\n\n        closeList();\n\n        if (line.trim() === \"\") {\n            htmlLines.push(`<div class=\"h-2\"></div>`);\n        } else {\n            htmlLines.push(`<p class=\"my-0.5\">${applyInline(line)}</p>`);\n        }\n    }\n    closeList();\n\n    if (trailingPartial.trim()) {\n        const escapedTrailing = trailingPartial\n            .replace(/&/g, \"&amp;\")\n            .replace(/</g, \"&lt;\")\n            .replace(/>/g, \"&gt;\");\n        htmlLines.push(`<p class=\"my-0.5\">${escapedTrailing}</p>`);\n    }\n\n    return htmlLines.join(\"\");\n}\n\nfunction applyInline(text: string): string {\n    return text\n        .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href=\"$2\" class=\"text-blue-600 dark:text-blue-400 underline underline-offset-2 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer\" data-app-link=\"true\">$1</a>')\n        .replace(/\\*\\*(.+?)\\*\\*/g, (_, content) => `<strong class=\"font-semibold text-foreground\">${content}</strong>`)\n        .replace(/(?<!\\*)\\*(?!\\*)(.+?)(?<!\\*)\\*(?!\\*)/g, '<em>$1</em>')\n        .replace(/`(.+?)`/g, '<code class=\"px-1 py-0.5 rounded bg-muted text-xs font-mono\">$1</code>');\n}\n\nfunction formatTimeAgo(timestamp: number): string {\n    const diff = Date.now() - timestamp;\n    const minutes = Math.floor(diff / 60000);\n    if (minutes < 1) return \"Just now\";\n    if (minutes < 60) return `${minutes}m ago`;\n    const hours = Math.floor(minutes / 60);\n    if (hours < 24) return `${hours}h ago`;\n    const days = Math.floor(hours / 24);\n    return `${days}d ago`;\n}\n\nconst PLACEHOLDERS = [\n    \"Which accounts haven't ordered in 30+ days?\",\n    \"Who are my best opportunities for copper fittings?\",\n    \"Summarize at-risk signals from this week's emails\",\n    \"Which enrolled accounts are closest to graduation?\",\n    \"What's driving the decline in HVAC revenue?\",\n    \"Show me accounts where a project-based play would work\",\n];\n\ninterface AskAnythingBarProps {\n    defaultScope?: Scope;\n    accountId?: number;\n}\n\nexport function AskAnythingBar({ defaultScope = \"portfolio\", accountId }: AskAnythingBarProps) {\n    const [, navigate] = useLocation();\n    const [scope, setScope] = useState<Scope>(defaultScope);\n    const [question, setQuestion] = useState(\"\");\n    const [streaming, setStreaming] = useState(false);\n    const [response, setResponse] = useState(\"\");\n    const [open, setOpen] = useState(false);\n    const [displayedQuestion, setDisplayedQuestion] = useState(\"\");\n    const [displayedScope, setDisplayedScope] = useState<Scope>(defaultScope);\n    const [placeholder, setPlaceholder] = useState(PLACEHOLDERS[0]);\n    const [history, setHistory] = useState<ChatEntry[]>(loadHistory);\n    const [historyOpen, setHistoryOpen] = useState(false);\n    const responseRef = useRef<HTMLDivElement>(null);\n    const inputRef = useRef<HTMLInputElement>(null);\n    const historyRef = useRef<HTMLDivElement>(null);\n    const currentResponseRef = useRef(\"\");\n\n    const handleResponseClick = useCallback((e: React.MouseEvent) => {\n        const target = e.target as HTMLElement;\n        const link = target.closest('a[data-app-link]') as HTMLAnchorElement | null;\n        if (link) {\n            e.preventDefault();\n            const href = link.getAttribute(\"href\");\n            if (href && href.startsWith(\"/\")) {\n                navigate(href);\n            }\n        }\n    }, [navigate]);\n\n    useEffect(() => {\n        let idx = 0;\n        const interval = setInterval(() => {\n            idx = (idx + 1) % PLACEHOLDERS.length;\n            setPlaceholder(PLACEHOLDERS[idx]);\n        }, 4000);\n        return () => clearInterval(interval);\n    }, []);\n\n    useEffect(() => {\n        if (responseRef.current) {\n            responseRef.current.scrollTop = responseRef.current.scrollHeight;\n        }\n    }, [response]);\n\n    useEffect(() => {\n        if (!historyOpen) return;\n        const handleClickOutside = (e: MouseEvent) => {\n            if (historyRef.current && !historyRef.current.contains(e.target as Node)) {\n                setHistoryOpen(false);\n            }\n        };\n        document.addEventListener(\"mousedown\", handleClickOutside);\n        return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n    }, [historyOpen]);\n\n    async function handleAsk() {\n        if (!question.trim() || streaming) return;\n        const askedQuestion = question.trim();\n        setDisplayedQuestion(askedQuestion);\n        setDisplayedScope(scope);\n        setResponse(\"\");\n        currentResponseRef.current = \"\";\n        setOpen(true);\n        setStreaming(true);\n        setHistoryOpen(false);\n\n        const params = new URLSearchParams({\n            question: askedQuestion,\n            scope,\n            ...(scope === \"account\" && accountId ? { scopeId: String(accountId) } : {}),\n        });\n\n        try {\n            const es = new EventSource(`/api/agent/ask-anything?${params.toString()}`);\n\n            es.onmessage = (e) => {\n                if (e.data === \"[DONE]\") {\n                    es.close();\n                    setStreaming(false);\n                    const finalResponse = currentResponseRef.current;\n                    if (finalResponse.trim()) {\n                        const entry: ChatEntry = {\n                            id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,\n                            question: askedQuestion,\n                            response: finalResponse,\n                            scope,\n                            timestamp: Date.now(),\n                        };\n                        setHistory((prev) => {\n                            const updated = [entry, ...prev].slice(0, MAX_HISTORY);\n                            saveHistory(updated);\n                            return updated;\n                        });\n                    }\n                    return;\n                }\n                try {\n                    const { text } = JSON.parse(e.data);\n                    currentResponseRef.current += text;\n                    setResponse((prev) => prev + text);\n                } catch { }\n            };\n\n            es.onerror = () => {\n                es.close();\n                setStreaming(false);\n            };\n        } catch {\n            setStreaming(false);\n        }\n    }\n\n    function handleKeyDown(e: React.KeyboardEvent) {\n        if (e.key === \"Enter\" && !e.shiftKey) {\n            e.preventDefault();\n            handleAsk();\n        }\n        if (e.key === \"Escape\") {\n            setOpen(false);\n        }\n    }\n\n    function openHistoryEntry(entry: ChatEntry) {\n        setDisplayedQuestion(entry.question);\n        setDisplayedScope(entry.scope);\n        setResponse(entry.response);\n        setOpen(true);\n        setHistoryOpen(false);\n    }\n\n    function clearHistory() {\n        setHistory([]);\n        localStorage.removeItem(HISTORY_KEY);\n    }\n\n    function deleteHistoryEntry(id: string) {\n        setHistory((prev) => {\n            const updated = prev.filter((e) => e.id !== id);\n            saveHistory(updated);\n            return updated;\n        });\n    }\n\n    const scopeLabels: Record<Scope, string> = {\n        portfolio: \"Portfolio\",\n        account: \"Account\",\n        program: \"Program\",\n    };\n\n    return (\n        <div className=\"relative flex-1 max-w-2xl flex items-center gap-1\" id=\"ask-anything-bar\">\n            {/* Input row */}\n            <div className={`flex items-center gap-1 rounded-xl border bg-background shadow-sm transition-all flex-1\n        ${open ? \"ring-2 ring-primary/30\" : \"hover:border-primary/40\"}`}>\n\n                <Sparkles className=\"h-4 w-4 text-primary ml-3 shrink-0\" />\n\n                <Input\n                    ref={inputRef}\n                    value={question}\n                    onChange={(e) => setQuestion(e.target.value)}\n                    onKeyDown={handleKeyDown}\n                    placeholder={placeholder}\n                    className=\"border-0 shadow-none focus-visible:ring-0 text-sm flex-1 bg-transparent\"\n                    disabled={streaming}\n                    id=\"ask-anything-input\"\n                />\n\n                {/* Scope picker */}\n                <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                        <button className=\"flex items-center gap-1 text-xs font-medium text-muted-foreground hover:text-foreground px-2 py-1 rounded-md hover:bg-muted/50 transition-colors shrink-0\">\n                            {scopeLabels[scope]}\n                            <ChevronDown className=\"h-3 w-3\" />\n                        </button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\" className=\"text-sm\">\n                        <DropdownMenuItem onClick={() => setScope(\"portfolio\")}>Portfolio</DropdownMenuItem>\n                        <DropdownMenuItem onClick={() => setScope(\"account\")} disabled={!accountId}>Account</DropdownMenuItem>\n                        <DropdownMenuItem onClick={() => setScope(\"program\")}>Program</DropdownMenuItem>\n                    </DropdownMenuContent>\n                </DropdownMenu>\n\n                <Button\n                    size=\"sm\"\n                    className=\"m-1 h-7 px-3 text-xs shrink-0\"\n                    onClick={handleAsk}\n                    disabled={!question.trim() || streaming}\n                    id=\"ask-anything-submit\"\n                >\n                    {streaming ? (\n                        <span className=\"flex gap-1\">\n                            <span className=\"animate-bounce\" style={{ animationDelay: \"0ms\" }}>Â·</span>\n                            <span className=\"animate-bounce\" style={{ animationDelay: \"150ms\" }}>Â·</span>\n                            <span className=\"animate-bounce\" style={{ animationDelay: \"300ms\" }}>Â·</span>\n                        </span>\n                    ) : (\n                        \"Ask\"\n                    )}\n                </Button>\n            </div>\n\n            {/* History button */}\n            <div className=\"relative\" ref={historyRef}>\n                <button\n                    onClick={() => setHistoryOpen(!historyOpen)}\n                    className={`flex items-center justify-center h-8 w-8 rounded-lg border transition-colors shrink-0\n                        ${history.length > 0 ? \"text-muted-foreground hover:text-foreground hover:bg-muted/50 bg-background\" : \"text-muted-foreground/40 bg-background cursor-default\"}`}\n                    disabled={history.length === 0}\n                    title=\"Recent questions\"\n                    data-testid=\"button-chat-history\"\n                >\n                    <History className=\"h-4 w-4\" />\n                </button>\n\n                {/* History dropdown */}\n                {historyOpen && history.length > 0 && (\n                    <div className=\"absolute top-full right-0 mt-1 z-50 w-80 rounded-xl border bg-background shadow-xl overflow-hidden\">\n                        <div className=\"px-3 py-2 border-b bg-muted/30 flex items-center justify-between\">\n                            <span className=\"text-xs font-medium text-muted-foreground\">Recent Questions</span>\n                            <div className=\"flex items-center gap-1\">\n                                <button\n                                    onClick={clearHistory}\n                                    className=\"text-xs text-muted-foreground hover:text-destructive transition-colors px-1.5 py-0.5 rounded hover:bg-muted/50\"\n                                    data-testid=\"button-clear-history\"\n                                >\n                                    Clear all\n                                </button>\n                                <button\n                                    onClick={() => setHistoryOpen(false)}\n                                    className=\"text-muted-foreground hover:text-foreground\"\n                                >\n                                    <X className=\"h-3.5 w-3.5\" />\n                                </button>\n                            </div>\n                        </div>\n                        <div className=\"max-h-64 overflow-y-auto\">\n                            {history.map((entry) => (\n                                <div\n                                    key={entry.id}\n                                    className=\"group flex items-start gap-2 px-3 py-2.5 hover:bg-muted/40 cursor-pointer border-b last:border-b-0 transition-colors\"\n                                    onClick={() => openHistoryEntry(entry)}\n                                    data-testid={`history-entry-${entry.id}`}\n                                >\n                                    <Sparkles className=\"h-3.5 w-3.5 text-muted-foreground mt-0.5 shrink-0\" />\n                                    <div className=\"flex-1 min-w-0\">\n                                        <p className=\"text-sm text-foreground truncate\">{entry.question}</p>\n                                        <p className=\"text-xs text-muted-foreground mt-0.5\">\n                                            {scopeLabels[entry.scope]} Â· {formatTimeAgo(entry.timestamp)}\n                                        </p>\n                                    </div>\n                                    <button\n                                        onClick={(e) => {\n                                            e.stopPropagation();\n                                            deleteHistoryEntry(entry.id);\n                                        }}\n                                        className=\"opacity-0 group-hover:opacity-100 text-muted-foreground hover:text-destructive transition-opacity p-0.5\"\n                                        data-testid={`button-delete-history-${entry.id}`}\n                                    >\n                                        <Trash2 className=\"h-3 w-3\" />\n                                    </button>\n                                </div>\n                            ))}\n                        </div>\n                    </div>\n                )}\n            </div>\n\n            {/* Response overlay */}\n            {open && (\n                <div className=\"absolute top-full left-0 right-0 mt-1 z-50 rounded-xl border bg-background shadow-xl overflow-hidden\">\n                    {/* Response question echo */}\n                    <div className=\"px-4 pt-3 pb-2 border-b bg-muted/30\">\n                        <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-2\">\n                                <Sparkles className=\"h-3.5 w-3.5 text-primary\" />\n                                <span className=\"text-xs font-medium text-muted-foreground\">{displayedQuestion}</span>\n                                <span className=\"text-xs text-muted-foreground/60\">Â· {scopeLabels[displayedScope]}</span>\n                            </div>\n                            <button\n                                onClick={() => { setOpen(false); }}\n                                className=\"text-muted-foreground hover:text-foreground\"\n                                data-testid=\"button-close-response\"\n                            >\n                                <X className=\"h-3.5 w-3.5\" />\n                            </button>\n                        </div>\n                    </div>\n\n                    {/* Streaming response */}\n                    <div\n                        ref={responseRef}\n                        className=\"px-4 py-3 text-sm text-foreground leading-relaxed max-h-80 overflow-y-auto\"\n                        onClick={handleResponseClick}\n                    >\n                        {response ? (\n                            <div className=\"space-y-0\" dangerouslySetInnerHTML={{ __html: renderMarkdown(response) }} />\n                        ) : (\n                            <span className=\"text-muted-foreground italic text-sm\">\n                                {streaming ? \"Thinking...\" : \"Ask a question above to get started.\"}\n                            </span>\n                        )}\n                        {streaming && (\n                            <span className=\"inline-block w-0.5 h-4 bg-primary ml-0.5 animate-pulse align-middle\" />\n                        )}\n                    </div>\n\n                    {/* Footer */}\n                    <div className=\"px-4 py-2 border-t bg-muted/20 flex items-center justify-between\">\n                        <span className=\"text-xs text-muted-foreground\">Revenue Intelligence Agent Â· Wallet Share Expander</span>\n                        <span className=\"text-xs text-muted-foreground\">gpt-4o</span>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n}\n","path":null,"size_bytes":20420,"size_tokens":null},"client/replit_integrations/audio/audio-utils.ts":{"content":"/**\n * Audio utility functions for voice chat.\n * Handles PCM16 decoding and AudioContext initialization.\n */\n\n/**\n * Decode base64 PCM16 audio to Float32Array for Web Audio API\n */\nexport function decodePCM16ToFloat32(base64Audio: string): Float32Array {\n  const raw = atob(base64Audio);\n  const bytes = new Uint8Array(raw.length);\n  for (let i = 0; i < raw.length; i++) {\n    bytes[i] = raw.charCodeAt(i);\n  }\n  const pcm16 = new Int16Array(bytes.buffer);\n  const float32 = new Float32Array(pcm16.length);\n  for (let i = 0; i < pcm16.length; i++) {\n    float32[i] = pcm16[i] / 32768;\n  }\n  return float32;\n}\n\n/**\n * Create and initialize AudioContext with worklet\n */\nexport async function createAudioPlaybackContext(\n  workletPath = \"/audio-playback-worklet.js\",\n  sampleRate = 24000\n): Promise<{ ctx: AudioContext; worklet: AudioWorkletNode }> {\n  const ctx = new AudioContext({ sampleRate });\n  await ctx.audioWorklet.addModule(workletPath);\n  const worklet = new AudioWorkletNode(ctx, \"audio-playback-processor\");\n  worklet.connect(ctx.destination);\n  return { ctx, worklet };\n}\n\n","path":null,"size_bytes":1086,"size_tokens":null},"client/src/components/app-sidebar.tsx":{"content":"import { useLocation, Link } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport {\n  LayoutDashboard,\n  Upload,\n  Users,\n  Target,\n  ClipboardList,\n  TrendingUp,\n  Settings,\n  LogOut,\n  GitBranch,\n  CreditCard,\n  ShieldCheck,\n  Trophy,\n  FileSpreadsheet,\n  HelpCircle,\n  Database,\n  BarChart4,\n  Contact,\n  FolderKanban,\n  Zap,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarHeader,\n  SidebarFooter,\n} from \"@/components/ui/sidebar\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport tenexityLogo from \"@assets/Tenexity_Logo_final_1769263645437.png\";\nimport appLogo from \"/favicon2.png\";\n\ninterface Setting {\n  key: string;\n  value: string | null;\n}\n\nconst mainNavItems = [\n  {\n    title: \"Dashboard\",\n    url: \"/\",\n    icon: LayoutDashboard,\n    tooltip: \"Overview of KPIs, top opportunities, and your daily focus tasks\",\n  },\n  {\n    title: \"Revenue Tracking\",\n    url: \"/revenue\",\n    icon: TrendingUp,\n    tooltip: \"Track enrolled accounts, incremental revenue, and calculate rev-share fees\",\n  },\n  {\n    title: \"Program Performance\",\n    url: \"/program-performance\",\n    icon: BarChart4,\n    tooltip: \"Enrolled/graduated counts, rep leaderboard, and program health metrics\",\n    matchPattern: /^\\/program-performance/,\n  },\n  {\n    title: \"Accounts\",\n    url: \"/accounts\",\n    icon: Users,\n    tooltip: \"View all customer accounts with gap analysis and opportunity scores\",\n  },\n  {\n    title: \"ICP Builder\",\n    url: \"/icp-builder\",\n    icon: Target,\n    tooltip: \"Define Ideal Customer Profiles for each segment using AI analysis\",\n  },\n  {\n    title: \"Playbooks\",\n    url: \"/playbooks\",\n    icon: ClipboardList,\n    tooltip: \"Generate and manage AI-powered sales tasks with call scripts and emails\",\n  },\n];\n\nconst intelligenceNavItems = [\n  {\n    title: \"Contacts\",\n    url: \"/crm/contacts\",\n    icon: Contact,\n    tooltip: \"Contact directory with roles, influence levels, and outreach tracking\",\n  },\n  {\n    title: \"Projects\",\n    url: \"/crm/projects\",\n    icon: FolderKanban,\n    tooltip: \"Construction project pipeline detected from email intelligence\",\n  },\n  {\n    title: \"Signals & Threats\",\n    url: \"/crm/signals\",\n    icon: Zap,\n    tooltip: \"Order signals and competitor intelligence from customer emails\",\n  },\n];\n\nconst adminNavItems = [\n  {\n    title: \"Setup Guide\",\n    url: \"/workflow-guide\",\n    icon: GitBranch,\n    tooltip: \"Visual guide showing setup, monthly, weekly, and daily workflows\",\n  },\n  {\n    title: \"Data Uploads\",\n    url: \"/data-uploads\",\n    icon: Upload,\n    tooltip: \"Import accounts, products, categories, and order history from CSV files\",\n  },\n  {\n    title: \"Subscription\",\n    url: \"/subscription\",\n    icon: CreditCard,\n    tooltip: \"Manage your subscription plan and billing settings\",\n  },\n  {\n    title: \"Settings\",\n    url: \"/settings\",\n    icon: Settings,\n    tooltip: \"Configure scoring weights and manage Territory Managers\",\n  },\n  {\n    title: \"App Admin\",\n    url: \"/app-admin\",\n    icon: ShieldCheck,\n    tooltip: \"Platform administration - manage all tenants and subscriptions\",\n  },\n];\n\nfunction UserProfile() {\n  const { user } = useAuth();\n\n  const displayName = user?.firstName && user?.lastName\n    ? `${user.firstName} ${user.lastName}`\n    : user?.email?.split('@')[0] || 'User';\n\n  const initials = user?.firstName && user?.lastName\n    ? `${user.firstName[0]}${user.lastName[0]}`.toUpperCase()\n    : displayName.slice(0, 2).toUpperCase();\n\n  return (\n    <div className=\"flex items-center gap-3 group-data-[collapsible=icon]:flex-col group-data-[collapsible=icon]:gap-2\">\n      <SidebarMenuButton asChild className=\"flex-1 h-auto py-1\" data-testid=\"link-profile\">\n        <Link href=\"/profile\">\n          <Avatar className=\"h-8 w-8 shrink-0\">\n            {user?.profileImageUrl && (\n              <AvatarImage src={user.profileImageUrl} alt={displayName} />\n            )}\n            <AvatarFallback className=\"bg-sidebar-accent text-sidebar-accent-foreground text-xs\">\n              {initials}\n            </AvatarFallback>\n          </Avatar>\n          <div className=\"flex flex-col flex-1 min-w-0 group-data-[collapsible=icon]:hidden\">\n            <span className=\"text-sm font-medium truncate\">{displayName}</span>\n            <span className=\"text-xs opacity-60\">My Profile</span>\n          </div>\n        </Link>\n      </SidebarMenuButton>\n      <SidebarMenuButton asChild size=\"sm\" className=\"h-8 w-8 p-0 shrink-0 group-data-[collapsible=icon]:hidden\" data-testid=\"button-logout\">\n        <a href=\"/api/logout\">\n          <LogOut className=\"h-4 w-4\" />\n        </a>\n      </SidebarMenuButton>\n    </div>\n  );\n}\n\nexport function AppSidebar() {\n  const [location, navigate] = useLocation();\n  const { user } = useAuth();\n\n  const { data: settingsData } = useQuery<Setting[]>({\n    queryKey: [\"/api/settings\"],\n  });\n\n  const getSettingValue = (key: string, defaultValue: string): string => {\n    const setting = settingsData?.find(s => s.key === key);\n    return setting?.value || defaultValue;\n  };\n\n  const appTitle = getSettingValue(\"appTitle\", \"AI VP Dashboard\");\n  const companyName = getSettingValue(\"companyName\", \"ABC Supply\");\n  const companyLogo = getSettingValue(\"companyLogo\", \"\");\n\n  // Platform admin emails (tenexity team members) - case-insensitive comparison\n  const platformAdminEmails = [\"graham@tenexity.ai\", \"admin@tenexity.ai\"];\n  const isPlatformAdmin = user?.email && platformAdminEmails.some(\n    adminEmail => adminEmail.toLowerCase() === (user.email || \"\").toLowerCase().trim()\n  );\n\n  // Filter admin items - hide App Admin from non-platform admins\n  const visibleAdminItems = adminNavItems.filter(item => {\n    if (item.url === \"/app-admin\") {\n      return isPlatformAdmin;\n    }\n    return true;\n  });\n\n  return (\n    <Sidebar collapsible=\"icon\">\n      <SidebarHeader className=\"p-4 group-data-[collapsible=icon]:p-2\">\n        <div className=\"flex items-center gap-3 group-data-[collapsible=icon]:justify-center\">\n          {companyLogo ? (\n            <div className=\"flex h-10 w-10 shrink-0 items-center justify-center rounded-md overflow-hidden bg-white group-data-[collapsible=icon]:h-8 group-data-[collapsible=icon]:w-8\">\n              <img\n                src={companyLogo}\n                alt=\"Company logo\"\n                className=\"h-full w-full object-contain p-1\"\n              />\n            </div>\n          ) : (\n            <div className=\"flex h-10 w-10 shrink-0 items-center justify-center rounded-md overflow-hidden group-data-[collapsible=icon]:h-8 group-data-[collapsible=icon]:w-8\">\n              <img\n                src={appLogo}\n                alt=\"Wallet Share Expander\"\n                className=\"h-full w-full object-contain\"\n              />\n            </div>\n          )}\n          <div className=\"flex flex-col group-data-[collapsible=icon]:hidden\">\n            <span className=\"text-sm font-semibold text-sidebar-foreground\">{appTitle}</span>\n            <span className=\"text-xs text-sidebar-foreground/60\">{companyName}</span>\n          </div>\n        </div>\n      </SidebarHeader>\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Main</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {mainNavItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    isActive={location === item.url}\n                    onClick={() => navigate(item.url)}\n                    tooltip={{ children: item.tooltip, side: \"right\" }}\n                    data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                  >\n                    <item.icon className=\"h-4 w-4\" />\n                    <span>{item.title}</span>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n        <SidebarGroup>\n          <SidebarGroupLabel>Intelligence</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {intelligenceNavItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    isActive={location === item.url}\n                    onClick={() => navigate(item.url)}\n                    tooltip={{ children: item.tooltip, side: \"right\" }}\n                    data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                  >\n                    <item.icon className=\"h-4 w-4\" />\n                    <span>{item.title}</span>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n        <SidebarGroup>\n          <SidebarGroupLabel>Admin</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {visibleAdminItems.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton\n                    isActive={location === item.url}\n                    onClick={() => navigate(item.url)}\n                    tooltip={{ children: item.tooltip, side: \"right\" }}\n                    data-testid={`nav-${item.title.toLowerCase().replace(/\\s+/g, \"-\")}`}\n                  >\n                    <item.icon className=\"h-4 w-4\" />\n                    <span>{item.title}</span>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n      <SidebarFooter className=\"p-4 space-y-4 group-data-[collapsible=icon]:p-2 group-data-[collapsible=icon]:space-y-2\">\n        <UserProfile />\n        <div className=\"border-t border-sidebar-border pt-3 group-data-[collapsible=icon]:hidden\">\n          <div className=\"flex items-center justify-center gap-2 text-xs text-sidebar-foreground/50\">\n            <span>Created with care by</span>\n            <img\n              src={tenexityLogo}\n              alt=\"Tenexity\"\n              className=\"h-4 object-contain dark:invert\"\n            />\n          </div>\n        </div>\n      </SidebarFooter>\n    </Sidebar>\n  );\n}\n","path":null,"size_bytes":10451,"size_tokens":null},"docs/wallet-share-expander-build-spec.md":{"content":"# Wallet Share Expander â€” Agentic Intelligence Layer\n## Master Build Specification\n\n---\n\n## How to Use This Document\n\nThis document is the complete technical specification for adding an agentic \nintelligence layer to the Wallet Share Expander application. It was developed \nthrough a design session analyzing the existing beta app, drawing inspiration \nfrom Sybill.ai's sales intelligence approach, and adapting those patterns to \nthe narrow vertical of MEP wholesale distribution.\n\n**When prompting Claude Code:** Paste the Project Context block first, then \npaste the specific Phase prompt you are working on. Complete and test each \nphase before moving to the next. The phases are designed to be sequential â€” \neach one builds on the database objects and functions created in the previous \nphase.\n\n**Phase order:**\n- Phase 0: Agent Identity & Continuity (do this first â€” it shapes everything)\n- Phase 1: Entity Store Database Schema\n- Phase 2: Relationship Graph & Vector Similarity\n- Phase 3: Agent Loop Edge Functions\n- Phase 4: Frontend Integration\n- Phase 5: Scheduling & Webhook Configuration\n\n---\n\n## Design Philosophy\n\nThe core insight behind this architecture is the difference between a \n**conversation-as-signal** model (what tools like Sybill.ai use) and a \n**transaction-as-signal** model (what this app is built on).\n\nSybill listens to what customers say. This app tracks what they actually buy.\nTransaction data doesn't lie â€” it surfaces wallet share gaps that reps don't \nknow exist and that contractors won't admit to.\n\nThe agentic layer is designed around three principles:\n\n**1. Ground truth over conversation.** Every AI recommendation must reference \na specific dollar amount, a specific category gap, or a specific pattern from \npurchase history. No generic advice.\n\n**2. The relationship is the asset.** The agent prepares humans to have better \nconversations. It never replaces the relationship between a territory manager \nand a contractor.\n\n**3. One clear action over ten suggestions.** Territory managers are busy. \nThe agent's job is to surface the single most important thing to do right now, \nnot to generate comprehensive reports that go unread.\n\n**What we took from Sybill and adapted:**\n- Pre-meeting / pre-call briefs (adapted from call transcript context to \n  transaction + relationship context)\n- Magic summaries after interactions (adapted to email intelligence pipeline)\n- Win/loss pattern analysis (adapted to graduation pattern analysis)\n- Natural language \"ask anything\" interface across deal data\n- Rep coaching briefs for managers (adapted to program performance views)\n\n**What makes this uniquely suited to MEP distribution:**\n- Project-driven buying cycle modeling (contractors buy by project, not by \n  calendar)\n- Trade-specific ICP profiles (HVAC, Plumbing, Mechanical, General Contractor \n  each have different category mixes)\n- Wallet share graduation model (enrollment â†’ growth â†’ graduation journey)\n- ERP-native data model (designed for integration with Eclipse, P21, Infor)\n- Seasonality awareness (a February silence may be winter slowdown, not churn)\n\n---\n\n## Project Context Block\n*Paste this at the start of every Claude Code session*\n\n```\nI am building an agentic intelligence layer for a Supabase + React app called \nWallet Share Expander. It is a SaaS tool for MEP wholesale distributors that \nanalyzes contractor purchasing data against an ideal customer profile baseline \nto surface wallet share gaps, enroll high-opportunity accounts, generate AI \nplaybooks, and proactively coach territory managers.\n\nThe stack is:\n- Frontend: React (existing app on Replit)\n- Backend: Supabase (Postgres + Edge Functions + pg_cron + pgvector + \n  database webhooks)\n- AI: Anthropic Claude API (claude-sonnet-4-5 model)\n- Email: Resend API\n- Auth: Supabase Auth (existing)\n\nThere is NO n8n. All orchestration happens inside Supabase Edge Functions.\nAll agent reasoning happens via direct Anthropic API calls from Edge Functions.\n\nThe three layers being built are:\n- Layer 1: Entity Store (the data model â€” contractors, contacts, projects, \n  interactions, orders, competitors)\n- Layer 2: Relationship Graph (relationship tables connecting entities, \n  plus pgvector for semantic similarity)\n- Layer 3: Agent Loop (Edge Functions that assemble context and call Claude)\n\nThe agent has a persistent identity (soul) stored in the system_prompts table,\na continuity mechanism (heartbeat) stored in the agent_state table, and a \nlearning memory stored in the playbook_learnings table. These are established \nin Phase 0 and must be referenced by all subsequent Edge Functions.\n```\n\n---\n\n## Phase 0: Agent Identity & Continuity\n*The soul, heartbeat, and memory layer. Build this first.*\n\n```\nUsing the project context above, create the agent identity and continuity \ninfrastructure. This phase establishes three foundational tables that all \nsubsequent Edge Functions will read from and write to.\n\nPART A: system_prompts table and core agent identity\n\nCreate a system_prompts table:\n- id (uuid, primary key)\n- prompt_key (text, unique â€” used to retrieve specific prompts)\n- content (text)\n- version (integer)\n- is_active (boolean)\n- created_at (timestamptz)\n- updated_at (timestamptz)\n\nInsert a row with prompt_key = 'core_agent_identity' and the following \ncontent:\n\n\"You are the Revenue Intelligence Agent for Wallet Share Expander, an AI \nsystem purpose-built for MEP wholesale distribution.\n\nYOUR PURPOSE:\nYou exist to help wholesale distributor territory managers grow revenue from \nexisting contractor accounts by identifying wallet share gaps, generating \ntargeted playbooks, and surfacing the right action at the right moment.\n\nYOUR UNDERSTANDING OF THIS WORLD:\n- Contractors buy based on project cycles, not calendar cycles. A plumbing \n  contractor's silence in February may mean winter slowdown, not churn.\n- The relationship between a territory manager and a contractor is the \n  primary asset. You support that relationship â€” you never replace it.\n- Transaction data tells the truth. What contractors say about their buying \n  behavior and what they actually do are often different. Trust the data.\n- A 72% gap in copper fittings is not an abstraction â€” it represents real \n  dollars going to a competitor today.\n- Wholesale distribution margins are thin. Every recommendation you make \n  should have a clear, measurable revenue connection.\n\nYOUR PRINCIPLES:\n- Always ground recommendations in specific data from the contractor's record.\n  Never make generic suggestions.\n- When you see an at-risk signal, surface it immediately even if uncertain.\n  False positives are recoverable. Missed churn signals are not.\n- Prioritize accounts where action today will change outcomes. Do not surface \n  noise.\n- The territory manager is busy and has many accounts. Give them one clear \n  next action, not a list of ten.\n- Never fabricate data, infer beyond what evidence supports, or express \n  certainty you do not have.\n- Be aware of seasonality â€” compare current behavior against the same period \n  in prior cycles before flagging anomalies.\n\nYOUR BOUNDARIES:\n- You do not make pricing decisions or commit the distributor to terms.\n- You do not contact contractors directly â€” you prepare humans to do so.\n- If you lack sufficient data to make a recommendation, say so clearly and \n  describe what data would help.\"\n\nCreate a helper function get_core_system_prompt() that returns the active \ncore_agent_identity content as text. All Edge Functions must call this \nfunction and prepend the result to their system prompt before any \nfunction-specific instructions.\n\nPART B: agent_state table (the heartbeat)\n\nCreate an agent_state table:\n- id (uuid, primary key)\n- organization_id (uuid)\n- agent_run_type (text â€” matches Edge Function names: 'daily-briefing', \n  'weekly-account-review', 'email-intelligence', 'generate-playbook', \n  'synthesize-learnings')\n- last_run_at (timestamptz)\n- last_run_summary (text â€” 2-4 sentence memo of what the agent did and found)\n- current_focus (text â€” what patterns or accounts it is actively watching)\n- pending_actions (jsonb â€” actions generated but not yet confirmed executed)\n- open_questions (jsonb â€” things flagged as needing more data or monitoring)\n- pattern_notes (text â€” cross-account patterns noticed over multiple runs, \n  appended over time with date stamps)\n- anomalies_watching (jsonb â€” specific accounts or signals being monitored \n  with watch criteria and expiry)\n- last_updated_at (timestamptz)\n\nEach Edge Function must:\n1. At the START of execution: query agent_state for its run_type and \n   organization_id. Include last_run_summary, current_focus, pattern_notes, \n   and open_questions in the Claude context so the agent builds on prior \n   observations rather than starting cold.\n2. At the END of execution: write a brief memo back to agent_state with what \n   it found, what it's watching, and any new patterns noted.\n\nThe memo written back should be generated by Claude as part of its response, \nusing this instruction appended to every function's system prompt:\n\"At the end of your response, include a JSON block with key 'agent_memo' \ncontaining: last_run_summary (string), current_focus (string), \npattern_notes_addition (string, new observations to append with today's date), \nanomalies_watching (array of {account_name, signal, watch_until}).\"\n\nPART C: playbook_learnings table (the memory)\n\nCreate a playbook_learnings table:\n- id (uuid, primary key)\n- organization_id (uuid)\n- learning (text â€” a concise, actionable rule derived from outcome data)\n- trade_type (text array â€” which trade types this applies to)\n- playbook_type (text array â€” which playbook types this applies to)\n- evidence_count (integer â€” how many outcomes support this learning)\n- success_rate (numeric â€” percentage of times this approach succeeded)\n- date_derived (date)\n- is_active (boolean â€” false if superseded by newer contradicting evidence)\n- superseded_by (uuid, foreign key to playbook_learnings)\n- created_at (timestamptz)\n\nSeed with 5 example learnings to validate the structure:\n1. \"Project-based email angles outperform category-gap angles for HVAC \n   contractors with annual revenue over $100K. Lead with the project.\"\n2. \"Copper fittings win-back playbooks succeed at significantly higher rates \n   when initiated within 45 days of the gap appearing versus after 90 days.\"\n3. \"Contacts with role = owner respond to relationship-based phone calls. \n   Contacts with role = purchasing respond to email with pricing data.\"\n4. \"Accounts that graduate fastest share a pattern: the rep made first \n   contact within 7 days of enrollment and focused on a single category gap \n   in the first 30 days.\"\n5. \"At-risk signals in email sentiment are reliable predictors of spend \n   decline within 60 days when detected early.\"\n\nCreate a Supabase Edge Function /functions/synthesize-learnings that:\n1. Is triggered monthly by pg_cron\n2. Queries playbook_outcomes joined with playbooks and contractors for the \n   past 90 days\n3. Sends the outcomes data to Claude with prompt: \"Analyze these playbook \n   outcomes and extract 3-7 durable learnings about what works for which \n   contractor types in MEP wholesale distribution. Format each as a concise, \n   actionable rule that a territory manager's AI assistant could use to \n   generate better playbooks. Include the trade types and playbook types each \n   learning applies to.\"\n4. Writes new rows to playbook_learnings\n5. For each new learning, checks if it contradicts any existing active \n   learning and if so marks the older one is_active = false and sets \n   superseded_by to the new row's id\n6. Updates agent_state for 'synthesize-learnings' run type\n```\n\n---\n\n## Phase 1: Entity Store Database Schema\n\n```\nUsing the project context above, and assuming Phase 0 tables exist, create \nthe complete Supabase SQL migration file to implement Layer 1: the Entity \nStore.\n\nCreate the following tables with all columns, types, indexes, and RLS \npolicies:\n\nTABLE: contractors\n- id (uuid, primary key)\n- organization_id (uuid, foreign key to organizations)\n- name (text)\n- trade_type (enum: 'hvac', 'plumbing', 'mechanical', 'general_contractor', \n  'electrical', 'other')\n- annual_revenue_current (numeric)\n- annual_revenue_baseline (numeric, the golden customer benchmark for this \n  trade type)\n- wallet_share_percentage (numeric, calculated)\n- wallet_share_direction (enum: 'growing', 'declining', 'stable')\n- opportunity_score (integer 0-100)\n- enrollment_status (enum: 'discovered', 'enrolled', 'graduated', 'at_risk')\n- enrolled_at (timestamptz)\n- graduated_at (timestamptz)\n- last_order_date (date)\n- days_since_last_order (integer, computed)\n- seasonality_profile (jsonb â€” stores monthly buying index: \n  {jan: 0.6, feb: 0.4, mar: 1.2, ...} where 1.0 = average month)\n- embedding (vector(1536) â€” for pgvector similarity search, added after \n  enabling pgvector extension)\n- created_at (timestamptz)\n- updated_at (timestamptz)\n\nTABLE: contacts\n- id (uuid, primary key)\n- contractor_id (uuid, foreign key to contractors)\n- organization_id (uuid, foreign key)\n- name (text)\n- role (enum: 'owner', 'operations_manager', 'project_manager', 'foreman', \n  'purchasing', 'other')\n- email (text)\n- phone (text)\n- influence_level (enum: 'decision_maker', 'influencer', 'user')\n- communication_preference (enum: 'email', 'phone', 'text', 'in_person')\n- relationship_warmth_score (integer 0-100)\n- topics_of_interest (text array)\n- last_contacted_at (timestamptz)\n- created_at (timestamptz)\n\nTABLE: projects\n- id (uuid, primary key)\n- contractor_id (uuid, foreign key)\n- organization_id (uuid, foreign key)\n- name (text)\n- project_type (enum: 'residential_single', 'residential_multi', \n  'commercial_office', 'commercial_retail', 'hotel', 'industrial', \n  'renovation', 'other')\n- status (enum: 'bidding', 'active', 'wrapping_up', 'complete', 'inferred')\n- estimated_value (numeric)\n- inferred_from (text â€” e.g. 'buying_pattern', 'email_mention', 'rep_note')\n- start_date (date)\n- end_date (date)\n- expected_categories (jsonb â€” array of {category_name, expected_spend})\n- actual_spend_to_date (numeric)\n- created_at (timestamptz)\n\nTABLE: categories\n- id (uuid, primary key)\n- organization_id (uuid, foreign key)\n- name (text â€” e.g. 'Copper Fittings', 'PVC Pipe', 'HVAC Filters')\n- trade_relevance (text array â€” which trade types use this category)\n- baseline_spend_by_trade (jsonb â€” {hvac: 28000, plumbing: 45000, etc.})\n\nTABLE: contractor_category_spend\n- id (uuid, primary key)\n- contractor_id (uuid, foreign key)\n- category_id (uuid, foreign key)\n- organization_id (uuid, foreign key)\n- current_spend (numeric)\n- potential_spend (numeric)\n- gap_percentage (numeric)\n- gap_dollars (numeric)\n- last_order_date (date)\n- days_since_order (integer)\n- trend (enum: 'growing', 'declining', 'stable', 'new_gap')\n- monthly_spend_history (jsonb â€” last 12 months: \n  [{month: '2025-01', spend: 4200}, ...])\n\nTABLE: interactions\n- id (uuid, primary key)\n- contractor_id (uuid, foreign key)\n- contact_id (uuid, foreign key, nullable)\n- organization_id (uuid, foreign key)\n- rep_user_id (uuid, foreign key to auth.users)\n- interaction_type (enum: 'email_sent', 'email_received', 'call', 'visit', \n  'playbook_action', 'order_placed', 'system_flag')\n- subject (text)\n- content (text)\n- sentiment (enum: 'positive', 'neutral', 'negative', 'buying_signal', \n  'competitor_mention', 'project_mention', 'at_risk_signal')\n- ai_summary (text)\n- ai_extracted_intel (jsonb)\n- outcome (text)\n- follow_up_required (boolean)\n- follow_up_date (date)\n- source (enum: 'email', 'manual', 'system', 'order_data')\n- created_at (timestamptz)\n\nTABLE: competitors\n- id (uuid, primary key)\n- organization_id (uuid, foreign key)\n- name (text)\n- categories_competing_in (text array)\n- win_rate_against (numeric)\n- notes (text)\n\nTABLE: contractor_competitors\n- id (uuid, primary key)\n- contractor_id (uuid, foreign key)\n- competitor_id (uuid, foreign key)\n- categories_lost (text array)\n- detected_via (enum: 'email_mention', 'rep_note', 'gap_analysis')\n- confidence (enum: 'confirmed', 'suspected')\n- first_detected_at (timestamptz)\n\nTABLE: playbooks\n- id (uuid, primary key)\n- contractor_id (uuid, foreign key)\n- organization_id (uuid, foreign key)\n- rep_user_id (uuid, foreign key)\n- status (enum: 'active', 'completed', 'paused', 'archived')\n- priority (enum: 'urgent', 'high', 'normal')\n- playbook_type (enum: 'category_winback', 'new_category', 'project_based', \n  'at_risk_retention', 'graduation_push')\n- target_categories (text array)\n- target_revenue_increase (numeric)\n- ai_generated_content (jsonb â€” contains call_script, email_draft, \n  talking_points, objection_handling, category_sequence, success_indicators, \n  risk_factors)\n- tasks (jsonb â€” array of {task, due_date, completed, completed_at})\n- tasks_pending_count (integer)\n- created_at (timestamptz)\n- updated_at (timestamptz)\n\nTABLE: playbook_outcomes\n- id (uuid, primary key)\n- playbook_id (uuid, foreign key)\n- contractor_id (uuid, foreign key)\n- category_id (uuid, foreign key, nullable)\n- organization_id (uuid, foreign key)\n- action_taken (text)\n- action_date (date)\n- spend_before (numeric)\n- spend_after (numeric)\n- measurement_date (date)\n- revenue_delta (numeric)\n- was_successful (boolean)\n- notes (text)\n- created_at (timestamptz)\n\nTABLE: rep_daily_briefings\n- id (uuid, primary key)\n- rep_user_id (uuid, foreign key)\n- organization_id (uuid, foreign key)\n- briefing_date (date)\n- briefing_content (jsonb)\n- email_sent_at (timestamptz)\n- created_at (timestamptz)\n\nTABLE: query_log\n- id (uuid, primary key)\n- rep_user_id (uuid, foreign key)\n- organization_id (uuid, foreign key)\n- question (text)\n- scope (text)\n- contractor_id (uuid, nullable)\n- response (text)\n- created_at (timestamptz)\n\nTABLE: organization_settings\n- id (uuid, primary key)\n- organization_id (uuid, foreign key, unique)\n- crm_webhook_url (text)\n- gmail_oauth_token (text)\n- outlook_oauth_token (text)\n- resend_from_email (text)\n- briefing_send_time (time, default '07:00:00')\n- briefing_timezone (text, default 'America/New_York')\n- active_rep_user_ids (uuid array)\n- created_at (timestamptz)\n- updated_at (timestamptz)\n\nTABLE: crm_sync_queue\n- id (uuid, primary key)\n- organization_id (uuid, foreign key)\n- contractor_id (uuid, foreign key)\n- event_type (text)\n- formatted_note (text)\n- webhook_url (text)\n- sent_at (timestamptz, nullable â€” null means pending)\n- created_at (timestamptz)\n\nEnable pgvector extension before creating the contractors table so the \nembedding column is supported.\n\nCreate all appropriate indexes:\n- GIN indexes on all jsonb columns\n- btree indexes on all foreign keys\n- btree indexes on frequently queried columns (enrollment_status, \n  opportunity_score, trade_type, created_at)\n- ivfflat index on contractors.embedding for approximate nearest neighbor \n  search with vector_cosine_ops\n\nWrite RLS policies so authenticated users only see data belonging to their \norganization_id. Use a helper function get_user_organization_id() that \nretrieves the organization for the authenticated user.\n\nOutput as a single SQL migration file ready to run in Supabase SQL editor.\n```\n\n---\n\n## Phase 2: Relationship Graph & Vector Similarity\n\n```\nUsing the project context above, and assuming Phase 0 and Phase 1 tables \nexist, implement Layer 2: the Relationship Graph and vector similarity.\n\nPART A: Relationship tables\n\nCreate these additional tables:\n\nTABLE: contractor_project_categories\n(links a project to the categories it is expected to consume vs actual spend)\n- id (uuid, primary key)\n- project_id (uuid, foreign key to projects)\n- category_id (uuid, foreign key to categories)\n- contractor_id (uuid, foreign key)\n- organization_id (uuid, foreign key)\n- expected_spend (numeric)\n- actual_spend (numeric)\n- gap (numeric, computed as expected_spend - actual_spend)\n- status (enum: 'open', 'filled', 'partial')\n- created_at (timestamptz)\n\nTABLE: similar_contractor_pairs\n(pre-computed similarity cache, refreshed weekly by pg_cron)\n- id (uuid, primary key)\n- organization_id (uuid, foreign key)\n- contractor_id_a (uuid, foreign key)\n- contractor_id_b (uuid, foreign key)\n- similarity_score (numeric 0-1)\n- similarity_basis (jsonb â€” which dimensions drove similarity:\n  {trade_type_match: true, revenue_tier_match: true, \n   category_overlap: 0.72, geography_match: false})\n- computed_at (timestamptz)\n\nPART B: Edge Function â€” generate-contractor-embedding\n\nCreate /functions/generate-contractor-embedding that:\n\n1. Accepts { contractor_id } in request body\n2. Queries Supabase to build a rich text representation:\n   - \"Contractor: [name]. Trade type: [trade_type]. Annual revenue: $[amount].\n     Wallet share: [%]. Enrollment status: [status]. \n     Top category gaps: [category1] $[gap1] gap, [category2] $[gap2] gap, \n     [category3] $[gap3] gap.\n     Buying pattern: [seasonality summary â€” peak months, slow months].\n     Project types: [any projects].\n     Opportunity score: [score].\"\n3. Calls OpenAI text-embedding-3-small to generate a 1536-dimension vector\n   (use OPENAI_API_KEY stored as Supabase secret)\n4. Upserts the vector into contractors.embedding\n5. Returns { success: true, contractor_id }\n\nPART C: Edge Function â€” find-similar-contractors\n\nCreate /functions/find-similar-contractors that:\n\n1. Accepts { contractor_id, limit: 5 } in request body\n2. Queries pgvector using cosine similarity:\n   SELECT id, name, trade_type, enrollment_status, \n   1 - (embedding <=> target_embedding) as similarity_score\n   FROM contractors\n   WHERE organization_id = [org] AND id != [contractor_id]\n   ORDER BY embedding <=> target_embedding\n   LIMIT [limit]\n3. For each result, constructs a human-readable similarity explanation\n4. Upserts results into similar_contractor_pairs\n5. Returns the array of similar contractors with scores and explanations\n\nPART D: Postgres Function â€” assemble_contractor_context\n\nCreate a Postgres function assemble_contractor_context(p_contractor_id uuid)\nthat returns JSONB containing everything the agent needs:\n\n{\n  contractor: { all fields from contractors },\n  contacts: [ all contacts for this contractor ],\n  category_gaps: [ \n    contractor_category_spend records joined with category names, \n    sorted by gap_dollars DESC, \n    include trend and days_since_order \n  ],\n  recent_interactions: [ last 10 interactions, newest first ],\n  active_playbook: { \n    playbook record if status = 'active',\n    include ai_generated_content and tasks \n  },\n  active_projects: [ projects where status != 'complete' ],\n  similar_contractors: [ \n    top 3 from similar_contractor_pairs,\n    include their enrollment_status and graduated_at,\n    include their most successful playbook_type from playbook_outcomes \n  ],\n  competitor_intel: [ contractor_competitors joined with competitors ],\n  risk_signals: [ \n    interactions where sentiment in ('at_risk_signal', 'competitor_mention')\n    and created_at > now() - interval '30 days'\n  ],\n  agent_context: {\n    agent_state: current agent_state record for this organization,\n    relevant_learnings: top 5 playbook_learnings matching this contractor's\n                        trade_type, sorted by evidence_count DESC\n  }\n}\n\nThis function is the single source of truth for all Claude context assembly.\nEvery Edge Function that reasons about a specific contractor must call this \nfunction rather than assembling context ad hoc.\n```\n\n---\n\n## Phase 3: Agent Loop Edge Functions\n\n```\nUsing the project context above, and assuming Phases 0, 1, and 2 are \ncomplete, implement Layer 3: the Agent Loop as six Supabase Edge Functions.\n\nUse @anthropic-ai/sdk for all Claude calls. Use @resend/node for email.\nStore API keys as Supabase secrets: ANTHROPIC_API_KEY, RESEND_API_KEY.\n\nAll Edge Functions must:\n1. Begin by calling get_core_system_prompt() and using it as the base of \n   their Claude system prompt\n2. Read the current agent_state for their run_type at the start of execution\n3. Include agent_state.pattern_notes and agent_state.open_questions in the \n   Claude context\n4. Append this instruction to every system prompt: \"At the end of your \n   response, include a JSON block with key 'agent_memo' containing: \n   last_run_summary (string, 2-4 sentences), current_focus (string), \n   pattern_notes_addition (string â€” new observations to append with today's \n   date, or empty string if none), anomalies_watching (array of \n   {account_name, signal, watch_until_date})\"\n5. Parse the agent_memo from Claude's response and write it back to \n   agent_state\n\n---\n\nFUNCTION 1: generate-playbook\nPath: /functions/generate-playbook\nTrigger: Database webhook on playbooks INSERT, or direct HTTP POST from \nfrontend when rep clicks Enroll.\n\nLogic:\n1. Receive { contractor_id, playbook_type } in request body\n2. Call assemble_contractor_context(contractor_id)\n3. Query playbook_learnings for learnings relevant to this trade_type and \n   playbook_type (limit 5, ordered by evidence_count DESC)\n4. Query similar_contractor_pairs for graduated similar accounts and retrieve \n   their most successful playbook actions from playbook_outcomes\n5. Build Claude prompt combining core system prompt + function prompt below:\n\nFUNCTION-SPECIFIC SYSTEM PROMPT ADDITION:\n\"You are generating a personalized sales playbook for a territory manager in \nMEP wholesale distribution. The playbook must be grounded entirely in \ntransaction data and relationship history from this specific contractor's \nrecord.\n\nApply these proven learnings from this distributor's historical outcomes:\n[INSERT relevant playbook_learnings rows here]\n\nSimilar accounts that graduated successfully: [INSERT similar contractor \ngraduation data here]\n\nOutput ONLY a valid JSON object with this exact structure â€” no preamble, \nno explanation outside the JSON:\n{\n  priority_action: {\n    action: string,\n    reason: string (must reference a specific dollar amount or category),\n    expected_outcome: string,\n    urgency: 'immediate' | 'this_week' | 'this_month'\n  },\n  call_script: {\n    opening: string,\n    gap_reference: string (specific: 'Your copper fittings spend is $12.4K \n                   against a $45K potential â€” that is a $32.6K gap'),\n    value_proposition: string,\n    objection_handling: [{ objection: string, response: string }],\n    close: string\n  },\n  email_draft: {\n    subject: string,\n    body: string,\n    personalization_notes: string\n  },\n  talking_points: [ string (3-5 items, each grounded in their data) ],\n  category_sequence: [\n    { category: string, rationale: string, timing: string }\n  ],\n  success_indicators: [ string ],\n  risk_factors: [ string ],\n  agent_memo: { ... }\n}\"\n\n6. Parse Claude's JSON response\n7. Strip agent_memo, write it to agent_state\n8. Update the playbook record: set ai_generated_content to the parsed result, \n   set status = 'active'\n9. Return the complete playbook to the caller\n\n---\n\nFUNCTION 2: daily-briefing\nPath: /functions/daily-briefing\nTrigger: pg_cron at '0 12 * * 1-5' (7am EST / noon UTC weekdays)\n\nLogic:\n1. Query all organizations with active reps in organization_settings\n2. For each organization, for each active_rep_user_id:\n   a. Query all enrolled accounts for this rep\n   b. For each account, call assemble_contractor_context()\n   c. Apply priority rules to generate a pre-scored priority list:\n      - URGENT: category with 30-day historical cycle is now 45+ days \n        with no order\n      - HIGH: competitor_mention sentiment in interactions in last 7 days\n      - HIGH: wallet_share_direction = 'declining' for 60+ days\n      - NORMAL: playbook task due today or overdue\n      - OPPORTUNITY: unenrolled contractor with opportunity_score >= 80 \n        and no interaction in last 30 days\n   d. Build Claude prompt with all context bundles and priority scores\n\nFUNCTION-SPECIFIC SYSTEM PROMPT ADDITION:\n\"You are generating a morning briefing for a wholesale distribution territory \nmanager. They have [N] enrolled accounts. Review the context provided and \ngenerate a focused, actionable briefing they can read in under 2 minutes.\n\nYour briefing must:\n- Lead with the single most important action and why it matters TODAY\n- Reference specific dollar amounts and category names â€” never vague language\n- Sound like advice from a knowledgeable colleague who has reviewed all their \n  accounts, not like a software report\n- Flag at-risk signals prominently\n- Be direct: one action per item, not a menu of options\n\nOutput ONLY valid JSON:\n{\n  headline_action: {\n    account_name: string,\n    action: string,\n    reason: string (specific data reference required),\n    urgency: string,\n    suggested_script: string (2-3 sentences they can say verbatim)\n  },\n  priority_items: [\n    {\n      rank: integer,\n      account_name: string,\n      action: string,\n      context: string,\n      expected_outcome: string,\n      quick_script: string\n    }\n  ],\n  watch_list: [\n    {\n      account_name: string,\n      signal: string,\n      recommended_response: string\n    }\n  ],\n  opportunity_nudge: {\n    account_name: string,\n    opportunity_score: integer,\n    reason_to_act_today: string\n  },\n  program_pulse: string (one sentence on overall program health),\n  agent_memo: { ... }\n}\"\n\n3. Format the JSON as clean HTML email using Resend's template system\n4. Send via Resend to rep's email address using organization_settings\n   .resend_from_email as sender\n5. Write record to rep_daily_briefings\n6. Update agent_state for 'daily-briefing'\n\n---\n\nFUNCTION 3: email-intelligence\nPath: /functions/email-intelligence\nTrigger: Database webhook on interactions INSERT where source = 'email'\n\nLogic:\n1. Receive the new interaction record id\n2. Fetch the full interaction record\n3. Call assemble_contractor_context(contractor_id)\n4. Build Claude prompt:\n\nFUNCTION-SPECIFIC SYSTEM PROMPT ADDITION:\n\"You are analyzing an email between a wholesale distributor territory manager \nand a contractor. Extract all intelligence relevant to wallet share expansion.\n\nSentiment classification â€” choose the MOST SPECIFIC that applies:\nbuying_signal | project_mention | competitor_mention | at_risk_signal | \npositive | neutral | negative\n\nFor project_mentions: extract project type, scale indicators, and timeline \nif mentioned.\nFor competitor_mentions: extract competitor name and which categories they \nappear to be winning.\nFor buying_signals: extract which categories or products the contractor \nexpressed interest in.\n\nOutput ONLY valid JSON:\n{\n  sentiment: string,\n  ai_summary: string (2 sentences maximum â€” factual, no speculation),\n  extracted_intel: {\n    project_mentions: [{ type: string, scale: string, timeline: string }],\n    competitor_mentions: [{ name: string, categories: [string] }],\n    buying_signals: [{ category: string, signal: string }],\n    objections: [string],\n    categories_mentioned: [string]\n  },\n  recommended_action: string,\n  follow_up_required: boolean,\n  follow_up_date: string (ISO date if applicable, else null),\n  urgency: 'immediate' | 'this_week' | 'routine',\n  agent_memo: { ... }\n}\"\n\n5. Update the interaction record: set ai_summary, ai_extracted_intel, \n   sentiment, follow_up_required, follow_up_date\n6. If project_mentions is non-empty: INSERT a new project record with \n   status = 'inferred', inferred_from = 'email_mention'\n7. If competitor_mentions is non-empty: UPSERT contractor_competitors with \n   confidence = 'suspected', detected_via = 'email_mention'\n8. If sentiment = 'at_risk_signal' OR urgency = 'immediate':\n   - Query the rep's email from auth.users\n   - Send immediate alert via Resend with subject: \n     \"âš ï¸ At-Risk Signal â€” [contractor name]\"\n   - Include the ai_summary and recommended_action in the email body\n9. Update agent_state\n\n---\n\nFUNCTION 4: ask-anything\nPath: /functions/ask-anything\nTrigger: Direct HTTP POST from frontend (synchronous, rep is waiting)\n\nRequest body: { \n  question: string, \n  scope: 'account' | 'portfolio' | 'program',\n  contractor_id?: uuid,\n  rep_user_id: uuid,\n  organization_id: uuid\n}\n\nLogic:\n1. If scope = 'account' and contractor_id provided:\n   Call assemble_contractor_context(contractor_id)\n2. If scope = 'portfolio':\n   Assemble summary stats: all enrolled accounts, their wallet_share_percentage, \n   direction, gap totals, active playbooks count, tasks pending count\n3. If scope = 'program':\n   Assemble: graduation rate, avg days to graduation, playbook_outcomes \n   success rates by type and trade, top performing rep, ICP performance data\n\nFUNCTION-SPECIFIC SYSTEM PROMPT ADDITION:\n\"You are a sales intelligence assistant answering a question from a wholesale \ndistribution territory manager. Answer conversationally but ground every \nanswer in specific data from the context provided.\n\nRules:\n- If a question requires data not in the provided context, say so clearly \n  rather than speculating\n- Most answers should be 2-4 sentences unless a detailed breakdown is \n  explicitly requested\n- Always end with one suggested action if relevant\n- Do not use bullet points in responses â€” write in natural, direct sentences\n  as a knowledgeable colleague would speak\"\n\n4. Call Claude with streaming enabled\n5. Stream the response back to the frontend as server-sent events\n6. After streaming completes, log question + response to query_log table\n7. Note: agent_memo is NOT required for this function â€” it is a real-time \n   query, not a scheduled review\n\n---\n\nFUNCTION 5: weekly-account-review\nPath: /functions/weekly-account-review\nTrigger: pg_cron at '0 11 * * 1' (6am EST / 11am UTC Monday)\n\nLogic:\n1. Query all enrolled contractors across all organizations\n2. For each contractor, call assemble_contractor_context()\n3. Build Claude prompt including relevant playbook_learnings\n\nFUNCTION-SPECIFIC SYSTEM PROMPT ADDITION:\n\"You are conducting a weekly intelligence review of an enrolled account. \nAnalyze all available data and produce a structured assessment.\n\nApply these proven learnings when making recommendations:\n[INSERT top 5 relevant playbook_learnings]\n\nAssess:\n1. Graduation readiness: Is this account approaching its target wallet share \n   penetration? What remains?\n2. Playbook effectiveness: Is the current playbook producing measurable results?\n   Should it be rotated?\n3. Pattern changes: What changed in the last 30 days vs the 30 days prior?\n4. Peer comparison: How does this account's trajectory compare to similar \n   accounts that graduated?\n5. Risk assessment: Are there any signals that warrant changing the \n   enrollment_status to at_risk?\n\nOutput ONLY valid JSON:\n{\n  graduation_readiness: {\n    ready: boolean,\n    current_penetration: number,\n    target_penetration: number,\n    estimated_days_to_graduation: integer,\n    blocking_categories: [string]\n  },\n  playbook_assessment: {\n    is_working: boolean,\n    evidence: string,\n    recommendation: 'continue' | 'rotate' | 'escalate',\n    rotation_suggestion: string (if recommendation != continue)\n  },\n  pattern_changes: string,\n  peer_comparison: string,\n  risk_assessment: {\n    change_status: boolean,\n    new_status: string (if change_status true),\n    reason: string\n  },\n  weekly_priority_action: {\n    action: string,\n    rationale: string\n  },\n  agent_memo: { ... }\n}\"\n\n4. For each account:\n   - Update wallet_share_direction based on monthly_spend_history trend\n   - If risk_assessment.change_status = true: update enrollment_status\n   - If graduation_readiness.ready = true: \n     * Update enrollment_status to 'graduated', set graduated_at = now()\n     * Create a system interaction record: type = 'system_flag', \n       content = 'Account flagged as graduation-ready by weekly review'\n     * Send congratulations email to rep via Resend\n   - If playbook_assessment.recommendation = 'rotate':\n     * Archive current playbook\n     * Create new playbook record to trigger generate-playbook webhook\n5. Recalculate opportunity_score for any accounts with significant changes\n6. Trigger generate-contractor-embedding for accounts that changed meaningfully\n7. Update agent_state for 'weekly-account-review'\n\n---\n\nFUNCTION 6: crm-sync-push\nPath: /functions/crm-sync-push\nTrigger: Database webhook on playbook_outcomes INSERT, or on contractors \nUPDATE where enrollment_status changes\n\nLogic:\n1. Receive the triggering event (outcome logged or status changed)\n2. Fetch contractor record and most recent playbook\n3. Generate a clean, structured CRM note (no Claude call needed â€” \n   this is templated):\n\n\"[ISO Date] â€” Wallet Share Expander Update\nAccount: [contractor name] ([trade_type])\nStatus: [enrollment_status] | Wallet Share: [%] (Target: [baseline]%)\nRecent Action: [last playbook task completed]\nOutcome: [revenue_delta if available, else 'Pending measurement']\nAI Assessment: [weekly_priority_action from most recent agent_state, \n                truncated to 100 chars]\nNext Action: [next incomplete task from playbook, with due_date]\nâ€”â€”\nGenerated by Wallet Share Expander | [timestamp]\"\n\n4. INSERT record into crm_sync_queue with the formatted note and \n   the organization's crm_webhook_url from organization_settings\n5. If crm_webhook_url is configured: POST the note to that URL\n   with a standard payload: { account_name, note, event_type, timestamp }\n6. Update crm_sync_queue.sent_at on success, log error on failure\n\n---\n\nFUNCTION 7: health-check\nPath: /functions/health-check\nTrigger: Direct HTTP GET (admin dashboard)\n\nLogic:\n1. Check ANTHROPIC_API_KEY is set and valid (make a minimal test call)\n2. Check RESEND_API_KEY is set\n3. Verify pg_cron jobs are registered (query cron.job table)\n4. Verify database webhooks are active\n5. Query agent_state for each run_type â€” return last_run_at for each\n6. Count: enrolled accounts, active playbooks, pending crm_sync_queue rows\n7. Return structured status JSON for admin dashboard panel\n```\n\n---\n\n## Phase 4: Frontend Integration\n\n```\nUsing the project context above, and assuming Phases 0-3 are complete, add \nthe following React UI components to surface the agentic intelligence layer. \nMatch the existing UI style: clean card-based design, blue primary color, \nopportunity score badges, progress bar style gap indicators.\n\nCOMPONENT 1: Contractor Dossier Panel\nA slide-out drawer that appears when any contractor card is clicked anywhere \nin the app.\n\nSections (in order, top to bottom):\n- Header: contractor name, trade type badge, opportunity score badge, \n  enrollment status badge with appropriate color (enrolled=blue, \n  at_risk=red, graduated=green)\n- Gap Summary: top 3 category gaps with progress bars matching existing \n  UI style, showing current/potential and gap percentage\n- Active Playbook Card:\n  * Priority action prominently displayed with urgency badge\n  * Two primary buttons: \"Send Email\" and \"View Call Script\"\n  * \"Send Email\" opens the Email Composer Modal pre-populated with \n    ai_generated_content.email_draft\n  * \"View Call Script\" opens a modal with the full call_script from \n    ai_generated_content\n  * Task checklist below with completion checkboxes\n  * Completing a task opens a micro-prompt: \"Did this lead to an order?\" \n    with Yes/No and optional notes field, which writes to playbook_outcomes\n- Similar Accounts: 2-3 cards showing similar contractors, their status, \n  and what worked for them (from similar_contractor_pairs)\n- Recent Interactions: timeline of last 5 interactions with sentiment \n  color badges (green=positive/buying_signal, yellow=neutral, \n  red=negative/at_risk, orange=competitor_mention, blue=project_mention)\n- Active Projects: any projects with status != complete, showing type \n  and inferred_from\n- Competitor Intel: list of detected competitors with categories they \n  are winning, confidence badge\n- Rep Notes: free-text input that creates an interaction record on save \n  (type='call', source='manual')\n\nData: call /functions/assemble_contractor_context via Supabase RPC on open.\n\nCOMPONENT 2: Ask Anything Bar\nPersistent bar in the dashboard header, always visible.\n\nBehavior:\n- Placeholder text cycles through: \"Which accounts are most at risk this \n  week?\" / \"What is the best angle for [last viewed account]?\" / \"How is \n  my program performing vs last month?\"\n- Scope selector: Account / Portfolio / Program (auto-detects from question \n  context but user can override)\n- On submit: POST to /functions/ask-anything, stream response\n- Response appears inline below the bar in a dismissible panel\n- Show a subtle \"Powered by transaction data from [N] enrolled accounts\" \n  attribution below the response\n- Log all questions (already handled by the Edge Function)\n\nCOMPONENT 3: Daily Briefing Card\nDashboard home â€” top card, above the Account Discovery list.\n\nLayout:\n- Headline action: large text, account name + action + urgency badge\n- \"Your most important action today\" label\n- Below headline: 2-3 priority items as compact rows with quick-action \n  buttons (opens Dossier Panel for that account)\n- Watch list: red warning banner if any at-risk accounts, collapsible\n- \"View Full Briefing\" link that shows the complete briefing_content \n  from rep_daily_briefings for today\n- If no briefing yet today: show \"Briefing arrives at 7am\" with yesterday's \n  briefing collapsed below\n\nData: query rep_daily_briefings for today's date on dashboard load.\n\nCOMPONENT 4: Email Composer Modal\nTriggered by \"Send Email\" button in the Dossier Panel.\n\nFeatures:\n- Subject pre-populated from playbook email_draft.subject\n- Body pre-populated from playbook email_draft.body\n- Personalization notes shown as helper text below body (from \n  email_draft.personalization_notes) â€” styled as italic helper text, \n  not part of the email\n- Editable â€” rep can modify anything before sending\n- Send button: \n  * Sends via connected Gmail/Outlook OAuth (use existing OAuth tokens \n    from organization_settings)\n  * Creates an interaction record: type='email_sent', source='email', \n    content = final sent body\n  * Webhook on this INSERT triggers email-intelligence function automatically\n- After send: prompt \"Set a follow-up reminder?\" with date picker that \n  creates a follow_up_date on a new interaction record\n\nCOMPONENT 5: Program Performance Dashboard\nNew tab or section accessible from main nav: \"Program Performance\"\n\nMetrics displayed:\n- Total enrolled / graduated / at_risk counts\n- Average wallet share growth for enrolled accounts\n- Average days to graduation\n- Playbook success rate (from playbook_outcomes.was_successful)\n- Revenue generated from graduated accounts (sum of revenue_delta)\n- Top performing playbook type by success rate\n- Category win rate: which categories are being captured most successfully\n- Rep leaderboard if multi-rep organization\n\nAll metrics should have comparison to prior period (last 30 vs prior 30 days).\n\nData: query playbook_outcomes, contractors, and playbook_learnings tables \ndirectly from frontend via Supabase client.\n```\n\n---\n\n## Phase 5: Scheduling & Webhook Configuration\n\n```\nUsing the project context above, and assuming Phases 0-4 are complete, \nset up all scheduling and webhook infrastructure.\n\nPART A: pg_cron scheduled jobs\n\nWrite SQL to create these cron jobs (enable pg_cron extension first):\n\n-- Daily briefing: weekdays 7am EST (noon UTC)\nSELECT cron.schedule(\n  'daily-briefing',\n  '0 12 * * 1-5',\n  $$ SELECT net.http_post(\n    url := current_setting('app.supabase_url') || '/functions/v1/daily-briefing',\n    headers := '{\"Authorization\": \"Bearer ' || \n               current_setting('app.service_role_key') || '\"}'::jsonb\n  ) $$\n);\n\nCreate equivalent schedules for:\n-- Weekly account review: Monday 6am EST (11am UTC)\n-- Synthesize learnings: 1st of each month, 3am EST (8am UTC)  \n-- Refresh embeddings: Sunday 2am EST (7am UTC) â€” for contractors \n   updated in the past 7 days\n-- Refresh similar pairs: Sunday 3am EST (8am UTC)\n-- CRM sync retry: every 4 hours â€” retry any crm_sync_queue rows \n   where sent_at is null and created_at > now() - interval '7 days'\n\nPART B: Database webhooks\n\nWrite SQL or Supabase dashboard instructions to create webhooks for:\n\n1. interactions INSERT where source = 'email'\n   â†’ POST to /functions/email-intelligence\n   â†’ Filter: NEW.source = 'email'\n\n2. playbooks INSERT\n   â†’ POST to /functions/generate-playbook\n   â†’ No filter (all new playbooks)\n\n3. contractors UPDATE where enrollment_status changes\n   â†’ POST to /functions/crm-sync-push\n   â†’ Filter: OLD.enrollment_status IS DISTINCT FROM NEW.enrollment_status\n\n4. playbook_outcomes INSERT\n   â†’ POST to /functions/crm-sync-push\n\nAll webhooks should include the service role key in Authorization header.\n\nPART C: Environment variables and secrets\n\nList all secrets that must be configured in Supabase Dashboard â†’ \nSettings â†’ Edge Functions â†’ Secrets:\n\n- ANTHROPIC_API_KEY\n- RESEND_API_KEY  \n- OPENAI_API_KEY (for embeddings via text-embedding-3-small)\n- SUPABASE_URL (auto-provided)\n- SUPABASE_SERVICE_ROLE_KEY (auto-provided)\n\nPART D: Supabase database settings\n\nAdd these to the database settings via SQL:\n\nALTER DATABASE postgres SET app.supabase_url = 'https://[project-ref].supabase.co';\n\nWrite a database function notify_webhook(table_name text, record jsonb) \nthat standardizes how all webhook payloads are structured, ensuring every \nwebhook call includes: event_type, table_name, record, organization_id, \nand timestamp.\n\nPART E: Testing checklist SQL\n\nWrite SQL queries to verify the full system is wired correctly:\n1. Verify pg_cron jobs are registered: SELECT * FROM cron.job;\n2. Verify pgvector is enabled: SELECT * FROM pg_extension WHERE extname = 'vector';\n3. Verify agent_state has a row for each function type\n4. Verify system_prompts has active core_agent_identity row\n5. Verify playbook_learnings has seed data\n6. Test assemble_contractor_context with a sample contractor_id\n7. Test find-similar-contractors Edge Function with a direct HTTP call\n8. Verify RLS policies: confirm a user cannot select data from another \n   organization\n```\n\n---\n\n## Reference: System Prompt Architecture\n\nEvery Edge Function builds its system prompt in this order:\n\n```\n1. get_core_system_prompt()          â† The soul (Phase 0)\n2. agent_state.pattern_notes         â† Recent cross-account observations\n3. agent_state.open_questions        â† Things being monitored  \n4. relevant playbook_learnings       â† What has worked historically\n5. Function-specific instructions    â† The task for this specific call\n6. agent_memo instruction            â† Request to write back to heartbeat\n```\n\nThis layering ensures every Claude call has: identity, continuity, memory, \ntask, and a mechanism to update its own state. No call starts cold.\n\n---\n\n## Reference: Data Flow Diagram\n\n```\nTRIGGER (pg_cron or DB webhook)\n         â†“\nEDGE FUNCTION starts\n         â†“\nREAD: get_core_system_prompt() + agent_state + playbook_learnings\n         â†“\nASSEMBLE: assemble_contractor_context(contractor_id)\n         â†“\nCALL: Claude API (core prompt + agent state + context + function prompt)\n         â†“\nPARSE: extract structured JSON output + agent_memo\n         â†“\nWRITE: update Supabase tables (playbooks, interactions, contractors, etc.)\nWRITE: update agent_state with agent_memo\nSEND: email via Resend (if applicable)\nPUSH: crm_sync_queue (if applicable)\n         â†“\nRETURN: response to caller (frontend or void for scheduled)\n```\n\n---\n\n## Reference: Key Design Decisions\n\n**Why no n8n:** All orchestration is native to Supabase via Edge Functions, \npg_cron, and database webhooks. This eliminates a dependency, reduces \noperational complexity, and keeps all logic in one platform.\n\n**Why not Neo4j:** The relationship graph is implemented as well-structured \nrelational tables in Postgres with pgvector for semantic similarity. Claude \nperforms the graph traversal reasoning in its context window from structured \nJSON assembled by assemble_contractor_context(). This avoids graph sparsity \ndegradation and operational complexity while achieving equivalent intelligence \nfor this narrow vertical use case.\n\n**Why transaction data over conversation data:** Unlike Sybill.ai which \nlearns from calls and emails, this system's ground truth is purchase orders. \nTransaction data does not rationalize, forget, or sugarcoat. A 72% gap in \ncopper fittings is a fact regardless of what the contractor said on the last \ncall.\n\n**Why project as a first-class entity:** Contractors do not buy on a calendar \ncycle â€” they buy on a project cycle. Modeling projects explicitly allows the \nagent to predict future demand gaps before they appear in the transaction \ndata, moving from reactive to predictive.\n\n---\n\n*End of specification. Version 1.0 â€” generated February 2026.*\n*For Wallet Share Expander by Tenexity Inc.*\n","path":null,"size_bytes":48669,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"/{*path}\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1541,"size_tokens":null},"security-two.md":{"content":"# COMPREHENSIVE CODE REVIEW\n\nYou are an expert code reviewer performing a thorough multi-dimensional analysis. Review the code in this project/file systematically through each of the following lenses, providing specific findings with file paths and line numbers where applicable.\n\n---\n\n## 1. SECURITY VULNERABILITIES (Critical Priority)\n\nAnalyze for security risks using OWASP Top 10 as your framework:\n\n**Injection Attacks:**\n- SQL injection: Look for string concatenation in queries, unsanitized user input in database calls\n- XSS (Cross-Site Scripting): Check for unescaped user input rendered in HTML/JS\n- Command injection: Find any system/shell commands using user input\n- NoSQL injection, LDAP injection, ORM injection patterns\n\n**Authentication & Authorization:**\n- Hardcoded credentials, API keys, or secrets\n- Weak password policies or insecure session management\n- Missing or improper access control checks\n- Insecure token handling (JWT issues, predictable tokens)\n\n**Data Exposure:**\n- Sensitive data in logs, error messages, or URLs\n- Missing encryption for data at rest or in transit\n- Overly permissive CORS or security headers\n- Information leakage through verbose errors\n\n**Dependency Risks:**\n- Known vulnerabilities in imported packages/libraries\n- Outdated dependencies with security patches available\n- Unused dependencies that expand attack surface\n\n---\n\n## 2. PERFORMANCE ISSUES\n\nIdentify code that will cause slowdowns or scalability problems:\n\n**Database Performance:**\n- N+1 query patterns (queries inside loops)\n- Missing database indexes on frequently queried fields\n- Unbounded queries without LIMIT/pagination\n- Inefficient JOINs or subqueries\n\n**Algorithmic Efficiency:**\n- Nested loops that could be O(nÂ²) or worse\n- Repeated calculations that should be cached/memoized\n- Inefficient data structure choices (e.g., arrays where sets/maps would be better)\n- Blocking operations in async contexts\n\n**Resource Management:**\n- Memory leaks (unclosed connections, event listeners, streams)\n- Large objects kept in memory unnecessarily\n- Missing connection pooling\n- Synchronous operations that should be async\n\n**Caching Opportunities:**\n- Repeated expensive computations\n- API calls that could be cached\n- Static data fetched repeatedly\n\n---\n\n## 3. BUG DETECTION\n\nFind logic errors and edge cases that will cause failures:\n\n**Logic Errors:**\n- Off-by-one errors in loops and array indexing\n- Incorrect boolean logic (AND/OR confusion, negation errors)\n- Type coercion issues (especially in JavaScript/TypeScript)\n- Race conditions in concurrent code\n\n**Edge Cases:**\n- Null/undefined handling (missing null checks)\n- Empty arrays/collections handling\n- Boundary conditions (zero, negative numbers, max values)\n- Division by zero possibilities\n- Empty string vs null distinctions\n\n**Error Scenarios:**\n- Unhandled promise rejections\n- Missing try/catch blocks around risky operations\n- Swallowed exceptions that hide failures\n- Incomplete error recovery logic\n\n**State Management:**\n- Mutable state shared across components/functions\n- State not properly reset between operations\n- Stale closures capturing outdated values\n\n---\n\n## 4. CODE STYLE & READABILITY\n\nEvaluate maintainability and adherence to conventions:\n\n**Naming:**\n- Variables/functions with unclear or misleading names\n- Inconsistent naming conventions (camelCase vs snake_case mixing)\n- Single-letter variables outside of obvious contexts\n- Abbreviations that obscure meaning\n\n**Structure:**\n- Functions exceeding ~50 lines (candidates for extraction)\n- Excessive nesting depth (>3-4 levels)\n- God classes/functions doing too many things\n- Magic numbers/strings that should be constants\n\n**Formatting:**\n- Inconsistent indentation or spacing\n- Missing or excessive blank lines\n- Line lengths exceeding project standards\n- Inconsistent brace/bracket styles\n\n**Code Smells:**\n- Duplicated code that should be abstracted\n- Dead code (unreachable or unused)\n- Commented-out code blocks\n- TODO/FIXME comments indicating incomplete work\n\n---\n\n## 5. TEST COVERAGE\n\nAssess testing adequacy and quality:\n\n**Coverage Gaps:**\n- Functions/classes with no corresponding tests\n- Critical paths (authentication, payments, data mutations) lacking tests\n- Edge cases not covered by existing tests\n- Error paths not tested\n\n**Test Quality:**\n- Tests that don't actually assert anything meaningful\n- Overly brittle tests coupled to implementation details\n- Missing mocks for external dependencies\n- Tests that pass even when code is broken\n\n**Testing Patterns:**\n- Missing unit tests for business logic\n- Missing integration tests for component interactions\n- Missing E2E tests for critical user flows\n- Absence of negative test cases (testing what should fail)\n\n---\n\n## 6. DOCUMENTATION\n\nEvaluate code documentation and knowledge transfer readiness:\n\n**Code Comments:**\n- Complex logic lacking explanatory comments\n- Outdated comments that no longer match the code\n- Missing JSDoc/docstrings for public APIs\n- Comments explaining \"what\" instead of \"why\"\n\n**API Documentation:**\n- Missing or incomplete endpoint documentation\n- Unclear parameter descriptions and types\n- Missing examples for complex operations\n- Undocumented error responses\n\n**Architecture Documentation:**\n- Missing README with setup instructions\n- Undocumented environment variables\n- Unclear module responsibilities and boundaries\n- Missing data flow or sequence diagrams for complex processes\n\n---\n\n## 7. ARCHITECTURE & DESIGN PATTERNS\n\nEvaluate structural soundness and maintainability:\n\n**SOLID Principles:**\n- Single Responsibility violations (classes/functions doing too much)\n- Open/Closed violations (requiring modification instead of extension)\n- Liskov Substitution issues in inheritance hierarchies\n- Interface Segregation problems (fat interfaces)\n- Dependency Inversion issues (high-level modules depending on low-level details)\n\n**Separation of Concerns:**\n- Business logic mixed with presentation code\n- Database queries scattered throughout codebase\n- Cross-cutting concerns (logging, auth) not properly abstracted\n- Tight coupling between modules\n\n**Design Patterns:**\n- Missing patterns that would simplify the code\n- Overengineered patterns where simple solutions would work\n- Inconsistent pattern usage across similar problems\n- Anti-patterns (God objects, circular dependencies, etc.)\n\n---\n\n## 8. ERROR HANDLING & RESILIENCE\n\nEvaluate robustness under failure conditions:\n\n**Error Handling:**\n- Missing error handling for I/O operations\n- Generic catch blocks that swallow specific errors\n- Inconsistent error response formats\n- Missing error logging\n\n**Resilience:**\n- Missing retry logic for transient failures\n- No timeout handling for external calls\n- Missing circuit breakers for failing dependencies\n- No graceful degradation strategies\n\n**Recovery:**\n- Incomplete rollback logic for failed transactions\n- Missing cleanup in error paths\n- Partial state corruption possible on failures\n\n---\n\n## OUTPUT FORMAT\n\nFor each category, provide:\n\n1. **CRITICAL** issues (must fix before deployment)\n2. **HIGH** issues (should fix soon)\n3. **MEDIUM** issues (fix when time permits)\n4. **LOW** issues (suggestions for improvement)\n\nFor each finding include:\n- File path and line number(s)\n- Description of the issue\n- Why it matters (impact)\n- Recommended fix with code example if helpful\n\n---\n\n## SUMMARY\n\nAfter reviewing all categories, provide:\n1. Executive summary (2-3 sentences on overall code health)\n2. Top 5 most critical issues to address\n3. Estimated technical debt score (1-10, where 10 is excellent)\n4. Recommended priority order for fixes","path":null,"size_bytes":7613,"size_tokens":null},"client/src/components/score-badge.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ScoreBadgeProps {\n  score: number;\n  maxScore?: number;\n  showLabel?: boolean;\n  size?: \"sm\" | \"default\";\n  testId?: string;\n}\n\nexport function ScoreBadge({\n  score,\n  maxScore = 100,\n  showLabel = true,\n  size = \"default\",\n  testId,\n}: ScoreBadgeProps) {\n  const percentage = (score / maxScore) * 100;\n\n  let variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" = \"secondary\";\n  let label = \"Low\";\n\n  if (percentage >= 75) {\n    variant = \"default\";\n    label = \"High\";\n  } else if (percentage >= 50) {\n    variant = \"secondary\";\n    label = \"Medium\";\n  } else if (percentage >= 25) {\n    variant = \"outline\";\n    label = \"Low\";\n  } else {\n    variant = \"destructive\";\n    label = \"Critical\";\n  }\n\n  return (\n    <Badge\n      variant={variant}\n      className={cn(\n        size === \"sm\" && \"text-xs px-1.5 py-0\"\n      )}\n      data-testid={testId}\n    >\n      {score.toFixed(0)}\n      {showLabel && ` - ${label}`}\n    </Badge>\n  );\n}\n","path":null,"size_bytes":1035,"size_tokens":null},"vitest.config.ts":{"content":"import { defineConfig } from 'vitest/config';\nimport path from 'path';\n\nexport default defineConfig({\n  test: {\n    globals: true,\n    environment: 'node',\n    include: ['tests/**/*.test.ts'],\n    coverage: {\n      provider: 'v8',\n      reporter: ['text', 'json', 'html'],\n      include: ['server/**/*.ts'],\n      exclude: ['server/vite.ts', 'server/index.ts'],\n    },\n    testTimeout: 10000,\n  },\n  resolve: {\n    alias: {\n      '@shared': path.resolve(__dirname, './shared'),\n      '@server': path.resolve(__dirname, './server'),\n    },\n  },\n});\n","path":null,"size_bytes":548,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"tests/e2e/real-auth-routes.test.ts":{"content":"import { describe, it, expect, beforeAll, vi, afterAll } from 'vitest';\nimport express, { Express } from 'express';\nimport { createServer, Server } from 'http';\nimport request from 'supertest';\n\nconst mockOidcConfig = {\n  metadata: {\n    issuer: 'https://test.example.com',\n    authorization_endpoint: 'https://test.example.com/authorize',\n    token_endpoint: 'https://test.example.com/token',\n    end_session_endpoint: 'https://test.example.com/logout',\n  },\n  serverMetadata: () => ({\n    issuer: 'https://test.example.com',\n  }),\n};\n\nvi.mock('openid-client', () => ({\n  discovery: vi.fn().mockResolvedValue(mockOidcConfig),\n  buildEndSessionUrl: vi.fn(() => new URL('https://test.example.com/logout')),\n}));\n\nvi.mock('openid-client/passport', () => {\n  return {\n    Strategy: vi.fn().mockImplementation(function(this: any, options: any, verify: any) {\n      this.name = options.name || 'test-strategy';\n      this._verify = verify;\n      return this;\n    }),\n  };\n});\n\nvi.mock('passport', () => {\n  const strategies: Map<string, any> = new Map();\n  \n  return {\n    default: {\n      initialize: vi.fn(() => (req: any, _res: any, next: any) => {\n        req._passport = { instance: {} };\n        next();\n      }),\n      session: vi.fn(() => (req: any, _res: any, next: any) => {\n        next();\n      }),\n      use: vi.fn((strategy: any) => {\n        strategies.set(strategy.name, strategy);\n      }),\n      serializeUser: vi.fn(),\n      deserializeUser: vi.fn(),\n      authenticate: vi.fn((strategyName: string, options: any) => {\n        return (req: any, res: any, next: any) => {\n          if (options?.failureRedirect) {\n            res.redirect('/');\n          } else {\n            res.redirect('/oauth/authorize');\n          }\n        };\n      }),\n    },\n  };\n});\n\nvi.mock('connect-pg-simple', () => {\n  const EventEmitter = require('events');\n  return {\n    default: vi.fn(() => {\n      return class MockStore extends EventEmitter {\n        constructor(_options: any) {\n          super();\n        }\n        get(_sid: string, callback: any) { callback(null, null); }\n        set(_sid: string, _session: any, callback: any) { callback(null); }\n        destroy(_sid: string, callback: any) { callback(null); }\n        touch(_sid: string, _session: any, callback: any) { callback(null); }\n      };\n    }),\n  };\n});\n\nvi.mock('../../server/replit_integrations/auth/storage', () => ({\n  authStorage: {\n    upsertUser: vi.fn(),\n  },\n}));\n\nprocess.env.DATABASE_URL = 'postgresql://test:test@localhost:5432/test';\nprocess.env.SESSION_SECRET = 'test-secret-for-testing-only';\nprocess.env.REPL_ID = 'test-repl-id';\nprocess.env.ISSUER_URL = 'https://test.example.com';\n\ndescribe('Real Auth Routes with setupAuth', () => {\n  let app: Express;\n  let server: Server;\n\n  beforeAll(async () => {\n    app = express();\n    server = createServer(app);\n    app.use(express.json());\n    \n    const { setupAuth } = await import('../../server/replit_integrations/auth/replitAuth');\n    await setupAuth(app);\n  });\n\n  afterAll(() => {\n    server.close();\n  });\n\n  describe('Auth route registration', () => {\n    it('/api/login route is registered and uses rate limiter', async () => {\n      const res = await request(app).get('/api/login');\n      \n      expect([200, 302]).toContain(res.status);\n      expect(res.headers['ratelimit-limit']).toBe('10');\n    });\n\n    it('/api/callback route is registered and uses rate limiter', async () => {\n      const res = await request(app).get('/api/callback');\n      \n      expect([200, 302]).toContain(res.status);\n      expect(res.headers['ratelimit-limit']).toBe('10');\n    });\n\n    it('/api/logout route is registered and uses rate limiter', async () => {\n      const res = await request(app)\n        .get('/api/logout')\n        .set('Cookie', 'connect.sid=test-session');\n      \n      expect(res.headers['ratelimit-limit']).toBe('5');\n    });\n  });\n\n  describe('Rate limiter enforcement on real routes', () => {\n    it('/api/login returns 429 after exceeding limit of 10 requests', async () => {\n      const freshApp = express();\n      const freshServer = createServer(freshApp);\n      freshApp.use(express.json());\n      \n      const { setupAuth: freshSetupAuth } = await import('../../server/replit_integrations/auth/replitAuth');\n      await freshSetupAuth(freshApp);\n\n      const responses: number[] = [];\n      for (let i = 0; i < 12; i++) {\n        const res = await request(freshApp).get('/api/login');\n        responses.push(res.status);\n      }\n\n      const rateLimitedCount = responses.filter(s => s === 429).length;\n      expect(rateLimitedCount).toBeGreaterThanOrEqual(1);\n      \n      const lastResponse = await request(freshApp).get('/api/login');\n      expect(lastResponse.status).toBe(429);\n      expect(lastResponse.body.message).toBe('Too many authentication attempts, please try again later');\n      \n      freshServer.close();\n    });\n\n    it('/api/logout returns 429 after exceeding limit of 5 requests', async () => {\n      const freshApp = express();\n      const freshServer = createServer(freshApp);\n      freshApp.use(express.json());\n      \n      const { setupAuth: freshSetupAuth } = await import('../../server/replit_integrations/auth/replitAuth');\n      await freshSetupAuth(freshApp);\n\n      for (let i = 0; i < 6; i++) {\n        await request(freshApp).get('/api/logout');\n      }\n\n      const res = await request(freshApp).get('/api/logout');\n      \n      expect(res.status).toBe(429);\n      expect(res.body.message).toBe('Too many logout attempts, please try again later');\n      \n      freshServer.close();\n    });\n  });\n\n  describe('Middleware chain verification', () => {\n    it('passport is initialized', async () => {\n      const passport = (await import('passport')).default;\n      expect(passport.initialize).toHaveBeenCalled();\n    });\n\n    it('passport session is configured', async () => {\n      const passport = (await import('passport')).default;\n      expect(passport.session).toHaveBeenCalled();\n    });\n\n    it('routes use passport.authenticate', async () => {\n      const passport = (await import('passport')).default;\n      \n      await request(app).get('/api/login');\n      expect(passport.authenticate).toHaveBeenCalled();\n    });\n  });\n\n  describe('Rate limit headers validation', () => {\n    it('/api/login includes all standard rate limit headers', async () => {\n      const res = await request(app).get('/api/login');\n      \n      expect(res.headers['ratelimit-limit']).toBeDefined();\n      expect(res.headers['ratelimit-remaining']).toBeDefined();\n      expect(res.headers['ratelimit-reset']).toBeDefined();\n    });\n\n    it('/api/logout includes all standard rate limit headers', async () => {\n      const res = await request(app).get('/api/logout');\n      \n      expect(res.headers['ratelimit-limit']).toBeDefined();\n      expect(res.headers['ratelimit-remaining']).toBeDefined();\n      expect(res.headers['ratelimit-reset']).toBeDefined();\n    });\n  });\n});\n","path":null,"size_bytes":6945,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5741,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1592,"size_tokens":null},"client/src/components/feature-mockups.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport {\n  TrendingUp,\n  Users,\n  Target,\n  Mail,\n  Phone,\n  CheckCircle,\n  Clock,\n  BarChart3,\n  Building2,\n  ArrowUpRight,\n  Sparkles,\n  GraduationCap,\n  HelpCircle,\n  ShieldAlert,\n  AlertTriangle,\n  Crosshair,\n  UserCheck,\n  Radar,\n  Zap,\n} from \"lucide-react\";\n\nconst mockAccounts = [\n  { name: \"Metro HVAC Solutions\", segment: \"HVAC Contractor\", score: 92, revenue: \"$142,500\", penetration: \"34%\", enrolled: true },\n  { name: \"Summit Mechanical\", segment: \"Mechanical\", score: 87, revenue: \"$98,200\", penetration: \"28%\", enrolled: false },\n  { name: \"Pacific Plumbing Pro\", segment: \"Plumbing\", score: 85, revenue: \"$76,800\", penetration: \"41%\", enrolled: true },\n  { name: \"Valley General Contractors\", segment: \"General Contractor\", score: 82, revenue: \"$234,100\", penetration: \"22%\", enrolled: false },\n  { name: \"Mountain Air Systems\", segment: \"HVAC Contractor\", score: 79, revenue: \"$67,400\", penetration: \"38%\", enrolled: true },\n];\n\nconst mockCategories = [\n  { name: \"Copper Fittings\", current: 12400, potential: 45000, gap: 72 },\n  { name: \"PVC Pipe\", current: 8900, potential: 32000, gap: 72 },\n  { name: \"HVAC Filters\", current: 15600, potential: 28000, gap: 44 },\n  { name: \"Ductwork\", current: 22000, potential: 35000, gap: 37 },\n  { name: \"Thermostats\", current: 9800, potential: 14000, gap: 30 },\n];\n\nconst mockICPData = [\n  { segment: \"HVAC Contractor\", avgRevenue: \"$145K\", categories: 8, topCategory: \"Ductwork\" },\n  { segment: \"Plumbing\", avgRevenue: \"$98K\", categories: 6, topCategory: \"Copper Fittings\" },\n  { segment: \"Mechanical\", avgRevenue: \"$210K\", categories: 10, topCategory: \"Motors & Drives\" },\n  { segment: \"General Contractor\", avgRevenue: \"$178K\", categories: 7, topCategory: \"Safety Equipment\" },\n];\n\nexport function MockupDashboard() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-6 w-6 rounded bg-primary flex items-center justify-center\">\n            <TrendingUp className=\"h-3.5 w-3.5 text-primary-foreground\" />\n          </div>\n          <span className=\"font-semibold text-sm\">Wallet Share Expander</span>\n        </div>\n        <Badge variant=\"secondary\" className=\"text-xs\">Dashboard</Badge>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-3\">\n        <Card className=\"p-3\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Total Accounts</p>\n              <p className=\"text-xl font-bold\">25</p>\n            </div>\n            <Users className=\"h-5 w-5 text-muted-foreground\" />\n          </div>\n        </Card>\n        <Card className=\"p-3\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Enrolled</p>\n              <p className=\"text-xl font-bold text-primary\">8</p>\n            </div>\n            <Target className=\"h-5 w-5 text-primary\" />\n          </div>\n        </Card>\n        <Card className=\"p-3\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Revenue Growth</p>\n              <p className=\"text-xl font-bold text-green-600\">+$142K</p>\n            </div>\n            <TrendingUp className=\"h-5 w-5 text-green-600\" />\n          </div>\n        </Card>\n        <Card className=\"p-3\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Avg. Penetration</p>\n              <p className=\"text-xl font-bold\">32%</p>\n            </div>\n            <BarChart3 className=\"h-5 w-5 text-muted-foreground\" />\n          </div>\n        </Card>\n      </div>\n\n      <Card className=\"p-3\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h3 className=\"font-semibold text-sm\">Top Opportunities</h3>\n          <Button variant=\"ghost\" size=\"sm\" className=\"h-6 text-xs\">View All</Button>\n        </div>\n        <div className=\"space-y-2\">\n          {mockAccounts.slice(0, 4).map((account, i) => (\n            <div key={i} className=\"flex items-center justify-between py-1.5 border-b last:border-0\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"h-7 w-7 rounded bg-muted flex items-center justify-center\">\n                  <Building2 className=\"h-3.5 w-3.5\" />\n                </div>\n                <div>\n                  <p className=\"font-medium text-xs\">{account.name}</p>\n                  <p className=\"text-[10px] text-muted-foreground\">{account.segment}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-right\">\n                  <p className=\"font-semibold text-xs\">{account.revenue}</p>\n                  <p className=\"text-[10px] text-muted-foreground\">{account.penetration} penetration</p>\n                </div>\n                <Badge variant={account.score >= 85 ? \"default\" : \"secondary\"} className=\"text-[10px]\">\n                  {account.score}\n                </Badge>\n              </div>\n            </div>\n          ))}\n        </div>\n      </Card>\n    </div>\n  );\n}\n\nexport function MockupEnrollment() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <h3 className=\"font-semibold\">Account Discovery</h3>\n        <Badge variant=\"outline\" className=\"text-xs\">25 Accounts Analyzed</Badge>\n      </div>\n\n      <div className=\"space-y-2\">\n        {mockAccounts.map((account, i) => (\n          <Card key={i} className={`p-3 ${account.enrolled ? 'border-primary/50 bg-primary/5' : ''}`}>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className={`h-8 w-8 rounded-lg flex items-center justify-center ${account.enrolled ? 'bg-primary text-primary-foreground' : 'bg-muted'}`}>\n                  {account.enrolled ? <CheckCircle className=\"h-4 w-4\" /> : <Building2 className=\"h-4 w-4\" />}\n                </div>\n                <div>\n                  <div className=\"flex items-center gap-2\">\n                    <p className=\"font-medium text-xs\">{account.name}</p>\n                    {account.enrolled && <Badge className=\"text-[10px] h-4\">Enrolled</Badge>}\n                  </div>\n                  <p className=\"text-[10px] text-muted-foreground\">{account.segment} â€¢ {account.revenue}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"text-right\">\n                  <div className=\"flex items-center gap-1\">\n                    <Sparkles className=\"h-3 w-3 text-amber-500\" />\n                    <span className=\"font-bold text-xs\">{account.score}</span>\n                  </div>\n                  <p className=\"text-[10px] text-muted-foreground\">Opportunity Score</p>\n                </div>\n                {!account.enrolled && (\n                  <Button size=\"sm\" className=\"h-6 text-xs\">Enroll</Button>\n                )}\n              </div>\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport function MockupGapAnalysis() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div>\n          <h3 className=\"font-semibold\">Metro HVAC Solutions</h3>\n          <p className=\"text-xs text-muted-foreground\">Gap Analysis â€¢ $142,500 current revenue</p>\n        </div>\n        <Badge className=\"text-xs\">92 Score</Badge>\n      </div>\n\n      <div className=\"grid grid-cols-3 gap-3\">\n        <Card className=\"p-3 text-center\">\n          <p className=\"text-lg font-bold text-primary\">$98,400</p>\n          <p className=\"text-[10px] text-muted-foreground\">Opportunity Value</p>\n        </Card>\n        <Card className=\"p-3 text-center\">\n          <p className=\"text-lg font-bold\">34%</p>\n          <p className=\"text-[10px] text-muted-foreground\">Current Penetration</p>\n        </Card>\n        <Card className=\"p-3 text-center\">\n          <p className=\"text-lg font-bold text-green-600\">69%</p>\n          <p className=\"text-[10px] text-muted-foreground\">Target Penetration</p>\n        </Card>\n      </div>\n\n      <Card className=\"p-3\">\n        <h4 className=\"font-semibold text-xs mb-3\">Category Gap Analysis</h4>\n        <div className=\"space-y-3\">\n          {mockCategories.map((cat, i) => (\n            <div key={i} className=\"space-y-1\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-xs font-medium\">{cat.name}</span>\n                <span className=\"text-[10px] text-muted-foreground\">\n                  ${(cat.current / 1000).toFixed(1)}K / ${(cat.potential / 1000).toFixed(1)}K potential\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Progress value={100 - cat.gap} className=\"h-2 flex-1\" />\n                <Badge variant={cat.gap > 50 ? \"destructive\" : \"secondary\"} className=\"text-[10px] w-12 justify-center\">\n                  {cat.gap}% gap\n                </Badge>\n              </div>\n            </div>\n          ))}\n        </div>\n      </Card>\n    </div>\n  );\n}\n\nexport function MockupICPBuilder() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div>\n          <h3 className=\"font-semibold\">ICP Builder</h3>\n          <p className=\"text-xs text-muted-foreground\">AI-Generated Ideal Customer Profiles</p>\n        </div>\n        <Badge variant=\"secondary\" className=\"text-xs\">4 Segments</Badge>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-3\">\n        {mockICPData.map((icp, i) => (\n          <Card key={i} className=\"p-3\">\n            <div className=\"flex items-start justify-between mb-2\">\n              <div>\n                <h4 className=\"font-semibold text-xs\">{icp.segment}</h4>\n                <p className=\"text-[10px] text-muted-foreground\">Ideal Customer Profile</p>\n              </div>\n              <Sparkles className=\"h-4 w-4 text-amber-500\" />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-[10px]\">\n                <span className=\"text-muted-foreground\">Avg. Revenue</span>\n                <span className=\"font-semibold\">{icp.avgRevenue}</span>\n              </div>\n              <div className=\"flex justify-between text-[10px]\">\n                <span className=\"text-muted-foreground\">Category Count</span>\n                <span className=\"font-semibold\">{icp.categories} categories</span>\n              </div>\n              <div className=\"flex justify-between text-[10px]\">\n                <span className=\"text-muted-foreground\">Top Category</span>\n                <span className=\"font-semibold\">{icp.topCategory}</span>\n              </div>\n            </div>\n            <div className=\"mt-2 pt-2 border-t\">\n              <Badge variant=\"outline\" className=\"text-[10px]\">View Full Profile</Badge>\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport function MockupRevenue() {\n  const enrolledAccounts = [\n    { name: \"Metro HVAC Solutions\", enrolled: \"Jan 15\", baseline: \"$142.5K\", current: \"$168.2K\", growth: \"+18%\", progress: 72 },\n    { name: \"Pacific Plumbing Pro\", enrolled: \"Jan 8\", baseline: \"$76.8K\", current: \"$89.4K\", growth: \"+16%\", progress: 65 },\n    { name: \"Mountain Air Systems\", enrolled: \"Jan 22\", baseline: \"$67.4K\", current: \"$74.1K\", growth: \"+10%\", progress: 45 },\n  ];\n\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div>\n          <h3 className=\"font-semibold\">Revenue Tracking</h3>\n          <p className=\"text-xs text-muted-foreground\">Enrolled Account Performance</p>\n        </div>\n        <Badge className=\"text-xs bg-green-600\">+$42.9K Growth</Badge>\n      </div>\n\n      <div className=\"grid grid-cols-3 gap-3\">\n        <Card className=\"p-3 text-center\">\n          <p className=\"text-lg font-bold\">8</p>\n          <p className=\"text-[10px] text-muted-foreground\">Enrolled Accounts</p>\n        </Card>\n        <Card className=\"p-3 text-center\">\n          <p className=\"text-lg font-bold text-green-600\">+15%</p>\n          <p className=\"text-[10px] text-muted-foreground\">Avg. Growth Rate</p>\n        </Card>\n        <Card className=\"p-3 text-center\">\n          <p className=\"text-lg font-bold\">2</p>\n          <p className=\"text-[10px] text-muted-foreground\">Ready to Graduate</p>\n        </Card>\n      </div>\n\n      <Card className=\"p-3\">\n        <h4 className=\"font-semibold text-xs mb-3\">Account Progress</h4>\n        <div className=\"space-y-3\">\n          {enrolledAccounts.map((account, i) => (\n            <div key={i} className=\"space-y-1.5 pb-2 border-b last:border-0\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"h-6 w-6 rounded bg-primary/10 flex items-center justify-center\">\n                    <Building2 className=\"h-3 w-3 text-primary\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium text-xs\">{account.name}</p>\n                    <p className=\"text-[10px] text-muted-foreground\">Enrolled {account.enrolled}</p>\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"font-semibold text-xs text-green-600\">{account.growth}</p>\n                  <p className=\"text-[10px] text-muted-foreground\">{account.baseline} â†’ {account.current}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Progress value={account.progress} className=\"h-1.5 flex-1\" />\n                <span className=\"text-[10px] text-muted-foreground w-8\">{account.progress}%</span>\n              </div>\n            </div>\n          ))}\n        </div>\n      </Card>\n    </div>\n  );\n}\n\nexport function MockupPlaybooks() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div>\n          <h3 className=\"font-semibold\">AI Playbooks</h3>\n          <p className=\"text-xs text-muted-foreground\">Customized Action Plans</p>\n        </div>\n        <Badge variant=\"secondary\" className=\"text-xs\">4 Active Playbooks</Badge>\n      </div>\n\n      <Card className=\"p-3 border-primary/30 bg-primary/5\">\n        <div className=\"flex items-start justify-between mb-3\">\n          <div>\n            <div className=\"flex items-center gap-2\">\n              <h4 className=\"font-semibold text-xs\">Metro HVAC Solutions</h4>\n              <Badge className=\"text-[10px]\">Priority</Badge>\n            </div>\n            <p className=\"text-[10px] text-muted-foreground\">HVAC Contractor â€¢ $98,400 opportunity</p>\n          </div>\n          <Sparkles className=\"h-4 w-4 text-amber-500\" />\n        </div>\n\n        <div className=\"space-y-2 mb-3\">\n          <div className=\"flex items-start gap-2 p-2 rounded bg-background border\">\n            <Phone className=\"h-3.5 w-3.5 text-primary mt-0.5\" />\n            <div>\n              <p className=\"font-medium text-[10px]\">Call Script: Copper Fittings Expansion</p>\n              <p className=\"text-[10px] text-muted-foreground line-clamp-2\">\n                \"Hi [Contact], I noticed you've been growing your HVAC installations. I wanted to share how our copper fitting packages...\"\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-start gap-2 p-2 rounded bg-background border\">\n            <Mail className=\"h-3.5 w-3.5 text-primary mt-0.5\" />\n            <div>\n              <p className=\"font-medium text-[10px]\">Email: New Product Introduction</p>\n              <p className=\"text-[10px] text-muted-foreground line-clamp-2\">\n                \"Subject: Exclusive pricing on HVAC filter bundles for Metro HVAC Solutions...\"\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex items-center justify-between pt-2 border-t\">\n          <div className=\"flex items-center gap-2\">\n            <Clock className=\"h-3 w-3 text-muted-foreground\" />\n            <span className=\"text-[10px] text-muted-foreground\">3 tasks pending</span>\n          </div>\n          <Button size=\"sm\" className=\"h-6 text-xs\">View Full Playbook</Button>\n        </div>\n      </Card>\n\n      <div className=\"grid grid-cols-2 gap-2\">\n        {[\n          { name: \"Pacific Plumbing Pro\", tasks: 2, segment: \"Plumbing\" },\n          { name: \"Mountain Air Systems\", tasks: 4, segment: \"HVAC\" },\n        ].map((playbook, i) => (\n          <Card key={i} className=\"p-2.5\">\n            <div className=\"flex items-center gap-2 mb-1.5\">\n              <div className=\"h-5 w-5 rounded bg-muted flex items-center justify-center\">\n                <Building2 className=\"h-2.5 w-2.5\" />\n              </div>\n              <div>\n                <p className=\"font-medium text-[10px]\">{playbook.name}</p>\n                <p className=\"text-[9px] text-muted-foreground\">{playbook.segment}</p>\n              </div>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-[10px] text-muted-foreground\">{playbook.tasks} tasks</span>\n              <ArrowUpRight className=\"h-3 w-3 text-muted-foreground\" />\n            </div>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n\nconst mockGraduatedAccounts = [\n  {\n    name: \"Mountain Air HVAC\",\n    segment: \"HVAC\",\n    daysEnrolled: 90,\n    baseline: 201000,\n    graduation: 245000,\n    growth: 44000,\n    icpSuccess: 80\n  },\n  {\n    name: \"Great Lakes Heating\",\n    segment: \"HVAC\",\n    daysEnrolled: 75,\n    baseline: 169000,\n    graduation: 199000,\n    growth: 30000,\n    icpSuccess: 67\n  },\n];\n\nexport function MockupGraduationSuccess() {\n  const totalGraduated = mockGraduatedAccounts.length;\n  const incrementalRevenue = mockGraduatedAccounts.reduce((sum, acc) => sum + acc.growth, 0);\n  const avgDays = Math.round(mockGraduatedAccounts.reduce((sum, acc) => sum + acc.daysEnrolled, 0) / totalGraduated);\n  const avgIcpSuccess = Math.round(mockGraduatedAccounts.reduce((sum, acc) => sum + acc.icpSuccess, 0) / totalGraduated);\n\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-8 w-8 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center\">\n            <GraduationCap className=\"h-4 w-4 text-amber-600 dark:text-amber-400\" />\n          </div>\n          <div>\n            <h3 className=\"font-semibold text-sm\">Graduation Success</h3>\n            <p className=\"text-[10px] text-muted-foreground\">Wallet share captured from graduated accounts</p>\n          </div>\n        </div>\n        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-view-graduates\">\n          View All Graduates\n          <ArrowUpRight className=\"h-3 w-3 ml-1\" />\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-3\">\n        <div className=\"text-center p-2.5 rounded-lg bg-muted/50\" data-testid=\"stat-graduated-count\">\n          <p className=\"text-xl font-bold text-chart-3\">{totalGraduated}</p>\n          <div className=\"flex items-center justify-center gap-1\">\n            <p className=\"text-[10px] text-muted-foreground\">Accounts Graduated</p>\n            <HelpCircle className=\"h-3 w-3 text-muted-foreground/60\" />\n          </div>\n        </div>\n        <div className=\"text-center p-2.5 rounded-lg bg-muted/50\" data-testid=\"stat-incremental-revenue\">\n          <p className=\"text-xl font-bold text-chart-1\">${Math.round(incrementalRevenue / 1000)}K</p>\n          <div className=\"flex items-center justify-center gap-1\">\n            <p className=\"text-[10px] text-muted-foreground\">Incremental Revenue</p>\n            <HelpCircle className=\"h-3 w-3 text-muted-foreground/60\" />\n          </div>\n        </div>\n        <div className=\"text-center p-2.5 rounded-lg bg-muted/50\" data-testid=\"stat-avg-days\">\n          <p className=\"text-xl font-bold\">{avgDays}</p>\n          <div className=\"flex items-center justify-center gap-1\">\n            <p className=\"text-[10px] text-muted-foreground\">Avg Days to Graduate</p>\n            <HelpCircle className=\"h-3 w-3 text-muted-foreground/60\" />\n          </div>\n        </div>\n        <div className=\"text-center p-2.5 rounded-lg bg-muted/50\" data-testid=\"stat-icp-success\">\n          <p className=\"text-xl font-bold text-chart-2\">{avgIcpSuccess}%</p>\n          <div className=\"flex items-center justify-center gap-1\">\n            <p className=\"text-[10px] text-muted-foreground\">Avg ICP Category Success</p>\n            <HelpCircle className=\"h-3 w-3 text-muted-foreground/60\" />\n          </div>\n        </div>\n      </div>\n\n      <div className=\"space-y-2\">\n        <h4 className=\"font-medium text-xs text-muted-foreground\">Recent Graduates</h4>\n        {mockGraduatedAccounts.map((account, i) => (\n          <div key={i} className=\"flex items-center gap-2\" data-testid={`graduate-row-${i}`}>\n            <div className=\"w-1 h-full min-h-[3.5rem] rounded-full bg-chart-2\" />\n            <Card className=\"flex-1 p-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"h-8 w-8 rounded-full bg-chart-2/10 flex items-center justify-center\">\n                    <CheckCircle className=\"h-4 w-4 text-chart-2\" />\n                  </div>\n                  <div>\n                    <p className=\"font-medium text-xs\" data-testid={`graduate-name-${i}`}>{account.name}</p>\n                    <p className=\"text-[10px] text-muted-foreground\">{account.segment} â€¢ {account.daysEnrolled} days enrolled</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-4 text-right\">\n                  <div>\n                    <p className=\"text-[10px] text-muted-foreground\">Baseline</p>\n                    <p className=\"font-semibold text-xs\" data-testid={`graduate-baseline-${i}`}>${Math.round(account.baseline / 1000)}K</p>\n                  </div>\n                  <div>\n                    <p className=\"text-[10px] text-muted-foreground\">At Graduation</p>\n                    <p className=\"font-semibold text-xs\" data-testid={`graduate-graduation-${i}`}>${Math.round(account.graduation / 1000)}K</p>\n                  </div>\n                  <div>\n                    <p className=\"text-[10px] text-muted-foreground\">Growth</p>\n                    <p className=\"font-bold text-xs text-green-600\" data-testid={`graduate-growth-${i}`}>+${Math.round(account.growth / 1000)}K</p>\n                  </div>\n                </div>\n              </div>\n            </Card>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n\n// â”€â”€â”€ NEW: Daily Briefing Mockup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function MockupDailyBriefing() {\n  const priorityAccounts = [\n    { name: \"Metro HVAC Solutions\", action: \"Call re: Copper Fittings proposal\", urgency: \"Today\", dot: \"bg-red-500\" },\n    { name: \"Pacific Plumbing Pro\", action: \"Follow up on last email â€” no reply in 8 days\", urgency: \"Overdue\", dot: \"bg-orange-500\" },\n    { name: \"Summit Mechanical\", action: \"Send ductwork pricing sheet\", urgency: \"This week\", dot: \"bg-blue-500\" },\n  ];\n\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div>\n          <p className=\"text-[10px] text-muted-foreground uppercase tracking-wide font-medium\">Daily Briefing â€¢ Mon Feb 17</p>\n          <h3 className=\"font-semibold text-sm mt-0.5\">Good morning, Sarah ðŸ‘‹</h3>\n        </div>\n        <Badge variant=\"secondary\" className=\"text-[10px]\">8 Enrolled Accounts</Badge>\n      </div>\n\n      <Card className=\"p-3 border-primary/20 bg-primary/5\">\n        <p className=\"text-[10px] font-medium text-primary uppercase tracking-wide mb-1\">Today's Focus</p>\n        <p className=\"text-xs text-foreground font-medium\">Metro HVAC is your highest-risk account this week. Their last order was 31 days ago â€” copper fitting gap is widening. A call today could recover ~$12K.</p>\n      </Card>\n\n      <div>\n        <p className=\"text-[10px] font-medium text-muted-foreground uppercase tracking-wide mb-2\">Priority Actions</p>\n        <div className=\"space-y-2\">\n          {priorityAccounts.map((acc, i) => (\n            <div key={i} className=\"flex items-start gap-2.5 p-2 rounded-lg border bg-background\">\n              <div className={`mt-1.5 h-2 w-2 rounded-full flex-shrink-0 ${acc.dot}`} />\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"font-medium text-xs truncate\">{acc.name}</p>\n                <p className=\"text-[10px] text-muted-foreground\">{acc.action}</p>\n              </div>\n              <Badge variant=\"outline\" className=\"text-[9px] shrink-0\">{acc.urgency}</Badge>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"flex items-center justify-between pt-1 border-t text-[10px] text-muted-foreground\">\n        <span>Generated at 7:00am EST by your AI agent</span>\n        <span className=\"text-primary font-medium cursor-pointer\">View Full Briefing â†’</span>\n      </div>\n    </div>\n  );\n}\n\n// â”€â”€â”€ NEW: Ask Anything Mockup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function MockupAskAnything() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <h3 className=\"font-semibold text-sm\">Ask Anything</h3>\n        <div className=\"flex items-center gap-1\">\n          {[\"Portfolio\", \"Account\", \"Program\"].map((scope, i) => (\n            <Badge key={i} variant={i === 0 ? \"default\" : \"outline\"} className=\"text-[10px] cursor-pointer\">{scope}</Badge>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"relative\">\n        <div className=\"flex items-center gap-2 border rounded-lg px-3 py-2 bg-muted/30\">\n          <Sparkles className=\"h-3.5 w-3.5 text-primary shrink-0\" />\n          <span className=\"text-xs text-muted-foreground\">Which accounts haven't ordered in 90+ days?</span>\n        </div>\n      </div>\n\n      <Card className=\"p-3 border-primary/20 bg-primary/5\">\n        <div className=\"flex items-center gap-1.5 mb-2\">\n          <div className=\"h-1.5 w-1.5 rounded-full bg-primary animate-pulse\" />\n          <p className=\"text-[10px] font-medium text-primary uppercase tracking-wide\">AI Response</p>\n        </div>\n        <p className=\"text-xs text-foreground leading-relaxed\">\n          <span className=\"font-semibold\">3 accounts</span> have gone 90+ days without an order:\n        </p>\n        <div className=\"mt-2 space-y-1.5\">\n          {[\n            { name: \"Valley General Contractors\", days: \"104 days\", risk: \"High\" },\n            { name: \"Summit Mechanical\", days: \"91 days\", risk: \"Med\" },\n            { name: \"Blue Ridge Plumbing\", days: \"90 days\", risk: \"Med\" },\n          ].map((acc, i) => (\n            <div key={i} className=\"flex items-center justify-between text-[10px]\">\n              <span className=\"font-medium\">{acc.name}</span>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-muted-foreground\">{acc.days} silent</span>\n                <Badge variant={acc.risk === \"High\" ? \"destructive\" : \"secondary\"} className=\"text-[9px]\">{acc.risk}</Badge>\n              </div>\n            </div>\n          ))}\n        </div>\n        <p className=\"text-[10px] text-muted-foreground mt-2\">I recommend opening their dossiers and triggering playbook reviews today.</p>\n      </Card>\n\n      <div className=\"text-[10px] text-muted-foreground text-center\">\n        Powered by your live account data Â· Answers stream in real time\n      </div>\n    </div>\n  );\n}\n\n// â”€â”€â”€ Agentic CRM Intelligence Mockup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function MockupCRMIntelligence() {\n  const threats = [\n    { competitor: \"Ferguson\", account: \"Allied Mechanical\", category: \"PVF\", level: \"critical\" as const, detail: \"15% volume discount offered on airport project\", priceGap: \"-4.6%\" },\n    { competitor: \"HD Supply\", account: \"Great Lakes Heating\", category: \"Controls\", level: \"high\" as const, detail: \"8% lower on BAS controllers for Lakeview Plaza\", priceGap: \"-8.1%\" },\n    { competitor: \"Winsupply\", account: \"Sunshine HVAC\", category: \"Refrigerant\", level: \"medium\" as const, detail: \"Comparing R-410A pricing. Delivery failure noted.\", priceGap: \"-6.1%\" },\n  ];\n\n  const signals = [\n    { account: \"Metro HVAC\", type: \"Quote Request\", product: \"Carrier 50XC Rooftop Units\", value: \"$124K\", urgency: \"immediate\" as const },\n    { account: \"Northeast H&C\", type: \"Purchase Intent\", product: \"Honeywell T6 Pro Thermostats\", value: \"$32K\", urgency: \"immediate\" as const },\n    { account: \"Buckeye Mechanical\", type: \"Pricing Inquiry\", product: \"Data Center Controls Package\", value: \"$95K\", urgency: \"this_week\" as const },\n  ];\n\n  const contacts = [\n    { name: \"Jennifer Adams\", title: \"Dir. of Purchasing\", account: \"Buckeye Mechanical\", role: \"Decision Maker\", lastContact: \"3d ago\", action: true },\n    { name: \"Robert Chang\", title: \"Owner / President\", account: \"Allied Mechanical\", role: \"Decision Maker\", lastContact: \"45d ago\", action: true },\n  ];\n\n  const threatBadge = (level: \"critical\" | \"high\" | \"medium\") => {\n    const styles = {\n      critical: \"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400 border-red-200 dark:border-red-800\",\n      high: \"bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-400 border-orange-200 dark:border-orange-800\",\n      medium: \"bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-400 border-amber-200 dark:border-amber-800\",\n    };\n    return styles[level];\n  };\n\n  const urgencyBadge = (urgency: \"immediate\" | \"this_week\") => {\n    const styles = {\n      immediate: \"bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-400 border-red-200 dark:border-red-800\",\n      this_week: \"bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-400 border-blue-200 dark:border-blue-800\",\n    };\n    return styles[urgency];\n  };\n\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-3 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"h-6 w-6 rounded bg-red-600 dark:bg-red-700 flex items-center justify-center\">\n            <Radar className=\"h-3.5 w-3.5 text-white\" />\n          </div>\n          <div>\n            <span className=\"font-semibold text-sm\">CRM Intelligence</span>\n            <p className=\"text-[10px] text-muted-foreground\">Auto-populated by AI agents</p>\n          </div>\n        </div>\n        <Badge variant=\"secondary\" className=\"text-[10px]\">Live</Badge>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-2\">\n        <Card className=\"p-2 text-center\">\n          <p className=\"text-base font-bold text-red-600 dark:text-red-400\">2</p>\n          <p className=\"text-[9px] text-muted-foreground\">Critical Threats</p>\n        </Card>\n        <Card className=\"p-2 text-center\">\n          <p className=\"text-base font-bold text-amber-600 dark:text-amber-400\">18</p>\n          <p className=\"text-[9px] text-muted-foreground\">Active Signals</p>\n        </Card>\n        <Card className=\"p-2 text-center\">\n          <p className=\"text-base font-bold\">25</p>\n          <p className=\"text-[9px] text-muted-foreground\">Contacts Tracked</p>\n        </Card>\n        <Card className=\"p-2 text-center\">\n          <p className=\"text-base font-bold text-green-600 dark:text-green-400\">$1.2M</p>\n          <p className=\"text-[9px] text-muted-foreground\">Pipeline Value</p>\n        </Card>\n      </div>\n\n      <div>\n        <div className=\"flex items-center gap-1.5 mb-1.5\">\n          <ShieldAlert className=\"h-3.5 w-3.5 text-red-600 dark:text-red-400\" />\n          <p className=\"text-[10px] font-semibold uppercase tracking-wide\">Competitor Threats</p>\n        </div>\n        <div className=\"space-y-1.5\">\n          {threats.map((t, i) => (\n            <Card key={i} className={`p-2 ${i === 0 ? 'border-red-300 dark:border-red-800 bg-red-50/50 dark:bg-red-950/20' : ''}`}>\n              <div className=\"flex items-start justify-between gap-2\">\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-1.5 mb-0.5\">\n                    <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold border ${threatBadge(t.level)}`}>\n                      {t.level === \"critical\" && <AlertTriangle className=\"h-2.5 w-2.5 mr-0.5\" />}\n                      {t.level.toUpperCase()}\n                    </span>\n                    <span className=\"text-[10px] font-semibold\">{t.competitor}</span>\n                    <span className=\"text-[10px] text-muted-foreground\">vs us</span>\n                  </div>\n                  <p className=\"text-[10px] text-muted-foreground truncate\">{t.account} - {t.detail}</p>\n                </div>\n                <div className=\"text-right shrink-0\">\n                  <p className=\"text-[10px] font-bold text-red-600 dark:text-red-400\">{t.priceGap}</p>\n                  <p className=\"text-[9px] text-muted-foreground\">{t.category}</p>\n                </div>\n              </div>\n            </Card>\n          ))}\n        </div>\n      </div>\n\n      <div>\n        <div className=\"flex items-center gap-1.5 mb-1.5\">\n          <Zap className=\"h-3.5 w-3.5 text-amber-600 dark:text-amber-400\" />\n          <p className=\"text-[10px] font-semibold uppercase tracking-wide\">Order Signals Detected</p>\n        </div>\n        <div className=\"space-y-1.5\">\n          {signals.map((s, i) => (\n            <div key={i} className=\"flex items-center gap-2 p-1.5 rounded border bg-background\">\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"flex items-center gap-1.5\">\n                  <span className=\"text-[10px] font-semibold\">{s.account}</span>\n                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold border ${urgencyBadge(s.urgency)}`}>\n                    {s.urgency === \"immediate\" ? \"NOW\" : \"THIS WEEK\"}\n                  </span>\n                </div>\n                <p className=\"text-[10px] text-muted-foreground truncate\">{s.type}: {s.product}</p>\n              </div>\n              <span className=\"text-[10px] font-bold shrink-0\">{s.value}</span>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div>\n        <div className=\"flex items-center gap-1.5 mb-1.5\">\n          <UserCheck className=\"h-3.5 w-3.5 text-primary\" />\n          <p className=\"text-[10px] font-semibold uppercase tracking-wide\">Key Contacts to Engage</p>\n        </div>\n        <div className=\"space-y-1.5\">\n          {contacts.map((c, i) => (\n            <div key={i} className=\"flex items-center justify-between p-1.5 rounded border bg-background\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"h-6 w-6 rounded-full bg-primary/10 flex items-center justify-center\">\n                  <Users className=\"h-3 w-3 text-primary\" />\n                </div>\n                <div>\n                  <p className=\"text-[10px] font-semibold\">{c.name}</p>\n                  <p className=\"text-[9px] text-muted-foreground\">{c.title} - {c.account}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-[9px] text-muted-foreground\">{c.lastContact}</span>\n                {c.action && (\n                  <Badge variant=\"outline\" className=\"text-[9px] border-primary/50 text-primary\">Action Needed</Badge>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"flex items-center justify-between pt-1 border-t text-[10px] text-muted-foreground\">\n        <div className=\"flex items-center gap-1\">\n          <Sparkles className=\"h-3 w-3 text-primary\" />\n          <span>All data auto-populated from email analysis</span>\n        </div>\n        <span className=\"text-primary font-medium cursor-pointer\">View Full CRM</span>\n      </div>\n    </div>\n  );\n}\n\n// â”€â”€â”€ NEW: Email Intelligence Mockup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function MockupEmailIntelligence() {\n  return (\n    <div className=\"bg-background rounded-lg p-4 space-y-4 text-sm border shadow-sm\">\n      <div className=\"flex items-center justify-between border-b pb-3\">\n        <div>\n          <h3 className=\"font-semibold text-sm\">Email Intelligence</h3>\n          <p className=\"text-[10px] text-muted-foreground\">AI analysis complete Â· 2 minutes ago</p>\n        </div>\n        <Badge className=\"text-[10px] bg-green-600\">Signal Detected</Badge>\n      </div>\n\n      <Card className=\"p-3 bg-muted/30 border-muted\">\n        <p className=\"text-[10px] font-medium text-muted-foreground mb-1\">Logged Email â€” Metro HVAC Solutions</p>\n        <p className=\"text-xs italic text-muted-foreground line-clamp-3\">\n          \"â€¦we've actually been getting some quotes from Ferguson on the copper side. Their pricing is competitive but the lead times are longer. Wanted to let you know before we make a final decisionâ€¦\"\n        </p>\n      </Card>\n\n      <div>\n        <p className=\"text-[10px] font-medium text-muted-foreground uppercase tracking-wide mb-2\">AI Analysis</p>\n        <div className=\"grid grid-cols-2 gap-2\">\n          <Card className=\"p-2.5\">\n            <p className=\"text-[10px] text-muted-foreground\">Sentiment</p>\n            <div className=\"flex items-center gap-1 mt-0.5\">\n              <div className=\"h-2 w-2 rounded-full bg-orange-500\" />\n              <p className=\"text-xs font-semibold\">At Risk</p>\n            </div>\n          </Card>\n          <Card className=\"p-2.5\">\n            <p className=\"text-[10px] text-muted-foreground\">Buying Signal</p>\n            <p className=\"text-xs font-semibold text-amber-600\">Decision Near</p>\n          </Card>\n          <Card className=\"p-2.5 col-span-2\">\n            <p className=\"text-[10px] text-muted-foreground mb-1\">Competitor Mentioned</p>\n            <Badge variant=\"destructive\" className=\"text-[10px]\">Ferguson â€” Copper Fittings</Badge>\n          </Card>\n        </div>\n      </div>\n\n      <Card className=\"p-2.5 border-red-500/30 bg-red-500/5\">\n        <p className=\"text-[10px] font-semibold text-red-600\">âš  Urgent Alert Sent to Rep</p>\n        <p className=\"text-[10px] text-muted-foreground mt-0.5\">Metro HVAC is evaluating a competitor. Respond within 24 hours to protect this account.</p>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":40187,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"server/replit_integrations/auth/storage.ts":{"content":"import { users, type User, type UpsertUser } from \"@shared/models/auth\";\nimport { db } from \"../../db\";\nimport { eq } from \"drizzle-orm\";\n\n// Interface for auth storage operations\n// (IMPORTANT) These user operations are mandatory for Replit Auth.\nexport interface IAuthStorage {\n  getUser(id: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n}\n\nclass AuthStorage implements IAuthStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    // First check if user exists by id\n    if (userData.id) {\n      const existingById = await this.getUser(userData.id);\n      if (existingById) {\n        const [user] = await db\n          .update(users)\n          .set({\n            ...userData,\n            updatedAt: new Date(),\n          })\n          .where(eq(users.id, userData.id))\n          .returning();\n        return user;\n      }\n    }\n\n    // Check if user exists by email (to handle re-login with different id)\n    if (userData.email) {\n      const [existingByEmail] = await db.select().from(users).where(eq(users.email, userData.email));\n      if (existingByEmail) {\n        // Update existing user, keeping original id\n        const [user] = await db\n          .update(users)\n          .set({\n            email: userData.email,\n            firstName: userData.firstName,\n            lastName: userData.lastName,\n            profileImageUrl: userData.profileImageUrl,\n            updatedAt: new Date(),\n          })\n          .where(eq(users.email, userData.email))\n          .returning();\n        return user;\n      }\n    }\n\n    // Insert new user\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .returning();\n    return user;\n  }\n}\n\nexport const authStorage = new AuthStorage();\n","path":null,"size_bytes":1913,"size_tokens":null},"server/replit_integrations/chat/index.ts":{"content":"export { registerChatRoutes } from \"./routes\";\nexport { chatStorage, type IChatStorage } from \"./storage\";\n\n","path":null,"size_bytes":108,"size_tokens":null},"client/src/pages/subscription.tsx":{"content":"import { useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { SubscriptionPlan } from \"@shared/schema\";\nimport {\n  CreditCard,\n  Check,\n  AlertCircle,\n  ExternalLink,\n  Loader2,\n  Crown,\n  Zap,\n  Building2,\n  Calendar,\n  RefreshCw,\n} from \"lucide-react\";\n\ninterface SubscriptionStatus {\n  subscriptionStatus: string;\n  planType: string;\n  billingPeriodEnd: string | null;\n  trialEndsAt: string | null;\n  canceledAt: string | null;\n  hasStripeCustomer: boolean;\n  plan: SubscriptionPlan | null;\n}\n\nconst planIcons: Record<string, typeof Crown> = {\n  starter: Zap,\n  professional: Crown,\n  enterprise: Building2,\n};\n\nfunction getPlanIcon(slug: string) {\n  return planIcons[slug] || Zap;\n}\n\nfunction getStatusBadgeVariant(status: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" {\n  switch (status) {\n    case \"active\":\n      return \"default\";\n    case \"trialing\":\n      return \"secondary\";\n    case \"past_due\":\n    case \"canceled\":\n    case \"unpaid\":\n      return \"destructive\";\n    default:\n      return \"outline\";\n  }\n}\n\nfunction formatDate(dateString: string | null): string {\n  if (!dateString) return \"N/A\";\n  return new Date(dateString).toLocaleDateString(\"en-US\", {\n    year: \"numeric\",\n    month: \"long\",\n    day: \"numeric\",\n  });\n}\n\nexport default function Subscription() {\n  const { toast } = useToast();\n  const [location] = useLocation();\n\n  const { data: subscription, isLoading: subscriptionLoading } = useQuery<SubscriptionStatus>({\n    queryKey: [\"/api/subscription\"],\n  });\n\n  const { data: plans, isLoading: plansLoading } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/subscription/plans\"],\n  });\n\n  const checkoutMutation = useMutation({\n    mutationFn: async ({ planSlug, billingCycle }: { planSlug: string; billingCycle: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/stripe/create-checkout-session\", {\n        planSlug,\n        billingCycle,\n      });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        window.location.href = data.url;\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Checkout Error\",\n        description: error.message || \"Failed to create checkout session\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const portalMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest(\"POST\", \"/api/stripe/create-portal-session\");\n      return res.json();\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        window.location.href = data.url;\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Portal Error\",\n        description: error.message || \"Failed to open billing portal\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    if (params.get(\"success\") === \"true\") {\n      toast({\n        title: \"Subscription Activated\",\n        description: \"Your subscription is now active. Thank you for subscribing!\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/subscription\"] });\n      window.history.replaceState({}, \"\", \"/subscription\");\n    } else if (params.get(\"canceled\") === \"true\") {\n      toast({\n        title: \"Checkout Canceled\",\n        description: \"Your checkout was canceled. No charges were made.\",\n        variant: \"destructive\",\n      });\n      window.history.replaceState({}, \"\", \"/subscription\");\n    }\n  }, [toast]);\n\n  const isLoading = subscriptionLoading || plansLoading;\n  const hasActiveSubscription = subscription?.subscriptionStatus === \"active\" || subscription?.subscriptionStatus === \"trialing\";\n  const currentPlanSlug = subscription?.planType || \"free\";\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-full items-center justify-center p-8\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col gap-6 p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"text-subscription-title\">\n            Subscription & Billing\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Manage your subscription plan and billing settings\n          </p>\n        </div>\n        {subscription?.hasStripeCustomer && (\n          <Button\n            variant=\"outline\"\n            onClick={() => portalMutation.mutate()}\n            disabled={portalMutation.isPending}\n            data-testid=\"button-manage-billing\"\n          >\n            {portalMutation.isPending ? (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            ) : (\n              <CreditCard className=\"mr-2 h-4 w-4\" />\n            )}\n            Manage Billing\n            <ExternalLink className=\"ml-2 h-3 w-3\" />\n          </Button>\n        )}\n      </div>\n\n      {hasActiveSubscription && subscription?.plan && (\n        <Card data-testid=\"card-current-plan\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                {(() => {\n                  const Icon = getPlanIcon(subscription.planType);\n                  return <Icon className=\"h-6 w-6 text-primary\" />;\n                })()}\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    {subscription.plan.name} Plan\n                    <Badge variant={getStatusBadgeVariant(subscription.subscriptionStatus)}>\n                      {subscription.subscriptionStatus}\n                    </Badge>\n                  </CardTitle>\n                  <CardDescription>\n                    Your current subscription plan\n                  </CardDescription>\n                </div>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div className=\"flex items-center gap-3 p-3 rounded-md bg-muted/50\">\n                <Calendar className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Next Billing Date</p>\n                  <p className=\"font-medium\" data-testid=\"text-billing-date\">\n                    {formatDate(subscription.billingPeriodEnd)}\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-3 p-3 rounded-md bg-muted/50\">\n                <CreditCard className=\"h-5 w-5 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Monthly Price</p>\n                  <p className=\"font-medium\" data-testid=\"text-plan-price\">\n                    ${subscription.plan.monthlyPrice}/mo\n                  </p>\n                </div>\n              </div>\n              {subscription.canceledAt && (\n                <div className=\"flex items-center gap-3 p-3 rounded-md bg-destructive/10\">\n                  <AlertCircle className=\"h-5 w-5 text-destructive\" />\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Cancels On</p>\n                    <p className=\"font-medium text-destructive\">\n                      {formatDate(subscription.canceledAt)}\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {subscription.plan.features && (\n              <>\n                <Separator className=\"my-4\" />\n                <div>\n                  <h4 className=\"text-sm font-medium mb-3\">Plan Features</h4>\n                  <ul className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n                    {(subscription.plan.features as string[]).map((feature, index) => (\n                      <li key={index} className=\"flex items-center gap-2 text-sm\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        <span>{feature}</span>\n                      </li>\n                    ))}\n                  </ul>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {!hasActiveSubscription && (\n        <Card className=\"border-primary/20 bg-primary/5\" data-testid=\"card-no-subscription\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <AlertCircle className=\"h-5 w-5\" />\n              No Active Subscription\n            </CardTitle>\n            <CardDescription>\n              Choose a plan below to get started with all features\n            </CardDescription>\n          </CardHeader>\n        </Card>\n      )}\n\n      <div>\n        <h2 className=\"text-lg font-semibold mb-4\">Available Plans</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          {plans?.map((plan) => {\n            const Icon = getPlanIcon(plan.slug);\n            const isCurrentPlan = currentPlanSlug === plan.slug && hasActiveSubscription;\n            const features = plan.features as string[] | null;\n\n            return (\n              <Card\n                key={plan.id}\n                className={isCurrentPlan ? \"border-primary\" : \"\"}\n                data-testid={`card-plan-${plan.slug}`}\n              >\n                <CardHeader>\n                  <div className=\"flex items-center gap-2\">\n                    <Icon className=\"h-5 w-5 text-primary\" />\n                    <CardTitle>{plan.name}</CardTitle>\n                    {isCurrentPlan && (\n                      <Badge variant=\"secondary\" className=\"ml-auto\">Current</Badge>\n                    )}\n                  </div>\n                  <CardDescription>\n                    <span className=\"text-2xl font-bold text-foreground\">\n                      ${plan.monthlyPrice}\n                    </span>\n                    <span className=\"text-muted-foreground\">/month</span>\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {features && (\n                    <ul className=\"space-y-2\">\n                      {features.slice(0, 5).map((feature, index) => (\n                        <li key={index} className=\"flex items-start gap-2 text-sm\">\n                          <Check className=\"h-4 w-4 text-primary mt-0.5 shrink-0\" />\n                          <span>{feature}</span>\n                        </li>\n                      ))}\n                      {features.length > 5 && (\n                        <li className=\"text-sm text-muted-foreground\">\n                          +{features.length - 5} more features\n                        </li>\n                      )}\n                    </ul>\n                  )}\n                </CardContent>\n                <CardFooter>\n                  {isCurrentPlan ? (\n                    <Button variant=\"outline\" className=\"w-full\" disabled>\n                      Current Plan\n                    </Button>\n                  ) : (\n                    <Button\n                      className=\"w-full\"\n                      onClick={() => checkoutMutation.mutate({ planSlug: plan.slug, billingCycle: \"monthly\" })}\n                      disabled={checkoutMutation.isPending}\n                      data-testid={`button-subscribe-${plan.slug}`}\n                    >\n                      {checkoutMutation.isPending ? (\n                        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                      ) : hasActiveSubscription ? (\n                        <>\n                          <RefreshCw className=\"mr-2 h-4 w-4\" />\n                          Switch to {plan.name}\n                        </>\n                      ) : (\n                        <>Subscribe to {plan.name}</>\n                      )}\n                    </Button>\n                  )}\n                </CardFooter>\n              </Card>\n            );\n          })}\n        </div>\n        <p className=\"text-xs text-muted-foreground mt-4 text-center\">\n          Annual billing available with 2 months free. Contact us for Enterprise pricing.\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12564,"size_tokens":null},"client/src/pages/landing.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ThemeToggle } from \"@/components/theme-toggle\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { SubscriptionPlan } from \"@shared/schema\";\nimport walletExpanderLogo from \"@assets/WalletExpander_logo_1769615587162.png\";\nimport heroConstructionWide from \"@assets/hero-construction-wide.png\";\nimport {\n  TrendingUp,\n  Target,\n  Users,\n  BarChart3,\n  Zap,\n  Shield,\n  CheckCircle,\n  ArrowRight,\n  Play,\n  DollarSign,\n  PieChart,\n  FileText,\n  Mail,\n  Building2,\n  ChevronRight,\n  Check,\n  UserCheck,\n  ClipboardList,\n  Loader2,\n  Crown,\n  GraduationCap,\n  Trophy,\n  Sparkles,\n} from \"lucide-react\";\n\nimport {\n  MockupDashboard,\n  MockupEnrollment,\n  MockupGapAnalysis,\n  MockupICPBuilder,\n  MockupRevenue,\n  MockupPlaybooks,\n  MockupGraduationSuccess,\n  MockupDailyBriefing,\n  MockupAskAnything,\n  MockupEmailIntelligence,\n  MockupCRMIntelligence,\n} from \"@/components/feature-mockups\";\n\nimport Tenexity_Official_Logo_BW_Cirlce from \"@assets/Tenexity Official Logo BW Cirlce.png\";\n\nconst showcaseFeatures = [\n  {\n    id: \"enrollment\",\n    badge: \"Smart Account Discovery\",\n    title: \"Find Your Highest-Potential Accounts Instantly\",\n    description: \"Our AI analyzes your entire customer base to surface the accounts with the greatest growth potential. Stop guessing which customers deserve more attention, let data reveal your hidden revenue goldmines so your team can focus where it matters most.\",\n    MockupComponent: MockupEnrollment,\n    benefits: [\n      \"AI identifies accounts with the biggest wallet share opportunity\",\n      \"Prioritize based on growth potential, not just current spend\",\n      \"Focus your best reps on the accounts most likely to grow\",\n      \"Turn data into a strategic advantage for account selection\",\n    ],\n  },\n  {\n    id: \"dashboard\",\n    badge: \"Growth Pipeline\",\n    title: \"Every Enrolled Account Gets a Customized Growth Plan\",\n    description: \"When you enroll an account, you're making a commitment, and so are we. Each enrolled account receives a personalized action plan designed to grow their wallet share. Track progress, celebrate wins, and watch your accounts graduate to higher revenue tiers.\",\n    MockupComponent: MockupDashboard,\n    benefits: [\n      \"Personalized growth roadmap for every enrolled account\",\n      \"Clear milestones and graduation targets\",\n      \"Real-time progress tracking from enrollment to graduation\",\n      \"Structured follow-up drives consistent results\",\n    ],\n  },\n  {\n    id: \"daily-briefing\",\n    badge: \"Agentic Daily Briefing\",\n    title: \"Your AI Rep Starts Every Day With a Plan\",\n    description: \"Every weekday morning, each territory manager receives a personalized briefing generated overnight by your AI agent. It surfaces which enrolled accounts need attention today, what buying signals were detected in recent emails, and which accounts are quietly trending at-risk â€” before it becomes a problem.\",\n    MockupComponent: MockupDailyBriefing,\n    benefits: [\n      \"Personalized morning email to every rep, zero effort required\",\n      \"AI prioritizes the 2-3 accounts that need action today\",\n      \"Buying signals and competitor mentions surface automatically\",\n      \"At-risk accounts flagged before they churn, not after\",\n    ],\n  },\n  {\n    id: \"gap-analysis\",\n    badge: \"Revenue Opportunity Mapping\",\n    title: \"See Exactly Where Each Account Can Grow\",\n    description: \"AI maps every enrolled account's purchases against their full potential. Instantly visualize which product categories are under-penetrated and quantify the exact dollar opportunity in each gap, so your team knows precisely where to focus conversations.\",\n    MockupComponent: MockupGapAnalysis,\n    benefits: [\n      \"Visualize untapped potential in every account\",\n      \"Quantified dollar amounts for each growth opportunity\",\n      \"Category-level insights power targeted conversations\",\n      \"AI prioritizes the highest-value gaps to pursue first\",\n    ],\n  },\n  {\n    id: \"ask-anything\",\n    badge: \"Ask Anything Intelligence\",\n    title: \"Ask Your Portfolio Any Question, Get an Answer in Seconds\",\n    description: \"No more waiting for weekly reports or digging through spreadsheets. Type any question â€” \\\"Which accounts haven't ordered in 90 days?\\\" or \\\"Who is my highest-risk account this week?\\\" â€” and your AI agent answers instantly by analyzing your entire account portfolio in real time.\",\n    MockupComponent: MockupAskAnything,\n    benefits: [\n      \"Natural language Q&A across your entire account portfolio\",\n      \"Ask about individual accounts, segments, or the full program\",\n      \"Answers streamed in real time, no waiting for reports\",\n      \"Every query logged for pattern analysis and team learning\",\n    ],\n  },\n  {\n    id: \"icp-builder\",\n    badge: \"Success Pattern Recognition\",\n    title: \"Learn from Your Best to Grow the Rest\",\n    description: \"AI studies your top-performing accounts to understand what success looks like in each segment. These patterns become the benchmark for growth, showing exactly how to guide underperforming accounts toward their full potential.\",\n    MockupComponent: MockupICPBuilder,\n    benefits: [\n      \"AI discovers what your best customers have in common\",\n      \"Segment-specific success patterns you can replicate\",\n      \"Data-driven targets based on real customer behavior\",\n      \"Continuous learning as your customer base evolves\",\n    ],\n  },\n  {\n    id: \"revenue\",\n    badge: \"Growth Results Tracking\",\n    title: \"Measure the Revenue Impact of Every Relationship\",\n    description: \"Track incremental revenue growth from enrollment through graduation. See exactly how much each account has grown, celebrate Territory Manager wins, and prove the ROI of relationship-driven selling with transparent, real-time reporting.\",\n    MockupComponent: MockupRevenue,\n    benefits: [\n      \"Track revenue lift from day one of enrollment\",\n      \"Celebrate milestones as accounts hit growth targets\",\n      \"Attribute results directly to relationship actions\",\n      \"Executive dashboards prove program ROI instantly\",\n    ],\n  },\n  {\n    id: \"playbooks\",\n    badge: \"AI-Powered Action Plans\",\n    title: \"Customized Playbooks That Empower Your Sales Team\",\n    description: \"AI generates personalized action plans for each enrolled account, complete with talking points, call scripts, and email templates tailored to their specific opportunities. Your team brings the relationship expertise; AI provides the perfect preparation.\",\n    MockupComponent: MockupPlaybooks,\n    benefits: [\n      \"Personalized scripts address each account's unique gaps\",\n      \"AI prepares your team for high-impact conversations\",\n      \"Human relationships enhanced by intelligent insights\",\n      \"Every touchpoint drives toward measurable growth\",\n    ],\n  },\n  {\n    id: \"email-intelligence\",\n    badge: \"Email Intelligence\",\n    title: \"Every Email Your Team Sends Makes the AI Smarter\",\n    description: \"When your rep logs a customer email, your AI agent reads it in seconds: extracting sentiment, identifying competitor mentions, detecting buying signals, and updating the account's risk profile. The next time that account appears in a briefing or playbook, the AI already knows what happened â€” and what to say next.\",\n    MockupComponent: MockupEmailIntelligence,\n    benefits: [\n      \"AI reads every logged email for sentiment and buying signals\",\n      \"Competitor mentions auto-flagged and tracked over time\",\n      \"At-risk alerts fired to the rep when urgency is detected\",\n      \"Each interaction makes playbooks more personalized\",\n    ],\n  },\n  {\n    id: \"crm-intelligence\",\n    badge: \"Agentic CRM Intelligence\",\n    title: \"Your CRM Fills Itself While Your Team Sells\",\n    description: \"This is the breakthrough. While your reps focus on relationships, AI agents work behind the scenes â€” extracting contacts from email signatures, detecting order signals from conversations, and flagging competitive threats the moment they appear. Every email becomes actionable intelligence, automatically organized and ready for your team.\",\n    MockupComponent: MockupCRMIntelligence,\n    featured: true,\n    benefits: [\n      \"Competitor threats detected and escalated in real time with price gap analysis\",\n      \"Order signals extracted from emails with dollar values and urgency scoring\",\n      \"Decision-maker contacts auto-discovered and linked to accounts\",\n      \"Zero manual data entry â€” your CRM evolves with every conversation\",\n    ],\n  },\n];\n\n\nconst stats = [\n  { value: \"32%\", label: \"Avg. Wallet Share Increase*\" },\n  { value: \"4.1x\", label: \"Typical ROI in First Year*\" },\n  { value: \"94%\", label: \"Accounts Meet Growth Targets*\" },\n  { value: \"Daily\", label: \"AI Briefings Sent to Every Rep\" },\n];\n\nexport default function Landing() {\n  const { toast } = useToast();\n  const [billingCycle, setBillingCycle] = useState<\"monthly\" | \"yearly\">(\"monthly\");\n\n  const { data: plans, isLoading: plansLoading } = useQuery<SubscriptionPlan[]>({\n    queryKey: [\"/api/subscription/plans\"],\n  });\n\n  const checkoutMutation = useMutation({\n    mutationFn: async ({ planSlug, cycle }: { planSlug: string; cycle: string }) => {\n      const res = await apiRequest(\"POST\", \"/api/stripe/create-checkout-session\", {\n        planSlug,\n        billingCycle: cycle,\n      });\n      return res.json();\n    },\n    onSuccess: (data) => {\n      if (data.url) {\n        window.location.href = data.url;\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Checkout Error\",\n        description: error.message || \"Failed to start checkout. Please log in first.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSelectPlan = (planSlug: string) => {\n    checkoutMutation.mutate({ planSlug, cycle: billingCycle });\n  };\n\n  useEffect(() => {\n    document.title = \"Wallet Share Expander - Grow Your Highest-Potential Accounts with AI-Enhanced Relationships\";\n\n    const metaDescription = document.querySelector('meta[name=\"description\"]');\n    if (metaDescription) {\n      metaDescription.setAttribute(\"content\", \"Find your highest-potential accounts and guarantee their growth with customized AI-powered playbooks. Enhance human relationships with intelligent insights that drive wallet share expansion.\");\n    } else {\n      const meta = document.createElement(\"meta\");\n      meta.name = \"description\";\n      meta.content = \"Find your highest-potential accounts and guarantee their growth with customized AI-powered playbooks. Enhance human relationships with intelligent insights that drive wallet share expansion.\";\n      document.head.appendChild(meta);\n    }\n\n    const ogTitle = document.querySelector('meta[property=\"og:title\"]');\n    if (!ogTitle) {\n      const meta = document.createElement(\"meta\");\n      meta.setAttribute(\"property\", \"og:title\");\n      meta.content = \"Wallet Share Expander - Guaranteed Account Growth\";\n      document.head.appendChild(meta);\n    }\n\n    const ogDescription = document.querySelector('meta[property=\"og:description\"]');\n    if (!ogDescription) {\n      const meta = document.createElement(\"meta\");\n      meta.setAttribute(\"property\", \"og:description\");\n      meta.content = \"Discover hidden revenue opportunities in your customer base. When you enroll an account, it's guaranteed to grow with customized AI playbooks that empower your sales team.\";\n      document.head.appendChild(meta);\n    }\n\n    const ogType = document.querySelector('meta[property=\"og:type\"]');\n    if (!ogType) {\n      const meta = document.createElement(\"meta\");\n      meta.setAttribute(\"property\", \"og:type\");\n      meta.content = \"website\";\n      document.head.appendChild(meta);\n    }\n\n    return () => {\n      document.title = \"AI VP Dashboard\";\n    };\n  }, []);\n\n  const scrollToSection = (id: string) => {\n    const element = document.getElementById(id);\n    if (element) {\n      element.scrollIntoView({ behavior: \"smooth\" });\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <header className=\"sticky top-0 z-50 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n        <div className=\"container mx-auto flex h-16 items-center justify-between gap-4 px-4\">\n          <div className=\"flex items-center gap-2\" data-testid=\"logo-brand\">\n            <img\n              src={Tenexity_Official_Logo_BW_Cirlce}\n              alt=\"Wallet Share Expander\"\n              className=\"h-10 w-auto\"\n            />\n            <span className=\"text-xl font-bold\">Wallet Share</span>\n          </div>\n\n          <nav className=\"hidden md:flex items-center gap-6\">\n            <button\n              onClick={() => scrollToSection(\"features\")}\n              className=\"text-sm font-medium text-muted-foreground transition-colors\"\n              data-testid=\"nav-features\"\n            >\n              Features\n            </button>\n            <button\n              onClick={() => scrollToSection(\"pricing\")}\n              className=\"text-sm font-medium text-muted-foreground transition-colors\"\n              data-testid=\"nav-pricing\"\n            >\n              Pricing\n            </button>\n            <a\n              href=\"/api/login\"\n              className=\"text-sm font-medium text-muted-foreground transition-colors\"\n              data-testid=\"nav-signup\"\n            >\n              Sign Up\n            </a>\n          </nav>\n\n          <div className=\"flex items-center gap-3\">\n            <ThemeToggle />\n            <a href=\"/api/login\">\n              <Button variant=\"outline\" size=\"sm\" data-testid=\"button-login\">\n                Login\n              </Button>\n            </a>\n            <a href=\"/api/login\">\n              <Button size=\"sm\" data-testid=\"button-get-started\">\n                Get Started\n              </Button>\n            </a>\n          </div>\n        </div>\n      </header>\n      <section className=\"relative overflow-hidden min-h-[500px] md:min-h-[560px] lg:min-h-[620px]\" data-testid=\"section-hero\">\n        <img\n          src={heroConstructionWide}\n          alt=\"Sales representative at a commercial construction site with strip mall and truck in background\"\n          className=\"absolute inset-0 w-full h-full object-cover object-[75%_center] md:object-[60%_center] lg:object-center\"\n          data-testid=\"img-hero-sales-rep\"\n        />\n        <div className=\"absolute inset-0 bg-gradient-to-r from-background via-background/85 via-[55%] to-transparent dark:from-background dark:via-background/80 dark:via-[55%] dark:to-transparent md:via-background/90 md:via-[50%] lg:via-[45%]\" />\n        <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-background/10 dark:to-background/30\" />\n\n        <div className=\"relative z-10 container mx-auto px-4 py-12 md:py-16 lg:py-20 flex items-center min-h-[500px] md:min-h-[560px] lg:min-h-[620px]\">\n          <div className=\"max-w-[60%] sm:max-w-[55%] md:max-w-xl lg:max-w-2xl\">\n            <Badge variant=\"secondary\" className=\"mb-6\" data-testid=\"badge-hero\">\n              Agentic AI That Thinks, Plans, and Reminds\n            </Badge>\n            <h1 className=\"text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold tracking-tight mb-4 md:mb-6 leading-[1.1]\" data-testid=\"text-hero-headline\">\n              Recover{\" \"}\n              <span className=\"relative inline-block\">\n                <span className=\"relative z-10\">Lost Revenue</span>\n                <svg className=\"absolute -bottom-2 left-0 w-full\" viewBox=\"0 0 200 12\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                  <path d=\"M2 8C40 2 80 2 100 5C120 8 160 10 198 4\" stroke=\"hsl(var(--primary))\" strokeWidth=\"3\" strokeLinecap=\"round\" strokeOpacity=\"0.5\" />\n                  <path d=\"M2 10C50 3 90 3 110 6C130 9 170 8 198 6\" stroke=\"hsl(var(--primary))\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeOpacity=\"0.3\" />\n                </svg>\n              </span>\n              {\" \"}from Existing Customers\n            </h1>\n            <p className=\"text-base md:text-lg lg:text-xl text-muted-foreground mb-6 md:mb-8 max-w-[95%] md:max-w-lg\" data-testid=\"text-hero-description\">\n              Identify wallet share leakage and prioritize your highest-potential accounts.\n              Let your AI agent monitor overnight, brief your reps each morning,\n              and flag risk before you lose revenue.\n            </p>\n\n            <div className=\"flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:gap-4 mb-8 md:mb-10 max-w-[90%] sm:max-w-none\">\n              <Button\n                size=\"lg\"\n                onClick={() => scrollToSection(\"pricing\")}\n                data-testid=\"button-hero-demo\"\n              >\n                Start Free Trial\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"lg\"\n                className=\"bg-background/60 backdrop-blur-sm\"\n                onClick={() => scrollToSection(\"features\")}\n                data-testid=\"button-hero-learn\"\n              >\n                <Play className=\"mr-2 h-4 w-4 fill-current\" />\n                See How It Works\n              </Button>\n            </div>\n\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 pt-6 border-t border-border/50\">\n              {stats.map((stat, index) => (\n                <div key={index} data-testid={`stat-${index}`}>\n                  <div className=\"text-xl sm:text-2xl md:text-3xl font-bold text-primary mb-1\" data-testid={`stat-value-${index}`}>\n                    {stat.value}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\" data-testid={`stat-label-${index}`}>\n                    {stat.label}\n                  </div>\n                </div>\n              ))}\n            </div>\n            <p className=\"text-xs text-muted-foreground/60 mt-4\" data-testid=\"text-stats-disclaimer\">\n              *Results based on enrolled accounts following recommended engagement practices\n            </p>\n          </div>\n        </div>\n      </section>\n      <section className=\"py-16 bg-muted/30\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"grid md:grid-cols-4 gap-6\">\n            <Card className=\"text-center p-6\" data-testid=\"card-step-analyze\">\n              <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                <Target className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold mb-2\">Discover</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                AI surfaces your highest-potential accounts with hidden wallet share opportunity\n              </p>\n            </Card>\n            <Card className=\"text-center p-6\" data-testid=\"card-step-prioritize\">\n              <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                <UserCheck className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold mb-2\">Enroll</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Commit accounts to growth with personalized playbooks and action plans\n              </p>\n            </Card>\n            <Card className=\"text-center p-6 border-primary/30 bg-primary/5\" data-testid=\"card-step-monitor\">\n              <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mb-4\">\n                <Zap className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold mb-2\">Agent Monitors</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Your AI runs overnight reviews, sends morning briefings, and surfaces risk â€” automatically\n              </p>\n            </Card>\n            <Card className=\"text-center p-6\" data-testid=\"card-step-execute\">\n              <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                <TrendingUp className=\"h-6 w-6 text-primary\" />\n              </div>\n              <h3 className=\"font-semibold mb-2\">Graduate</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Watch accounts grow and hit revenue targets with structured support\n              </p>\n            </Card>\n          </div>\n        </div>\n      </section>\n      <section id=\"features\" className=\"py-20\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"text-center mb-16\">\n            <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-features\">\n              How It Works\n            </Badge>\n            <h2 className=\"text-3xl md:text-4xl font-bold mb-4\" data-testid=\"text-features-title\">\n              A Proven System for Account Growth\n            </h2>\n            <p className=\"text-lg text-muted-foreground max-w-3xl mx-auto\">\n              Discover your highest-potential accounts, enroll them with customized growth plans, and empower your team with\n              AI-generated action playbooks. Human relationships drive the results, AI ensures nothing falls through the cracks.\n            </p>\n          </div>\n\n          <div className=\"space-y-24\">\n            {showcaseFeatures.map((feature, index) => {\n              const isEven = index % 2 === 0;\n              const isFeatured = 'featured' in feature && feature.featured;\n              return (\n                <div key={feature.id}>\n                  {isFeatured && (\n                    <div className=\"text-center mb-12\" data-testid=\"crm-intelligence-header\">\n                      <div className=\"inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-red-600/10 via-primary/10 to-red-600/10 dark:from-red-500/15 dark:via-primary/15 dark:to-red-500/15 border border-red-500/20 dark:border-red-400/20 mb-4\">\n                        <Sparkles className=\"w-4 h-4 text-red-600 dark:text-red-400\" />\n                        <span className=\"text-sm font-semibold text-red-700 dark:text-red-300\">The Competitive Edge That Changes Everything</span>\n                        <Sparkles className=\"w-4 h-4 text-red-600 dark:text-red-400\" />\n                      </div>\n                    </div>\n                  )}\n                  <div\n                    className={`flex flex-col ${isEven ? 'lg:flex-row' : 'lg:flex-row-reverse'} gap-8 lg:gap-16 items-center ${isFeatured ? 'relative rounded-2xl p-8 lg:p-12 border-2 border-red-500/20 dark:border-red-400/20 bg-gradient-to-br from-red-50/50 via-background to-primary/5 dark:from-red-950/20 dark:via-background dark:to-primary/10' : ''}`}\n                    data-testid={`feature-showcase-${feature.id}`}\n                  >\n                    {isFeatured && (\n                      <div className=\"absolute -top-px left-0 right-0 h-1 rounded-t-2xl bg-gradient-to-r from-red-600 via-primary to-red-600\" />\n                    )}\n                    <div className=\"w-full lg:w-1/2\">\n                      <div className=\"relative group\" data-testid={`mockup-${feature.id}`}>\n                        <div className={`absolute -inset-1 rounded-lg blur-sm opacity-75 group-hover:opacity-100 transition duration-300 ${isFeatured ? 'bg-gradient-to-r from-red-500/30 via-primary/20 to-red-500/30' : 'bg-gradient-to-r from-primary/20 to-primary/5'}`} />\n                        <div className={`relative rounded-lg overflow-hidden shadow-xl border ${isFeatured ? 'border-red-500/30 dark:border-red-400/30 shadow-red-500/10' : 'border-border/50'}`}>\n                          <feature.MockupComponent />\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"w-full lg:w-1/2 space-y-6\">\n                      <Badge\n                        variant={isFeatured ? \"default\" : \"outline\"}\n                        className={`text-xs font-medium ${isFeatured ? 'bg-red-600 dark:bg-red-700 text-white border-red-600 dark:border-red-700' : ''}`}\n                        data-testid={`badge-${feature.id}`}\n                      >\n                        {feature.badge}\n                      </Badge>\n                      <h3 className=\"text-2xl md:text-3xl font-bold leading-tight\" data-testid={`title-${feature.id}`}>\n                        {feature.title}\n                      </h3>\n                      <p className=\"text-muted-foreground text-lg leading-relaxed\" data-testid={`description-${feature.id}`}>\n                        {feature.description}\n                      </p>\n                      <ul className=\"space-y-3\">\n                        {feature.benefits.map((benefit, benefitIndex) => (\n                          <li\n                            key={benefitIndex}\n                            className=\"flex items-start gap-3\"\n                            data-testid={`benefit-${feature.id}-${benefitIndex}`}\n                          >\n                            <div className={`flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center mt-0.5 ${isFeatured ? 'bg-red-600/10 dark:bg-red-500/20' : 'bg-primary/10'}`}>\n                              <Check className={`w-3 h-3 ${isFeatured ? 'text-red-600 dark:text-red-400' : 'text-primary'}`} />\n                            </div>\n                            <span className=\"text-sm text-muted-foreground\">{benefit}</span>\n                          </li>\n                        ))}\n                      </ul>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      </section>\n      <section id=\"growth-guarantee\" className=\"py-20 bg-muted/30\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-5xl mx-auto\">\n            <div className=\"text-center mb-12\">\n              <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-guarantee\">\n                The Growth Guarantee\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold mb-4\" data-testid=\"text-guarantee-title\">\n                Enrolled Accounts Are <span className=\"text-primary\">Guaranteed to Grow</span>\n              </h2>\n              <p className=\"text-lg text-muted-foreground max-w-3xl mx-auto\">When you enroll an account, you're not hoping for results, you're activating a proven system designed to drive additional revenue through AI-powered personalization and human relationships.</p>\n            </div>\n\n            <div className=\"grid md:grid-cols-4 gap-6 mb-12\">\n              <Card className=\"p-6 text-center relative\" data-testid=\"card-guarantee-step-1\">\n                <div className=\"absolute -top-3 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full bg-primary text-primary-foreground text-sm font-bold flex items-center justify-center\">\n                  1\n                </div>\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                  <Target className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h4 className=\"font-semibold mb-2\">AI Finds Potential</h4>\n                <p className=\"text-sm text-muted-foreground\">\n                  Surface accounts with the highest wallet share growth opportunity\n                </p>\n              </Card>\n\n              <Card className=\"p-6 text-center relative\" data-testid=\"card-guarantee-step-2\">\n                <div className=\"absolute -top-3 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full bg-primary text-primary-foreground text-sm font-bold flex items-center justify-center\">\n                  2\n                </div>\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                  <UserCheck className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h4 className=\"font-semibold mb-2\">You Enroll</h4>\n                <p className=\"text-sm text-muted-foreground\">\n                  Commit to growing the account with a customized action plan\n                </p>\n              </Card>\n\n              <Card className=\"p-6 text-center relative\" data-testid=\"card-guarantee-step-3\">\n                <div className=\"absolute -top-3 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full bg-primary text-primary-foreground text-sm font-bold flex items-center justify-center\">\n                  3\n                </div>\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                  <ClipboardList className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h4 className=\"font-semibold mb-2\">AI Personalizes</h4>\n                <p className=\"text-sm text-muted-foreground\">\n                  Custom playbook with scripts and actions tailored to their gaps\n                </p>\n              </Card>\n\n              <Card className=\"p-6 text-center relative\" data-testid=\"card-guarantee-step-4\">\n                <div className=\"absolute -top-3 left-1/2 -translate-x-1/2 w-6 h-6 rounded-full bg-primary text-primary-foreground text-sm font-bold flex items-center justify-center\">\n                  4\n                </div>\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n                  <DollarSign className=\"h-6 w-6 text-primary\" />\n                </div>\n                <h4 className=\"font-semibold mb-2\">Revenue Grows</h4>\n                <p className=\"text-sm text-muted-foreground\">\n                  Track incremental revenue as the account hits growth milestones\n                </p>\n              </Card>\n            </div>\n\n            <div className=\"grid md:grid-cols-3 gap-8\">\n              <Card className=\"p-6 border-primary/20 bg-primary/5\" data-testid=\"card-guarantee-stat-1\">\n                <div className=\"text-3xl font-bold text-primary mb-2\">94%</div>\n                <div className=\"font-semibold mb-1\">Graduation Rate</div>\n                <p className=\"text-sm text-muted-foreground\">\n                  Of enrolled accounts achieve their revenue growth targets\n                </p>\n              </Card>\n              <Card className=\"p-6 border-primary/20 bg-primary/5\" data-testid=\"card-guarantee-stat-2\">\n                <div className=\"text-3xl font-bold text-primary mb-2\">32%</div>\n                <div className=\"font-semibold mb-1\">Average Growth</div>\n                <p className=\"text-sm text-muted-foreground\">\n                  Wallet share increase for enrolled accounts\n                </p>\n              </Card>\n              <Card className=\"p-6 border-primary/20 bg-primary/5\" data-testid=\"card-guarantee-stat-3\">\n                <div className=\"text-3xl font-bold text-primary mb-2\">90 Days</div>\n                <div className=\"font-semibold mb-1\">Time to Results</div>\n                <p className=\"text-sm text-muted-foreground\">\n                  Average time for enrolled accounts to show measurable growth\n                </p>\n              </Card>\n            </div>\n          </div>\n        </div>\n      </section>\n      {/* Graduation Visibility Section */}\n      <section id=\"graduation-visibility\" className=\"py-20\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-5xl mx-auto\">\n            <div className=\"text-center mb-12\">\n              <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-graduation-visibility\">\n                Measure What Matters\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold mb-4\" data-testid=\"text-graduation-visibility-title\">\n                Complete Visibility Into <span className=\"text-primary\">Wallet Share Capture</span>\n              </h2>\n              <p className=\"text-lg text-muted-foreground max-w-3xl mx-auto\">\n                Graduated accounts provide a clear picture of your wallet share expansion success.\n                Track every account from enrollment to graduation and see exactly how much value you've captured.\n              </p>\n            </div>\n\n            <div className=\"grid md:grid-cols-2 gap-8 mb-12\">\n              <Card className=\"p-6\" data-testid=\"card-visibility-tracking\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                    <GraduationCap className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <div>\n                    <h4 className=\"text-lg font-semibold mb-2\">Enrollment to Graduation Tracking</h4>\n                    <p className=\"text-muted-foreground mb-4\">\n                      Track the complete journey of every enrolled account. See revenue at enrollment,\n                      growth milestones hit, and final revenue at graduation.\n                    </p>\n                    <ul className=\"space-y-2\">\n                      <li className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        Baseline revenue vs. graduation revenue delta\n                      </li>\n                      <li className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        Days from enrollment to graduation\n                      </li>\n                      <li className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        ICP category success rate\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n              </Card>\n\n              <Card className=\"p-6\" data-testid=\"card-visibility-profitability\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"w-12 h-12 rounded-full bg-chart-1/10 flex items-center justify-center flex-shrink-0\">\n                    <TrendingUp className=\"h-6 w-6 text-chart-1\" />\n                  </div>\n                  <div>\n                    <h4 className=\"text-lg font-semibold mb-2\">Profitability from Existing Accounts</h4>\n                    <p className=\"text-muted-foreground mb-4\">See how much additional revenue you're generating from accounts you already have. No customer acquisition cost, pure wallet share expansion.</p>\n                    <ul className=\"space-y-2\">\n                      <li className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        Cumulative revenue growth across all graduates\n                      </li>\n                      <li className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        Average revenue lift per account\n                      </li>\n                      <li className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                        <Check className=\"h-4 w-4 text-primary\" />\n                        Category penetration improvements\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n              </Card>\n            </div>\n\n            <Card className=\"p-6 border-chart-2/30 bg-chart-2/5\" data-testid=\"card-visibility-alumni\">\n              <div className=\"flex flex-col md:flex-row items-center gap-6\">\n                <div className=\"w-16 h-16 rounded-full bg-chart-2/20 flex items-center justify-center flex-shrink-0\">\n                  <Trophy className=\"h-8 w-8 text-chart-2\" />\n                </div>\n                <div className=\"text-center md:text-left flex-1\">\n                  <h4 className=\"text-xl font-semibold mb-2 text-chart-2\">Alumni Section: Your Success Scoreboard</h4>\n                  <p className=\"text-muted-foreground\">Every graduated account moves to your Alumni section, a permanent record of success. See which accounts you've grown, how much revenue you captured, and what categories you successfully expanded into. It's proof that your wallet share expansion strategy works.</p>\n                </div>\n                <div className=\"text-center md:text-right flex-shrink-0\">\n                  <div className=\"text-4xl font-bold text-chart-2\">100%</div>\n                  <div className=\"text-sm text-muted-foreground\">Visibility</div>\n                </div>\n              </div>\n            </Card>\n          </div>\n        </div>\n      </section>\n      {/* Agent Loop Overnight Section */}\n      <section id=\"agent-loop\" className=\"py-20\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-5xl mx-auto\">\n            <div className=\"text-center mb-12\">\n              <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-agent-loop\">\n                Autonomous Agent Loop\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold mb-4\" data-testid=\"text-agent-loop-title\">\n                Your AI Never Sleeps â€”{\" \"}\n                <span className=\"text-primary\">Even When Your Team Does</span>\n              </h2>\n              <p className=\"text-lg text-muted-foreground max-w-3xl mx-auto\">\n                Six automated jobs run on a schedule so your team always comes in prepared,\n                and nothing ever falls through the cracks.\n              </p>\n            </div>\n\n            <div className=\"grid md:grid-cols-3 gap-4 mb-10\">\n              {[\n                {\n                  time: \"Weekdays 7:00am\",\n                  job: \"Daily Briefing\",\n                  description: \"Personalized morning email to each rep with today's priority accounts and overnight signals\",\n                  icon: Mail,\n                  color: \"text-blue-500\",\n                  bg: \"bg-blue-500/10\",\n                },\n                {\n                  time: \"Mondays 6:00am\",\n                  job: \"Weekly Account Review\",\n                  description: \"Auto-assesses graduation readiness and risk level for every enrolled account\",\n                  icon: BarChart3,\n                  color: \"text-primary\",\n                  bg: \"bg-primary/10\",\n                },\n                {\n                  time: \"Sundays 2:00am\",\n                  job: \"Similarity Refresh\",\n                  description: \"Finds accounts similar to your top graduates so reps can enroll look-alikes\",\n                  icon: Users,\n                  color: \"text-violet-500\",\n                  bg: \"bg-violet-500/10\",\n                },\n                {\n                  time: \"1st of Month 3:00am\",\n                  job: \"Learning Synthesis\",\n                  description: \"Reads 90 days of playbook outcomes and distills new cross-account patterns\",\n                  icon: Sparkles,\n                  color: \"text-amber-500\",\n                  bg: \"bg-amber-500/10\",\n                },\n                {\n                  time: \"Every 4 Hours\",\n                  job: \"CRM Sync\",\n                  description: \"Pushes enrollment, graduation, and at-risk events to your CRM automatically\",\n                  icon: Shield,\n                  color: \"text-green-500\",\n                  bg: \"bg-green-500/10\",\n                },\n                {\n                  time: \"Real-time\",\n                  job: \"Email Intelligence\",\n                  description: \"Analyzes every logged email for signals, sentiment, and competitor mentions\",\n                  icon: Zap,\n                  color: \"text-orange-500\",\n                  bg: \"bg-orange-500/10\",\n                },\n              ].map((item, i) => {\n                const Icon = item.icon;\n                return (\n                  <Card key={i} className=\"p-5\" data-testid={`card-agent-loop-${i}`}>\n                    <div className={`w-10 h-10 rounded-lg ${item.bg} flex items-center justify-center mb-3`}>\n                      <Icon className={`h-5 w-5 ${item.color}`} />\n                    </div>\n                    <div className=\"text-xs font-medium text-muted-foreground mb-1\">{item.time}</div>\n                    <h4 className=\"font-semibold text-sm mb-2\">{item.job}</h4>\n                    <p className=\"text-xs text-muted-foreground leading-relaxed\">{item.description}</p>\n                  </Card>\n                );\n              })}\n            </div>\n\n            <div className=\"text-center\">\n              <Button size=\"lg\" onClick={() => scrollToSection(\"pricing\")} data-testid=\"button-agent-loop-cta\">\n                See It In Action\n                <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n      </section>\n      {/* Graduation Success Proof Section */}\n      <section id=\"graduation-proof\" className=\"py-20 bg-muted/30\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-5xl mx-auto\">\n            <div className=\"text-center mb-12\">\n              <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-proof\">\n                See the Results\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold mb-4\" data-testid=\"text-proof-title\">\n                Enroll, Work with AI, <span className=\"text-primary\">Graduate to Huge Returns</span>\n              </h2>\n              <p className=\"text-lg text-muted-foreground max-w-3xl mx-auto\">\n                This is what success looks like. Every enrolled account has a clear path from enrollment to graduation,\n                with full visibility into baseline revenue, growth achieved, and ICP category success.\n              </p>\n            </div>\n\n            {/* Workflow Steps */}\n            <div className=\"grid grid-cols-4 gap-4 mb-12\">\n              <div className=\"text-center\" data-testid=\"workflow-step-enroll\">\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-3 relative\">\n                  <UserCheck className=\"h-6 w-6 text-primary\" />\n                  <div className=\"absolute -right-2 top-1/2 -translate-y-1/2 hidden md:block\">\n                    <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                  </div>\n                </div>\n                <p className=\"font-semibold text-sm\">1. Enroll Account</p>\n                <p className=\"text-xs text-muted-foreground\">Commit to growth</p>\n              </div>\n              <div className=\"text-center\" data-testid=\"workflow-step-playbooks\">\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-3 relative\">\n                  <Zap className=\"h-6 w-6 text-primary\" />\n                  <div className=\"absolute -right-2 top-1/2 -translate-y-1/2 hidden md:block\">\n                    <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                  </div>\n                </div>\n                <p className=\"font-semibold text-sm\">2. AI Playbooks</p>\n                <p className=\"text-xs text-muted-foreground\">Personalized actions</p>\n              </div>\n              <div className=\"text-center\" data-testid=\"workflow-step-graduate\">\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-chart-2/10 flex items-center justify-center mb-3 relative\">\n                  <GraduationCap className=\"h-6 w-6 text-chart-2\" />\n                  <div className=\"absolute -right-2 top-1/2 -translate-y-1/2 hidden md:block\">\n                    <ChevronRight className=\"h-4 w-4 text-muted-foreground\" />\n                  </div>\n                </div>\n                <p className=\"font-semibold text-sm\">3. Graduate</p>\n                <p className=\"text-xs text-muted-foreground\">Hit revenue targets</p>\n              </div>\n              <div className=\"text-center\" data-testid=\"workflow-step-returns\">\n                <div className=\"mx-auto w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center mb-3\">\n                  <DollarSign className=\"h-6 w-6 text-green-600 dark:text-green-400\" />\n                </div>\n                <p className=\"font-semibold text-sm\">4. Capture Returns</p>\n                <p className=\"text-xs text-muted-foreground\">Measurable growth</p>\n              </div>\n            </div>\n\n            {/* Graduation Success Mockup */}\n            <div className=\"relative group\" data-testid=\"mockup-graduation-success\">\n              <div className=\"absolute -inset-2 bg-gradient-to-r from-chart-2/20 via-primary/10 to-green-500/20 rounded-xl blur-lg opacity-75 group-hover:opacity-100 transition duration-300\" />\n              <div className=\"relative rounded-xl overflow-hidden shadow-2xl border border-border/50\">\n                <MockupGraduationSuccess />\n              </div>\n            </div>\n\n            <div className=\"mt-10 text-center\">\n              <p className=\"text-muted-foreground mb-6\">\n                Every graduated account tells a story: where they started, how they grew, and the value you captured.\n                <br className=\"hidden md:block\" />\n                No guesswork, no assumptions, just measurable wallet share expansion.\n              </p>\n              <Button size=\"lg\" onClick={() => scrollToSection(\"pricing\")} data-testid=\"button-proof-cta\">\n                Start Growing Wallet Share\n                <ArrowRight className=\"ml-2 h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </div>\n      </section>\n      <section id=\"pricing\" className=\"py-20\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-5xl mx-auto\">\n            <div className=\"text-center mb-12\">\n              <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-pricing\">\n                Simple Pricing\n              </Badge>\n              <h2 className=\"text-3xl md:text-4xl font-bold mb-4\" data-testid=\"text-pricing-title\">\n                Choose the Plan That Fits Your Needs\n              </h2>\n              <p className=\"text-lg text-muted-foreground mb-8\">\n                Start with a free trial. Upgrade anytime to unlock more features and grow wallet share at scale.\n              </p>\n\n              <div className=\"inline-flex items-center gap-2 p-1 rounded-lg bg-muted\" data-testid=\"billing-toggle\">\n                <button\n                  onClick={() => setBillingCycle(\"monthly\")}\n                  className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${billingCycle === \"monthly\"\n                    ? \"bg-background text-foreground shadow-sm\"\n                    : \"text-muted-foreground\"\n                    }`}\n                  data-testid=\"button-monthly-billing\"\n                >\n                  Monthly\n                </button>\n                <button\n                  onClick={() => setBillingCycle(\"yearly\")}\n                  className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${billingCycle === \"yearly\"\n                    ? \"bg-background text-foreground shadow-sm\"\n                    : \"text-muted-foreground\"\n                    }`}\n                  data-testid=\"button-yearly-billing\"\n                >\n                  Yearly\n                  <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\n                    Save 20%\n                  </Badge>\n                </button>\n              </div>\n            </div>\n\n            {plansLoading ? (\n              <div className=\"flex justify-center py-12\">\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n              </div>\n            ) : plans && plans.length > 0 ? (\n              <div className=\"grid md:grid-cols-4 gap-6\">\n                {plans.map((plan) => {\n                  const priceRaw = billingCycle === \"yearly\" ? plan.yearlyPrice : plan.monthlyPrice;\n                  const price = parseFloat(priceRaw || \"0\");\n                  const isPopular = plan.slug === \"scale\";\n                  const isEnterprise = plan.slug === \"enterprise\";\n                  const isFree = plan.slug === \"starter\";\n                  const features = Array.isArray(plan.features) ? plan.features : [];\n                  const planDescriptions: Record<string, string> = {\n                    starter: \"Try it free with one account\",\n                    growth: \"For focused account development\",\n                    scale: \"For growing sales teams\",\n                    enterprise: \"Full service solution\",\n                  };\n\n                  return (\n                    <Card\n                      key={plan.slug}\n                      className={`relative p-6 flex flex-col ${isPopular ? \"border-primary shadow-lg\" : \"\"\n                        }`}\n                      data-testid={`card-plan-${plan.slug}`}\n                    >\n                      {isPopular && (\n                        <Badge\n                          className=\"absolute -top-3 left-1/2 -translate-x-1/2\"\n                          data-testid=\"badge-popular\"\n                        >\n                          <Crown className=\"w-3 h-3 mr-1\" />\n                          Most Popular\n                        </Badge>\n                      )}\n\n                      <div className=\"text-center mb-6\">\n                        <h3 className=\"text-xl font-bold mb-2\" data-testid={`text-plan-name-${plan.slug}`}>\n                          {plan.name}\n                        </h3>\n                        <p className=\"text-sm text-muted-foreground mb-4\" data-testid={`text-plan-desc-${plan.slug}`}>\n                          {planDescriptions[plan.slug] || \"Flexible plan for your needs\"}\n                        </p>\n                        <div className=\"flex items-baseline justify-center gap-1\">\n                          {isEnterprise ? (\n                            <span className=\"text-4xl font-bold\" data-testid={`text-plan-price-${plan.slug}`}>\n                              Custom\n                            </span>\n                          ) : isFree ? (\n                            <span className=\"text-4xl font-bold\" data-testid={`text-plan-price-${plan.slug}`}>\n                              Free\n                            </span>\n                          ) : (\n                            <>\n                              <span className=\"text-4xl font-bold\" data-testid={`text-plan-price-${plan.slug}`}>\n                                ${billingCycle === \"yearly\" ? Math.round(price / 12) : Math.round(price)}\n                              </span>\n                              <span className=\"text-muted-foreground\">/mo</span>\n                              {billingCycle === \"yearly\" && (\n                                <span className=\"block text-sm text-muted-foreground mt-1\">(billed yearly)</span>\n                              )}\n                            </>\n                          )}\n                        </div>\n                      </div>\n\n                      <ul className=\"space-y-3 flex-1 mb-6\">\n                        {features.map((feature, idx) => (\n                          <li key={idx} className=\"flex items-start gap-2 text-sm\">\n                            <Check className=\"w-4 h-4 text-primary mt-0.5 flex-shrink-0\" />\n                            <span>{String(feature)}</span>\n                          </li>\n                        ))}\n                      </ul>\n\n                      {isEnterprise ? (\n                        <a href=\"mailto:sales@tenexity.com?subject=Enterprise%20Plan%20Inquiry\">\n                          <Button\n                            className=\"w-full\"\n                            variant=\"outline\"\n                            data-testid={`button-select-plan-${plan.slug}`}\n                          >\n                            Contact Sales\n                          </Button>\n                        </a>\n                      ) : (\n                        <Button\n                          className=\"w-full\"\n                          variant={isPopular ? \"default\" : \"outline\"}\n                          onClick={() => handleSelectPlan(plan.slug)}\n                          disabled={checkoutMutation.isPending}\n                          data-testid={`button-select-plan-${plan.slug}`}\n                        >\n                          {checkoutMutation.isPending ? (\n                            <>\n                              <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                              Loading...\n                            </>\n                          ) : isFree ? (\n                            <>Get Started Free</>\n                          ) : (\n                            <>Get Started</>\n                          )}\n                        </Button>\n                      )}\n                    </Card>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"grid md:grid-cols-4 gap-6\">\n                <Card className=\"p-6\" data-testid=\"card-plan-starter\">\n                  <div className=\"text-center mb-6\">\n                    <h3 className=\"text-xl font-bold mb-2\">Starter</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">Try it free with one account</p>\n                    <div className=\"flex items-baseline justify-center gap-1\">\n                      <span className=\"text-4xl font-bold\">Free</span>\n                    </div>\n                  </div>\n                  <ul className=\"space-y-3 mb-6\">\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>1 enrolled account</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>1 AI-powered playbook</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>1 ICP profile</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Upload unlimited accounts</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Full gap analysis</span>\n                    </li>\n                  </ul>\n                  <a href=\"/api/login\">\n                    <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-select-plan-starter-fallback\">\n                      Get Started Free\n                    </Button>\n                  </a>\n                </Card>\n\n                <Card className=\"p-6\" data-testid=\"card-plan-growth\">\n                  <div className=\"text-center mb-6\">\n                    <h3 className=\"text-xl font-bold mb-2\">Growth</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">For focused account development</p>\n                    <div className=\"text-center\">\n                      <div className=\"flex items-baseline justify-center gap-1\">\n                        <span className=\"text-4xl font-bold\">${billingCycle === \"yearly\" ? 240 : 300}</span>\n                        <span className=\"text-muted-foreground\">/mo</span>\n                      </div>\n                      {billingCycle === \"yearly\" && (\n                        <span className=\"block text-sm text-muted-foreground mt-1\">(billed yearly)</span>\n                      )}\n                    </div>\n                  </div>\n                  <ul className=\"space-y-3 mb-6\">\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>5 enrolled accounts</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Unlimited AI playbooks</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>3 ICP profiles</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Upload unlimited accounts</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Full gap analysis</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Email support</span>\n                    </li>\n                  </ul>\n                  <a href=\"/api/login\">\n                    <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-select-plan-growth-fallback\">\n                      Get Started\n                    </Button>\n                  </a>\n                </Card>\n\n                <Card className=\"p-6 border-primary shadow-lg relative\" data-testid=\"card-plan-scale\">\n                  <Badge className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\n                    <Crown className=\"w-3 h-3 mr-1\" />\n                    Most Popular\n                  </Badge>\n                  <div className=\"text-center mb-6\">\n                    <h3 className=\"text-xl font-bold mb-2\">Scale</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">For growing sales teams</p>\n                    <div className=\"text-center\">\n                      <div className=\"flex items-baseline justify-center gap-1\">\n                        <span className=\"text-4xl font-bold\">${billingCycle === \"yearly\" ? 600 : 750}</span>\n                        <span className=\"text-muted-foreground\">/mo</span>\n                      </div>\n                      {billingCycle === \"yearly\" && (\n                        <span className=\"block text-sm text-muted-foreground mt-1\">(billed yearly)</span>\n                      )}\n                    </div>\n                  </div>\n                  <ul className=\"space-y-3 mb-6\">\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>15 enrolled accounts</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Unlimited AI playbooks</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Unlimited ICP profiles</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Upload unlimited accounts</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Full gap analysis</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>AI-powered playbooks</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Priority support</span>\n                    </li>\n                  </ul>\n                  <a href=\"/api/login\">\n                    <Button className=\"w-full\" data-testid=\"button-select-plan-scale-fallback\">\n                      Get Started\n                    </Button>\n                  </a>\n                </Card>\n\n                <Card className=\"p-6\" data-testid=\"card-plan-enterprise\">\n                  <div className=\"text-center mb-6\">\n                    <h3 className=\"text-xl font-bold mb-2\">Enterprise</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">Full service solution</p>\n                    <div className=\"flex items-baseline justify-center gap-1\">\n                      <span className=\"text-4xl font-bold\">Custom</span>\n                    </div>\n                  </div>\n                  <ul className=\"space-y-3 mb-6\">\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Unlimited enrolled accounts</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Weekly account review calls</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Fractional VP of Sales services</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Custom AI training for your team</span>\n                    </li>\n                    <li className=\"flex items-start gap-2 text-sm\">\n                      <Check className=\"w-4 h-4 text-primary mt-0.5\" />\n                      <span>Dedicated support</span>\n                    </li>\n                  </ul>\n                  <a href=\"mailto:sales@tenexity.com?subject=Enterprise%20Plan%20Inquiry\">\n                    <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-select-plan-enterprise-fallback\">\n                      Contact Sales\n                    </Button>\n                  </a>\n                </Card>\n              </div>\n            )}\n\n            <p className=\"text-center text-sm text-muted-foreground mt-8\" data-testid=\"text-trial-info\">\n              Start free with one account. No credit card required. Upgrade anytime as you grow.\n            </p>\n\n            <div className=\"mt-12 max-w-3xl mx-auto\">\n              <Card className=\"p-6\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"flex-shrink-0 mt-1\">\n                    <GraduationCap className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-lg mb-2\" data-testid=\"text-graduation-title\">\n                      Graduate Accounts, Control Your Costs\n                    </h3>\n                    <p className=\"text-muted-foreground text-sm leading-relaxed\" data-testid=\"text-graduation-description\">\n                      You're always in control of your subscription. When an enrolled account reaches your target revenue\n                      level or hits its ICP potential, simply graduate it from the program. This frees up a slot for a\n                      new account to enroll, letting you continuously work on your highest-potential opportunities without\n                      increasing costs. We track every graduated account so you can see your total success: how many\n                      accounts have grown, the revenue increase from enrollment to graduation, and the cumulative value\n                      you've captured. It's a built-in scoreboard for your wallet share expansion efforts.\n                    </p>\n                  </div>\n                </div>\n              </Card>\n            </div>\n          </div>\n        </div>\n      </section>\n      <section className=\"py-20\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-4xl mx-auto\">\n            <div className=\"grid md:grid-cols-2 gap-8 items-center\">\n              <div>\n                <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-why-us\">\n                  Why Choose Us\n                </Badge>\n                <h2 className=\"text-3xl font-bold mb-4\" data-testid=\"text-why-title\">\n                  AI That Enhances, Not Replaces, Human Relationships\n                </h2>\n                <p className=\"text-muted-foreground mb-6\">Your sales team builds relationships. We give them the insights, preparation, and confidence to make every conversation count. AI does the analysis, your people close the deals.</p>\n\n                <ul className=\"space-y-4\">\n                  <li className=\"flex items-start gap-3\" data-testid=\"benefit-security\">\n                    <Users className=\"h-5 w-5 text-primary mt-0.5\" />\n                    <div>\n                      <h4 className=\"font-medium\">Relationship-First Approach</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        AI prepares your teamâ€”humans build the trust that closes deals\n                      </p>\n                    </div>\n                  </li>\n                  <li className=\"flex items-start gap-3\" data-testid=\"benefit-implementation\">\n                    <CheckCircle className=\"h-5 w-5 text-primary mt-0.5\" />\n                    <div>\n                      <h4 className=\"font-medium\">Proven Growth System</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Every enrolled account receives a customized plan designed to drive results\n                      </p>\n                    </div>\n                  </li>\n                  <li className=\"flex items-start gap-3\" data-testid=\"benefit-support\">\n                    <Shield className=\"h-5 w-5 text-primary mt-0.5\" />\n                    <div>\n                      <h4 className=\"font-medium\">Enterprise Security</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        SOC 2 compliant with dedicated customer success support\n                      </p>\n                    </div>\n                  </li>\n                </ul>\n              </div>\n\n              <Card className=\"p-8 bg-primary/5 border-primary/20\" data-testid=\"card-testimonial\">\n                <blockquote className=\"text-lg italic mb-4\" data-testid=\"text-testimonial-quote\">\n                  \"We enrolled 50 accounts in the first month and every single one\n                  has grown. The AI playbooks give our reps exactly what they need to\n                  have confident, value-driven conversations. It's like giving each\n                  rep a personal sales strategist.\"\n                </blockquote>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center\">\n                    <Building2 className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  <div>\n                    <div className=\"font-medium\" data-testid=\"text-testimonial-author\">Sarah Johnson</div>\n                    <div className=\"text-sm text-muted-foreground\" data-testid=\"text-testimonial-role\">\n                      VP of Sales, Industrial Supply Co.\n                    </div>\n                  </div>\n                </div>\n              </Card>\n            </div>\n          </div>\n        </div>\n      </section>\n      <section id=\"signup\" className=\"py-20 bg-muted/30\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"max-w-xl mx-auto\">\n            <Card className=\"p-8\" data-testid=\"card-signup\">\n              <div className=\"text-center\">\n                <Badge variant=\"secondary\" className=\"mb-4\" data-testid=\"badge-signup\">\n                  Start Growing Today\n                </Badge>\n                <h2 className=\"text-2xl font-bold mb-2\" data-testid=\"text-signup-title\">\n                  Discover Your Highest-Potential Accounts\n                </h2>\n                <p className=\"text-muted-foreground mb-6\">\n                  See which accounts have the biggest growth opportunity.\n                  Start enrolling and watch them grow with proven playbook strategies.\n                </p>\n\n                <div className=\"space-y-4\">\n                  <a href=\"/api/login\">\n                    <Button size=\"lg\" className=\"w-full\" data-testid=\"button-signup-login\">\n                      <ArrowRight className=\"mr-2 h-4 w-4\" />\n                      Create Free Account\n                    </Button>\n                  </a>\n\n                  <p className=\"text-sm text-muted-foreground\">\n                    Already have an account?{\" \"}\n                    <a\n                      href=\"/api/login\"\n                      className=\"text-primary font-medium\"\n                      data-testid=\"link-login\"\n                    >\n                      Log in\n                    </a>\n                  </p>\n\n                  <div className=\"flex items-center justify-center gap-6 pt-4 border-t text-sm text-muted-foreground\">\n                    <div className=\"flex items-center gap-2\">\n                      <Check className=\"w-4 h-4 text-primary\" />\n                      <span>14-day free trial</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Check className=\"w-4 h-4 text-primary\" />\n                      <span>No credit card</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Check className=\"w-4 h-4 text-primary\" />\n                      <span>Cancel anytime</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </Card>\n          </div>\n        </div>\n      </section>\n      <footer className=\"py-12 border-t\">\n        <div className=\"container mx-auto px-4\">\n          <div className=\"flex flex-col md:flex-row items-center justify-between gap-4\">\n            <div className=\"flex items-center gap-2\" data-testid=\"footer-logo\">\n              <div className=\"flex h-8 w-8 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n                <TrendingUp className=\"h-4 w-4\" />\n              </div>\n              <span className=\"font-semibold\">Wallet Share Expander</span>\n            </div>\n\n            <div className=\"flex items-center gap-6 text-sm text-muted-foreground\">\n              <a href=\"#\" className=\"transition-colors\" data-testid=\"link-privacy\">\n                Privacy Policy\n              </a>\n              <a href=\"#\" className=\"transition-colors\" data-testid=\"link-terms\">\n                Terms of Service\n              </a>\n              <a href=\"#\" className=\"transition-colors\" data-testid=\"link-contact\">\n                Contact\n              </a>\n            </div>\n\n            <div className=\"text-sm text-muted-foreground\" data-testid=\"text-powered-by\">\n              Powered by Tenexity\n            </div>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":71953,"size_tokens":null},"server/utils/errorHandler.ts":{"content":"import { Response } from \"express\";\nimport { z } from \"zod\";\n\nexport function handleRouteError(\n  error: unknown,\n  res: Response,\n  context: string\n): void {\n  if (error instanceof z.ZodError) {\n    res.status(400).json({ \n      message: \"Invalid data\", \n      errors: error.errors \n    });\n    return;\n  }\n\n  console.error(`${context}:`, error);\n  res.status(500).json({ \n    message: `Failed to ${context.toLowerCase().replace(/ error$/, \"\")}` \n  });\n}\n","path":null,"size_bytes":456,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"server/email-service.ts":{"content":"import { Resend } from 'resend';\nimport { storage } from './storage';\nimport type { Task, TerritoryManager, Account } from '@shared/schema';\nimport { withRetry } from './utils/retry';\nimport { getTenantStorage } from './storage/tenantStorage';\n\nfunction getResendClient(): Resend | null {\n  const apiKey = process.env.RESEND_API_KEY;\n  if (!apiKey) {\n    return null;\n  }\n  return new Resend(apiKey);\n}\n\nexport interface EmailSettings {\n  enabled: boolean;\n  fromEmail: string;\n  fromName: string;\n  notifyOnNewTask: boolean;\n  notifyOnHighPriority: boolean;\n  dailyDigest: boolean;\n}\n\nexport const DEFAULT_EMAIL_SETTINGS: EmailSettings = {\n  enabled: false,\n  fromEmail: 'notifications@yourdomain.com',\n  fromName: 'AI VP Dashboard',\n  notifyOnNewTask: true,\n  notifyOnHighPriority: true,\n  dailyDigest: false,\n};\n\nexport async function getEmailSettings(): Promise<EmailSettings> {\n  const setting = await storage.getSetting('emailSettings');\n  if (setting?.value) {\n    try {\n      return { ...DEFAULT_EMAIL_SETTINGS, ...JSON.parse(setting.value) };\n    } catch {\n      return DEFAULT_EMAIL_SETTINGS;\n    }\n  }\n  return DEFAULT_EMAIL_SETTINGS;\n}\n\nexport async function saveEmailSettings(settings: Partial<EmailSettings>): Promise<EmailSettings> {\n  const current = await getEmailSettings();\n  const updated = { ...current, ...settings };\n  await storage.upsertSetting({ key: 'emailSettings', value: JSON.stringify(updated) });\n  return updated;\n}\n\nexport function isEmailConfigured(): boolean {\n  return !!process.env.RESEND_API_KEY;\n}\n\ninterface SendEmailResult {\n  success: boolean;\n  messageId?: string;\n  error?: string;\n}\n\nexport async function sendEmail(\n  to: string,\n  subject: string,\n  htmlContent: string\n): Promise<SendEmailResult> {\n  const settings = await getEmailSettings();\n  \n  if (!settings.enabled) {\n    return { success: false, error: 'Email notifications are disabled' };\n  }\n\n  const client = getResendClient();\n  if (!client) {\n    return { success: false, error: 'Resend API key not configured' };\n  }\n\n  try {\n    const result = await withRetry(\n      () => client.emails.send({\n        from: `${settings.fromName} <${settings.fromEmail}>`,\n        to: [to],\n        subject,\n        html: htmlContent,\n      }),\n      { maxRetries: 3, timeoutMs: 30000 }\n    );\n\n    if (result.error) {\n      return { success: false, error: result.error.message };\n    }\n\n    return { success: true, messageId: result.data?.id };\n  } catch (error) {\n    return { success: false, error: error instanceof Error ? error.message : 'Failed to send email' };\n  }\n}\n\nexport async function sendTestEmail(toEmail: string): Promise<SendEmailResult> {\n  const settings = await getEmailSettings();\n  const client = getResendClient();\n  \n  if (!client) {\n    return { success: false, error: 'Resend API key not configured. Please add RESEND_API_KEY to your secrets.' };\n  }\n\n  try {\n    const result = await withRetry(\n      () => client.emails.send({\n        from: `${settings.fromName} <${settings.fromEmail}>`,\n        to: [toEmail],\n        subject: 'Test Email from AI VP Dashboard',\n        html: `\n          <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <h2 style=\"color: #1a365d;\">Email Configuration Test</h2>\n            <p>This is a test email from your AI VP Dashboard.</p>\n            <p>If you received this email, your email notifications are configured correctly!</p>\n            <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\" />\n            <p style=\"color: #718096; font-size: 12px;\">This is an automated message from the AI VP Dashboard.</p>\n          </div>\n        `,\n      }),\n      { maxRetries: 3, timeoutMs: 30000 }\n    );\n\n    if (result.error) {\n      return { success: false, error: result.error.message };\n    }\n\n    return { success: true, messageId: result.data?.id };\n  } catch (error) {\n    return { success: false, error: error instanceof Error ? error.message : 'Failed to send test email' };\n  }\n}\n\nexport async function sendTaskNotification(\n  task: Task,\n  account: Account,\n  territoryManager: TerritoryManager\n): Promise<SendEmailResult> {\n  const settings = await getEmailSettings();\n  \n  if (!settings.enabled || !settings.notifyOnNewTask) {\n    return { success: false, error: 'Task notifications are disabled' };\n  }\n\n  const taskTypeLabels: Record<string, string> = {\n    call: 'Phone Call',\n    email: 'Email Outreach',\n    visit: 'Site Visit',\n  };\n\n  const gapCategories = Array.isArray(task.gapCategories) \n    ? (task.gapCategories as string[]).join(', ') \n    : '';\n\n  const htmlContent = `\n    <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;\">\n      <h2 style=\"color: #1a365d;\">New Task Assigned</h2>\n      <p>Hi ${territoryManager.name},</p>\n      <p>A new task has been assigned to you:</p>\n      \n      <div style=\"background: #f7fafc; border-radius: 8px; padding: 16px; margin: 16px 0;\">\n        <h3 style=\"margin: 0 0 8px 0; color: #2d3748;\">${task.title}</h3>\n        <p style=\"margin: 0 0 8px 0; color: #4a5568;\"><strong>Account:</strong> ${account.name}</p>\n        <p style=\"margin: 0 0 8px 0; color: #4a5568;\"><strong>Type:</strong> ${taskTypeLabels[task.taskType] || task.taskType}</p>\n        ${gapCategories ? `<p style=\"margin: 0 0 8px 0; color: #4a5568;\"><strong>Categories:</strong> ${gapCategories}</p>` : ''}\n        ${task.dueDate ? `<p style=\"margin: 0; color: #4a5568;\"><strong>Due:</strong> ${new Date(task.dueDate).toLocaleDateString()}</p>` : ''}\n      </div>\n      \n      ${task.description ? `<p style=\"color: #4a5568;\">${task.description}</p>` : ''}\n      \n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\" />\n      <p style=\"color: #718096; font-size: 12px;\">This is an automated notification from the AI VP Dashboard.</p>\n    </div>\n  `;\n\n  return sendEmail(territoryManager.email, `New Task: ${task.title}`, htmlContent);\n}\n\nexport async function sendHighPriorityNotification(\n  task: Task,\n  account: Account,\n  territoryManager: TerritoryManager\n): Promise<SendEmailResult> {\n  const settings = await getEmailSettings();\n  \n  if (!settings.enabled || !settings.notifyOnHighPriority) {\n    return { success: false, error: 'High priority notifications are disabled' };\n  }\n\n  const htmlContent = `\n    <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto;\">\n      <div style=\"background: #feb2b2; color: #742a2a; padding: 12px; border-radius: 8px 8px 0 0;\">\n        <strong>HIGH PRIORITY</strong>\n      </div>\n      <div style=\"border: 1px solid #feb2b2; border-top: none; border-radius: 0 0 8px 8px; padding: 16px;\">\n        <h2 style=\"color: #1a365d; margin-top: 0;\">Urgent Task Requires Attention</h2>\n        <p>Hi ${territoryManager.name},</p>\n        <p>A high-priority task requires your immediate attention:</p>\n        \n        <div style=\"background: #fff5f5; border-left: 4px solid #fc8181; padding: 12px; margin: 16px 0;\">\n          <h3 style=\"margin: 0 0 8px 0; color: #c53030;\">${task.title}</h3>\n          <p style=\"margin: 0 0 4px 0;\"><strong>Account:</strong> ${account.name}</p>\n          ${task.dueDate ? `<p style=\"margin: 0;\"><strong>Due:</strong> ${new Date(task.dueDate).toLocaleDateString()}</p>` : ''}\n        </div>\n        \n        ${task.description ? `<p>${task.description}</p>` : ''}\n      </div>\n      <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\" />\n      <p style=\"color: #718096; font-size: 12px;\">This is an automated notification from the AI VP Dashboard.</p>\n    </div>\n  `;\n\n  return sendEmail(\n    territoryManager.email, \n    `[URGENT] ${task.title} - ${account.name}`, \n    htmlContent\n  );\n}\n\nexport async function sendDailyDigest(tenantId: number): Promise<{ sent: number; errors: number }> {\n  const settings = await getEmailSettings();\n\n  if (!settings.enabled || !settings.dailyDigest) {\n    return { sent: 0, errors: 0 };\n  }\n\n  const tenantStorage = getTenantStorage(tenantId);\n  const allTasks = await tenantStorage.getAllTasks();\n  const pendingTasks = allTasks.filter(t => t.status === 'pending' || t.status === 'in_progress');\n\n  if (pendingTasks.length === 0) {\n    return { sent: 0, errors: 0 };\n  }\n\n  const territoryManagers = await tenantStorage.getTerritoryManagers();\n  if (territoryManagers.length === 0) {\n    return { sent: 0, errors: 0 };\n  }\n\n  const tasksByTm = new Map<number, Task[]>();\n  for (const task of pendingTasks) {\n    if (task.assignedTmId) {\n      const existing = tasksByTm.get(task.assignedTmId) || [];\n      existing.push(task);\n      tasksByTm.set(task.assignedTmId, existing);\n    }\n  }\n\n  const accounts = await tenantStorage.getAccounts();\n  const accountMap = new Map(accounts.map(a => [a.id, a]));\n\n  const taskTypeLabels: Record<string, string> = {\n    call: 'Phone Call',\n    email: 'Email Outreach',\n    visit: 'Site Visit',\n  };\n\n  const today = new Date().toLocaleDateString('en-US', {\n    weekday: 'long',\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric',\n  });\n\n  let sent = 0;\n  let errors = 0;\n\n  for (const tm of territoryManagers) {\n    const tmTasks = tasksByTm.get(tm.id) || [];\n    if (tmTasks.length === 0) continue;\n\n    const overdueTasks = tmTasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date());\n    const urgentTasks = tmTasks.filter(t => /urgent/i.test(t.title));\n\n    const taskRows = tmTasks\n      .sort((a, b) => {\n        const aOverdue = a.dueDate && new Date(a.dueDate) < new Date() ? 0 : 1;\n        const bOverdue = b.dueDate && new Date(b.dueDate) < new Date() ? 0 : 1;\n        return aOverdue - bOverdue;\n      })\n      .slice(0, 20)\n      .map(t => {\n        const account = accountMap.get(t.accountId);\n        const isOverdue = t.dueDate && new Date(t.dueDate) < new Date();\n        return `\n          <tr style=\"${isOverdue ? 'background: #fff5f5;' : ''}\">\n            <td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${t.title}</td>\n            <td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${account?.name || 'Unknown'}</td>\n            <td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">${taskTypeLabels[t.taskType] || t.taskType}</td>\n            <td style=\"padding: 8px; border-bottom: 1px solid #e2e8f0;\">\n              ${t.dueDate\n                ? `<span style=\"${isOverdue ? 'color: #c53030; font-weight: bold;' : ''}\">${new Date(t.dueDate).toLocaleDateString()}</span>`\n                : 'â€”'}\n            </td>\n          </tr>`;\n      })\n      .join('');\n\n    const htmlContent = `\n      <div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 700px; margin: 0 auto;\">\n        <h2 style=\"color: #1a365d;\">Daily Task Digest</h2>\n        <p style=\"color: #718096;\">${today}</p>\n        <p>Hi ${tm.name},</p>\n        <p>Here's your daily summary of pending tasks:</p>\n\n        <div style=\"display: flex; gap: 16px; margin: 16px 0;\">\n          <div style=\"background: #ebf8ff; padding: 12px 16px; border-radius: 8px; flex: 1; text-align: center;\">\n            <div style=\"font-size: 24px; font-weight: bold; color: #2b6cb0;\">${tmTasks.length}</div>\n            <div style=\"color: #4a5568; font-size: 13px;\">Pending Tasks</div>\n          </div>\n          ${overdueTasks.length > 0 ? `\n          <div style=\"background: #fff5f5; padding: 12px 16px; border-radius: 8px; flex: 1; text-align: center;\">\n            <div style=\"font-size: 24px; font-weight: bold; color: #c53030;\">${overdueTasks.length}</div>\n            <div style=\"color: #4a5568; font-size: 13px;\">Overdue</div>\n          </div>` : ''}\n          ${urgentTasks.length > 0 ? `\n          <div style=\"background: #fffbeb; padding: 12px 16px; border-radius: 8px; flex: 1; text-align: center;\">\n            <div style=\"font-size: 24px; font-weight: bold; color: #d69e2e;\">${urgentTasks.length}</div>\n            <div style=\"color: #4a5568; font-size: 13px;\">Urgent</div>\n          </div>` : ''}\n        </div>\n\n        <table style=\"width: 100%; border-collapse: collapse; margin: 16px 0;\">\n          <thead>\n            <tr style=\"background: #f7fafc;\">\n              <th style=\"padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #4a5568;\">Task</th>\n              <th style=\"padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #4a5568;\">Account</th>\n              <th style=\"padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #4a5568;\">Type</th>\n              <th style=\"padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #4a5568;\">Due Date</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${taskRows}\n          </tbody>\n        </table>\n        ${tmTasks.length > 20 ? `<p style=\"color: #718096; font-style: italic;\">...and ${tmTasks.length - 20} more tasks</p>` : ''}\n\n        <hr style=\"border: none; border-top: 1px solid #e2e8f0; margin: 24px 0;\" />\n        <p style=\"color: #718096; font-size: 12px;\">This is an automated daily digest from the AI VP Dashboard.</p>\n      </div>\n    `;\n\n    const result = await sendEmail(tm.email, `Daily Task Digest â€” ${tmTasks.length} pending tasks`, htmlContent);\n    if (result.success) {\n      sent++;\n    } else {\n      errors++;\n    }\n  }\n\n  return { sent, errors };\n}\n","path":null,"size_bytes":13426,"size_tokens":null},"tests/unit/subscription.middleware.test.ts":{"content":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport type { Request, Response, NextFunction } from 'express';\nimport { requireActiveSubscription, requirePlan, checkSubscriptionStatus } from '../../server/middleware/subscription';\n\nfunction createMockRequest(tenantContext?: any): Partial<Request> {\n  return { tenantContext };\n}\n\nfunction createMockResponse(): Partial<Response> {\n  const res: Partial<Response> = {};\n  res.status = vi.fn().mockReturnValue(res);\n  res.json = vi.fn().mockReturnValue(res);\n  return res;\n}\n\ndescribe('requireActiveSubscription', () => {\n  let mockNext: NextFunction;\n\n  beforeEach(() => {\n    mockNext = vi.fn();\n  });\n\n  it('returns 401 when no tenant context exists', () => {\n    const req = createMockRequest(undefined) as Request;\n    const res = createMockResponse() as Response;\n\n    requireActiveSubscription(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(401);\n    expect(res.json).toHaveBeenCalledWith({ message: 'Not authenticated' });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('returns 402 when subscription status is not active', () => {\n    const req = createMockRequest({\n      tenant: { subscriptionStatus: 'canceled', planType: 'starter' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    requireActiveSubscription(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(402);\n    expect(res.json).toHaveBeenCalledWith({\n      message: 'Active subscription required',\n      subscriptionStatus: 'canceled',\n      planType: 'starter',\n    });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('calls next when subscription status is active', () => {\n    const req = createMockRequest({\n      tenant: { subscriptionStatus: 'active', planType: 'professional' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    requireActiveSubscription(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n    expect(res.status).not.toHaveBeenCalled();\n  });\n\n  it('calls next when subscription status is trialing', () => {\n    const req = createMockRequest({\n      tenant: { subscriptionStatus: 'trialing', planType: 'starter' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    requireActiveSubscription(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n    expect(res.status).not.toHaveBeenCalled();\n  });\n\n  it('returns 402 when subscription status is null', () => {\n    const req = createMockRequest({\n      tenant: { subscriptionStatus: null, planType: 'free' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    requireActiveSubscription(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(402);\n    expect(res.json).toHaveBeenCalledWith({\n      message: 'Active subscription required',\n      subscriptionStatus: 'none',\n      planType: 'free',\n    });\n  });\n});\n\ndescribe('requirePlan', () => {\n  let mockNext: NextFunction;\n\n  beforeEach(() => {\n    mockNext = vi.fn();\n  });\n\n  it('returns 401 when no tenant context exists', () => {\n    const middleware = requirePlan('starter');\n    const req = createMockRequest(undefined) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(401);\n    expect(res.json).toHaveBeenCalledWith({ message: 'Not authenticated' });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('returns 403 when plan level is insufficient', () => {\n    const middleware = requirePlan('professional');\n    const req = createMockRequest({\n      tenant: { planType: 'starter' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(403);\n    expect(res.json).toHaveBeenCalledWith({\n      message: 'professional plan or higher required',\n      currentPlan: 'starter',\n      requiredPlan: 'professional',\n    });\n    expect(mockNext).not.toHaveBeenCalled();\n  });\n\n  it('calls next when plan meets minimum requirement', () => {\n    const middleware = requirePlan('starter');\n    const req = createMockRequest({\n      tenant: { planType: 'professional' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n    expect(res.status).not.toHaveBeenCalled();\n  });\n\n  it('calls next when plan equals minimum requirement', () => {\n    const middleware = requirePlan('professional');\n    const req = createMockRequest({\n      tenant: { planType: 'professional' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n    expect(res.status).not.toHaveBeenCalled();\n  });\n\n  it('enterprise plan has access to all features', () => {\n    const middleware = requirePlan('starter');\n    const req = createMockRequest({\n      tenant: { planType: 'enterprise' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(mockNext).toHaveBeenCalled();\n  });\n\n  it('free plan is denied for starter features', () => {\n    const middleware = requirePlan('starter');\n    const req = createMockRequest({\n      tenant: { planType: 'free' }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    middleware(req, res, mockNext);\n\n    expect(res.status).toHaveBeenCalledWith(403);\n    expect(res.json).toHaveBeenCalledWith({\n      message: 'starter plan or higher required',\n      currentPlan: 'free',\n      requiredPlan: 'starter',\n    });\n  });\n});\n\ndescribe('checkSubscriptionStatus', () => {\n  let mockNext: NextFunction;\n\n  beforeEach(() => {\n    mockNext = vi.fn();\n  });\n\n  it('attaches subscription info to request when tenant exists', () => {\n    const req = createMockRequest({\n      tenant: {\n        subscriptionStatus: 'active',\n        planType: 'professional',\n        billingPeriodEnd: '2024-12-31',\n      }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    checkSubscriptionStatus(req, res, mockNext);\n\n    expect((req as any).subscriptionInfo).toEqual({\n      isActive: true,\n      status: 'active',\n      planType: 'professional',\n      billingPeriodEnd: '2024-12-31',\n    });\n    expect(mockNext).toHaveBeenCalled();\n  });\n\n  it('sets isActive to false for canceled subscriptions', () => {\n    const req = createMockRequest({\n      tenant: {\n        subscriptionStatus: 'canceled',\n        planType: 'starter',\n        billingPeriodEnd: null,\n      }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    checkSubscriptionStatus(req, res, mockNext);\n\n    expect((req as any).subscriptionInfo.isActive).toBe(false);\n    expect(mockNext).toHaveBeenCalled();\n  });\n\n  it('sets isActive to true for trialing subscriptions', () => {\n    const req = createMockRequest({\n      tenant: {\n        subscriptionStatus: 'trialing',\n        planType: 'starter',\n      }\n    }) as Request;\n    const res = createMockResponse() as Response;\n\n    checkSubscriptionStatus(req, res, mockNext);\n\n    expect((req as any).subscriptionInfo.isActive).toBe(true);\n    expect(mockNext).toHaveBeenCalled();\n  });\n\n  it('calls next without attaching info when no tenant', () => {\n    const req = createMockRequest(undefined) as Request;\n    const res = createMockResponse() as Response;\n\n    checkSubscriptionStatus(req, res, mockNext);\n\n    expect((req as any).subscriptionInfo).toBeUndefined();\n    expect(mockNext).toHaveBeenCalled();\n  });\n});\n","path":null,"size_bytes":7574,"size_tokens":null},"server/services/agent-identity.ts":{"content":"/**\n * Agent Identity Service â€” Phase 0\n *\n * Provides getCoreSystemPrompt() and writeAgentMemo() helpers that every\n * subsequent agent service must call.  These functions are the glue between\n * the agent \"soul\" (agent_system_prompts) and the agent \"heartbeat\"\n * (agent_state), ensuring every AI call starts with consistent identity and\n * updates its state when it finishes.\n */\n\nimport { storage } from \"../storage\";\nimport type { AgentState } from \"@shared/schema\";\n\nconst CORE_PROMPT_KEY = \"core_agent_identity\";\n\n/**\n * Returns the active core agent identity prompt content.\n * Every agent service MUST prepend this to its OpenAI system prompt.\n *\n * Falls back to a minimal inline prompt if the DB row is missing so that\n * agent services never fail silently due to a missing seed.\n */\nexport async function getCoreSystemPrompt(): Promise<string> {\n    try {\n        const row = await storage.getAgentSystemPrompt(CORE_PROMPT_KEY);\n        if (row?.content) return row.content;\n    } catch (err) {\n        console.warn(\"[agent-identity] getCoreSystemPrompt DB error:\", err);\n    }\n\n    // Inline fallback â€” should only fire before seed data is loaded\n    return [\n        \"You are the Revenue Intelligence Agent for Wallet Share Expander, an AI\",\n        \"system purpose-built for MEP wholesale distribution.\",\n        \"\",\n        \"YOUR PURPOSE:\",\n        \"Help wholesale distributor territory managers grow revenue from existing\",\n        \"contractor accounts by identifying wallet share gaps, generating targeted\",\n        \"playbooks, and surfacing the right action at the right moment.\",\n        \"\",\n        \"YOUR PRINCIPLES:\",\n        \"- Always ground recommendations in specific data from the contractor's record.\",\n        \"- Give territory managers one clear next action, not a list of ten.\",\n        \"- Never fabricate data or express certainty you do not have.\",\n        \"- Be aware of seasonality before flagging anomalies.\",\n    ].join(\"\\n\");\n}\n\n/**\n * Reads the current agent state for a given run type so prior observations\n * can be included in the OpenAI context.\n */\nexport async function readAgentState(\n    tenantId: number,\n    runType: string,\n): Promise<AgentState | undefined> {\n    try {\n        return await storage.getAgentState(tenantId, runType);\n    } catch (err) {\n        console.warn(\"[agent-identity] readAgentState error:\", err);\n        return undefined;\n    }\n}\n\n/**\n * Shape of the agent_memo JSON block that every agent service asks Claude\n * to include at the end of its response.\n */\nexport interface AgentMemo {\n    last_run_summary: string;\n    current_focus: string;\n    pattern_notes_addition: string; // new observations to append with today's date\n    anomalies_watching: Array<{\n        account_name: string;\n        signal: string;\n        watch_until_date: string;\n    }>;\n}\n\n/**\n * The instruction appended to every agent service's system prompt, asking\n * the model to write a memo back to agent_state.\n */\nexport const AGENT_MEMO_INSTRUCTION = `\nAt the end of your JSON response, include a field \"agent_memo\" with this structure:\n{\n  \"last_run_summary\": \"2-4 sentences describing what you found and did in this run.\",\n  \"current_focus\": \"Single sentence on what pattern or account you are watching most closely.\",\n  \"pattern_notes_addition\": \"New cross-account observations to append with today's date, or empty string.\",\n  \"anomalies_watching\": [\n    { \"account_name\": \"...\", \"signal\": \"...\", \"watch_until_date\": \"YYYY-MM-DD\" }\n  ]\n}\n`;\n\n/**\n * Parses the agent_memo from a Claude response object and writes it back to\n * agent_state.  Call at the END of every agent service execution.\n *\n * @param tenantId  - the org/tenant running the agent\n * @param runType   - matches agentState.agentRunType\n * @param memo      - the parsed agent_memo object from the Claude response\n */\nexport async function writeAgentMemo(\n    tenantId: number,\n    runType: string,\n    memo: AgentMemo,\n): Promise<void> {\n    try {\n        const existing = await storage.getAgentState(tenantId, runType);\n        const appendedNotes =\n            memo.pattern_notes_addition\n                ? `\\n[${new Date().toISOString().slice(0, 10)}] ${memo.pattern_notes_addition}` + (existing?.patternNotes ?? \"\")\n                : existing?.patternNotes ?? null;\n\n        await storage.upsertAgentState(tenantId, runType, {\n            lastRunAt: new Date(),\n            lastRunSummary: memo.last_run_summary,\n            currentFocus: memo.current_focus,\n            patternNotes: appendedNotes,\n            anomaliesWatching: memo.anomalies_watching,\n        });\n    } catch (err) {\n        // Non-fatal â€” agent memo write failure should not crash the service\n        console.error(\"[agent-identity] writeAgentMemo error:\", err);\n    }\n}\n\n/**\n * Convenience helper: builds the context prefix that every agent service\n * prepends after the core system prompt:\n *  - Pattern notes (cross-account observations from prior runs)\n *  - Open questions (things the agent was monitoring)\n */\nexport function buildStatePreamble(state: AgentState | undefined): string {\n    if (!state) return \"\";\n\n    const parts: string[] = [];\n\n    if (state.patternNotes) {\n        parts.push(\n            \"PRIOR OBSERVATIONS (Cross-account patterns from previous runs):\",\n            state.patternNotes,\n        );\n    }\n\n    if (state.openQuestions && Array.isArray(state.openQuestions) && state.openQuestions.length > 0) {\n        parts.push(\n            \"\\nOPEN QUESTIONS (Things flagged for monitoring):\",\n            (state.openQuestions as string[]).join(\"\\n\"),\n        );\n    }\n\n    return parts.join(\"\\n\");\n}\n","path":null,"size_bytes":5631,"size_tokens":null},"DEMO-WALKTHROUGH.md":{"content":"# Wallet Share Expander â€” Demo Walkthrough & Recording Plan\n\n**Audience:** Prospective distributors evaluating the platform\n**Duration:** 3â€“5 minutes\n**Tone:** Confident, conversational, data-driven\n\n---\n\n## Pre-Demo Checklist\n\n- [ ] Log in and confirm the dashboard loads with live data\n- [ ] Verify Daily Briefing Card is visible (if previously dismissed, it resets via admin controls)\n- [ ] Have the Ask Anything bar visible at the top of the dashboard\n- [ ] Confirm the demo accounts are seeded: Midwest Pipe & Supply, Palmetto Heating & Air, Allied Mechanical Group\n\n---\n\n## Demo Flow â€” Step by Step\n\n### Step 1: Dashboard Overview (30 seconds)\n\n**What to show:** The main dashboard with KPI cards and the Daily Briefing Card.\n\n**Talking points:**\n- \"This is the Wallet Share Expander dashboard. It gives you a single view of your entire portfolio â€” 20 accounts, 11 enrolled in growth programs, and $169K in incremental revenue already tracked.\"\n- Point out the top KPI cards: Total Accounts, Enrolled Accounts, Incremental Revenue.\n- Mention the segment breakdown: HVAC (9 accounts), Plumbing (6), Mechanical (5).\n\n---\n\n### Step 2: Daily Briefing Card (45 seconds)\n\n**What to show:** The Daily Briefing Card on the dashboard.\n\n**Talking points:**\n- \"Every morning the AI scans your entire portfolio and surfaces what needs attention today. No more digging through spreadsheets.\"\n- Highlight the 2 urgent tasks for today:\n  - **Coastal Mechanical** â€” At-risk check-in. 90 days enrolled, no revenue growth, last order 47 days ago.\n  - **Palmetto Heating & Air** â€” URGENT. Ferguson competitor quote detected in email. Act within 24 hours.\n- Click \"View Full Briefing\" to expand and show the pending actions list:\n  - Midwest Pipe & Supply: $53K total opportunity, highest-value unenrolled account\n  - Palmetto Heating & Air: Ferguson actively quoting the $10.7K Controls gap\n  - Allied Mechanical Group: Follow up on PVF pricing sheet, $17.8K gap still open\n\n---\n\n### Step 3: Account Dossier â€” Deep Dive on Midwest Pipe & Supply (60 seconds)\n\n**What to show:** Click on Midwest Pipe & Supply (Account ID 238) from the Accounts page or dashboard to open the Account Dossier panel.\n\n**Talking points:**\n- \"Let's look at our highest-opportunity account. Midwest Pipe & Supply has $162K in annual revenue but only 29% category penetration â€” that means 71% of their wallet is going somewhere else.\"\n- Highlight the key data in the dossier:\n  - Opportunity Score: 87\n  - Segment: Plumbing | Region: Midwest | TM: Mike Thornton\n  - Top spending gaps: $27.5K in PVF (86.8% gap), $25.9K in Water Heaters (76.2% gap)\n  - Active projects: Eastside Mixed-Use Development ($340K, bidding) and Downtown Office HVAC Retrofit ($125K, active)\n- \"The AI has identified two active construction projects where we can anchor a pitch â€” that's $465K in project value where this customer will need materials.\"\n\n---\n\n### Step 4: Call Script Generation (30 seconds)\n\n**What to show:** From the Account Dossier or Playbooks page, open a call script for the Midwest Pipe & Supply task (Task: \"Call: Midwest Pipe â€” Top Unenrolled Opportunity\").\n\n**Talking points:**\n- \"With one click, the AI generates a personalized call script. It knows the account's gaps, their active projects, and even which competitor they might be buying from.\"\n- Show the script content â€” it references specific dollar amounts, project names, and product categories.\n- \"Your rep doesn't need to prep for 30 minutes. They open this, pick up the phone, and go.\"\n\n---\n\n### Step 5: Email Composer â€” Palmetto Heating & Air (45 seconds)\n\n**What to show:** Navigate to the Playbooks page or Account Dossier for Palmetto Heating & Air (Account ID 234). Open the email task or email composer.\n\n**Talking points:**\n- \"Palmetto Heating & Air is at-risk â€” Ferguson was mentioned in a recent email, quoting on the Controls & Thermostats category where we have a $10.7K gap.\"\n- Show the AI-generated email template with the pre-filled subject and body.\n- Click \"Send from Email\" to demonstrate how it copies the content and opens the default email client.\n- \"Your rep can customize it, hit send, and the interaction is logged automatically. No copy-paste, no lost follow-ups.\"\n- Mention the active projects: Palmetto Gardens Condo Complex ($210K) and County Hospital Wing Expansion ($175K, bidding).\n\n---\n\n### Step 6: Ask Anything Bar (45 seconds)\n\n**What to show:** The Ask Anything bar at the top of the dashboard.\n\n**Talking points:**\n- \"This is the Ask Anything bar. Your team can ask natural language questions about the entire portfolio and get instant, data-backed answers.\"\n- Type one of the suggested questions below and show the streaming response.\n- \"It's like having a sales analyst on call 24/7 â€” except it already knows every account, every gap, and every trend.\"\n\n---\n\n## Suggested Ask Anything Questions\n\nUse these questions during the demo to showcase the AI's capabilities. Each one is designed to return rich, specific results based on the current seed data.\n\n### Portfolio-Level Questions (Scope: Portfolio)\n\n1. **\"Which accounts have the biggest revenue gaps and should be prioritized for enrollment?\"**\n   - Expected result: Highlights Midwest Pipe & Supply (score 87, 29% penetration, $162K revenue), Chicago Comfort Systems (score 86, 31% penetration), Carolina Climate Control (score 86, 34% penetration), and Premier Plumbing NJ (score 85, 28% penetration). All are unenrolled with high opportunity scores.\n\n2. **\"What's the risk situation with our enrolled accounts and what should we do about it?\"**\n   - Expected result: Identifies Palmetto Heating & Air (at-risk, Ferguson competitor quote, $10.7K Controls gap) and Coastal Mechanical (at-risk, 90 days with no growth, last order 47 days ago). Provides specific action recommendations.\n\n3. **\"How is Mike Thornton's territory performing compared to the other reps?\"**\n   - Expected result: Breaks down Mike Thornton's 9 accounts in Midwest/Great Lakes vs. Sarah Chen's 5 in Northeast/Mid-Atlantic vs. James Rivera's 6 in Southeast/Florida. Compares revenue, penetration, and enrollment rates.\n\n4. **\"Which accounts haven't ordered in over 30 days?\"**\n   - Expected result: Lists accounts with stale order history, flagging potential churn risks. Highlights Coastal Mechanical (47 days since last order) and any others with aging order dates.\n\n5. **\"Show me the total dollar opportunity across all unenrolled accounts.\"**\n   - Expected result: Sums up the gap dollars across the 9 unenrolled accounts (Midwest Pipe, Chicago Comfort, Carolina Climate, Premier Plumbing, Atlantic Plumbing, Ohio Valley, Detroit Climate, Lake Shore, Indiana Plumbing). Should total well over $200K in addressable opportunity.\n\n### Account-Level Questions (Scope: Account â€” select a specific account first)\n\n6. **\"What categories are we losing share in and how should I approach the buyer?\"** *(Select: Midwest Pipe & Supply)*\n   - Expected result: Details the PVF gap ($27.5K, 86.8%), Water Heaters ($25.9K, 76.2%), and smaller gaps. References the active Eastside Mixed-Use project as a conversation anchor.\n\n7. **\"Draft a strategy to win back the Controls category from Ferguson.\"** *(Select: Palmetto Heating & Air)*\n   - Expected result: Builds a competitive counter-strategy referencing the $10.7K Controls gap, the Ferguson quote detection, and the Palmetto Gardens Condo project as leverage.\n\n---\n\n## Key Data Points for Narration\n\n| Metric | Value |\n|---|---|\n| Total Accounts | 20 |\n| Enrolled in Growth Program | 11 |\n| Graduated (Success Stories) | 3 (Metro HVAC, Sunshine HVAC, Great Lakes Heating) |\n| At-Risk Accounts | 2 (Palmetto Heating & Air, Coastal Mechanical) |\n| Incremental Revenue Tracked | $169,000 |\n| Segments | HVAC (9), Plumbing (6), Mechanical (5) |\n| Territory Managers | Sarah Chen, James Rivera, Mike Thornton |\n| Top Unenrolled Opportunity | Midwest Pipe & Supply â€” Score 87, $53K gap |\n| Competitor Detected | Ferguson Enterprises (quoting Palmetto H&A) |\n| Active Projects in Pipeline | 6 projects across 3 accounts, ~$1.4M total value |\n\n---\n\n## Closing Statement (15 seconds)\n\n\"The Wallet Share Expander doesn't just show you data â€” it tells you exactly what to do, writes the scripts, drafts the emails, and tracks whether it worked. Your reps spend less time prepping and more time selling. That's how you recover wallet share at scale.\"\n\n---\n\n## Recording Tips\n\n- Use a clean browser window (no extra tabs or bookmarks visible)\n- Set the browser to 100% zoom for readable text\n- If using screen recording software, capture at 1080p minimum\n- Pause briefly on each key screen to let the viewer absorb the data\n- Keep mouse movements deliberate â€” avoid hovering randomly\n- For the Ask Anything demo, type the question slowly so viewers can read along\n- Consider recording audio separately for a cleaner voiceover\n","path":null,"size_bytes":8882,"size_tokens":null},"server/services/email-ai-analysis.ts":{"content":"import { db } from \"../db\";\nimport { syncedEmails, accounts, customCategories, type SyncedEmail } from \"@shared/schema\";\nimport { eq, and } from \"drizzle-orm\";\nimport OpenAI from \"openai\";\nimport { z } from \"zod\";\n\nconst ContactSchema = z.object({\n  first_name: z.string(),\n  last_name: z.string().optional().default(\"\"),\n  email: z.string().optional().default(\"\"),\n  title: z.string().optional().default(\"\"),\n  role: z.enum([\"purchaser\", \"project_manager\", \"estimator\", \"owner\", \"decision_maker\", \"influencer\", \"gatekeeper\", \"unknown\"]).default(\"unknown\"),\n  department: z.string().optional().default(\"\"),\n});\n\nconst ProjectSchema = z.object({\n  name: z.string(),\n  location: z.string().optional().default(\"\"),\n  project_type: z.enum([\"new_construction\", \"renovation\", \"retrofit\", \"maintenance\", \"tenant_improvement\", \"unknown\"]).default(\"unknown\"),\n  estimated_value: z.string().optional().default(\"\"),\n  stage: z.enum([\"identified\", \"bidding\", \"awarded\", \"in_progress\", \"completed\", \"unknown\"]).default(\"identified\"),\n  start_date: z.string().optional().default(\"\"),\n  bid_deadline: z.string().optional().default(\"\"),\n  general_contractor: z.string().optional().default(\"\"),\n  unit_count: z.number().optional(),\n  square_footage: z.number().optional(),\n  product_categories: z.array(z.string()).default([]),\n});\n\nconst OrderSignalSchema = z.object({\n  signal_type: z.enum([\"quote_request\", \"reorder\", \"pricing_inquiry\", \"product_inquiry\", \"purchase_intent\", \"delivery_request\"]),\n  product_category: z.string().optional().default(\"\"),\n  product_details: z.string().optional().default(\"\"),\n  estimated_quantity: z.string().optional().default(\"\"),\n  estimated_value: z.string().optional().default(\"\"),\n  delivery_date: z.string().optional().default(\"\"),\n  urgency: z.enum([\"immediate\", \"this_week\", \"this_month\", \"next_quarter\", \"exploring\"]).default(\"exploring\"),\n  pricing_mentioned: z.boolean().default(false),\n  competitor_price_mentioned: z.boolean().default(false),\n});\n\nconst CompetitorMentionSchema = z.object({\n  competitor_name: z.string(),\n  mention_type: z.enum([\"quote\", \"pricing\", \"product_comparison\", \"switch_threat\", \"positive_mention\", \"negative_mention\"]),\n  product_category: z.string().optional().default(\"\"),\n  competitor_price: z.string().optional().default(\"\"),\n  our_price: z.string().optional().default(\"\"),\n  details: z.string().optional().default(\"\"),\n  threat_level: z.enum([\"low\", \"medium\", \"high\", \"critical\"]).default(\"medium\"),\n  response_needed: z.boolean().default(false),\n});\n\nconst EnhancedEmailAnalysisSchema = z.object({\n  sentiment: z.enum([\"positive\", \"neutral\", \"negative\", \"urgent\"]),\n  summary: z.string().max(500),\n  sales_urgency: z.object({\n    level: z.enum([\"immediate\", \"this_week\", \"this_month\", \"next_quarter\", \"no_urgency\"]),\n    deadline: z.string().optional().default(\"\"),\n    reason: z.string().optional().default(\"\"),\n  }),\n  action_items: z.array(z.object({\n    action: z.string(),\n    priority: z.enum([\"high\", \"medium\", \"low\"]),\n    task_type: z.enum([\"call\", \"email\", \"visit\", \"quote\", \"follow_up\", \"internal\"]),\n    product_category: z.string().optional().default(\"\"),\n    deadline: z.string().optional().default(\"\"),\n  })).max(5),\n  contacts_detected: z.array(ContactSchema).max(5),\n  projects_detected: z.array(ProjectSchema).max(3),\n  order_signals: z.array(OrderSignalSchema).max(5),\n  competitor_mentions: z.array(CompetitorMentionSchema).max(5),\n  account_mentions: z.array(z.string()).max(10),\n  product_categories_discussed: z.array(z.string()).max(10),\n});\n\nexport type EnhancedEmailAnalysis = z.infer<typeof EnhancedEmailAnalysisSchema>;\n\nexport async function analyzeEmail(email: SyncedEmail, tenantId: number): Promise<EnhancedEmailAnalysis | null> {\n  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });\n\n  const [tenantAccounts, categories] = await Promise.all([\n    db.select({ id: accounts.id, name: accounts.name, segment: accounts.segment })\n      .from(accounts)\n      .where(eq(accounts.tenantId, tenantId)),\n    db.select({ id: customCategories.id, name: customCategories.name })\n      .from(customCategories)\n      .where(and(\n        eq(customCategories.tenantId, tenantId),\n        eq(customCategories.isActive, true),\n      )),\n  ]);\n\n  const accountNames = tenantAccounts.map(a => a.name);\n  const categoryNames = categories.map(c => c.name);\n\n  const toAddrs = Array.isArray(email.toAddresses)\n    ? (email.toAddresses as Array<{ email: string; name: string }>).map(a => `${a.name} <${a.email}>`).join(\", \")\n    : \"\";\n  const ccAddrs = Array.isArray(email.ccAddresses)\n    ? (email.ccAddresses as Array<{ email: string; name: string }>).map(a => `${a.name} <${a.email}>`).join(\", \")\n    : \"\";\n\n  const prompt = `You are an expert sales intelligence analyst for a building materials distributor. Analyze the following email and extract comprehensive, actionable intelligence.\n\n=== EMAIL ===\nFROM: ${email.fromName} <${email.fromAddress}>\nTO: ${toAddrs}\n${ccAddrs ? `CC: ${ccAddrs}` : \"\"}\nSUBJECT: ${email.subject}\nDATE: ${email.receivedAt ? new Date(email.receivedAt).toLocaleDateString() : \"Unknown\"}\nDIRECTION: ${email.direction || \"inbound\"}\n\nBODY:\n${(email.bodyText || email.bodyPreview || \"\").slice(0, 4000)}\n\n=== CONTEXT ===\n\nKNOWN CUSTOMER ACCOUNTS:\n${accountNames.slice(0, 100).join(\", \")}\n\nYOUR PRODUCT CATEGORIES (map email content to these when possible):\n${categoryNames.length > 0 ? categoryNames.join(\", \") : \"HVAC Equipment, Ductwork & Fittings, Refrigerant & Supplies, Controls & Thermostats, Water Heaters, Plumbing Fixtures, Pipe & Fittings, PVF (Pipe, Valves, Fittings), Drainage Systems, Insulation Materials, Tools & Safety, Electrical Components\"}\n\nCOMMON COMPETITORS IN BUILDING MATERIALS DISTRIBUTION:\nFerguson, Winsupply, Hajoca, F.W. Webb, R.E. Michel, Johnstone Supply, Gensco, US LBM, Builders FirstSource, HD Supply, Grainger\n\n=== EXTRACTION INSTRUCTIONS ===\n\nReturn a JSON object with the following fields:\n\n1. \"sentiment\": Overall email tone â€” \"positive\", \"neutral\", \"negative\", or \"urgent\"\n\n2. \"summary\": 2-3 sentence summary emphasizing sales-relevant information (who wants what, by when, and why it matters)\n\n3. \"sales_urgency\": How time-sensitive this is for sales action\n   - \"level\": \"immediate\" (needs response today), \"this_week\", \"this_month\", \"next_quarter\", \"no_urgency\"\n   - \"deadline\": Specific deadline if mentioned (e.g. \"2026-03-15\" or \"end of March\")\n   - \"reason\": Why it's urgent (e.g. \"Bid deadline Friday\", \"Competitor quoting now\")\n\n4. \"action_items\": Specific follow-up actions for the sales team\n   - \"action\": What needs to be done\n   - \"priority\": \"high\", \"medium\", \"low\"\n   - \"task_type\": \"call\", \"email\", \"visit\", \"quote\", \"follow_up\", \"internal\"\n   - \"product_category\": Which product category this relates to (from the list above)\n   - \"deadline\": When this should be done by\n\n5. \"contacts_detected\": People mentioned or identified from email signatures, CC lines, or body\n   - \"first_name\", \"last_name\", \"email\", \"title\", \"department\"\n   - \"role\": \"purchaser\", \"project_manager\", \"estimator\", \"owner\", \"decision_maker\", \"influencer\", \"gatekeeper\", \"unknown\"\n\n6. \"projects_detected\": Construction projects, jobs, or installations mentioned\n   - \"name\": Project or job name/description\n   - \"location\": City, state, or address if mentioned\n   - \"project_type\": \"new_construction\", \"renovation\", \"retrofit\", \"maintenance\", \"tenant_improvement\", \"unknown\"\n   - \"estimated_value\": Dollar value if mentioned\n   - \"stage\": \"identified\", \"bidding\", \"awarded\", \"in_progress\", \"completed\", \"unknown\"\n   - \"start_date\", \"bid_deadline\": Dates if mentioned (ISO format)\n   - \"general_contractor\": GC name if mentioned\n   - \"unit_count\": Number of units if a multi-unit project\n   - \"square_footage\": Square footage if mentioned\n   - \"product_categories\": Which of your product categories this project will need\n\n7. \"order_signals\": Purchase intent, quote requests, reorder patterns\n   - \"signal_type\": \"quote_request\", \"reorder\", \"pricing_inquiry\", \"product_inquiry\", \"purchase_intent\", \"delivery_request\"\n   - \"product_category\": Map to your product categories\n   - \"product_details\": Specific products or SKUs mentioned\n   - \"estimated_quantity\": Quantities mentioned\n   - \"estimated_value\": Dollar value if discussed\n   - \"delivery_date\": Requested delivery date\n   - \"urgency\": \"immediate\", \"this_week\", \"this_month\", \"next_quarter\", \"exploring\"\n   - \"pricing_mentioned\": true if pricing/costs discussed\n   - \"competitor_price_mentioned\": true if competitor pricing referenced\n\n8. \"competitor_mentions\": Any reference to competing distributors or their offerings\n   - \"competitor_name\": Company name\n   - \"mention_type\": \"quote\" (they got a quote), \"pricing\" (price comparison), \"product_comparison\", \"switch_threat\", \"positive_mention\", \"negative_mention\"\n   - \"product_category\": What category the competition is for\n   - \"competitor_price\", \"our_price\": If pricing mentioned\n   - \"details\": Context of the mention\n   - \"threat_level\": \"low\", \"medium\", \"high\", \"critical\"\n   - \"response_needed\": true if immediate competitive response needed\n\n9. \"account_mentions\": Customer account names mentioned (match against known accounts when possible)\n\n10. \"product_categories_discussed\": List of your product categories referenced or implied in this email\n\nIf a field has no data, return empty arrays [] or empty strings \"\". Only include data you can confidently extract â€” do not fabricate.`;\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        {\n          role: \"system\",\n          content: \"You are a senior sales intelligence analyst specializing in building materials distribution. You extract actionable intelligence from emails to help Territory Managers close more deals, defend against competitors, and identify project opportunities. Always return valid JSON matching the requested schema exactly.\",\n        },\n        { role: \"user\", content: prompt },\n      ],\n      response_format: { type: \"json_object\" },\n      temperature: 0.15,\n      max_tokens: 2500,\n    });\n\n    const raw = JSON.parse(completion.choices[0].message.content ?? \"{}\");\n    const analysis = EnhancedEmailAnalysisSchema.parse(raw);\n\n    let linkedAccountId = email.linkedAccountId;\n    if (!linkedAccountId && analysis.account_mentions.length > 0) {\n      for (const mention of analysis.account_mentions) {\n        const matchedAccount = tenantAccounts.find(\n          a => a.name.toLowerCase() === mention.toLowerCase()\n        );\n        if (matchedAccount) {\n          linkedAccountId = matchedAccount.id;\n          break;\n        }\n      }\n    }\n\n    await db.update(syncedEmails)\n      .set({\n        aiAnalyzed: true,\n        aiSentiment: analysis.sentiment,\n        aiSummary: analysis.summary,\n        aiActionItems: analysis.action_items,\n        aiOpportunitySignals: analysis.order_signals,\n        aiAccountMentions: analysis.account_mentions,\n        linkedAccountId: linkedAccountId || email.linkedAccountId,\n      })\n      .where(eq(syncedEmails.id, email.id));\n\n    return analysis;\n  } catch (err: any) {\n    console.error(`AI analysis failed for email ${email.id}:`, err?.message);\n    await db.update(syncedEmails)\n      .set({ aiAnalyzed: true, aiSummary: `Analysis failed: ${err?.message}` })\n      .where(eq(syncedEmails.id, email.id));\n    return null;\n  }\n}\n\nexport async function analyzeUnprocessedEmails(tenantId: number, limit: number = 10): Promise<{ analyzed: number; errors: number; crmRecordsCreated: number }> {\n  const { linkEmailToCrm } = await import(\"./email-crm-linker.js\");\n\n  const unanalyzed = await db.select()\n    .from(syncedEmails)\n    .where(and(\n      eq(syncedEmails.tenantId, tenantId),\n      eq(syncedEmails.aiAnalyzed, false),\n    ))\n    .limit(limit);\n\n  let analyzed = 0;\n  let errors = 0;\n  let crmRecordsCreated = 0;\n\n  for (const email of unanalyzed) {\n    try {\n      const analysis = await analyzeEmail(email, tenantId);\n      analyzed++;\n\n      if (analysis) {\n        const refetchedEmail = await db.select().from(syncedEmails).where(eq(syncedEmails.id, email.id)).limit(1);\n        const updatedEmail = refetchedEmail[0] ?? email;\n        const stats = await linkEmailToCrm(updatedEmail, analysis, tenantId);\n        crmRecordsCreated += stats.contactsCreated + stats.projectsCreated + stats.orderSignalsCreated + stats.competitorMentionsCreated;\n      }\n    } catch (err: any) {\n      console.error(`Email analysis pipeline error for email ${email.id}:`, err?.message);\n      errors++;\n    }\n  }\n\n  return { analyzed, errors, crmRecordsCreated };\n}\n","path":null,"size_bytes":12618,"size_tokens":null},"server/services/email-sync.ts":{"content":"import { db } from \"../db\";\nimport { syncedEmails, emailConnections, accounts, type EmailConnection, type SyncedEmail, type InsertSyncedEmail } from \"@shared/schema\";\nimport { eq, and, desc } from \"drizzle-orm\";\nimport { getValidAccessToken } from \"./email-oauth\";\n\ninterface RawEmail {\n  externalId: string;\n  fromAddress: string;\n  fromName: string;\n  toAddresses: Array<{ email: string; name: string }>;\n  ccAddresses: Array<{ email: string; name: string }>;\n  subject: string;\n  bodyPreview: string;\n  bodyText: string;\n  receivedAt: Date;\n  direction: \"inbound\" | \"outbound\";\n}\n\nasync function fetchMicrosoftEmails(accessToken: string, since?: Date): Promise<RawEmail[]> {\n  const filter = since\n    ? `&$filter=receivedDateTime ge ${since.toISOString()}`\n    : \"\";\n\n  const res = await fetch(\n    `https://graph.microsoft.com/v1.0/me/messages?$top=50&$orderby=receivedDateTime desc&$select=id,from,toRecipients,ccRecipients,subject,bodyPreview,body,receivedDateTime,sender${filter}`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  if (!res.ok) {\n    const errText = await res.text();\n    throw new Error(`Microsoft Graph API error: ${res.status} ${errText}`);\n  }\n\n  const data = await res.json();\n  const messages: any[] = data.value || [];\n\n  return messages.map((msg) => ({\n    externalId: msg.id,\n    fromAddress: msg.from?.emailAddress?.address || \"\",\n    fromName: msg.from?.emailAddress?.name || \"\",\n    toAddresses: (msg.toRecipients || []).map((r: any) => ({\n      email: r.emailAddress?.address || \"\",\n      name: r.emailAddress?.name || \"\",\n    })),\n    ccAddresses: (msg.ccRecipients || []).map((r: any) => ({\n      email: r.emailAddress?.address || \"\",\n      name: r.emailAddress?.name || \"\",\n    })),\n    subject: msg.subject || \"\",\n    bodyPreview: msg.bodyPreview || \"\",\n    bodyText: msg.body?.content\n      ? msg.body.content.replace(/<[^>]*>/g, \" \").replace(/\\s+/g, \" \").trim().slice(0, 5000)\n      : \"\",\n    receivedAt: new Date(msg.receivedDateTime),\n    direction: \"inbound\" as const,\n  }));\n}\n\nasync function fetchGmailEmails(accessToken: string, since?: Date): Promise<RawEmail[]> {\n  const query = since ? `after:${Math.floor(since.getTime() / 1000)}` : \"\";\n  const listRes = await fetch(\n    `https://gmail.googleapis.com/gmail/v1/users/me/messages?maxResults=50${query ? `&q=${encodeURIComponent(query)}` : \"\"}`,\n    { headers: { Authorization: `Bearer ${accessToken}` } }\n  );\n\n  if (!listRes.ok) {\n    const errText = await listRes.text();\n    throw new Error(`Gmail API list error: ${listRes.status} ${errText}`);\n  }\n\n  const listData = await listRes.json();\n  const messageRefs: Array<{ id: string }> = listData.messages || [];\n  const emails: RawEmail[] = [];\n\n  for (const ref of messageRefs.slice(0, 50)) {\n    try {\n      const msgRes = await fetch(\n        `https://gmail.googleapis.com/gmail/v1/users/me/messages/${ref.id}?format=full`,\n        { headers: { Authorization: `Bearer ${accessToken}` } }\n      );\n\n      if (!msgRes.ok) continue;\n      const msg = await msgRes.json();\n\n      const headers = msg.payload?.headers || [];\n      const getHeader = (name: string) =>\n        headers.find((h: any) => h.name.toLowerCase() === name.toLowerCase())?.value || \"\";\n\n      const fromRaw = getHeader(\"From\");\n      const fromMatch = fromRaw.match(/^(.+?)\\s*<(.+?)>$/) || [null, \"\", fromRaw];\n\n      let bodyText = \"\";\n      const extractBody = (part: any): string => {\n        if (part.body?.data) {\n          return Buffer.from(part.body.data, \"base64url\").toString(\"utf-8\");\n        }\n        if (part.parts) {\n          for (const p of part.parts) {\n            if (p.mimeType === \"text/plain\") {\n              const text = extractBody(p);\n              if (text) return text;\n            }\n          }\n          for (const p of part.parts) {\n            const text = extractBody(p);\n            if (text) return text;\n          }\n        }\n        return \"\";\n      };\n\n      bodyText = extractBody(msg.payload || {});\n      if (bodyText.length > 5000) bodyText = bodyText.slice(0, 5000);\n\n      const parseAddresses = (header: string) => {\n        if (!header) return [];\n        return header.split(\",\").map((addr) => {\n          const match = addr.trim().match(/^(.+?)\\s*<(.+?)>$/);\n          return match\n            ? { name: match[1].trim().replace(/^\"|\"$/g, \"\"), email: match[2] }\n            : { name: \"\", email: addr.trim() };\n        });\n      };\n\n      emails.push({\n        externalId: msg.id,\n        fromAddress: fromMatch[2] || fromRaw,\n        fromName: (fromMatch[1] || \"\").replace(/^\"|\"$/g, \"\").trim(),\n        toAddresses: parseAddresses(getHeader(\"To\")),\n        ccAddresses: parseAddresses(getHeader(\"Cc\")),\n        subject: getHeader(\"Subject\"),\n        bodyPreview: (msg.snippet || \"\").slice(0, 200),\n        bodyText: bodyText.replace(/<[^>]*>/g, \" \").replace(/\\s+/g, \" \").trim(),\n        receivedAt: new Date(parseInt(msg.internalDate)),\n        direction: \"inbound\",\n      });\n    } catch {\n      continue;\n    }\n  }\n\n  return emails;\n}\n\nexport async function syncEmailsForConnection(connection: EmailConnection): Promise<{ synced: number; errors: number }> {\n  let synced = 0;\n  let errors = 0;\n\n  try {\n    const accessToken = await getValidAccessToken(connection);\n\n    const rawEmails = connection.provider === \"microsoft\"\n      ? await fetchMicrosoftEmails(accessToken, connection.lastSyncAt || undefined)\n      : await fetchGmailEmails(accessToken, connection.lastSyncAt || undefined);\n\n    const tenantAccounts = await db.select()\n      .from(accounts)\n      .where(eq(accounts.tenantId, connection.tenantId));\n\n    const accountNames = new Map<string, number>();\n    for (const acc of tenantAccounts) {\n      accountNames.set(acc.name.toLowerCase(), acc.id);\n    }\n\n    for (const email of rawEmails) {\n      try {\n        const existingEmail = await db.select({ id: syncedEmails.id })\n          .from(syncedEmails)\n          .where(and(\n            eq(syncedEmails.connectionId, connection.id),\n            eq(syncedEmails.externalId, email.externalId),\n          ))\n          .limit(1);\n\n        if (existingEmail.length > 0) continue;\n\n        let linkedAccountId: number | null = null;\n        const fromNameLower = email.fromName?.toLowerCase() || \"\";\n        const subjectLower = email.subject?.toLowerCase() || \"\";\n        accountNames.forEach((id, name) => {\n          if (!linkedAccountId && (fromNameLower.includes(name) || subjectLower.includes(name))) {\n            linkedAccountId = id;\n          }\n        });\n\n        const insertData: InsertSyncedEmail = {\n          tenantId: connection.tenantId,\n          connectionId: connection.id,\n          externalId: email.externalId,\n          fromAddress: email.fromAddress,\n          fromName: email.fromName,\n          toAddresses: email.toAddresses,\n          ccAddresses: email.ccAddresses,\n          subject: email.subject,\n          bodyPreview: email.bodyPreview.slice(0, 200),\n          bodyText: email.bodyText,\n          receivedAt: email.receivedAt,\n          direction: email.direction,\n          linkedAccountId,\n          aiAnalyzed: false,\n        };\n\n        await db.insert(syncedEmails).values(insertData);\n        synced++;\n      } catch (err) {\n        errors++;\n        console.error(`Failed to store email ${email.externalId}:`, err);\n      }\n    }\n\n    await db.update(emailConnections)\n      .set({ lastSyncAt: new Date(), syncError: null, updatedAt: new Date() })\n      .where(eq(emailConnections.id, connection.id));\n\n  } catch (err: any) {\n    await db.update(emailConnections)\n      .set({\n        syncError: err?.message || String(err),\n        status: err?.message?.includes(\"expired\") ? \"expired\" : \"error\",\n        updatedAt: new Date(),\n      })\n      .where(eq(emailConnections.id, connection.id));\n    throw err;\n  }\n\n  return { synced, errors };\n}\n\nexport async function getSyncedEmails(\n  tenantId: number,\n  options?: { connectionId?: number; accountId?: number; limit?: number; offset?: number; analyzed?: boolean }\n): Promise<{ emails: SyncedEmail[]; total: number }> {\n  const conditions = [eq(syncedEmails.tenantId, tenantId)];\n\n  if (options?.connectionId) {\n    conditions.push(eq(syncedEmails.connectionId, options.connectionId));\n  }\n  if (options?.accountId) {\n    conditions.push(eq(syncedEmails.linkedAccountId, options.accountId));\n  }\n  if (options?.analyzed !== undefined) {\n    conditions.push(eq(syncedEmails.aiAnalyzed, options.analyzed));\n  }\n\n  const whereClause = conditions.length === 1 ? conditions[0] : and(...conditions);\n\n  const [countResult] = await db.select({ count: syncedEmails.id })\n    .from(syncedEmails)\n    .where(whereClause!);\n\n  const emails = await db.select()\n    .from(syncedEmails)\n    .where(whereClause!)\n    .orderBy(desc(syncedEmails.receivedAt))\n    .limit(options?.limit || 50)\n    .offset(options?.offset || 0);\n\n  return { emails, total: Number(countResult?.count || 0) };\n}\n\nexport async function getSyncedEmail(id: number, tenantId: number): Promise<SyncedEmail | undefined> {\n  const [email] = await db.select()\n    .from(syncedEmails)\n    .where(and(\n      eq(syncedEmails.id, id),\n      eq(syncedEmails.tenantId, tenantId),\n    ))\n    .limit(1);\n  return email;\n}\n","path":null,"size_bytes":9220,"size_tokens":null},"server/services/email-oauth.ts":{"content":"import { db } from \"../db\";\nimport { emailConnections, type EmailConnection, type InsertEmailConnection } from \"@shared/schema\";\nimport { eq, and } from \"drizzle-orm\";\n\nconst MICROSOFT_AUTH_URL = \"https://login.microsoftonline.com/common/oauth2/v2.0/authorize\";\nconst MICROSOFT_TOKEN_URL = \"https://login.microsoftonline.com/common/oauth2/v2.0/token\";\nconst GOOGLE_AUTH_URL = \"https://accounts.google.com/o/oauth2/v2/auth\";\nconst GOOGLE_TOKEN_URL = \"https://oauth2.googleapis.com/token\";\n\nfunction getBaseUrl(): string {\n  return process.env.BASE_URL || `https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`;\n}\n\nexport function getMicrosoftAuthUrl(state: string): string {\n  const clientId = process.env.MICROSOFT_CLIENT_ID;\n  if (!clientId) throw new Error(\"MICROSOFT_CLIENT_ID not configured\");\n\n  const redirectUri = `${getBaseUrl()}/api/auth/microsoft/callback`;\n  const scopes = [\n    \"openid\",\n    \"profile\",\n    \"email\",\n    \"offline_access\",\n    \"https://graph.microsoft.com/Mail.Read\",\n    \"https://graph.microsoft.com/User.Read\",\n  ].join(\" \");\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    response_type: \"code\",\n    redirect_uri: redirectUri,\n    scope: scopes,\n    state,\n    response_mode: \"query\",\n    prompt: \"consent\",\n  });\n\n  return `${MICROSOFT_AUTH_URL}?${params.toString()}`;\n}\n\nexport function getGoogleAuthUrl(state: string): string {\n  const clientId = process.env.GOOGLE_EMAIL_CLIENT_ID;\n  if (!clientId) throw new Error(\"GOOGLE_EMAIL_CLIENT_ID not configured\");\n\n  const redirectUri = `${getBaseUrl()}/api/auth/google-email/callback`;\n  const scopes = [\n    \"openid\",\n    \"email\",\n    \"profile\",\n    \"https://www.googleapis.com/auth/gmail.readonly\",\n  ].join(\" \");\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    response_type: \"code\",\n    redirect_uri: redirectUri,\n    scope: scopes,\n    state,\n    access_type: \"offline\",\n    prompt: \"consent\",\n  });\n\n  return `${GOOGLE_AUTH_URL}?${params.toString()}`;\n}\n\nexport async function exchangeMicrosoftCode(code: string): Promise<{\n  accessToken: string;\n  refreshToken: string;\n  expiresIn: number;\n  email: string;\n}> {\n  const clientId = process.env.MICROSOFT_CLIENT_ID!;\n  const clientSecret = process.env.MICROSOFT_CLIENT_SECRET!;\n  const redirectUri = `${getBaseUrl()}/api/auth/microsoft/callback`;\n\n  const tokenRes = await fetch(MICROSOFT_TOKEN_URL, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n    body: new URLSearchParams({\n      client_id: clientId,\n      client_secret: clientSecret,\n      code,\n      redirect_uri: redirectUri,\n      grant_type: \"authorization_code\",\n    }),\n  });\n\n  if (!tokenRes.ok) {\n    const errorBody = await tokenRes.text();\n    throw new Error(`Microsoft token exchange failed: ${errorBody}`);\n  }\n\n  const tokens = await tokenRes.json();\n\n  const profileRes = await fetch(\"https://graph.microsoft.com/v1.0/me\", {\n    headers: { Authorization: `Bearer ${tokens.access_token}` },\n  });\n\n  if (!profileRes.ok) throw new Error(\"Failed to fetch Microsoft profile\");\n  const profile = await profileRes.json();\n\n  return {\n    accessToken: tokens.access_token,\n    refreshToken: tokens.refresh_token,\n    expiresIn: tokens.expires_in,\n    email: profile.mail || profile.userPrincipalName,\n  };\n}\n\nexport async function exchangeGoogleCode(code: string): Promise<{\n  accessToken: string;\n  refreshToken: string;\n  expiresIn: number;\n  email: string;\n}> {\n  const clientId = process.env.GOOGLE_EMAIL_CLIENT_ID!;\n  const clientSecret = process.env.GOOGLE_EMAIL_CLIENT_SECRET!;\n  const redirectUri = `${getBaseUrl()}/api/auth/google-email/callback`;\n\n  const tokenRes = await fetch(GOOGLE_TOKEN_URL, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n    body: new URLSearchParams({\n      client_id: clientId,\n      client_secret: clientSecret,\n      code,\n      redirect_uri: redirectUri,\n      grant_type: \"authorization_code\",\n    }),\n  });\n\n  if (!tokenRes.ok) {\n    const errorBody = await tokenRes.text();\n    throw new Error(`Google token exchange failed: ${errorBody}`);\n  }\n\n  const tokens = await tokenRes.json();\n\n  const profileRes = await fetch(\"https://www.googleapis.com/oauth2/v2/userinfo\", {\n    headers: { Authorization: `Bearer ${tokens.access_token}` },\n  });\n\n  if (!profileRes.ok) throw new Error(\"Failed to fetch Google profile\");\n  const profile = await profileRes.json();\n\n  return {\n    accessToken: tokens.access_token,\n    refreshToken: tokens.refresh_token,\n    expiresIn: tokens.expires_in,\n    email: profile.email,\n  };\n}\n\nexport async function refreshMicrosoftToken(connection: EmailConnection): Promise<{ accessToken: string; expiresIn: number }> {\n  const clientId = process.env.MICROSOFT_CLIENT_ID!;\n  const clientSecret = process.env.MICROSOFT_CLIENT_SECRET!;\n\n  const tokenRes = await fetch(MICROSOFT_TOKEN_URL, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n    body: new URLSearchParams({\n      client_id: clientId,\n      client_secret: clientSecret,\n      refresh_token: connection.refreshToken!,\n      grant_type: \"refresh_token\",\n    }),\n  });\n\n  if (!tokenRes.ok) throw new Error(\"Microsoft token refresh failed\");\n  const tokens = await tokenRes.json();\n\n  await db.update(emailConnections)\n    .set({\n      accessToken: tokens.access_token,\n      refreshToken: tokens.refresh_token || connection.refreshToken,\n      tokenExpiresAt: new Date(Date.now() + tokens.expires_in * 1000),\n      status: \"connected\",\n      updatedAt: new Date(),\n    })\n    .where(eq(emailConnections.id, connection.id));\n\n  return { accessToken: tokens.access_token, expiresIn: tokens.expires_in };\n}\n\nexport async function refreshGoogleToken(connection: EmailConnection): Promise<{ accessToken: string; expiresIn: number }> {\n  const clientId = process.env.GOOGLE_EMAIL_CLIENT_ID!;\n  const clientSecret = process.env.GOOGLE_EMAIL_CLIENT_SECRET!;\n\n  const tokenRes = await fetch(GOOGLE_TOKEN_URL, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n    body: new URLSearchParams({\n      client_id: clientId,\n      client_secret: clientSecret,\n      refresh_token: connection.refreshToken!,\n      grant_type: \"refresh_token\",\n    }),\n  });\n\n  if (!tokenRes.ok) throw new Error(\"Google token refresh failed\");\n  const tokens = await tokenRes.json();\n\n  await db.update(emailConnections)\n    .set({\n      accessToken: tokens.access_token,\n      tokenExpiresAt: new Date(Date.now() + tokens.expires_in * 1000),\n      status: \"connected\",\n      updatedAt: new Date(),\n    })\n    .where(eq(emailConnections.id, connection.id));\n\n  return { accessToken: tokens.access_token, expiresIn: tokens.expires_in };\n}\n\nexport async function getValidAccessToken(connection: EmailConnection): Promise<string> {\n  if (connection.tokenExpiresAt && new Date(connection.tokenExpiresAt) > new Date(Date.now() + 60000)) {\n    return connection.accessToken;\n  }\n\n  if (!connection.refreshToken) {\n    await db.update(emailConnections)\n      .set({ status: \"expired\", updatedAt: new Date() })\n      .where(eq(emailConnections.id, connection.id));\n    throw new Error(\"Token expired and no refresh token available\");\n  }\n\n  try {\n    const result = connection.provider === \"microsoft\"\n      ? await refreshMicrosoftToken(connection)\n      : await refreshGoogleToken(connection);\n    return result.accessToken;\n  } catch (err) {\n    await db.update(emailConnections)\n      .set({ status: \"expired\", syncError: String(err), updatedAt: new Date() })\n      .where(eq(emailConnections.id, connection.id));\n    throw err;\n  }\n}\n\nexport async function saveEmailConnection(data: InsertEmailConnection): Promise<EmailConnection> {\n  const existing = await db.select()\n    .from(emailConnections)\n    .where(and(\n      eq(emailConnections.tenantId, data.tenantId),\n      eq(emailConnections.provider, data.provider),\n      eq(emailConnections.emailAddress, data.emailAddress),\n    ))\n    .limit(1);\n\n  if (existing.length > 0) {\n    const [updated] = await db.update(emailConnections)\n      .set({\n        accessToken: data.accessToken,\n        refreshToken: data.refreshToken,\n        tokenExpiresAt: data.tokenExpiresAt,\n        status: \"connected\",\n        syncError: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(emailConnections.id, existing[0].id))\n      .returning();\n    return updated;\n  }\n\n  const [connection] = await db.insert(emailConnections).values(data).returning();\n  return connection;\n}\n\nexport async function getEmailConnections(tenantId: number): Promise<EmailConnection[]> {\n  return db.select()\n    .from(emailConnections)\n    .where(eq(emailConnections.tenantId, tenantId));\n}\n\nexport async function getEmailConnection(id: number, tenantId: number): Promise<EmailConnection | undefined> {\n  const [connection] = await db.select()\n    .from(emailConnections)\n    .where(and(\n      eq(emailConnections.id, id),\n      eq(emailConnections.tenantId, tenantId),\n    ))\n    .limit(1);\n  return connection;\n}\n\nexport async function disconnectEmailConnection(id: number, tenantId: number): Promise<void> {\n  await db.update(emailConnections)\n    .set({ status: \"disconnected\", accessToken: \"\", refreshToken: null, updatedAt: new Date() })\n    .where(and(\n      eq(emailConnections.id, id),\n      eq(emailConnections.tenantId, tenantId),\n    ));\n}\n\nexport async function getActiveConnections(): Promise<EmailConnection[]> {\n  return db.select()\n    .from(emailConnections)\n    .where(eq(emailConnections.status, \"connected\"));\n}\n","path":null,"size_bytes":9578,"size_tokens":null},"DEMO-EMAIL-INTELLIGENCE.md":{"content":"# Email Intelligence & CRM Auto-Population\n\n## Sell Sheet & Demo Guide\n\n---\n\n## The Problem You're Solving\n\nTerritory Managers spend **60% of their day** reading emails, manually logging contacts, and trying to remember which accounts mentioned a competitor or requested a quote last week. Critical sales intelligence gets buried in inboxes:\n\n- A customer mentions a Ferguson quote and nobody follows up within 24 hours\n- A $500K construction project is discussed across 12 emails but never enters the CRM\n- The purchasing contact changed roles 3 months ago and nobody updated the record\n- A reorder signal sits unread while the customer buys from a competitor\n\n**The result:** lost wallet share, missed projects, and reactive selling instead of proactive selling.\n\n---\n\n## What Email Intelligence Does\n\n### One-Click Inbox Connection\n\nTerritory Managers connect their Microsoft Outlook or Google Gmail account with a single click. No IT tickets, no admin setup, no passwords shared. The system uses secure OAuth â€” the same technology behind \"Sign in with Google\" â€” and only requests **read-only** access. We never send emails on behalf of the user.\n\n### Automatic Email Sync\n\nOnce connected, the system continuously syncs inbound and outbound customer emails. Emails can be linked to known customer accounts (manually or through upstream integrations), enriching account-level intelligence over time. The AI analysis also identifies which known accounts are mentioned in email content.\n\n### AI-Powered Sales Intelligence Extraction\n\nEvery synced email is analyzed by GPT-4o to extract **10 categories of actionable intelligence**:\n\n| Intelligence Category | What It Captures | Why It Matters |\n|---|---|---|\n| **Sentiment Analysis** | Positive, neutral, negative, urgent tone | Spot unhappy customers before they churn |\n| **Sales Urgency** | Deadline, urgency level, reason | Prioritize what needs attention today vs. next month |\n| **Action Items** | Specific follow-ups with priority and type | Never miss a to-do buried in an email |\n| **Contact Detection** | Names, titles, roles, departments | Auto-build your contact database |\n| **Project Detection** | Project names, locations, GCs, values, stages | Track every construction opportunity |\n| **Order Signals** | Quote requests, reorders, pricing inquiries | Catch buying intent the moment it appears |\n| **Competitor Mentions** | Who's quoting, at what price, threat level | Respond to competitive threats in hours, not weeks |\n| **Account Matching** | Links email content to known customer accounts | Enriches account intelligence automatically |\n| **Product Category Mapping** | Maps discussions to your product categories | Understand what customers are buying â€” and what they're not |\n| **Pricing Intelligence** | Competitor prices, your prices, gaps | Arm your team with pricing ammunition |\n\n### CRM Auto-Population\n\nExtracted intelligence doesn't just sit in a report â€” it **automatically creates and updates CRM records**:\n\n- **Contacts** are created or updated with names, titles, roles, and departments. Deduplication ensures no duplicates: matching by email address first, then by name + account.\n- **Projects** are created with location, type, estimated value, stage, GC, and product categories needed. Matched by name to avoid duplicates.\n- **Order Signals** are logged with signal type, product details, quantities, urgency, and competitive pricing flags. Deduplicated by source email to prevent duplicates on re-analysis.\n- **Competitor Mentions** are captured with competitor name, threat level, product category, pricing details, and whether a response is needed. Deduplicated by source email to prevent duplicates on re-analysis.\n\nAll CRM data is accessible via API endpoints (`/api/crm/*`) with full tenant isolation and role-based access control.\n\n---\n\n## Demo Script (10 Minutes)\n\n### Setup (Before the Demo)\n\n1. Have a Microsoft-connected email account already synced with a few analyzed emails\n2. Open the dashboard showing the Daily Focus section with live tasks\n3. Have the Settings > Integrations tab ready to show\n4. Have a tool like Postman or a browser ready to show API responses for CRM data\n\n### Scene 1: The Problem (2 min)\n\n> \"Let me show you something. Your Territory Managers get 50-100 customer emails per day. Right now, all that intelligence â€” quote requests, competitor threats, project opportunities â€” it's locked in individual inboxes. Nobody else can see it. If a TM is out sick, on vacation, or leaves the company, that knowledge walks out the door.\"\n\n### Scene 2: One-Click Connection (1 min)\n\nNavigate to **Settings > Integrations > Email Inbox Connections**\n\n> \"Connecting is one click. The TM clicks 'Connect Microsoft' or 'Connect Google', signs into their email, and grants read-only access. That's it. We never see their password, and we can only read â€” never send â€” emails.\"\n\nShow the connected account with status indicator.\n\n### Scene 3: Intelligence in Action (4 min)\n\nShow CRM data via API calls or database view:\n\n**Contacts** (`GET /api/crm/contacts`)\n\n> \"Within minutes, the system has already found contacts across their inbox. It detected names, titles, and roles â€” Purchasing Manager, Project Manager, Decision Maker â€” all extracted from email signatures, CC lines, and message content. It knows when we last communicated with each contact.\"\n\n**Order Signals** (`GET /api/crm/order-signals`)\n\n> \"Here's where it gets powerful. The AI detected a quote request for PVF materials. It caught the urgency level and flagged whether a competitor price was mentioned. Your team now has the intelligence to respond with a competitive offer before the deal is lost.\"\n\n**Competitor Mentions** (`GET /api/crm/competitor-mentions`)\n\n> \"Every time a competitor is mentioned in an email, it's captured with threat level, product category, and pricing details. Your team can filter by threat level to see the most critical competitive situations that need an immediate response.\"\n\n**Projects** (`GET /api/crm/projects`)\n\n> \"Construction projects mentioned in emails are automatically tracked â€” project name, location, general contractor, estimated value, what stage it's in, and which of your product categories it needs. This is early pipeline intelligence that your competitors don't have.\"\n\n### Scene 4: The Bigger Picture (2 min)\n\nNavigate to **Dashboard**\n\n> \"The platform already has a Daily Focus system that surfaces priority tasks based on opportunity scores, enrollment status, and at-risk signals. The CRM intelligence from email analysis adds another layer â€” now you have a 360-degree view of each account: purchase history, wallet share gaps, AND what they're saying in their emails. Future releases will connect these email signals directly into the task engine for fully automated follow-up workflows.\"\n\n### Scene 5: The Close (1 min)\n\n> \"Think about what this replaces: a TM manually forwarding emails, typing notes into a CRM, hoping they remember to follow up. Now it's automatic. Every email, every contact, every project, every competitive signal â€” captured and queryable. Your team sells more because they spend time selling, not doing data entry.\"\n\n---\n\n## ROI Talking Points\n\n### Time Savings\n- **15-20 hours per TM per month** saved on manual CRM data entry and email triage\n- At $75/hr fully loaded cost, that's **$1,125 - $1,500/month per TM**\n- A team of 10 TMs saves **$135,000 - $180,000/year** in productivity\n\n### Revenue Recovery\n- Average distributor loses **12-18% of wallet share** to competitors they didn't know were quoting\n- Competitor detection gives visibility into threats that were previously invisible\n- Even recovering **1% of wallet share** on a $10M book of business = **$100,000 in incremental revenue**\n\n### Pipeline Intelligence\n- Construction projects detected from emails represent **early pipeline** that competitors haven't seen yet\n- Order signals catch **reorder patterns** before the customer goes to a competitor\n- Contact role mapping ensures you're **selling to decision makers**, not gatekeepers\n\n---\n\n## Competitive Differentiators\n\n| Feature | Our Platform | Traditional CRM | Competitor Tools |\n|---|---|---|---|\n| Email Intelligence | AI extracts 10 categories automatically | Manual logging by rep | Basic sentiment only |\n| CRM Auto-Population | Contacts, projects, signals auto-created | Rep types everything | Contact capture only |\n| Competitor Detection | Names, pricing, threat level, response flag | None | Keyword alerts only |\n| Project Pipeline | Full project details with GC, value, stage | Manual entry | Not available |\n| Product Category Mapping | Maps to your actual product catalog | Generic categories | Not available |\n| Integration Effort | One-click OAuth, read-only | Weeks of setup, API keys | Complex configuration |\n| Privacy | Read-only access, no email sending | Full access required | Varies |\n\n---\n\n## Objection Handling\n\n### \"Our TMs won't want to share their email.\"\n\n> \"We only request read-only access â€” we can never send emails or modify their inbox. TMs stay in full control and can disconnect anytime from Settings. The benefit is that the system does their CRM data entry for them. Most TMs love it because it saves them 15+ hours a month of admin work.\"\n\n### \"We already have a CRM.\"\n\n> \"This isn't replacing your CRM â€” it's feeding it. Right now, your CRM only knows what someone manually typed in. This captures the 90% of intelligence that never makes it into a CRM: the competitor quote mentioned in passing, the project that came up in a P.S., the new contact who was CC'd on a thread.\"\n\n### \"Is the AI accurate?\"\n\n> \"The system uses GPT-4o with a prompt specifically tuned for building materials distribution. It knows your product categories, your competitors, and your customer accounts. It only extracts what it can confidently identify â€” no fabrication. And every extraction is linked back to the source email, so your team can always verify.\"\n\n### \"What about email privacy / compliance?\"\n\n> \"Three safeguards: First, we use OAuth with read-only scopes â€” the same security standard used by Microsoft and Google's own apps. Second, all data is tenant-isolated â€” no customer can see another customer's data. Third, the TM controls the connection and can disconnect at any time.\"\n\n### \"How long does setup take?\"\n\n> \"Under 5 minutes per Territory Manager. They click 'Connect', sign into their email provider, and approve read-only access. The system starts syncing and analyzing immediately. No IT involvement needed from the TM side.\"\n\n---\n\n## Technical Requirements (For IT Stakeholders)\n\n### Microsoft / Outlook\n- Azure AD app registration (one-time admin setup)\n- Delegated permissions: `Mail.Read`, `User.Read`, `offline_access`\n- Works with Microsoft 365 Business and Enterprise plans\n\n### Google / Gmail\n- Google Cloud Console OAuth app (one-time admin setup)\n- Scope: `gmail.readonly`\n- Works with Google Workspace Business and Enterprise plans\n- Requires adding `GOOGLE_EMAIL_CLIENT_ID` and `GOOGLE_EMAIL_CLIENT_SECRET` to platform secrets\n\n### Security\n- OAuth 2.0 authorization code flow â€” no user passwords stored\n- Refresh tokens stored server-side, auto-refreshed on expiry\n- Read-only access â€” the system cannot send, delete, or modify emails\n- Full tenant isolation â€” multi-tenant architecture with tenant-scoped data access on all queries\n- Role-based access control: read routes require active subscription, write routes require write permission\n\n---\n\n## Proposed Pricing Tiers\n\n*Note: These are recommendations for future implementation. Email intelligence is not yet gated by subscription tier.*\n\nThis feature is a natural fit for **Growth and Scale tiers**:\n\n- **Starter:** No email intelligence (incentivizes upgrade)\n- **Growth:** 1 email connection per user, 500 emails/month analyzed\n- **Scale:** Unlimited connections, unlimited analysis, priority processing\n\nThe email intelligence capability is a strong **upsell driver** â€” once prospects see competitor detection and project pipeline in action, the value of upgrading from Starter becomes immediately obvious.\n\n---\n\n## Planned Enhancements\n\nThese capabilities are on the near-term roadmap:\n\n- **CRM UI Pages:** Dedicated frontend views for browsing contacts, projects, order signals, and competitor mentions (currently API-only)\n- **Email-to-Task Pipeline:** Automatically generate Daily Focus tasks from high-urgency order signals and competitor threats\n- **Account Auto-Matching:** Intelligent matching of email senders to customer accounts using domain patterns and historical correspondence\n- **Email Interaction Timeline:** Visual timeline on account detail pages showing all email touchpoints with AI-extracted summaries\n\n---\n\n*Last updated: February 2026*\n","path":null,"size_bytes":12803,"size_tokens":null},"server/services/email-crm-linker.ts":{"content":"import { db } from \"../db\";\nimport {\n  contacts, projects, emailInteractions, orderSignals, competitorMentions,\n  accounts, type SyncedEmail,\n} from \"@shared/schema\";\nimport { eq, and, ilike } from \"drizzle-orm\";\nimport type { EnhancedEmailAnalysis } from \"./email-ai-analysis\";\n\nexport async function linkEmailToCrm(\n  email: SyncedEmail,\n  analysis: EnhancedEmailAnalysis,\n  tenantId: number,\n): Promise<{ contactsCreated: number; projectsCreated: number; orderSignalsCreated: number; competitorMentionsCreated: number }> {\n  const stats = { contactsCreated: 0, projectsCreated: 0, orderSignalsCreated: 0, competitorMentionsCreated: 0 };\n\n  const linkedAccountId = email.linkedAccountId ?? null;\n\n  const contactIds = await processContacts(email, analysis, tenantId, linkedAccountId);\n  stats.contactsCreated = contactIds.length;\n\n  const projectIds = await processProjects(email, analysis, tenantId, linkedAccountId);\n  stats.projectsCreated = projectIds.length;\n\n  stats.orderSignalsCreated = await processOrderSignals(email, analysis, tenantId, linkedAccountId, projectIds[0] ?? null);\n  stats.competitorMentionsCreated = await processCompetitorMentions(email, analysis, tenantId, linkedAccountId, projectIds[0] ?? null);\n\n  await createEmailInteractions(email, contactIds, tenantId);\n\n  return stats;\n}\n\nasync function processContacts(\n  email: SyncedEmail,\n  analysis: EnhancedEmailAnalysis,\n  tenantId: number,\n  linkedAccountId: number | null,\n): Promise<number[]> {\n  const createdIds: number[] = [];\n\n  const fromContact = findContactByEmail(analysis.contacts_detected, email.fromAddress ?? \"\");\n  const allContacts = [...analysis.contacts_detected];\n\n  if (!fromContact && email.fromName && email.fromAddress) {\n    const nameParts = (email.fromName || \"\").trim().split(/\\s+/);\n    allContacts.push({\n      first_name: nameParts[0] || email.fromName || \"\",\n      last_name: nameParts.slice(1).join(\" \") || \"\",\n      email: email.fromAddress || \"\",\n      title: \"\",\n      role: \"unknown\" as const,\n      department: \"\",\n    });\n  }\n\n  for (const detected of allContacts) {\n    if (!detected.first_name) continue;\n\n    const emailAddr = detected.email || \"\";\n\n    const existingByEmail = emailAddr\n      ? await db.select({ id: contacts.id })\n          .from(contacts)\n          .where(and(\n            eq(contacts.tenantId, tenantId),\n            ilike(contacts.email, emailAddr),\n          ))\n          .limit(1)\n      : [];\n\n    if (existingByEmail.length > 0) {\n      const existingId = existingByEmail[0].id;\n      await db.update(contacts)\n        .set({\n          lastContactedAt: email.receivedAt ?? new Date(),\n          ...(detected.title && { title: detected.title }),\n          ...(detected.role !== \"unknown\" && { role: detected.role }),\n          ...(detected.department && { department: detected.department }),\n          ...(linkedAccountId && { accountId: linkedAccountId }),\n          updatedAt: new Date(),\n        })\n        .where(eq(contacts.id, existingId));\n      createdIds.push(existingId);\n      continue;\n    }\n\n    const existingByName = await db.select({ id: contacts.id })\n      .from(contacts)\n      .where(and(\n        eq(contacts.tenantId, tenantId),\n        ilike(contacts.firstName, detected.first_name),\n        ...(detected.last_name ? [ilike(contacts.lastName, detected.last_name)] : []),\n        ...(linkedAccountId ? [eq(contacts.accountId, linkedAccountId)] : []),\n      ))\n      .limit(1);\n\n    if (existingByName.length > 0) {\n      const existingId = existingByName[0].id;\n      await db.update(contacts)\n        .set({\n          lastContactedAt: email.receivedAt ?? new Date(),\n          ...(emailAddr && { email: emailAddr }),\n          ...(detected.title && { title: detected.title }),\n          ...(detected.role !== \"unknown\" && { role: detected.role }),\n          updatedAt: new Date(),\n        })\n        .where(eq(contacts.id, existingId));\n      createdIds.push(existingId);\n      continue;\n    }\n\n    const [newContact] = await db.insert(contacts)\n      .values({\n        tenantId,\n        accountId: linkedAccountId,\n        firstName: detected.first_name,\n        lastName: detected.last_name || null,\n        email: emailAddr || null,\n        title: detected.title || null,\n        role: detected.role || \"unknown\",\n        department: detected.department || null,\n        source: \"email_sync\",\n        lastContactedAt: email.receivedAt ?? new Date(),\n      })\n      .returning({ id: contacts.id });\n\n    if (newContact) createdIds.push(newContact.id);\n  }\n\n  return createdIds;\n}\n\nasync function processProjects(\n  email: SyncedEmail,\n  analysis: EnhancedEmailAnalysis,\n  tenantId: number,\n  linkedAccountId: number | null,\n): Promise<number[]> {\n  const createdIds: number[] = [];\n\n  for (const detected of analysis.projects_detected) {\n    if (!detected.name) continue;\n\n    const existing = await db.select({ id: projects.id })\n      .from(projects)\n      .where(and(\n        eq(projects.tenantId, tenantId),\n        ilike(projects.name, detected.name),\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      await db.update(projects)\n        .set({\n          ...(detected.location && { location: detected.location }),\n          ...(detected.project_type !== \"unknown\" && { projectType: detected.project_type }),\n          ...(detected.stage !== \"unknown\" && { stage: detected.stage }),\n          ...(detected.general_contractor && { generalContractor: detected.general_contractor }),\n          ...(detected.unit_count && { unitCount: detected.unit_count }),\n          ...(detected.square_footage && { squareFootage: detected.square_footage }),\n          ...(detected.product_categories.length > 0 && { productCategories: detected.product_categories }),\n          updatedAt: new Date(),\n        })\n        .where(eq(projects.id, existing[0].id));\n      createdIds.push(existing[0].id);\n      continue;\n    }\n\n    const [newProject] = await db.insert(projects)\n      .values({\n        tenantId,\n        accountId: linkedAccountId,\n        name: detected.name,\n        location: detected.location || null,\n        projectType: detected.project_type !== \"unknown\" ? detected.project_type : null,\n        estimatedValue: detected.estimated_value || null,\n        stage: detected.stage !== \"unknown\" ? detected.stage : \"identified\",\n        startDate: parseDate(detected.start_date),\n        bidDeadline: parseDate(detected.bid_deadline),\n        generalContractor: detected.general_contractor || null,\n        unitCount: detected.unit_count ?? null,\n        squareFootage: detected.square_footage ?? null,\n        productCategories: detected.product_categories.length > 0 ? detected.product_categories : null,\n        source: \"email_sync\",\n        sourceEmailId: email.id,\n      })\n      .returning({ id: projects.id });\n\n    if (newProject) createdIds.push(newProject.id);\n  }\n\n  return createdIds;\n}\n\nasync function processOrderSignals(\n  email: SyncedEmail,\n  analysis: EnhancedEmailAnalysis,\n  tenantId: number,\n  linkedAccountId: number | null,\n  projectId: number | null,\n): Promise<number> {\n  let count = 0;\n\n  const existingForEmail = await db.select({ id: orderSignals.id, signalType: orderSignals.signalType, productCategory: orderSignals.productCategory })\n    .from(orderSignals)\n    .where(and(\n      eq(orderSignals.tenantId, tenantId),\n      eq(orderSignals.sourceEmailId, email.id),\n    ));\n\n  for (const signal of analysis.order_signals) {\n    const alreadyExists = existingForEmail.some(\n      e => e.signalType === signal.signal_type && e.productCategory === (signal.product_category || null)\n    );\n    if (alreadyExists) continue;\n\n    await db.insert(orderSignals).values({\n      tenantId,\n      accountId: linkedAccountId,\n      projectId,\n      sourceEmailId: email.id,\n      signalType: signal.signal_type,\n      productCategory: signal.product_category || null,\n      productDetails: signal.product_details || null,\n      estimatedQuantity: signal.estimated_quantity || null,\n      estimatedValue: signal.estimated_value || null,\n      requestedDeliveryDate: parseDate(signal.delivery_date),\n      urgency: signal.urgency,\n      pricingMentioned: signal.pricing_mentioned,\n      competitorPriceMentioned: signal.competitor_price_mentioned,\n    });\n    count++;\n  }\n\n  return count;\n}\n\nasync function processCompetitorMentions(\n  email: SyncedEmail,\n  analysis: EnhancedEmailAnalysis,\n  tenantId: number,\n  linkedAccountId: number | null,\n  projectId: number | null,\n): Promise<number> {\n  let count = 0;\n\n  const existingForEmail = await db.select({ id: competitorMentions.id, competitorName: competitorMentions.competitorName, productCategory: competitorMentions.productCategory })\n    .from(competitorMentions)\n    .where(and(\n      eq(competitorMentions.tenantId, tenantId),\n      eq(competitorMentions.sourceEmailId, email.id),\n    ));\n\n  for (const mention of analysis.competitor_mentions) {\n    if (!mention.competitor_name) continue;\n\n    const alreadyExists = existingForEmail.some(\n      e => e.competitorName === mention.competitor_name && e.productCategory === (mention.product_category || null)\n    );\n    if (alreadyExists) continue;\n\n    await db.insert(competitorMentions).values({\n      tenantId,\n      accountId: linkedAccountId,\n      projectId,\n      sourceEmailId: email.id,\n      competitorName: mention.competitor_name,\n      mentionType: mention.mention_type,\n      productCategory: mention.product_category || null,\n      competitorPrice: mention.competitor_price || null,\n      ourPrice: mention.our_price || null,\n      details: mention.details || null,\n      threatLevel: mention.threat_level,\n      responseNeeded: mention.response_needed,\n    });\n    count++;\n  }\n\n  return count;\n}\n\nasync function createEmailInteractions(\n  email: SyncedEmail,\n  contactIds: number[],\n  tenantId: number,\n): Promise<void> {\n  for (const contactId of contactIds) {\n    const existing = await db.select({ id: emailInteractions.id })\n      .from(emailInteractions)\n      .where(and(\n        eq(emailInteractions.emailId, email.id),\n        eq(emailInteractions.contactId, contactId),\n      ))\n      .limit(1);\n\n    if (existing.length > 0) continue;\n\n    const contact = await db.select({ email: contacts.email })\n      .from(contacts)\n      .where(eq(contacts.id, contactId))\n      .limit(1);\n\n    const contactEmail = contact[0]?.email?.toLowerCase() ?? \"\";\n    const fromEmail = (email.fromAddress ?? \"\").toLowerCase();\n    const role = contactEmail === fromEmail ? \"sender\" : \"participant\";\n\n    await db.insert(emailInteractions).values({\n      tenantId,\n      emailId: email.id,\n      contactId,\n      role,\n    });\n  }\n}\n\nfunction findContactByEmail(\n  detected: EnhancedEmailAnalysis[\"contacts_detected\"],\n  targetEmail: string,\n) {\n  if (!targetEmail) return undefined;\n  const lower = targetEmail.toLowerCase();\n  return detected.find(c => (c.email || \"\").toLowerCase() === lower);\n}\n\nfunction parseDate(dateStr: string | undefined): Date | null {\n  if (!dateStr) return null;\n  const d = new Date(dateStr);\n  return isNaN(d.getTime()) ? null : d;\n}\n","path":null,"size_bytes":11074,"size_tokens":null},"PHASE-B.md":{"content":"# Phase B â€” CRM Evolution Roadmap\n\n## Overview\n\nPhase B transforms the Wallet Share Expander from a sales intelligence tool into a lightweight CRM system with integrated email intelligence. The goal is to create a unified platform where Territory Managers can manage contacts, track all interactions, and receive AI-driven insights from real customer communications â€” all without leaving the application.\n\n### Current State (Phase A â€” Complete)\n\nThe platform already provides:\n\n- Account database with segmentation, regions, and territory assignments\n- Territory Manager administration with territory assignments\n- Task management with statuses, due dates, and task types (call, email, follow-up)\n- AI-generated action items, call scripts, and email templates\n- Account scoring, gap analysis, and category penetration metrics\n- Program enrollment lifecycle (enroll â†’ track â†’ graduate)\n- Revenue tracking with tiered rev-share calculations\n- Dashboard with KPIs, daily briefing, and top opportunities\n- Ask Anything AI bar with account-scoped intelligence\n- Account Dossier panel with detailed account analysis\n\n### What's Missing for CRM\n\n| Capability | Status | Phase B Priority |\n|------------|--------|-----------------|\n| Contact Management (people at accounts) | Not built | 1 â€” Foundation |\n| Activity Timeline (unified interaction feed) | Not built | 2 â€” Core |\n| Notes & Attachments | Not built | 3 â€” Quick Win |\n| Email Integration (OAuth + AI analysis) | Not built | 4 â€” Crown Jewel |\n| Advanced Search & Filtering | Partial | 5 â€” Enhancement |\n\n**Estimated CRM readiness today: ~60-65%**\n\n---\n\n## Feature 1: Contact Management\n\n### Purpose\n\nCRMs revolve around people, not just companies. Adding contacts to accounts allows reps to track who they're talking to, their roles, and how to reach them. This is also the foundation for email integration â€” matching incoming emails to known contacts.\n\n### Data Model\n\n- **Contact** belongs to an Account\n- Fields: name, title/role, email, phone, isPrimary, notes, createdAt, updatedAt\n- An account can have multiple contacts\n- One contact can be marked as primary\n\n### UI\n\n- Contacts tab within the Account Dossier panel\n- Add/edit/delete contacts inline\n- Primary contact badge displayed on account cards\n- Contact quick-view on hover in task lists\n\n### Integration Points\n\n- Email integration matches sender addresses to contacts\n- Playbook generation references contact names and roles\n- Task assignment can target specific contacts\n- Ask Anything can answer \"Who is the main contact at [account]?\"\n\n---\n\n## Feature 2: Activity Timeline\n\n### Purpose\n\nA single chronological feed per account showing everything that's happened â€” tasks completed, emails exchanged, notes added, enrollment changes, AI briefing mentions. This is the \"single source of truth\" for account history.\n\n### Data Model\n\n- **ActivityEntry** linked to an Account (and optionally a Contact)\n- Fields: type (task, email, note, enrollment, briefing, call), title, body, metadata (JSON), source (manual, ai, email-sync), createdAt, createdBy\n- Immutable log â€” entries are appended, never edited or deleted\n\n### UI\n\n- Timeline view in the Account Dossier panel (new tab or integrated into existing view)\n- Filterable by activity type\n- Chronological with date grouping (Today, This Week, Earlier)\n- Auto-populated from existing data (task status changes, enrollment events)\n- Manual entries via \"Log Activity\" button\n\n### Integration Points\n\n- Email integration auto-creates timeline entries for analyzed emails\n- Task completions auto-log to the timeline\n- Daily Briefing references recent timeline activity\n- Playbook generation considers recent interactions when crafting scripts\n\n---\n\n## Feature 3: Notes & Attachments\n\n### Purpose\n\nReps need a simple, fast way to jot down information about accounts â€” things that don't fit into structured fields. Meeting notes, observations, pricing conversations, competitive intel heard in passing.\n\n### Data Model\n\n- **Note** belongs to an Account (and optionally a Contact)\n- Fields: content (rich text), tags, createdAt, createdBy\n- Future: file attachments (quotes, contracts, photos)\n\n### UI\n\n- Notes section in Account Dossier panel\n- Quick-add note from the account card or timeline\n- Searchable across all accounts\n- Pin important notes to the top\n\n### Integration Points\n\n- Ask Anything can search and reference notes\n- AI considers recent notes when generating playbooks\n- Notes appear in the Activity Timeline\n\n---\n\n## Feature 4: Email Integration (OAuth + AI Analysis)\n\n### Purpose\n\nAutomatically connect to a rep's email account via OAuth, sync emails, run full AI analysis on every message to extract intelligence, and feed insights back into account profiles, briefings, and playbooks. Every email your team sends makes the AI smarter.\n\n### Architecture\n\n#### OAuth Email Connection\n\n- Support Google Workspace (Gmail API) and Microsoft 365 (Outlook/Graph API) via OAuth 2.0\n- Per-user connection â€” each Territory Manager authorizes their own email account\n- Token refresh handled automatically; revocation available in Settings\n- Connection status visible in Settings > Integrations tab\n\n#### AI Email Analysis Pipeline\n\nEvery synced email is fully analyzed by the AI. The pipeline runs on all incoming messages:\n\n1. **Full Content Analysis** â€” The AI reads the complete email (sender, recipients, subject, body) and extracts:\n   - **Sentiment** â€” Positive, negative, neutral, or mixed\n   - **Competitor Mentions** â€” Names of competing distributors or brands referenced\n   - **Buying Signals** â€” Interest in new products, requests for quotes, volume inquiries\n   - **Risk Indicators** â€” Complaints, delayed responses, mentions of switching suppliers\n   - **Key Topics** â€” Categories or products discussed\n2. **Account & Contact Linking** â€” Cross-reference sender/recipient domains and addresses against the account database and known contacts. Link the analysis to the matching account and contact records.\n3. **Account Profile Update** â€” Extracted intelligence is stored and linked to the account, updating risk scores and opportunity signals\n4. **Audit Log** â€” Every email processed gets a log entry for full transparency and compliance\n\n#### Audit & Transparency Report\n\nA dedicated report (accessible from Settings or a new Reports section) showing:\n\n- Total emails synced per period\n- How many were linked to known accounts vs. unlinked\n- Breakdown of AI findings (sentiment distribution, competitor mentions, buying signals detected)\n- Drill-down to individual email analysis records\n- Exportable for compliance review\n\n### Data Model\n\n- **EmailConnection** â€” userId, provider (google/microsoft), accessToken (encrypted), refreshToken (encrypted), status, lastSyncAt, syncCursor\n- **EmailMessage** â€” connectionId, accountId (nullable), contactId (nullable), messageId (provider's ID), from, to, subject, receivedAt, syncedAt\n- **EmailAnalysis** â€” emailMessageId, accountId, sentiment, competitorMentions (JSON array), buyingSignals (JSON array), riskIndicators (JSON array), keyTopics (JSON array), summary, analyzedAt\n- **EmailAuditLog** â€” emailMessageId, action (synced, analyzed, linked), accountId (nullable), details (JSON â€” AI findings summary), timestamp\n\n### UI\n\n- **Settings > Integrations:** \"Connect Email\" button with Google/Microsoft OAuth flow, connection status, disconnect option\n- **Account Dossier > Emails tab:** List of synced emails for the account with AI analysis badges (sentiment, signals)\n- **Email detail view:** Full AI analysis breakdown â€” sentiment, competitor mentions, buying signals, risk indicators\n- **Audit Report page:** Filterable table of all email processing activity\n- **Dashboard integration:** Daily Briefing references recent email intelligence (\"Palmetto mentioned Ferguson in yesterday's email â€” competitor risk detected\")\n\n### Sync Behavior\n\n- Background sync runs periodically (configurable: every 15/30/60 minutes)\n- Only syncs emails from the last N days on initial connection (configurable, default 30)\n- Incremental sync after initial load\n- Rate-limited to respect provider API quotas\n- Errors logged and surfaced in Settings\n\n### Security & Privacy\n\n- OAuth tokens stored encrypted in the database\n- Full email content is processed by AI but only extracted insights are stored long-term\n- Raw email bodies are not persisted after analysis (only subject, from/to, date, and AI-extracted metadata)\n- Users can disconnect at any time, which revokes the OAuth token and stops syncing\n- Admin audit report provides full visibility into what was processed\n- Tenant isolation ensures email data never crosses tenant boundaries\n\n---\n\n## Feature 5: Advanced Search & Filtering\n\n### Purpose\n\nAs the system accumulates more data (contacts, notes, emails, activity), users need robust search to find what they're looking for quickly.\n\n### Capabilities\n\n- Full-text search across accounts, contacts, notes, and email subjects\n- Filter accounts by segment, region, territory manager, enrollment status, score range\n- Filter activities by type, date range, account\n- Saved filter presets\n- Search results highlight matching terms\n\n---\n\n## Implementation Sequence\n\n```\nPhase B-1: Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Foundation for email matching\n     â”‚\nPhase B-2: Activity Timeline â”€â”€â”€â”€â–º Unified interaction history\n     â”‚\nPhase B-3: Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Quick win, feeds into timeline\n     â”‚\nPhase B-4: Email Integration â”€â”€â”€â”€â–º OAuth connect + AI analysis pipeline\n     â”‚\nPhase B-5: Advanced Search â”€â”€â”€â”€â”€â”€â–º Ties everything together\n```\n\nEach phase builds on the previous one. Contacts must come first since email integration depends on matching senders to known contacts. The Activity Timeline provides the unified view where email insights, notes, and task history all converge.\n\n---\n\n## Success Metrics\n\n| Metric | Target |\n|--------|--------|\n| Accounts with 1+ contacts | >80% within 30 days of launch |\n| Emails synced per rep per week | >50 |\n| Emails matched to accounts | >60% of synced emails |\n| AI insights surfaced in briefings | >3 per daily briefing |\n| Rep time saved (self-reported) | >2 hours/week |\n| Account risk signals detected via email | >5 per month |\n\n---\n\n## Dependencies\n\n- **OpenAI API** â€” Already integrated for AI analysis (GPT-5.1 via Replit AI Integrations)\n- **Google OAuth** â€” Required for Gmail integration (Google Cloud Console setup, OAuth consent screen)\n- **Microsoft OAuth** â€” Required for Outlook integration (Azure AD app registration)\n- **Background job runner** â€” Needed for periodic email sync (cron or queue-based)\n\n---\n\n*Document created: February 22, 2026*\n*Status: Planning â€” Not yet in development*\n","path":null,"size_bytes":10844,"size_tokens":null},"client/src/pages/crm-projects.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  Search,\n  Building2,\n  MapPin,\n  DollarSign,\n  Calendar,\n  HardHat,\n  Layers,\n  ArrowRight,\n  Loader2,\n  FolderKanban,\n  Clock,\n  Ruler,\n  Users,\n  Swords,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport type { Project } from \"@shared/schema\";\n\ninterface AccountBasic {\n  id: number;\n  name: string;\n}\n\nconst STAGE_CONFIG: Record<string, { label: string; color: string }> = {\n  identified: { label: \"Identified\", color: \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\" },\n  bidding: { label: \"Bidding\", color: \"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300\" },\n  awarded: { label: \"Awarded\", color: \"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300\" },\n  in_progress: { label: \"In Progress\", color: \"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300\" },\n  completed: { label: \"Completed\", color: \"bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300\" },\n  lost: { label: \"Lost\", color: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\" },\n};\n\nconst TYPE_CONFIG: Record<string, string> = {\n  new_construction: \"New Construction\",\n  renovation: \"Renovation\",\n  retrofit: \"Retrofit\",\n  maintenance: \"Maintenance\",\n  tenant_improvement: \"Tenant Improvement\",\n  unknown: \"Unknown\",\n};\n\nfunction formatCurrency(value: string | number | null): string {\n  if (!value) return \"â€”\";\n  const num = typeof value === \"string\" ? parseFloat(value) : value;\n  if (isNaN(num)) return \"â€”\";\n  if (num >= 1_000_000) return `$${(num / 1_000_000).toFixed(1)}M`;\n  if (num >= 1_000) return `$${(num / 1_000).toFixed(0)}K`;\n  return `$${num.toFixed(0)}`;\n}\n\nfunction formatDate(d: string | Date | null): string {\n  if (!d) return \"â€”\";\n  return new Date(d).toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" });\n}\n\nexport default function CRMProjects() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [stageFilter, setStageFilter] = useState(\"all\");\n  const [typeFilter, setTypeFilter] = useState(\"all\");\n  const [selectedProject, setSelectedProject] = useState<Project | null>(null);\n\n  const { data: projects, isLoading } = useQuery<Project[]>({\n    queryKey: [\"/api/crm/projects\"],\n  });\n\n  const { data: accountsList } = useQuery<AccountBasic[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  const accountMap = useMemo(() => {\n    const map: Record<number, string> = {};\n    if (accountsList) {\n      accountsList.forEach((a: any) => { map[a.id] = a.name; });\n    }\n    return map;\n  }, [accountsList]);\n\n  const filteredProjects = useMemo(() => {\n    if (!projects) return [];\n    return projects.filter((p) => {\n      const matchesSearch =\n        p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        (p.location || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n        (p.generalContractor || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n        (accountMap[p.accountId || 0] || \"\").toLowerCase().includes(searchQuery.toLowerCase());\n      const matchesStage = stageFilter === \"all\" || p.stage === stageFilter;\n      const matchesType = typeFilter === \"all\" || p.projectType === typeFilter;\n      return matchesSearch && matchesStage && matchesType;\n    });\n  }, [projects, searchQuery, stageFilter, typeFilter, accountMap]);\n\n  const stats = useMemo(() => {\n    if (!projects) return { total: 0, totalValue: 0, active: 0, bidding: 0 };\n    const activeStages = [\"identified\", \"bidding\", \"awarded\", \"in_progress\"];\n    return {\n      total: projects.length,\n      totalValue: projects.reduce((sum, p) => sum + (p.estimatedValue ? parseFloat(p.estimatedValue as string) : 0), 0),\n      active: projects.filter(p => activeStages.includes(p.stage || \"\")).length,\n      bidding: projects.filter(p => p.stage === \"bidding\").length,\n    };\n  }, [projects]);\n\n  const stages = [\"all\", \"identified\", \"bidding\", \"awarded\", \"in_progress\", \"completed\", \"lost\"];\n  const types = [\"all\", \"new_construction\", \"renovation\", \"retrofit\", \"maintenance\", \"tenant_improvement\"];\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-crm-projects\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Project Pipeline</h1>\n          <p className=\"text-muted-foreground\">\n            Construction projects detected from email intelligence and customer correspondence\n          </p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card data-testid=\"stat-total-projects\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-950\">\n                <FolderKanban className=\"h-5 w-5 text-blue-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{stats.total}</p>\n                <p className=\"text-xs text-muted-foreground\">Total Projects</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card data-testid=\"stat-pipeline-value\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-green-100 dark:bg-green-950\">\n                <DollarSign className=\"h-5 w-5 text-green-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{formatCurrency(stats.totalValue)}</p>\n                <p className=\"text-xs text-muted-foreground\">Pipeline Value</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card data-testid=\"stat-active-projects\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-purple-100 dark:bg-purple-950\">\n                <HardHat className=\"h-5 w-5 text-purple-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{stats.active}</p>\n                <p className=\"text-xs text-muted-foreground\">Active Projects</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card data-testid=\"stat-bidding-projects\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 dark:bg-amber-950\">\n                <Clock className=\"h-5 w-5 text-amber-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{stats.bidding}</p>\n                <p className=\"text-xs text-muted-foreground\">In Bidding</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n            <CardTitle className=\"text-lg\">All Projects</CardTitle>\n            <div className=\"flex flex-wrap items-center gap-2\">\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search name, location, GC, account...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-projects\"\n                />\n              </div>\n              <Select value={stageFilter} onValueChange={setStageFilter}>\n                <SelectTrigger className=\"w-[150px]\" data-testid=\"select-stage-filter\">\n                  <SelectValue placeholder=\"All Stages\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {stages.map(s => (\n                    <SelectItem key={s} value={s}>{s === \"all\" ? \"All Stages\" : STAGE_CONFIG[s]?.label || s}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Select value={typeFilter} onValueChange={setTypeFilter}>\n                <SelectTrigger className=\"w-[170px]\" data-testid=\"select-type-filter\">\n                  <SelectValue placeholder=\"All Types\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {types.map(t => (\n                    <SelectItem key={t} value={t}>{t === \"all\" ? \"All Types\" : TYPE_CONFIG[t] || t}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {filteredProjects.length === 0 ? (\n            <EmptyState\n              icon={FolderKanban}\n              title=\"No projects found\"\n              description={projects?.length ? \"Try adjusting your filters\" : \"Connect your email inbox in Settings to auto-detect construction projects from customer correspondence\"}\n            />\n          ) : (\n            <div className=\"space-y-3\">\n              {filteredProjects.map((project) => {\n                const accountName = accountMap[project.accountId || 0];\n                const categories = (project.productCategories as string[] | null) || [];\n                const competitors = (project.competitorsInvolved as string[] | null) || [];\n                const stageConfig = STAGE_CONFIG[project.stage || \"identified\"] || STAGE_CONFIG.identified;\n                const hasBidDeadline = project.bidDeadline && new Date(project.bidDeadline) > new Date();\n                const bidDeadlineSoon = project.bidDeadline && new Date(project.bidDeadline).getTime() - Date.now() < 7 * 24 * 60 * 60 * 1000 && new Date(project.bidDeadline) > new Date();\n\n                return (\n                  <div\n                    key={project.id}\n                    className={`p-4 rounded-lg border cursor-pointer transition-colors hover:bg-accent/50 ${bidDeadlineSoon ? \"border-amber-300 dark:border-amber-700\" : \"\"}`}\n                    onClick={() => setSelectedProject(project)}\n                    data-testid={`card-project-${project.id}`}\n                  >\n                    <div className=\"flex items-start justify-between gap-4\">\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2 flex-wrap\">\n                          <span className=\"font-medium\" data-testid={`text-project-name-${project.id}`}>{project.name}</span>\n                          <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${stageConfig.color}`} data-testid={`badge-stage-${project.stage || \"identified\"}-${project.id}`}>\n                            {stageConfig.label}\n                          </span>\n                          {project.projectType && project.projectType !== \"unknown\" && (\n                            <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-type-${project.projectType}-${project.id}`}>{TYPE_CONFIG[project.projectType] || project.projectType}</Badge>\n                          )}\n                          {bidDeadlineSoon && (\n                            <Badge variant=\"destructive\" className=\"text-[10px] px-1.5 py-0\" data-testid={`badge-bid-deadline-soon-${project.id}`}>\n                              Bid deadline soon\n                            </Badge>\n                          )}\n                        </div>\n                        <div className=\"flex items-center gap-4 text-sm text-muted-foreground mt-1.5 flex-wrap\">\n                          {project.location && (\n                            <span className=\"inline-flex items-center gap-1\" data-testid={`text-location-${project.id}`}>\n                              <MapPin className=\"h-3 w-3\" />\n                              {project.location}\n                            </span>\n                          )}\n                          {project.generalContractor && (\n                            <span className=\"inline-flex items-center gap-1\" data-testid={`text-general-contractor-${project.id}`}>\n                              <HardHat className=\"h-3 w-3\" />\n                              {project.generalContractor}\n                            </span>\n                          )}\n                          {accountName && (\n                            <Link\n                              href={`/accounts?account=${project.accountId}`}\n                              onClick={(e) => e.stopPropagation()}\n                              className=\"text-primary hover:underline inline-flex items-center gap-1\"\n                              data-testid={`link-account-${project.accountId}`}\n                            >\n                              <Building2 className=\"h-3 w-3\" />\n                              {accountName}\n                            </Link>\n                          )}\n                        </div>\n                        {categories.length > 0 && (\n                          <div className=\"flex items-center gap-1.5 mt-2 flex-wrap\" data-testid={`categories-${project.id}`}>\n                            <Layers className=\"h-3 w-3 text-muted-foreground shrink-0\" />\n                            {categories.slice(0, 4).map((cat, i) => (\n                              <Badge key={i} variant=\"secondary\" className=\"text-[10px] px-1.5 py-0\" data-testid={`badge-category-${cat}-${project.id}`}>{cat}</Badge>\n                            ))}\n                            {categories.length > 4 && (\n                              <span className=\"text-xs text-muted-foreground\" data-testid={`text-more-categories-${project.id}`}>+{categories.length - 4} more</span>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"text-right shrink-0\">\n                        {project.estimatedValue && (\n                          <p className=\"font-semibold text-lg\" data-testid={`text-estimated-value-${project.id}`}>{formatCurrency(project.estimatedValue)}</p>\n                        )}\n                        {hasBidDeadline && (\n                          <p className=\"text-xs text-muted-foreground mt-1\" data-testid={`text-bid-deadline-${project.id}`}>\n                            Bid by {formatDate(project.bidDeadline)}\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!selectedProject} onOpenChange={(open) => !open && setSelectedProject(null)}>\n        <DialogContent className=\"max-w-lg\" data-testid={`dialog-project-details-${selectedProject?.id || \"\"}`}>\n          <DialogHeader>\n            <DialogTitle data-testid={`dialog-title-${selectedProject?.id || \"\"}`}>{selectedProject?.name}</DialogTitle>\n            <DialogDescription>Project details and intelligence</DialogDescription>\n          </DialogHeader>\n          {selectedProject && (\n            <div className=\"space-y-4\">\n              <div className=\"flex flex-wrap gap-2\">\n                <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${(STAGE_CONFIG[selectedProject.stage || \"identified\"] || STAGE_CONFIG.identified).color}`} data-testid={`badge-stage-detail-${selectedProject.stage || \"identified\"}`}>\n                  {(STAGE_CONFIG[selectedProject.stage || \"identified\"] || STAGE_CONFIG.identified).label}\n                </span>\n                {selectedProject.projectType && selectedProject.projectType !== \"unknown\" && (\n                  <Badge variant=\"outline\" data-testid={`badge-type-detail-${selectedProject.projectType}`}>{TYPE_CONFIG[selectedProject.projectType] || selectedProject.projectType}</Badge>\n                )}\n                <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-source-${selectedProject.source || \"manual\"}`}>\n                  Source: {selectedProject.source === \"email_sync\" ? \"Email Intelligence\" : \"Manual\"}\n                </Badge>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                {selectedProject.estimatedValue && (\n                  <div data-testid=\"field-estimated-value\">\n                    <p className=\"text-muted-foreground text-xs\">Estimated Value</p>\n                    <p className=\"font-semibold text-lg\" data-testid={`text-estimated-value-detail-${selectedProject.id}`}>{formatCurrency(selectedProject.estimatedValue)}</p>\n                  </div>\n                )}\n                {selectedProject.location && (\n                  <div data-testid=\"field-location\">\n                    <p className=\"text-muted-foreground text-xs\">Location</p>\n                    <p className=\"font-medium flex items-center gap-1\" data-testid={`text-location-detail-${selectedProject.id}`}><MapPin className=\"h-3 w-3\" />{selectedProject.location}</p>\n                  </div>\n                )}\n                {selectedProject.generalContractor && (\n                  <div data-testid=\"field-general-contractor\">\n                    <p className=\"text-muted-foreground text-xs\">General Contractor</p>\n                    <p className=\"font-medium\" data-testid={`text-gc-detail-${selectedProject.id}`}>{selectedProject.generalContractor}</p>\n                  </div>\n                )}\n                {selectedProject.accountId && accountMap[selectedProject.accountId] && (\n                  <div data-testid=\"field-account\">\n                    <p className=\"text-muted-foreground text-xs\">Account</p>\n                    <Link href={`/accounts?account=${selectedProject.accountId}`} className=\"font-medium text-primary hover:underline inline-flex items-center gap-1\" data-testid={`link-account-detail-${selectedProject.accountId}`}>\n                      <Building2 className=\"h-3 w-3\" />\n                      {accountMap[selectedProject.accountId]}\n                    </Link>\n                  </div>\n                )}\n                {selectedProject.bidDeadline && (\n                  <div data-testid=\"field-bid-deadline\">\n                    <p className=\"text-muted-foreground text-xs\">Bid Deadline</p>\n                    <p className=\"font-medium flex items-center gap-1\" data-testid={`text-bid-deadline-detail-${selectedProject.id}`}><Calendar className=\"h-3 w-3\" />{formatDate(selectedProject.bidDeadline)}</p>\n                  </div>\n                )}\n                {selectedProject.startDate && (\n                  <div data-testid=\"field-start-date\">\n                    <p className=\"text-muted-foreground text-xs\">Start Date</p>\n                    <p className=\"font-medium\" data-testid={`text-start-date-${selectedProject.id}`}>{formatDate(selectedProject.startDate)}</p>\n                  </div>\n                )}\n                {selectedProject.unitCount && (\n                  <div data-testid=\"field-units\">\n                    <p className=\"text-muted-foreground text-xs\">Units</p>\n                    <p className=\"font-medium\" data-testid={`text-units-${selectedProject.id}`}>{selectedProject.unitCount}</p>\n                  </div>\n                )}\n                {selectedProject.squareFootage && (\n                  <div data-testid=\"field-square-footage\">\n                    <p className=\"text-muted-foreground text-xs\">Square Footage</p>\n                    <p className=\"font-medium\" data-testid={`text-square-footage-${selectedProject.id}`}>{selectedProject.squareFootage.toLocaleString()} sq ft</p>\n                  </div>\n                )}\n              </div>\n\n              {((selectedProject.productCategories as string[] | null) || []).length > 0 && (\n                <div data-testid=\"section-product-categories\">\n                  <p className=\"text-muted-foreground text-xs mb-1.5\">Product Categories Needed</p>\n                  <div className=\"flex flex-wrap gap-1.5\">\n                    {((selectedProject.productCategories as string[]) || []).map((cat, i) => (\n                      <Badge key={i} variant=\"secondary\" data-testid={`badge-category-detail-${cat}`}>{cat}</Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {((selectedProject.competitorsInvolved as string[] | null) || []).length > 0 && (\n                <div data-testid=\"section-competitors\">\n                  <p className=\"text-muted-foreground text-xs mb-1.5\">Competitors Involved</p>\n                  <div className=\"flex flex-wrap gap-1.5\">\n                    {((selectedProject.competitorsInvolved as string[]) || []).map((comp, i) => (\n                      <Badge key={i} variant=\"destructive\" className=\"text-xs\" data-testid={`badge-competitor-${comp}`}>{comp}</Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {selectedProject.notes && (\n                <div data-testid=\"section-notes\">\n                  <p className=\"text-muted-foreground text-xs mb-1\">Notes</p>\n                  <p className=\"text-sm bg-muted/50 p-3 rounded-md\" data-testid={`text-notes-${selectedProject.id}`}>{selectedProject.notes}</p>\n                </div>\n              )}\n\n              {selectedProject.accountId && (\n                <div className=\"pt-2 border-t\">\n                  <Link href={`/playbooks?account=${selectedProject.accountId}`}>\n                    <Button variant=\"outline\" size=\"sm\" className=\"w-full\" data-testid={`button-generate-playbook-${selectedProject.accountId}`}>\n                      <ArrowRight className=\"h-4 w-4 mr-2\" />\n                      Generate Playbook for this Account\n                    </Button>\n                  </Link>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":22887,"size_tokens":null},"client/src/pages/crm-contacts.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  Search,\n  UserPlus,\n  Phone,\n  Mail,\n  Building2,\n  Crown,\n  Shield,\n  Eye,\n  Briefcase,\n  Clock,\n  ExternalLink,\n  Users,\n  AlertCircle,\n  Loader2,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport type { Contact } from \"@shared/schema\";\n\ninterface AccountBasic {\n  id: number;\n  name: string;\n}\n\nconst ROLE_CONFIG: Record<string, { label: string; icon: typeof Crown; color: string }> = {\n  decision_maker: { label: \"Decision Maker\", icon: Crown, color: \"text-amber-600 bg-amber-50 dark:bg-amber-950 border-amber-200 dark:border-amber-800\" },\n  owner: { label: \"Owner\", icon: Crown, color: \"text-amber-600 bg-amber-50 dark:bg-amber-950 border-amber-200 dark:border-amber-800\" },\n  purchaser: { label: \"Purchaser\", icon: Briefcase, color: \"text-blue-600 bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\" },\n  project_manager: { label: \"Project Manager\", icon: Briefcase, color: \"text-purple-600 bg-purple-50 dark:bg-purple-950 border-purple-200 dark:border-purple-800\" },\n  estimator: { label: \"Estimator\", icon: Briefcase, color: \"text-green-600 bg-green-50 dark:bg-green-950 border-green-200 dark:border-green-800\" },\n  influencer: { label: \"Influencer\", icon: Eye, color: \"text-indigo-600 bg-indigo-50 dark:bg-indigo-950 border-indigo-200 dark:border-indigo-800\" },\n  gatekeeper: { label: \"Gatekeeper\", icon: Shield, color: \"text-orange-600 bg-orange-50 dark:bg-orange-950 border-orange-200 dark:border-orange-800\" },\n  unknown: { label: \"Unknown\", icon: Users, color: \"text-gray-600 bg-gray-50 dark:bg-gray-900 border-gray-200 dark:border-gray-700\" },\n};\n\nfunction RoleBadge({ role, contactId }: { role: string | null; contactId?: number }) {\n  const config = ROLE_CONFIG[role || \"unknown\"] || ROLE_CONFIG.unknown;\n  const Icon = config.icon;\n  const testId = contactId ? `badge-role-${contactId}` : \"badge-role\";\n  return (\n    <span \n      className={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-medium border ${config.color}`}\n      data-testid={testId}\n    >\n      <Icon className=\"h-3 w-3\" />\n      {config.label}\n    </span>\n  );\n}\n\nfunction formatTimeAgo(date: string | Date | null): string {\n  if (!date) return \"Never\";\n  const d = new Date(date);\n  const now = new Date();\n  const diffMs = now.getTime() - d.getTime();\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n  if (diffDays === 0) return \"Today\";\n  if (diffDays === 1) return \"Yesterday\";\n  if (diffDays < 7) return `${diffDays} days ago`;\n  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;\n  if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;\n  return `${Math.floor(diffDays / 365)} years ago`;\n}\n\nexport default function CRMContacts() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [roleFilter, setRoleFilter] = useState(\"all\");\n  const [sourceFilter, setSourceFilter] = useState(\"all\");\n  const [selectedContact, setSelectedContact] = useState<Contact | null>(null);\n  const { toast } = useToast();\n\n  const { data: contacts, isLoading } = useQuery<Contact[]>({\n    queryKey: [\"/api/crm/contacts\"],\n  });\n\n  const { data: accountsList } = useQuery<AccountBasic[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  const accountMap = useMemo(() => {\n    const map: Record<number, string> = {};\n    if (accountsList) {\n      accountsList.forEach((a: any) => { map[a.id] = a.name; });\n    }\n    return map;\n  }, [accountsList]);\n\n  const filteredContacts = useMemo(() => {\n    if (!contacts) return [];\n    return contacts.filter((c) => {\n      const fullName = `${c.firstName} ${c.lastName || \"\"}`.toLowerCase();\n      const matchesSearch =\n        fullName.includes(searchQuery.toLowerCase()) ||\n        (c.email || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n        (c.title || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n        (accountMap[c.accountId || 0] || \"\").toLowerCase().includes(searchQuery.toLowerCase());\n      const matchesRole = roleFilter === \"all\" || c.role === roleFilter;\n      const matchesSource = sourceFilter === \"all\" || c.source === sourceFilter;\n      return matchesSearch && matchesRole && matchesSource;\n    });\n  }, [contacts, searchQuery, roleFilter, sourceFilter, accountMap]);\n\n  const stats = useMemo(() => {\n    if (!contacts) return { total: 0, decisionMakers: 0, recentlyContacted: 0, noContact30: 0 };\n    const now = new Date();\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n    return {\n      total: contacts.length,\n      decisionMakers: contacts.filter(c => c.role === \"decision_maker\" || c.role === \"owner\").length,\n      recentlyContacted: contacts.filter(c => c.lastContactedAt && new Date(c.lastContactedAt) > thirtyDaysAgo).length,\n      noContact30: contacts.filter(c => !c.lastContactedAt || new Date(c.lastContactedAt) < thirtyDaysAgo).length,\n    };\n  }, [contacts]);\n\n  const roles = [\"all\", \"decision_maker\", \"owner\", \"purchaser\", \"project_manager\", \"estimator\", \"influencer\", \"gatekeeper\", \"unknown\"];\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-crm-contacts\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Contacts</h1>\n          <p className=\"text-muted-foreground\">\n            People detected across your customer accounts from email intelligence\n          </p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card data-testid=\"stat-card-total-contacts\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-950\">\n                <Users className=\"h-5 w-5 text-blue-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"text-total-contacts\">{stats.total}</p>\n                <p className=\"text-xs text-muted-foreground\">Total Contacts</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card data-testid=\"stat-card-decision-makers\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 dark:bg-amber-950\">\n                <Crown className=\"h-5 w-5 text-amber-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"text-decision-makers\">{stats.decisionMakers}</p>\n                <p className=\"text-xs text-muted-foreground\">Decision Makers</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card data-testid=\"stat-card-recently-contacted\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-green-100 dark:bg-green-950\">\n                <Clock className=\"h-5 w-5 text-green-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"text-recently-contacted\">{stats.recentlyContacted}</p>\n                <p className=\"text-xs text-muted-foreground\">Contacted (30d)</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n        <Card data-testid=\"stat-card-needs-outreach\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-red-100 dark:bg-red-950\">\n                <AlertCircle className=\"h-5 w-5 text-red-600\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\" data-testid=\"text-needs-outreach\">{stats.noContact30}</p>\n                <p className=\"text-xs text-muted-foreground\">Needs Outreach</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n            <CardTitle className=\"text-lg\">Contact Directory</CardTitle>\n            <div className=\"flex flex-wrap items-center gap-2\">\n              <div className=\"relative w-64\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search name, email, title, account...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-contacts\"\n                />\n              </div>\n              <Select value={roleFilter} onValueChange={setRoleFilter}>\n                <SelectTrigger className=\"w-[160px]\" data-testid=\"select-role-filter\">\n                  <SelectValue placeholder=\"All Roles\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Roles</SelectItem>\n                  {roles.filter(r => r !== \"all\").map(r => (\n                    <SelectItem key={r} value={r}>{ROLE_CONFIG[r]?.label || r}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Select value={sourceFilter} onValueChange={setSourceFilter}>\n                <SelectTrigger className=\"w-[140px]\" data-testid=\"select-source-filter\">\n                  <SelectValue placeholder=\"All Sources\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Sources</SelectItem>\n                  <SelectItem value=\"email_sync\">Email Sync</SelectItem>\n                  <SelectItem value=\"manual\">Manual</SelectItem>\n                  <SelectItem value=\"csv_import\">CSV Import</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {filteredContacts.length === 0 ? (\n            <EmptyState\n              icon={Users}\n              title=\"No contacts found\"\n              description={contacts?.length ? \"Try adjusting your filters\" : \"Connect your email inbox in Settings to auto-detect contacts from customer correspondence\"}\n            />\n          ) : (\n            <div className=\"space-y-2\">\n              {filteredContacts.map((contact) => {\n                const accountName = accountMap[contact.accountId || 0];\n                const isStale = !contact.lastContactedAt || new Date(contact.lastContactedAt) < new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);\n                const isKeyPerson = contact.role === \"decision_maker\" || contact.role === \"owner\";\n\n                return (\n                  <div\n                    key={contact.id}\n                    className={`flex items-center justify-between p-4 rounded-lg border cursor-pointer transition-colors hover:bg-accent/50 ${isKeyPerson && isStale ? \"border-amber-300 dark:border-amber-700 bg-amber-50/30 dark:bg-amber-950/20\" : \"\"}`}\n                    onClick={() => setSelectedContact(contact)}\n                    data-testid={`card-contact-${contact.id}`}\n                  >\n                    <div className=\"flex items-center gap-4 flex-1 min-w-0\">\n                      <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary shrink-0\">\n                        <span className=\"text-sm font-semibold\">\n                          {contact.firstName?.[0]}{(contact.lastName || \"\")[0] || \"\"}\n                        </span>\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"font-medium truncate\" data-testid={`text-contact-name-${contact.id}`}>\n                            {contact.firstName} {contact.lastName || \"\"}\n                          </span>\n                          <RoleBadge role={contact.role} contactId={contact.id} />\n                          {isKeyPerson && isStale && (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Badge variant=\"destructive\" className=\"text-[10px] px-1.5 py-0\" data-testid={`badge-outreach-needed-${contact.id}`}>\n                                  Outreach needed\n                                </Badge>\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                Decision maker hasn't been contacted in 30+ days\n                              </TooltipContent>\n                            </Tooltip>\n                          )}\n                        </div>\n                        <div className=\"flex items-center gap-3 text-sm text-muted-foreground mt-0.5\">\n                          {contact.title && <span className=\"truncate\" data-testid={`text-contact-title-${contact.id}`}>{contact.title}</span>}\n                          {contact.title && accountName && <span>Â·</span>}\n                          {accountName && (\n                            <Link\n                              href={`/accounts?account=${contact.accountId}`}\n                              onClick={(e) => e.stopPropagation()}\n                              className=\"text-primary hover:underline inline-flex items-center gap-1\"\n                              data-testid={`link-account-${contact.id}`}\n                            >\n                              <Building2 className=\"h-3 w-3\" />\n                              {accountName}\n                            </Link>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-4 shrink-0\">\n                      <div className=\"text-right text-sm text-muted-foreground hidden md:block\" data-testid={`text-last-contacted-${contact.id}`}>\n                        <div className=\"flex items-center gap-1\">\n                          <Clock className=\"h-3 w-3\" />\n                          {formatTimeAgo(contact.lastContactedAt)}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-1\">\n                        {contact.email && (\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={(e) => { e.stopPropagation(); window.open(`mailto:${contact.email}`); }}\n                                data-testid={`button-email-${contact.id}`}\n                              >\n                                <Mail className=\"h-4 w-4\" />\n                              </Button>\n                            </TooltipTrigger>\n                            <TooltipContent>{contact.email}</TooltipContent>\n                          </Tooltip>\n                        )}\n                        {contact.phone && (\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={(e) => { e.stopPropagation(); window.open(`tel:${contact.phone}`); }}\n                                data-testid={`button-phone-${contact.id}`}\n                              >\n                                <Phone className=\"h-4 w-4\" />\n                              </Button>\n                            </TooltipTrigger>\n                            <TooltipContent>{contact.phone}</TooltipContent>\n                          </Tooltip>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!selectedContact} onOpenChange={(open) => !open && setSelectedContact(null)}>\n        <DialogContent className=\"max-w-lg\" data-testid=\"dialog-contact-details\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-3\" data-testid={selectedContact ? `text-dialog-title-${selectedContact.id}` : undefined}>\n              <div className=\"flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary\">\n                <span className=\"text-sm font-semibold\">\n                  {selectedContact?.firstName?.[0]}{(selectedContact?.lastName || \"\")[0] || \"\"}\n                </span>\n              </div>\n              {selectedContact?.firstName} {selectedContact?.lastName || \"\"}\n            </DialogTitle>\n            <DialogDescription>Contact details and intelligence</DialogDescription>\n          </DialogHeader>\n          {selectedContact && (\n            <div className=\"space-y-4\">\n              <div className=\"flex flex-wrap gap-2\">\n                <RoleBadge role={selectedContact.role} contactId={selectedContact.id} />\n                {selectedContact.isPrimary && (\n                  <Badge variant=\"default\" data-testid={`badge-primary-contact-${selectedContact.id}`}>Primary Contact</Badge>\n                )}\n                <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-source-${selectedContact.id}`}>\n                  Source: {selectedContact.source === \"email_sync\" ? \"Email Intelligence\" : selectedContact.source === \"csv_import\" ? \"CSV Import\" : \"Manual\"}\n                </Badge>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                {selectedContact.title && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Title</p>\n                    <p className=\"font-medium\" data-testid={`text-dialog-title-value-${selectedContact.id}`}>{selectedContact.title}</p>\n                  </div>\n                )}\n                {selectedContact.department && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Department</p>\n                    <p className=\"font-medium\" data-testid={`text-dialog-department-${selectedContact.id}`}>{selectedContact.department}</p>\n                  </div>\n                )}\n                {selectedContact.email && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Email</p>\n                    <a href={`mailto:${selectedContact.email}`} className=\"font-medium text-primary hover:underline\" data-testid={`link-dialog-email-${selectedContact.id}`}>\n                      {selectedContact.email}\n                    </a>\n                  </div>\n                )}\n                {selectedContact.phone && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Phone</p>\n                    <a href={`tel:${selectedContact.phone}`} className=\"font-medium text-primary hover:underline\" data-testid={`link-dialog-phone-${selectedContact.id}`}>\n                      {selectedContact.phone}\n                    </a>\n                  </div>\n                )}\n                {selectedContact.accountId && accountMap[selectedContact.accountId] && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Account</p>\n                    <Link href={`/accounts?account=${selectedContact.accountId}`} className=\"font-medium text-primary hover:underline inline-flex items-center gap-1\" data-testid={`link-dialog-account-${selectedContact.id}`}>\n                      <Building2 className=\"h-3 w-3\" />\n                      {accountMap[selectedContact.accountId]}\n                    </Link>\n                  </div>\n                )}\n                <div>\n                  <p className=\"text-muted-foreground text-xs\">Last Contacted</p>\n                  <p className=\"font-medium\" data-testid={`text-dialog-last-contacted-${selectedContact.id}`}>{formatTimeAgo(selectedContact.lastContactedAt)}</p>\n                </div>\n              </div>\n\n              {selectedContact.notes && (\n                <div>\n                  <p className=\"text-muted-foreground text-xs mb-1\">Notes</p>\n                  <p className=\"text-sm bg-muted/50 p-3 rounded-md\" data-testid={`text-dialog-notes-${selectedContact.id}`}>{selectedContact.notes}</p>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":21727,"size_tokens":null},"client/src/pages/crm-signals.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { EmptyState } from \"@/components/empty-state\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  Search,\n  ShoppingCart,\n  Swords,\n  AlertTriangle,\n  DollarSign,\n  Building2,\n  Clock,\n  ArrowRight,\n  Loader2,\n  Zap,\n  Shield,\n  TrendingUp,\n  Package,\n  CheckCircle,\n  XCircle,\n  Tag,\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport type { OrderSignal, CompetitorMention } from \"@shared/schema\";\n\ninterface AccountBasic {\n  id: number;\n  name: string;\n}\n\nconst URGENCY_CONFIG: Record<string, { label: string; color: string; priority: number }> = {\n  immediate: { label: \"Immediate\", color: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\", priority: 5 },\n  this_week: { label: \"This Week\", color: \"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300\", priority: 4 },\n  this_month: { label: \"This Month\", color: \"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300\", priority: 3 },\n  next_quarter: { label: \"Next Quarter\", color: \"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300\", priority: 2 },\n  exploring: { label: \"Exploring\", color: \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\", priority: 1 },\n  normal: { label: \"Normal\", color: \"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300\", priority: 1 },\n};\n\nconst SIGNAL_TYPE_CONFIG: Record<string, { label: string; icon: typeof ShoppingCart }> = {\n  quote_request: { label: \"Quote Request\", icon: DollarSign },\n  reorder: { label: \"Reorder\", icon: Package },\n  pricing_inquiry: { label: \"Pricing Inquiry\", icon: Tag },\n  product_inquiry: { label: \"Product Inquiry\", icon: Search },\n  purchase_intent: { label: \"Purchase Intent\", icon: ShoppingCart },\n  delivery_request: { label: \"Delivery Request\", icon: TrendingUp },\n};\n\nconst THREAT_CONFIG: Record<string, { label: string; color: string; priority: number }> = {\n  critical: { label: \"Critical\", color: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300 border-red-200 dark:border-red-800\", priority: 4 },\n  high: { label: \"High\", color: \"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300 border-orange-200 dark:border-orange-800\", priority: 3 },\n  medium: { label: \"Medium\", color: \"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300 border-amber-200 dark:border-amber-800\", priority: 2 },\n  low: { label: \"Low\", color: \"bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 border-gray-200 dark:border-gray-700\", priority: 1 },\n};\n\nconst MENTION_TYPE_LABELS: Record<string, string> = {\n  quote: \"Competitor Quote\",\n  pricing: \"Price Comparison\",\n  product_comparison: \"Product Comparison\",\n  switch_threat: \"Switch Threat\",\n  positive_mention: \"Positive Mention\",\n  negative_mention: \"Negative Mention\",\n};\n\nconst STATUS_CONFIG: Record<string, { label: string; color: string }> = {\n  new: { label: \"New\", color: \"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300\" },\n  contacted: { label: \"Contacted\", color: \"bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300\" },\n  quoted: { label: \"Quoted\", color: \"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300\" },\n  won: { label: \"Won\", color: \"bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300\" },\n  lost: { label: \"Lost\", color: \"bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300\" },\n};\n\nfunction formatCurrency(value: string | number | null): string {\n  if (!value) return \"\";\n  const num = typeof value === \"string\" ? parseFloat(value) : value;\n  if (isNaN(num)) return \"\";\n  if (num >= 1_000_000) return `$${(num / 1_000_000).toFixed(1)}M`;\n  if (num >= 1_000) return `$${(num / 1_000).toFixed(0)}K`;\n  return `$${num.toFixed(0)}`;\n}\n\nfunction formatDate(d: string | Date | null): string {\n  if (!d) return \"\";\n  return new Date(d).toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\", year: \"numeric\" });\n}\n\nfunction formatTimeAgo(date: string | Date | null): string {\n  if (!date) return \"\";\n  const d = new Date(date);\n  const now = new Date();\n  const diffMs = now.getTime() - d.getTime();\n  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));\n  if (diffDays === 0) return \"Today\";\n  if (diffDays === 1) return \"Yesterday\";\n  if (diffDays < 7) return `${diffDays}d ago`;\n  if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;\n  return `${Math.floor(diffDays / 30)}mo ago`;\n}\n\nexport default function CRMSignals() {\n  const [activeTab, setActiveTab] = useState(\"signals\");\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [urgencyFilter, setUrgencyFilter] = useState(\"all\");\n  const [threatFilter, setThreatFilter] = useState(\"all\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [selectedSignal, setSelectedSignal] = useState<OrderSignal | null>(null);\n  const [selectedMention, setSelectedMention] = useState<CompetitorMention | null>(null);\n  const [updateStatusTo, setUpdateStatusTo] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: orderSignalsData, isLoading: loadingSignals } = useQuery<OrderSignal[]>({\n    queryKey: [\"/api/crm/order-signals\"],\n  });\n\n  const { data: competitorMentionsData, isLoading: loadingMentions } = useQuery<CompetitorMention[]>({\n    queryKey: [\"/api/crm/competitor-mentions\"],\n  });\n\n  const { data: accountsList } = useQuery<AccountBasic[]>({\n    queryKey: [\"/api/accounts\"],\n  });\n\n  const accountMap = useMemo(() => {\n    const map: Record<number, string> = {};\n    if (accountsList) {\n      accountsList.forEach((a: any) => { map[a.id] = a.name; });\n    }\n    return map;\n  }, [accountsList]);\n\n  const updateSignalStatusMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: number; status: string }) => {\n      const response = await apiRequest(\"PATCH\", `/api/crm/order-signals/${id}`, { status });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crm/order-signals\"] });\n      toast({ title: \"Signal updated\", description: \"Status has been updated.\" });\n      setSelectedSignal(null);\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to update signal.\", variant: \"destructive\" });\n    },\n  });\n\n  const markMentionRespondedMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const response = await apiRequest(\"PATCH\", `/api/crm/competitor-mentions/${id}`, { respondedAt: new Date().toISOString() });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crm/competitor-mentions\"] });\n      toast({ title: \"Marked as responded\", description: \"Competitor mention has been marked as addressed.\" });\n      setSelectedMention(null);\n    },\n    onError: () => {\n      toast({ title: \"Error\", description: \"Failed to update.\", variant: \"destructive\" });\n    },\n  });\n\n  const filteredSignals = useMemo(() => {\n    if (!orderSignalsData) return [];\n    return orderSignalsData\n      .filter((s) => {\n        const matchesSearch =\n          (s.productCategory || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n          (s.productDetails || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n          (accountMap[s.accountId || 0] || \"\").toLowerCase().includes(searchQuery.toLowerCase());\n        const matchesUrgency = urgencyFilter === \"all\" || s.urgency === urgencyFilter;\n        const matchesStatus = statusFilter === \"all\" || s.status === statusFilter;\n        return matchesSearch && matchesUrgency && matchesStatus;\n      })\n      .sort((a, b) => (URGENCY_CONFIG[b.urgency || \"normal\"]?.priority || 0) - (URGENCY_CONFIG[a.urgency || \"normal\"]?.priority || 0));\n  }, [orderSignalsData, searchQuery, urgencyFilter, statusFilter, accountMap]);\n\n  const filteredMentions = useMemo(() => {\n    if (!competitorMentionsData) return [];\n    return competitorMentionsData\n      .filter((m) => {\n        const matchesSearch =\n          m.competitorName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n          (m.productCategory || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n          (m.details || \"\").toLowerCase().includes(searchQuery.toLowerCase()) ||\n          (accountMap[m.accountId || 0] || \"\").toLowerCase().includes(searchQuery.toLowerCase());\n        const matchesThreat = threatFilter === \"all\" || m.threatLevel === threatFilter;\n        return matchesSearch && matchesThreat;\n      })\n      .sort((a, b) => (THREAT_CONFIG[b.threatLevel || \"medium\"]?.priority || 0) - (THREAT_CONFIG[a.threatLevel || \"medium\"]?.priority || 0));\n  }, [competitorMentionsData, searchQuery, threatFilter, accountMap]);\n\n  const signalStats = useMemo(() => {\n    if (!orderSignalsData) return { total: 0, urgent: 0, newCount: 0, totalValue: 0 };\n    return {\n      total: orderSignalsData.length,\n      urgent: orderSignalsData.filter(s => s.urgency === \"immediate\" || s.urgency === \"this_week\").length,\n      newCount: orderSignalsData.filter(s => s.status === \"new\").length,\n      totalValue: orderSignalsData.reduce((sum, s) => sum + (s.estimatedValue ? parseFloat(s.estimatedValue as string) : 0), 0),\n    };\n  }, [orderSignalsData]);\n\n  const threatStats = useMemo(() => {\n    if (!competitorMentionsData) return { total: 0, critical: 0, needsResponse: 0, unresponded: 0 };\n    return {\n      total: competitorMentionsData.length,\n      critical: competitorMentionsData.filter(m => m.threatLevel === \"critical\" || m.threatLevel === \"high\").length,\n      needsResponse: competitorMentionsData.filter(m => m.responseNeeded && !m.respondedAt).length,\n      unresponded: competitorMentionsData.filter(m => !m.respondedAt).length,\n    };\n  }, [competitorMentionsData]);\n\n  const isLoading = loadingSignals || loadingMentions;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\" data-testid=\"page-crm-signals\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold tracking-tight\">Signals & Threats</h1>\n          <p className=\"text-muted-foreground\">\n            Order signals and competitive intelligence extracted from email conversations\n          </p>\n        </div>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList data-testid=\"tabs-signals-threats\">\n          <TabsTrigger value=\"signals\" className=\"gap-2\" data-testid=\"tab-signals\">\n            <Zap className=\"h-4 w-4\" />\n            Order Signals\n            {signalStats.newCount > 0 && (\n              <Badge variant=\"destructive\" className=\"ml-1 text-[10px] px-1.5 py-0\" data-testid=\"badge-new-signals-count\">{signalStats.newCount}</Badge>\n            )}\n          </TabsTrigger>\n          <TabsTrigger value=\"threats\" className=\"gap-2\" data-testid=\"tab-threats\">\n            <Swords className=\"h-4 w-4\" />\n            Competitor Threats\n            {threatStats.needsResponse > 0 && (\n              <Badge variant=\"destructive\" className=\"ml-1 text-[10px] px-1.5 py-0\" data-testid=\"badge-needs-response-count\">{threatStats.needsResponse}</Badge>\n            )}\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"signals\" className=\"space-y-4 mt-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card data-testid=\"stat-total-signals\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-950\">\n                    <Zap className=\"h-5 w-5 text-blue-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{signalStats.total}</p>\n                    <p className=\"text-xs text-muted-foreground\">Total Signals</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            <Card data-testid=\"stat-urgent-signals\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-red-100 dark:bg-red-950\">\n                    <AlertTriangle className=\"h-5 w-5 text-red-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{signalStats.urgent}</p>\n                    <p className=\"text-xs text-muted-foreground\">Urgent</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            <Card data-testid=\"stat-new-signals\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 dark:bg-amber-950\">\n                    <ShoppingCart className=\"h-5 w-5 text-amber-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{signalStats.newCount}</p>\n                    <p className=\"text-xs text-muted-foreground\">New / Unactioned</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            <Card data-testid=\"stat-signal-value\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-green-100 dark:bg-green-950\">\n                    <DollarSign className=\"h-5 w-5 text-green-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{formatCurrency(signalStats.totalValue) || \"$0\"}</p>\n                    <p className=\"text-xs text-muted-foreground\">Est. Value</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n                <CardTitle className=\"text-lg\">Order Signals</CardTitle>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <div className=\"relative w-64\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Search product, account...\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      className=\"pl-9\"\n                      data-testid=\"input-search-signals\"\n                    />\n                  </div>\n                  <Select value={urgencyFilter} onValueChange={setUrgencyFilter}>\n                    <SelectTrigger className=\"w-[150px]\" data-testid=\"select-urgency-filter\" aria-label=\"Filter by urgency\">\n                      <SelectValue placeholder=\"All Urgency\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Urgency</SelectItem>\n                      <SelectItem value=\"immediate\">Immediate</SelectItem>\n                      <SelectItem value=\"this_week\">This Week</SelectItem>\n                      <SelectItem value=\"this_month\">This Month</SelectItem>\n                      <SelectItem value=\"next_quarter\">Next Quarter</SelectItem>\n                      <SelectItem value=\"exploring\">Exploring</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <Select value={statusFilter} onValueChange={setStatusFilter}>\n                    <SelectTrigger className=\"w-[130px]\" data-testid=\"select-status-filter\" aria-label=\"Filter by status\">\n                      <SelectValue placeholder=\"All Status\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Status</SelectItem>\n                      <SelectItem value=\"new\">New</SelectItem>\n                      <SelectItem value=\"contacted\">Contacted</SelectItem>\n                      <SelectItem value=\"quoted\">Quoted</SelectItem>\n                      <SelectItem value=\"won\">Won</SelectItem>\n                      <SelectItem value=\"lost\">Lost</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {filteredSignals.length === 0 ? (\n                <EmptyState\n                  icon={Zap}\n                  title=\"No order signals found\"\n                  description={orderSignalsData?.length ? \"Try adjusting your filters\" : \"Connect your email inbox in Settings to detect purchase signals from customer emails\"}\n                />\n              ) : (\n                <div className=\"space-y-2\">\n                  {filteredSignals.map((signal) => {\n                    const accountName = accountMap[signal.accountId || 0];\n                    const urgencyConfig = URGENCY_CONFIG[signal.urgency || \"normal\"] || URGENCY_CONFIG.normal;\n                    const statusConfig = STATUS_CONFIG[signal.status || \"new\"] || STATUS_CONFIG.new;\n                    const signalTypeConfig = SIGNAL_TYPE_CONFIG[signal.signalType] || { label: signal.signalType, icon: Zap };\n                    const SignalIcon = signalTypeConfig.icon;\n\n                    return (\n                      <div\n                        key={signal.id}\n                        className={`flex items-center justify-between p-4 rounded-lg border cursor-pointer transition-colors hover:bg-accent/50 ${signal.urgency === \"immediate\" ? \"border-red-300 dark:border-red-700\" : \"\"}`}\n                        onClick={() => setSelectedSignal(signal)}\n                        data-testid={`card-signal-${signal.id}`}\n                      >\n                        <div className=\"flex items-center gap-4 flex-1 min-w-0\">\n                          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10 text-primary shrink-0\">\n                            <SignalIcon className=\"h-5 w-5\" />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 flex-wrap\">\n                              <span className=\"font-medium\" data-testid={`text-signal-type-${signal.id}`}>{signalTypeConfig.label}</span>\n                              <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${urgencyConfig.color}`} data-testid={`badge-urgency-${signal.urgency}-${signal.id}`}>\n                                {urgencyConfig.label}\n                              </span>\n                              <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${statusConfig.color}`} data-testid={`badge-status-${signal.status}-${signal.id}`}>\n                                {statusConfig.label}\n                              </span>\n                              {signal.competitorPriceMentioned && (\n                                <Badge variant=\"destructive\" className=\"text-[10px] px-1.5 py-0\" data-testid={`badge-competitor-pricing-${signal.id}`}>\n                                  Competitor pricing\n                                </Badge>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-3 text-sm text-muted-foreground mt-0.5 flex-wrap\">\n                              {signal.productCategory && (\n                                <span className=\"inline-flex items-center gap-1\" data-testid={`text-product-category-${signal.id}`}>\n                                  <Package className=\"h-3 w-3\" />\n                                  {signal.productCategory}\n                                </span>\n                              )}\n                              {signal.productDetails && (\n                                <span className=\"truncate max-w-[200px]\" data-testid={`text-product-details-${signal.id}`}>{signal.productDetails}</span>\n                              )}\n                              {accountName && (\n                                <Link\n                                  href={`/accounts?account=${signal.accountId}`}\n                                  onClick={(e) => e.stopPropagation()}\n                                  className=\"text-primary hover:underline inline-flex items-center gap-1\"\n                                  data-testid={`link-account-${signal.accountId}`}\n                                >\n                                  <Building2 className=\"h-3 w-3\" />\n                                  {accountName}\n                                </Link>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-3 shrink-0\">\n                          {signal.estimatedValue && (\n                            <span className=\"font-semibold\" data-testid={`text-estimated-value-${signal.id}`}>{formatCurrency(signal.estimatedValue)}</span>\n                          )}\n                          <span className=\"text-xs text-muted-foreground\" data-testid={`text-created-time-${signal.id}`}>{formatTimeAgo(signal.createdAt)}</span>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"threats\" className=\"space-y-4 mt-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card data-testid=\"stat-total-threats\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-950\">\n                    <Swords className=\"h-5 w-5 text-blue-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{threatStats.total}</p>\n                    <p className=\"text-xs text-muted-foreground\">Total Mentions</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            <Card data-testid=\"stat-critical-threats\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-red-100 dark:bg-red-950\">\n                    <AlertTriangle className=\"h-5 w-5 text-red-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{threatStats.critical}</p>\n                    <p className=\"text-xs text-muted-foreground\">High / Critical</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            <Card data-testid=\"stat-needs-response\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-amber-100 dark:bg-amber-950\">\n                    <Shield className=\"h-5 w-5 text-amber-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{threatStats.needsResponse}</p>\n                    <p className=\"text-xs text-muted-foreground\">Needs Response</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            <Card data-testid=\"stat-unresponded\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-purple-100 dark:bg-purple-950\">\n                    <Clock className=\"h-5 w-5 text-purple-600\" />\n                  </div>\n                  <div>\n                    <p className=\"text-2xl font-bold\">{threatStats.unresponded}</p>\n                    <p className=\"text-xs text-muted-foreground\">Unaddressed</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n                <CardTitle className=\"text-lg\">Competitor Intelligence</CardTitle>\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <div className=\"relative w-64\">\n                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Search competitor, product, account...\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      className=\"pl-9\"\n                      data-testid=\"input-search-threats\"\n                    />\n                  </div>\n                  <Select value={threatFilter} onValueChange={setThreatFilter}>\n                    <SelectTrigger className=\"w-[150px]\" data-testid=\"select-threat-filter\" aria-label=\"Filter by threat level\">\n                      <SelectValue placeholder=\"All Threats\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Threat Levels</SelectItem>\n                      <SelectItem value=\"critical\">Critical</SelectItem>\n                      <SelectItem value=\"high\">High</SelectItem>\n                      <SelectItem value=\"medium\">Medium</SelectItem>\n                      <SelectItem value=\"low\">Low</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {filteredMentions.length === 0 ? (\n                <EmptyState\n                  icon={Swords}\n                  title=\"No competitor mentions found\"\n                  description={competitorMentionsData?.length ? \"Try adjusting your filters\" : \"Connect your email inbox in Settings to detect competitor intelligence from customer correspondence\"}\n                />\n              ) : (\n                <div className=\"space-y-2\">\n                  {filteredMentions.map((mention) => {\n                    const accountName = accountMap[mention.accountId || 0];\n                    const threatConfig = THREAT_CONFIG[mention.threatLevel || \"medium\"] || THREAT_CONFIG.medium;\n                    const isResponded = !!mention.respondedAt;\n\n                    return (\n                      <div\n                        key={mention.id}\n                        className={`flex items-center justify-between p-4 rounded-lg border cursor-pointer transition-colors hover:bg-accent/50 ${mention.threatLevel === \"critical\" ? \"border-red-300 dark:border-red-700 bg-red-50/30 dark:bg-red-950/20\" : \"\"} ${isResponded ? \"opacity-60\" : \"\"}`}\n                        onClick={() => setSelectedMention(mention)}\n                        data-testid={`card-threat-${mention.id}`}\n                      >\n                        <div className=\"flex items-center gap-4 flex-1 min-w-0\">\n                          <div className={`flex h-10 w-10 items-center justify-center rounded-lg shrink-0 ${mention.threatLevel === \"critical\" || mention.threatLevel === \"high\" ? \"bg-red-100 dark:bg-red-950\" : \"bg-orange-100 dark:bg-orange-950\"}`}>\n                            <Swords className={`h-5 w-5 ${mention.threatLevel === \"critical\" || mention.threatLevel === \"high\" ? \"text-red-600\" : \"text-orange-600\"}`} />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 flex-wrap\">\n                              <span className=\"font-medium\" data-testid={`text-competitor-name-${mention.id}`}>{mention.competitorName}</span>\n                              <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium border ${threatConfig.color}`} data-testid={`badge-threat-level-${mention.threatLevel}-${mention.id}`}>\n                                {threatConfig.label}\n                              </span>\n                              <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-mention-type-${mention.mentionType}-${mention.id}`}>\n                                {MENTION_TYPE_LABELS[mention.mentionType] || mention.mentionType}\n                              </Badge>\n                              {mention.responseNeeded && !isResponded && (\n                                <Badge variant=\"destructive\" className=\"text-[10px] px-1.5 py-0\" data-testid={`badge-response-needed-${mention.id}`}>\n                                  Response needed\n                                </Badge>\n                              )}\n                              {isResponded && (\n                                <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0 text-green-600 border-green-300\" data-testid={`badge-responded-${mention.id}`}>\n                                  Responded\n                                </Badge>\n                              )}\n                            </div>\n                            <div className=\"flex items-center gap-3 text-sm text-muted-foreground mt-0.5 flex-wrap\">\n                              {mention.productCategory && (\n                                <span className=\"inline-flex items-center gap-1\" data-testid={`text-product-category-${mention.id}`}>\n                                  <Package className=\"h-3 w-3\" />\n                                  {mention.productCategory}\n                                </span>\n                              )}\n                              {mention.details && (\n                                <span className=\"truncate max-w-[300px]\" data-testid={`text-threat-details-${mention.id}`}>{mention.details}</span>\n                              )}\n                              {accountName && (\n                                <Link\n                                  href={`/accounts?account=${mention.accountId}`}\n                                  onClick={(e) => e.stopPropagation()}\n                                  className=\"text-primary hover:underline inline-flex items-center gap-1\"\n                                  data-testid={`link-account-${mention.accountId}`}\n                                >\n                                  <Building2 className=\"h-3 w-3\" />\n                                  {accountName}\n                                </Link>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-3 shrink-0\">\n                          {(mention.competitorPrice || mention.ourPrice) && (\n                            <div className=\"text-right text-sm\">\n                              {mention.competitorPrice && <div className=\"text-red-600\" data-testid={`text-competitor-price-${mention.id}`}>Them: {mention.competitorPrice}</div>}\n                              {mention.ourPrice && <div className=\"text-green-600\" data-testid={`text-our-price-${mention.id}`}>Us: {mention.ourPrice}</div>}\n                            </div>\n                          )}\n                          <span className=\"text-xs text-muted-foreground\" data-testid={`text-created-time-${mention.id}`}>{formatTimeAgo(mention.createdAt)}</span>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={!!selectedSignal} onOpenChange={(open) => !open && setSelectedSignal(null)}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Order Signal Details</DialogTitle>\n            <DialogDescription>Review and take action on this purchase signal</DialogDescription>\n          </DialogHeader>\n          {selectedSignal && (\n            <div className=\"space-y-4\">\n              <div className=\"flex flex-wrap gap-2\">\n                <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${(URGENCY_CONFIG[selectedSignal.urgency || \"normal\"] || URGENCY_CONFIG.normal).color}`} data-testid={`badge-urgency-${selectedSignal.urgency}-dialog`}>\n                  {(URGENCY_CONFIG[selectedSignal.urgency || \"normal\"] || URGENCY_CONFIG.normal).label}\n                </span>\n                <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium ${(STATUS_CONFIG[selectedSignal.status || \"new\"] || STATUS_CONFIG.new).color}`} data-testid={`badge-status-${selectedSignal.status}-dialog`}>\n                  {(STATUS_CONFIG[selectedSignal.status || \"new\"] || STATUS_CONFIG.new).label}\n                </span>\n                {selectedSignal.competitorPriceMentioned && (\n                  <Badge variant=\"destructive\" className=\"text-xs\" data-testid=\"badge-competitor-pricing-mentioned\">Competitor pricing mentioned</Badge>\n                )}\n                {selectedSignal.pricingMentioned && (\n                  <Badge variant=\"outline\" className=\"text-xs\" data-testid=\"badge-pricing-discussed\">Pricing discussed</Badge>\n                )}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div>\n                  <p className=\"text-muted-foreground text-xs\">Signal Type</p>\n                  <p className=\"font-medium\" data-testid=\"text-signal-type\">{SIGNAL_TYPE_CONFIG[selectedSignal.signalType]?.label || selectedSignal.signalType}</p>\n                </div>\n                {selectedSignal.productCategory && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Product Category</p>\n                    <p className=\"font-medium\" data-testid=\"text-product-category\">{selectedSignal.productCategory}</p>\n                  </div>\n                )}\n                {selectedSignal.productDetails && (\n                  <div className=\"col-span-2\">\n                    <p className=\"text-muted-foreground text-xs\">Product Details</p>\n                    <p className=\"font-medium\" data-testid=\"text-product-details\">{selectedSignal.productDetails}</p>\n                  </div>\n                )}\n                {selectedSignal.estimatedQuantity && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Estimated Quantity</p>\n                    <p className=\"font-medium\" data-testid=\"text-estimated-quantity\">{selectedSignal.estimatedQuantity}</p>\n                  </div>\n                )}\n                {selectedSignal.estimatedValue && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Estimated Value</p>\n                    <p className=\"font-semibold text-lg\" data-testid=\"text-estimated-value\">{formatCurrency(selectedSignal.estimatedValue)}</p>\n                  </div>\n                )}\n                {selectedSignal.requestedDeliveryDate && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Requested Delivery</p>\n                    <p className=\"font-medium\" data-testid=\"text-requested-delivery\">{formatDate(selectedSignal.requestedDeliveryDate)}</p>\n                  </div>\n                )}\n                {selectedSignal.accountId && accountMap[selectedSignal.accountId] && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Account</p>\n                    <Link href={`/accounts?account=${selectedSignal.accountId}`} className=\"font-medium text-primary hover:underline inline-flex items-center gap-1\" data-testid={`link-account-${selectedSignal.accountId}`}>\n                      <Building2 className=\"h-3 w-3\" />\n                      {accountMap[selectedSignal.accountId]}\n                    </Link>\n                  </div>\n                )}\n              </div>\n\n              {selectedSignal.notes && (\n                <div>\n                  <p className=\"text-muted-foreground text-xs mb-1\">Notes</p>\n                  <p className=\"text-sm bg-muted/50 p-3 rounded-md\" data-testid=\"text-signal-notes\">{selectedSignal.notes}</p>\n                </div>\n              )}\n\n              <div className=\"pt-2 border-t\">\n                <p className=\"text-muted-foreground text-xs mb-2\" data-testid=\"text-update-status-label\">Update Status</p>\n                <div className=\"flex flex-wrap gap-2\">\n                  {[\"contacted\", \"quoted\", \"won\", \"lost\"].map((s) => (\n                    <Button\n                      key={s}\n                      variant={selectedSignal.status === s ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => updateSignalStatusMutation.mutate({ id: selectedSignal.id, status: s })}\n                      disabled={updateSignalStatusMutation.isPending}\n                      data-testid={`button-status-${s}`}\n                    >\n                      {s === \"won\" && <CheckCircle className=\"h-3 w-3 mr-1\" />}\n                      {s === \"lost\" && <XCircle className=\"h-3 w-3 mr-1\" />}\n                      {STATUS_CONFIG[s]?.label || s}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!selectedMention} onOpenChange={(open) => !open && setSelectedMention(null)}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Competitor Intelligence</DialogTitle>\n            <DialogDescription>Review and respond to this competitive threat</DialogDescription>\n          </DialogHeader>\n          {selectedMention && (\n            <div className=\"space-y-4\">\n              <div className=\"flex flex-wrap gap-2\">\n                <span className={`inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium border ${(THREAT_CONFIG[selectedMention.threatLevel || \"medium\"] || THREAT_CONFIG.medium).color}`} data-testid={`badge-threat-level-${selectedMention.threatLevel}-dialog`}>\n                  {(THREAT_CONFIG[selectedMention.threatLevel || \"medium\"] || THREAT_CONFIG.medium).label} Threat\n                </span>\n                <Badge variant=\"outline\" className=\"text-xs\" data-testid={`badge-mention-type-${selectedMention.mentionType}-dialog`}>\n                  {MENTION_TYPE_LABELS[selectedMention.mentionType] || selectedMention.mentionType}\n                </Badge>\n                {selectedMention.respondedAt ? (\n                  <Badge variant=\"outline\" className=\"text-xs text-green-600 border-green-300\" data-testid=\"badge-responded-dialog\">\n                    Responded {formatDate(selectedMention.respondedAt)}\n                  </Badge>\n                ) : selectedMention.responseNeeded ? (\n                  <Badge variant=\"destructive\" className=\"text-xs\" data-testid=\"badge-response-needed-dialog\">Response needed</Badge>\n                ) : null}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div>\n                  <p className=\"text-muted-foreground text-xs\">Competitor</p>\n                  <p className=\"font-semibold text-lg\" data-testid=\"text-competitor-name\">{selectedMention.competitorName}</p>\n                </div>\n                {selectedMention.productCategory && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Product Category</p>\n                    <p className=\"font-medium\" data-testid=\"text-product-category\">{selectedMention.productCategory}</p>\n                  </div>\n                )}\n                {selectedMention.competitorPrice && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Competitor Price</p>\n                    <p className=\"font-medium text-red-600\" data-testid=\"text-competitor-price\">{selectedMention.competitorPrice}</p>\n                  </div>\n                )}\n                {selectedMention.ourPrice && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Our Price</p>\n                    <p className=\"font-medium text-green-600\" data-testid=\"text-our-price\">{selectedMention.ourPrice}</p>\n                  </div>\n                )}\n                {selectedMention.accountId && accountMap[selectedMention.accountId] && (\n                  <div>\n                    <p className=\"text-muted-foreground text-xs\">Account</p>\n                    <Link href={`/accounts?account=${selectedMention.accountId}`} className=\"font-medium text-primary hover:underline inline-flex items-center gap-1\" data-testid={`link-account-${selectedMention.accountId}`}>\n                      <Building2 className=\"h-3 w-3\" />\n                      {accountMap[selectedMention.accountId]}\n                    </Link>\n                  </div>\n                )}\n              </div>\n\n              {selectedMention.details && (\n                <div>\n                  <p className=\"text-muted-foreground text-xs mb-1\">Details</p>\n                  <p className=\"text-sm bg-muted/50 p-3 rounded-md\" data-testid=\"text-threat-details\">{selectedMention.details}</p>\n                </div>\n              )}\n\n              {!selectedMention.respondedAt && (\n                <div className=\"pt-2 border-t\">\n                  <Button\n                    onClick={() => markMentionRespondedMutation.mutate(selectedMention.id)}\n                    disabled={markMentionRespondedMutation.isPending}\n                    className=\"w-full\"\n                    data-testid=\"button-mark-responded\"\n                  >\n                    <CheckCircle className=\"h-4 w-4 mr-2\" />\n                    Mark as Responded\n                  </Button>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":43329,"size_tokens":null}},"version":2}